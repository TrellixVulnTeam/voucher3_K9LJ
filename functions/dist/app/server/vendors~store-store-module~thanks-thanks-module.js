exports.ids=[2],exports.modules={"+Lud":function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getSubchannelPool=exports.SubchannelPool=void 0;const channel_options_1=__webpack_require__("39CH"),subchannel_1=__webpack_require__("Ikg5"),uri_parser_1=__webpack_require__("x8Ej");class SubchannelPool{constructor(global){this.global=global,this.pool=Object.create(null),this.cleanupTimer=null}unrefUnusedSubchannels(){let allSubchannelsUnrefed=!0;for(const channelTarget in this.pool){const refedSubchannels=this.pool[channelTarget].filter(value=>!value.subchannel.unrefIfOneRef());refedSubchannels.length>0&&(allSubchannelsUnrefed=!1),this.pool[channelTarget]=refedSubchannels}allSubchannelsUnrefed&&null!==this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=null)}ensureCleanupTask(){var _a,_b;this.global&&null===this.cleanupTimer&&(this.cleanupTimer=setInterval(()=>{this.unrefUnusedSubchannels()},1e4),null===(_b=(_a=this.cleanupTimer).unref)||void 0===_b||_b.call(_a))}getOrCreateSubchannel(channelTargetUri,subchannelTarget,channelArguments,channelCredentials){this.ensureCleanupTask();const channelTarget=uri_parser_1.uriToString(channelTargetUri);if(channelTarget in this.pool){const subchannelObjArray=this.pool[channelTarget];for(const subchannelObj of subchannelObjArray)if(subchannel_1.subchannelAddressEqual(subchannelTarget,subchannelObj.subchannelAddress)&&channel_options_1.channelOptionsEqual(channelArguments,subchannelObj.channelArguments)&&channelCredentials._equals(subchannelObj.channelCredentials))return subchannelObj.subchannel}const subchannel=new subchannel_1.Subchannel(channelTargetUri,subchannelTarget,channelArguments,channelCredentials);return channelTarget in this.pool||(this.pool[channelTarget]=[]),this.pool[channelTarget].push({subchannelAddress:subchannelTarget,channelArguments:channelArguments,channelCredentials:channelCredentials,subchannel:subchannel}),this.global&&subchannel.ref(),subchannel}}exports.SubchannelPool=SubchannelPool;const globalSubchannelPool=new SubchannelPool(!0);exports.getSubchannelPool=function getSubchannelPool(global){return global?globalSubchannelPool:new SubchannelPool(!1)}},"+hx4":function(module,exports,__webpack_require__){"use strict";module.exports=__webpack_require__("NzeB")},"02Vj":function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var database04501227=__webpack_require__("sE+A");function loadBundle(data){return database04501227.loadBundle(this._delegate,data)}function namedQuery(queryName){var _this=this;return database04501227.namedQuery(this._delegate,queryName).then(function(expQuery){return expQuery?new database04501227.Query(_this,expQuery):null})}function registerBundle(instance){instance.prototype.loadBundle=loadBundle,instance.prototype.namedQuery=namedQuery}__webpack_require__("zOht"),__webpack_require__("Jv5v"),__webpack_require__("NcST"),__webpack_require__("jK02"),__webpack_require__("PJMN"),__webpack_require__("AVbK"),__webpack_require__("eM9J"),__webpack_require__("oyvS"),__webpack_require__("8ZNE"),registerBundle(database04501227.Firestore),exports.registerBundle=registerBundle},"1Giq":function(module,exports,__webpack_require__){"use strict";function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(e){}return null}module.exports=inquire},"1mAN":function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.loadPackageDefinition=exports.makeClientConstructor=void 0;const client_1=__webpack_require__("rVu5"),requesterFuncs={unary:client_1.Client.prototype.makeUnaryRequest,server_stream:client_1.Client.prototype.makeServerStreamRequest,client_stream:client_1.Client.prototype.makeClientStreamRequest,bidi:client_1.Client.prototype.makeBidiStreamRequest};function isPrototypePolluted(key){return["__proto__","prototype","constructor"].includes(key)}function makeClientConstructor(methods,serviceName,classOptions){classOptions||(classOptions={});class ServiceClientImpl extends client_1.Client{}return Object.keys(methods).forEach(name=>{if(isPrototypePolluted(name))return;const attrs=methods[name];let methodType;if("string"==typeof name&&"$"===name.charAt(0))throw new Error("Method names cannot start with $");methodType=attrs.requestStream?attrs.responseStream?"bidi":"client_stream":attrs.responseStream?"server_stream":"unary";const serialize=attrs.requestSerialize,deserialize=attrs.responseDeserialize,methodFunc=function partial(fn,path,serialize,deserialize){return function(...args){return fn.call(this,path,serialize,deserialize,...args)}}(requesterFuncs[methodType],attrs.path,serialize,deserialize);ServiceClientImpl.prototype[name]=methodFunc,Object.assign(ServiceClientImpl.prototype[name],attrs),attrs.originalName&&!isPrototypePolluted(attrs.originalName)&&(ServiceClientImpl.prototype[attrs.originalName]=ServiceClientImpl.prototype[name])}),ServiceClientImpl.service=methods,ServiceClientImpl}exports.makeClientConstructor=makeClientConstructor,exports.loadPackageDefinition=function loadPackageDefinition(packageDef){const result={};for(const serviceFqn in packageDef)if(Object.prototype.hasOwnProperty.call(packageDef,serviceFqn)){const service=packageDef[serviceFqn],nameComponents=serviceFqn.split(".");if(nameComponents.some(comp=>isPrototypePolluted(comp)))continue;const serviceName=nameComponents[nameComponents.length-1];let current=result;for(const packageName of nameComponents.slice(0,-1))current[packageName]||(current[packageName]={}),current=current[packageName];obj=service,current[serviceName]="format"in obj?service:makeClientConstructor(service,0,{})}var obj;return result}},"39CH":function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.channelOptionsEqual=exports.recognizedOptions=void 0,exports.recognizedOptions={"grpc.ssl_target_name_override":!0,"grpc.primary_user_agent":!0,"grpc.secondary_user_agent":!0,"grpc.default_authority":!0,"grpc.keepalive_time_ms":!0,"grpc.keepalive_timeout_ms":!0,"grpc.keepalive_permit_without_calls":!0,"grpc.service_config":!0,"grpc.max_concurrent_streams":!0,"grpc.initial_reconnect_backoff_ms":!0,"grpc.max_reconnect_backoff_ms":!0,"grpc.use_local_subchannel_pool":!0,"grpc.max_send_message_length":!0,"grpc.max_receive_message_length":!0,"grpc.enable_http_proxy":!0,"grpc-node.max_session_memory":!0},exports.channelOptionsEqual=function channelOptionsEqual(options1,options2){const keys1=Object.keys(options1).sort(),keys2=Object.keys(options2).sort();if(keys1.length!==keys2.length)return!1;for(let i=0;i<keys1.length;i+=1){if(keys1[i]!==keys2[i])return!1;if(options1[keys1[i]]!==options2[keys2[i]])return!1}return!0}},"3G9Y":function(module,exports,__webpack_require__){"use strict";module.exports=BufferWriter;var Writer=__webpack_require__("DIMq");(BufferWriter.prototype=Object.create(Writer.prototype)).constructor=BufferWriter;var util=__webpack_require__("6Tgl");function BufferWriter(){Writer.call(this)}function writeStringBuffer(val,buf,pos){val.length<40?util.utf8.write(val,buf,pos):buf.utf8Write?buf.utf8Write(val,pos):buf.write(val,pos)}BufferWriter._configure=function(){BufferWriter.alloc=util._Buffer_allocUnsafe,BufferWriter.writeBytesBuffer=util.Buffer&&util.Buffer.prototype instanceof Uint8Array&&"set"===util.Buffer.prototype.set.name?function writeBytesBuffer_set(val,buf,pos){buf.set(val,pos)}:function writeBytesBuffer_copy(val,buf,pos){if(val.copy)val.copy(buf,pos,0,val.length);else for(var i=0;i<val.length;)buf[pos++]=val[i++]}},BufferWriter.prototype.bytes=function write_bytes_buffer(value){util.isString(value)&&(value=util._Buffer_from(value,"base64"));var len=value.length>>>0;return this.uint32(len),len&&this._push(BufferWriter.writeBytesBuffer,len,value),this},BufferWriter.prototype.string=function write_string_buffer(value){var len=util.Buffer.byteLength(value);return this.uint32(len),len&&this._push(writeStringBuffer,len,value),this},BufferWriter._configure()},"3Xxg":function(module,exports,__webpack_require__){"use strict";module.exports=function decoder(mtype){var gen=util.codegen(["r","l"],mtype.name+"$decode")("if(!(r instanceof Reader))")("r=Reader.create(r)")("var c=l===undefined?r.len:r.pos+l,m=new this.ctor"+(mtype.fieldsArray.filter(function(field){return field.map}).length?",k,value":""))("while(r.pos<c){")("var t=r.uint32()");mtype.group&&gen("if((t&7)===4)")("break");gen("switch(t>>>3){");for(var i=0;i<mtype.fieldsArray.length;++i){var field=mtype._fieldsArray[i].resolve(),type=field.resolvedType instanceof Enum?"int32":field.type,ref="m"+util.safeProp(field.name);gen("case %i:",field.id),field.map?(gen("if(%s===util.emptyObject)",ref)("%s={}",ref)("var c2 = r.uint32()+r.pos"),void 0!==types.defaults[field.keyType]?gen("k=%j",types.defaults[field.keyType]):gen("k=null"),void 0!==types.defaults[type]?gen("value=%j",types.defaults[type]):gen("value=null"),gen("while(r.pos<c2){")("var tag2=r.uint32()")("switch(tag2>>>3){")("case 1: k=r.%s(); break",field.keyType)("case 2:"),void 0===types.basic[type]?gen("value=types[%i].decode(r,r.uint32())",i):gen("value=r.%s()",type),gen("break")("default:")("r.skipType(tag2&7)")("break")("}")("}"),void 0!==types.long[field.keyType]?gen('%s[typeof k==="object"?util.longToHash(k):k]=value',ref):gen("%s[k]=value",ref)):field.repeated?(gen("if(!(%s&&%s.length))",ref,ref)("%s=[]",ref),void 0!==types.packed[type]&&gen("if((t&7)===2){")("var c2=r.uint32()+r.pos")("while(r.pos<c2)")("%s.push(r.%s())",ref,type)("}else"),void 0===types.basic[type]?gen(field.resolvedType.group?"%s.push(types[%i].decode(r))":"%s.push(types[%i].decode(r,r.uint32()))",ref,i):gen("%s.push(r.%s())",ref,type)):void 0===types.basic[type]?gen(field.resolvedType.group?"%s=types[%i].decode(r)":"%s=types[%i].decode(r,r.uint32())",ref,i):gen("%s=r.%s()",ref,type),gen("break")}for(gen("default:")("r.skipType(t&7)")("break")("}")("}"),i=0;i<mtype._fieldsArray.length;++i){var rfield=mtype._fieldsArray[i];rfield.required&&gen("if(!m.hasOwnProperty(%j))",rfield.name)("throw util.ProtocolError(%j,{instance:m})",missing(rfield))}return gen("return m")};var Enum=__webpack_require__("vREW"),types=__webpack_require__("hSTS"),util=__webpack_require__("y9PA");function missing(field){return"missing required '"+field.name+"'"}},"3cR/":function(module){module.exports=JSON.parse('{"nested":{"google":{"nested":{"protobuf":{"nested":{"FileDescriptorSet":{"fields":{"file":{"rule":"repeated","type":"FileDescriptorProto","id":1}}},"FileDescriptorProto":{"fields":{"name":{"type":"string","id":1},"package":{"type":"string","id":2},"dependency":{"rule":"repeated","type":"string","id":3},"publicDependency":{"rule":"repeated","type":"int32","id":10,"options":{"packed":false}},"weakDependency":{"rule":"repeated","type":"int32","id":11,"options":{"packed":false}},"messageType":{"rule":"repeated","type":"DescriptorProto","id":4},"enumType":{"rule":"repeated","type":"EnumDescriptorProto","id":5},"service":{"rule":"repeated","type":"ServiceDescriptorProto","id":6},"extension":{"rule":"repeated","type":"FieldDescriptorProto","id":7},"options":{"type":"FileOptions","id":8},"sourceCodeInfo":{"type":"SourceCodeInfo","id":9},"syntax":{"type":"string","id":12}}},"DescriptorProto":{"fields":{"name":{"type":"string","id":1},"field":{"rule":"repeated","type":"FieldDescriptorProto","id":2},"extension":{"rule":"repeated","type":"FieldDescriptorProto","id":6},"nestedType":{"rule":"repeated","type":"DescriptorProto","id":3},"enumType":{"rule":"repeated","type":"EnumDescriptorProto","id":4},"extensionRange":{"rule":"repeated","type":"ExtensionRange","id":5},"oneofDecl":{"rule":"repeated","type":"OneofDescriptorProto","id":8},"options":{"type":"MessageOptions","id":7},"reservedRange":{"rule":"repeated","type":"ReservedRange","id":9},"reservedName":{"rule":"repeated","type":"string","id":10}},"nested":{"ExtensionRange":{"fields":{"start":{"type":"int32","id":1},"end":{"type":"int32","id":2}}},"ReservedRange":{"fields":{"start":{"type":"int32","id":1},"end":{"type":"int32","id":2}}}}},"FieldDescriptorProto":{"fields":{"name":{"type":"string","id":1},"number":{"type":"int32","id":3},"label":{"type":"Label","id":4},"type":{"type":"Type","id":5},"typeName":{"type":"string","id":6},"extendee":{"type":"string","id":2},"defaultValue":{"type":"string","id":7},"oneofIndex":{"type":"int32","id":9},"jsonName":{"type":"string","id":10},"options":{"type":"FieldOptions","id":8}},"nested":{"Type":{"values":{"TYPE_DOUBLE":1,"TYPE_FLOAT":2,"TYPE_INT64":3,"TYPE_UINT64":4,"TYPE_INT32":5,"TYPE_FIXED64":6,"TYPE_FIXED32":7,"TYPE_BOOL":8,"TYPE_STRING":9,"TYPE_GROUP":10,"TYPE_MESSAGE":11,"TYPE_BYTES":12,"TYPE_UINT32":13,"TYPE_ENUM":14,"TYPE_SFIXED32":15,"TYPE_SFIXED64":16,"TYPE_SINT32":17,"TYPE_SINT64":18}},"Label":{"values":{"LABEL_OPTIONAL":1,"LABEL_REQUIRED":2,"LABEL_REPEATED":3}}}},"OneofDescriptorProto":{"fields":{"name":{"type":"string","id":1},"options":{"type":"OneofOptions","id":2}}},"EnumDescriptorProto":{"fields":{"name":{"type":"string","id":1},"value":{"rule":"repeated","type":"EnumValueDescriptorProto","id":2},"options":{"type":"EnumOptions","id":3}}},"EnumValueDescriptorProto":{"fields":{"name":{"type":"string","id":1},"number":{"type":"int32","id":2},"options":{"type":"EnumValueOptions","id":3}}},"ServiceDescriptorProto":{"fields":{"name":{"type":"string","id":1},"method":{"rule":"repeated","type":"MethodDescriptorProto","id":2},"options":{"type":"ServiceOptions","id":3}}},"MethodDescriptorProto":{"fields":{"name":{"type":"string","id":1},"inputType":{"type":"string","id":2},"outputType":{"type":"string","id":3},"options":{"type":"MethodOptions","id":4},"clientStreaming":{"type":"bool","id":5},"serverStreaming":{"type":"bool","id":6}}},"FileOptions":{"fields":{"javaPackage":{"type":"string","id":1},"javaOuterClassname":{"type":"string","id":8},"javaMultipleFiles":{"type":"bool","id":10},"javaGenerateEqualsAndHash":{"type":"bool","id":20,"options":{"deprecated":true}},"javaStringCheckUtf8":{"type":"bool","id":27},"optimizeFor":{"type":"OptimizeMode","id":9,"options":{"default":"SPEED"}},"goPackage":{"type":"string","id":11},"ccGenericServices":{"type":"bool","id":16},"javaGenericServices":{"type":"bool","id":17},"pyGenericServices":{"type":"bool","id":18},"deprecated":{"type":"bool","id":23},"ccEnableArenas":{"type":"bool","id":31},"objcClassPrefix":{"type":"string","id":36},"csharpNamespace":{"type":"string","id":37},"uninterpretedOption":{"rule":"repeated","type":"UninterpretedOption","id":999}},"extensions":[[1000,536870911]],"reserved":[[38,38]],"nested":{"OptimizeMode":{"values":{"SPEED":1,"CODE_SIZE":2,"LITE_RUNTIME":3}}}},"MessageOptions":{"fields":{"messageSetWireFormat":{"type":"bool","id":1},"noStandardDescriptorAccessor":{"type":"bool","id":2},"deprecated":{"type":"bool","id":3},"mapEntry":{"type":"bool","id":7},"uninterpretedOption":{"rule":"repeated","type":"UninterpretedOption","id":999}},"extensions":[[1000,536870911]],"reserved":[[8,8]]},"FieldOptions":{"fields":{"ctype":{"type":"CType","id":1,"options":{"default":"STRING"}},"packed":{"type":"bool","id":2},"jstype":{"type":"JSType","id":6,"options":{"default":"JS_NORMAL"}},"lazy":{"type":"bool","id":5},"deprecated":{"type":"bool","id":3},"weak":{"type":"bool","id":10},"uninterpretedOption":{"rule":"repeated","type":"UninterpretedOption","id":999}},"extensions":[[1000,536870911]],"reserved":[[4,4]],"nested":{"CType":{"values":{"STRING":0,"CORD":1,"STRING_PIECE":2}},"JSType":{"values":{"JS_NORMAL":0,"JS_STRING":1,"JS_NUMBER":2}}}},"OneofOptions":{"fields":{"uninterpretedOption":{"rule":"repeated","type":"UninterpretedOption","id":999}},"extensions":[[1000,536870911]]},"EnumOptions":{"fields":{"allowAlias":{"type":"bool","id":2},"deprecated":{"type":"bool","id":3},"uninterpretedOption":{"rule":"repeated","type":"UninterpretedOption","id":999}},"extensions":[[1000,536870911]]},"EnumValueOptions":{"fields":{"deprecated":{"type":"bool","id":1},"uninterpretedOption":{"rule":"repeated","type":"UninterpretedOption","id":999}},"extensions":[[1000,536870911]]},"ServiceOptions":{"fields":{"deprecated":{"type":"bool","id":33},"uninterpretedOption":{"rule":"repeated","type":"UninterpretedOption","id":999}},"extensions":[[1000,536870911]]},"MethodOptions":{"fields":{"deprecated":{"type":"bool","id":33},"uninterpretedOption":{"rule":"repeated","type":"UninterpretedOption","id":999}},"extensions":[[1000,536870911]]},"UninterpretedOption":{"fields":{"name":{"rule":"repeated","type":"NamePart","id":2},"identifierValue":{"type":"string","id":3},"positiveIntValue":{"type":"uint64","id":4},"negativeIntValue":{"type":"int64","id":5},"doubleValue":{"type":"double","id":6},"stringValue":{"type":"bytes","id":7},"aggregateValue":{"type":"string","id":8}},"nested":{"NamePart":{"fields":{"namePart":{"rule":"required","type":"string","id":1},"isExtension":{"rule":"required","type":"bool","id":2}}}}},"SourceCodeInfo":{"fields":{"location":{"rule":"repeated","type":"Location","id":1}},"nested":{"Location":{"fields":{"path":{"rule":"repeated","type":"int32","id":1},"span":{"rule":"repeated","type":"int32","id":2},"leadingComments":{"type":"string","id":3},"trailingComments":{"type":"string","id":4},"leadingDetachedComments":{"rule":"repeated","type":"string","id":6}}}}},"GeneratedCodeInfo":{"fields":{"annotation":{"rule":"repeated","type":"Annotation","id":1}},"nested":{"Annotation":{"fields":{"path":{"rule":"repeated","type":"int32","id":1},"sourceFile":{"type":"string","id":2},"begin":{"type":"int32","id":3},"end":{"type":"int32","id":4}}}}}}}}}}}')},"56Zw":function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var logging_1=__webpack_require__("xQiD");Object.defineProperty(exports,"trace",{enumerable:!0,get:function(){return logging_1.trace}});var resolver_1=__webpack_require__("9rQR");Object.defineProperty(exports,"registerResolver",{enumerable:!0,get:function(){return resolver_1.registerResolver}});var uri_parser_1=__webpack_require__("x8Ej");Object.defineProperty(exports,"uriToString",{enumerable:!0,get:function(){return uri_parser_1.uriToString}});var backoff_timeout_1=__webpack_require__("hc0Y");Object.defineProperty(exports,"BackoffTimeout",{enumerable:!0,get:function(){return backoff_timeout_1.BackoffTimeout}});var load_balancer_1=__webpack_require__("JG2R");Object.defineProperty(exports,"registerLoadBalancerType",{enumerable:!0,get:function(){return load_balancer_1.registerLoadBalancerType}}),Object.defineProperty(exports,"getFirstUsableConfig",{enumerable:!0,get:function(){return load_balancer_1.getFirstUsableConfig}}),Object.defineProperty(exports,"validateLoadBalancingConfig",{enumerable:!0,get:function(){return load_balancer_1.validateLoadBalancingConfig}});var subchannel_1=__webpack_require__("Ikg5");Object.defineProperty(exports,"subchannelAddressToString",{enumerable:!0,get:function(){return subchannel_1.subchannelAddressToString}});var load_balancer_child_handler_1=__webpack_require__("z8EH");Object.defineProperty(exports,"ChildLoadBalancerHandler",{enumerable:!0,get:function(){return load_balancer_child_handler_1.ChildLoadBalancerHandler}});var picker_1=__webpack_require__("mVN3");Object.defineProperty(exports,"UnavailablePicker",{enumerable:!0,get:function(){return picker_1.UnavailablePicker}}),Object.defineProperty(exports,"QueuePicker",{enumerable:!0,get:function(){return picker_1.QueuePicker}}),Object.defineProperty(exports,"PickResultType",{enumerable:!0,get:function(){return picker_1.PickResultType}});var filter_1=__webpack_require__("nC4N");Object.defineProperty(exports,"BaseFilter",{enumerable:!0,get:function(){return filter_1.BaseFilter}});var filter_stack_1=__webpack_require__("Za3E");Object.defineProperty(exports,"FilterStackFactory",{enumerable:!0,get:function(){return filter_stack_1.FilterStackFactory}})},"5cLd":function(module,exports){var reAsciiWord=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,reLatin=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,rsBreakRange="\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2000-\\u206f \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",rsAstral="[\\ud800-\\udfff]",rsBreak="["+rsBreakRange+"]",rsCombo="[\\u0300-\\u036f\\ufe20-\\ufe23\\u20d0-\\u20f0]",rsDigits="\\d+",rsDingbat="[\\u2700-\\u27bf]",rsLower="[a-z\\xdf-\\xf6\\xf8-\\xff]",rsMisc="[^\\ud800-\\udfff"+rsBreakRange+rsDigits+"\\u2700-\\u27bfa-z\\xdf-\\xf6\\xf8-\\xffA-Z\\xc0-\\xd6\\xd8-\\xde]",rsFitz="\\ud83c[\\udffb-\\udfff]",rsNonAstral="[^\\ud800-\\udfff]",rsRegional="(?:\\ud83c[\\udde6-\\uddff]){2}",rsSurrPair="[\\ud800-\\udbff][\\udc00-\\udfff]",rsUpper="[A-Z\\xc0-\\xd6\\xd8-\\xde]",rsLowerMisc="(?:"+rsLower+"|"+rsMisc+")",rsUpperMisc="(?:"+rsUpper+"|"+rsMisc+")",reOptMod="(?:"+rsCombo+"|"+rsFitz+")"+"?",rsSeq="[\\ufe0e\\ufe0f]?"+reOptMod+("(?:\\u200d(?:"+[rsNonAstral,rsRegional,rsSurrPair].join("|")+")[\\ufe0e\\ufe0f]?"+reOptMod+")*"),rsEmoji="(?:"+[rsDingbat,rsRegional,rsSurrPair].join("|")+")"+rsSeq,rsSymbol="(?:"+[rsNonAstral+rsCombo+"?",rsCombo,rsRegional,rsSurrPair,rsAstral].join("|")+")",reApos=RegExp("['\u2019]","g"),reComboMark=RegExp(rsCombo,"g"),reUnicode=RegExp(rsFitz+"(?="+rsFitz+")|"+rsSymbol+rsSeq,"g"),reUnicodeWord=RegExp([rsUpper+"?"+rsLower+"+(?:['\u2019](?:d|ll|m|re|s|t|ve))?(?="+[rsBreak,rsUpper,"$"].join("|")+")",rsUpperMisc+"+(?:['\u2019](?:D|LL|M|RE|S|T|VE))?(?="+[rsBreak,rsUpper+rsLowerMisc,"$"].join("|")+")",rsUpper+"?"+rsLowerMisc+"+(?:['\u2019](?:d|ll|m|re|s|t|ve))?",rsUpper+"+(?:['\u2019](?:D|LL|M|RE|S|T|VE))?",rsDigits,rsEmoji].join("|"),"g"),reHasUnicode=RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe23\\u20d0-\\u20f0\\ufe0e\\ufe0f]"),reHasUnicodeWord=/[a-z][A-Z]|[A-Z]{2,}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,freeGlobal="object"==typeof global&&global&&global.Object===Object&&global,freeSelf="object"==typeof self&&self&&self.Object===Object&&self,root=freeGlobal||freeSelf||Function("return this")();var deburrLetter=function basePropertyOf(object){return function(key){return null==object?void 0:object[key]}}({"\xc0":"A","\xc1":"A","\xc2":"A","\xc3":"A","\xc4":"A","\xc5":"A","\xe0":"a","\xe1":"a","\xe2":"a","\xe3":"a","\xe4":"a","\xe5":"a","\xc7":"C","\xe7":"c","\xd0":"D","\xf0":"d","\xc8":"E","\xc9":"E","\xca":"E","\xcb":"E","\xe8":"e","\xe9":"e","\xea":"e","\xeb":"e","\xcc":"I","\xcd":"I","\xce":"I","\xcf":"I","\xec":"i","\xed":"i","\xee":"i","\xef":"i","\xd1":"N","\xf1":"n","\xd2":"O","\xd3":"O","\xd4":"O","\xd5":"O","\xd6":"O","\xd8":"O","\xf2":"o","\xf3":"o","\xf4":"o","\xf5":"o","\xf6":"o","\xf8":"o","\xd9":"U","\xda":"U","\xdb":"U","\xdc":"U","\xf9":"u","\xfa":"u","\xfb":"u","\xfc":"u","\xdd":"Y","\xfd":"y","\xff":"y","\xc6":"Ae","\xe6":"ae","\xde":"Th","\xfe":"th","\xdf":"ss","\u0100":"A","\u0102":"A","\u0104":"A","\u0101":"a","\u0103":"a","\u0105":"a","\u0106":"C","\u0108":"C","\u010a":"C","\u010c":"C","\u0107":"c","\u0109":"c","\u010b":"c","\u010d":"c","\u010e":"D","\u0110":"D","\u010f":"d","\u0111":"d","\u0112":"E","\u0114":"E","\u0116":"E","\u0118":"E","\u011a":"E","\u0113":"e","\u0115":"e","\u0117":"e","\u0119":"e","\u011b":"e","\u011c":"G","\u011e":"G","\u0120":"G","\u0122":"G","\u011d":"g","\u011f":"g","\u0121":"g","\u0123":"g","\u0124":"H","\u0126":"H","\u0125":"h","\u0127":"h","\u0128":"I","\u012a":"I","\u012c":"I","\u012e":"I","\u0130":"I","\u0129":"i","\u012b":"i","\u012d":"i","\u012f":"i","\u0131":"i","\u0134":"J","\u0135":"j","\u0136":"K","\u0137":"k","\u0138":"k","\u0139":"L","\u013b":"L","\u013d":"L","\u013f":"L","\u0141":"L","\u013a":"l","\u013c":"l","\u013e":"l","\u0140":"l","\u0142":"l","\u0143":"N","\u0145":"N","\u0147":"N","\u014a":"N","\u0144":"n","\u0146":"n","\u0148":"n","\u014b":"n","\u014c":"O","\u014e":"O","\u0150":"O","\u014d":"o","\u014f":"o","\u0151":"o","\u0154":"R","\u0156":"R","\u0158":"R","\u0155":"r","\u0157":"r","\u0159":"r","\u015a":"S","\u015c":"S","\u015e":"S","\u0160":"S","\u015b":"s","\u015d":"s","\u015f":"s","\u0161":"s","\u0162":"T","\u0164":"T","\u0166":"T","\u0163":"t","\u0165":"t","\u0167":"t","\u0168":"U","\u016a":"U","\u016c":"U","\u016e":"U","\u0170":"U","\u0172":"U","\u0169":"u","\u016b":"u","\u016d":"u","\u016f":"u","\u0171":"u","\u0173":"u","\u0174":"W","\u0175":"w","\u0176":"Y","\u0177":"y","\u0178":"Y","\u0179":"Z","\u017b":"Z","\u017d":"Z","\u017a":"z","\u017c":"z","\u017e":"z","\u0132":"IJ","\u0133":"ij","\u0152":"Oe","\u0153":"oe","\u0149":"'n","\u017f":"ss"});function hasUnicode(string){return reHasUnicode.test(string)}function stringToArray(string){return hasUnicode(string)?function unicodeToArray(string){return string.match(reUnicode)||[]}(string):function asciiToArray(string){return string.split("")}(string)}var objectToString=Object.prototype.toString,Symbol=root.Symbol,symbolProto=Symbol?Symbol.prototype:void 0,symbolToString=symbolProto?symbolProto.toString:void 0;function baseToString(value){if("string"==typeof value)return value;if(function isSymbol(value){return"symbol"==typeof value||function isObjectLike(value){return!!value&&"object"==typeof value}(value)&&"[object Symbol]"==objectToString.call(value)}(value))return symbolToString?symbolToString.call(value):"";var result=value+"";return"0"==result&&1/value==-Infinity?"-0":result}function castSlice(array,start,end){var length=array.length;return end=void 0===end?length:end,!start&&end>=length?array:function baseSlice(array,start,end){var index=-1,length=array.length;start<0&&(start=-start>length?0:length+start),(end=end>length?length:end)<0&&(end+=length),length=start>end?0:end-start>>>0,start>>>=0;for(var result=Array(length);++index<length;)result[index]=array[index+start];return result}(array,start,end)}function toString(value){return null==value?"":baseToString(value)}var camelCase=function createCompounder(callback){return function(string){return function arrayReduce(array,iteratee,accumulator,initAccum){var index=-1,length=array?array.length:0;for(initAccum&&length&&(accumulator=array[++index]);++index<length;)accumulator=iteratee(accumulator,array[index],index,array);return accumulator}(function words(string,pattern,guard){if(string=toString(string),void 0===(pattern=guard?void 0:pattern))return function hasUnicodeWord(string){return reHasUnicodeWord.test(string)}(string)?function unicodeWords(string){return string.match(reUnicodeWord)||[]}(string):function asciiWords(string){return string.match(reAsciiWord)||[]}(string);return string.match(pattern)||[]}(function deburr(string){return(string=toString(string))&&string.replace(reLatin,deburrLetter).replace(reComboMark,"")}(string).replace(reApos,"")),callback,"")}}(function(result,word,index){return word=word.toLowerCase(),result+(index?function capitalize(string){return upperFirst(toString(string).toLowerCase())}(word):word)});var upperFirst=function createCaseFirst(methodName){return function(string){var strSymbols=hasUnicode(string=toString(string))?stringToArray(string):void 0,chr=strSymbols?strSymbols[0]:string.charAt(0),trailing=strSymbols?castSlice(strSymbols,1).join(""):string.slice(1);return chr[methodName]()+trailing}}("toUpperCase");module.exports=camelCase},"5etU":function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.setup=void 0;const resolver_1=__webpack_require__("9rQR");class UdsResolver{constructor(target,listener,channelOptions){let path;this.listener=listener,this.addresses=[],path=""===target.authority?"/"+target.path:target.path,this.addresses=[{path:path}]}updateResolution(){process.nextTick(this.listener.onSuccessfulResolution,this.addresses,null,null,null,{})}destroy(){}static getDefaultAuthority(target){return"localhost"}}exports.setup=function setup(){resolver_1.registerResolver("unix",UdsResolver)}},"6Tgl":function(module,exports,__webpack_require__){"use strict";var util=exports;function merge(dst,src,ifNotSet){for(var keys=Object.keys(src),i=0;i<keys.length;++i)void 0!==dst[keys[i]]&&ifNotSet||(dst[keys[i]]=src[keys[i]]);return dst}function newError(name){function CustomError(message,properties){if(!(this instanceof CustomError))return new CustomError(message,properties);Object.defineProperty(this,"message",{get:function(){return message}}),Error.captureStackTrace?Error.captureStackTrace(this,CustomError):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),properties&&merge(this,properties)}return(CustomError.prototype=Object.create(Error.prototype)).constructor=CustomError,Object.defineProperty(CustomError.prototype,"name",{get:function(){return name}}),CustomError.prototype.toString=function toString(){return this.name+": "+this.message},CustomError}util.asPromise=__webpack_require__("MFts"),util.base64=__webpack_require__("bnU+"),util.EventEmitter=__webpack_require__("aJe0"),util.float=__webpack_require__("KwGI"),util.inquire=__webpack_require__("1Giq"),util.utf8=__webpack_require__("yNTq"),util.pool=__webpack_require__("BEY9"),util.LongBits=__webpack_require__("o4Qh"),util.isNode=Boolean("undefined"!=typeof global&&global&&global.process&&global.process.versions&&global.process.versions.node),util.global=util.isNode&&global||"undefined"!=typeof window&&window||"undefined"!=typeof self&&self||this,util.emptyArray=Object.freeze?Object.freeze([]):[],util.emptyObject=Object.freeze?Object.freeze({}):{},util.isInteger=Number.isInteger||function isInteger(value){return"number"==typeof value&&isFinite(value)&&Math.floor(value)===value},util.isString=function isString(value){return"string"==typeof value||value instanceof String},util.isObject=function isObject(value){return value&&"object"==typeof value},util.isset=util.isSet=function isSet(obj,prop){var value=obj[prop];return!(null==value||!obj.hasOwnProperty(prop))&&("object"!=typeof value||(Array.isArray(value)?value.length:Object.keys(value).length)>0)},util.Buffer=function(){try{var Buffer=util.inquire("buffer").Buffer;return Buffer.prototype.utf8Write?Buffer:null}catch(e){return null}}(),util._Buffer_from=null,util._Buffer_allocUnsafe=null,util.newBuffer=function newBuffer(sizeOrArray){return"number"==typeof sizeOrArray?util.Buffer?util._Buffer_allocUnsafe(sizeOrArray):new util.Array(sizeOrArray):util.Buffer?util._Buffer_from(sizeOrArray):"undefined"==typeof Uint8Array?sizeOrArray:new Uint8Array(sizeOrArray)},util.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,util.Long=util.global.dcodeIO&&util.global.dcodeIO.Long||util.global.Long||util.inquire("long"),util.key2Re=/^true|false|0|1$/,util.key32Re=/^-?(?:0|[1-9][0-9]*)$/,util.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,util.longToHash=function longToHash(value){return value?util.LongBits.from(value).toHash():util.LongBits.zeroHash},util.longFromHash=function longFromHash(hash,unsigned){var bits=util.LongBits.fromHash(hash);return util.Long?util.Long.fromBits(bits.lo,bits.hi,unsigned):bits.toNumber(Boolean(unsigned))},util.merge=merge,util.lcFirst=function lcFirst(str){return str.charAt(0).toLowerCase()+str.substring(1)},util.newError=newError,util.ProtocolError=newError("ProtocolError"),util.oneOfGetter=function getOneOf(fieldNames){for(var fieldMap={},i=0;i<fieldNames.length;++i)fieldMap[fieldNames[i]]=1;return function(){for(var keys=Object.keys(this),i=keys.length-1;i>-1;--i)if(1===fieldMap[keys[i]]&&void 0!==this[keys[i]]&&null!==this[keys[i]])return keys[i]}},util.oneOfSetter=function setOneOf(fieldNames){return function(name){for(var i=0;i<fieldNames.length;++i)fieldNames[i]!==name&&delete this[fieldNames[i]]}},util.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},util._configure=function(){var Buffer=util.Buffer;Buffer?(util._Buffer_from=Buffer.from!==Uint8Array.from&&Buffer.from||function Buffer_from(value,encoding){return new Buffer(value,encoding)},util._Buffer_allocUnsafe=Buffer.allocUnsafe||function Buffer_allocUnsafe(size){return new Buffer(size)}):util._Buffer_from=util._Buffer_allocUnsafe=null}},"6XSn":function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ChannelImplementation=exports.ConnectivityState=void 0;const call_stream_1=__webpack_require__("hfvT"),channel_credentials_1=__webpack_require__("mr48"),resolving_load_balancer_1=__webpack_require__("bQ6e"),subchannel_pool_1=__webpack_require__("+Lud"),picker_1=__webpack_require__("mVN3"),constants_1=__webpack_require__("8o9P"),filter_stack_1=__webpack_require__("Za3E"),call_credentials_filter_1=__webpack_require__("v+/A"),deadline_filter_1=__webpack_require__("xN2E"),compression_filter_1=__webpack_require__("Nr3n"),resolver_1=__webpack_require__("9rQR"),logging_1=__webpack_require__("xQiD"),max_message_size_filter_1=__webpack_require__("AUsp"),http_proxy_1=__webpack_require__("BJPX"),uri_parser_1=__webpack_require__("x8Ej");var ConnectivityState;!function(ConnectivityState){ConnectivityState[ConnectivityState.IDLE=0]="IDLE",ConnectivityState[ConnectivityState.CONNECTING=1]="CONNECTING",ConnectivityState[ConnectivityState.READY=2]="READY",ConnectivityState[ConnectivityState.TRANSIENT_FAILURE=3]="TRANSIENT_FAILURE",ConnectivityState[ConnectivityState.SHUTDOWN=4]="SHUTDOWN"}(ConnectivityState=exports.ConnectivityState||(exports.ConnectivityState={}));let nextCallNumber=0;exports.ChannelImplementation=class{constructor(target,credentials,options){var _a,_b,_c;if(this.credentials=credentials,this.options=options,this.connectivityState=ConnectivityState.IDLE,this.currentPicker=new picker_1.UnavailablePicker,this.configSelectionQueue=[],this.pickQueue=[],this.connectivityStateWatchers=[],this.configSelector=null,"string"!=typeof target)throw new TypeError("Channel target must be a string");if(!(credentials instanceof channel_credentials_1.ChannelCredentials))throw new TypeError("Channel credentials must be a ChannelCredentials object");if(options&&("object"!=typeof options||!Object.values(options).every(value=>"string"==typeof value||"number"==typeof value||void 0===value)))throw new TypeError("Channel options must be an object with string or number values");const originalTargetUri=uri_parser_1.parseUri(target);if(null===originalTargetUri)throw new Error(`Could not parse target name "${target}"`);const defaultSchemeMapResult=resolver_1.mapUriDefaultScheme(originalTargetUri);if(null===defaultSchemeMapResult)throw new Error(`Could not find a default scheme for target name "${target}"`);this.callRefTimer=setInterval(()=>{},2147483647),null===(_b=(_a=this.callRefTimer).unref)||void 0===_b||_b.call(_a),this.options["grpc.default_authority"]?this.defaultAuthority=this.options["grpc.default_authority"]:this.defaultAuthority=resolver_1.getDefaultAuthority(defaultSchemeMapResult);const proxyMapResult=http_proxy_1.mapProxyName(defaultSchemeMapResult,options);this.target=proxyMapResult.target,this.options=Object.assign({},this.options,proxyMapResult.extraOptions),this.subchannelPool=subchannel_pool_1.getSubchannelPool(0===(null!==(_c=options["grpc.use_local_subchannel_pool"])&&void 0!==_c?_c:0));const channelControlHelper={createSubchannel:(subchannelAddress,subchannelArgs)=>this.subchannelPool.getOrCreateSubchannel(this.target,subchannelAddress,Object.assign({},this.options,subchannelArgs),this.credentials),updateState:(connectivityState,picker)=>{this.currentPicker=picker;const queueCopy=this.pickQueue.slice();this.pickQueue=[],this.callRefTimerUnref();for(const{callStream:callStream,callMetadata:callMetadata,callConfig:callConfig}of queueCopy)this.tryPick(callStream,callMetadata,callConfig);this.updateState(connectivityState)},requestReresolution:()=>{throw new Error("Resolving load balancer should never call requestReresolution")}};this.resolvingLoadBalancer=new resolving_load_balancer_1.ResolvingLoadBalancer(this.target,channelControlHelper,options,configSelector=>{this.configSelector=configSelector,process.nextTick(()=>{const localQueue=this.configSelectionQueue;this.configSelectionQueue=[],this.callRefTimerUnref();for(const{callStream:callStream,callMetadata:callMetadata}of localQueue)this.tryGetConfig(callStream,callMetadata);this.configSelectionQueue=[]})},status=>{this.configSelectionQueue.length>0&&logging_1.trace(constants_1.LogVerbosity.DEBUG,"channel","Name resolution failed for target "+uri_parser_1.uriToString(this.target)+" with calls queued for config selection");const localQueue=this.configSelectionQueue;this.configSelectionQueue=[],this.callRefTimerUnref();for(const{callStream:callStream,callMetadata:callMetadata}of localQueue)callMetadata.getOptions().waitForReady?(this.callRefTimerRef(),this.configSelectionQueue.push({callStream:callStream,callMetadata:callMetadata})):callStream.cancelWithStatus(status.code,status.details)}),this.filterStackFactory=new filter_stack_1.FilterStackFactory([new call_credentials_filter_1.CallCredentialsFilterFactory(this),new deadline_filter_1.DeadlineFilterFactory(this),new max_message_size_filter_1.MaxMessageSizeFilterFactory(this.options),new compression_filter_1.CompressionFilterFactory(this)])}callRefTimerRef(){var _a,_b,_c,_d;(null===(_b=(_a=this.callRefTimer).hasRef)||void 0===_b?void 0:_b.call(_a))||(logging_1.trace(constants_1.LogVerbosity.DEBUG,"channel","callRefTimer.ref | configSelectionQueue.length="+this.configSelectionQueue.length+" pickQueue.length="+this.pickQueue.length),null===(_d=(_c=this.callRefTimer).ref)||void 0===_d||_d.call(_c))}callRefTimerUnref(){var _a,_b;this.callRefTimer.hasRef&&!this.callRefTimer.hasRef()||(logging_1.trace(constants_1.LogVerbosity.DEBUG,"channel","callRefTimer.unref | configSelectionQueue.length="+this.configSelectionQueue.length+" pickQueue.length="+this.pickQueue.length),null===(_b=(_a=this.callRefTimer).unref)||void 0===_b||_b.call(_a))}pushPick(callStream,callMetadata,callConfig){this.pickQueue.push({callStream:callStream,callMetadata:callMetadata,callConfig:callConfig}),this.callRefTimerRef()}tryPick(callStream,callMetadata,callConfig){var _a,_b,_c;const pickResult=this.currentPicker.pick({metadata:callMetadata,extraPickInfo:callConfig.pickInformation});switch(logging_1.trace(constants_1.LogVerbosity.DEBUG,"channel","Pick result: "+picker_1.PickResultType[pickResult.pickResultType]+" subchannel: "+(null===(_a=pickResult.subchannel)||void 0===_a?void 0:_a.getAddress())+" status: "+(null===(_b=pickResult.status)||void 0===_b?void 0:_b.code)+" "+(null===(_c=pickResult.status)||void 0===_c?void 0:_c.details)),pickResult.pickResultType){case picker_1.PickResultType.COMPLETE:if(null===pickResult.subchannel)callStream.cancelWithStatus(constants_1.Status.UNAVAILABLE,"Request dropped by load balancing policy");else{if(pickResult.subchannel.getConnectivityState()!==ConnectivityState.READY){logging_1.log(constants_1.LogVerbosity.ERROR,"Error: COMPLETE pick result subchannel "+pickResult.subchannel.getAddress()+" has state "+ConnectivityState[pickResult.subchannel.getConnectivityState()]),this.pushPick(callStream,callMetadata,callConfig);break}callStream.filterStack.sendMetadata(Promise.resolve(callMetadata.clone())).then(finalMetadata=>{var _a,_b,_c;const subchannelState=pickResult.subchannel.getConnectivityState();if(subchannelState===ConnectivityState.READY)try{pickResult.subchannel.startCallStream(finalMetadata,callStream,null!==(_a=pickResult.extraFilterFactory)&&void 0!==_a?_a:void 0),null===(_b=callConfig.onCommitted)||void 0===_b||_b.call(callConfig),null===(_c=pickResult.onCallStarted)||void 0===_c||_c.call(pickResult)}catch(error){"ERR_HTTP2_GOAWAY_SESSION"===error.code?(logging_1.trace(constants_1.LogVerbosity.INFO,"channel","Failed to start call on picked subchannel "+pickResult.subchannel.getAddress()+" with error "+error.message+". Retrying pick"),this.tryPick(callStream,callMetadata,callConfig)):(logging_1.trace(constants_1.LogVerbosity.INFO,"channel","Failed to start call on picked subchanel "+pickResult.subchannel.getAddress()+" with error "+error.message+". Ending call"),callStream.cancelWithStatus(constants_1.Status.INTERNAL,`Failed to start HTTP/2 stream with error: ${error.message}`))}else logging_1.trace(constants_1.LogVerbosity.INFO,"channel","Picked subchannel "+pickResult.subchannel.getAddress()+" has state "+ConnectivityState[subchannelState]+" after metadata filters. Retrying pick"),this.tryPick(callStream,callMetadata,callConfig)},error=>{callStream.cancelWithStatus("number"==typeof error.code?error.code:constants_1.Status.UNKNOWN,`Getting metadata from plugin failed with error: ${error.message}`)})}break;case picker_1.PickResultType.QUEUE:this.pushPick(callStream,callMetadata,callConfig);break;case picker_1.PickResultType.TRANSIENT_FAILURE:callMetadata.getOptions().waitForReady?this.pushPick(callStream,callMetadata,callConfig):callStream.cancelWithStatus(pickResult.status.code,pickResult.status.details);break;case picker_1.PickResultType.DROP:callStream.cancelWithStatus(pickResult.status.code,pickResult.status.details);break;default:throw new Error(`Invalid state: unknown pickResultType ${pickResult.pickResultType}`)}}removeConnectivityStateWatcher(watcherObject){const watcherIndex=this.connectivityStateWatchers.findIndex(value=>value===watcherObject);watcherIndex>=0&&this.connectivityStateWatchers.splice(watcherIndex,1)}updateState(newState){logging_1.trace(constants_1.LogVerbosity.DEBUG,"connectivity_state",uri_parser_1.uriToString(this.target)+" "+ConnectivityState[this.connectivityState]+" -> "+ConnectivityState[newState]),this.connectivityState=newState;const watchersCopy=this.connectivityStateWatchers.slice();for(const watcherObject of watchersCopy)newState!==watcherObject.currentState&&(watcherObject.timer&&clearTimeout(watcherObject.timer),this.removeConnectivityStateWatcher(watcherObject),watcherObject.callback())}tryGetConfig(stream,metadata){if(null===this.configSelector)this.resolvingLoadBalancer.exitIdle(),this.configSelectionQueue.push({callStream:stream,callMetadata:metadata}),this.callRefTimerRef();else{const callConfig=this.configSelector(stream.getMethod(),metadata);callConfig.status===constants_1.Status.OK?this.tryPick(stream,metadata,callConfig):stream.cancelWithStatus(callConfig.status,"Failed to route call to method "+stream.getMethod())}}_startCallStream(stream,metadata){this.tryGetConfig(stream,metadata.clone())}close(){this.resolvingLoadBalancer.destroy(),this.updateState(ConnectivityState.SHUTDOWN),clearInterval(this.callRefTimer),this.subchannelPool.unrefUnusedSubchannels()}getTarget(){return uri_parser_1.uriToString(this.target)}getConnectivityState(tryToConnect){const connectivityState=this.connectivityState;return tryToConnect&&this.resolvingLoadBalancer.exitIdle(),connectivityState}watchConnectivityState(currentState,deadline,callback){if(this.connectivityState===ConnectivityState.SHUTDOWN)throw new Error("Channel has been shut down");let timer=null;if(deadline!==1/0){const deadlineDate=deadline instanceof Date?deadline:new Date(deadline),now=new Date;if(deadline===-1/0||deadlineDate<=now)return void process.nextTick(callback,new Error("Deadline passed without connectivity state change"));timer=setTimeout(()=>{this.removeConnectivityStateWatcher(watcherObject),callback(new Error("Deadline passed without connectivity state change"))},deadlineDate.getTime()-now.getTime())}const watcherObject={currentState:currentState,callback:callback,timer:timer};this.connectivityStateWatchers.push(watcherObject)}createCall(method,deadline,host,parentCall,propagateFlags){if("string"!=typeof method)throw new TypeError("Channel#createCall: method must be a string");if(!("number"==typeof deadline||deadline instanceof Date))throw new TypeError("Channel#createCall: deadline must be a number or Date");if(this.connectivityState===ConnectivityState.SHUTDOWN)throw new Error("Channel has been shut down");const callNumber=function getNewCallNumber(){const callNumber=nextCallNumber;return nextCallNumber+=1,nextCallNumber>=Number.MAX_SAFE_INTEGER&&(nextCallNumber=0),callNumber}();logging_1.trace(constants_1.LogVerbosity.DEBUG,"channel",uri_parser_1.uriToString(this.target)+" createCall ["+callNumber+'] method="'+method+'", deadline='+deadline);const finalOptions={deadline:deadline,flags:null!=propagateFlags?propagateFlags:constants_1.Propagate.DEFAULTS,host:null!=host?host:this.defaultAuthority,parentCall:parentCall};return new call_stream_1.Http2CallStream(method,this,finalOptions,this.filterStackFactory,this.credentials._getCallCredentials(),callNumber)}}},"6wl5":function(module,exports,__webpack_require__){"use strict";function codegen(functionParams,functionName){"string"==typeof functionParams&&(functionName=functionParams,functionParams=void 0);var body=[];function Codegen(formatStringOrScope){if("string"!=typeof formatStringOrScope){var source=toString();if(codegen.verbose&&console.log("codegen: "+source),source="return "+source,formatStringOrScope){for(var scopeKeys=Object.keys(formatStringOrScope),scopeParams=new Array(scopeKeys.length+1),scopeValues=new Array(scopeKeys.length),scopeOffset=0;scopeOffset<scopeKeys.length;)scopeParams[scopeOffset]=scopeKeys[scopeOffset],scopeValues[scopeOffset]=formatStringOrScope[scopeKeys[scopeOffset++]];return scopeParams[scopeOffset]=source,Function.apply(null,scopeParams).apply(null,scopeValues)}return Function(source)()}for(var formatParams=new Array(arguments.length-1),formatOffset=0;formatOffset<formatParams.length;)formatParams[formatOffset]=arguments[++formatOffset];if(formatOffset=0,formatStringOrScope=formatStringOrScope.replace(/%([%dfijs])/g,function replace($0,$1){var value=formatParams[formatOffset++];switch($1){case"d":case"f":return String(Number(value));case"i":return String(Math.floor(value));case"j":return JSON.stringify(value);case"s":return String(value)}return"%"}),formatOffset!==formatParams.length)throw Error("parameter count mismatch");return body.push(formatStringOrScope),Codegen}function toString(functionNameOverride){return"function "+(functionNameOverride||functionName||"")+"("+(functionParams&&functionParams.join(",")||"")+"){\n  "+body.join("\n  ")+"\n}"}return Codegen.toString=toString,Codegen}module.exports=codegen,codegen.verbose=!1},"7m6H":function(module,exports,__webpack_require__){"use strict";module.exports=Root;var Namespace=__webpack_require__("fgco");((Root.prototype=Object.create(Namespace.prototype)).constructor=Root).className="Root";var Type,parse,common,Field=__webpack_require__("pqPr"),Enum=__webpack_require__("vREW"),OneOf=__webpack_require__("d+r3"),util=__webpack_require__("y9PA");function Root(options){Namespace.call(this,"",options),this.deferred=[],this.files=[]}function SYNC(){}Root.fromJSON=function fromJSON(json,root){return root||(root=new Root),json.options&&root.setOptions(json.options),root.addJSON(json.nested)},Root.prototype.resolvePath=util.path.resolve,Root.prototype.fetch=util.fetch,Root.prototype.load=function load(filename,options,callback){"function"==typeof options&&(callback=options,options=void 0);var self=this;if(!callback)return util.asPromise(load,self,filename,options);var sync=callback===SYNC;function finish(err,root){if(callback){var cb=callback;if(callback=null,sync)throw err;cb(err,root)}}function getBundledFileName(filename){var idx=filename.lastIndexOf("google/protobuf/");if(idx>-1){var altname=filename.substring(idx);if(altname in common)return altname}return null}function process(filename,source){try{if(util.isString(source)&&"{"===source.charAt(0)&&(source=JSON.parse(source)),util.isString(source)){parse.filename=filename;var resolved,parsed=parse(source,self,options),i=0;if(parsed.imports)for(;i<parsed.imports.length;++i)(resolved=getBundledFileName(parsed.imports[i])||self.resolvePath(filename,parsed.imports[i]))&&fetch(resolved);if(parsed.weakImports)for(i=0;i<parsed.weakImports.length;++i)(resolved=getBundledFileName(parsed.weakImports[i])||self.resolvePath(filename,parsed.weakImports[i]))&&fetch(resolved,!0)}else self.setOptions(source.options).addJSON(source.nested)}catch(err){finish(err)}sync||queued||finish(null,self)}function fetch(filename,weak){if(!(self.files.indexOf(filename)>-1))if(self.files.push(filename),filename in common)sync?process(filename,common[filename]):(++queued,setTimeout(function(){--queued,process(filename,common[filename])}));else if(sync){var source;try{source=util.fs.readFileSync(filename).toString("utf8")}catch(err){return void(weak||finish(err))}process(filename,source)}else++queued,self.fetch(filename,function(err,source){--queued,callback&&(err?weak?queued||finish(null,self):finish(err):process(filename,source))})}var queued=0;util.isString(filename)&&(filename=[filename]);for(var resolved,i=0;i<filename.length;++i)(resolved=self.resolvePath("",filename[i]))&&fetch(resolved);if(sync)return self;queued||finish(null,self)},Root.prototype.loadSync=function loadSync(filename,options){if(!util.isNode)throw Error("not supported");return this.load(filename,options,SYNC)},Root.prototype.resolveAll=function resolveAll(){if(this.deferred.length)throw Error("unresolvable extensions: "+this.deferred.map(function(field){return"'extend "+field.extend+"' in "+field.parent.fullName}).join(", "));return Namespace.prototype.resolveAll.call(this)};var exposeRe=/^[A-Z]/;function tryHandleExtension(root,field){var extendedType=field.parent.lookup(field.extend);if(extendedType){var sisterField=new Field(field.fullName,field.id,field.type,field.rule,void 0,field.options);return sisterField.declaringField=field,field.extensionField=sisterField,extendedType.add(sisterField),!0}return!1}Root.prototype._handleAdd=function _handleAdd(object){if(object instanceof Field)void 0===object.extend||object.extensionField||tryHandleExtension(0,object)||this.deferred.push(object);else if(object instanceof Enum)exposeRe.test(object.name)&&(object.parent[object.name]=object.values);else if(!(object instanceof OneOf)){if(object instanceof Type)for(var i=0;i<this.deferred.length;)tryHandleExtension(0,this.deferred[i])?this.deferred.splice(i,1):++i;for(var j=0;j<object.nestedArray.length;++j)this._handleAdd(object._nestedArray[j]);exposeRe.test(object.name)&&(object.parent[object.name]=object)}},Root.prototype._handleRemove=function _handleRemove(object){if(object instanceof Field){if(void 0!==object.extend)if(object.extensionField)object.extensionField.parent.remove(object.extensionField),object.extensionField=null;else{var index=this.deferred.indexOf(object);index>-1&&this.deferred.splice(index,1)}}else if(object instanceof Enum)exposeRe.test(object.name)&&delete object.parent[object.name];else if(object instanceof Namespace){for(var i=0;i<object.nestedArray.length;++i)this._handleRemove(object._nestedArray[i]);exposeRe.test(object.name)&&delete object.parent[object.name]}},Root._configure=function(Type_,parse_,common_){Type=Type_,parse=parse_,common=common_}},"8ZNE":function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const camelCase=__webpack_require__("5cLd"),Protobuf=__webpack_require__("+hx4"),descriptor=__webpack_require__("PFer"),util_1=__webpack_require__("iWXB");exports.isAnyExtension=function isAnyExtension(obj){return"@type"in obj&&"string"==typeof obj["@type"]};const descriptorOptions={longs:String,enums:String,bytes:String,defaults:!0,oneofs:!0,json:!0};function getAllHandledReflectionObjects(obj,parentName){const objName=function joinName(baseName,name){return""===baseName?name:baseName+"."+name}(parentName,obj.name);return function isHandledReflectionObject(obj){return obj instanceof Protobuf.Service||obj instanceof Protobuf.Type||obj instanceof Protobuf.Enum}(obj)?[[objName,obj]]:function isNamespaceBase(obj){return obj instanceof Protobuf.Namespace||obj instanceof Protobuf.Root}(obj)&&void 0!==obj.nested?Object.keys(obj.nested).map(name=>getAllHandledReflectionObjects(obj.nested[name],objName)).reduce((accumulator,currentValue)=>accumulator.concat(currentValue),[]):[]}function createDeserializer(cls,options){return function deserialize(argBuf){return cls.toObject(cls.decode(argBuf),options)}}function createSerializer(cls){return function serialize(arg){const message=cls.fromObject(arg);return cls.encode(message).finish()}}function createMethodDefinition(method,serviceName,options,fileDescriptors){const requestType=method.resolvedRequestType,responseType=method.resolvedResponseType;return{path:"/"+serviceName+"/"+method.name,requestStream:!!method.requestStream,responseStream:!!method.responseStream,requestSerialize:createSerializer(requestType),requestDeserialize:createDeserializer(requestType,options),responseSerialize:createSerializer(responseType),responseDeserialize:createDeserializer(responseType,options),originalName:camelCase(method.name),requestType:createMessageDefinition(requestType,fileDescriptors),responseType:createMessageDefinition(responseType,fileDescriptors)}}function createMessageDefinition(message,fileDescriptors){const messageDescriptor=message.toDescriptor("proto3");return{format:"Protocol Buffer 3 DescriptorProto",type:messageDescriptor.$type.toObject(messageDescriptor,descriptorOptions),fileDescriptorProtos:fileDescriptors}}function createDefinition(obj,name,options,fileDescriptors){if(obj instanceof Protobuf.Service)return function createServiceDefinition(service,name,options,fileDescriptors){const def={};for(const method of service.methodsArray)def[method.name]=createMethodDefinition(method,name,options,fileDescriptors);return def}(obj,name,options,fileDescriptors);if(obj instanceof Protobuf.Type)return createMessageDefinition(obj,fileDescriptors);if(obj instanceof Protobuf.Enum)return function createEnumDefinition(enumType,fileDescriptors){const enumDescriptor=enumType.toDescriptor("proto3");return{format:"Protocol Buffer 3 EnumDescriptorProto",type:enumDescriptor.$type.toObject(enumDescriptor,descriptorOptions),fileDescriptorProtos:fileDescriptors}}(obj,fileDescriptors);throw new Error("Type mismatch in reflection object handling")}function createPackageDefinition(root,options){const def={};root.resolveAll();const bufferList=root.toDescriptor("proto3").file.map(value=>Buffer.from(descriptor.FileDescriptorProto.encode(value).finish()));for(const[name,obj]of getAllHandledReflectionObjects(root,""))def[name]=createDefinition(obj,name,options,bufferList);return def}function createPackageDefinitionFromDescriptorSet(decodedDescriptorSet,options){options=options||{};const root=Protobuf.Root.fromDescriptor(decodedDescriptorSet);return root.resolveAll(),createPackageDefinition(root,options)}exports.load=function load(filename,options){return util_1.loadProtosWithOptions(filename,options).then(loadedRoot=>createPackageDefinition(loadedRoot,options))},exports.loadSync=function loadSync(filename,options){return createPackageDefinition(util_1.loadProtosWithOptionsSync(filename,options),options)},exports.fromJSON=function fromJSON(json,options){options=options||{};const loadedRoot=Protobuf.Root.fromJSON(json);return loadedRoot.resolveAll(),createPackageDefinition(loadedRoot,options)},exports.loadFileDescriptorSetFromBuffer=function loadFileDescriptorSetFromBuffer(descriptorSet,options){return createPackageDefinitionFromDescriptorSet(descriptor.FileDescriptorSet.decode(descriptorSet),options)},exports.loadFileDescriptorSetFromObject=function loadFileDescriptorSetFromObject(descriptorSet,options){return createPackageDefinitionFromDescriptorSet(descriptor.FileDescriptorSet.fromObject(descriptorSet),options)},util_1.addCommonProtos()},"8o9P":function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.DEFAULT_MAX_RECEIVE_MESSAGE_LENGTH=exports.DEFAULT_MAX_SEND_MESSAGE_LENGTH=exports.Propagate=exports.LogVerbosity=exports.Status=void 0,function(Status){Status[Status.OK=0]="OK",Status[Status.CANCELLED=1]="CANCELLED",Status[Status.UNKNOWN=2]="UNKNOWN",Status[Status.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Status[Status.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Status[Status.NOT_FOUND=5]="NOT_FOUND",Status[Status.ALREADY_EXISTS=6]="ALREADY_EXISTS",Status[Status.PERMISSION_DENIED=7]="PERMISSION_DENIED",Status[Status.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Status[Status.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Status[Status.ABORTED=10]="ABORTED",Status[Status.OUT_OF_RANGE=11]="OUT_OF_RANGE",Status[Status.UNIMPLEMENTED=12]="UNIMPLEMENTED",Status[Status.INTERNAL=13]="INTERNAL",Status[Status.UNAVAILABLE=14]="UNAVAILABLE",Status[Status.DATA_LOSS=15]="DATA_LOSS",Status[Status.UNAUTHENTICATED=16]="UNAUTHENTICATED"}(exports.Status||(exports.Status={})),function(LogVerbosity){LogVerbosity[LogVerbosity.DEBUG=0]="DEBUG",LogVerbosity[LogVerbosity.INFO=1]="INFO",LogVerbosity[LogVerbosity.ERROR=2]="ERROR",LogVerbosity[LogVerbosity.NONE=3]="NONE"}(exports.LogVerbosity||(exports.LogVerbosity={})),function(Propagate){Propagate[Propagate.DEADLINE=1]="DEADLINE",Propagate[Propagate.CENSUS_STATS_CONTEXT=2]="CENSUS_STATS_CONTEXT",Propagate[Propagate.CENSUS_TRACING_CONTEXT=4]="CENSUS_TRACING_CONTEXT",Propagate[Propagate.CANCELLATION=8]="CANCELLATION",Propagate[Propagate.DEFAULTS=65535]="DEFAULTS"}(exports.Propagate||(exports.Propagate={})),exports.DEFAULT_MAX_SEND_MESSAGE_LENGTH=-1,exports.DEFAULT_MAX_RECEIVE_MESSAGE_LENGTH=4194304},"9BLw":function(module,exports,__webpack_require__){"use strict";var wrappers=exports,Message=__webpack_require__("G8sG");wrappers[".google.protobuf.Any"]={fromObject:function(object){if(object&&object["@type"]){var name=object["@type"].substring(object["@type"].lastIndexOf("/")+1),type=this.lookup(name);if(type){var type_url="."===object["@type"].charAt(0)?object["@type"].substr(1):object["@type"];return-1===type_url.indexOf("/")&&(type_url="/"+type_url),this.create({type_url:type_url,value:type.encode(type.fromObject(object)).finish()})}}return this.fromObject(object)},toObject:function(message,options){var prefix="",name="";if(options&&options.json&&message.type_url&&message.value){name=message.type_url.substring(message.type_url.lastIndexOf("/")+1),prefix=message.type_url.substring(0,message.type_url.lastIndexOf("/")+1);var type=this.lookup(name);type&&(message=type.decode(message.value))}if(!(message instanceof this.ctor)&&message instanceof Message){var object=message.$type.toObject(message,options);return""===prefix&&(prefix="type.googleapis.com/"),name=prefix+("."===message.$type.fullName[0]?message.$type.fullName.substr(1):message.$type.fullName),object["@type"]=name,object}return this.toObject(message,options)}}},"9rQR":function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.registerAll=exports.mapUriDefaultScheme=exports.getDefaultAuthority=exports.createResolver=exports.registerDefaultScheme=exports.registerResolver=void 0;const resolver_dns=__webpack_require__("JUUq"),resolver_uds=__webpack_require__("5etU"),resolver_ip=__webpack_require__("YM9t"),uri_parser_1=__webpack_require__("x8Ej"),registeredResolvers={};let defaultScheme=null;exports.registerResolver=function registerResolver(scheme,resolverClass){registeredResolvers[scheme]=resolverClass},exports.registerDefaultScheme=function registerDefaultScheme(scheme){defaultScheme=scheme},exports.createResolver=function createResolver(target,listener,options){if(void 0!==target.scheme&&target.scheme in registeredResolvers)return new registeredResolvers[target.scheme](target,listener,options);throw new Error(`No resolver could be created for target ${uri_parser_1.uriToString(target)}`)},exports.getDefaultAuthority=function getDefaultAuthority(target){if(void 0!==target.scheme&&target.scheme in registeredResolvers)return registeredResolvers[target.scheme].getDefaultAuthority(target);throw new Error(`Invalid target ${uri_parser_1.uriToString(target)}`)},exports.mapUriDefaultScheme=function mapUriDefaultScheme(target){return void 0!==target.scheme&&target.scheme in registeredResolvers?target:null!==defaultScheme?{scheme:defaultScheme,authority:void 0,path:uri_parser_1.uriToString(target)}:null},exports.registerAll=function registerAll(){resolver_dns.setup(),resolver_uds.setup(),resolver_ip.setup()}},AUsp:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MaxMessageSizeFilterFactory=exports.MaxMessageSizeFilter=void 0;const filter_1=__webpack_require__("nC4N"),constants_1=__webpack_require__("8o9P");class MaxMessageSizeFilter extends filter_1.BaseFilter{constructor(options,callStream){super(),this.options=options,this.callStream=callStream,this.maxSendMessageSize=constants_1.DEFAULT_MAX_SEND_MESSAGE_LENGTH,this.maxReceiveMessageSize=constants_1.DEFAULT_MAX_RECEIVE_MESSAGE_LENGTH,"grpc.max_send_message_length"in options&&(this.maxSendMessageSize=options["grpc.max_send_message_length"]),"grpc.max_receive_message_length"in options&&(this.maxReceiveMessageSize=options["grpc.max_receive_message_length"])}async sendMessage(message){if(-1===this.maxSendMessageSize)return message;{const concreteMessage=await message;return concreteMessage.message.length>this.maxSendMessageSize?(this.callStream.cancelWithStatus(constants_1.Status.RESOURCE_EXHAUSTED,`Sent message larger than max (${concreteMessage.message.length} vs. ${this.maxSendMessageSize})`),Promise.reject("Message too large")):concreteMessage}}async receiveMessage(message){if(-1===this.maxReceiveMessageSize)return message;{const concreteMessage=await message;return concreteMessage.length>this.maxReceiveMessageSize?(this.callStream.cancelWithStatus(constants_1.Status.RESOURCE_EXHAUSTED,`Received message larger than max (${concreteMessage.length} vs. ${this.maxReceiveMessageSize})`),Promise.reject("Message too large")):concreteMessage}}}exports.MaxMessageSizeFilter=MaxMessageSizeFilter;exports.MaxMessageSizeFilterFactory=class{constructor(options){this.options=options}createFilter(callStream){return new MaxMessageSizeFilter(this.options,callStream)}}},AVbK:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.experimental=exports.StatusBuilder=exports.getClientChannel=exports.ServerCredentials=exports.Server=exports.setLogVerbosity=exports.setLogger=exports.load=exports.loadObject=exports.CallCredentials=exports.ChannelCredentials=exports.waitForClientReady=exports.closeClient=exports.Channel=exports.makeGenericClientConstructor=exports.makeClientConstructor=exports.loadPackageDefinition=exports.Client=exports.propagate=exports.connectivityState=exports.status=exports.logVerbosity=exports.Metadata=exports.credentials=void 0;const call_credentials_1=__webpack_require__("y+4D");Object.defineProperty(exports,"CallCredentials",{enumerable:!0,get:function(){return call_credentials_1.CallCredentials}});const channel_1=__webpack_require__("6XSn");Object.defineProperty(exports,"connectivityState",{enumerable:!0,get:function(){return channel_1.ConnectivityState}}),Object.defineProperty(exports,"Channel",{enumerable:!0,get:function(){return channel_1.ChannelImplementation}});const channel_credentials_1=__webpack_require__("mr48");Object.defineProperty(exports,"ChannelCredentials",{enumerable:!0,get:function(){return channel_credentials_1.ChannelCredentials}});const client_1=__webpack_require__("rVu5");Object.defineProperty(exports,"Client",{enumerable:!0,get:function(){return client_1.Client}});const constants_1=__webpack_require__("8o9P");Object.defineProperty(exports,"logVerbosity",{enumerable:!0,get:function(){return constants_1.LogVerbosity}}),Object.defineProperty(exports,"status",{enumerable:!0,get:function(){return constants_1.Status}}),Object.defineProperty(exports,"propagate",{enumerable:!0,get:function(){return constants_1.Propagate}});const logging=__webpack_require__("xQiD"),make_client_1=__webpack_require__("1mAN");Object.defineProperty(exports,"loadPackageDefinition",{enumerable:!0,get:function(){return make_client_1.loadPackageDefinition}}),Object.defineProperty(exports,"makeClientConstructor",{enumerable:!0,get:function(){return make_client_1.makeClientConstructor}}),Object.defineProperty(exports,"makeGenericClientConstructor",{enumerable:!0,get:function(){return make_client_1.makeClientConstructor}});const metadata_1=__webpack_require__("m7sO");Object.defineProperty(exports,"Metadata",{enumerable:!0,get:function(){return metadata_1.Metadata}});const server_1=__webpack_require__("xTBj");Object.defineProperty(exports,"Server",{enumerable:!0,get:function(){return server_1.Server}});const server_credentials_1=__webpack_require__("uKrT");Object.defineProperty(exports,"ServerCredentials",{enumerable:!0,get:function(){return server_credentials_1.ServerCredentials}});const status_builder_1=__webpack_require__("c/ta");Object.defineProperty(exports,"StatusBuilder",{enumerable:!0,get:function(){return status_builder_1.StatusBuilder}}),exports.credentials={combineChannelCredentials:(channelCredentials,...callCredentials)=>callCredentials.reduce((acc,other)=>acc.compose(other),channelCredentials),combineCallCredentials:(first,...additional)=>additional.reduce((acc,other)=>acc.compose(other),first),createInsecure:channel_credentials_1.ChannelCredentials.createInsecure,createSsl:channel_credentials_1.ChannelCredentials.createSsl,createFromMetadataGenerator:call_credentials_1.CallCredentials.createFromMetadataGenerator,createFromGoogleCredential:call_credentials_1.CallCredentials.createFromGoogleCredential,createEmpty:call_credentials_1.CallCredentials.createEmpty},exports.closeClient=client=>client.close(),exports.waitForClientReady=(client,deadline,callback)=>client.waitForReady(deadline,callback),exports.loadObject=(value,options)=>{throw new Error("Not available in this library. Use @grpc/proto-loader and loadPackageDefinition instead")},exports.load=(filename,format,options)=>{throw new Error("Not available in this library. Use @grpc/proto-loader and loadPackageDefinition instead")},exports.setLogger=logger=>{logging.setLogger(logger)},exports.setLogVerbosity=verbosity=>{logging.setLoggerVerbosity(verbosity)},exports.getClientChannel=client=>client_1.Client.prototype.getChannel.call(client);var client_interceptors_1=__webpack_require__("eaSJ");Object.defineProperty(exports,"ListenerBuilder",{enumerable:!0,get:function(){return client_interceptors_1.ListenerBuilder}}),Object.defineProperty(exports,"RequesterBuilder",{enumerable:!0,get:function(){return client_interceptors_1.RequesterBuilder}}),Object.defineProperty(exports,"InterceptingCall",{enumerable:!0,get:function(){return client_interceptors_1.InterceptingCall}}),Object.defineProperty(exports,"InterceptorConfigurationError",{enumerable:!0,get:function(){return client_interceptors_1.InterceptorConfigurationError}});const experimental=__webpack_require__("56Zw");exports.experimental=experimental;const resolver=__webpack_require__("9rQR"),load_balancer=__webpack_require__("JG2R");resolver.registerAll(),load_balancer.registerAll()},AbGV:function(module,exports,__webpack_require__){"use strict";exports.Service=__webpack_require__("gH6v")},B4j6:function(module,exports,__webpack_require__){"use strict";module.exports=Method;var ReflectionObject=__webpack_require__("iuWj");((Method.prototype=Object.create(ReflectionObject.prototype)).constructor=Method).className="Method";var util=__webpack_require__("y9PA");function Method(name,type,requestType,responseType,requestStream,responseStream,options,comment,parsedOptions){if(util.isObject(requestStream)?(options=requestStream,requestStream=responseStream=void 0):util.isObject(responseStream)&&(options=responseStream,responseStream=void 0),void 0!==type&&!util.isString(type))throw TypeError("type must be a string");if(!util.isString(requestType))throw TypeError("requestType must be a string");if(!util.isString(responseType))throw TypeError("responseType must be a string");ReflectionObject.call(this,name,options),this.type=type||"rpc",this.requestType=requestType,this.requestStream=!!requestStream||void 0,this.responseType=responseType,this.responseStream=!!responseStream||void 0,this.resolvedRequestType=null,this.resolvedResponseType=null,this.comment=comment,this.parsedOptions=parsedOptions}Method.fromJSON=function fromJSON(name,json){return new Method(name,json.type,json.requestType,json.responseType,json.requestStream,json.responseStream,json.options,json.comment,json.parsedOptions)},Method.prototype.toJSON=function toJSON(toJSONOptions){var keepComments=!!toJSONOptions&&Boolean(toJSONOptions.keepComments);return util.toObject(["type","rpc"!==this.type&&this.type||void 0,"requestType",this.requestType,"requestStream",this.requestStream,"responseType",this.responseType,"responseStream",this.responseStream,"options",this.options,"comment",keepComments?this.comment:void 0,"parsedOptions",this.parsedOptions])},Method.prototype.resolve=function resolve(){return this.resolved?this:(this.resolvedRequestType=this.parent.lookupType(this.requestType),this.resolvedResponseType=this.parent.lookupType(this.responseType),ReflectionObject.prototype.resolve.call(this))}},BEY9:function(module,exports,__webpack_require__){"use strict";module.exports=function pool(alloc,slice,size){var SIZE=size||8192,MAX=SIZE>>>1,slab=null,offset=SIZE;return function pool_alloc(size){if(size<1||size>MAX)return alloc(size);offset+size>SIZE&&(slab=alloc(SIZE),offset=0);var buf=slice.call(slab,offset,offset+=size);return 7&offset&&(offset=1+(7|offset)),buf}}},BJPX:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getProxiedConnection=exports.mapProxyName=void 0;const logging_1=__webpack_require__("xQiD"),constants_1=__webpack_require__("8o9P"),resolver_1=__webpack_require__("9rQR"),http=__webpack_require__("KEll"),tls=__webpack_require__("ugmf"),logging=__webpack_require__("xQiD"),subchannel_1=__webpack_require__("Ikg5"),uri_parser_1=__webpack_require__("x8Ej"),url_1=__webpack_require__("bzos");function trace(text){logging.trace(constants_1.LogVerbosity.DEBUG,"proxy",text)}exports.mapProxyName=function mapProxyName(target,options){var _a;const noProxyResult={target:target,extraOptions:{}};if(0===(null!==(_a=options["grpc.enable_http_proxy"])&&void 0!==_a?_a:1))return noProxyResult;const proxyInfo=function getProxyInfo(){let proxyUrl,proxyEnv="",envVar="";if(process.env.grpc_proxy)envVar="grpc_proxy",proxyEnv=process.env.grpc_proxy;else if(process.env.https_proxy)envVar="https_proxy",proxyEnv=process.env.https_proxy;else{if(!process.env.http_proxy)return{};envVar="http_proxy",proxyEnv=process.env.http_proxy}try{proxyUrl=new url_1.URL(proxyEnv)}catch(e){return logging_1.log(constants_1.LogVerbosity.ERROR,`cannot parse value of "${envVar}" env var`),{}}if("http:"!==proxyUrl.protocol)return logging_1.log(constants_1.LogVerbosity.ERROR,`"${proxyUrl.protocol}" scheme not supported in proxy URI`),{};let userCred=null;proxyUrl.username&&(proxyUrl.password?(logging_1.log(constants_1.LogVerbosity.INFO,"userinfo found in proxy URI"),userCred=`${proxyUrl.username}:${proxyUrl.password}`):userCred=proxyUrl.username);const hostname=proxyUrl.hostname;let port=proxyUrl.port;""===port&&(port="80");const result={address:`${hostname}:${port}`};return userCred&&(result.creds=userCred),trace("Proxy server "+result.address+" set by environment variable "+envVar),result}();if(!proxyInfo.address)return noProxyResult;const hostPort=uri_parser_1.splitHostPort(target.path);if(!hostPort)return noProxyResult;const serverHost=hostPort.host;for(const host of function getNoProxyHostList(){let noProxyStr=process.env.no_grpc_proxy,envVar="no_grpc_proxy";return noProxyStr||(noProxyStr=process.env.no_proxy,envVar="no_proxy"),noProxyStr?(trace("No proxy server list set by environment variable "+envVar),noProxyStr.split(",")):[]}())if(host===serverHost)return trace("Not using proxy for target in no_proxy list: "+uri_parser_1.uriToString(target)),noProxyResult;const extraOptions={"grpc.http_connect_target":uri_parser_1.uriToString(target)};return proxyInfo.creds&&(extraOptions["grpc.http_connect_creds"]=proxyInfo.creds),{target:{scheme:"dns",path:proxyInfo.address},extraOptions:extraOptions}},exports.getProxiedConnection=function getProxiedConnection(address,channelOptions,connectionOptions){if(!("grpc.http_connect_target"in channelOptions))return Promise.resolve({});const realTarget=channelOptions["grpc.http_connect_target"],parsedTarget=uri_parser_1.parseUri(realTarget);if(null===parsedTarget)return Promise.resolve({});const options={method:"CONNECT",path:parsedTarget.path};subchannel_1.isTcpSubchannelAddress(address)?(options.host=address.host,options.port=address.port):options.socketPath=address.path,"grpc.http_connect_creds"in channelOptions&&(options.headers={"Proxy-Authorization":"Basic "+Buffer.from(channelOptions["grpc.http_connect_creds"]).toString("base64")});const proxyAddressString=subchannel_1.subchannelAddressToString(address);return trace("Using proxy "+proxyAddressString+" to connect to "+options.path),new Promise((resolve,reject)=>{const request=http.request(options);request.once("connect",(res,socket,head)=>{var _a;if(request.removeAllListeners(),socket.removeAllListeners(),200===res.statusCode)if(trace("Successfully connected to "+options.path+" through proxy "+proxyAddressString),"secureContext"in connectionOptions){const targetPath=resolver_1.getDefaultAuthority(parsedTarget),hostPort=uri_parser_1.splitHostPort(targetPath),remoteHost=null!==(_a=null==hostPort?void 0:hostPort.host)&&void 0!==_a?_a:targetPath,cts=tls.connect(Object.assign({host:remoteHost,servername:remoteHost,socket:socket},connectionOptions),()=>{trace("Successfully established a TLS connection to "+options.path+" through proxy "+proxyAddressString),resolve({socket:cts,realTarget:parsedTarget})});cts.on("error",error=>{trace("Failed to establish a TLS connection to "+options.path+" through proxy "+proxyAddressString+" with error "+error.message),reject()})}else resolve({socket:socket,realTarget:parsedTarget});else logging_1.log(constants_1.LogVerbosity.ERROR,"Failed to connect to "+options.path+" through proxy "+proxyAddressString+" with status "+res.statusCode),reject()}),request.once("error",err=>{request.removeAllListeners(),logging_1.log(constants_1.LogVerbosity.ERROR,"Failed to connect to proxy "+proxyAddressString+" with error "+err.message),reject()}),request.end()})}},BWhg:function(module,exports,__webpack_require__){"use strict";var converter=exports,Enum=__webpack_require__("vREW"),util=__webpack_require__("y9PA");function genValuePartial_fromObject(gen,field,fieldIndex,prop){if(field.resolvedType)if(field.resolvedType instanceof Enum){gen("switch(d%s){",prop);for(var values=field.resolvedType.values,keys=Object.keys(values),i=0;i<keys.length;++i)field.repeated&&values[keys[i]]===field.typeDefault&&gen("default:"),gen("case%j:",keys[i])("case %i:",values[keys[i]])("m%s=%j",prop,values[keys[i]])("break");gen("}")}else gen('if(typeof d%s!=="object")',prop)("throw TypeError(%j)",field.fullName+": object expected")("m%s=types[%i].fromObject(d%s)",prop,fieldIndex,prop);else{var isUnsigned=!1;switch(field.type){case"double":case"float":gen("m%s=Number(d%s)",prop,prop);break;case"uint32":case"fixed32":gen("m%s=d%s>>>0",prop,prop);break;case"int32":case"sint32":case"sfixed32":gen("m%s=d%s|0",prop,prop);break;case"uint64":isUnsigned=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":gen("if(util.Long)")("(m%s=util.Long.fromValue(d%s)).unsigned=%j",prop,prop,isUnsigned)('else if(typeof d%s==="string")',prop)("m%s=parseInt(d%s,10)",prop,prop)('else if(typeof d%s==="number")',prop)("m%s=d%s",prop,prop)('else if(typeof d%s==="object")',prop)("m%s=new util.LongBits(d%s.low>>>0,d%s.high>>>0).toNumber(%s)",prop,prop,prop,isUnsigned?"true":"");break;case"bytes":gen('if(typeof d%s==="string")',prop)("util.base64.decode(d%s,m%s=util.newBuffer(util.base64.length(d%s)),0)",prop,prop,prop)("else if(d%s.length)",prop)("m%s=d%s",prop,prop);break;case"string":gen("m%s=String(d%s)",prop,prop);break;case"bool":gen("m%s=Boolean(d%s)",prop,prop)}}return gen}function genValuePartial_toObject(gen,field,fieldIndex,prop){if(field.resolvedType)field.resolvedType instanceof Enum?gen("d%s=o.enums===String?types[%i].values[m%s]:m%s",prop,fieldIndex,prop,prop):gen("d%s=types[%i].toObject(m%s,o)",prop,fieldIndex,prop);else{var isUnsigned=!1;switch(field.type){case"double":case"float":gen("d%s=o.json&&!isFinite(m%s)?String(m%s):m%s",prop,prop,prop,prop);break;case"uint64":isUnsigned=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":gen('if(typeof m%s==="number")',prop)("d%s=o.longs===String?String(m%s):m%s",prop,prop,prop)("else")("d%s=o.longs===String?util.Long.prototype.toString.call(m%s):o.longs===Number?new util.LongBits(m%s.low>>>0,m%s.high>>>0).toNumber(%s):m%s",prop,prop,prop,prop,isUnsigned?"true":"",prop);break;case"bytes":gen("d%s=o.bytes===String?util.base64.encode(m%s,0,m%s.length):o.bytes===Array?Array.prototype.slice.call(m%s):m%s",prop,prop,prop,prop,prop);break;default:gen("d%s=m%s",prop,prop)}}return gen}converter.fromObject=function fromObject(mtype){var fields=mtype.fieldsArray,gen=util.codegen(["d"],mtype.name+"$fromObject")("if(d instanceof this.ctor)")("return d");if(!fields.length)return gen("return new this.ctor");gen("var m=new this.ctor");for(var i=0;i<fields.length;++i){var field=fields[i].resolve(),prop=util.safeProp(field.name);field.map?(gen("if(d%s){",prop)('if(typeof d%s!=="object")',prop)("throw TypeError(%j)",field.fullName+": object expected")("m%s={}",prop)("for(var ks=Object.keys(d%s),i=0;i<ks.length;++i){",prop),genValuePartial_fromObject(gen,field,i,prop+"[ks[i]]")("}")("}")):field.repeated?(gen("if(d%s){",prop)("if(!Array.isArray(d%s))",prop)("throw TypeError(%j)",field.fullName+": array expected")("m%s=[]",prop)("for(var i=0;i<d%s.length;++i){",prop),genValuePartial_fromObject(gen,field,i,prop+"[i]")("}")("}")):(field.resolvedType instanceof Enum||gen("if(d%s!=null){",prop),genValuePartial_fromObject(gen,field,i,prop),field.resolvedType instanceof Enum||gen("}"))}return gen("return m")},converter.toObject=function toObject(mtype){var fields=mtype.fieldsArray.slice().sort(util.compareFieldsById);if(!fields.length)return util.codegen()("return {}");for(var gen=util.codegen(["m","o"],mtype.name+"$toObject")("if(!o)")("o={}")("var d={}"),repeatedFields=[],mapFields=[],normalFields=[],i=0;i<fields.length;++i)fields[i].partOf||(fields[i].resolve().repeated?repeatedFields:fields[i].map?mapFields:normalFields).push(fields[i]);if(repeatedFields.length){for(gen("if(o.arrays||o.defaults){"),i=0;i<repeatedFields.length;++i)gen("d%s=[]",util.safeProp(repeatedFields[i].name));gen("}")}if(mapFields.length){for(gen("if(o.objects||o.defaults){"),i=0;i<mapFields.length;++i)gen("d%s={}",util.safeProp(mapFields[i].name));gen("}")}if(normalFields.length){for(gen("if(o.defaults){"),i=0;i<normalFields.length;++i){var field=normalFields[i],prop=util.safeProp(field.name);if(field.resolvedType instanceof Enum)gen("d%s=o.enums===String?%j:%j",prop,field.resolvedType.valuesById[field.typeDefault],field.typeDefault);else if(field.long)gen("if(util.Long){")("var n=new util.Long(%i,%i,%j)",field.typeDefault.low,field.typeDefault.high,field.typeDefault.unsigned)("d%s=o.longs===String?n.toString():o.longs===Number?n.toNumber():n",prop)("}else")("d%s=o.longs===String?%j:%i",prop,field.typeDefault.toString(),field.typeDefault.toNumber());else if(field.bytes){var arrayDefault="["+Array.prototype.slice.call(field.typeDefault).join(",")+"]";gen("if(o.bytes===String)d%s=%j",prop,String.fromCharCode.apply(String,field.typeDefault))("else{")("d%s=%s",prop,arrayDefault)("if(o.bytes!==Array)d%s=util.newBuffer(d%s)",prop,prop)("}")}else gen("d%s=%j",prop,field.typeDefault)}gen("}")}var hasKs2=!1;for(i=0;i<fields.length;++i){field=fields[i];var index=mtype._fieldsArray.indexOf(field);prop=util.safeProp(field.name);field.map?(hasKs2||(hasKs2=!0,gen("var ks2")),gen("if(m%s&&(ks2=Object.keys(m%s)).length){",prop,prop)("d%s={}",prop)("for(var j=0;j<ks2.length;++j){"),genValuePartial_toObject(gen,field,index,prop+"[ks2[j]]")("}")):field.repeated?(gen("if(m%s&&m%s.length){",prop,prop)("d%s=[]",prop)("for(var j=0;j<m%s.length;++j){",prop),genValuePartial_toObject(gen,field,index,prop+"[j]")("}")):(gen("if(m%s!=null&&m.hasOwnProperty(%j)){",prop,field.name),genValuePartial_toObject(gen,field,index,prop),field.partOf&&gen("if(o.oneofs)")("d%s=%j",util.safeProp(field.partOf.name),field.name)),gen("}")}return gen("return d")}},"Bko/":function(module,exports,__webpack_require__){"use strict";module.exports={}},"Bx+5":function(module,exports,__webpack_require__){"use strict";var protobuf=module.exports=__webpack_require__("bDA7");protobuf.build="light",protobuf.load=function load(filename,root,callback){return"function"==typeof root?(callback=root,root=new protobuf.Root):root||(root=new protobuf.Root),root.load(filename,callback)},protobuf.loadSync=function loadSync(filename,root){return root||(root=new protobuf.Root),root.loadSync(filename)},protobuf.encoder=__webpack_require__("dqsW"),protobuf.decoder=__webpack_require__("3Xxg"),protobuf.verifier=__webpack_require__("KlcT"),protobuf.converter=__webpack_require__("BWhg"),protobuf.ReflectionObject=__webpack_require__("iuWj"),protobuf.Namespace=__webpack_require__("fgco"),protobuf.Root=__webpack_require__("7m6H"),protobuf.Enum=__webpack_require__("vREW"),protobuf.Type=__webpack_require__("bs9O"),protobuf.Field=__webpack_require__("pqPr"),protobuf.OneOf=__webpack_require__("d+r3"),protobuf.MapField=__webpack_require__("guhe"),protobuf.Service=__webpack_require__("dHTU"),protobuf.Method=__webpack_require__("B4j6"),protobuf.Message=__webpack_require__("G8sG"),protobuf.wrappers=__webpack_require__("9BLw"),protobuf.types=__webpack_require__("hSTS"),protobuf.util=__webpack_require__("y9PA"),protobuf.ReflectionObject._configure(protobuf.Root),protobuf.Namespace._configure(protobuf.Type,protobuf.Service,protobuf.Enum),protobuf.Root._configure(protobuf.Type),protobuf.Field._configure(protobuf.Type)},CelR:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getDefaultRootsData=exports.CIPHER_SUITES=void 0;const fs=__webpack_require__("mw/K");exports.CIPHER_SUITES=process.env.GRPC_SSL_CIPHER_SUITES;const DEFAULT_ROOTS_FILE_PATH=process.env.GRPC_DEFAULT_SSL_ROOTS_FILE_PATH;let defaultRootsData=null;exports.getDefaultRootsData=function getDefaultRootsData(){return DEFAULT_ROOTS_FILE_PATH?(null===defaultRootsData&&(defaultRootsData=fs.readFileSync(DEFAULT_ROOTS_FILE_PATH)),defaultRootsData):null}},DIMq:function(module,exports,__webpack_require__){"use strict";module.exports=Writer;var BufferWriter,util=__webpack_require__("6Tgl"),LongBits=util.LongBits,base64=util.base64,utf8=util.utf8;function Op(fn,len,val){this.fn=fn,this.len=len,this.next=void 0,this.val=val}function noop(){}function State(writer){this.head=writer.head,this.tail=writer.tail,this.len=writer.len,this.next=writer.states}function Writer(){this.len=0,this.head=new Op(noop,0,0),this.tail=this.head,this.states=null}var create=function create(){return util.Buffer?function create_buffer_setup(){return(Writer.create=function create_buffer(){return new BufferWriter})()}:function create_array(){return new Writer}};function writeByte(val,buf,pos){buf[pos]=255&val}function VarintOp(len,val){this.len=len,this.next=void 0,this.val=val}function writeVarint64(val,buf,pos){for(;val.hi;)buf[pos++]=127&val.lo|128,val.lo=(val.lo>>>7|val.hi<<25)>>>0,val.hi>>>=7;for(;val.lo>127;)buf[pos++]=127&val.lo|128,val.lo=val.lo>>>7;buf[pos++]=val.lo}function writeFixed32(val,buf,pos){buf[pos]=255&val,buf[pos+1]=val>>>8&255,buf[pos+2]=val>>>16&255,buf[pos+3]=val>>>24}Writer.create=create(),Writer.alloc=function alloc(size){return new util.Array(size)},util.Array!==Array&&(Writer.alloc=util.pool(Writer.alloc,util.Array.prototype.subarray)),Writer.prototype._push=function push(fn,len,val){return this.tail=this.tail.next=new Op(fn,len,val),this.len+=len,this},VarintOp.prototype=Object.create(Op.prototype),VarintOp.prototype.fn=function writeVarint32(val,buf,pos){for(;val>127;)buf[pos++]=127&val|128,val>>>=7;buf[pos]=val},Writer.prototype.uint32=function write_uint32(value){return this.len+=(this.tail=this.tail.next=new VarintOp((value>>>=0)<128?1:value<16384?2:value<2097152?3:value<268435456?4:5,value)).len,this},Writer.prototype.int32=function write_int32(value){return value<0?this._push(writeVarint64,10,LongBits.fromNumber(value)):this.uint32(value)},Writer.prototype.sint32=function write_sint32(value){return this.uint32((value<<1^value>>31)>>>0)},Writer.prototype.uint64=function write_uint64(value){var bits=LongBits.from(value);return this._push(writeVarint64,bits.length(),bits)},Writer.prototype.int64=Writer.prototype.uint64,Writer.prototype.sint64=function write_sint64(value){var bits=LongBits.from(value).zzEncode();return this._push(writeVarint64,bits.length(),bits)},Writer.prototype.bool=function write_bool(value){return this._push(writeByte,1,value?1:0)},Writer.prototype.fixed32=function write_fixed32(value){return this._push(writeFixed32,4,value>>>0)},Writer.prototype.sfixed32=Writer.prototype.fixed32,Writer.prototype.fixed64=function write_fixed64(value){var bits=LongBits.from(value);return this._push(writeFixed32,4,bits.lo)._push(writeFixed32,4,bits.hi)},Writer.prototype.sfixed64=Writer.prototype.fixed64,Writer.prototype.float=function write_float(value){return this._push(util.float.writeFloatLE,4,value)},Writer.prototype.double=function write_double(value){return this._push(util.float.writeDoubleLE,8,value)};var writeBytes=util.Array.prototype.set?function writeBytes_set(val,buf,pos){buf.set(val,pos)}:function writeBytes_for(val,buf,pos){for(var i=0;i<val.length;++i)buf[pos+i]=val[i]};Writer.prototype.bytes=function write_bytes(value){var len=value.length>>>0;if(!len)return this._push(writeByte,1,0);if(util.isString(value)){var buf=Writer.alloc(len=base64.length(value));base64.decode(value,buf,0),value=buf}return this.uint32(len)._push(writeBytes,len,value)},Writer.prototype.string=function write_string(value){var len=utf8.length(value);return len?this.uint32(len)._push(utf8.write,len,value):this._push(writeByte,1,0)},Writer.prototype.fork=function fork(){return this.states=new State(this),this.head=this.tail=new Op(noop,0,0),this.len=0,this},Writer.prototype.reset=function reset(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Op(noop,0,0),this.len=0),this},Writer.prototype.ldelim=function ldelim(){var head=this.head,tail=this.tail,len=this.len;return this.reset().uint32(len),len&&(this.tail.next=head.next,this.tail=tail,this.len+=len),this},Writer.prototype.finish=function finish(){for(var head=this.head.next,buf=this.constructor.alloc(this.len),pos=0;head;)head.fn(head.val,buf,pos),pos+=head.len,head=head.next;return buf},Writer._configure=function(BufferWriter_){BufferWriter=BufferWriter_,Writer.create=create(),BufferWriter._configure()}},Dseh:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.setup=exports.PickFirstLoadBalancer=exports.PickFirstLoadBalancingConfig=void 0;const load_balancer_1=__webpack_require__("JG2R"),channel_1=__webpack_require__("6XSn"),picker_1=__webpack_require__("mVN3"),subchannel_1=__webpack_require__("Ikg5"),logging=__webpack_require__("xQiD"),constants_1=__webpack_require__("8o9P");function trace(text){logging.trace(constants_1.LogVerbosity.DEBUG,"pick_first",text)}class PickFirstLoadBalancingConfig{getLoadBalancerName(){return"pick_first"}constructor(){}toJsonObject(){return{pick_first:{}}}static createFromJson(obj){return new PickFirstLoadBalancingConfig}}exports.PickFirstLoadBalancingConfig=PickFirstLoadBalancingConfig;class PickFirstPicker{constructor(subchannel){this.subchannel=subchannel}pick(pickArgs){return{pickResultType:picker_1.PickResultType.COMPLETE,subchannel:this.subchannel,status:null,extraFilterFactory:null,onCallStarted:null}}}class PickFirstLoadBalancer{constructor(channelControlHelper){this.channelControlHelper=channelControlHelper,this.latestAddressList=[],this.subchannels=[],this.currentState=channel_1.ConnectivityState.IDLE,this.currentSubchannelIndex=0,this.currentPick=null,this.triedAllSubchannels=!1,this.subchannelStateCounts={[channel_1.ConnectivityState.CONNECTING]:0,[channel_1.ConnectivityState.IDLE]:0,[channel_1.ConnectivityState.READY]:0,[channel_1.ConnectivityState.SHUTDOWN]:0,[channel_1.ConnectivityState.TRANSIENT_FAILURE]:0},this.subchannelStateListener=(subchannel,previousState,newState)=>{if(this.subchannelStateCounts[previousState]-=1,this.subchannelStateCounts[newState]+=1,subchannel===this.subchannels[this.currentSubchannelIndex]&&newState===channel_1.ConnectivityState.TRANSIENT_FAILURE&&this.startNextSubchannelConnecting(),newState!==channel_1.ConnectivityState.READY){if(this.triedAllSubchannels&&this.subchannelStateCounts[channel_1.ConnectivityState.IDLE]===this.subchannels.length)return this.resetSubchannelList(),void this.updateState(channel_1.ConnectivityState.IDLE,new picker_1.QueuePicker(this));if(null===this.currentPick)if(this.triedAllSubchannels){let newLBState;newLBState=this.subchannelStateCounts[channel_1.ConnectivityState.CONNECTING]>0?channel_1.ConnectivityState.CONNECTING:this.subchannelStateCounts[channel_1.ConnectivityState.TRANSIENT_FAILURE]>0?channel_1.ConnectivityState.TRANSIENT_FAILURE:channel_1.ConnectivityState.IDLE,newLBState!==this.currentState&&(newLBState===channel_1.ConnectivityState.TRANSIENT_FAILURE?this.updateState(newLBState,new picker_1.UnavailablePicker):this.updateState(newLBState,new picker_1.QueuePicker(this)))}else this.updateState(channel_1.ConnectivityState.CONNECTING,new picker_1.QueuePicker(this))}else this.pickSubchannel(subchannel)},this.pickedSubchannelStateListener=(subchannel,previousState,newState)=>{if(newState!==channel_1.ConnectivityState.READY)if(this.currentPick=null,subchannel.unref(),subchannel.removeConnectivityStateListener(this.pickedSubchannelStateListener),this.subchannels.length>0)if(this.triedAllSubchannels){let newLBState;newLBState=this.subchannelStateCounts[channel_1.ConnectivityState.CONNECTING]>0?channel_1.ConnectivityState.CONNECTING:this.subchannelStateCounts[channel_1.ConnectivityState.TRANSIENT_FAILURE]>0?channel_1.ConnectivityState.TRANSIENT_FAILURE:channel_1.ConnectivityState.IDLE,newLBState===channel_1.ConnectivityState.TRANSIENT_FAILURE?this.updateState(newLBState,new picker_1.UnavailablePicker):this.updateState(newLBState,new picker_1.QueuePicker(this))}else this.updateState(channel_1.ConnectivityState.CONNECTING,new picker_1.QueuePicker(this));else this.updateState(channel_1.ConnectivityState.IDLE,new picker_1.QueuePicker(this))},this.connectionDelayTimeout=setTimeout(()=>{},0),clearTimeout(this.connectionDelayTimeout)}startNextSubchannelConnecting(){if(!this.triedAllSubchannels){for(const[index,subchannel]of this.subchannels.entries())if(index>this.currentSubchannelIndex){const subchannelState=subchannel.getConnectivityState();if(subchannelState===channel_1.ConnectivityState.IDLE||subchannelState===channel_1.ConnectivityState.CONNECTING)return void this.startConnecting(index)}this.triedAllSubchannels=!0}}startConnecting(subchannelIndex){clearTimeout(this.connectionDelayTimeout),this.currentSubchannelIndex=subchannelIndex,this.subchannels[subchannelIndex].getConnectivityState()===channel_1.ConnectivityState.IDLE&&(trace("Start connecting to subchannel with address "+this.subchannels[subchannelIndex].getAddress()),process.nextTick(()=>{this.subchannels[subchannelIndex].startConnecting()})),this.connectionDelayTimeout=setTimeout(()=>{this.startNextSubchannelConnecting()},250)}pickSubchannel(subchannel){trace("Pick subchannel with address "+subchannel.getAddress()),null!==this.currentPick&&(this.currentPick.unref(),this.currentPick.removeConnectivityStateListener(this.pickedSubchannelStateListener)),this.currentPick=subchannel,this.updateState(channel_1.ConnectivityState.READY,new PickFirstPicker(subchannel)),subchannel.addConnectivityStateListener(this.pickedSubchannelStateListener),subchannel.ref(),this.resetSubchannelList(),clearTimeout(this.connectionDelayTimeout)}updateState(newState,picker){trace(channel_1.ConnectivityState[this.currentState]+" -> "+channel_1.ConnectivityState[newState]),this.currentState=newState,this.channelControlHelper.updateState(newState,picker)}resetSubchannelList(){for(const subchannel of this.subchannels)subchannel.removeConnectivityStateListener(this.subchannelStateListener),subchannel.unref();this.currentSubchannelIndex=0,this.subchannelStateCounts={[channel_1.ConnectivityState.CONNECTING]:0,[channel_1.ConnectivityState.IDLE]:0,[channel_1.ConnectivityState.READY]:0,[channel_1.ConnectivityState.SHUTDOWN]:0,[channel_1.ConnectivityState.TRANSIENT_FAILURE]:0},this.subchannels=[],this.triedAllSubchannels=!1}connectToAddressList(){this.resetSubchannelList(),trace("Connect to address list "+this.latestAddressList.map(address=>subchannel_1.subchannelAddressToString(address))),this.subchannels=this.latestAddressList.map(address=>this.channelControlHelper.createSubchannel(address,{}));for(const subchannel of this.subchannels)subchannel.ref();for(const subchannel of this.subchannels)if(subchannel.addConnectivityStateListener(this.subchannelStateListener),this.subchannelStateCounts[subchannel.getConnectivityState()]+=1,subchannel.getConnectivityState()===channel_1.ConnectivityState.READY)return this.pickSubchannel(subchannel),void this.resetSubchannelList();for(const[index,subchannel]of this.subchannels.entries()){const subchannelState=subchannel.getConnectivityState();if(subchannelState===channel_1.ConnectivityState.IDLE||subchannelState===channel_1.ConnectivityState.CONNECTING)return this.startConnecting(index),void(null===this.currentPick&&this.updateState(channel_1.ConnectivityState.CONNECTING,new picker_1.QueuePicker(this)))}null===this.currentPick&&this.updateState(channel_1.ConnectivityState.TRANSIENT_FAILURE,new picker_1.UnavailablePicker)}updateAddressList(addressList,lbConfig){0!==this.subchannels.length&&this.latestAddressList.every((value,index)=>addressList[index]===value)||(this.latestAddressList=addressList,this.connectToAddressList())}exitIdle(){for(const subchannel of this.subchannels)subchannel.startConnecting();this.currentState===channel_1.ConnectivityState.IDLE&&this.latestAddressList.length>0&&this.connectToAddressList(),(this.currentState===channel_1.ConnectivityState.IDLE||this.triedAllSubchannels)&&this.channelControlHelper.requestReresolution()}resetBackoff(){}destroy(){this.resetSubchannelList(),null!==this.currentPick&&(this.currentPick.unref(),this.currentPick.removeConnectivityStateListener(this.pickedSubchannelStateListener))}getTypeName(){return"pick_first"}}exports.PickFirstLoadBalancer=PickFirstLoadBalancer,exports.setup=function setup(){load_balancer_1.registerLoadBalancerType("pick_first",PickFirstLoadBalancer,PickFirstLoadBalancingConfig)}},Em0h:function(module){module.exports=JSON.parse('{"nested":{"google":{"nested":{"protobuf":{"nested":{"Type":{"fields":{"name":{"type":"string","id":1},"fields":{"rule":"repeated","type":"Field","id":2},"oneofs":{"rule":"repeated","type":"string","id":3},"options":{"rule":"repeated","type":"Option","id":4},"sourceContext":{"type":"SourceContext","id":5},"syntax":{"type":"Syntax","id":6}}},"Field":{"fields":{"kind":{"type":"Kind","id":1},"cardinality":{"type":"Cardinality","id":2},"number":{"type":"int32","id":3},"name":{"type":"string","id":4},"typeUrl":{"type":"string","id":6},"oneofIndex":{"type":"int32","id":7},"packed":{"type":"bool","id":8},"options":{"rule":"repeated","type":"Option","id":9},"jsonName":{"type":"string","id":10},"defaultValue":{"type":"string","id":11}},"nested":{"Kind":{"values":{"TYPE_UNKNOWN":0,"TYPE_DOUBLE":1,"TYPE_FLOAT":2,"TYPE_INT64":3,"TYPE_UINT64":4,"TYPE_INT32":5,"TYPE_FIXED64":6,"TYPE_FIXED32":7,"TYPE_BOOL":8,"TYPE_STRING":9,"TYPE_GROUP":10,"TYPE_MESSAGE":11,"TYPE_BYTES":12,"TYPE_UINT32":13,"TYPE_ENUM":14,"TYPE_SFIXED32":15,"TYPE_SFIXED64":16,"TYPE_SINT32":17,"TYPE_SINT64":18}},"Cardinality":{"values":{"CARDINALITY_UNKNOWN":0,"CARDINALITY_OPTIONAL":1,"CARDINALITY_REQUIRED":2,"CARDINALITY_REPEATED":3}}}},"Enum":{"fields":{"name":{"type":"string","id":1},"enumvalue":{"rule":"repeated","type":"EnumValue","id":2},"options":{"rule":"repeated","type":"Option","id":3},"sourceContext":{"type":"SourceContext","id":4},"syntax":{"type":"Syntax","id":5}}},"EnumValue":{"fields":{"name":{"type":"string","id":1},"number":{"type":"int32","id":2},"options":{"rule":"repeated","type":"Option","id":3}}},"Option":{"fields":{"name":{"type":"string","id":1},"value":{"type":"Any","id":2}}},"Syntax":{"values":{"SYNTAX_PROTO2":0,"SYNTAX_PROTO3":1}},"Any":{"fields":{"type_url":{"type":"string","id":1},"value":{"type":"bytes","id":2}}},"SourceContext":{"fields":{"fileName":{"type":"string","id":1}}}}}}}}}')},G8sG:function(module,exports,__webpack_require__){"use strict";module.exports=Message;var util=__webpack_require__("6Tgl");function Message(properties){if(properties)for(var keys=Object.keys(properties),i=0;i<keys.length;++i)this[keys[i]]=properties[keys[i]]}Message.create=function create(properties){return this.$type.create(properties)},Message.encode=function encode(message,writer){return this.$type.encode(message,writer)},Message.encodeDelimited=function encodeDelimited(message,writer){return this.$type.encodeDelimited(message,writer)},Message.decode=function decode(reader){return this.$type.decode(reader)},Message.decodeDelimited=function decodeDelimited(reader){return this.$type.decodeDelimited(reader)},Message.verify=function verify(message){return this.$type.verify(message)},Message.fromObject=function fromObject(object){return this.$type.fromObject(object)},Message.toObject=function toObject(message,options){return this.$type.toObject(message,options)},Message.prototype.toJSON=function toJSON(){return this.$type.toObject(this,util.toJSONOptions)}},IRA2:function(module,exports,__webpack_require__){"use strict";module.exports=Reader;var BufferReader,util=__webpack_require__("6Tgl"),LongBits=util.LongBits,utf8=util.utf8;function indexOutOfRange(reader,writeLength){return RangeError("index out of range: "+reader.pos+" + "+(writeLength||1)+" > "+reader.len)}function Reader(buffer){this.buf=buffer,this.pos=0,this.len=buffer.length}var create_array="undefined"!=typeof Uint8Array?function create_typed_array(buffer){if(buffer instanceof Uint8Array||Array.isArray(buffer))return new Reader(buffer);throw Error("illegal buffer")}:function create_array(buffer){if(Array.isArray(buffer))return new Reader(buffer);throw Error("illegal buffer")},create=function create(){return util.Buffer?function create_buffer_setup(buffer){return(Reader.create=function create_buffer(buffer){return util.Buffer.isBuffer(buffer)?new BufferReader(buffer):create_array(buffer)})(buffer)}:create_array};function readLongVarint(){var bits=new LongBits(0,0),i=0;if(!(this.len-this.pos>4)){for(;i<3;++i){if(this.pos>=this.len)throw indexOutOfRange(this);if(bits.lo=(bits.lo|(127&this.buf[this.pos])<<7*i)>>>0,this.buf[this.pos++]<128)return bits}return bits.lo=(bits.lo|(127&this.buf[this.pos++])<<7*i)>>>0,bits}for(;i<4;++i)if(bits.lo=(bits.lo|(127&this.buf[this.pos])<<7*i)>>>0,this.buf[this.pos++]<128)return bits;if(bits.lo=(bits.lo|(127&this.buf[this.pos])<<28)>>>0,bits.hi=(bits.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return bits;if(i=0,this.len-this.pos>4){for(;i<5;++i)if(bits.hi=(bits.hi|(127&this.buf[this.pos])<<7*i+3)>>>0,this.buf[this.pos++]<128)return bits}else for(;i<5;++i){if(this.pos>=this.len)throw indexOutOfRange(this);if(bits.hi=(bits.hi|(127&this.buf[this.pos])<<7*i+3)>>>0,this.buf[this.pos++]<128)return bits}throw Error("invalid varint encoding")}function readFixed32_end(buf,end){return(buf[end-4]|buf[end-3]<<8|buf[end-2]<<16|buf[end-1]<<24)>>>0}function readFixed64(){if(this.pos+8>this.len)throw indexOutOfRange(this,8);return new LongBits(readFixed32_end(this.buf,this.pos+=4),readFixed32_end(this.buf,this.pos+=4))}Reader.create=create(),Reader.prototype._slice=util.Array.prototype.subarray||util.Array.prototype.slice,Reader.prototype.uint32=function read_uint32_setup(){var value=4294967295;return function read_uint32(){if(value=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return value;if(value=(value|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return value;if(value=(value|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return value;if(value=(value|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return value;if(value=(value|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return value;if((this.pos+=5)>this.len)throw this.pos=this.len,indexOutOfRange(this,10);return value}}(),Reader.prototype.int32=function read_int32(){return 0|this.uint32()},Reader.prototype.sint32=function read_sint32(){var value=this.uint32();return value>>>1^-(1&value)|0},Reader.prototype.bool=function read_bool(){return 0!==this.uint32()},Reader.prototype.fixed32=function read_fixed32(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);return readFixed32_end(this.buf,this.pos+=4)},Reader.prototype.sfixed32=function read_sfixed32(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);return 0|readFixed32_end(this.buf,this.pos+=4)},Reader.prototype.float=function read_float(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);var value=util.float.readFloatLE(this.buf,this.pos);return this.pos+=4,value},Reader.prototype.double=function read_double(){if(this.pos+8>this.len)throw indexOutOfRange(this,4);var value=util.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,value},Reader.prototype.bytes=function read_bytes(){var length=this.uint32(),start=this.pos,end=this.pos+length;if(end>this.len)throw indexOutOfRange(this,length);return this.pos+=length,Array.isArray(this.buf)?this.buf.slice(start,end):start===end?new this.buf.constructor(0):this._slice.call(this.buf,start,end)},Reader.prototype.string=function read_string(){var bytes=this.bytes();return utf8.read(bytes,0,bytes.length)},Reader.prototype.skip=function skip(length){if("number"==typeof length){if(this.pos+length>this.len)throw indexOutOfRange(this,length);this.pos+=length}else do{if(this.pos>=this.len)throw indexOutOfRange(this)}while(128&this.buf[this.pos++]);return this},Reader.prototype.skipType=function(wireType){switch(wireType){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(wireType=7&this.uint32());)this.skipType(wireType);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+wireType+" at offset "+this.pos)}return this},Reader._configure=function(BufferReader_){BufferReader=BufferReader_,Reader.create=create(),BufferReader._configure();var fn=util.Long?"toLong":"toNumber";util.merge(Reader.prototype,{int64:function read_int64(){return readLongVarint.call(this)[fn](!1)},uint64:function read_uint64(){return readLongVarint.call(this)[fn](!0)},sint64:function read_sint64(){return readLongVarint.call(this).zzDecode()[fn](!1)},fixed64:function read_fixed64(){return readFixed64.call(this)[fn](!0)},sfixed64:function read_sfixed64(){return readFixed64.call(this)[fn](!1)}})}},Ikg5:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Subchannel=exports.subchannelAddressToString=exports.subchannelAddressEqual=exports.isTcpSubchannelAddress=void 0;const http2=__webpack_require__("MG4E"),tls_1=__webpack_require__("ugmf"),channel_1=__webpack_require__("6XSn"),backoff_timeout_1=__webpack_require__("hc0Y"),resolver_1=__webpack_require__("9rQR"),logging=__webpack_require__("xQiD"),constants_1=__webpack_require__("8o9P"),http_proxy_1=__webpack_require__("BJPX"),net=__webpack_require__("Qs2e"),uri_parser_1=__webpack_require__("x8Ej"),clientVersion=__webpack_require__("eM9J").version;function trace(text){logging.trace(constants_1.LogVerbosity.DEBUG,"subchannel",text)}function refTrace(text){logging.trace(constants_1.LogVerbosity.DEBUG,"subchannel_refcount",text)}const{HTTP2_HEADER_AUTHORITY:HTTP2_HEADER_AUTHORITY,HTTP2_HEADER_CONTENT_TYPE:HTTP2_HEADER_CONTENT_TYPE,HTTP2_HEADER_METHOD:HTTP2_HEADER_METHOD,HTTP2_HEADER_PATH:HTTP2_HEADER_PATH,HTTP2_HEADER_TE:HTTP2_HEADER_TE,HTTP2_HEADER_USER_AGENT:HTTP2_HEADER_USER_AGENT}=http2.constants;const tooManyPingsData=Buffer.from("too_many_pings","ascii");function isTcpSubchannelAddress(address){return"port"in address}function subchannelAddressToString(address){return isTcpSubchannelAddress(address)?address.host+":"+address.port:address.path}exports.isTcpSubchannelAddress=isTcpSubchannelAddress,exports.subchannelAddressEqual=function subchannelAddressEqual(address1,address2){return isTcpSubchannelAddress(address1)?isTcpSubchannelAddress(address2)&&address1.host===address2.host&&address1.port===address2.port:!isTcpSubchannelAddress(address2)&&address1.path===address2.path},exports.subchannelAddressToString=subchannelAddressToString;exports.Subchannel=class{constructor(channelTarget,subchannelAddress,options,credentials){this.channelTarget=channelTarget,this.subchannelAddress=subchannelAddress,this.options=options,this.credentials=credentials,this.connectivityState=channel_1.ConnectivityState.IDLE,this.session=null,this.continueConnecting=!1,this.stateListeners=[],this.disconnectListeners=[],this.keepaliveTimeMs=2147483647,this.keepaliveTimeoutMs=2e4,this.keepaliveWithoutCalls=!1,this.callRefcount=0,this.refcount=0,this.userAgent=[options["grpc.primary_user_agent"],`grpc-node-js/${clientVersion}`,options["grpc.secondary_user_agent"]].filter(e=>e).join(" "),"grpc.keepalive_time_ms"in options&&(this.keepaliveTimeMs=options["grpc.keepalive_time_ms"]),"grpc.keepalive_timeout_ms"in options&&(this.keepaliveTimeoutMs=options["grpc.keepalive_timeout_ms"]),this.keepaliveWithoutCalls="grpc.keepalive_permit_without_calls"in options&&1===options["grpc.keepalive_permit_without_calls"],this.keepaliveIntervalId=setTimeout(()=>{},0),clearTimeout(this.keepaliveIntervalId),this.keepaliveTimeoutId=setTimeout(()=>{},0),clearTimeout(this.keepaliveTimeoutId);const backoffOptions={initialDelay:options["grpc.initial_reconnect_backoff_ms"],maxDelay:options["grpc.max_reconnect_backoff_ms"]};this.backoffTimeout=new backoff_timeout_1.BackoffTimeout(()=>{this.handleBackoffTimer()},backoffOptions),this.subchannelAddressString=subchannelAddressToString(subchannelAddress)}handleBackoffTimer(){this.continueConnecting?this.transitionToState([channel_1.ConnectivityState.TRANSIENT_FAILURE],channel_1.ConnectivityState.CONNECTING):this.transitionToState([channel_1.ConnectivityState.TRANSIENT_FAILURE],channel_1.ConnectivityState.IDLE)}startBackoff(){this.backoffTimeout.runOnce()}stopBackoff(){this.backoffTimeout.stop(),this.backoffTimeout.reset()}sendPing(){var _a,_b;logging.trace(constants_1.LogVerbosity.DEBUG,"keepalive","Sending ping to "+this.subchannelAddressString),this.keepaliveTimeoutId=setTimeout(()=>{this.transitionToState([channel_1.ConnectivityState.READY],channel_1.ConnectivityState.IDLE)},this.keepaliveTimeoutMs),null===(_b=(_a=this.keepaliveTimeoutId).unref)||void 0===_b||_b.call(_a),this.session.ping((err,duration,payload)=>{clearTimeout(this.keepaliveTimeoutId)})}startKeepalivePings(){var _a,_b;this.keepaliveIntervalId=setInterval(()=>{this.sendPing()},this.keepaliveTimeMs),null===(_b=(_a=this.keepaliveIntervalId).unref)||void 0===_b||_b.call(_a)}stopKeepalivePings(){clearInterval(this.keepaliveIntervalId),clearTimeout(this.keepaliveTimeoutId)}createSession(proxyConnectionResult){var _a,_b,_c;const targetAuthority=resolver_1.getDefaultAuthority(null!==(_a=proxyConnectionResult.realTarget)&&void 0!==_a?_a:this.channelTarget);let connectionOptions=this.credentials._getConnectionOptions()||{};connectionOptions.maxSendHeaderBlockLength=Number.MAX_SAFE_INTEGER,"grpc-node.max_session_memory"in this.options&&(connectionOptions.maxSessionMemory=this.options["grpc-node.max_session_memory"]);let addressScheme="http://";if("secureContext"in connectionOptions){if(addressScheme="https://",this.options["grpc.ssl_target_name_override"]){const sslTargetNameOverride=this.options["grpc.ssl_target_name_override"];connectionOptions.checkServerIdentity=(host,cert)=>tls_1.checkServerIdentity(sslTargetNameOverride,cert),connectionOptions.servername=sslTargetNameOverride}else{const authorityHostname=null!==(_c=null===(_b=uri_parser_1.splitHostPort(targetAuthority))||void 0===_b?void 0:_b.host)&&void 0!==_c?_c:"localhost";connectionOptions.servername=authorityHostname}proxyConnectionResult.socket&&(connectionOptions.createConnection=(authority,option)=>proxyConnectionResult.socket)}else connectionOptions.createConnection=(authority,option)=>proxyConnectionResult.socket?proxyConnectionResult.socket:net.connect(this.subchannelAddress);connectionOptions=Object.assign(Object.assign({},connectionOptions),this.subchannelAddress);const session=http2.connect(addressScheme+targetAuthority,connectionOptions);this.session=session,session.unref(),session.once("connect",()=>{this.session===session&&this.transitionToState([channel_1.ConnectivityState.CONNECTING],channel_1.ConnectivityState.READY)}),session.once("close",()=>{this.session===session&&(this.transitionToState([channel_1.ConnectivityState.CONNECTING],channel_1.ConnectivityState.TRANSIENT_FAILURE),this.transitionToState([channel_1.ConnectivityState.READY],channel_1.ConnectivityState.IDLE))}),session.once("goaway",(errorCode,lastStreamID,opaqueData)=>{this.session===session&&(errorCode===http2.constants.NGHTTP2_ENHANCE_YOUR_CALM&&opaqueData.equals(tooManyPingsData)&&(this.keepaliveTimeMs=Math.min(2*this.keepaliveTimeMs,2147483647),logging.log(constants_1.LogVerbosity.ERROR,`Connection to ${uri_parser_1.uriToString(this.channelTarget)} at ${this.subchannelAddressString} rejected by server because of excess pings. Increasing ping interval to ${this.keepaliveTimeMs} ms`)),trace(this.subchannelAddressString+" connection closed by GOAWAY with code "+errorCode),this.transitionToState([channel_1.ConnectivityState.CONNECTING,channel_1.ConnectivityState.READY],channel_1.ConnectivityState.IDLE))}),session.once("error",error=>{trace(this.subchannelAddressString+" connection closed with error "+error.message)})}startConnectingInternal(){var _a,_b;const connectionOptions=this.credentials._getConnectionOptions()||{};if("secureContext"in connectionOptions)if(connectionOptions.ALPNProtocols=["h2"],this.options["grpc.ssl_target_name_override"]){const sslTargetNameOverride=this.options["grpc.ssl_target_name_override"];connectionOptions.checkServerIdentity=(host,cert)=>tls_1.checkServerIdentity(sslTargetNameOverride,cert),connectionOptions.servername=sslTargetNameOverride}else if("grpc.http_connect_target"in this.options){const targetPath=resolver_1.getDefaultAuthority(null!==(_a=uri_parser_1.parseUri(this.options["grpc.http_connect_target"]))&&void 0!==_a?_a:{path:"localhost"}),hostPort=uri_parser_1.splitHostPort(targetPath);connectionOptions.servername=null!==(_b=null==hostPort?void 0:hostPort.host)&&void 0!==_b?_b:targetPath}http_proxy_1.getProxiedConnection(this.subchannelAddress,this.options,connectionOptions).then(result=>{this.createSession(result)},reason=>{this.transitionToState([channel_1.ConnectivityState.CONNECTING],channel_1.ConnectivityState.TRANSIENT_FAILURE)})}transitionToState(oldStates,newState){if(-1===oldStates.indexOf(this.connectivityState))return!1;trace(this.subchannelAddressString+" "+channel_1.ConnectivityState[this.connectivityState]+" -> "+channel_1.ConnectivityState[newState]);const previousState=this.connectivityState;switch(this.connectivityState=newState,newState){case channel_1.ConnectivityState.READY:this.stopBackoff(),this.session.socket.once("close",()=>{for(const listener of this.disconnectListeners)listener()}),this.keepaliveWithoutCalls&&this.startKeepalivePings();break;case channel_1.ConnectivityState.CONNECTING:this.startBackoff(),this.startConnectingInternal(),this.continueConnecting=!1;break;case channel_1.ConnectivityState.TRANSIENT_FAILURE:this.session&&this.session.close(),this.session=null,this.stopKeepalivePings(),this.backoffTimeout.isRunning()||process.nextTick(()=>{this.handleBackoffTimer()});break;case channel_1.ConnectivityState.IDLE:this.session&&this.session.close(),this.session=null,this.stopKeepalivePings();break;default:throw new Error(`Invalid state: unknown ConnectivityState ${newState}`)}for(const listener of[...this.stateListeners])listener(this,previousState,newState);return!0}checkBothRefcounts(){0===this.callRefcount&&0===this.refcount&&this.transitionToState([channel_1.ConnectivityState.CONNECTING,channel_1.ConnectivityState.READY],channel_1.ConnectivityState.TRANSIENT_FAILURE)}callRef(){refTrace(this.subchannelAddressString+" callRefcount "+this.callRefcount+" -> "+(this.callRefcount+1)),0===this.callRefcount&&(this.session&&this.session.ref(),this.backoffTimeout.ref(),this.keepaliveWithoutCalls||this.startKeepalivePings()),this.callRefcount+=1}callUnref(){refTrace(this.subchannelAddressString+" callRefcount "+this.callRefcount+" -> "+(this.callRefcount-1)),this.callRefcount-=1,0===this.callRefcount&&(this.session&&this.session.unref(),this.backoffTimeout.unref(),this.keepaliveWithoutCalls||this.stopKeepalivePings(),this.checkBothRefcounts())}ref(){refTrace(this.subchannelAddressString+" refcount "+this.refcount+" -> "+(this.refcount+1)),this.refcount+=1}unref(){refTrace(this.subchannelAddressString+" refcount "+this.refcount+" -> "+(this.refcount-1)),this.refcount-=1,this.checkBothRefcounts()}unrefIfOneRef(){return 1===this.refcount&&(this.unref(),!0)}startCallStream(metadata,callStream,extraFilterFactory){const headers=metadata.toHttp2Headers();let http2Stream;headers[HTTP2_HEADER_AUTHORITY]=callStream.getHost(),headers[HTTP2_HEADER_USER_AGENT]=this.userAgent,headers[HTTP2_HEADER_CONTENT_TYPE]="application/grpc",headers[HTTP2_HEADER_METHOD]="POST",headers[HTTP2_HEADER_PATH]=callStream.getMethod(),headers[HTTP2_HEADER_TE]="trailers";try{http2Stream=this.session.request(headers)}catch(e){throw this.transitionToState([channel_1.ConnectivityState.READY],channel_1.ConnectivityState.TRANSIENT_FAILURE),e}let headersString="";for(const header of Object.keys(headers))headersString+="\t\t"+header+": "+headers[header]+"\n";logging.trace(constants_1.LogVerbosity.DEBUG,"call_stream","Starting stream on subchannel "+this.subchannelAddressString+" with headers\n"+headersString),callStream.attachHttp2Stream(http2Stream,this,extraFilterFactory)}startConnecting(){this.transitionToState([channel_1.ConnectivityState.IDLE],channel_1.ConnectivityState.CONNECTING)||this.connectivityState===channel_1.ConnectivityState.TRANSIENT_FAILURE&&(this.continueConnecting=!0)}getConnectivityState(){return this.connectivityState}addConnectivityStateListener(listener){this.stateListeners.push(listener)}removeConnectivityStateListener(listener){const listenerIndex=this.stateListeners.indexOf(listener);listenerIndex>-1&&this.stateListeners.splice(listenerIndex,1)}addDisconnectListener(listener){this.disconnectListeners.push(listener)}removeDisconnectListener(listener){const listenerIndex=this.disconnectListeners.indexOf(listener);listenerIndex>-1&&this.disconnectListeners.splice(listenerIndex,1)}resetBackoff(){this.backoffTimeout.reset(),this.transitionToState([channel_1.ConnectivityState.TRANSIENT_FAILURE],channel_1.ConnectivityState.CONNECTING)}getAddress(){return this.subchannelAddressString}}},JG2R:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.registerAll=exports.validateLoadBalancingConfig=exports.getFirstUsableConfig=exports.isLoadBalancerNameRegistered=exports.createLoadBalancer=exports.registerLoadBalancerType=void 0;const load_balancer_pick_first=__webpack_require__("Dseh"),load_balancer_round_robin=__webpack_require__("uhwk"),registeredLoadBalancerTypes={};exports.registerLoadBalancerType=function registerLoadBalancerType(typeName,loadBalancerType,loadBalancingConfigType){registeredLoadBalancerTypes[typeName]={LoadBalancer:loadBalancerType,LoadBalancingConfig:loadBalancingConfigType}},exports.createLoadBalancer=function createLoadBalancer(config,channelControlHelper){const typeName=config.getLoadBalancerName();return typeName in registeredLoadBalancerTypes?new registeredLoadBalancerTypes[typeName].LoadBalancer(channelControlHelper):null},exports.isLoadBalancerNameRegistered=function isLoadBalancerNameRegistered(typeName){return typeName in registeredLoadBalancerTypes},exports.getFirstUsableConfig=function getFirstUsableConfig(configs,defaultPickFirst=!1){for(const config of configs)if(config.getLoadBalancerName()in registeredLoadBalancerTypes)return config;return defaultPickFirst?new load_balancer_pick_first.PickFirstLoadBalancingConfig:null},exports.validateLoadBalancingConfig=function validateLoadBalancingConfig(obj){if(null===obj||"object"!=typeof obj)throw new Error("Load balancing config must be an object");const keys=Object.keys(obj);if(1!==keys.length)throw new Error("Provided load balancing config has multiple conflicting entries");const typeName=keys[0];if(typeName in registeredLoadBalancerTypes)return registeredLoadBalancerTypes[typeName].LoadBalancingConfig.createFromJson(obj[typeName]);throw new Error(`Unrecognized load balancing config name ${typeName}`)},exports.registerAll=function registerAll(){load_balancer_pick_first.setup(),load_balancer_round_robin.setup()}},JUUq:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.setup=void 0;const resolver_1=__webpack_require__("9rQR"),dns=__webpack_require__("NcB8"),util=__webpack_require__("jK02"),service_config_1=__webpack_require__("Mkf5"),constants_1=__webpack_require__("8o9P"),metadata_1=__webpack_require__("m7sO"),logging=__webpack_require__("xQiD"),constants_2=__webpack_require__("8o9P"),uri_parser_1=__webpack_require__("x8Ej"),net_1=__webpack_require__("Qs2e");function trace(text){logging.trace(constants_2.LogVerbosity.DEBUG,"dns_resolver",text)}const resolveTxtPromise=util.promisify(dns.resolveTxt),dnsLookupPromise=util.promisify(dns.lookup);class DnsResolver{constructor(target,listener,channelOptions){var _a,_b;this.target=target,this.listener=listener,this.pendingLookupPromise=null,this.pendingTxtPromise=null,this.latestLookupResult=null,this.latestServiceConfig=null,this.latestServiceConfigError=null,trace("Resolver constructed for target "+uri_parser_1.uriToString(target));const hostPort=uri_parser_1.splitHostPort(target.path);null===hostPort?(this.ipResult=null,this.dnsHostname=null,this.port=null):net_1.isIPv4(hostPort.host)||net_1.isIPv6(hostPort.host)?(this.ipResult=[{host:hostPort.host,port:null!==(_a=hostPort.port)&&void 0!==_a?_a:443}],this.dnsHostname=null,this.port=null):(this.ipResult=null,this.dnsHostname=hostPort.host,this.port=null!==(_b=hostPort.port)&&void 0!==_b?_b:443),this.percentage=100*Math.random(),this.defaultResolutionError={code:constants_1.Status.UNAVAILABLE,details:`Name resolution failed for target ${uri_parser_1.uriToString(this.target)}`,metadata:new metadata_1.Metadata}}startResolution(){if(null!==this.ipResult)return trace("Returning IP address for target "+uri_parser_1.uriToString(this.target)),void setImmediate(()=>{this.listener.onSuccessfulResolution(this.ipResult,null,null,null,{})});if(null===this.dnsHostname)setImmediate(()=>{this.listener.onError({code:constants_1.Status.UNAVAILABLE,details:`Failed to parse DNS address ${uri_parser_1.uriToString(this.target)}`,metadata:new metadata_1.Metadata})});else{this.latestLookupResult=null;const hostname=this.dnsHostname;this.pendingLookupPromise=dnsLookupPromise(hostname,{all:!0}),this.pendingLookupPromise.then(addressList=>{this.pendingLookupPromise=null;const ip4Addresses=addressList.filter(addr=>4===addr.family),ip6Addresses=addressList.filter(addr=>6===addr.family);this.latestLookupResult=function mergeArrays(...arrays){const result=[];for(let i=0;i<Math.max.apply(null,arrays.map(array=>array.length));i++)for(const array of arrays)i<array.length&&result.push(array[i]);return result}(ip6Addresses,ip4Addresses).map(addr=>({host:addr.address,port:+this.port}));const allAddressesString="["+this.latestLookupResult.map(addr=>addr.host+":"+addr.port).join(",")+"]";trace("Resolved addresses for target "+uri_parser_1.uriToString(this.target)+": "+allAddressesString),0!==this.latestLookupResult.length?this.listener.onSuccessfulResolution(this.latestLookupResult,this.latestServiceConfig,this.latestServiceConfigError,null,{}):this.listener.onError(this.defaultResolutionError)},err=>{trace("Resolution error for target "+uri_parser_1.uriToString(this.target)+": "+err.message),this.pendingLookupPromise=null,this.listener.onError(this.defaultResolutionError)}),null===this.pendingTxtPromise&&(this.pendingTxtPromise=resolveTxtPromise(hostname),this.pendingTxtPromise.then(txtRecord=>{this.pendingTxtPromise=null;try{this.latestServiceConfig=service_config_1.extractAndSelectServiceConfig(txtRecord,this.percentage)}catch(err){this.latestServiceConfigError={code:constants_1.Status.UNAVAILABLE,details:"Parsing service config failed",metadata:new metadata_1.Metadata}}null!==this.latestLookupResult&&this.listener.onSuccessfulResolution(this.latestLookupResult,this.latestServiceConfig,this.latestServiceConfigError,null,{})},err=>{}))}}updateResolution(){trace("Resolution update requested for target "+uri_parser_1.uriToString(this.target)),null===this.pendingLookupPromise&&this.startResolution()}destroy(){}static getDefaultAuthority(target){return target.path}}exports.setup=function setup(){resolver_1.registerResolver("dns",DnsResolver),resolver_1.registerDefaultScheme("dns")}},KRUT:function(module){module.exports=JSON.parse('{"nested":{"google":{"nested":{"protobuf":{"nested":{"Api":{"fields":{"name":{"type":"string","id":1},"methods":{"rule":"repeated","type":"Method","id":2},"options":{"rule":"repeated","type":"Option","id":3},"version":{"type":"string","id":4},"sourceContext":{"type":"SourceContext","id":5},"mixins":{"rule":"repeated","type":"Mixin","id":6},"syntax":{"type":"Syntax","id":7}}},"Method":{"fields":{"name":{"type":"string","id":1},"requestTypeUrl":{"type":"string","id":2},"requestStreaming":{"type":"bool","id":3},"responseTypeUrl":{"type":"string","id":4},"responseStreaming":{"type":"bool","id":5},"options":{"rule":"repeated","type":"Option","id":6},"syntax":{"type":"Syntax","id":7}}},"Mixin":{"fields":{"name":{"type":"string","id":1},"root":{"type":"string","id":2}}},"SourceContext":{"fields":{"fileName":{"type":"string","id":1}}},"Option":{"fields":{"name":{"type":"string","id":1},"value":{"type":"Any","id":2}}},"Syntax":{"values":{"SYNTAX_PROTO2":0,"SYNTAX_PROTO3":1}}}}}}}}')},KgU9:function(module,exports,__webpack_require__){"use strict";var firebase=__webpack_require__("eq5/"),tslib=__webpack_require__("zOht"),component=__webpack_require__("S+S0"),nodeFetch=__webpack_require__("m0OZ");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var firebase__default=_interopDefaultLegacy(firebase),nodeFetch__default=_interopDefaultLegacy(nodeFetch),errorCodeMap={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},HttpsErrorImpl=function(_super){function HttpsErrorImpl(code,message,details){var _this=_super.call(this,message)||this;return Object.setPrototypeOf(_this,HttpsErrorImpl.prototype),_this.code=code,_this.details=details,_this}return tslib.__extends(HttpsErrorImpl,_super),HttpsErrorImpl}(Error);var ContextProvider=function(){function ContextProvider(authProvider,messagingProvider){var _this=this;this.auth=null,this.messaging=null,this.auth=authProvider.getImmediate({optional:!0}),this.messaging=messagingProvider.getImmediate({optional:!0}),this.auth||authProvider.get().then(function(auth){return _this.auth=auth},function(){}),this.messaging||messagingProvider.get().then(function(messaging){return _this.messaging=messaging},function(){})}return ContextProvider.prototype.getAuthToken=function(){return tslib.__awaiter(this,void 0,void 0,function(){var token;return tslib.__generator(this,function(_a){switch(_a.label){case 0:if(!this.auth)return[2,void 0];_a.label=1;case 1:return _a.trys.push([1,3,,4]),[4,this.auth.getToken()];case 2:return(token=_a.sent())?[2,token.accessToken]:[2,void 0];case 3:return _a.sent(),[2,void 0];case 4:return[2]}})})},ContextProvider.prototype.getInstanceIdToken=function(){return tslib.__awaiter(this,void 0,void 0,function(){return tslib.__generator(this,function(_a){switch(_a.label){case 0:if(!this.messaging||!("Notification"in self)||"granted"!==Notification.permission)return[2,void 0];_a.label=1;case 1:return _a.trys.push([1,3,,4]),[4,this.messaging.getToken()];case 2:return[2,_a.sent()];case 3:return _a.sent(),[2,void 0];case 4:return[2]}})})},ContextProvider.prototype.getContext=function(){return tslib.__awaiter(this,void 0,void 0,function(){var authToken,instanceIdToken;return tslib.__generator(this,function(_a){switch(_a.label){case 0:return[4,this.getAuthToken()];case 1:return authToken=_a.sent(),[4,this.getInstanceIdToken()];case 2:return instanceIdToken=_a.sent(),[2,{authToken:authToken,instanceIdToken:instanceIdToken}]}})})},ContextProvider}();function mapValues(o,f){var result={};for(var key in o)o.hasOwnProperty(key)&&(result[key]=f(o[key]));return result}var Serializer=function(){function Serializer(){}return Serializer.prototype.encode=function(data){var _this=this;if(null==data)return null;if(data instanceof Number&&(data=data.valueOf()),"number"==typeof data&&isFinite(data))return data;if(!0===data||!1===data)return data;if("[object String]"===Object.prototype.toString.call(data))return data;if(data instanceof Date)return data.toISOString();if(Array.isArray(data))return data.map(function(x){return _this.encode(x)});if("function"==typeof data||"object"==typeof data)return mapValues(data,function(x){return _this.encode(x)});throw new Error("Data cannot be encoded in JSON: "+data)},Serializer.prototype.decode=function(json){var _this=this;if(null==json)return json;if(json["@type"])switch(json["@type"]){case"type.googleapis.com/google.protobuf.Int64Value":case"type.googleapis.com/google.protobuf.UInt64Value":var value=Number(json.value);if(isNaN(value))throw new Error("Data cannot be decoded from JSON: "+json);return value;default:throw new Error("Data cannot be decoded from JSON: "+json)}return Array.isArray(json)?json.map(function(x){return _this.decode(x)}):"function"==typeof json||"object"==typeof json?mapValues(json,function(x){return _this.decode(x)}):json},Serializer}();var Service=function(){function Service(app_,authProvider,messagingProvider,appCheckProvider,regionOrCustomDomain_,fetchImpl){var _this=this;void 0===regionOrCustomDomain_&&(regionOrCustomDomain_="us-central1"),this.app_=app_,this.appCheckProvider=appCheckProvider,this.fetchImpl=fetchImpl,this.serializer=new Serializer,this.emulatorOrigin=null,this.INTERNAL={delete:function(){return Promise.resolve(_this.deleteService())}},this.contextProvider=new ContextProvider(authProvider,messagingProvider),this.cancelAllRequests=new Promise(function(resolve){_this.deleteService=function(){return resolve()}});try{var url=new URL(regionOrCustomDomain_);this.customDomain=url.origin,this.region="us-central1"}catch(e){this.customDomain=null,this.region=regionOrCustomDomain_}}return Object.defineProperty(Service.prototype,"app",{get:function(){return this.app_},enumerable:!1,configurable:!0}),Service.prototype._url=function(name){var projectId=this.app_.options.projectId;return null!==this.emulatorOrigin?this.emulatorOrigin+"/"+projectId+"/"+this.region+"/"+name:null!==this.customDomain?this.customDomain+"/"+name:"https://"+this.region+"-"+projectId+".cloudfunctions.net/"+name},Service.prototype.useEmulator=function(host,port){this.emulatorOrigin="http://"+host+":"+port},Service.prototype.useFunctionsEmulator=function(origin){this.emulatorOrigin=origin},Service.prototype.httpsCallable=function(name,options){var _this=this;return function(data){return _this.call(name,data,options||{})}},Service.prototype.postJSON=function(url,body,headers){return tslib.__awaiter(this,void 0,void 0,function(){var appCheckToken,response,json;return tslib.__generator(this,function(_a){switch(_a.label){case 0:return headers["Content-Type"]="application/json",[4,this.getAppCheckToken()];case 1:null!==(appCheckToken=_a.sent())&&(headers["X-Firebase-AppCheck"]=appCheckToken),_a.label=2;case 2:return _a.trys.push([2,4,,5]),[4,this.fetchImpl(url,{method:"POST",body:JSON.stringify(body),headers:headers})];case 3:return response=_a.sent(),[3,5];case 4:return _a.sent(),[2,{status:0,json:null}];case 5:json=null,_a.label=6;case 6:return _a.trys.push([6,8,,9]),[4,response.json()];case 7:return json=_a.sent(),[3,9];case 8:return _a.sent(),[3,9];case 9:return[2,{status:response.status,json:json}]}})})},Service.prototype.getAppCheckToken=function(){return tslib.__awaiter(this,void 0,void 0,function(){var appCheck;return tslib.__generator(this,function(_a){switch(_a.label){case 0:return(appCheck=this.appCheckProvider.getImmediate({optional:!0}))?[4,appCheck.getToken()]:[3,2];case 1:return[2,_a.sent().token];case 2:return[2,null]}})})},Service.prototype.call=function(name,data,options){return tslib.__awaiter(this,void 0,void 0,function(){var url,body,headers,context,timeout,_a,timer,failAfterPromise,response,error,responseData;return tslib.__generator(this,function(_b){switch(_b.label){case 0:return url=this._url(name),data=this.serializer.encode(data),body={data:data},headers={},[4,this.contextProvider.getContext()];case 1:return(context=_b.sent()).authToken&&(headers.Authorization="Bearer "+context.authToken),context.instanceIdToken&&(headers["Firebase-Instance-ID-Token"]=context.instanceIdToken),timeout=options.timeout||7e4,_a=function failAfter(millis){var timer,promise=new Promise(function(_,reject){timer=setTimeout(function(){reject(new HttpsErrorImpl("deadline-exceeded","deadline-exceeded"))},millis)});return{timer:timer,promise:promise}}(timeout),timer=_a.timer,failAfterPromise=_a.promise,[4,Promise.race([clearTimeoutWrapper(timer,this.postJSON(url,body,headers)),failAfterPromise,clearTimeoutWrapper(timer,this.cancelAllRequests)])];case 2:if(!(response=_b.sent()))throw new HttpsErrorImpl("cancelled","Firebase Functions instance was deleted.");if(error=function _errorForResponse(status,bodyJSON,serializer){var code=function codeForHTTPStatus(status){if(status>=200&&status<300)return"ok";switch(status){case 0:return"internal";case 400:return"invalid-argument";case 401:return"unauthenticated";case 403:return"permission-denied";case 404:return"not-found";case 409:return"aborted";case 429:return"resource-exhausted";case 499:return"cancelled";case 500:return"internal";case 501:return"unimplemented";case 503:return"unavailable";case 504:return"deadline-exceeded"}return"unknown"}(status),description=code,details=void 0;try{var errorJSON=bodyJSON&&bodyJSON.error;if(errorJSON){var status_1=errorJSON.status;if("string"==typeof status_1){if(!errorCodeMap[status_1])return new HttpsErrorImpl("internal","internal");code=errorCodeMap[status_1],description=status_1}var message=errorJSON.message;"string"==typeof message&&(description=message),void 0!==(details=errorJSON.details)&&(details=serializer.decode(details))}}catch(e){}return"ok"===code?null:new HttpsErrorImpl(code,description,details)}(response.status,response.json,this.serializer))throw error;if(!response.json)throw new HttpsErrorImpl("internal","Response is not valid JSON object.");if(void 0===(responseData=response.json.data)&&(responseData=response.json.result),void 0===responseData)throw new HttpsErrorImpl("internal","Response is missing data field.");return[2,{data:this.serializer.decode(responseData)}]}})})},Service}();function clearTimeoutWrapper(timer,promise){return tslib.__awaiter(this,void 0,void 0,function(){var result;return tslib.__generator(this,function(_a){switch(_a.label){case 0:return[4,promise];case 1:return result=_a.sent(),clearTimeout(timer),[2,result]}})})}!function registerFunctions(instance,fetchImpl){var namespaceExports={Functions:Service};instance.INTERNAL.registerComponent(new component.Component("functions",function factory(container,_a){var regionOrCustomDomain=_a.instanceIdentifier,app=container.getProvider("app").getImmediate(),authProvider=container.getProvider("auth-internal"),appCheckProvider=container.getProvider("app-check-internal"),messagingProvider=container.getProvider("messaging");return new Service(app,authProvider,messagingProvider,appCheckProvider,regionOrCustomDomain,fetchImpl)},"PUBLIC").setServiceProps(namespaceExports).setMultipleInstances(!0))}(firebase__default.default,nodeFetch__default.default),firebase__default.default.registerVersion("@firebase/functions","0.6.13","node")},KlcT:function(module,exports,__webpack_require__){"use strict";module.exports=function verifier(mtype){var gen=util.codegen(["m"],mtype.name+"$verify")('if(typeof m!=="object"||m===null)')("return%j","object expected"),oneofs=mtype.oneofsArray,seenFirstField={};oneofs.length&&gen("var p={}");for(var i=0;i<mtype.fieldsArray.length;++i){var field=mtype._fieldsArray[i].resolve(),ref="m"+util.safeProp(field.name);if(field.optional&&gen("if(%s!=null&&m.hasOwnProperty(%j)){",ref,field.name),field.map)gen("if(!util.isObject(%s))",ref)("return%j",invalid(field,"object"))("var k=Object.keys(%s)",ref)("for(var i=0;i<k.length;++i){"),genVerifyKey(gen,field,"k[i]"),genVerifyValue(gen,field,i,ref+"[k[i]]")("}");else if(field.repeated)gen("if(!Array.isArray(%s))",ref)("return%j",invalid(field,"array"))("for(var i=0;i<%s.length;++i){",ref),genVerifyValue(gen,field,i,ref+"[i]")("}");else{if(field.partOf){var oneofProp=util.safeProp(field.partOf.name);1===seenFirstField[field.partOf.name]&&gen("if(p%s===1)",oneofProp)("return%j",field.partOf.name+": multiple values"),seenFirstField[field.partOf.name]=1,gen("p%s=1",oneofProp)}genVerifyValue(gen,field,i,ref)}field.optional&&gen("}")}return gen("return null")};var Enum=__webpack_require__("vREW"),util=__webpack_require__("y9PA");function invalid(field,expected){return field.name+": "+expected+(field.repeated&&"array"!==expected?"[]":field.map&&"object"!==expected?"{k:"+field.keyType+"}":"")+" expected"}function genVerifyValue(gen,field,fieldIndex,ref){if(field.resolvedType)if(field.resolvedType instanceof Enum){gen("switch(%s){",ref)("default:")("return%j",invalid(field,"enum value"));for(var keys=Object.keys(field.resolvedType.values),j=0;j<keys.length;++j)gen("case %i:",field.resolvedType.values[keys[j]]);gen("break")("}")}else gen("{")("var e=types[%i].verify(%s);",fieldIndex,ref)("if(e)")("return%j+e",field.name+".")("}");else switch(field.type){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":gen("if(!util.isInteger(%s))",ref)("return%j",invalid(field,"integer"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":gen("if(!util.isInteger(%s)&&!(%s&&util.isInteger(%s.low)&&util.isInteger(%s.high)))",ref,ref,ref,ref)("return%j",invalid(field,"integer|Long"));break;case"float":case"double":gen('if(typeof %s!=="number")',ref)("return%j",invalid(field,"number"));break;case"bool":gen('if(typeof %s!=="boolean")',ref)("return%j",invalid(field,"boolean"));break;case"string":gen("if(!util.isString(%s))",ref)("return%j",invalid(field,"string"));break;case"bytes":gen('if(!(%s&&typeof %s.length==="number"||util.isString(%s)))',ref,ref,ref)("return%j",invalid(field,"buffer"))}return gen}function genVerifyKey(gen,field,ref){switch(field.keyType){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":gen("if(!util.key32Re.test(%s))",ref)("return%j",invalid(field,"integer key"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":gen("if(!util.key64Re.test(%s))",ref)("return%j",invalid(field,"integer|Long key"));break;case"bool":gen("if(!util.key2Re.test(%s))",ref)("return%j",invalid(field,"boolean key"))}return gen}},KwGI:function(module,exports,__webpack_require__){"use strict";function factory(exports){return"undefined"!=typeof Float32Array?function(){var f32=new Float32Array([-0]),f8b=new Uint8Array(f32.buffer),le=128===f8b[3];function writeFloat_f32_cpy(val,buf,pos){f32[0]=val,buf[pos]=f8b[0],buf[pos+1]=f8b[1],buf[pos+2]=f8b[2],buf[pos+3]=f8b[3]}function writeFloat_f32_rev(val,buf,pos){f32[0]=val,buf[pos]=f8b[3],buf[pos+1]=f8b[2],buf[pos+2]=f8b[1],buf[pos+3]=f8b[0]}function readFloat_f32_cpy(buf,pos){return f8b[0]=buf[pos],f8b[1]=buf[pos+1],f8b[2]=buf[pos+2],f8b[3]=buf[pos+3],f32[0]}function readFloat_f32_rev(buf,pos){return f8b[3]=buf[pos],f8b[2]=buf[pos+1],f8b[1]=buf[pos+2],f8b[0]=buf[pos+3],f32[0]}exports.writeFloatLE=le?writeFloat_f32_cpy:writeFloat_f32_rev,exports.writeFloatBE=le?writeFloat_f32_rev:writeFloat_f32_cpy,exports.readFloatLE=le?readFloat_f32_cpy:readFloat_f32_rev,exports.readFloatBE=le?readFloat_f32_rev:readFloat_f32_cpy}():function(){function writeFloat_ieee754(writeUint,val,buf,pos){var sign=val<0?1:0;if(sign&&(val=-val),0===val)writeUint(1/val>0?0:2147483648,buf,pos);else if(isNaN(val))writeUint(2143289344,buf,pos);else if(val>34028234663852886e22)writeUint((sign<<31|2139095040)>>>0,buf,pos);else if(val<11754943508222875e-54)writeUint((sign<<31|Math.round(val/1401298464324817e-60))>>>0,buf,pos);else{var exponent=Math.floor(Math.log(val)/Math.LN2);writeUint((sign<<31|exponent+127<<23|8388607&Math.round(val*Math.pow(2,-exponent)*8388608))>>>0,buf,pos)}}function readFloat_ieee754(readUint,buf,pos){var uint=readUint(buf,pos),sign=2*(uint>>31)+1,exponent=uint>>>23&255,mantissa=8388607&uint;return 255===exponent?mantissa?NaN:sign*(1/0):0===exponent?1401298464324817e-60*sign*mantissa:sign*Math.pow(2,exponent-150)*(mantissa+8388608)}exports.writeFloatLE=writeFloat_ieee754.bind(null,writeUintLE),exports.writeFloatBE=writeFloat_ieee754.bind(null,writeUintBE),exports.readFloatLE=readFloat_ieee754.bind(null,readUintLE),exports.readFloatBE=readFloat_ieee754.bind(null,readUintBE)}(),"undefined"!=typeof Float64Array?function(){var f64=new Float64Array([-0]),f8b=new Uint8Array(f64.buffer),le=128===f8b[7];function writeDouble_f64_cpy(val,buf,pos){f64[0]=val,buf[pos]=f8b[0],buf[pos+1]=f8b[1],buf[pos+2]=f8b[2],buf[pos+3]=f8b[3],buf[pos+4]=f8b[4],buf[pos+5]=f8b[5],buf[pos+6]=f8b[6],buf[pos+7]=f8b[7]}function writeDouble_f64_rev(val,buf,pos){f64[0]=val,buf[pos]=f8b[7],buf[pos+1]=f8b[6],buf[pos+2]=f8b[5],buf[pos+3]=f8b[4],buf[pos+4]=f8b[3],buf[pos+5]=f8b[2],buf[pos+6]=f8b[1],buf[pos+7]=f8b[0]}function readDouble_f64_cpy(buf,pos){return f8b[0]=buf[pos],f8b[1]=buf[pos+1],f8b[2]=buf[pos+2],f8b[3]=buf[pos+3],f8b[4]=buf[pos+4],f8b[5]=buf[pos+5],f8b[6]=buf[pos+6],f8b[7]=buf[pos+7],f64[0]}function readDouble_f64_rev(buf,pos){return f8b[7]=buf[pos],f8b[6]=buf[pos+1],f8b[5]=buf[pos+2],f8b[4]=buf[pos+3],f8b[3]=buf[pos+4],f8b[2]=buf[pos+5],f8b[1]=buf[pos+6],f8b[0]=buf[pos+7],f64[0]}exports.writeDoubleLE=le?writeDouble_f64_cpy:writeDouble_f64_rev,exports.writeDoubleBE=le?writeDouble_f64_rev:writeDouble_f64_cpy,exports.readDoubleLE=le?readDouble_f64_cpy:readDouble_f64_rev,exports.readDoubleBE=le?readDouble_f64_rev:readDouble_f64_cpy}():function(){function writeDouble_ieee754(writeUint,off0,off1,val,buf,pos){var sign=val<0?1:0;if(sign&&(val=-val),0===val)writeUint(0,buf,pos+off0),writeUint(1/val>0?0:2147483648,buf,pos+off1);else if(isNaN(val))writeUint(0,buf,pos+off0),writeUint(2146959360,buf,pos+off1);else if(val>17976931348623157e292)writeUint(0,buf,pos+off0),writeUint((sign<<31|2146435072)>>>0,buf,pos+off1);else{var mantissa;if(val<22250738585072014e-324)writeUint((mantissa=val/5e-324)>>>0,buf,pos+off0),writeUint((sign<<31|mantissa/4294967296)>>>0,buf,pos+off1);else{var exponent=Math.floor(Math.log(val)/Math.LN2);1024===exponent&&(exponent=1023),writeUint(4503599627370496*(mantissa=val*Math.pow(2,-exponent))>>>0,buf,pos+off0),writeUint((sign<<31|exponent+1023<<20|1048576*mantissa&1048575)>>>0,buf,pos+off1)}}}function readDouble_ieee754(readUint,off0,off1,buf,pos){var lo=readUint(buf,pos+off0),hi=readUint(buf,pos+off1),sign=2*(hi>>31)+1,exponent=hi>>>20&2047,mantissa=4294967296*(1048575&hi)+lo;return 2047===exponent?mantissa?NaN:sign*(1/0):0===exponent?5e-324*sign*mantissa:sign*Math.pow(2,exponent-1075)*(mantissa+4503599627370496)}exports.writeDoubleLE=writeDouble_ieee754.bind(null,writeUintLE,0,4),exports.writeDoubleBE=writeDouble_ieee754.bind(null,writeUintBE,4,0),exports.readDoubleLE=readDouble_ieee754.bind(null,readUintLE,0,4),exports.readDoubleBE=readDouble_ieee754.bind(null,readUintBE,4,0)}(),exports}function writeUintLE(val,buf,pos){buf[pos]=255&val,buf[pos+1]=val>>>8&255,buf[pos+2]=val>>>16&255,buf[pos+3]=val>>>24}function writeUintBE(val,buf,pos){buf[pos]=val>>>24,buf[pos+1]=val>>>16&255,buf[pos+2]=val>>>8&255,buf[pos+3]=255&val}function readUintLE(buf,pos){return(buf[pos]|buf[pos+1]<<8|buf[pos+2]<<16|buf[pos+3]<<24)>>>0}function readUintBE(buf,pos){return(buf[pos]<<24|buf[pos+1]<<16|buf[pos+2]<<8|buf[pos+3])>>>0}module.exports=factory(factory)},LZp6:function(module,exports,__webpack_require__){"use strict";var path=exports,isAbsolute=path.isAbsolute=function isAbsolute(path){return/^(?:\/|\w+:)/.test(path)},normalize=path.normalize=function normalize(path){var parts=(path=path.replace(/\\/g,"/").replace(/\/{2,}/g,"/")).split("/"),absolute=isAbsolute(path),prefix="";absolute&&(prefix=parts.shift()+"/");for(var i=0;i<parts.length;)".."===parts[i]?i>0&&".."!==parts[i-1]?parts.splice(--i,2):absolute?parts.splice(i,1):++i:"."===parts[i]?parts.splice(i,1):++i;return prefix+parts.join("/")};path.resolve=function resolve(originPath,includePath,alreadyNormalized){return alreadyNormalized||(includePath=normalize(includePath)),isAbsolute(includePath)?includePath:(alreadyNormalized||(originPath=normalize(originPath)),(originPath=originPath.replace(/(?:\/|^)[^/]+$/,"")).length?normalize(originPath+"/"+includePath):includePath)}},MFts:function(module,exports,__webpack_require__){"use strict";module.exports=function asPromise(fn,ctx){var params=new Array(arguments.length-1),offset=0,index=2,pending=!0;for(;index<arguments.length;)params[offset++]=arguments[index++];return new Promise(function executor(resolve,reject){params[offset]=function callback(err){if(pending)if(pending=!1,err)reject(err);else{for(var params=new Array(arguments.length-1),offset=0;offset<params.length;)params[offset++]=arguments[offset];resolve.apply(null,params)}};try{fn.apply(ctx||null,params)}catch(err){pending&&(pending=!1,reject(err))}})}},Mkf5:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.extractAndSelectServiceConfig=exports.validateServiceConfig=void 0;const os=__webpack_require__("jle/"),load_balancer_1=__webpack_require__("JG2R"),TIMEOUT_REGEX=/^\d+(\.\d{1,9})?s$/;function validateName(obj){if(!("service"in obj)||"string"!=typeof obj.service)throw new Error("Invalid method config name: invalid service");const result={service:obj.service};if("method"in obj){if("string"!=typeof obj.method)throw new Error("Invalid method config name: invalid method");result.method=obj.method}return result}function validateMethodConfig(obj){const result={name:[]};if(!("name"in obj)||!Array.isArray(obj.name))throw new Error("Invalid method config: invalid name array");for(const name of obj.name)result.name.push(validateName(name));if("waitForReady"in obj){if("boolean"!=typeof obj.waitForReady)throw new Error("Invalid method config: invalid waitForReady");result.waitForReady=obj.waitForReady}if("timeout"in obj){if("string"!=typeof obj.timeout||!TIMEOUT_REGEX.test(obj.timeout))throw new Error("Invalid method config: invalid timeout");result.timeout=obj.timeout}if("maxRequestBytes"in obj){if("number"!=typeof obj.maxRequestBytes)throw new Error("Invalid method config: invalid maxRequestBytes");result.maxRequestBytes=obj.maxRequestBytes}if("maxResponseBytes"in obj){if("number"!=typeof obj.maxResponseBytes)throw new Error("Invalid method config: invalid maxRequestBytes");result.maxResponseBytes=obj.maxResponseBytes}return result}function validateServiceConfig(obj){const result={loadBalancingConfig:[],methodConfig:[]};if("loadBalancingPolicy"in obj){if("string"!=typeof obj.loadBalancingPolicy)throw new Error("Invalid service config: invalid loadBalancingPolicy");result.loadBalancingPolicy=obj.loadBalancingPolicy}if("loadBalancingConfig"in obj){if(!Array.isArray(obj.loadBalancingConfig))throw new Error("Invalid service config: invalid loadBalancingConfig");for(const config of obj.loadBalancingConfig)result.loadBalancingConfig.push(load_balancer_1.validateLoadBalancingConfig(config))}if("methodConfig"in obj&&Array.isArray(obj.methodConfig))for(const methodConfig of obj.methodConfig)result.methodConfig.push(validateMethodConfig(methodConfig));const seenMethodNames=[];for(const methodConfig of result.methodConfig)for(const name of methodConfig.name){for(const seenName of seenMethodNames)if(name.service===seenName.service&&name.method===seenName.method)throw new Error(`Invalid service config: duplicate name ${name.service}/${name.method}`);seenMethodNames.push(name)}return result}function validateCanaryConfig(obj){if(!("serviceConfig"in obj))throw new Error("Invalid service config choice: missing service config");const result={serviceConfig:validateServiceConfig(obj.serviceConfig)};if("clientLanguage"in obj){if(!Array.isArray(obj.clientLanguage))throw new Error("Invalid service config choice: invalid clientLanguage");result.clientLanguage=[];for(const lang of obj.clientLanguage){if("string"!=typeof lang)throw new Error("Invalid service config choice: invalid clientLanguage");result.clientLanguage.push(lang)}}if("clientHostname"in obj){if(!Array.isArray(obj.clientHostname))throw new Error("Invalid service config choice: invalid clientHostname");result.clientHostname=[];for(const lang of obj.clientHostname){if("string"!=typeof lang)throw new Error("Invalid service config choice: invalid clientHostname");result.clientHostname.push(lang)}}if("percentage"in obj){if(!("number"==typeof obj.percentage&&0<=obj.percentage&&obj.percentage<=100))throw new Error("Invalid service config choice: invalid percentage");result.percentage=obj.percentage}const allowedFields=["clientLanguage","percentage","clientHostname","serviceConfig"];for(const field in obj)if(!allowedFields.includes(field))throw new Error(`Invalid service config choice: unexpected field ${field}`);return result}function validateAndSelectCanaryConfig(obj,percentage){if(!Array.isArray(obj))throw new Error("Invalid service config list");for(const config of obj){const validatedConfig=validateCanaryConfig(config);if(!("number"==typeof validatedConfig.percentage&&percentage>validatedConfig.percentage)){if(Array.isArray(validatedConfig.clientHostname)){let hostnameMatched=!1;for(const hostname of validatedConfig.clientHostname)hostname===os.hostname()&&(hostnameMatched=!0);if(!hostnameMatched)continue}if(Array.isArray(validatedConfig.clientLanguage)){let languageMatched=!1;for(const language of validatedConfig.clientLanguage)"node"===language&&(languageMatched=!0);if(!languageMatched)continue}return validatedConfig.serviceConfig}}throw new Error("No matching service config found")}exports.validateServiceConfig=validateServiceConfig,exports.extractAndSelectServiceConfig=function extractAndSelectServiceConfig(txtRecord,percentage){for(const record of txtRecord)if(record.length>0&&record[0].startsWith("grpc_config=")){const recordString=record.join("").substring("grpc_config=".length);return validateAndSelectCanaryConfig(JSON.parse(recordString),percentage)}return null}},Nr3n:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CompressionFilterFactory=exports.CompressionFilter=void 0;const zlib=__webpack_require__("FMKJ"),filter_1=__webpack_require__("nC4N");class CompressionHandler{async writeMessage(message,compress){let messageBuffer=message;compress&&(messageBuffer=await this.compressMessage(messageBuffer));const output=Buffer.allocUnsafe(messageBuffer.length+5);return output.writeUInt8(compress?1:0,0),output.writeUInt32BE(messageBuffer.length,1),messageBuffer.copy(output,5),output}async readMessage(data){const compressed=1===data.readUInt8(0);let messageBuffer=data.slice(5);return compressed&&(messageBuffer=await this.decompressMessage(messageBuffer)),messageBuffer}}class IdentityHandler extends CompressionHandler{async compressMessage(message){return message}async writeMessage(message,compress){const output=Buffer.allocUnsafe(message.length+5);return output.writeUInt8(0,0),output.writeUInt32BE(message.length,1),message.copy(output,5),output}decompressMessage(message){return Promise.reject(new Error('Received compressed message but "grpc-encoding" header was identity'))}}class DeflateHandler extends CompressionHandler{compressMessage(message){return new Promise((resolve,reject)=>{zlib.deflate(message,(err,output)=>{err?reject(err):resolve(output)})})}decompressMessage(message){return new Promise((resolve,reject)=>{zlib.inflate(message,(err,output)=>{err?reject(err):resolve(output)})})}}class GzipHandler extends CompressionHandler{compressMessage(message){return new Promise((resolve,reject)=>{zlib.gzip(message,(err,output)=>{err?reject(err):resolve(output)})})}decompressMessage(message){return new Promise((resolve,reject)=>{zlib.unzip(message,(err,output)=>{err?reject(err):resolve(output)})})}}class UnknownHandler extends CompressionHandler{constructor(compressionName){super(),this.compressionName=compressionName}compressMessage(message){return Promise.reject(new Error(`Received message compressed with unsupported compression method ${this.compressionName}`))}decompressMessage(message){return Promise.reject(new Error(`Compression method not supported: ${this.compressionName}`))}}class CompressionFilter extends filter_1.BaseFilter{constructor(){super(...arguments),this.sendCompression=new IdentityHandler,this.receiveCompression=new IdentityHandler}async sendMetadata(metadata){const headers=await metadata;return headers.set("grpc-accept-encoding","identity,deflate,gzip"),headers.set("accept-encoding","identity"),headers}receiveMetadata(metadata){const receiveEncoding=metadata.get("grpc-encoding");if(receiveEncoding.length>0){const encoding=receiveEncoding[0];"string"==typeof encoding&&(this.receiveCompression=function getCompressionHandler(compressionName){switch(compressionName){case"identity":return new IdentityHandler;case"deflate":return new DeflateHandler;case"gzip":return new GzipHandler;default:return new UnknownHandler(compressionName)}}(encoding))}return metadata.remove("grpc-encoding"),metadata.remove("grpc-accept-encoding"),metadata}async sendMessage(message){const resolvedMessage=await message,compress=void 0!==resolvedMessage.flags&&0==(2&resolvedMessage.flags);return{message:await this.sendCompression.writeMessage(resolvedMessage.message,compress),flags:resolvedMessage.flags}}async receiveMessage(message){return this.receiveCompression.readMessage(await message)}}exports.CompressionFilter=CompressionFilter;exports.CompressionFilterFactory=class{constructor(channel){this.channel=channel}createFilter(callStream){return new CompressionFilter}}},NzeB:function(module,exports,__webpack_require__){"use strict";var protobuf=module.exports=__webpack_require__("Bx+5");protobuf.build="full",protobuf.tokenize=__webpack_require__("p2ao"),protobuf.parse=__webpack_require__("Vh32"),protobuf.common=__webpack_require__("oA4V"),protobuf.Root._configure(protobuf.Type,protobuf.parse,protobuf.common)},PFer:function(module,exports,__webpack_require__){"use strict";var $protobuf=__webpack_require__("+hx4");module.exports=exports=$protobuf.descriptor=$protobuf.Root.fromJSON(__webpack_require__("3cR/")).lookup(".google.protobuf");var Namespace=$protobuf.Namespace,Root=$protobuf.Root,Enum=$protobuf.Enum,Type=$protobuf.Type,Field=$protobuf.Field,MapField=$protobuf.MapField,OneOf=$protobuf.OneOf,Service=$protobuf.Service,Method=$protobuf.Method;function Root_toDescriptorRecursive(ns,files,syntax){var file=exports.FileDescriptorProto.create({name:ns.filename||(ns.fullName.substring(1).replace(/\./g,"_")||"root")+".proto"});syntax&&(file.syntax=syntax),ns instanceof Root||(file.package=ns.fullName.substring(1));for(var nested,i=0;i<ns.nestedArray.length;++i)(nested=ns._nestedArray[i])instanceof Type?file.messageType.push(nested.toDescriptor(syntax)):nested instanceof Enum?file.enumType.push(nested.toDescriptor()):nested instanceof Field?file.extension.push(nested.toDescriptor(syntax)):nested instanceof Service?file.service.push(nested.toDescriptor()):nested instanceof Namespace&&Root_toDescriptorRecursive(nested,files,syntax);file.options=toDescriptorOptions(ns.options,exports.FileOptions),file.messageType.length+file.enumType.length+file.extension.length+file.service.length&&files.push(file)}Root.fromDescriptor=function fromDescriptor(descriptor){"number"==typeof descriptor.length&&(descriptor=exports.FileDescriptorSet.decode(descriptor));var root=new Root;if(descriptor.file)for(var fileDescriptor,filePackage,i,j=0;j<descriptor.file.length;++j){if(filePackage=root,(fileDescriptor=descriptor.file[j]).package&&fileDescriptor.package.length&&(filePackage=root.define(fileDescriptor.package)),fileDescriptor.name&&fileDescriptor.name.length&&root.files.push(filePackage.filename=fileDescriptor.name),fileDescriptor.messageType)for(i=0;i<fileDescriptor.messageType.length;++i)filePackage.add(Type.fromDescriptor(fileDescriptor.messageType[i],fileDescriptor.syntax));if(fileDescriptor.enumType)for(i=0;i<fileDescriptor.enumType.length;++i)filePackage.add(Enum.fromDescriptor(fileDescriptor.enumType[i]));if(fileDescriptor.extension)for(i=0;i<fileDescriptor.extension.length;++i)filePackage.add(Field.fromDescriptor(fileDescriptor.extension[i]));if(fileDescriptor.service)for(i=0;i<fileDescriptor.service.length;++i)filePackage.add(Service.fromDescriptor(fileDescriptor.service[i]));var opts=fromDescriptorOptions(fileDescriptor.options,exports.FileOptions);if(opts){var ks=Object.keys(opts);for(i=0;i<ks.length;++i)filePackage.setOption(ks[i],opts[ks[i]])}}return root},Root.prototype.toDescriptor=function toDescriptor(syntax){var set=exports.FileDescriptorSet.create();return Root_toDescriptorRecursive(this,set.file,syntax),set};var unnamedMessageIndex=0;Type.fromDescriptor=function fromDescriptor(descriptor,syntax){"number"==typeof descriptor.length&&(descriptor=exports.DescriptorProto.decode(descriptor));var i,type=new Type(descriptor.name.length?descriptor.name:"Type"+unnamedMessageIndex++,fromDescriptorOptions(descriptor.options,exports.MessageOptions));if(descriptor.oneofDecl)for(i=0;i<descriptor.oneofDecl.length;++i)type.add(OneOf.fromDescriptor(descriptor.oneofDecl[i]));if(descriptor.field)for(i=0;i<descriptor.field.length;++i){var field=Field.fromDescriptor(descriptor.field[i],syntax);type.add(field),descriptor.field[i].hasOwnProperty("oneofIndex")&&type.oneofsArray[descriptor.field[i].oneofIndex].add(field)}if(descriptor.extension)for(i=0;i<descriptor.extension.length;++i)type.add(Field.fromDescriptor(descriptor.extension[i],syntax));if(descriptor.nestedType)for(i=0;i<descriptor.nestedType.length;++i)type.add(Type.fromDescriptor(descriptor.nestedType[i],syntax)),descriptor.nestedType[i].options&&descriptor.nestedType[i].options.mapEntry&&type.setOption("map_entry",!0);if(descriptor.enumType)for(i=0;i<descriptor.enumType.length;++i)type.add(Enum.fromDescriptor(descriptor.enumType[i]));if(descriptor.extensionRange&&descriptor.extensionRange.length)for(type.extensions=[],i=0;i<descriptor.extensionRange.length;++i)type.extensions.push([descriptor.extensionRange[i].start,descriptor.extensionRange[i].end]);if(descriptor.reservedRange&&descriptor.reservedRange.length||descriptor.reservedName&&descriptor.reservedName.length){if(type.reserved=[],descriptor.reservedRange)for(i=0;i<descriptor.reservedRange.length;++i)type.reserved.push([descriptor.reservedRange[i].start,descriptor.reservedRange[i].end]);if(descriptor.reservedName)for(i=0;i<descriptor.reservedName.length;++i)type.reserved.push(descriptor.reservedName[i])}return type},Type.prototype.toDescriptor=function toDescriptor(syntax){var i,descriptor=exports.DescriptorProto.create({name:this.name});for(i=0;i<this.fieldsArray.length;++i){var fieldDescriptor;if(descriptor.field.push(fieldDescriptor=this._fieldsArray[i].toDescriptor(syntax)),this._fieldsArray[i]instanceof MapField){var keyType=toDescriptorType(this._fieldsArray[i].keyType,this._fieldsArray[i].resolvedKeyType),valueType=toDescriptorType(this._fieldsArray[i].type,this._fieldsArray[i].resolvedType),valueTypeName=11===valueType||14===valueType?this._fieldsArray[i].resolvedType&&shortname(this.parent,this._fieldsArray[i].resolvedType)||this._fieldsArray[i].type:void 0;descriptor.nestedType.push(exports.DescriptorProto.create({name:fieldDescriptor.typeName,field:[exports.FieldDescriptorProto.create({name:"key",number:1,label:1,type:keyType}),exports.FieldDescriptorProto.create({name:"value",number:2,label:1,type:valueType,typeName:valueTypeName})],options:exports.MessageOptions.create({mapEntry:!0})}))}}for(i=0;i<this.oneofsArray.length;++i)descriptor.oneofDecl.push(this._oneofsArray[i].toDescriptor());for(i=0;i<this.nestedArray.length;++i)this._nestedArray[i]instanceof Field?descriptor.field.push(this._nestedArray[i].toDescriptor(syntax)):this._nestedArray[i]instanceof Type?descriptor.nestedType.push(this._nestedArray[i].toDescriptor(syntax)):this._nestedArray[i]instanceof Enum&&descriptor.enumType.push(this._nestedArray[i].toDescriptor());if(this.extensions)for(i=0;i<this.extensions.length;++i)descriptor.extensionRange.push(exports.DescriptorProto.ExtensionRange.create({start:this.extensions[i][0],end:this.extensions[i][1]}));if(this.reserved)for(i=0;i<this.reserved.length;++i)"string"==typeof this.reserved[i]?descriptor.reservedName.push(this.reserved[i]):descriptor.reservedRange.push(exports.DescriptorProto.ReservedRange.create({start:this.reserved[i][0],end:this.reserved[i][1]}));return descriptor.options=toDescriptorOptions(this.options,exports.MessageOptions),descriptor};var numberRe=/^(?![eE])[0-9]*(?:\.[0-9]*)?(?:[eE][+-]?[0-9]+)?$/;Field.fromDescriptor=function fromDescriptor(descriptor,syntax){if("number"==typeof descriptor.length&&(descriptor=exports.DescriptorProto.decode(descriptor)),"number"!=typeof descriptor.number)throw Error("missing field id");var fieldType,fieldRule;switch(fieldType=descriptor.typeName&&descriptor.typeName.length?descriptor.typeName:function fromDescriptorType(type){switch(type){case 1:return"double";case 2:return"float";case 3:return"int64";case 4:return"uint64";case 5:return"int32";case 6:return"fixed64";case 7:return"fixed32";case 8:return"bool";case 9:return"string";case 12:return"bytes";case 13:return"uint32";case 15:return"sfixed32";case 16:return"sfixed64";case 17:return"sint32";case 18:return"sint64"}throw Error("illegal type: "+type)}(descriptor.type),descriptor.label){case 1:fieldRule=void 0;break;case 2:fieldRule="required";break;case 3:fieldRule="repeated";break;default:throw Error("illegal label: "+descriptor.label)}var extendee=descriptor.extendee;void 0!==descriptor.extendee&&(extendee=extendee.length?extendee:void 0);var field=new Field(descriptor.name.length?descriptor.name:"field"+descriptor.number,descriptor.number,fieldType,fieldRule,extendee);if(field.options=fromDescriptorOptions(descriptor.options,exports.FieldOptions),descriptor.defaultValue&&descriptor.defaultValue.length){var defaultValue=descriptor.defaultValue;switch(defaultValue){case"true":case"TRUE":defaultValue=!0;break;case"false":case"FALSE":defaultValue=!1;break;default:numberRe.exec(defaultValue)&&(defaultValue=parseInt(defaultValue))}field.setOption("default",defaultValue)}return function packableDescriptorType(type){switch(type){case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 13:case 14:case 15:case 16:case 17:case 18:return!0}return!1}(descriptor.type)&&("proto3"===syntax?descriptor.options&&!descriptor.options.packed&&field.setOption("packed",!1):descriptor.options&&descriptor.options.packed||field.setOption("packed",!1)),field},Field.prototype.toDescriptor=function toDescriptor(syntax){var descriptor=exports.FieldDescriptorProto.create({name:this.name,number:this.id});if(this.map)descriptor.type=11,descriptor.typeName=$protobuf.util.ucFirst(this.name),descriptor.label=3;else{switch(descriptor.type=toDescriptorType(this.type,this.resolve().resolvedType)){case 10:case 11:case 14:descriptor.typeName=this.resolvedType?shortname(this.parent,this.resolvedType):this.type}switch(this.rule){case"repeated":descriptor.label=3;break;case"required":descriptor.label=2;break;default:descriptor.label=1}}if(descriptor.extendee=this.extensionField?this.extensionField.parent.fullName:this.extend,this.partOf&&(descriptor.oneofIndex=this.parent.oneofsArray.indexOf(this.partOf))<0)throw Error("missing oneof");return this.options&&(descriptor.options=toDescriptorOptions(this.options,exports.FieldOptions),null!=this.options.default&&(descriptor.defaultValue=String(this.options.default))),"proto3"===syntax?this.packed||((descriptor.options||(descriptor.options=exports.FieldOptions.create())).packed=!1):this.packed&&((descriptor.options||(descriptor.options=exports.FieldOptions.create())).packed=!0),descriptor};var unnamedEnumIndex=0;Enum.fromDescriptor=function fromDescriptor(descriptor){"number"==typeof descriptor.length&&(descriptor=exports.EnumDescriptorProto.decode(descriptor));var values={};if(descriptor.value)for(var i=0;i<descriptor.value.length;++i){var name=descriptor.value[i].name,value=descriptor.value[i].number||0;values[name&&name.length?name:"NAME"+value]=value}return new Enum(descriptor.name&&descriptor.name.length?descriptor.name:"Enum"+unnamedEnumIndex++,values,fromDescriptorOptions(descriptor.options,exports.EnumOptions))},Enum.prototype.toDescriptor=function toDescriptor(){for(var values=[],i=0,ks=Object.keys(this.values);i<ks.length;++i)values.push(exports.EnumValueDescriptorProto.create({name:ks[i],number:this.values[ks[i]]}));return exports.EnumDescriptorProto.create({name:this.name,value:values,options:toDescriptorOptions(this.options,exports.EnumOptions)})};var unnamedOneofIndex=0;OneOf.fromDescriptor=function fromDescriptor(descriptor){return"number"==typeof descriptor.length&&(descriptor=exports.OneofDescriptorProto.decode(descriptor)),new OneOf(descriptor.name&&descriptor.name.length?descriptor.name:"oneof"+unnamedOneofIndex++)},OneOf.prototype.toDescriptor=function toDescriptor(){return exports.OneofDescriptorProto.create({name:this.name})};var unnamedServiceIndex=0;Service.fromDescriptor=function fromDescriptor(descriptor){"number"==typeof descriptor.length&&(descriptor=exports.ServiceDescriptorProto.decode(descriptor));var service=new Service(descriptor.name&&descriptor.name.length?descriptor.name:"Service"+unnamedServiceIndex++,fromDescriptorOptions(descriptor.options,exports.ServiceOptions));if(descriptor.method)for(var i=0;i<descriptor.method.length;++i)service.add(Method.fromDescriptor(descriptor.method[i]));return service},Service.prototype.toDescriptor=function toDescriptor(){for(var methods=[],i=0;i<this.methodsArray.length;++i)methods.push(this._methodsArray[i].toDescriptor());return exports.ServiceDescriptorProto.create({name:this.name,method:methods,options:toDescriptorOptions(this.options,exports.ServiceOptions)})};var unnamedMethodIndex=0;function toDescriptorType(type,resolvedType){switch(type){case"double":return 1;case"float":return 2;case"int64":return 3;case"uint64":return 4;case"int32":return 5;case"fixed64":return 6;case"fixed32":return 7;case"bool":return 8;case"string":return 9;case"bytes":return 12;case"uint32":return 13;case"sfixed32":return 15;case"sfixed64":return 16;case"sint32":return 17;case"sint64":return 18}if(resolvedType instanceof Enum)return 14;if(resolvedType instanceof Type)return resolvedType.group?10:11;throw Error("illegal type: "+type)}function fromDescriptorOptions(options,type){if(options){for(var field,key,val,str,out=[],i=0;i<type.fieldsArray.length;++i)"uninterpretedOption"!==(key=(field=type._fieldsArray[i]).name)&&options.hasOwnProperty(key)&&(val=options[key],field.resolvedType instanceof Enum&&"number"==typeof val&&void 0!==field.resolvedType.valuesById[val]&&(val=field.resolvedType.valuesById[val]),out.push((str=key).substring(0,1)+str.substring(1).replace(/([A-Z])(?=[a-z]|$)/g,function($0,$1){return"_"+$1.toLowerCase()}),val));return out.length?$protobuf.util.toObject(out):void 0}}function toDescriptorOptions(options,type){if(options){for(var key,val,out=[],i=0,ks=Object.keys(options);i<ks.length;++i)if(val=options[key=ks[i]],"default"!==key){var field=type.fields[key];(field||(field=type.fields[key=$protobuf.util.camelCase(key)]))&&out.push(key,val)}return out.length?type.fromObject($protobuf.util.toObject(out)):void 0}}function shortname(from,to){var fromPath=from.fullName.split("."),toPath=to.fullName.split("."),i=0,j=0,k=toPath.length-1;if(!(from instanceof Root)&&to instanceof Namespace)for(;i<fromPath.length&&j<k&&fromPath[i]===toPath[j];){var other=to.lookup(fromPath[i++],!0);if(null!==other&&other!==to)break;++j}else for(;i<fromPath.length&&j<k&&fromPath[i]===toPath[j];++i,++j);return toPath.slice(j).join(".")}Method.fromDescriptor=function fromDescriptor(descriptor){return"number"==typeof descriptor.length&&(descriptor=exports.MethodDescriptorProto.decode(descriptor)),new Method(descriptor.name&&descriptor.name.length?descriptor.name:"Method"+unnamedMethodIndex++,"rpc",descriptor.inputType,descriptor.outputType,Boolean(descriptor.clientStreaming),Boolean(descriptor.serverStreaming),fromDescriptorOptions(descriptor.options,exports.MethodOptions))},Method.prototype.toDescriptor=function toDescriptor(){return exports.MethodDescriptorProto.create({name:this.name,inputType:this.resolvedRequestType?this.resolvedRequestType.fullName:this.requestType,outputType:this.resolvedResponseType?this.resolvedResponseType.fullName:this.responseType,clientStreaming:this.requestStream,serverStreaming:this.responseStream,options:toDescriptorOptions(this.options,exports.MethodOptions)})}},Ta7y:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ClientDuplexStreamImpl=exports.ClientWritableStreamImpl=exports.ClientReadableStreamImpl=exports.ClientUnaryCallImpl=exports.callErrorFromStatus=void 0;const events_1=__webpack_require__("/0p4"),stream_1=__webpack_require__("msIP"),constants_1=__webpack_require__("8o9P");exports.callErrorFromStatus=function callErrorFromStatus(status){const message=`${status.code} ${constants_1.Status[status.code]}: ${status.details}`;return Object.assign(new Error(message),status)};class ClientUnaryCallImpl extends events_1.EventEmitter{constructor(){super()}cancel(){var _a;null===(_a=this.call)||void 0===_a||_a.cancelWithStatus(constants_1.Status.CANCELLED,"Cancelled on client")}getPeer(){var _a,_b;return null!==(_b=null===(_a=this.call)||void 0===_a?void 0:_a.getPeer())&&void 0!==_b?_b:"unknown"}}exports.ClientUnaryCallImpl=ClientUnaryCallImpl;class ClientReadableStreamImpl extends stream_1.Readable{constructor(deserialize){super({objectMode:!0}),this.deserialize=deserialize}cancel(){var _a;null===(_a=this.call)||void 0===_a||_a.cancelWithStatus(constants_1.Status.CANCELLED,"Cancelled on client")}getPeer(){var _a,_b;return null!==(_b=null===(_a=this.call)||void 0===_a?void 0:_a.getPeer())&&void 0!==_b?_b:"unknown"}_read(_size){var _a;null===(_a=this.call)||void 0===_a||_a.startRead()}}exports.ClientReadableStreamImpl=ClientReadableStreamImpl;class ClientWritableStreamImpl extends stream_1.Writable{constructor(serialize){super({objectMode:!0}),this.serialize=serialize}cancel(){var _a;null===(_a=this.call)||void 0===_a||_a.cancelWithStatus(constants_1.Status.CANCELLED,"Cancelled on client")}getPeer(){var _a,_b;return null!==(_b=null===(_a=this.call)||void 0===_a?void 0:_a.getPeer())&&void 0!==_b?_b:"unknown"}_write(chunk,encoding,cb){var _a;const context={callback:cb},flags=Number(encoding);Number.isNaN(flags)||(context.flags=flags),null===(_a=this.call)||void 0===_a||_a.sendMessageWithContext(context,chunk)}_final(cb){var _a;null===(_a=this.call)||void 0===_a||_a.halfClose(),cb()}}exports.ClientWritableStreamImpl=ClientWritableStreamImpl;class ClientDuplexStreamImpl extends stream_1.Duplex{constructor(serialize,deserialize){super({objectMode:!0}),this.serialize=serialize,this.deserialize=deserialize}cancel(){var _a;null===(_a=this.call)||void 0===_a||_a.cancelWithStatus(constants_1.Status.CANCELLED,"Cancelled on client")}getPeer(){var _a,_b;return null!==(_b=null===(_a=this.call)||void 0===_a?void 0:_a.getPeer())&&void 0!==_b?_b:"unknown"}_read(_size){var _a;null===(_a=this.call)||void 0===_a||_a.startRead()}_write(chunk,encoding,cb){var _a;const context={callback:cb},flags=Number(encoding);Number.isNaN(flags)||(context.flags=flags),null===(_a=this.call)||void 0===_a||_a.sendMessageWithContext(context,chunk)}_final(cb){var _a;null===(_a=this.call)||void 0===_a||_a.halfClose(),cb()}}exports.ClientDuplexStreamImpl=ClientDuplexStreamImpl},Vh32:function(module,exports,__webpack_require__){"use strict";module.exports=parse,parse.filename=null,parse.defaults={keepCase:!1};var tokenize=__webpack_require__("p2ao"),Root=__webpack_require__("7m6H"),Type=__webpack_require__("bs9O"),Field=__webpack_require__("pqPr"),MapField=__webpack_require__("guhe"),OneOf=__webpack_require__("d+r3"),Enum=__webpack_require__("vREW"),Service=__webpack_require__("dHTU"),Method=__webpack_require__("B4j6"),types=__webpack_require__("hSTS"),util=__webpack_require__("y9PA"),base10Re=/^[1-9][0-9]*$/,base10NegRe=/^-?[1-9][0-9]*$/,base16Re=/^0[x][0-9a-fA-F]+$/,base16NegRe=/^-?0[x][0-9a-fA-F]+$/,base8Re=/^0[0-7]+$/,base8NegRe=/^-?0[0-7]+$/,numberRe=/^(?![eE])[0-9]*(?:\.[0-9]*)?(?:[eE][+-]?[0-9]+)?$/,nameRe=/^[a-zA-Z_][a-zA-Z_0-9]*$/,typeRefRe=/^(?:\.?[a-zA-Z_][a-zA-Z_0-9]*)(?:\.[a-zA-Z_][a-zA-Z_0-9]*)*$/,fqTypeRefRe=/^(?:\.[a-zA-Z_][a-zA-Z_0-9]*)+$/;function parse(source,root,options){root instanceof Root||(options=root,root=new Root),options||(options=parse.defaults);var pkg,imports,weakImports,syntax,token,preferTrailingComment=options.preferTrailingComment||!1,tn=tokenize(source,options.alternateCommentMode||!1),next=tn.next,push=tn.push,peek=tn.peek,skip=tn.skip,cmnt=tn.cmnt,head=!0,isProto3=!1,ptr=root,applyCase=options.keepCase?function(name){return name}:util.camelCase;function illegal(token,name,insideTryCatch){var filename=parse.filename;return insideTryCatch||(parse.filename=null),Error("illegal "+(name||"token")+" '"+token+"' ("+(filename?filename+", ":"")+"line "+tn.line+")")}function readString(){var token,values=[];do{if('"'!==(token=next())&&"'"!==token)throw illegal(token);values.push(next()),skip(token),token=peek()}while('"'===token||"'"===token);return values.join("")}function readValue(acceptTypeRef){var token=next();switch(token){case"'":case'"':return push(token),readString();case"true":case"TRUE":return!0;case"false":case"FALSE":return!1}try{return function parseNumber(token,insideTryCatch){var sign=1;"-"===token.charAt(0)&&(sign=-1,token=token.substring(1));switch(token){case"inf":case"INF":case"Inf":return sign*(1/0);case"nan":case"NAN":case"Nan":case"NaN":return NaN;case"0":return 0}if(base10Re.test(token))return sign*parseInt(token,10);if(base16Re.test(token))return sign*parseInt(token,16);if(base8Re.test(token))return sign*parseInt(token,8);if(numberRe.test(token))return sign*parseFloat(token);throw illegal(token,"number",insideTryCatch)}(token,!0)}catch(e){if(acceptTypeRef&&typeRefRe.test(token))return token;throw illegal(token,"value")}}function readRanges(target,acceptStrings){var token,start;do{!acceptStrings||'"'!==(token=peek())&&"'"!==token?target.push([start=parseId(next()),skip("to",!0)?parseId(next()):start]):target.push(readString())}while(skip(",",!0));skip(";")}function parseId(token,acceptNegative){switch(token){case"max":case"MAX":case"Max":return 536870911;case"0":return 0}if(!acceptNegative&&"-"===token.charAt(0))throw illegal(token,"id");if(base10NegRe.test(token))return parseInt(token,10);if(base16NegRe.test(token))return parseInt(token,16);if(base8NegRe.test(token))return parseInt(token,8);throw illegal(token,"id")}function parsePackage(){if(void 0!==pkg)throw illegal("package");if(pkg=next(),!typeRefRe.test(pkg))throw illegal(pkg,"name");ptr=ptr.define(pkg),skip(";")}function parseImport(){var whichImports,token=peek();switch(token){case"weak":whichImports=weakImports||(weakImports=[]),next();break;case"public":next();default:whichImports=imports||(imports=[])}token=readString(),skip(";"),whichImports.push(token)}function parseSyntax(){if(skip("="),syntax=readString(),!(isProto3="proto3"===syntax)&&"proto2"!==syntax)throw illegal(syntax,"syntax");skip(";")}function parseCommon(parent,token){switch(token){case"option":return parseOption(parent,token),skip(";"),!0;case"message":return function parseType(parent,token){if(!nameRe.test(token=next()))throw illegal(token,"type name");var type=new Type(token);ifBlock(type,function parseType_block(token){if(!parseCommon(type,token))switch(token){case"map":!function parseMapField(parent){skip("<");var keyType=next();if(void 0===types.mapKey[keyType])throw illegal(keyType,"type");skip(",");var valueType=next();if(!typeRefRe.test(valueType))throw illegal(valueType,"type");skip(">");var name=next();if(!nameRe.test(name))throw illegal(name,"name");skip("=");var field=new MapField(applyCase(name),parseId(next()),keyType,valueType);ifBlock(field,function parseMapField_block(token){if("option"!==token)throw illegal(token);parseOption(field,token),skip(";")},function parseMapField_line(){parseInlineOptions(field)}),parent.add(field)}(type);break;case"required":case"repeated":parseField(type,token);break;case"optional":parseField(type,isProto3?"proto3_optional":"optional");break;case"oneof":!function parseOneOf(parent,token){if(!nameRe.test(token=next()))throw illegal(token,"name");var oneof=new OneOf(applyCase(token));ifBlock(oneof,function parseOneOf_block(token){"option"===token?(parseOption(oneof,token),skip(";")):(push(token),parseField(oneof,"optional"))}),parent.add(oneof)}(type,token);break;case"extensions":readRanges(type.extensions||(type.extensions=[]));break;case"reserved":readRanges(type.reserved||(type.reserved=[]),!0);break;default:if(!isProto3||!typeRefRe.test(token))throw illegal(token);push(token),parseField(type,"optional")}}),parent.add(type)}(parent,token),!0;case"enum":return function parseEnum(parent,token){if(!nameRe.test(token=next()))throw illegal(token,"name");var enm=new Enum(token);ifBlock(enm,function parseEnum_block(token){switch(token){case"option":parseOption(enm,token),skip(";");break;case"reserved":readRanges(enm.reserved||(enm.reserved=[]),!0);break;default:!function parseEnumValue(parent,token){if(!nameRe.test(token))throw illegal(token,"name");skip("=");var value=parseId(next(),!0),dummy={};ifBlock(dummy,function parseEnumValue_block(token){if("option"!==token)throw illegal(token);parseOption(dummy,token),skip(";")},function parseEnumValue_line(){parseInlineOptions(dummy)}),parent.add(token,value,dummy.comment)}(enm,token)}}),parent.add(enm)}(parent,token),!0;case"service":return function parseService(parent,token){if(!nameRe.test(token=next()))throw illegal(token,"service name");var service=new Service(token);ifBlock(service,function parseService_block(token){if(!parseCommon(service,token)){if("rpc"!==token)throw illegal(token);!function parseMethod(parent,token){var commentText=cmnt(),type=token;if(!nameRe.test(token=next()))throw illegal(token,"name");var requestType,requestStream,responseType,responseStream,name=token;skip("("),skip("stream",!0)&&(requestStream=!0);if(!typeRefRe.test(token=next()))throw illegal(token);requestType=token,skip(")"),skip("returns"),skip("("),skip("stream",!0)&&(responseStream=!0);if(!typeRefRe.test(token=next()))throw illegal(token);responseType=token,skip(")");var method=new Method(name,type,requestType,responseType,requestStream,responseStream);method.comment=commentText,ifBlock(method,function parseMethod_block(token){if("option"!==token)throw illegal(token);parseOption(method,token),skip(";")}),parent.add(method)}(service,token)}}),parent.add(service)}(parent,token),!0;case"extend":return function parseExtension(parent,token){if(!typeRefRe.test(token=next()))throw illegal(token,"reference");var reference=token;ifBlock(null,function parseExtension_block(token){switch(token){case"required":case"repeated":parseField(parent,token,reference);break;case"optional":parseField(parent,isProto3?"proto3_optional":"optional",reference);break;default:if(!isProto3||!typeRefRe.test(token))throw illegal(token);push(token),parseField(parent,"optional",reference)}})}(parent,token),!0}return!1}function ifBlock(obj,fnIf,fnElse){var trailingLine=tn.line;if(obj&&("string"!=typeof obj.comment&&(obj.comment=cmnt()),obj.filename=parse.filename),skip("{",!0)){for(var token;"}"!==(token=next());)fnIf(token);skip(";",!0)}else fnElse&&fnElse(),skip(";"),obj&&("string"!=typeof obj.comment||preferTrailingComment)&&(obj.comment=cmnt(trailingLine)||obj.comment)}function parseField(parent,rule,extend){var type=next();if("group"!==type){if(!typeRefRe.test(type))throw illegal(type,"type");var name=next();if(!nameRe.test(name))throw illegal(name,"name");name=applyCase(name),skip("=");var field=new Field(name,parseId(next()),type,rule,extend);if(ifBlock(field,function parseField_block(token){if("option"!==token)throw illegal(token);parseOption(field,token),skip(";")},function parseField_line(){parseInlineOptions(field)}),"proto3_optional"===rule){var oneof=new OneOf("_"+name);field.setOption("proto3_optional",!0),oneof.add(field),parent.add(oneof)}else parent.add(field);isProto3||!field.repeated||void 0===types.packed[type]&&void 0!==types.basic[type]||field.setOption("packed",!1,!0)}else(function parseGroup(parent,rule){var name=next();if(!nameRe.test(name))throw illegal(name,"name");var fieldName=util.lcFirst(name);name===fieldName&&(name=util.ucFirst(name));skip("=");var id=parseId(next()),type=new Type(name);type.group=!0;var field=new Field(fieldName,id,name,rule);field.filename=parse.filename,ifBlock(type,function parseGroup_block(token){switch(token){case"option":parseOption(type,token),skip(";");break;case"required":case"repeated":parseField(type,token);break;case"optional":parseField(type,isProto3?"proto3_optional":"optional");break;default:throw illegal(token)}}),parent.add(type).add(field)})(parent,rule)}function parseOption(parent,token){var isCustom=skip("(",!0);if(!typeRefRe.test(token=next()))throw illegal(token,"name");var propName,name=token,option=name;isCustom&&(skip(")"),option=name="("+name+")",token=peek(),fqTypeRefRe.test(token)&&(propName=token.substr(1),name+=token,next())),skip("="),function setParsedOption(parent,name,value,propName){parent.setParsedOption&&parent.setParsedOption(name,value,propName)}(parent,option,parseOptionValue(parent,name),propName)}function parseOptionValue(parent,name){if(skip("{",!0)){for(var result={};!skip("}",!0);){if(!nameRe.test(token=next()))throw illegal(token,"name");var value,propName=token;"{"===peek()?value=parseOptionValue(parent,name+"."+token):(skip(":"),"{"===peek()?value=parseOptionValue(parent,name+"."+token):(value=readValue(!0),setOption(parent,name+"."+token,value)));var prevValue=result[propName];prevValue&&(value=[].concat(prevValue).concat(value)),result[propName]=value,skip(",",!0)}return result}var simpleValue=readValue(!0);return setOption(parent,name,simpleValue),simpleValue}function setOption(parent,name,value){parent.setOption&&parent.setOption(name,value)}function parseInlineOptions(parent){if(skip("[",!0)){do{parseOption(parent,"option")}while(skip(",",!0));skip("]")}return parent}for(;null!==(token=next());)switch(token){case"package":if(!head)throw illegal(token);parsePackage();break;case"import":if(!head)throw illegal(token);parseImport();break;case"syntax":if(!head)throw illegal(token);parseSyntax();break;case"option":parseOption(ptr,token),skip(";");break;default:if(parseCommon(ptr,token)){head=!1;continue}throw illegal(token)}return parse.filename=null,{package:pkg,imports:imports,weakImports:weakImports,syntax:syntax,root:root}}},YM9t:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.setup=void 0;const net_1=__webpack_require__("Qs2e"),constants_1=__webpack_require__("8o9P"),metadata_1=__webpack_require__("m7sO"),resolver_1=__webpack_require__("9rQR"),uri_parser_1=__webpack_require__("x8Ej"),logging=__webpack_require__("xQiD");function trace(text){logging.trace(constants_1.LogVerbosity.DEBUG,"ip_resolver",text)}class IpResolver{constructor(target,listener,channelOptions){var _a;this.target=target,this.listener=listener,this.addresses=[],this.error=null,trace("Resolver constructed for target "+uri_parser_1.uriToString(target));const addresses=[];if("ipv4"!==target.scheme&&"ipv6"!==target.scheme)return void(this.error={code:constants_1.Status.UNAVAILABLE,details:`Unrecognized scheme ${target.scheme} in IP resolver`,metadata:new metadata_1.Metadata});const pathList=target.path.split(",");for(const path of pathList){const hostPort=uri_parser_1.splitHostPort(path);if(null===hostPort)return void(this.error={code:constants_1.Status.UNAVAILABLE,details:`Failed to parse ${target.scheme} address ${path}`,metadata:new metadata_1.Metadata});if("ipv4"===target.scheme&&!net_1.isIPv4(hostPort.host)||"ipv6"===target.scheme&&!net_1.isIPv6(hostPort.host))return void(this.error={code:constants_1.Status.UNAVAILABLE,details:`Failed to parse ${target.scheme} address ${path}`,metadata:new metadata_1.Metadata});addresses.push({host:hostPort.host,port:null!==(_a=hostPort.port)&&void 0!==_a?_a:443})}this.addresses=addresses,trace("Parsed "+target.scheme+" address list "+this.addresses)}updateResolution(){process.nextTick(()=>{this.error?this.listener.onError(this.error):this.listener.onSuccessfulResolution(this.addresses,null,null,null,{})})}destroy(){}static getDefaultAuthority(target){return target.path.split(",")[0]}}exports.setup=function setup(){resolver_1.registerResolver("ipv4",IpResolver),resolver_1.registerResolver("ipv6",IpResolver)}},Za3E:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.FilterStackFactory=exports.FilterStack=void 0;class FilterStack{constructor(filters){this.filters=filters}sendMetadata(metadata){let result=metadata;for(let i=0;i<this.filters.length;i++)result=this.filters[i].sendMetadata(result);return result}receiveMetadata(metadata){let result=metadata;for(let i=this.filters.length-1;i>=0;i--)result=this.filters[i].receiveMetadata(result);return result}sendMessage(message){let result=message;for(let i=0;i<this.filters.length;i++)result=this.filters[i].sendMessage(result);return result}receiveMessage(message){let result=message;for(let i=this.filters.length-1;i>=0;i--)result=this.filters[i].receiveMessage(result);return result}receiveTrailers(status){let result=status;for(let i=this.filters.length-1;i>=0;i--)result=this.filters[i].receiveTrailers(result);return result}}exports.FilterStack=FilterStack;exports.FilterStackFactory=class{constructor(factories){this.factories=factories}createFilter(callStream){return new FilterStack(this.factories.map(factory=>factory.createFilter(callStream)))}}},aJe0:function(module,exports,__webpack_require__){"use strict";function EventEmitter(){this._listeners={}}module.exports=EventEmitter,EventEmitter.prototype.on=function on(evt,fn,ctx){return(this._listeners[evt]||(this._listeners[evt]=[])).push({fn:fn,ctx:ctx||this}),this},EventEmitter.prototype.off=function off(evt,fn){if(void 0===evt)this._listeners={};else if(void 0===fn)this._listeners[evt]=[];else for(var listeners=this._listeners[evt],i=0;i<listeners.length;)listeners[i].fn===fn?listeners.splice(i,1):++i;return this},EventEmitter.prototype.emit=function emit(evt){var listeners=this._listeners[evt];if(listeners){for(var args=[],i=1;i<arguments.length;)args.push(arguments[i++]);for(i=0;i<listeners.length;)listeners[i].fn.apply(listeners[i++].ctx,args)}return this}},bDA7:function(module,exports,__webpack_require__){"use strict";var protobuf=exports;function configure(){protobuf.util._configure(),protobuf.Writer._configure(protobuf.BufferWriter),protobuf.Reader._configure(protobuf.BufferReader)}protobuf.build="minimal",protobuf.Writer=__webpack_require__("DIMq"),protobuf.BufferWriter=__webpack_require__("3G9Y"),protobuf.Reader=__webpack_require__("IRA2"),protobuf.BufferReader=__webpack_require__("lWSR"),protobuf.util=__webpack_require__("6Tgl"),protobuf.rpc=__webpack_require__("AbGV"),protobuf.roots=__webpack_require__("Bko/"),protobuf.configure=configure,configure()},bQ6e:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ResolvingLoadBalancer=void 0;const load_balancer_1=__webpack_require__("JG2R"),service_config_1=__webpack_require__("Mkf5"),channel_1=__webpack_require__("6XSn"),resolver_1=__webpack_require__("9rQR"),picker_1=__webpack_require__("mVN3"),backoff_timeout_1=__webpack_require__("hc0Y"),constants_1=__webpack_require__("8o9P"),metadata_1=__webpack_require__("m7sO"),logging=__webpack_require__("xQiD"),constants_2=__webpack_require__("8o9P"),uri_parser_1=__webpack_require__("x8Ej"),load_balancer_child_handler_1=__webpack_require__("z8EH");exports.ResolvingLoadBalancer=class{constructor(target,channelControlHelper,channelOptions,onSuccessfulResolution,onFailedResolution){this.target=target,this.channelControlHelper=channelControlHelper,this.channelOptions=channelOptions,this.onSuccessfulResolution=onSuccessfulResolution,this.onFailedResolution=onFailedResolution,this.latestChildState=channel_1.ConnectivityState.IDLE,this.latestChildPicker=new picker_1.QueuePicker(this),this.currentState=channel_1.ConnectivityState.IDLE,this.previousServiceConfig=null,this.continueResolving=!1,channelOptions["grpc.service_config"]?this.defaultServiceConfig=service_config_1.validateServiceConfig(JSON.parse(channelOptions["grpc.service_config"])):this.defaultServiceConfig={loadBalancingConfig:[],methodConfig:[]},this.updateState(channel_1.ConnectivityState.IDLE,new picker_1.QueuePicker(this)),this.childLoadBalancer=new load_balancer_child_handler_1.ChildLoadBalancerHandler({createSubchannel:channelControlHelper.createSubchannel.bind(channelControlHelper),requestReresolution:()=>{this.backoffTimeout.isRunning()?this.continueResolving=!0:this.updateResolution()},updateState:(newState,picker)=>{this.latestChildState=newState,this.latestChildPicker=picker,this.updateState(newState,picker)}}),this.innerResolver=resolver_1.createResolver(target,{onSuccessfulResolution:(addressList,serviceConfig,serviceConfigError,configSelector,attributes)=>{var _a;let workingServiceConfig=null;null===serviceConfig?null===serviceConfigError?(this.previousServiceConfig=null,workingServiceConfig=this.defaultServiceConfig):null===this.previousServiceConfig?this.handleResolutionFailure(serviceConfigError):workingServiceConfig=this.previousServiceConfig:(workingServiceConfig=serviceConfig,this.previousServiceConfig=serviceConfig);const workingConfigList=null!==(_a=null==workingServiceConfig?void 0:workingServiceConfig.loadBalancingConfig)&&void 0!==_a?_a:[],loadBalancingConfig=load_balancer_1.getFirstUsableConfig(workingConfigList,!0);if(null===loadBalancingConfig)return void this.handleResolutionFailure({code:constants_1.Status.UNAVAILABLE,details:"All load balancer options in service config are not compatible",metadata:new metadata_1.Metadata});this.childLoadBalancer.updateAddressList(addressList,loadBalancingConfig,attributes);const finalServiceConfig=null!=workingServiceConfig?workingServiceConfig:this.defaultServiceConfig;this.onSuccessfulResolution(null!=configSelector?configSelector:function getDefaultConfigSelector(serviceConfig){return function defaultConfigSelector(methodName,metadata){var _a,_b;const splitName=methodName.split("/").filter(x=>x.length>0),service=null!==(_a=splitName[0])&&void 0!==_a?_a:"",method=null!==(_b=splitName[1])&&void 0!==_b?_b:"";if(serviceConfig&&serviceConfig.methodConfig)for(const methodConfig of serviceConfig.methodConfig)for(const name of methodConfig.name)if(name.service===service&&(void 0===name.method||name.method===method))return{methodConfig:methodConfig,pickInformation:{},status:constants_1.Status.OK};return{methodConfig:{name:[]},pickInformation:{},status:constants_1.Status.OK}}}(finalServiceConfig))},onError:error=>{this.handleResolutionFailure(error)}},channelOptions),this.backoffTimeout=new backoff_timeout_1.BackoffTimeout(()=>{this.continueResolving?(this.updateResolution(),this.continueResolving=!1):this.updateState(this.latestChildState,this.latestChildPicker)}),this.backoffTimeout.unref()}updateResolution(){this.innerResolver.updateResolution(),this.currentState===channel_1.ConnectivityState.IDLE&&this.updateState(channel_1.ConnectivityState.CONNECTING,new picker_1.QueuePicker(this))}updateState(connectivityState,picker){!function trace(text){logging.trace(constants_2.LogVerbosity.DEBUG,"resolving_load_balancer",text)}(uri_parser_1.uriToString(this.target)+" "+channel_1.ConnectivityState[this.currentState]+" -> "+channel_1.ConnectivityState[connectivityState]),connectivityState===channel_1.ConnectivityState.IDLE&&(picker=new picker_1.QueuePicker(this)),this.currentState=connectivityState,this.channelControlHelper.updateState(connectivityState,picker)}handleResolutionFailure(error){this.latestChildState===channel_1.ConnectivityState.IDLE&&(this.updateState(channel_1.ConnectivityState.TRANSIENT_FAILURE,new picker_1.UnavailablePicker(error)),this.onFailedResolution(error)),this.backoffTimeout.runOnce()}exitIdle(){this.childLoadBalancer.exitIdle(),this.currentState===channel_1.ConnectivityState.IDLE&&(this.backoffTimeout.isRunning()?this.continueResolving=!0:this.updateResolution(),this.updateState(channel_1.ConnectivityState.CONNECTING,new picker_1.QueuePicker(this)))}updateAddressList(addressList,lbConfig){throw new Error("updateAddressList not supported on ResolvingLoadBalancer")}resetBackoff(){this.backoffTimeout.reset(),this.childLoadBalancer.resetBackoff()}destroy(){this.childLoadBalancer.destroy(),this.innerResolver.destroy(),this.updateState(channel_1.ConnectivityState.SHUTDOWN,new picker_1.UnavailablePicker)}getTypeName(){return"resolving_load_balancer"}}},"bnU+":function(module,exports,__webpack_require__){"use strict";var base64=exports;base64.length=function length(string){var p=string.length;if(!p)return 0;for(var n=0;--p%4>1&&"="===string.charAt(p);)++n;return Math.ceil(3*string.length)/4-n};for(var b64=new Array(64),s64=new Array(123),i=0;i<64;)s64[b64[i]=i<26?i+65:i<52?i+71:i<62?i-4:i-59|43]=i++;base64.encode=function encode(buffer,start,end){for(var t,parts=null,chunk=[],i=0,j=0;start<end;){var b=buffer[start++];switch(j){case 0:chunk[i++]=b64[b>>2],t=(3&b)<<4,j=1;break;case 1:chunk[i++]=b64[t|b>>4],t=(15&b)<<2,j=2;break;case 2:chunk[i++]=b64[t|b>>6],chunk[i++]=b64[63&b],j=0}i>8191&&((parts||(parts=[])).push(String.fromCharCode.apply(String,chunk)),i=0)}return j&&(chunk[i++]=b64[t],chunk[i++]=61,1===j&&(chunk[i++]=61)),parts?(i&&parts.push(String.fromCharCode.apply(String,chunk.slice(0,i))),parts.join("")):String.fromCharCode.apply(String,chunk.slice(0,i))};base64.decode=function decode(string,buffer,offset){for(var t,start=offset,j=0,i=0;i<string.length;){var c=string.charCodeAt(i++);if(61===c&&j>1)break;if(void 0===(c=s64[c]))throw Error("invalid encoding");switch(j){case 0:t=c,j=1;break;case 1:buffer[offset++]=t<<2|(48&c)>>4,t=c,j=2;break;case 2:buffer[offset++]=(15&t)<<4|(60&c)>>2,t=c,j=3;break;case 3:buffer[offset++]=(3&t)<<6|c,j=0}}if(1===j)throw Error("invalid encoding");return offset-start},base64.test=function test(string){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(string)}},bs9O:function(module,exports,__webpack_require__){"use strict";module.exports=Type;var Namespace=__webpack_require__("fgco");((Type.prototype=Object.create(Namespace.prototype)).constructor=Type).className="Type";var Enum=__webpack_require__("vREW"),OneOf=__webpack_require__("d+r3"),Field=__webpack_require__("pqPr"),MapField=__webpack_require__("guhe"),Service=__webpack_require__("dHTU"),Message=__webpack_require__("G8sG"),Reader=__webpack_require__("IRA2"),Writer=__webpack_require__("DIMq"),util=__webpack_require__("y9PA"),encoder=__webpack_require__("dqsW"),decoder=__webpack_require__("3Xxg"),verifier=__webpack_require__("KlcT"),converter=__webpack_require__("BWhg"),wrappers=__webpack_require__("9BLw");function Type(name,options){Namespace.call(this,name,options),this.fields={},this.oneofs=void 0,this.extensions=void 0,this.reserved=void 0,this.group=void 0,this._fieldsById=null,this._fieldsArray=null,this._oneofsArray=null,this._ctor=null}function clearCache(type){return type._fieldsById=type._fieldsArray=type._oneofsArray=null,delete type.encode,delete type.decode,delete type.verify,type}Object.defineProperties(Type.prototype,{fieldsById:{get:function(){if(this._fieldsById)return this._fieldsById;this._fieldsById={};for(var names=Object.keys(this.fields),i=0;i<names.length;++i){var field=this.fields[names[i]],id=field.id;if(this._fieldsById[id])throw Error("duplicate id "+id+" in "+this);this._fieldsById[id]=field}return this._fieldsById}},fieldsArray:{get:function(){return this._fieldsArray||(this._fieldsArray=util.toArray(this.fields))}},oneofsArray:{get:function(){return this._oneofsArray||(this._oneofsArray=util.toArray(this.oneofs))}},ctor:{get:function(){return this._ctor||(this.ctor=Type.generateConstructor(this)())},set:function(ctor){var prototype=ctor.prototype;prototype instanceof Message||((ctor.prototype=new Message).constructor=ctor,util.merge(ctor.prototype,prototype)),ctor.$type=ctor.prototype.$type=this,util.merge(ctor,Message,!0),this._ctor=ctor;for(var i=0;i<this.fieldsArray.length;++i)this._fieldsArray[i].resolve();var ctorProperties={};for(i=0;i<this.oneofsArray.length;++i)ctorProperties[this._oneofsArray[i].resolve().name]={get:util.oneOfGetter(this._oneofsArray[i].oneof),set:util.oneOfSetter(this._oneofsArray[i].oneof)};i&&Object.defineProperties(ctor.prototype,ctorProperties)}}}),Type.generateConstructor=function generateConstructor(mtype){for(var field,gen=util.codegen(["p"],mtype.name),i=0;i<mtype.fieldsArray.length;++i)(field=mtype._fieldsArray[i]).map?gen("this%s={}",util.safeProp(field.name)):field.repeated&&gen("this%s=[]",util.safeProp(field.name));return gen("if(p)for(var ks=Object.keys(p),i=0;i<ks.length;++i)if(p[ks[i]]!=null)")("this[ks[i]]=p[ks[i]]")},Type.fromJSON=function fromJSON(name,json){var type=new Type(name,json.options);type.extensions=json.extensions,type.reserved=json.reserved;for(var names=Object.keys(json.fields),i=0;i<names.length;++i)type.add((void 0!==json.fields[names[i]].keyType?MapField.fromJSON:Field.fromJSON)(names[i],json.fields[names[i]]));if(json.oneofs)for(names=Object.keys(json.oneofs),i=0;i<names.length;++i)type.add(OneOf.fromJSON(names[i],json.oneofs[names[i]]));if(json.nested)for(names=Object.keys(json.nested),i=0;i<names.length;++i){var nested=json.nested[names[i]];type.add((void 0!==nested.id?Field.fromJSON:void 0!==nested.fields?Type.fromJSON:void 0!==nested.values?Enum.fromJSON:void 0!==nested.methods?Service.fromJSON:Namespace.fromJSON)(names[i],nested))}return json.extensions&&json.extensions.length&&(type.extensions=json.extensions),json.reserved&&json.reserved.length&&(type.reserved=json.reserved),json.group&&(type.group=!0),json.comment&&(type.comment=json.comment),type},Type.prototype.toJSON=function toJSON(toJSONOptions){var inherited=Namespace.prototype.toJSON.call(this,toJSONOptions),keepComments=!!toJSONOptions&&Boolean(toJSONOptions.keepComments);return util.toObject(["options",inherited&&inherited.options||void 0,"oneofs",Namespace.arrayToJSON(this.oneofsArray,toJSONOptions),"fields",Namespace.arrayToJSON(this.fieldsArray.filter(function(obj){return!obj.declaringField}),toJSONOptions)||{},"extensions",this.extensions&&this.extensions.length?this.extensions:void 0,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"group",this.group||void 0,"nested",inherited&&inherited.nested||void 0,"comment",keepComments?this.comment:void 0])},Type.prototype.resolveAll=function resolveAll(){for(var fields=this.fieldsArray,i=0;i<fields.length;)fields[i++].resolve();var oneofs=this.oneofsArray;for(i=0;i<oneofs.length;)oneofs[i++].resolve();return Namespace.prototype.resolveAll.call(this)},Type.prototype.get=function get(name){return this.fields[name]||this.oneofs&&this.oneofs[name]||this.nested&&this.nested[name]||null},Type.prototype.add=function add(object){if(this.get(object.name))throw Error("duplicate name '"+object.name+"' in "+this);if(object instanceof Field&&void 0===object.extend){if(this._fieldsById?this._fieldsById[object.id]:this.fieldsById[object.id])throw Error("duplicate id "+object.id+" in "+this);if(this.isReservedId(object.id))throw Error("id "+object.id+" is reserved in "+this);if(this.isReservedName(object.name))throw Error("name '"+object.name+"' is reserved in "+this);return object.parent&&object.parent.remove(object),this.fields[object.name]=object,object.message=this,object.onAdd(this),clearCache(this)}return object instanceof OneOf?(this.oneofs||(this.oneofs={}),this.oneofs[object.name]=object,object.onAdd(this),clearCache(this)):Namespace.prototype.add.call(this,object)},Type.prototype.remove=function remove(object){if(object instanceof Field&&void 0===object.extend){if(!this.fields||this.fields[object.name]!==object)throw Error(object+" is not a member of "+this);return delete this.fields[object.name],object.parent=null,object.onRemove(this),clearCache(this)}if(object instanceof OneOf){if(!this.oneofs||this.oneofs[object.name]!==object)throw Error(object+" is not a member of "+this);return delete this.oneofs[object.name],object.parent=null,object.onRemove(this),clearCache(this)}return Namespace.prototype.remove.call(this,object)},Type.prototype.isReservedId=function isReservedId(id){return Namespace.isReservedId(this.reserved,id)},Type.prototype.isReservedName=function isReservedName(name){return Namespace.isReservedName(this.reserved,name)},Type.prototype.create=function create(properties){return new this.ctor(properties)},Type.prototype.setup=function setup(){for(var fullName=this.fullName,types=[],i=0;i<this.fieldsArray.length;++i)types.push(this._fieldsArray[i].resolve().resolvedType);this.encode=encoder(this)({Writer:Writer,types:types,util:util}),this.decode=decoder(this)({Reader:Reader,types:types,util:util}),this.verify=verifier(this)({types:types,util:util}),this.fromObject=converter.fromObject(this)({types:types,util:util}),this.toObject=converter.toObject(this)({types:types,util:util});var wrapper=wrappers[fullName];if(wrapper){var originalThis=Object.create(this);originalThis.fromObject=this.fromObject,this.fromObject=wrapper.fromObject.bind(originalThis),originalThis.toObject=this.toObject,this.toObject=wrapper.toObject.bind(originalThis)}return this},Type.prototype.encode=function encode_setup(message,writer){return this.setup().encode(message,writer)},Type.prototype.encodeDelimited=function encodeDelimited(message,writer){return this.encode(message,writer&&writer.len?writer.fork():writer).ldelim()},Type.prototype.decode=function decode_setup(reader,length){return this.setup().decode(reader,length)},Type.prototype.decodeDelimited=function decodeDelimited(reader){return reader instanceof Reader||(reader=Reader.create(reader)),this.decode(reader,reader.uint32())},Type.prototype.verify=function verify_setup(message){return this.setup().verify(message)},Type.prototype.fromObject=function fromObject(object){return this.setup().fromObject(object)},Type.prototype.toObject=function toObject(message,options){return this.setup().toObject(message,options)},Type.d=function decorateType(typeName){return function typeDecorator(target){util.decorateType(target,typeName)}}},"c/ta":function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.StatusBuilder=void 0;exports.StatusBuilder=class{constructor(){this.code=null,this.details=null,this.metadata=null}withCode(code){return this.code=code,this}withDetails(details){return this.details=details,this}withMetadata(metadata){return this.metadata=metadata,this}build(){const status={};return null!==this.code&&(status.code=this.code),null!==this.details&&(status.details=this.details),null!==this.metadata&&(status.metadata=this.metadata),status}}},"d+r3":function(module,exports,__webpack_require__){"use strict";module.exports=OneOf;var ReflectionObject=__webpack_require__("iuWj");((OneOf.prototype=Object.create(ReflectionObject.prototype)).constructor=OneOf).className="OneOf";var Field=__webpack_require__("pqPr"),util=__webpack_require__("y9PA");function OneOf(name,fieldNames,options,comment){if(Array.isArray(fieldNames)||(options=fieldNames,fieldNames=void 0),ReflectionObject.call(this,name,options),void 0!==fieldNames&&!Array.isArray(fieldNames))throw TypeError("fieldNames must be an Array");this.oneof=fieldNames||[],this.fieldsArray=[],this.comment=comment}function addFieldsToParent(oneof){if(oneof.parent)for(var i=0;i<oneof.fieldsArray.length;++i)oneof.fieldsArray[i].parent||oneof.parent.add(oneof.fieldsArray[i])}OneOf.fromJSON=function fromJSON(name,json){return new OneOf(name,json.oneof,json.options,json.comment)},OneOf.prototype.toJSON=function toJSON(toJSONOptions){var keepComments=!!toJSONOptions&&Boolean(toJSONOptions.keepComments);return util.toObject(["options",this.options,"oneof",this.oneof,"comment",keepComments?this.comment:void 0])},OneOf.prototype.add=function add(field){if(!(field instanceof Field))throw TypeError("field must be a Field");return field.parent&&field.parent!==this.parent&&field.parent.remove(field),this.oneof.push(field.name),this.fieldsArray.push(field),field.partOf=this,addFieldsToParent(this),this},OneOf.prototype.remove=function remove(field){if(!(field instanceof Field))throw TypeError("field must be a Field");var index=this.fieldsArray.indexOf(field);if(index<0)throw Error(field+" is not a member of "+this);return this.fieldsArray.splice(index,1),(index=this.oneof.indexOf(field.name))>-1&&this.oneof.splice(index,1),field.partOf=null,this},OneOf.prototype.onAdd=function onAdd(parent){ReflectionObject.prototype.onAdd.call(this,parent);for(var i=0;i<this.oneof.length;++i){var field=parent.get(this.oneof[i]);field&&!field.partOf&&(field.partOf=this,this.fieldsArray.push(field))}addFieldsToParent(this)},OneOf.prototype.onRemove=function onRemove(parent){for(var field,i=0;i<this.fieldsArray.length;++i)(field=this.fieldsArray[i]).parent&&field.parent.remove(field);ReflectionObject.prototype.onRemove.call(this,parent)},OneOf.d=function decorateOneOf(){for(var fieldNames=new Array(arguments.length),index=0;index<arguments.length;)fieldNames[index]=arguments[index++];return function oneOfDecorator(prototype,oneofName){util.decorateType(prototype.constructor).add(new OneOf(oneofName,fieldNames)),Object.defineProperty(prototype,oneofName,{get:util.oneOfGetter(fieldNames),set:util.oneOfSetter(fieldNames)})}}},dHTU:function(module,exports,__webpack_require__){"use strict";module.exports=Service;var Namespace=__webpack_require__("fgco");((Service.prototype=Object.create(Namespace.prototype)).constructor=Service).className="Service";var Method=__webpack_require__("B4j6"),util=__webpack_require__("y9PA"),rpc=__webpack_require__("AbGV");function Service(name,options){Namespace.call(this,name,options),this.methods={},this._methodsArray=null}function clearCache(service){return service._methodsArray=null,service}Service.fromJSON=function fromJSON(name,json){var service=new Service(name,json.options);if(json.methods)for(var names=Object.keys(json.methods),i=0;i<names.length;++i)service.add(Method.fromJSON(names[i],json.methods[names[i]]));return json.nested&&service.addJSON(json.nested),service.comment=json.comment,service},Service.prototype.toJSON=function toJSON(toJSONOptions){var inherited=Namespace.prototype.toJSON.call(this,toJSONOptions),keepComments=!!toJSONOptions&&Boolean(toJSONOptions.keepComments);return util.toObject(["options",inherited&&inherited.options||void 0,"methods",Namespace.arrayToJSON(this.methodsArray,toJSONOptions)||{},"nested",inherited&&inherited.nested||void 0,"comment",keepComments?this.comment:void 0])},Object.defineProperty(Service.prototype,"methodsArray",{get:function(){return this._methodsArray||(this._methodsArray=util.toArray(this.methods))}}),Service.prototype.get=function get(name){return this.methods[name]||Namespace.prototype.get.call(this,name)},Service.prototype.resolveAll=function resolveAll(){for(var methods=this.methodsArray,i=0;i<methods.length;++i)methods[i].resolve();return Namespace.prototype.resolve.call(this)},Service.prototype.add=function add(object){if(this.get(object.name))throw Error("duplicate name '"+object.name+"' in "+this);return object instanceof Method?(this.methods[object.name]=object,object.parent=this,clearCache(this)):Namespace.prototype.add.call(this,object)},Service.prototype.remove=function remove(object){if(object instanceof Method){if(this.methods[object.name]!==object)throw Error(object+" is not a member of "+this);return delete this.methods[object.name],object.parent=null,clearCache(this)}return Namespace.prototype.remove.call(this,object)},Service.prototype.create=function create(rpcImpl,requestDelimited,responseDelimited){for(var method,rpcService=new rpc.Service(rpcImpl,requestDelimited,responseDelimited),i=0;i<this.methodsArray.length;++i){var methodName=util.lcFirst((method=this._methodsArray[i]).resolve().name).replace(/[^$\w_]/g,"");rpcService[methodName]=util.codegen(["r","c"],util.isReserved(methodName)?methodName+"_":methodName)("return this.rpcCall(m,q,s,r,c)")({m:method,q:method.resolvedRequestType.ctor,s:method.resolvedResponseType.ctor})}return rpcService}},dqsW:function(module,exports,__webpack_require__){"use strict";module.exports=function encoder(mtype){for(var ref,gen=util.codegen(["m","w"],mtype.name+"$encode")("if(!w)")("w=Writer.create()"),fields=mtype.fieldsArray.slice().sort(util.compareFieldsById),i=0;i<fields.length;++i){var field=fields[i].resolve(),index=mtype._fieldsArray.indexOf(field),type=field.resolvedType instanceof Enum?"int32":field.type,wireType=types.basic[type];ref="m"+util.safeProp(field.name),field.map?(gen("if(%s!=null&&Object.hasOwnProperty.call(m,%j)){",ref,field.name)("for(var ks=Object.keys(%s),i=0;i<ks.length;++i){",ref)("w.uint32(%i).fork().uint32(%i).%s(ks[i])",(field.id<<3|2)>>>0,8|types.mapKey[field.keyType],field.keyType),void 0===wireType?gen("types[%i].encode(%s[ks[i]],w.uint32(18).fork()).ldelim().ldelim()",index,ref):gen(".uint32(%i).%s(%s[ks[i]]).ldelim()",16|wireType,type,ref),gen("}")("}")):field.repeated?(gen("if(%s!=null&&%s.length){",ref,ref),field.packed&&void 0!==types.packed[type]?gen("w.uint32(%i).fork()",(field.id<<3|2)>>>0)("for(var i=0;i<%s.length;++i)",ref)("w.%s(%s[i])",type,ref)("w.ldelim()"):(gen("for(var i=0;i<%s.length;++i)",ref),void 0===wireType?genTypePartial(gen,field,index,ref+"[i]"):gen("w.uint32(%i).%s(%s[i])",(field.id<<3|wireType)>>>0,type,ref)),gen("}")):(field.optional&&gen("if(%s!=null&&Object.hasOwnProperty.call(m,%j))",ref,field.name),void 0===wireType?genTypePartial(gen,field,index,ref):gen("w.uint32(%i).%s(%s)",(field.id<<3|wireType)>>>0,type,ref))}return gen("return w")};var Enum=__webpack_require__("vREW"),types=__webpack_require__("hSTS"),util=__webpack_require__("y9PA");function genTypePartial(gen,field,fieldIndex,ref){return field.resolvedType.group?gen("types[%i].encode(%s,w.uint32(%i)).uint32(%i)",fieldIndex,ref,(field.id<<3|3)>>>0,(field.id<<3|4)>>>0):gen("types[%i].encode(%s,w.uint32(%i).fork()).ldelim()",fieldIndex,ref,(field.id<<3|2)>>>0)}},eM9J:function(module){module.exports=JSON.parse('{"_from":"@grpc/grpc-js@^1.3.2","_id":"@grpc/grpc-js@1.3.5","_inBundle":false,"_integrity":"sha512-V29L2QNKkLWM3bcJfVFMSo+Z7kkO8A1s7MAfdzBXLYEC1PE5/M0n1iXBDiD5aUtyVLh5GILcbme2bGtIHl0FMQ==","_location":"/@grpc/grpc-js","_phantomChildren":{},"_requested":{"type":"range","registry":true,"raw":"@grpc/grpc-js@^1.3.2","name":"@grpc/grpc-js","escapedName":"@grpc%2fgrpc-js","scope":"@grpc","rawSpec":"^1.3.2","saveSpec":null,"fetchSpec":"^1.3.2"},"_requiredBy":["/@firebase/firestore","/google-gax"],"_resolved":"https://registry.npmjs.org/@grpc/grpc-js/-/grpc-js-1.3.5.tgz","_shasum":"0cfecfbfd5b7723064db1b7b7109678fbd6ce424","_spec":"@grpc/grpc-js@^1.3.2","_where":"C:\\\\Users\\\\User\\\\Desktop\\\\voucher3\\\\node_modules\\\\@firebase\\\\firestore","author":{"name":"Google Inc."},"bundleDependencies":false,"contributors":[{"name":"Google Inc."}],"dependencies":{"@types/node":">=12.12.47"},"deprecated":false,"description":"gRPC Library for Node - pure JS implementation","devDependencies":{"@grpc/proto-loader":"^0.5.5","@types/gulp":"^4.0.6","@types/gulp-mocha":"0.0.32","@types/lodash":"^4.14.108","@types/mocha":"^5.2.6","@types/ncp":"^2.0.1","@types/pify":"^3.0.2","@types/yargs":"^15.0.5","clang-format":"^1.0.55","execa":"^2.0.3","gts":"^2.0.0","gulp":"^4.0.2","gulp-mocha":"^6.0.0","lodash":"^4.17.4","mocha-jenkins-reporter":"^0.4.1","ncp":"^2.0.0","pify":"^4.0.1","rimraf":"^3.0.2","ts-node":"^8.3.0","typescript":"^3.7.2","yargs":"^15.4.1"},"engines":{"node":"^8.13.0 || >=10.10.0"},"files":["src/**/*.ts","build/src/*.{js,d.ts,js.map}","LICENSE","deps/envoy-api/envoy/api/v2/**/*.proto","deps/envoy-api/envoy/config/**/*.proto","deps/envoy-api/envoy/service/**/*.proto","deps/envoy-api/envoy/type/**/*.proto","deps/udpa/udpa/**/*.proto","deps/googleapis/google/api/*.proto","deps/googleapis/google/rpc/*.proto","deps/protoc-gen-validate/validate/**/*.proto"],"homepage":"https://grpc.io/","keywords":[],"license":"Apache-2.0","main":"build/src/index.js","name":"@grpc/grpc-js","repository":{"type":"git","url":"https://github.com/grpc/grpc-node/tree/master/packages/grpc-js"},"scripts":{"build":"npm run compile","check":"gts check src/**/*.ts","clean":"node -e \'require(\\"rimraf\\")(\\"./build\\", () => {})\'","compile":"tsc -p .","fix":"gts fix src/*.ts","format":"clang-format -i -style=\\"{Language: JavaScript, BasedOnStyle: Google, ColumnLimit: 80}\\" src/*.ts test/*.ts","lint":"npm run check","posttest":"npm run check","prepare":"npm run compile","pretest":"npm run compile","test":"gulp test"},"types":"build/src/index.d.ts","version":"1.3.5"}')},eaSJ:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getInterceptingCall=exports.InterceptingCall=exports.RequesterBuilder=exports.ListenerBuilder=exports.InterceptorConfigurationError=void 0;const metadata_1=__webpack_require__("m7sO"),call_stream_1=__webpack_require__("hfvT"),constants_1=__webpack_require__("8o9P");class InterceptorConfigurationError extends Error{constructor(message){super(message),this.name="InterceptorConfigurationError",Error.captureStackTrace(this,InterceptorConfigurationError)}}exports.InterceptorConfigurationError=InterceptorConfigurationError;exports.ListenerBuilder=class{constructor(){this.metadata=void 0,this.message=void 0,this.status=void 0}withOnReceiveMetadata(onReceiveMetadata){return this.metadata=onReceiveMetadata,this}withOnReceiveMessage(onReceiveMessage){return this.message=onReceiveMessage,this}withOnReceiveStatus(onReceiveStatus){return this.status=onReceiveStatus,this}build(){return{onReceiveMetadata:this.metadata,onReceiveMessage:this.message,onReceiveStatus:this.status}}};exports.RequesterBuilder=class{constructor(){this.start=void 0,this.message=void 0,this.halfClose=void 0,this.cancel=void 0}withStart(start){return this.start=start,this}withSendMessage(sendMessage){return this.message=sendMessage,this}withHalfClose(halfClose){return this.halfClose=halfClose,this}withCancel(cancel){return this.cancel=cancel,this}build(){return{start:this.start,sendMessage:this.message,halfClose:this.halfClose,cancel:this.cancel}}};const defaultListener={onReceiveMetadata:(metadata,next)=>{next(metadata)},onReceiveMessage:(message,next)=>{next(message)},onReceiveStatus:(status,next)=>{next(status)}},defaultRequester={start:(metadata,listener,next)=>{next(metadata,listener)},sendMessage:(message,next)=>{next(message)},halfClose:next=>{next()},cancel:next=>{next()}};exports.InterceptingCall=class{constructor(nextCall,requester){var _a,_b,_c,_d;this.nextCall=nextCall,this.processingMessage=!1,this.pendingHalfClose=!1,this.requester=requester?{start:null!==(_a=requester.start)&&void 0!==_a?_a:defaultRequester.start,sendMessage:null!==(_b=requester.sendMessage)&&void 0!==_b?_b:defaultRequester.sendMessage,halfClose:null!==(_c=requester.halfClose)&&void 0!==_c?_c:defaultRequester.halfClose,cancel:null!==(_d=requester.cancel)&&void 0!==_d?_d:defaultRequester.cancel}:defaultRequester}cancelWithStatus(status,details){this.requester.cancel(()=>{this.nextCall.cancelWithStatus(status,details)})}getPeer(){return this.nextCall.getPeer()}start(metadata,interceptingListener){var _a,_b,_c,_d,_e,_f;const fullInterceptingListener={onReceiveMetadata:null!==(_b=null===(_a=null==interceptingListener?void 0:interceptingListener.onReceiveMetadata)||void 0===_a?void 0:_a.bind(interceptingListener))&&void 0!==_b?_b:metadata=>{},onReceiveMessage:null!==(_d=null===(_c=null==interceptingListener?void 0:interceptingListener.onReceiveMessage)||void 0===_c?void 0:_c.bind(interceptingListener))&&void 0!==_d?_d:message=>{},onReceiveStatus:null!==(_f=null===(_e=null==interceptingListener?void 0:interceptingListener.onReceiveStatus)||void 0===_e?void 0:_e.bind(interceptingListener))&&void 0!==_f?_f:status=>{}};this.requester.start(metadata,fullInterceptingListener,(md,listener)=>{var _a,_b,_c;let finalInterceptingListener;if(call_stream_1.isInterceptingListener(listener))finalInterceptingListener=listener;else{const fullListener={onReceiveMetadata:null!==(_a=listener.onReceiveMetadata)&&void 0!==_a?_a:defaultListener.onReceiveMetadata,onReceiveMessage:null!==(_b=listener.onReceiveMessage)&&void 0!==_b?_b:defaultListener.onReceiveMessage,onReceiveStatus:null!==(_c=listener.onReceiveStatus)&&void 0!==_c?_c:defaultListener.onReceiveStatus};finalInterceptingListener=new call_stream_1.InterceptingListenerImpl(fullListener,fullInterceptingListener)}this.nextCall.start(md,finalInterceptingListener)})}sendMessageWithContext(context,message){this.processingMessage=!0,this.requester.sendMessage(message,finalMessage=>{this.processingMessage=!1,this.nextCall.sendMessageWithContext(context,finalMessage),this.pendingHalfClose&&this.nextCall.halfClose()})}sendMessage(message){this.sendMessageWithContext({},message)}startRead(){this.nextCall.startRead()}halfClose(){this.requester.halfClose(()=>{this.processingMessage?this.pendingHalfClose=!0:this.nextCall.halfClose()})}setCredentials(credentials){this.nextCall.setCredentials(credentials)}};class BaseInterceptingCall{constructor(call,methodDefinition){this.call=call,this.methodDefinition=methodDefinition}cancelWithStatus(status,details){this.call.cancelWithStatus(status,details)}getPeer(){return this.call.getPeer()}setCredentials(credentials){this.call.setCredentials(credentials)}sendMessageWithContext(context,message){let serialized;try{serialized=this.methodDefinition.requestSerialize(message)}catch(e){return void this.call.cancelWithStatus(constants_1.Status.INTERNAL,`Request message serialization failure: ${e.message}`)}this.call.sendMessageWithContext(context,serialized)}sendMessage(message){this.sendMessageWithContext({},message)}start(metadata,interceptingListener){let readError=null;this.call.start(metadata,{onReceiveMetadata:metadata=>{var _a;null===(_a=null==interceptingListener?void 0:interceptingListener.onReceiveMetadata)||void 0===_a||_a.call(interceptingListener,metadata)},onReceiveMessage:message=>{var _a;let deserialized;try{deserialized=this.methodDefinition.responseDeserialize(message)}catch(e){return readError={code:constants_1.Status.INTERNAL,details:`Response message parsing error: ${e.message}`,metadata:new metadata_1.Metadata},void this.call.cancelWithStatus(readError.code,readError.details)}null===(_a=null==interceptingListener?void 0:interceptingListener.onReceiveMessage)||void 0===_a||_a.call(interceptingListener,deserialized)},onReceiveStatus:status=>{var _a,_b;readError?null===(_a=null==interceptingListener?void 0:interceptingListener.onReceiveStatus)||void 0===_a||_a.call(interceptingListener,readError):null===(_b=null==interceptingListener?void 0:interceptingListener.onReceiveStatus)||void 0===_b||_b.call(interceptingListener,status)}})}startRead(){this.call.startRead()}halfClose(){this.call.halfClose()}}class BaseUnaryInterceptingCall extends BaseInterceptingCall{constructor(call,methodDefinition){super(call,methodDefinition)}start(metadata,listener){var _a,_b;let receivedMessage=!1;const wrapperListener={onReceiveMetadata:null!==(_b=null===(_a=null==listener?void 0:listener.onReceiveMetadata)||void 0===_a?void 0:_a.bind(listener))&&void 0!==_b?_b:metadata=>{},onReceiveMessage:message=>{var _a;receivedMessage=!0,null===(_a=null==listener?void 0:listener.onReceiveMessage)||void 0===_a||_a.call(listener,message)},onReceiveStatus:status=>{var _a,_b;receivedMessage||null===(_a=null==listener?void 0:listener.onReceiveMessage)||void 0===_a||_a.call(listener,null),null===(_b=null==listener?void 0:listener.onReceiveStatus)||void 0===_b||_b.call(listener,status)}};super.start(metadata,wrapperListener),this.call.startRead()}}class BaseStreamingInterceptingCall extends BaseInterceptingCall{}function getBottomInterceptingCall(channel,options,methodDefinition){const call=function getCall(channel,path,options){var _a,_b;const deadline=null!==(_a=options.deadline)&&void 0!==_a?_a:1/0,host=options.host,parent=null!==(_b=options.parent)&&void 0!==_b?_b:null,propagateFlags=options.propagate_flags,credentials=options.credentials,call=channel.createCall(path,deadline,host,parent,propagateFlags);return credentials&&call.setCredentials(credentials),call}(channel,methodDefinition.path,options);return methodDefinition.responseStream?new BaseStreamingInterceptingCall(call,methodDefinition):new BaseUnaryInterceptingCall(call,methodDefinition)}exports.getInterceptingCall=function getInterceptingCall(interceptorArgs,methodDefinition,options,channel){if(interceptorArgs.clientInterceptors.length>0&&interceptorArgs.clientInterceptorProviders.length>0)throw new InterceptorConfigurationError("Both interceptors and interceptor_providers were passed as options to the client constructor. Only one of these is allowed.");if(interceptorArgs.callInterceptors.length>0&&interceptorArgs.callInterceptorProviders.length>0)throw new InterceptorConfigurationError("Both interceptors and interceptor_providers were passed as call options. Only one of these is allowed.");let interceptors=[];interceptors=interceptorArgs.callInterceptors.length>0||interceptorArgs.callInterceptorProviders.length>0?[].concat(interceptorArgs.callInterceptors,interceptorArgs.callInterceptorProviders.map(provider=>provider(methodDefinition))).filter(interceptor=>interceptor):[].concat(interceptorArgs.clientInterceptors,interceptorArgs.clientInterceptorProviders.map(provider=>provider(methodDefinition))).filter(interceptor=>interceptor);const interceptorOptions=Object.assign({},options,{method_definition:methodDefinition});return interceptors.reduceRight((nextCall,nextInterceptor)=>currentOptions=>nextInterceptor(currentOptions,nextCall),finalOptions=>getBottomInterceptingCall(channel,finalOptions,methodDefinition))(interceptorOptions)}},eroE:function(module,exports,__webpack_require__){"use strict";module.exports=fetch;var asPromise=__webpack_require__("MFts"),fs=__webpack_require__("1Giq")("fs");function fetch(filename,options,callback){return"function"==typeof options?(callback=options,options={}):options||(options={}),callback?!options.xhr&&fs&&fs.readFile?fs.readFile(filename,function fetchReadFileCallback(err,contents){return err&&"undefined"!=typeof XMLHttpRequest?fetch.xhr(filename,options,callback):err?callback(err):callback(null,options.binary?contents:contents.toString("utf8"))}):fetch.xhr(filename,options,callback):asPromise(fetch,this,filename,options)}fetch.xhr=function fetch_xhr(filename,options,callback){var xhr=new XMLHttpRequest;xhr.onreadystatechange=function fetchOnReadyStateChange(){if(4===xhr.readyState){if(0!==xhr.status&&200!==xhr.status)return callback(Error("status "+xhr.status));if(options.binary){var buffer=xhr.response;if(!buffer){buffer=[];for(var i=0;i<xhr.responseText.length;++i)buffer.push(255&xhr.responseText.charCodeAt(i))}return callback(null,"undefined"!=typeof Uint8Array?new Uint8Array(buffer):buffer)}return callback(null,xhr.responseText)}},options.binary&&("overrideMimeType"in xhr&&xhr.overrideMimeType("text/plain; charset=x-user-defined"),xhr.responseType="arraybuffer"),xhr.open("GET",filename),xhr.send()}},fgco:function(module,exports,__webpack_require__){"use strict";module.exports=Namespace;var ReflectionObject=__webpack_require__("iuWj");((Namespace.prototype=Object.create(ReflectionObject.prototype)).constructor=Namespace).className="Namespace";var Type,Service,Enum,Field=__webpack_require__("pqPr"),OneOf=__webpack_require__("d+r3"),util=__webpack_require__("y9PA");function arrayToJSON(array,toJSONOptions){if(array&&array.length){for(var obj={},i=0;i<array.length;++i)obj[array[i].name]=array[i].toJSON(toJSONOptions);return obj}}function Namespace(name,options){ReflectionObject.call(this,name,options),this.nested=void 0,this._nestedArray=null}function clearCache(namespace){return namespace._nestedArray=null,namespace}Namespace.fromJSON=function fromJSON(name,json){return new Namespace(name,json.options).addJSON(json.nested)},Namespace.arrayToJSON=arrayToJSON,Namespace.isReservedId=function isReservedId(reserved,id){if(reserved)for(var i=0;i<reserved.length;++i)if("string"!=typeof reserved[i]&&reserved[i][0]<=id&&reserved[i][1]>id)return!0;return!1},Namespace.isReservedName=function isReservedName(reserved,name){if(reserved)for(var i=0;i<reserved.length;++i)if(reserved[i]===name)return!0;return!1},Object.defineProperty(Namespace.prototype,"nestedArray",{get:function(){return this._nestedArray||(this._nestedArray=util.toArray(this.nested))}}),Namespace.prototype.toJSON=function toJSON(toJSONOptions){return util.toObject(["options",this.options,"nested",arrayToJSON(this.nestedArray,toJSONOptions)])},Namespace.prototype.addJSON=function addJSON(nestedJson){if(nestedJson)for(var nested,names=Object.keys(nestedJson),i=0;i<names.length;++i)nested=nestedJson[names[i]],this.add((void 0!==nested.fields?Type.fromJSON:void 0!==nested.values?Enum.fromJSON:void 0!==nested.methods?Service.fromJSON:void 0!==nested.id?Field.fromJSON:Namespace.fromJSON)(names[i],nested));return this},Namespace.prototype.get=function get(name){return this.nested&&this.nested[name]||null},Namespace.prototype.getEnum=function getEnum(name){if(this.nested&&this.nested[name]instanceof Enum)return this.nested[name].values;throw Error("no such enum: "+name)},Namespace.prototype.add=function add(object){if(!(object instanceof Field&&void 0!==object.extend||object instanceof Type||object instanceof Enum||object instanceof Service||object instanceof Namespace||object instanceof OneOf))throw TypeError("object must be a valid nested object");if(this.nested){var prev=this.get(object.name);if(prev){if(!(prev instanceof Namespace&&object instanceof Namespace)||prev instanceof Type||prev instanceof Service)throw Error("duplicate name '"+object.name+"' in "+this);for(var nested=prev.nestedArray,i=0;i<nested.length;++i)object.add(nested[i]);this.remove(prev),this.nested||(this.nested={}),object.setOptions(prev.options,!0)}}else this.nested={};return this.nested[object.name]=object,object.onAdd(this),clearCache(this)},Namespace.prototype.remove=function remove(object){if(!(object instanceof ReflectionObject))throw TypeError("object must be a ReflectionObject");if(object.parent!==this)throw Error(object+" is not a member of "+this);return delete this.nested[object.name],Object.keys(this.nested).length||(this.nested=void 0),object.onRemove(this),clearCache(this)},Namespace.prototype.define=function define(path,json){if(util.isString(path))path=path.split(".");else if(!Array.isArray(path))throw TypeError("illegal path");if(path&&path.length&&""===path[0])throw Error("path must be relative");for(var ptr=this;path.length>0;){var part=path.shift();if(ptr.nested&&ptr.nested[part]){if(!((ptr=ptr.nested[part])instanceof Namespace))throw Error("path conflicts with non-namespace objects")}else ptr.add(ptr=new Namespace(part))}return json&&ptr.addJSON(json),ptr},Namespace.prototype.resolveAll=function resolveAll(){for(var nested=this.nestedArray,i=0;i<nested.length;)nested[i]instanceof Namespace?nested[i++].resolveAll():nested[i++].resolve();return this.resolve()},Namespace.prototype.lookup=function lookup(path,filterTypes,parentAlreadyChecked){if("boolean"==typeof filterTypes?(parentAlreadyChecked=filterTypes,filterTypes=void 0):filterTypes&&!Array.isArray(filterTypes)&&(filterTypes=[filterTypes]),util.isString(path)&&path.length){if("."===path)return this.root;path=path.split(".")}else if(!path.length)return this;if(""===path[0])return this.root.lookup(path.slice(1),filterTypes);var found=this.get(path[0]);if(found){if(1===path.length){if(!filterTypes||filterTypes.indexOf(found.constructor)>-1)return found}else if(found instanceof Namespace&&(found=found.lookup(path.slice(1),filterTypes,!0)))return found}else for(var i=0;i<this.nestedArray.length;++i)if(this._nestedArray[i]instanceof Namespace&&(found=this._nestedArray[i].lookup(path,filterTypes,!0)))return found;return null===this.parent||parentAlreadyChecked?null:this.parent.lookup(path,filterTypes)},Namespace.prototype.lookupType=function lookupType(path){var found=this.lookup(path,[Type]);if(!found)throw Error("no such type: "+path);return found},Namespace.prototype.lookupEnum=function lookupEnum(path){var found=this.lookup(path,[Enum]);if(!found)throw Error("no such Enum '"+path+"' in "+this);return found},Namespace.prototype.lookupTypeOrEnum=function lookupTypeOrEnum(path){var found=this.lookup(path,[Type,Enum]);if(!found)throw Error("no such Type or Enum '"+path+"' in "+this);return found},Namespace.prototype.lookupService=function lookupService(path){var found=this.lookup(path,[Service]);if(!found)throw Error("no such Service '"+path+"' in "+this);return found},Namespace._configure=function(Type_,Service_,Enum_){Type=Type_,Service=Service_,Enum=Enum_}},gH6v:function(module,exports,__webpack_require__){"use strict";module.exports=Service;var util=__webpack_require__("6Tgl");function Service(rpcImpl,requestDelimited,responseDelimited){if("function"!=typeof rpcImpl)throw TypeError("rpcImpl must be a function");util.EventEmitter.call(this),this.rpcImpl=rpcImpl,this.requestDelimited=Boolean(requestDelimited),this.responseDelimited=Boolean(responseDelimited)}(Service.prototype=Object.create(util.EventEmitter.prototype)).constructor=Service,Service.prototype.rpcCall=function rpcCall(method,requestCtor,responseCtor,request,callback){if(!request)throw TypeError("request must be specified");var self=this;if(!callback)return util.asPromise(rpcCall,self,method,requestCtor,responseCtor,request);if(self.rpcImpl)try{return self.rpcImpl(method,requestCtor[self.requestDelimited?"encodeDelimited":"encode"](request).finish(),function rpcCallback(err,response){if(err)return self.emit("error",err,method),callback(err);if(null!==response){if(!(response instanceof responseCtor))try{response=responseCtor[self.responseDelimited?"decodeDelimited":"decode"](response)}catch(err){return self.emit("error",err,method),callback(err)}return self.emit("data",response,method),callback(null,response)}self.end(!0)})}catch(err){return self.emit("error",err,method),void setTimeout(function(){callback(err)},0)}else setTimeout(function(){callback(Error("already ended"))},0)},Service.prototype.end=function end(endedByRPC){return this.rpcImpl&&(endedByRPC||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}},gM9X:function(module){module.exports=JSON.parse('{"nested":{"google":{"nested":{"protobuf":{"nested":{"SourceContext":{"fields":{"fileName":{"type":"string","id":1}}}}}}}}}')},guhe:function(module,exports,__webpack_require__){"use strict";module.exports=MapField;var Field=__webpack_require__("pqPr");((MapField.prototype=Object.create(Field.prototype)).constructor=MapField).className="MapField";var types=__webpack_require__("hSTS"),util=__webpack_require__("y9PA");function MapField(name,id,keyType,type,options,comment){if(Field.call(this,name,id,type,void 0,void 0,options,comment),!util.isString(keyType))throw TypeError("keyType must be a string");this.keyType=keyType,this.resolvedKeyType=null,this.map=!0}MapField.fromJSON=function fromJSON(name,json){return new MapField(name,json.id,json.keyType,json.type,json.options,json.comment)},MapField.prototype.toJSON=function toJSON(toJSONOptions){var keepComments=!!toJSONOptions&&Boolean(toJSONOptions.keepComments);return util.toObject(["keyType",this.keyType,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",keepComments?this.comment:void 0])},MapField.prototype.resolve=function resolve(){if(this.resolved)return this;if(void 0===types.mapKey[this.keyType])throw Error("invalid key type: "+this.keyType);return Field.prototype.resolve.call(this)},MapField.d=function decorateMapField(fieldId,fieldKeyType,fieldValueType){return"function"==typeof fieldValueType?fieldValueType=util.decorateType(fieldValueType).name:fieldValueType&&"object"==typeof fieldValueType&&(fieldValueType=util.decorateEnum(fieldValueType).name),function mapFieldDecorator(prototype,fieldName){util.decorateType(prototype.constructor).add(new MapField(fieldName,fieldId,fieldKeyType,fieldValueType))}}},hSTS:function(module,exports,__webpack_require__){"use strict";var types=exports,util=__webpack_require__("y9PA"),s=["double","float","int32","uint32","sint32","fixed32","sfixed32","int64","uint64","sint64","fixed64","sfixed64","bool","string","bytes"];function bake(values,offset){var i=0,o={};for(offset|=0;i<values.length;)o[s[i+offset]]=values[i++];return o}types.basic=bake([1,5,0,0,0,5,5,0,0,0,1,1,0,2,2]),types.defaults=bake([0,0,0,0,0,0,0,0,0,0,0,0,!1,"",util.emptyArray,null]),types.long=bake([0,0,0,1,1],7),types.mapKey=bake([0,0,0,5,5,0,0,0,1,1,0,2],2),types.packed=bake([1,5,0,0,0,5,5,0,0,0,1,1,0])},hc0Y:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BackoffTimeout=void 0;exports.BackoffTimeout=class{constructor(callback,options){this.callback=callback,this.initialDelay=1e3,this.multiplier=1.6,this.maxDelay=12e4,this.jitter=.2,this.running=!1,this.hasRef=!0,options&&(options.initialDelay&&(this.initialDelay=options.initialDelay),options.multiplier&&(this.multiplier=options.multiplier),options.jitter&&(this.jitter=options.jitter),options.maxDelay&&(this.maxDelay=options.maxDelay)),this.nextDelay=this.initialDelay,this.timerId=setTimeout(()=>{},0),clearTimeout(this.timerId)}runOnce(){var _a,_b;this.running=!0,this.timerId=setTimeout(()=>{this.callback(),this.running=!1},this.nextDelay),this.hasRef||null===(_b=(_a=this.timerId).unref)||void 0===_b||_b.call(_a);const nextBackoff=Math.min(this.nextDelay*this.multiplier,this.maxDelay),jitterMagnitude=nextBackoff*this.jitter;this.nextDelay=nextBackoff+function uniformRandom(min,max){return Math.random()*(max-min)+min}(-jitterMagnitude,jitterMagnitude)}stop(){clearTimeout(this.timerId),this.running=!1}reset(){this.nextDelay=this.initialDelay}isRunning(){return this.running}ref(){var _a,_b;this.hasRef=!0,null===(_b=(_a=this.timerId).ref)||void 0===_b||_b.call(_a)}unref(){var _a,_b;this.hasRef=!1,null===(_b=(_a=this.timerId).unref)||void 0===_b||_b.call(_a)}}},hfvT:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Http2CallStream=exports.InterceptingListenerImpl=exports.isInterceptingListener=void 0;const http2=__webpack_require__("MG4E"),os=__webpack_require__("jle/"),constants_1=__webpack_require__("8o9P"),filter_stack_1=__webpack_require__("Za3E"),metadata_1=__webpack_require__("m7sO"),stream_decoder_1=__webpack_require__("lvRS"),logging=__webpack_require__("xQiD"),constants_2=__webpack_require__("8o9P"),{HTTP2_HEADER_STATUS:HTTP2_HEADER_STATUS,HTTP2_HEADER_CONTENT_TYPE:HTTP2_HEADER_CONTENT_TYPE,NGHTTP2_CANCEL:NGHTTP2_CANCEL}=http2.constants;exports.isInterceptingListener=function isInterceptingListener(listener){return void 0!==listener.onReceiveMetadata&&1===listener.onReceiveMetadata.length};exports.InterceptingListenerImpl=class{constructor(listener,nextListener){this.listener=listener,this.nextListener=nextListener,this.processingMessage=!1,this.pendingStatus=null}onReceiveMetadata(metadata){this.listener.onReceiveMetadata(metadata,metadata=>{this.nextListener.onReceiveMetadata(metadata)})}onReceiveMessage(message){this.processingMessage=!0,this.listener.onReceiveMessage(message,msg=>{this.processingMessage=!1,this.nextListener.onReceiveMessage(msg),this.pendingStatus&&this.nextListener.onReceiveStatus(this.pendingStatus)})}onReceiveStatus(status){this.listener.onReceiveStatus(status,processedStatus=>{this.processingMessage?this.pendingStatus=processedStatus:this.nextListener.onReceiveStatus(processedStatus)})}};exports.Http2CallStream=class{constructor(methodName,channel,options,filterStackFactory,channelCallCredentials,callNumber){this.methodName=methodName,this.channel=channel,this.options=options,this.channelCallCredentials=channelCallCredentials,this.callNumber=callNumber,this.http2Stream=null,this.pendingRead=!1,this.isWriteFilterPending=!1,this.pendingWrite=null,this.pendingWriteCallback=null,this.writesClosed=!1,this.decoder=new stream_decoder_1.StreamDecoder,this.isReadFilterPending=!1,this.canPush=!1,this.readsClosed=!1,this.statusOutput=!1,this.unpushedReadMessages=[],this.unfilteredReadMessages=[],this.mappedStatusCode=constants_1.Status.UNKNOWN,this.finalStatus=null,this.subchannel=null,this.listener=null,this.internalError=null,this.filterStack=filterStackFactory.createFilter(this),this.credentials=channelCallCredentials,this.disconnectListener=()=>{this.endCall({code:constants_1.Status.UNAVAILABLE,details:"Connection dropped",metadata:new metadata_1.Metadata})},this.options.parentCall&&this.options.flags&constants_1.Propagate.CANCELLATION&&this.options.parentCall.on("cancelled",()=>{this.cancelWithStatus(constants_1.Status.CANCELLED,"Cancelled by parent call")})}outputStatus(){if(!this.statusOutput){this.statusOutput=!0;const filteredStatus=this.filterStack.receiveTrailers(this.finalStatus);process.nextTick(()=>{var _a;null===(_a=this.listener)||void 0===_a||_a.onReceiveStatus(filteredStatus)}),this.subchannel&&(this.subchannel.callUnref(),this.subchannel.removeDisconnectListener(this.disconnectListener))}}trace(text){logging.trace(constants_2.LogVerbosity.DEBUG,"call_stream","["+this.callNumber+"] "+text)}endCall(status){null!==this.finalStatus&&this.finalStatus.code!==constants_1.Status.OK||(this.trace("ended with status: code="+status.code+' details="'+status.details+'"'),this.finalStatus=status,this.maybeOutputStatus()),this.destroyHttp2Stream()}maybeOutputStatus(){null!==this.finalStatus&&(this.finalStatus.code!==constants_1.Status.OK||this.readsClosed&&0===this.unpushedReadMessages.length&&0===this.unfilteredReadMessages.length&&!this.isReadFilterPending)&&this.outputStatus()}push(message){this.trace("pushing to reader message of length "+(message instanceof Buffer?message.length:null)),this.canPush=!1,process.nextTick(()=>{var _a;this.statusOutput||(null===(_a=this.listener)||void 0===_a||_a.onReceiveMessage(message),this.maybeOutputStatus())})}handleFilterError(error){this.cancelWithStatus(constants_1.Status.INTERNAL,error.message)}handleFilteredRead(message){if(null===this.finalStatus||this.finalStatus.code===constants_1.Status.OK){if(this.isReadFilterPending=!1,this.canPush?(this.http2Stream.pause(),this.push(message)):(this.trace("unpushedReadMessages.push message of length "+message.length),this.unpushedReadMessages.push(message)),this.unfilteredReadMessages.length>0){const nextMessage=this.unfilteredReadMessages.shift();this.filterReceivedMessage(nextMessage)}}else this.maybeOutputStatus()}filterReceivedMessage(framedMessage){null===this.finalStatus||this.finalStatus.code===constants_1.Status.OK?(this.trace("filterReceivedMessage of length "+framedMessage.length),this.isReadFilterPending=!0,this.filterStack.receiveMessage(Promise.resolve(framedMessage)).then(this.handleFilteredRead.bind(this),this.handleFilterError.bind(this))):this.maybeOutputStatus()}tryPush(messageBytes){this.isReadFilterPending?(this.trace("unfilteredReadMessages.push message of length "+(messageBytes&&messageBytes.length)),this.unfilteredReadMessages.push(messageBytes)):this.filterReceivedMessage(messageBytes)}handleTrailers(headers){let metadata,headersString="";for(const header of Object.keys(headers))headersString+="\t\t"+header+": "+headers[header]+"\n";this.trace("Received server trailers:\n"+headersString);try{metadata=metadata_1.Metadata.fromHttp2Headers(headers)}catch(e){metadata=new metadata_1.Metadata}const metadataMap=metadata.getMap();let code=this.mappedStatusCode;if(code===constants_1.Status.UNKNOWN&&"string"==typeof metadataMap["grpc-status"]){const receivedStatus=Number(metadataMap["grpc-status"]);receivedStatus in constants_1.Status&&(code=receivedStatus,this.trace("received status code "+receivedStatus+" from server")),metadata.remove("grpc-status")}let details="";"string"==typeof metadataMap["grpc-message"]&&(details=decodeURI(metadataMap["grpc-message"]),metadata.remove("grpc-message"),this.trace('received status details string "'+details+'" from server'));const status={code:code,details:details,metadata:metadata};this.endCall(status)}attachHttp2Stream(stream,subchannel,extraFilterFactory){if(void 0!==extraFilterFactory&&(this.filterStack=new filter_stack_1.FilterStack([this.filterStack,extraFilterFactory.createFilter(this)])),null!==this.finalStatus)stream.close(NGHTTP2_CANCEL);else{if(this.trace("attachHttp2Stream from subchannel "+subchannel.getAddress()),this.http2Stream=stream,this.subchannel=subchannel,subchannel.addDisconnectListener(this.disconnectListener),subchannel.callRef(),stream.on("response",(headers,flags)=>{var _a;let headersString="";for(const header of Object.keys(headers))headersString+="\t\t"+header+": "+headers[header]+"\n";switch(this.trace("Received server headers:\n"+headersString),headers[":status"]){case 400:this.mappedStatusCode=constants_1.Status.INTERNAL;break;case 401:this.mappedStatusCode=constants_1.Status.UNAUTHENTICATED;break;case 403:this.mappedStatusCode=constants_1.Status.PERMISSION_DENIED;break;case 404:this.mappedStatusCode=constants_1.Status.UNIMPLEMENTED;break;case 429:case 502:case 503:case 504:this.mappedStatusCode=constants_1.Status.UNAVAILABLE;break;default:this.mappedStatusCode=constants_1.Status.UNKNOWN}if(flags&http2.constants.NGHTTP2_FLAG_END_STREAM)this.handleTrailers(headers);else{let metadata;try{metadata=metadata_1.Metadata.fromHttp2Headers(headers)}catch(error){return void this.endCall({code:constants_1.Status.UNKNOWN,details:error.message,metadata:new metadata_1.Metadata})}try{const finalMetadata=this.filterStack.receiveMetadata(metadata);null===(_a=this.listener)||void 0===_a||_a.onReceiveMetadata(finalMetadata)}catch(error){this.endCall({code:constants_1.Status.UNKNOWN,details:error.message,metadata:new metadata_1.Metadata})}}}),stream.on("trailers",this.handleTrailers.bind(this)),stream.on("data",data=>{this.trace("receive HTTP/2 data frame of length "+data.length);const messages=this.decoder.write(data);for(const message of messages)this.trace("parsed message of length "+message.length),this.tryPush(message)}),stream.on("end",()=>{this.readsClosed=!0,this.maybeOutputStatus()}),stream.on("close",()=>{process.nextTick(()=>{var _a;if(this.trace("HTTP/2 stream closed with code "+stream.rstCode),(null===(_a=this.finalStatus)||void 0===_a?void 0:_a.code)===constants_1.Status.OK)return;let code,details="";switch(stream.rstCode){case http2.constants.NGHTTP2_NO_ERROR:if(null!==this.finalStatus)return;code=constants_1.Status.INTERNAL,details=`Received RST_STREAM with code ${stream.rstCode}`;break;case http2.constants.NGHTTP2_REFUSED_STREAM:code=constants_1.Status.UNAVAILABLE,details="Stream refused by server";break;case http2.constants.NGHTTP2_CANCEL:code=constants_1.Status.CANCELLED,details="Call cancelled";break;case http2.constants.NGHTTP2_ENHANCE_YOUR_CALM:code=constants_1.Status.RESOURCE_EXHAUSTED,details="Bandwidth exhausted";break;case http2.constants.NGHTTP2_INADEQUATE_SECURITY:code=constants_1.Status.PERMISSION_DENIED,details="Protocol not secure enough";break;case http2.constants.NGHTTP2_INTERNAL_ERROR:code=constants_1.Status.INTERNAL,null===this.internalError?details=`Received RST_STREAM with code ${stream.rstCode} (Internal server error)`:"ECONNRESET"===this.internalError.code?(code=constants_1.Status.UNAVAILABLE,details=this.internalError.message):details=`Received RST_STREAM with code ${stream.rstCode} triggered by internal client error: ${this.internalError.message}`;break;default:code=constants_1.Status.INTERNAL,details=`Received RST_STREAM with code ${stream.rstCode}`}this.endCall({code:code,details:details,metadata:new metadata_1.Metadata})})}),stream.on("error",err=>{"ERR_HTTP2_STREAM_ERROR"!==err.code&&(this.trace("Node error event: message="+err.message+" code="+err.code+" errno="+function getSystemErrorName(errno){for(const[name,num]of Object.entries(os.constants.errno))if(num===errno)return name;return"Unknown system error "+errno}(err.errno)+" syscall="+err.syscall),this.internalError=err)}),this.pendingRead||stream.pause(),this.pendingWrite){if(!this.pendingWriteCallback)throw new Error("Invalid state in write handling code");this.trace("sending data chunk of length "+this.pendingWrite.length+" (deferred)"),stream.write(this.pendingWrite,this.pendingWriteCallback)}this.maybeCloseWrites()}}start(metadata,listener){this.trace("Sending metadata"),this.listener=listener,this.channel._startCallStream(this,metadata)}destroyHttp2Stream(){var _a;if(null!==this.http2Stream&&!this.http2Stream.destroyed){let code;code=(null===(_a=this.finalStatus)||void 0===_a?void 0:_a.code)===constants_1.Status.OK?http2.constants.NGHTTP2_NO_ERROR:http2.constants.NGHTTP2_CANCEL,this.trace("close http2 stream with code "+code),this.http2Stream.close(code)}}cancelWithStatus(status,details){this.trace("cancelWithStatus code: "+status+' details: "'+details+'"'),this.endCall({code:status,details:details,metadata:new metadata_1.Metadata})}getDeadline(){if(this.options.parentCall&&this.options.flags&constants_1.Propagate.DEADLINE){const parentDeadline=this.options.parentCall.getDeadline(),selfDeadline=this.options.deadline,parentDeadlineMsecs=parentDeadline instanceof Date?parentDeadline.getTime():parentDeadline,selfDeadlineMsecs=selfDeadline instanceof Date?selfDeadline.getTime():selfDeadline;return Math.min(parentDeadlineMsecs,selfDeadlineMsecs)}return this.options.deadline}getCredentials(){return this.credentials}setCredentials(credentials){this.credentials=this.channelCallCredentials.compose(credentials)}getStatus(){return this.finalStatus}getPeer(){var _a,_b;return null!==(_b=null===(_a=this.subchannel)||void 0===_a?void 0:_a.getAddress())&&void 0!==_b?_b:this.channel.getTarget()}getMethod(){return this.methodName}getHost(){return this.options.host}startRead(){if(null!==this.finalStatus&&this.finalStatus.code!==constants_1.Status.OK)return this.readsClosed=!0,void this.maybeOutputStatus();if(this.canPush=!0,null===this.http2Stream)this.pendingRead=!0;else{if(this.unpushedReadMessages.length>0){const nextMessage=this.unpushedReadMessages.shift();return void this.push(nextMessage)}this.http2Stream.resume()}}maybeCloseWrites(){this.writesClosed&&!this.isWriteFilterPending&&null!==this.http2Stream&&(this.trace("calling end() on HTTP/2 stream"),this.http2Stream.end())}sendMessageWithContext(context,message){var _a;this.trace("write() called with message of length "+message.length);const writeObj={message:message,flags:context.flags},cb=null!==(_a=context.callback)&&void 0!==_a?_a:()=>{};this.isWriteFilterPending=!0,this.filterStack.sendMessage(Promise.resolve(writeObj)).then(message=>{this.isWriteFilterPending=!1,null===this.http2Stream?(this.trace("deferring writing data chunk of length "+message.message.length),this.pendingWrite=message.message,this.pendingWriteCallback=cb):(this.trace("sending data chunk of length "+message.message.length),this.http2Stream.write(message.message,cb),this.maybeCloseWrites())},this.handleFilterError.bind(this))}halfClose(){this.trace("end() called"),this.writesClosed=!0,this.maybeCloseWrites()}}},iV0I:function(module,exports,__webpack_require__){"use strict";var firebase=__webpack_require__("eq5/");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}__webpack_require__("LOEa"),__webpack_require__("rjtV"),__webpack_require__("l4iV"),__webpack_require__("02Vj"),__webpack_require__("KgU9");var firebase__default=_interopDefaultLegacy(firebase);firebase__default.default.registerVersion("firebase","8.7.1","app"),firebase__default.default.SDK_VERSION="8.7.1";firebase__default.default.registerVersion("firebase","8.7.1","node"),module.exports=firebase__default.default},iWXB:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs=__webpack_require__("mw/K"),path=__webpack_require__("oyvS"),Protobuf=__webpack_require__("+hx4");function addIncludePathResolver(root,includePaths){const originalResolvePath=root.resolvePath;root.resolvePath=(origin,target)=>{if(path.isAbsolute(target))return target;for(const directory of includePaths){const fullPath=path.join(directory,target);try{return fs.accessSync(fullPath,fs.constants.R_OK),fullPath}catch(err){continue}}return process.emitWarning(`${target} not found in any of the include paths ${includePaths}`),originalResolvePath(origin,target)}}exports.loadProtosWithOptions=async function loadProtosWithOptions(filename,options){const root=new Protobuf.Root;if((options=options||{}).includeDirs){if(!Array.isArray(options.includeDirs))return Promise.reject(new Error("The includeDirs option must be an array"));addIncludePathResolver(root,options.includeDirs)}const loadedRoot=await root.load(filename,options);return loadedRoot.resolveAll(),loadedRoot},exports.loadProtosWithOptionsSync=function loadProtosWithOptionsSync(filename,options){const root=new Protobuf.Root;if((options=options||{}).includeDirs){if(!Array.isArray(options.includeDirs))throw new Error("The includeDirs option must be an array");addIncludePathResolver(root,options.includeDirs)}const loadedRoot=root.loadSync(filename,options);return loadedRoot.resolveAll(),loadedRoot},exports.addCommonProtos=function addCommonProtos(){const apiDescriptor=__webpack_require__("KRUT"),descriptorDescriptor=__webpack_require__("3cR/"),sourceContextDescriptor=__webpack_require__("gM9X"),typeDescriptor=__webpack_require__("Em0h");Protobuf.common("api",apiDescriptor.nested.google.nested.protobuf.nested),Protobuf.common("descriptor",descriptorDescriptor.nested.google.nested.protobuf.nested),Protobuf.common("source_context",sourceContextDescriptor.nested.google.nested.protobuf.nested),Protobuf.common("type",typeDescriptor.nested.google.nested.protobuf.nested)}},iuWj:function(module,exports,__webpack_require__){"use strict";module.exports=ReflectionObject,ReflectionObject.className="ReflectionObject";var Root,util=__webpack_require__("y9PA");function ReflectionObject(name,options){if(!util.isString(name))throw TypeError("name must be a string");if(options&&!util.isObject(options))throw TypeError("options must be an object");this.options=options,this.parsedOptions=null,this.name=name,this.parent=null,this.resolved=!1,this.comment=null,this.filename=null}Object.defineProperties(ReflectionObject.prototype,{root:{get:function(){for(var ptr=this;null!==ptr.parent;)ptr=ptr.parent;return ptr}},fullName:{get:function(){for(var path=[this.name],ptr=this.parent;ptr;)path.unshift(ptr.name),ptr=ptr.parent;return path.join(".")}}}),ReflectionObject.prototype.toJSON=function toJSON(){throw Error()},ReflectionObject.prototype.onAdd=function onAdd(parent){this.parent&&this.parent!==parent&&this.parent.remove(this),this.parent=parent,this.resolved=!1;var root=parent.root;root instanceof Root&&root._handleAdd(this)},ReflectionObject.prototype.onRemove=function onRemove(parent){var root=parent.root;root instanceof Root&&root._handleRemove(this),this.parent=null,this.resolved=!1},ReflectionObject.prototype.resolve=function resolve(){return this.resolved||this.root instanceof Root&&(this.resolved=!0),this},ReflectionObject.prototype.getOption=function getOption(name){if(this.options)return this.options[name]},ReflectionObject.prototype.setOption=function setOption(name,value,ifNotSet){return ifNotSet&&this.options&&void 0!==this.options[name]||((this.options||(this.options={}))[name]=value),this},ReflectionObject.prototype.setParsedOption=function setParsedOption(name,value,propName){this.parsedOptions||(this.parsedOptions=[]);var parsedOptions=this.parsedOptions;if(propName){var opt=parsedOptions.find(function(opt){return Object.prototype.hasOwnProperty.call(opt,name)});if(opt){var newValue=opt[name];util.setProperty(newValue,propName,value)}else(opt={})[name]=util.setProperty({},propName,value),parsedOptions.push(opt)}else{var newOpt={};newOpt[name]=value,parsedOptions.push(newOpt)}return this},ReflectionObject.prototype.setOptions=function setOptions(options,ifNotSet){if(options)for(var keys=Object.keys(options),i=0;i<keys.length;++i)this.setOption(keys[i],options[keys[i]],ifNotSet);return this},ReflectionObject.prototype.toString=function toString(){var className=this.constructor.className,fullName=this.fullName;return fullName.length?className+" "+fullName:className},ReflectionObject._configure=function(Root_){Root=Root_}},l4iV:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib=__webpack_require__("zOht"),firebase=__webpack_require__("eq5/"),database04501227=__webpack_require__("sE+A"),component=__webpack_require__("S+S0"),util=__webpack_require__("Jv5v");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}__webpack_require__("NcST"),__webpack_require__("jK02"),__webpack_require__("PJMN"),__webpack_require__("AVbK"),__webpack_require__("eM9J"),__webpack_require__("oyvS"),__webpack_require__("8ZNE");var firebase__default=_interopDefaultLegacy(firebase);function arrayUnion(){for(var elements=[],_i=0;_i<arguments.length;_i++)elements[_i]=arguments[_i];return new database04501227.ArrayUnionFieldValueImpl("arrayUnion",elements)}function arrayRemove(){for(var elements=[],_i=0;_i<arguments.length;_i++)elements[_i]=arguments[_i];return new database04501227.ArrayRemoveFieldValueImpl("arrayRemove",elements)}var FieldPath=function(){function FieldPath(){for(var fieldNames=[],_i=0;_i<arguments.length;_i++)fieldNames[_i]=arguments[_i];this._delegate=new(database04501227.FieldPath.bind.apply(database04501227.FieldPath,tslib.__spreadArray([void 0],fieldNames)))}return FieldPath.documentId=function(){return new FieldPath(database04501227.FieldPath$1.keyField().canonicalString())},FieldPath.prototype.isEqual=function(other){return(other=util.getModularInstance(other))instanceof database04501227.FieldPath&&this._delegate._internalPath.isEqual(other._internalPath)},FieldPath}(),FieldValue=function(){function FieldValue(_delegate){this._delegate=_delegate}return FieldValue.serverTimestamp=function(){var delegate=function serverTimestamp(){return new database04501227.ServerTimestampFieldValueImpl("serverTimestamp")}();return delegate._methodName="FieldValue.serverTimestamp",new FieldValue(delegate)},FieldValue.delete=function(){var delegate=function deleteField(){return new database04501227.DeleteFieldValueImpl("deleteField")}();return delegate._methodName="FieldValue.delete",new FieldValue(delegate)},FieldValue.arrayUnion=function(){for(var elements=[],_i=0;_i<arguments.length;_i++)elements[_i]=arguments[_i];var delegate=arrayUnion.apply(void 0,elements);return delegate._methodName="FieldValue.arrayUnion",new FieldValue(delegate)},FieldValue.arrayRemove=function(){for(var elements=[],_i=0;_i<arguments.length;_i++)elements[_i]=arguments[_i];var delegate=arrayRemove.apply(void 0,elements);return delegate._methodName="FieldValue.arrayRemove",new FieldValue(delegate)},FieldValue.increment=function(n){var delegate=function increment(n){return new database04501227.NumericIncrementFieldValueImpl("increment",n)}(n);return delegate._methodName="FieldValue.increment",new FieldValue(delegate)},FieldValue.prototype.isEqual=function(other){return this._delegate.isEqual(other._delegate)},FieldValue}(),firestoreNamespace={Firestore:database04501227.Firestore,GeoPoint:database04501227.GeoPoint,Timestamp:database04501227.Timestamp,Blob:database04501227.Blob,Transaction:database04501227.Transaction,WriteBatch:database04501227.WriteBatch,DocumentReference:database04501227.DocumentReference,DocumentSnapshot:database04501227.DocumentSnapshot,Query:database04501227.Query,QueryDocumentSnapshot:database04501227.QueryDocumentSnapshot,QuerySnapshot:database04501227.QuerySnapshot,CollectionReference:database04501227.CollectionReference,FieldPath:FieldPath,FieldValue:FieldValue,setLogLevel:database04501227.setLogLevel,CACHE_SIZE_UNLIMITED:database04501227.CACHE_SIZE_UNLIMITED};function registerFirestore(instance){!function configureForFirebase(firebase,firestoreFactory){firebase.INTERNAL.registerComponent(new component.Component("firestore",function(container){var app=container.getProvider("app").getImmediate();return firestoreFactory(app,container.getProvider("auth-internal"))},"PUBLIC").setServiceProps(Object.assign({},firestoreNamespace)))}(instance,function(app,auth){return new database04501227.Firestore(app,new database04501227.FirebaseFirestore(app,auth),new database04501227.IndexedDbPersistenceProvider)}),instance.registerVersion("@firebase/firestore","2.3.8","node")}registerFirestore(firebase__default.default),exports.registerFirestore=registerFirestore},lWSR:function(module,exports,__webpack_require__){"use strict";module.exports=BufferReader;var Reader=__webpack_require__("IRA2");(BufferReader.prototype=Object.create(Reader.prototype)).constructor=BufferReader;var util=__webpack_require__("6Tgl");function BufferReader(buffer){Reader.call(this,buffer)}BufferReader._configure=function(){util.Buffer&&(BufferReader.prototype._slice=util.Buffer.prototype.slice)},BufferReader.prototype.string=function read_string_buffer(){var len=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+len,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+len,this.len))},BufferReader._configure()},lvRS:function(module,exports,__webpack_require__){"use strict";var ReadState;Object.defineProperty(exports,"__esModule",{value:!0}),exports.StreamDecoder=void 0,function(ReadState){ReadState[ReadState.NO_DATA=0]="NO_DATA",ReadState[ReadState.READING_SIZE=1]="READING_SIZE",ReadState[ReadState.READING_MESSAGE=2]="READING_MESSAGE"}(ReadState||(ReadState={}));exports.StreamDecoder=class{constructor(){this.readState=ReadState.NO_DATA,this.readCompressFlag=Buffer.alloc(1),this.readPartialSize=Buffer.alloc(4),this.readSizeRemaining=4,this.readMessageSize=0,this.readPartialMessage=[],this.readMessageRemaining=0}write(data){let toRead,readHead=0;const result=[];for(;readHead<data.length;)switch(this.readState){case ReadState.NO_DATA:this.readCompressFlag=data.slice(readHead,readHead+1),readHead+=1,this.readState=ReadState.READING_SIZE,this.readPartialSize.fill(0),this.readSizeRemaining=4,this.readMessageSize=0,this.readMessageRemaining=0,this.readPartialMessage=[];break;case ReadState.READING_SIZE:if(toRead=Math.min(data.length-readHead,this.readSizeRemaining),data.copy(this.readPartialSize,4-this.readSizeRemaining,readHead,readHead+toRead),this.readSizeRemaining-=toRead,readHead+=toRead,0===this.readSizeRemaining)if(this.readMessageSize=this.readPartialSize.readUInt32BE(0),this.readMessageRemaining=this.readMessageSize,this.readMessageRemaining>0)this.readState=ReadState.READING_MESSAGE;else{const message=Buffer.concat([this.readCompressFlag,this.readPartialSize],5);this.readState=ReadState.NO_DATA,result.push(message)}break;case ReadState.READING_MESSAGE:if(toRead=Math.min(data.length-readHead,this.readMessageRemaining),this.readPartialMessage.push(data.slice(readHead,readHead+toRead)),this.readMessageRemaining-=toRead,readHead+=toRead,0===this.readMessageRemaining){const framedMessageBuffers=[this.readCompressFlag,this.readPartialSize].concat(this.readPartialMessage),framedMessage=Buffer.concat(framedMessageBuffers,this.readMessageSize+5);this.readState=ReadState.NO_DATA,result.push(framedMessage)}break;default:throw new Error("Unexpected read state")}return result}}},m0OZ:function(__webpack_module__,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Headers",function(){return Headers}),__webpack_require__.d(__webpack_exports__,"Request",function(){return Request}),__webpack_require__.d(__webpack_exports__,"Response",function(){return Response}),__webpack_require__.d(__webpack_exports__,"FetchError",function(){return FetchError});var stream__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("msIP"),http__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("KEll"),url__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("bzos"),https__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("7WL4"),zlib__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("FMKJ");const Readable=stream__WEBPACK_IMPORTED_MODULE_0__.Readable,BUFFER=Symbol("buffer"),TYPE=Symbol("type");class Blob{constructor(){this[TYPE]="";const blobParts=arguments[0],options=arguments[1],buffers=[];let size=0;if(blobParts){const a=blobParts,length=Number(a.length);for(let i=0;i<length;i++){const element=a[i];let buffer;buffer=element instanceof Buffer?element:ArrayBuffer.isView(element)?Buffer.from(element.buffer,element.byteOffset,element.byteLength):element instanceof ArrayBuffer?Buffer.from(element):element instanceof Blob?element[BUFFER]:Buffer.from("string"==typeof element?element:String(element)),size+=buffer.length,buffers.push(buffer)}}this[BUFFER]=Buffer.concat(buffers);let type=options&&void 0!==options.type&&String(options.type).toLowerCase();type&&!/[^\u0020-\u007E]/.test(type)&&(this[TYPE]=type)}get size(){return this[BUFFER].length}get type(){return this[TYPE]}text(){return Promise.resolve(this[BUFFER].toString())}arrayBuffer(){const buf=this[BUFFER],ab=buf.buffer.slice(buf.byteOffset,buf.byteOffset+buf.byteLength);return Promise.resolve(ab)}stream(){const readable=new Readable;return readable._read=function(){},readable.push(this[BUFFER]),readable.push(null),readable}toString(){return"[object Blob]"}slice(){const size=this.size,start=arguments[0],end=arguments[1];let relativeStart,relativeEnd;relativeStart=void 0===start?0:start<0?Math.max(size+start,0):Math.min(start,size),relativeEnd=void 0===end?size:end<0?Math.max(size+end,0):Math.min(end,size);const span=Math.max(relativeEnd-relativeStart,0),slicedBuffer=this[BUFFER].slice(relativeStart,relativeStart+span),blob=new Blob([],{type:arguments[2]});return blob[BUFFER]=slicedBuffer,blob}}function FetchError(message,type,systemError){Error.call(this,message),this.message=message,this.type=type,systemError&&(this.code=this.errno=systemError.code),Error.captureStackTrace(this,this.constructor)}let convert;Object.defineProperties(Blob.prototype,{size:{enumerable:!0},type:{enumerable:!0},slice:{enumerable:!0}}),Object.defineProperty(Blob.prototype,Symbol.toStringTag,{value:"Blob",writable:!1,enumerable:!1,configurable:!0}),FetchError.prototype=Object.create(Error.prototype),FetchError.prototype.constructor=FetchError,FetchError.prototype.name="FetchError";try{convert=require("encoding").convert}catch(e){}const INTERNALS=Symbol("Body internals"),PassThrough=stream__WEBPACK_IMPORTED_MODULE_0__.PassThrough;function Body(body){var _this=this,_ref=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},_ref$size=_ref.size;let size=void 0===_ref$size?0:_ref$size;var _ref$timeout=_ref.timeout;let timeout=void 0===_ref$timeout?0:_ref$timeout;null==body?body=null:isURLSearchParams(body)?body=Buffer.from(body.toString()):isBlob(body)||Buffer.isBuffer(body)||("[object ArrayBuffer]"===Object.prototype.toString.call(body)?body=Buffer.from(body):ArrayBuffer.isView(body)?body=Buffer.from(body.buffer,body.byteOffset,body.byteLength):body instanceof stream__WEBPACK_IMPORTED_MODULE_0__||(body=Buffer.from(String(body)))),this[INTERNALS]={body:body,disturbed:!1,error:null},this.size=size,this.timeout=timeout,body instanceof stream__WEBPACK_IMPORTED_MODULE_0__&&body.on("error",function(err){const error="AbortError"===err.name?err:new FetchError(`Invalid response body while trying to fetch ${_this.url}: ${err.message}`,"system",err);_this[INTERNALS].error=error})}function consumeBody(){var _this4=this;if(this[INTERNALS].disturbed)return Body.Promise.reject(new TypeError(`body used already for: ${this.url}`));if(this[INTERNALS].disturbed=!0,this[INTERNALS].error)return Body.Promise.reject(this[INTERNALS].error);let body=this.body;if(null===body)return Body.Promise.resolve(Buffer.alloc(0));if(isBlob(body)&&(body=body.stream()),Buffer.isBuffer(body))return Body.Promise.resolve(body);if(!(body instanceof stream__WEBPACK_IMPORTED_MODULE_0__))return Body.Promise.resolve(Buffer.alloc(0));let accum=[],accumBytes=0,abort=!1;return new Body.Promise(function(resolve,reject){let resTimeout;_this4.timeout&&(resTimeout=setTimeout(function(){abort=!0,reject(new FetchError(`Response timeout while trying to fetch ${_this4.url} (over ${_this4.timeout}ms)`,"body-timeout"))},_this4.timeout)),body.on("error",function(err){"AbortError"===err.name?(abort=!0,reject(err)):reject(new FetchError(`Invalid response body while trying to fetch ${_this4.url}: ${err.message}`,"system",err))}),body.on("data",function(chunk){if(!abort&&null!==chunk){if(_this4.size&&accumBytes+chunk.length>_this4.size)return abort=!0,void reject(new FetchError(`content size at ${_this4.url} over limit: ${_this4.size}`,"max-size"));accumBytes+=chunk.length,accum.push(chunk)}}),body.on("end",function(){if(!abort){clearTimeout(resTimeout);try{resolve(Buffer.concat(accum,accumBytes))}catch(err){reject(new FetchError(`Could not create Buffer from response body for ${_this4.url}: ${err.message}`,"system",err))}}})})}function isURLSearchParams(obj){return"object"==typeof obj&&"function"==typeof obj.append&&"function"==typeof obj.delete&&"function"==typeof obj.get&&"function"==typeof obj.getAll&&"function"==typeof obj.has&&"function"==typeof obj.set&&("URLSearchParams"===obj.constructor.name||"[object URLSearchParams]"===Object.prototype.toString.call(obj)||"function"==typeof obj.sort)}function isBlob(obj){return"object"==typeof obj&&"function"==typeof obj.arrayBuffer&&"string"==typeof obj.type&&"function"==typeof obj.stream&&"function"==typeof obj.constructor&&"string"==typeof obj.constructor.name&&/^(Blob|File)$/.test(obj.constructor.name)&&/^(Blob|File)$/.test(obj[Symbol.toStringTag])}function clone(instance){let p1,p2,body=instance.body;if(instance.bodyUsed)throw new Error("cannot clone body after it is used");return body instanceof stream__WEBPACK_IMPORTED_MODULE_0__&&"function"!=typeof body.getBoundary&&(p1=new PassThrough,p2=new PassThrough,body.pipe(p1),body.pipe(p2),instance[INTERNALS].body=p1,body=p2),body}function extractContentType(body){return null===body?null:"string"==typeof body?"text/plain;charset=UTF-8":isURLSearchParams(body)?"application/x-www-form-urlencoded;charset=UTF-8":isBlob(body)?body.type||null:Buffer.isBuffer(body)||"[object ArrayBuffer]"===Object.prototype.toString.call(body)||ArrayBuffer.isView(body)?null:"function"==typeof body.getBoundary?`multipart/form-data;boundary=${body.getBoundary()}`:body instanceof stream__WEBPACK_IMPORTED_MODULE_0__?null:"text/plain;charset=UTF-8"}function getTotalBytes(instance){const body=instance.body;return null===body?0:isBlob(body)?body.size:Buffer.isBuffer(body)?body.length:body&&"function"==typeof body.getLengthSync&&(body._lengthRetrievers&&0==body._lengthRetrievers.length||body.hasKnownLength&&body.hasKnownLength())?body.getLengthSync():null}Body.prototype={get body(){return this[INTERNALS].body},get bodyUsed(){return this[INTERNALS].disturbed},arrayBuffer(){return consumeBody.call(this).then(function(buf){return buf.buffer.slice(buf.byteOffset,buf.byteOffset+buf.byteLength)})},blob(){let ct=this.headers&&this.headers.get("content-type")||"";return consumeBody.call(this).then(function(buf){return Object.assign(new Blob([],{type:ct.toLowerCase()}),{[BUFFER]:buf})})},json(){var _this2=this;return consumeBody.call(this).then(function(buffer){try{return JSON.parse(buffer.toString())}catch(err){return Body.Promise.reject(new FetchError(`invalid json response body at ${_this2.url} reason: ${err.message}`,"invalid-json"))}})},text(){return consumeBody.call(this).then(function(buffer){return buffer.toString()})},buffer(){return consumeBody.call(this)},textConverted(){var _this3=this;return consumeBody.call(this).then(function(buffer){return function convertBody(buffer,headers){if("function"!=typeof convert)throw new Error("The package `encoding` must be installed to use the textConverted() function");const ct=headers.get("content-type");let res,str,charset="utf-8";ct&&(res=/charset=([^;]*)/i.exec(ct));str=buffer.slice(0,1024).toString(),!res&&str&&(res=/<meta.+?charset=(['"])(.+?)\1/i.exec(str));!res&&str&&(res=/<meta[\s]+?http-equiv=(['"])content-type\1[\s]+?content=(['"])(.+?)\2/i.exec(str),res||(res=/<meta[\s]+?content=(['"])(.+?)\1[\s]+?http-equiv=(['"])content-type\3/i.exec(str),res&&res.pop()),res&&(res=/charset=(.*)/i.exec(res.pop())));!res&&str&&(res=/<\?xml.+?encoding=(['"])(.+?)\1/i.exec(str));res&&(charset=res.pop(),"gb2312"!==charset&&"gbk"!==charset||(charset="gb18030"));return convert(buffer,"UTF-8",charset).toString()}(buffer,_this3.headers)})}},Object.defineProperties(Body.prototype,{body:{enumerable:!0},bodyUsed:{enumerable:!0},arrayBuffer:{enumerable:!0},blob:{enumerable:!0},json:{enumerable:!0},text:{enumerable:!0}}),Body.mixIn=function(proto){for(const name of Object.getOwnPropertyNames(Body.prototype))if(!(name in proto)){const desc=Object.getOwnPropertyDescriptor(Body.prototype,name);Object.defineProperty(proto,name,desc)}},Body.Promise=global.Promise;const invalidTokenRegex=/[^\^_`a-zA-Z\-0-9!#$%&'*+.|~]/,invalidHeaderCharRegex=/[^\t\x20-\x7e\x80-\xff]/;function validateName(name){if(name=`${name}`,invalidTokenRegex.test(name)||""===name)throw new TypeError(`${name} is not a legal HTTP header name`)}function validateValue(value){if(value=`${value}`,invalidHeaderCharRegex.test(value))throw new TypeError(`${value} is not a legal HTTP header value`)}function find(map,name){name=name.toLowerCase();for(const key in map)if(key.toLowerCase()===name)return key}const MAP=Symbol("map");class Headers{constructor(){let init=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0;if(this[MAP]=Object.create(null),init instanceof Headers){const rawHeaders=init.raw(),headerNames=Object.keys(rawHeaders);for(const headerName of headerNames)for(const value of rawHeaders[headerName])this.append(headerName,value)}else if(null==init);else{if("object"!=typeof init)throw new TypeError("Provided initializer must be an object");{const method=init[Symbol.iterator];if(null!=method){if("function"!=typeof method)throw new TypeError("Header pairs must be iterable");const pairs=[];for(const pair of init){if("object"!=typeof pair||"function"!=typeof pair[Symbol.iterator])throw new TypeError("Each header pair must be iterable");pairs.push(Array.from(pair))}for(const pair of pairs){if(2!==pair.length)throw new TypeError("Each header pair must be a name/value tuple");this.append(pair[0],pair[1])}}else for(const key of Object.keys(init)){const value=init[key];this.append(key,value)}}}}get(name){validateName(name=`${name}`);const key=find(this[MAP],name);return void 0===key?null:this[MAP][key].join(", ")}forEach(callback){let thisArg=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,pairs=getHeaders(this),i=0;for(;i<pairs.length;){var _pairs$i=pairs[i];const name=_pairs$i[0],value=_pairs$i[1];callback.call(thisArg,value,name,this),pairs=getHeaders(this),i++}}set(name,value){value=`${value}`,validateName(name=`${name}`),validateValue(value);const key=find(this[MAP],name);this[MAP][void 0!==key?key:name]=[value]}append(name,value){value=`${value}`,validateName(name=`${name}`),validateValue(value);const key=find(this[MAP],name);void 0!==key?this[MAP][key].push(value):this[MAP][name]=[value]}has(name){return validateName(name=`${name}`),void 0!==find(this[MAP],name)}delete(name){validateName(name=`${name}`);const key=find(this[MAP],name);void 0!==key&&delete this[MAP][key]}raw(){return this[MAP]}keys(){return createHeadersIterator(this,"key")}values(){return createHeadersIterator(this,"value")}[Symbol.iterator](){return createHeadersIterator(this,"key+value")}}function getHeaders(headers){let kind=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"key+value";const keys=Object.keys(headers[MAP]).sort();return keys.map("key"===kind?function(k){return k.toLowerCase()}:"value"===kind?function(k){return headers[MAP][k].join(", ")}:function(k){return[k.toLowerCase(),headers[MAP][k].join(", ")]})}Headers.prototype.entries=Headers.prototype[Symbol.iterator],Object.defineProperty(Headers.prototype,Symbol.toStringTag,{value:"Headers",writable:!1,enumerable:!1,configurable:!0}),Object.defineProperties(Headers.prototype,{get:{enumerable:!0},forEach:{enumerable:!0},set:{enumerable:!0},append:{enumerable:!0},has:{enumerable:!0},delete:{enumerable:!0},keys:{enumerable:!0},values:{enumerable:!0},entries:{enumerable:!0}});const INTERNAL=Symbol("internal");function createHeadersIterator(target,kind){const iterator=Object.create(HeadersIteratorPrototype);return iterator[INTERNAL]={target:target,kind:kind,index:0},iterator}const HeadersIteratorPrototype=Object.setPrototypeOf({next(){if(!this||Object.getPrototypeOf(this)!==HeadersIteratorPrototype)throw new TypeError("Value of `this` is not a HeadersIterator");var _INTERNAL=this[INTERNAL];const target=_INTERNAL.target,kind=_INTERNAL.kind,index=_INTERNAL.index,values=getHeaders(target,kind);return index>=values.length?{value:void 0,done:!0}:(this[INTERNAL].index=index+1,{value:values[index],done:!1})}},Object.getPrototypeOf(Object.getPrototypeOf([][Symbol.iterator]())));function exportNodeCompatibleHeaders(headers){const obj=Object.assign({__proto__:null},headers[MAP]),hostHeaderKey=find(headers[MAP],"Host");return void 0!==hostHeaderKey&&(obj[hostHeaderKey]=obj[hostHeaderKey][0]),obj}Object.defineProperty(HeadersIteratorPrototype,Symbol.toStringTag,{value:"HeadersIterator",writable:!1,enumerable:!1,configurable:!0});const INTERNALS$1=Symbol("Response internals"),STATUS_CODES=http__WEBPACK_IMPORTED_MODULE_1__.STATUS_CODES;class Response{constructor(){let body=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,opts=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Body.call(this,body,opts);const status=opts.status||200,headers=new Headers(opts.headers);if(null!=body&&!headers.has("Content-Type")){const contentType=extractContentType(body);contentType&&headers.append("Content-Type",contentType)}this[INTERNALS$1]={url:opts.url,status:status,statusText:opts.statusText||STATUS_CODES[status],headers:headers,counter:opts.counter}}get url(){return this[INTERNALS$1].url||""}get status(){return this[INTERNALS$1].status}get ok(){return this[INTERNALS$1].status>=200&&this[INTERNALS$1].status<300}get redirected(){return this[INTERNALS$1].counter>0}get statusText(){return this[INTERNALS$1].statusText}get headers(){return this[INTERNALS$1].headers}clone(){return new Response(clone(this),{url:this.url,status:this.status,statusText:this.statusText,headers:this.headers,ok:this.ok,redirected:this.redirected})}}Body.mixIn(Response.prototype),Object.defineProperties(Response.prototype,{url:{enumerable:!0},status:{enumerable:!0},ok:{enumerable:!0},redirected:{enumerable:!0},statusText:{enumerable:!0},headers:{enumerable:!0},clone:{enumerable:!0}}),Object.defineProperty(Response.prototype,Symbol.toStringTag,{value:"Response",writable:!1,enumerable:!1,configurable:!0});const INTERNALS$2=Symbol("Request internals"),parse_url=url__WEBPACK_IMPORTED_MODULE_2__.parse,format_url=url__WEBPACK_IMPORTED_MODULE_2__.format,streamDestructionSupported="destroy"in stream__WEBPACK_IMPORTED_MODULE_0__.Readable.prototype;function isRequest(input){return"object"==typeof input&&"object"==typeof input[INTERNALS$2]}class Request{constructor(input){let parsedURL,init=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};isRequest(input)?parsedURL=parse_url(input.url):(parsedURL=input&&input.href?parse_url(input.href):parse_url(`${input}`),input={});let method=init.method||input.method||"GET";if(method=method.toUpperCase(),(null!=init.body||isRequest(input)&&null!==input.body)&&("GET"===method||"HEAD"===method))throw new TypeError("Request with GET/HEAD method cannot have body");let inputBody=null!=init.body?init.body:isRequest(input)&&null!==input.body?clone(input):null;Body.call(this,inputBody,{timeout:init.timeout||input.timeout||0,size:init.size||input.size||0});const headers=new Headers(init.headers||input.headers||{});if(null!=inputBody&&!headers.has("Content-Type")){const contentType=extractContentType(inputBody);contentType&&headers.append("Content-Type",contentType)}let signal=isRequest(input)?input.signal:null;if("signal"in init&&(signal=init.signal),null!=signal&&!function isAbortSignal(signal){const proto=signal&&"object"==typeof signal&&Object.getPrototypeOf(signal);return!(!proto||"AbortSignal"!==proto.constructor.name)}(signal))throw new TypeError("Expected signal to be an instanceof AbortSignal");this[INTERNALS$2]={method:method,redirect:init.redirect||input.redirect||"follow",headers:headers,parsedURL:parsedURL,signal:signal},this.follow=void 0!==init.follow?init.follow:void 0!==input.follow?input.follow:20,this.compress=void 0!==init.compress?init.compress:void 0===input.compress||input.compress,this.counter=init.counter||input.counter||0,this.agent=init.agent||input.agent}get method(){return this[INTERNALS$2].method}get url(){return format_url(this[INTERNALS$2].parsedURL)}get headers(){return this[INTERNALS$2].headers}get redirect(){return this[INTERNALS$2].redirect}get signal(){return this[INTERNALS$2].signal}clone(){return new Request(this)}}function AbortError(message){Error.call(this,message),this.type="aborted",this.message=message,Error.captureStackTrace(this,this.constructor)}Body.mixIn(Request.prototype),Object.defineProperty(Request.prototype,Symbol.toStringTag,{value:"Request",writable:!1,enumerable:!1,configurable:!0}),Object.defineProperties(Request.prototype,{method:{enumerable:!0},url:{enumerable:!0},headers:{enumerable:!0},redirect:{enumerable:!0},clone:{enumerable:!0},signal:{enumerable:!0}}),AbortError.prototype=Object.create(Error.prototype),AbortError.prototype.constructor=AbortError,AbortError.prototype.name="AbortError";const PassThrough$1=stream__WEBPACK_IMPORTED_MODULE_0__.PassThrough,resolve_url=url__WEBPACK_IMPORTED_MODULE_2__.resolve;function fetch(url,opts){if(!fetch.Promise)throw new Error("native promise missing, set fetch.Promise to your favorite alternative");return Body.Promise=fetch.Promise,new fetch.Promise(function(resolve,reject){const request=new Request(url,opts),options=function getNodeRequestOptions(request){const parsedURL=request[INTERNALS$2].parsedURL,headers=new Headers(request[INTERNALS$2].headers);if(headers.has("Accept")||headers.set("Accept","*/*"),!parsedURL.protocol||!parsedURL.hostname)throw new TypeError("Only absolute URLs are supported");if(!/^https?:$/.test(parsedURL.protocol))throw new TypeError("Only HTTP(S) protocols are supported");if(request.signal&&request.body instanceof stream__WEBPACK_IMPORTED_MODULE_0__.Readable&&!streamDestructionSupported)throw new Error("Cancellation of streamed requests with AbortSignal is not supported in node < 8");let contentLengthValue=null;if(null==request.body&&/^(POST|PUT)$/i.test(request.method)&&(contentLengthValue="0"),null!=request.body){const totalBytes=getTotalBytes(request);"number"==typeof totalBytes&&(contentLengthValue=String(totalBytes))}contentLengthValue&&headers.set("Content-Length",contentLengthValue),headers.has("User-Agent")||headers.set("User-Agent","node-fetch/1.0 (+https://github.com/bitinn/node-fetch)"),request.compress&&!headers.has("Accept-Encoding")&&headers.set("Accept-Encoding","gzip,deflate");let agent=request.agent;return"function"==typeof agent&&(agent=agent(parsedURL)),headers.has("Connection")||agent||headers.set("Connection","close"),Object.assign({},parsedURL,{method:request.method,headers:exportNodeCompatibleHeaders(headers),agent:agent})}(request),send=("https:"===options.protocol?https__WEBPACK_IMPORTED_MODULE_3__:http__WEBPACK_IMPORTED_MODULE_1__).request,signal=request.signal;let response=null;const abort=function abort(){let error=new AbortError("The user aborted a request.");reject(error),request.body&&request.body instanceof stream__WEBPACK_IMPORTED_MODULE_0__.Readable&&request.body.destroy(error),response&&response.body&&response.body.emit("error",error)};if(signal&&signal.aborted)return void abort();const abortAndFinalize=function abortAndFinalize(){abort(),finalize()},req=send(options);let reqTimeout;function finalize(){req.abort(),signal&&signal.removeEventListener("abort",abortAndFinalize),clearTimeout(reqTimeout)}signal&&signal.addEventListener("abort",abortAndFinalize),request.timeout&&req.once("socket",function(socket){reqTimeout=setTimeout(function(){reject(new FetchError(`network timeout at: ${request.url}`,"request-timeout")),finalize()},request.timeout)}),req.on("error",function(err){reject(new FetchError(`request to ${request.url} failed, reason: ${err.message}`,"system",err)),finalize()}),req.on("response",function(res){clearTimeout(reqTimeout);const headers=function createHeadersLenient(obj){const headers=new Headers;for(const name of Object.keys(obj))if(!invalidTokenRegex.test(name))if(Array.isArray(obj[name]))for(const val of obj[name])invalidHeaderCharRegex.test(val)||(void 0===headers[MAP][name]?headers[MAP][name]=[val]:headers[MAP][name].push(val));else invalidHeaderCharRegex.test(obj[name])||(headers[MAP][name]=[obj[name]]);return headers}(res.headers);if(fetch.isRedirect(res.statusCode)){const location=headers.get("Location"),locationURL=null===location?null:resolve_url(request.url,location);switch(request.redirect){case"error":return reject(new FetchError(`uri requested responds with a redirect, redirect mode is set to error: ${request.url}`,"no-redirect")),void finalize();case"manual":if(null!==locationURL)try{headers.set("Location",locationURL)}catch(err){reject(err)}break;case"follow":if(null===locationURL)break;if(request.counter>=request.follow)return reject(new FetchError(`maximum redirect reached at: ${request.url}`,"max-redirect")),void finalize();const requestOpts={headers:new Headers(request.headers),follow:request.follow,counter:request.counter+1,agent:request.agent,compress:request.compress,method:request.method,body:request.body,signal:request.signal,timeout:request.timeout,size:request.size};return 303!==res.statusCode&&request.body&&null===getTotalBytes(request)?(reject(new FetchError("Cannot follow redirect with body being a readable stream","unsupported-redirect")),void finalize()):(303!==res.statusCode&&(301!==res.statusCode&&302!==res.statusCode||"POST"!==request.method)||(requestOpts.method="GET",requestOpts.body=void 0,requestOpts.headers.delete("content-length")),resolve(fetch(new Request(locationURL,requestOpts))),void finalize())}}res.once("end",function(){signal&&signal.removeEventListener("abort",abortAndFinalize)});let body=res.pipe(new PassThrough$1);const response_options={url:request.url,status:res.statusCode,statusText:res.statusMessage,headers:headers,size:request.size,timeout:request.timeout,counter:request.counter},codings=headers.get("Content-Encoding");if(!request.compress||"HEAD"===request.method||null===codings||204===res.statusCode||304===res.statusCode)return response=new Response(body,response_options),void resolve(response);const zlibOptions={flush:zlib__WEBPACK_IMPORTED_MODULE_4__.Z_SYNC_FLUSH,finishFlush:zlib__WEBPACK_IMPORTED_MODULE_4__.Z_SYNC_FLUSH};if("gzip"==codings||"x-gzip"==codings)return body=body.pipe(zlib__WEBPACK_IMPORTED_MODULE_4__.createGunzip(zlibOptions)),response=new Response(body,response_options),void resolve(response);if("deflate"!=codings&&"x-deflate"!=codings){if("br"==codings&&"function"==typeof zlib__WEBPACK_IMPORTED_MODULE_4__.createBrotliDecompress)return body=body.pipe(zlib__WEBPACK_IMPORTED_MODULE_4__.createBrotliDecompress()),response=new Response(body,response_options),void resolve(response);response=new Response(body,response_options),resolve(response)}else{res.pipe(new PassThrough$1).once("data",function(chunk){body=8==(15&chunk[0])?body.pipe(zlib__WEBPACK_IMPORTED_MODULE_4__.createInflate()):body.pipe(zlib__WEBPACK_IMPORTED_MODULE_4__.createInflateRaw()),response=new Response(body,response_options),resolve(response)})}}),function writeToStream(dest,instance){const body=instance.body;null===body?dest.end():isBlob(body)?body.stream().pipe(dest):Buffer.isBuffer(body)?(dest.write(body),dest.end()):body.pipe(dest)}(req,request)})}fetch.isRedirect=function(code){return 301===code||302===code||303===code||307===code||308===code},fetch.Promise=global.Promise,__webpack_exports__.default=fetch},m7sO:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Metadata=void 0;const logging_1=__webpack_require__("xQiD"),constants_1=__webpack_require__("8o9P"),LEGAL_KEY_REGEX=/^[0-9a-z_.-]+$/,LEGAL_NON_BINARY_VALUE_REGEX=/^[ -~]*$/;function isBinaryKey(key){return key.endsWith("-bin")}function normalizeKey(key){return key.toLowerCase()}function validate(key,value){if(!function isLegalKey(key){return LEGAL_KEY_REGEX.test(key)}(key))throw new Error('Metadata key "'+key+'" contains illegal characters');if(null!=value)if(isBinaryKey(key)){if(!(value instanceof Buffer))throw new Error("keys that end with '-bin' must have Buffer values")}else{if(value instanceof Buffer)throw new Error("keys that don't end with '-bin' must have String values");if(!function isLegalNonBinaryValue(value){return LEGAL_NON_BINARY_VALUE_REGEX.test(value)}(value))throw new Error('Metadata string value "'+value+'" contains illegal characters')}}class Metadata{constructor(options){this.internalRepr=new Map,this.options=void 0===options?{}:options}set(key,value){validate(key=normalizeKey(key),value),this.internalRepr.set(key,[value])}add(key,value){validate(key=normalizeKey(key),value);const existingValue=this.internalRepr.get(key);void 0===existingValue?this.internalRepr.set(key,[value]):existingValue.push(value)}remove(key){validate(key=normalizeKey(key)),this.internalRepr.delete(key)}get(key){return validate(key=normalizeKey(key)),this.internalRepr.get(key)||[]}getMap(){const result={};return this.internalRepr.forEach((values,key)=>{if(values.length>0){const v=values[0];result[key]=v instanceof Buffer?v.slice():v}}),result}clone(){const newMetadata=new Metadata(this.options),newInternalRepr=newMetadata.internalRepr;return this.internalRepr.forEach((value,key)=>{const clonedValue=value.map(v=>v instanceof Buffer?Buffer.from(v):v);newInternalRepr.set(key,clonedValue)}),newMetadata}merge(other){other.internalRepr.forEach((values,key)=>{const mergedValue=(this.internalRepr.get(key)||[]).concat(values);this.internalRepr.set(key,mergedValue)})}setOptions(options){this.options=options}getOptions(){return this.options}toHttp2Headers(){const result={};return this.internalRepr.forEach((values,key)=>{result[key]=values.map(value=>value instanceof Buffer?value.toString("base64"):value)}),result}_getCoreRepresentation(){return this.internalRepr}static fromHttp2Headers(headers){const result=new Metadata;return Object.keys(headers).forEach(key=>{if(":"===key.charAt(0))return;const values=headers[key];try{isBinaryKey(key)?Array.isArray(values)?values.forEach(value=>{result.add(key,Buffer.from(value,"base64"))}):void 0!==values&&(!function isCustomMetadata(key){return!key.startsWith("grpc-")}(key)?result.add(key,Buffer.from(values,"base64")):values.split(",").forEach(v=>{result.add(key,Buffer.from(v.trim(),"base64"))})):Array.isArray(values)?values.forEach(value=>{result.add(key,value)}):void 0!==values&&result.add(key,values)}catch(error){const message=`Failed to add metadata entry ${key}: ${values}. ${error.message}. For more information see https://github.com/grpc/grpc-node/issues/1173`;logging_1.log(constants_1.LogVerbosity.ERROR,message)}}),result}}exports.Metadata=Metadata},mVN3:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.QueuePicker=exports.UnavailablePicker=exports.PickResultType=void 0;const metadata_1=__webpack_require__("m7sO"),constants_1=__webpack_require__("8o9P");var PickResultType;!function(PickResultType){PickResultType[PickResultType.COMPLETE=0]="COMPLETE",PickResultType[PickResultType.QUEUE=1]="QUEUE",PickResultType[PickResultType.TRANSIENT_FAILURE=2]="TRANSIENT_FAILURE",PickResultType[PickResultType.DROP=3]="DROP"}(PickResultType=exports.PickResultType||(exports.PickResultType={}));exports.UnavailablePicker=class{constructor(status){this.status=void 0!==status?status:{code:constants_1.Status.UNAVAILABLE,details:"No connection established",metadata:new metadata_1.Metadata}}pick(pickArgs){return{pickResultType:PickResultType.TRANSIENT_FAILURE,subchannel:null,status:this.status,extraFilterFactory:null,onCallStarted:null}}};exports.QueuePicker=class{constructor(loadBalancer){this.loadBalancer=loadBalancer,this.calledExitIdle=!1}pick(pickArgs){return this.calledExitIdle||(process.nextTick(()=>{this.loadBalancer.exitIdle()}),this.calledExitIdle=!0),{pickResultType:PickResultType.QUEUE,subchannel:null,status:null,extraFilterFactory:null,onCallStarted:null}}}},mr48:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ChannelCredentials=void 0;const tls_1=__webpack_require__("ugmf"),call_credentials_1=__webpack_require__("y+4D"),tls_helpers_1=__webpack_require__("CelR");function verifyIsBufferOrNull(obj,friendlyName){if(obj&&!(obj instanceof Buffer))throw new TypeError(`${friendlyName}, if provided, must be a Buffer.`)}function bufferOrNullEqual(buf1,buf2){return null===buf1&&null===buf2||null!==buf1&&null!==buf2&&buf1.equals(buf2)}class ChannelCredentials{constructor(callCredentials){this.callCredentials=callCredentials||call_credentials_1.CallCredentials.createEmpty()}_getCallCredentials(){return this.callCredentials}static createSsl(rootCerts,privateKey,certChain,verifyOptions){if(verifyIsBufferOrNull(rootCerts,"Root certificate"),verifyIsBufferOrNull(privateKey,"Private key"),verifyIsBufferOrNull(certChain,"Certificate chain"),privateKey&&!certChain)throw new Error("Private key must be given with accompanying certificate chain");if(!privateKey&&certChain)throw new Error("Certificate chain must be given with accompanying private key");return new SecureChannelCredentialsImpl(rootCerts||tls_helpers_1.getDefaultRootsData(),privateKey||null,certChain||null,verifyOptions||{})}static createInsecure(){return new InsecureChannelCredentialsImpl}}exports.ChannelCredentials=ChannelCredentials;class InsecureChannelCredentialsImpl extends ChannelCredentials{constructor(callCredentials){super(callCredentials)}compose(callCredentials){throw new Error("Cannot compose insecure credentials")}_getConnectionOptions(){return null}_isSecure(){return!1}_equals(other){return other instanceof InsecureChannelCredentialsImpl}}class SecureChannelCredentialsImpl extends ChannelCredentials{constructor(rootCerts,privateKey,certChain,verifyOptions){super(),this.rootCerts=rootCerts,this.privateKey=privateKey,this.certChain=certChain,this.verifyOptions=verifyOptions;const secureContext=tls_1.createSecureContext({ca:rootCerts||void 0,key:privateKey||void 0,cert:certChain||void 0,ciphers:tls_helpers_1.CIPHER_SUITES});this.connectionOptions={secureContext:secureContext},verifyOptions&&verifyOptions.checkServerIdentity&&(this.connectionOptions.checkServerIdentity=(host,cert)=>verifyOptions.checkServerIdentity(host,{raw:cert.raw}))}compose(callCredentials){const combinedCallCredentials=this.callCredentials.compose(callCredentials);return new ComposedChannelCredentialsImpl(this,combinedCallCredentials)}_getConnectionOptions(){return Object.assign({},this.connectionOptions)}_isSecure(){return!0}_equals(other){return this===other||other instanceof SecureChannelCredentialsImpl&&(!!bufferOrNullEqual(this.rootCerts,other.rootCerts)&&(!!bufferOrNullEqual(this.privateKey,other.privateKey)&&(!!bufferOrNullEqual(this.certChain,other.certChain)&&this.verifyOptions.checkServerIdentity===other.verifyOptions.checkServerIdentity)))}}class ComposedChannelCredentialsImpl extends ChannelCredentials{constructor(channelCredentials,callCreds){super(callCreds),this.channelCredentials=channelCredentials}compose(callCredentials){const combinedCallCredentials=this.callCredentials.compose(callCredentials);return new ComposedChannelCredentialsImpl(this.channelCredentials,combinedCallCredentials)}_getConnectionOptions(){return this.channelCredentials._getConnectionOptions()}_isSecure(){return!0}_equals(other){return this===other||other instanceof ComposedChannelCredentialsImpl&&(this.channelCredentials._equals(other.channelCredentials)&&this.callCredentials._equals(other.callCredentials))}}},nC4N:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BaseFilter=void 0;exports.BaseFilter=class{async sendMetadata(metadata){return metadata}receiveMetadata(metadata){return metadata}async sendMessage(message){return message}async receiveMessage(message){return message}receiveTrailers(status){return status}}},o4Qh:function(module,exports,__webpack_require__){"use strict";module.exports=LongBits;var util=__webpack_require__("6Tgl");function LongBits(lo,hi){this.lo=lo>>>0,this.hi=hi>>>0}var zero=LongBits.zero=new LongBits(0,0);zero.toNumber=function(){return 0},zero.zzEncode=zero.zzDecode=function(){return this},zero.length=function(){return 1};var zeroHash=LongBits.zeroHash="\0\0\0\0\0\0\0\0";LongBits.fromNumber=function fromNumber(value){if(0===value)return zero;var sign=value<0;sign&&(value=-value);var lo=value>>>0,hi=(value-lo)/4294967296>>>0;return sign&&(hi=~hi>>>0,lo=~lo>>>0,++lo>4294967295&&(lo=0,++hi>4294967295&&(hi=0))),new LongBits(lo,hi)},LongBits.from=function from(value){if("number"==typeof value)return LongBits.fromNumber(value);if(util.isString(value)){if(!util.Long)return LongBits.fromNumber(parseInt(value,10));value=util.Long.fromString(value)}return value.low||value.high?new LongBits(value.low>>>0,value.high>>>0):zero},LongBits.prototype.toNumber=function toNumber(unsigned){if(!unsigned&&this.hi>>>31){var lo=1+~this.lo>>>0,hi=~this.hi>>>0;return lo||(hi=hi+1>>>0),-(lo+4294967296*hi)}return this.lo+4294967296*this.hi},LongBits.prototype.toLong=function toLong(unsigned){return util.Long?new util.Long(0|this.lo,0|this.hi,Boolean(unsigned)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(unsigned)}};var charCodeAt=String.prototype.charCodeAt;LongBits.fromHash=function fromHash(hash){return hash===zeroHash?zero:new LongBits((charCodeAt.call(hash,0)|charCodeAt.call(hash,1)<<8|charCodeAt.call(hash,2)<<16|charCodeAt.call(hash,3)<<24)>>>0,(charCodeAt.call(hash,4)|charCodeAt.call(hash,5)<<8|charCodeAt.call(hash,6)<<16|charCodeAt.call(hash,7)<<24)>>>0)},LongBits.prototype.toHash=function toHash(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},LongBits.prototype.zzEncode=function zzEncode(){var mask=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^mask)>>>0,this.lo=(this.lo<<1^mask)>>>0,this},LongBits.prototype.zzDecode=function zzDecode(){var mask=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^mask)>>>0,this.hi=(this.hi>>>1^mask)>>>0,this},LongBits.prototype.length=function length(){var part0=this.lo,part1=(this.lo>>>28|this.hi<<4)>>>0,part2=this.hi>>>24;return 0===part2?0===part1?part0<16384?part0<128?1:2:part0<2097152?3:4:part1<16384?part1<128?5:6:part1<2097152?7:8:part2<128?9:10}},oA4V:function(module,exports,__webpack_require__){"use strict";module.exports=common;var timeType,commonRe=/\/|\./;function common(name,json){commonRe.test(name)||(name="google/protobuf/"+name+".proto",json={nested:{google:{nested:{protobuf:{nested:json}}}}}),common[name]=json}common("any",{Any:{fields:{type_url:{type:"string",id:1},value:{type:"bytes",id:2}}}}),common("duration",{Duration:timeType={fields:{seconds:{type:"int64",id:1},nanos:{type:"int32",id:2}}}}),common("timestamp",{Timestamp:timeType}),common("empty",{Empty:{fields:{}}}),common("struct",{Struct:{fields:{fields:{keyType:"string",type:"Value",id:1}}},Value:{oneofs:{kind:{oneof:["nullValue","numberValue","stringValue","boolValue","structValue","listValue"]}},fields:{nullValue:{type:"NullValue",id:1},numberValue:{type:"double",id:2},stringValue:{type:"string",id:3},boolValue:{type:"bool",id:4},structValue:{type:"Struct",id:5},listValue:{type:"ListValue",id:6}}},NullValue:{values:{NULL_VALUE:0}},ListValue:{fields:{values:{rule:"repeated",type:"Value",id:1}}}}),common("wrappers",{DoubleValue:{fields:{value:{type:"double",id:1}}},FloatValue:{fields:{value:{type:"float",id:1}}},Int64Value:{fields:{value:{type:"int64",id:1}}},UInt64Value:{fields:{value:{type:"uint64",id:1}}},Int32Value:{fields:{value:{type:"int32",id:1}}},UInt32Value:{fields:{value:{type:"uint32",id:1}}},BoolValue:{fields:{value:{type:"bool",id:1}}},StringValue:{fields:{value:{type:"string",id:1}}},BytesValue:{fields:{value:{type:"bytes",id:1}}}}),common("field_mask",{FieldMask:{fields:{paths:{rule:"repeated",type:"string",id:1}}}}),common.get=function get(file){return common[file]||null}},p2ao:function(module,exports,__webpack_require__){"use strict";module.exports=tokenize;var delimRe=/[\s{}=;:[\],'"()<>]/g,stringDoubleRe=/(?:"([^"\\]*(?:\\.[^"\\]*)*)")/g,stringSingleRe=/(?:'([^'\\]*(?:\\.[^'\\]*)*)')/g,setCommentRe=/^ *[*/]+ */,setCommentAltRe=/^\s*\*?\/*/,setCommentSplitRe=/\n/g,whitespaceRe=/\s/,unescapeRe=/\\(.?)/g,unescapeMap={0:"\0",r:"\r",n:"\n",t:"\t"};function unescape(str){return str.replace(unescapeRe,function($0,$1){switch($1){case"\\":case"":return $1;default:return unescapeMap[$1]||""}})}function tokenize(source,alternateCommentMode){source=source.toString();var offset=0,length=source.length,line=1,commentType=null,commentText=null,commentLine=0,commentLineEmpty=!1,commentIsLeading=!1,stack=[],stringDelim=null;function illegal(subject){return Error("illegal "+subject+" (line "+line+")")}function charAt(pos){return source.charAt(pos)}function setComment(start,end,isLeading){commentType=source.charAt(start++),commentLine=line,commentLineEmpty=!1,commentIsLeading=isLeading;var c,commentOffset=start-(alternateCommentMode?2:3);do{if(--commentOffset<0||"\n"===(c=source.charAt(commentOffset))){commentLineEmpty=!0;break}}while(" "===c||"\t"===c);for(var lines=source.substring(start,end).split(setCommentSplitRe),i=0;i<lines.length;++i)lines[i]=lines[i].replace(alternateCommentMode?setCommentAltRe:setCommentRe,"").trim();commentText=lines.join("\n").trim()}function isDoubleSlashCommentLine(startOffset){var endOffset=findEndOfLine(startOffset),lineText=source.substring(startOffset,endOffset);return/^\s*\/{1,2}/.test(lineText)}function findEndOfLine(cursor){for(var endOffset=cursor;endOffset<length&&"\n"!==charAt(endOffset);)endOffset++;return endOffset}function next(){if(stack.length>0)return stack.shift();if(stringDelim)return function readString(){var re="'"===stringDelim?stringSingleRe:stringDoubleRe;re.lastIndex=offset-1;var match=re.exec(source);if(!match)throw illegal("string");return offset=re.lastIndex,push(stringDelim),stringDelim=null,unescape(match[1])}();var repeat,prev,curr,start,isDoc,isLeadingComment=0===offset;do{if(offset===length)return null;for(repeat=!1;whitespaceRe.test(curr=charAt(offset));)if("\n"===curr&&(isLeadingComment=!0,++line),++offset===length)return null;if("/"===charAt(offset)){if(++offset===length)throw illegal("comment");if("/"===charAt(offset))if(alternateCommentMode){if(start=offset,isDoc=!1,isDoubleSlashCommentLine(offset)){isDoc=!0;do{if((offset=findEndOfLine(offset))===length)break;offset++}while(isDoubleSlashCommentLine(offset))}else offset=Math.min(length,findEndOfLine(offset)+1);isDoc&&setComment(start,offset,isLeadingComment),line++,repeat=!0}else{for(isDoc="/"===charAt(start=offset+1);"\n"!==charAt(++offset);)if(offset===length)return null;++offset,isDoc&&setComment(start,offset-1,isLeadingComment),++line,repeat=!0}else{if("*"!==(curr=charAt(offset)))return"/";start=offset+1,isDoc=alternateCommentMode||"*"===charAt(start);do{if("\n"===curr&&++line,++offset===length)throw illegal("comment");prev=curr,curr=charAt(offset)}while("*"!==prev||"/"!==curr);++offset,isDoc&&setComment(start,offset-2,isLeadingComment),repeat=!0}}}while(repeat);var end=offset;if(delimRe.lastIndex=0,!delimRe.test(charAt(end++)))for(;end<length&&!delimRe.test(charAt(end));)++end;var token=source.substring(offset,offset=end);return'"'!==token&&"'"!==token||(stringDelim=token),token}function push(token){stack.push(token)}function peek(){if(!stack.length){var token=next();if(null===token)return null;push(token)}return stack[0]}return Object.defineProperty({next:next,peek:peek,push:push,skip:function skip(expected,optional){var actual=peek();if(actual===expected)return next(),!0;if(!optional)throw illegal("token '"+actual+"', '"+expected+"' expected");return!1},cmnt:function cmnt(trailingLine){var ret=null;return void 0===trailingLine?commentLine===line-1&&(alternateCommentMode||"*"===commentType||commentLineEmpty)&&(ret=commentIsLeading?commentText:null):(commentLine<trailingLine&&peek(),commentLine!==trailingLine||commentLineEmpty||!alternateCommentMode&&"/"!==commentType||(ret=commentIsLeading?null:commentText)),ret}},"line",{get:function(){return line}})}tokenize.unescape=unescape},pqPr:function(module,exports,__webpack_require__){"use strict";module.exports=Field;var ReflectionObject=__webpack_require__("iuWj");((Field.prototype=Object.create(ReflectionObject.prototype)).constructor=Field).className="Field";var Type,Enum=__webpack_require__("vREW"),types=__webpack_require__("hSTS"),util=__webpack_require__("y9PA"),ruleRe=/^required|optional|repeated$/;function Field(name,id,type,rule,extend,options,comment){if(util.isObject(rule)?(comment=extend,options=rule,rule=extend=void 0):util.isObject(extend)&&(comment=options,options=extend,extend=void 0),ReflectionObject.call(this,name,options),!util.isInteger(id)||id<0)throw TypeError("id must be a non-negative integer");if(!util.isString(type))throw TypeError("type must be a string");if(void 0!==rule&&!ruleRe.test(rule=rule.toString().toLowerCase()))throw TypeError("rule must be a string rule");if(void 0!==extend&&!util.isString(extend))throw TypeError("extend must be a string");"proto3_optional"===rule&&(rule="optional"),this.rule=rule&&"optional"!==rule?rule:void 0,this.type=type,this.id=id,this.extend=extend||void 0,this.required="required"===rule,this.optional=!this.required,this.repeated="repeated"===rule,this.map=!1,this.message=null,this.partOf=null,this.typeDefault=null,this.defaultValue=null,this.long=!!util.Long&&void 0!==types.long[type],this.bytes="bytes"===type,this.resolvedType=null,this.extensionField=null,this.declaringField=null,this._packed=null,this.comment=comment}Field.fromJSON=function fromJSON(name,json){return new Field(name,json.id,json.type,json.rule,json.extend,json.options,json.comment)},Object.defineProperty(Field.prototype,"packed",{get:function(){return null===this._packed&&(this._packed=!1!==this.getOption("packed")),this._packed}}),Field.prototype.setOption=function setOption(name,value,ifNotSet){return"packed"===name&&(this._packed=null),ReflectionObject.prototype.setOption.call(this,name,value,ifNotSet)},Field.prototype.toJSON=function toJSON(toJSONOptions){var keepComments=!!toJSONOptions&&Boolean(toJSONOptions.keepComments);return util.toObject(["rule","optional"!==this.rule&&this.rule||void 0,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",keepComments?this.comment:void 0])},Field.prototype.resolve=function resolve(){if(this.resolved)return this;if(void 0===(this.typeDefault=types.defaults[this.type])&&(this.resolvedType=(this.declaringField?this.declaringField.parent:this.parent).lookupTypeOrEnum(this.type),this.resolvedType instanceof Type?this.typeDefault=null:this.typeDefault=this.resolvedType.values[Object.keys(this.resolvedType.values)[0]]),this.options&&null!=this.options.default&&(this.typeDefault=this.options.default,this.resolvedType instanceof Enum&&"string"==typeof this.typeDefault&&(this.typeDefault=this.resolvedType.values[this.typeDefault])),this.options&&(!0!==this.options.packed&&(void 0===this.options.packed||!this.resolvedType||this.resolvedType instanceof Enum)||delete this.options.packed,Object.keys(this.options).length||(this.options=void 0)),this.long)this.typeDefault=util.Long.fromNumber(this.typeDefault,"u"===this.type.charAt(0)),Object.freeze&&Object.freeze(this.typeDefault);else if(this.bytes&&"string"==typeof this.typeDefault){var buf;util.base64.test(this.typeDefault)?util.base64.decode(this.typeDefault,buf=util.newBuffer(util.base64.length(this.typeDefault)),0):util.utf8.write(this.typeDefault,buf=util.newBuffer(util.utf8.length(this.typeDefault)),0),this.typeDefault=buf}return this.map?this.defaultValue=util.emptyObject:this.repeated?this.defaultValue=util.emptyArray:this.defaultValue=this.typeDefault,this.parent instanceof Type&&(this.parent.ctor.prototype[this.name]=this.defaultValue),ReflectionObject.prototype.resolve.call(this)},Field.d=function decorateField(fieldId,fieldType,fieldRule,defaultValue){return"function"==typeof fieldType?fieldType=util.decorateType(fieldType).name:fieldType&&"object"==typeof fieldType&&(fieldType=util.decorateEnum(fieldType).name),function fieldDecorator(prototype,fieldName){util.decorateType(prototype.constructor).add(new Field(fieldName,fieldId,fieldType,fieldRule,{default:defaultValue}))}},Field._configure=function configure(Type_){Type=Type_}},rVu5:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Client=void 0;const call_1=__webpack_require__("Ta7y"),channel_1=__webpack_require__("6XSn"),constants_1=__webpack_require__("8o9P"),metadata_1=__webpack_require__("m7sO"),client_interceptors_1=__webpack_require__("eaSJ"),CHANNEL_SYMBOL=Symbol(),INTERCEPTOR_SYMBOL=Symbol(),INTERCEPTOR_PROVIDER_SYMBOL=Symbol(),CALL_INVOCATION_TRANSFORMER_SYMBOL=Symbol();function isFunction(arg){return"function"==typeof arg}exports.Client=class{constructor(address,credentials,options={}){var _a,_b;if(options=Object.assign({},options),this[INTERCEPTOR_SYMBOL]=null!==(_a=options.interceptors)&&void 0!==_a?_a:[],delete options.interceptors,this[INTERCEPTOR_PROVIDER_SYMBOL]=null!==(_b=options.interceptor_providers)&&void 0!==_b?_b:[],delete options.interceptor_providers,this[INTERCEPTOR_SYMBOL].length>0&&this[INTERCEPTOR_PROVIDER_SYMBOL].length>0)throw new Error("Both interceptors and interceptor_providers were passed as options to the client constructor. Only one of these is allowed.");if(this[CALL_INVOCATION_TRANSFORMER_SYMBOL]=options.callInvocationTransformer,delete options.callInvocationTransformer,options.channelOverride)this[CHANNEL_SYMBOL]=options.channelOverride;else if(options.channelFactoryOverride){const channelFactoryOverride=options.channelFactoryOverride;delete options.channelFactoryOverride,this[CHANNEL_SYMBOL]=channelFactoryOverride(address,credentials,options)}else this[CHANNEL_SYMBOL]=new channel_1.ChannelImplementation(address,credentials,options)}close(){this[CHANNEL_SYMBOL].close()}getChannel(){return this[CHANNEL_SYMBOL]}waitForReady(deadline,callback){const checkState=err=>{if(err)return void callback(new Error("Failed to connect before the deadline"));let newState;try{newState=this[CHANNEL_SYMBOL].getConnectivityState(!0)}catch(e){return void callback(new Error("The channel has been closed"))}if(newState===channel_1.ConnectivityState.READY)callback();else try{this[CHANNEL_SYMBOL].watchConnectivityState(newState,deadline,checkState)}catch(e){callback(new Error("The channel has been closed"))}};setImmediate(checkState)}checkOptionalUnaryResponseArguments(arg1,arg2,arg3){if(isFunction(arg1))return{metadata:new metadata_1.Metadata,options:{},callback:arg1};if(isFunction(arg2))return arg1 instanceof metadata_1.Metadata?{metadata:arg1,options:{},callback:arg2}:{metadata:new metadata_1.Metadata,options:arg1,callback:arg2};if(!(arg1 instanceof metadata_1.Metadata&&arg2 instanceof Object&&isFunction(arg3)))throw new Error("Incorrect arguments passed");return{metadata:arg1,options:arg2,callback:arg3}}makeUnaryRequest(method,serialize,deserialize,argument,metadata,options,callback){var _a,_b;const checkedArguments=this.checkOptionalUnaryResponseArguments(metadata,options,callback),methodDefinition={path:method,requestStream:!1,responseStream:!1,requestSerialize:serialize,responseDeserialize:deserialize};let callProperties={argument:argument,metadata:checkedArguments.metadata,call:new call_1.ClientUnaryCallImpl,channel:this[CHANNEL_SYMBOL],methodDefinition:methodDefinition,callOptions:checkedArguments.options,callback:checkedArguments.callback};this[CALL_INVOCATION_TRANSFORMER_SYMBOL]&&(callProperties=this[CALL_INVOCATION_TRANSFORMER_SYMBOL](callProperties));const emitter=callProperties.call,interceptorArgs={clientInterceptors:this[INTERCEPTOR_SYMBOL],clientInterceptorProviders:this[INTERCEPTOR_PROVIDER_SYMBOL],callInterceptors:null!==(_a=callProperties.callOptions.interceptors)&&void 0!==_a?_a:[],callInterceptorProviders:null!==(_b=callProperties.callOptions.interceptor_providers)&&void 0!==_b?_b:[]},call=client_interceptors_1.getInterceptingCall(interceptorArgs,callProperties.methodDefinition,callProperties.callOptions,callProperties.channel);emitter.call=call,callProperties.callOptions.credentials&&call.setCredentials(callProperties.callOptions.credentials);let responseMessage=null,receivedStatus=!1;return call.start(callProperties.metadata,{onReceiveMetadata:metadata=>{emitter.emit("metadata",metadata)},onReceiveMessage(message){null!==responseMessage&&call.cancelWithStatus(constants_1.Status.INTERNAL,"Too many responses received"),responseMessage=message},onReceiveStatus(status){receivedStatus||(receivedStatus=!0,status.code===constants_1.Status.OK?callProperties.callback(null,responseMessage):callProperties.callback(call_1.callErrorFromStatus(status)),emitter.emit("status",status))}}),call.sendMessage(argument),call.halfClose(),emitter}makeClientStreamRequest(method,serialize,deserialize,metadata,options,callback){var _a,_b;const checkedArguments=this.checkOptionalUnaryResponseArguments(metadata,options,callback),methodDefinition={path:method,requestStream:!0,responseStream:!1,requestSerialize:serialize,responseDeserialize:deserialize};let callProperties={metadata:checkedArguments.metadata,call:new call_1.ClientWritableStreamImpl(serialize),channel:this[CHANNEL_SYMBOL],methodDefinition:methodDefinition,callOptions:checkedArguments.options,callback:checkedArguments.callback};this[CALL_INVOCATION_TRANSFORMER_SYMBOL]&&(callProperties=this[CALL_INVOCATION_TRANSFORMER_SYMBOL](callProperties));const emitter=callProperties.call,interceptorArgs={clientInterceptors:this[INTERCEPTOR_SYMBOL],clientInterceptorProviders:this[INTERCEPTOR_PROVIDER_SYMBOL],callInterceptors:null!==(_a=callProperties.callOptions.interceptors)&&void 0!==_a?_a:[],callInterceptorProviders:null!==(_b=callProperties.callOptions.interceptor_providers)&&void 0!==_b?_b:[]},call=client_interceptors_1.getInterceptingCall(interceptorArgs,callProperties.methodDefinition,callProperties.callOptions,callProperties.channel);emitter.call=call,callProperties.callOptions.credentials&&call.setCredentials(callProperties.callOptions.credentials);let responseMessage=null,receivedStatus=!1;return call.start(callProperties.metadata,{onReceiveMetadata:metadata=>{emitter.emit("metadata",metadata)},onReceiveMessage(message){null!==responseMessage&&call.cancelWithStatus(constants_1.Status.INTERNAL,"Too many responses received"),responseMessage=message},onReceiveStatus(status){receivedStatus||(receivedStatus=!0,status.code===constants_1.Status.OK?callProperties.callback(null,responseMessage):callProperties.callback(call_1.callErrorFromStatus(status)),emitter.emit("status",status))}}),emitter}checkMetadataAndOptions(arg1,arg2){let metadata,options;return arg1 instanceof metadata_1.Metadata?(metadata=arg1,options=arg2||{}):(options=arg1||{},metadata=new metadata_1.Metadata),{metadata:metadata,options:options}}makeServerStreamRequest(method,serialize,deserialize,argument,metadata,options){var _a,_b;const checkedArguments=this.checkMetadataAndOptions(metadata,options),methodDefinition={path:method,requestStream:!1,responseStream:!0,requestSerialize:serialize,responseDeserialize:deserialize};let callProperties={argument:argument,metadata:checkedArguments.metadata,call:new call_1.ClientReadableStreamImpl(deserialize),channel:this[CHANNEL_SYMBOL],methodDefinition:methodDefinition,callOptions:checkedArguments.options};this[CALL_INVOCATION_TRANSFORMER_SYMBOL]&&(callProperties=this[CALL_INVOCATION_TRANSFORMER_SYMBOL](callProperties));const stream=callProperties.call,interceptorArgs={clientInterceptors:this[INTERCEPTOR_SYMBOL],clientInterceptorProviders:this[INTERCEPTOR_PROVIDER_SYMBOL],callInterceptors:null!==(_a=callProperties.callOptions.interceptors)&&void 0!==_a?_a:[],callInterceptorProviders:null!==(_b=callProperties.callOptions.interceptor_providers)&&void 0!==_b?_b:[]},call=client_interceptors_1.getInterceptingCall(interceptorArgs,callProperties.methodDefinition,callProperties.callOptions,callProperties.channel);stream.call=call,callProperties.callOptions.credentials&&call.setCredentials(callProperties.callOptions.credentials);let receivedStatus=!1;return call.start(callProperties.metadata,{onReceiveMetadata(metadata){stream.emit("metadata",metadata)},onReceiveMessage(message){stream.push(message)},onReceiveStatus(status){receivedStatus||(receivedStatus=!0,stream.push(null),status.code!==constants_1.Status.OK&&stream.emit("error",call_1.callErrorFromStatus(status)),stream.emit("status",status))}}),call.sendMessage(argument),call.halfClose(),stream}makeBidiStreamRequest(method,serialize,deserialize,metadata,options){var _a,_b;const checkedArguments=this.checkMetadataAndOptions(metadata,options),methodDefinition={path:method,requestStream:!0,responseStream:!0,requestSerialize:serialize,responseDeserialize:deserialize};let callProperties={metadata:checkedArguments.metadata,call:new call_1.ClientDuplexStreamImpl(serialize,deserialize),channel:this[CHANNEL_SYMBOL],methodDefinition:methodDefinition,callOptions:checkedArguments.options};this[CALL_INVOCATION_TRANSFORMER_SYMBOL]&&(callProperties=this[CALL_INVOCATION_TRANSFORMER_SYMBOL](callProperties));const stream=callProperties.call,interceptorArgs={clientInterceptors:this[INTERCEPTOR_SYMBOL],clientInterceptorProviders:this[INTERCEPTOR_PROVIDER_SYMBOL],callInterceptors:null!==(_a=callProperties.callOptions.interceptors)&&void 0!==_a?_a:[],callInterceptorProviders:null!==(_b=callProperties.callOptions.interceptor_providers)&&void 0!==_b?_b:[]},call=client_interceptors_1.getInterceptingCall(interceptorArgs,callProperties.methodDefinition,callProperties.callOptions,callProperties.channel);stream.call=call,callProperties.callOptions.credentials&&call.setCredentials(callProperties.callOptions.credentials);let receivedStatus=!1;return call.start(callProperties.metadata,{onReceiveMetadata(metadata){stream.emit("metadata",metadata)},onReceiveMessage(message){stream.push(message)},onReceiveStatus(status){receivedStatus||(receivedStatus=!0,stream.push(null),status.code!==constants_1.Status.OK&&stream.emit("error",call_1.callErrorFromStatus(status)),stream.emit("status",status))}}),stream}}},"sE+A":function(module,exports,__webpack_require__){"use strict";var tslib=__webpack_require__("zOht"),util=__webpack_require__("Jv5v"),logger=__webpack_require__("NcST"),util$1=__webpack_require__("jK02"),crypto=__webpack_require__("PJMN"),grpcJs=__webpack_require__("AVbK"),package_json=__webpack_require__("eM9J"),path=__webpack_require__("oyvS"),protoLoader=__webpack_require__("8ZNE"),ListenSequence=function(){function ListenSequence(previousValue,sequenceNumberSyncer){var _this=this;this.previousValue=previousValue,sequenceNumberSyncer&&(sequenceNumberSyncer.sequenceNumberHandler=function(sequenceNumber){return _this.setPreviousValue(sequenceNumber)},this.writeNewSequenceNumber=function(sequenceNumber){return sequenceNumberSyncer.writeSequenceNumber(sequenceNumber)})}return ListenSequence.prototype.setPreviousValue=function(externalPreviousValue){return this.previousValue=Math.max(externalPreviousValue,this.previousValue),this.previousValue},ListenSequence.prototype.next=function(){var nextValue=++this.previousValue;return this.writeNewSequenceNumber&&this.writeNewSequenceNumber(nextValue),nextValue},ListenSequence}();ListenSequence.INVALID=-1;var logClient=new logger.Logger("@firebase/firestore");function getLogLevel(){return logClient.logLevel}function logDebug(msg){for(var obj=[],_i=1;_i<arguments.length;_i++)obj[_i-1]=arguments[_i];if(logClient.logLevel<=logger.LogLevel.DEBUG){var args=obj.map(argToString);logClient.debug.apply(logClient,tslib.__spreadArray(["Firestore (8.7.0): "+msg],args))}}function logError(msg){for(var obj=[],_i=1;_i<arguments.length;_i++)obj[_i-1]=arguments[_i];if(logClient.logLevel<=logger.LogLevel.ERROR){var args=obj.map(argToString);logClient.error.apply(logClient,tslib.__spreadArray(["Firestore (8.7.0): "+msg],args))}}function logWarn(msg){for(var obj=[],_i=1;_i<arguments.length;_i++)obj[_i-1]=arguments[_i];if(logClient.logLevel<=logger.LogLevel.WARN){var args=obj.map(argToString);logClient.warn.apply(logClient,tslib.__spreadArray(["Firestore (8.7.0): "+msg],args))}}function argToString(obj){if("string"==typeof obj)return obj;try{return function formatJSON(value){return util$1.inspect(value,{depth:100})}(obj)}catch(e){return obj}}function fail(failure){void 0===failure&&(failure="Unexpected state");var message="FIRESTORE (8.7.0) INTERNAL ASSERTION FAILED: "+failure;throw logError(message),new Error(message)}function hardAssert(assertion,message){assertion||fail()}function debugCast(obj,constructor){return obj}var Code_OK="ok",Code_CANCELLED="cancelled",Code_UNKNOWN="unknown",Code_INVALID_ARGUMENT="invalid-argument",Code_DEADLINE_EXCEEDED="deadline-exceeded",Code_NOT_FOUND="not-found",Code_ALREADY_EXISTS="already-exists",Code_PERMISSION_DENIED="permission-denied",Code_UNAUTHENTICATED="unauthenticated",Code_RESOURCE_EXHAUSTED="resource-exhausted",Code_FAILED_PRECONDITION="failed-precondition",Code_ABORTED="aborted",Code_OUT_OF_RANGE="out-of-range",Code_UNIMPLEMENTED="unimplemented",Code_INTERNAL="internal",Code_UNAVAILABLE="unavailable",Code_DATA_LOSS="data-loss",FirestoreError=function(_super){function FirestoreError(code,message){var _this=_super.call(this,message)||this;return _this.code=code,_this.message=message,_this.name="FirebaseError",_this.toString=function(){return _this.name+": [code="+_this.code+"]: "+_this.message},_this}return tslib.__extends(FirestoreError,_super),FirestoreError}(Error),BasePath=function(){function BasePath(segments,offset,length){void 0===offset?offset=0:offset>segments.length&&fail(),void 0===length?length=segments.length-offset:length>segments.length-offset&&fail(),this.segments=segments,this.offset=offset,this.len=length}return Object.defineProperty(BasePath.prototype,"length",{get:function(){return this.len},enumerable:!1,configurable:!0}),BasePath.prototype.isEqual=function(other){return 0===BasePath.comparator(this,other)},BasePath.prototype.child=function(nameOrPath){var segments=this.segments.slice(this.offset,this.limit());return nameOrPath instanceof BasePath?nameOrPath.forEach(function(segment){segments.push(segment)}):segments.push(nameOrPath),this.construct(segments)},BasePath.prototype.limit=function(){return this.offset+this.length},BasePath.prototype.popFirst=function(size){return size=void 0===size?1:size,this.construct(this.segments,this.offset+size,this.length-size)},BasePath.prototype.popLast=function(){return this.construct(this.segments,this.offset,this.length-1)},BasePath.prototype.firstSegment=function(){return this.segments[this.offset]},BasePath.prototype.lastSegment=function(){return this.get(this.length-1)},BasePath.prototype.get=function(index){return this.segments[this.offset+index]},BasePath.prototype.isEmpty=function(){return 0===this.length},BasePath.prototype.isPrefixOf=function(other){if(other.length<this.length)return!1;for(var i=0;i<this.length;i++)if(this.get(i)!==other.get(i))return!1;return!0},BasePath.prototype.isImmediateParentOf=function(potentialChild){if(this.length+1!==potentialChild.length)return!1;for(var i=0;i<this.length;i++)if(this.get(i)!==potentialChild.get(i))return!1;return!0},BasePath.prototype.forEach=function(fn){for(var i=this.offset,end=this.limit();i<end;i++)fn(this.segments[i])},BasePath.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())},BasePath.comparator=function(p1,p2){for(var len=Math.min(p1.length,p2.length),i=0;i<len;i++){var left=p1.get(i),right=p2.get(i);if(left<right)return-1;if(left>right)return 1}return p1.length<p2.length?-1:p1.length>p2.length?1:0},BasePath}(),ResourcePath=function(_super){function ResourcePath(){return null!==_super&&_super.apply(this,arguments)||this}return tslib.__extends(ResourcePath,_super),ResourcePath.prototype.construct=function(segments,offset,length){return new ResourcePath(segments,offset,length)},ResourcePath.prototype.canonicalString=function(){return this.toArray().join("/")},ResourcePath.prototype.toString=function(){return this.canonicalString()},ResourcePath.fromString=function(){for(var pathComponents=[],_i=0;_i<arguments.length;_i++)pathComponents[_i]=arguments[_i];for(var segments=[],_d=0,pathComponents_1=pathComponents;_d<pathComponents_1.length;_d++){var path=pathComponents_1[_d];if(path.indexOf("//")>=0)throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid segment ("+path+"). Paths must not contain // in them.");segments.push.apply(segments,path.split("/").filter(function(segment){return segment.length>0}))}return new ResourcePath(segments)},ResourcePath.emptyPath=function(){return new ResourcePath([])},ResourcePath}(BasePath),identifierRegExp=/^[_a-zA-Z][_a-zA-Z0-9]*$/,FieldPath$1=function(_super){function FieldPath$1(){return null!==_super&&_super.apply(this,arguments)||this}return tslib.__extends(FieldPath$1,_super),FieldPath$1.prototype.construct=function(segments,offset,length){return new FieldPath$1(segments,offset,length)},FieldPath$1.isValidIdentifier=function(segment){return identifierRegExp.test(segment)},FieldPath$1.prototype.canonicalString=function(){return this.toArray().map(function(str){return str=str.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),FieldPath$1.isValidIdentifier(str)||(str="`"+str+"`"),str}).join(".")},FieldPath$1.prototype.toString=function(){return this.canonicalString()},FieldPath$1.prototype.isKeyField=function(){return 1===this.length&&"__name__"===this.get(0)},FieldPath$1.keyField=function(){return new FieldPath$1(["__name__"])},FieldPath$1.fromServerFormat=function(path){for(var segments=[],current="",i=0,addCurrentSegment=function(){if(0===current.length)throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid field path ("+path+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");segments.push(current),current=""},inBackticks=!1;i<path.length;){var c=path[i];if("\\"===c){if(i+1===path.length)throw new FirestoreError(Code_INVALID_ARGUMENT,"Path has trailing escape character: "+path);var next=path[i+1];if("\\"!==next&&"."!==next&&"`"!==next)throw new FirestoreError(Code_INVALID_ARGUMENT,"Path has invalid escape sequence: "+path);current+=next,i+=2}else"`"===c?(inBackticks=!inBackticks,i++):"."!==c||inBackticks?(current+=c,i++):(addCurrentSegment(),i++)}if(addCurrentSegment(),inBackticks)throw new FirestoreError(Code_INVALID_ARGUMENT,"Unterminated ` in path: "+path);return new FieldPath$1(segments)},FieldPath$1.emptyPath=function(){return new FieldPath$1([])},FieldPath$1}(BasePath);function encodeResourcePath(path){for(var result="",i=0;i<path.length;i++)result.length>0&&(result=encodeSeparator(result)),result=encodeSegment(path.get(i),result);return encodeSeparator(result)}function encodeSegment(segment,resultBuf){for(var result=resultBuf,length=segment.length,i=0;i<length;i++){var c=segment.charAt(i);switch(c){case"\0":result+="\x01\x10";break;case"\x01":result+="\x01\x11";break;default:result+=c}}return result}function encodeSeparator(result){return result+"\x01\x01"}function decodeResourcePath(path){var length=path.length;if(hardAssert(length>=2),2===length)return hardAssert("\x01"===path.charAt(0)&&"\x01"===path.charAt(1)),ResourcePath.emptyPath();for(var lastReasonableEscapeIndex=length-2,segments=[],segmentBuilder="",start=0;start<length;){var end=path.indexOf("\x01",start);switch((end<0||end>lastReasonableEscapeIndex)&&fail(),path.charAt(end+1)){case"\x01":var currentPiece=path.substring(start,end),segment=void 0;0===segmentBuilder.length?segment=currentPiece:(segment=segmentBuilder+=currentPiece,segmentBuilder=""),segments.push(segment);break;case"\x10":segmentBuilder+=path.substring(start,end),segmentBuilder+="\0";break;case"\x11":segmentBuilder+=path.substring(start,end+1);break;default:fail()}start=end+2}return new ResourcePath(segments)}var DbTimestamp=function DbTimestamp(seconds,nanoseconds){this.seconds=seconds,this.nanoseconds=nanoseconds},DbPrimaryClient=function DbPrimaryClient(ownerId,allowTabSynchronization,leaseTimestampMs){this.ownerId=ownerId,this.allowTabSynchronization=allowTabSynchronization,this.leaseTimestampMs=leaseTimestampMs};DbPrimaryClient.store="owner",DbPrimaryClient.key="owner";var DbMutationQueue=function DbMutationQueue(userId,lastAcknowledgedBatchId,lastStreamToken){this.userId=userId,this.lastAcknowledgedBatchId=lastAcknowledgedBatchId,this.lastStreamToken=lastStreamToken};DbMutationQueue.store="mutationQueues",DbMutationQueue.keyPath="userId";var DbMutationBatch=function DbMutationBatch(userId,batchId,localWriteTimeMs,baseMutations,mutations){this.userId=userId,this.batchId=batchId,this.localWriteTimeMs=localWriteTimeMs,this.baseMutations=baseMutations,this.mutations=mutations};DbMutationBatch.store="mutations",DbMutationBatch.keyPath="batchId",DbMutationBatch.userMutationsIndex="userMutationsIndex",DbMutationBatch.userMutationsKeyPath=["userId","batchId"];var DbDocumentMutation=function(){function DbDocumentMutation(){}return DbDocumentMutation.prefixForUser=function(userId){return[userId]},DbDocumentMutation.prefixForPath=function(userId,path){return[userId,encodeResourcePath(path)]},DbDocumentMutation.key=function(userId,path,batchId){return[userId,encodeResourcePath(path),batchId]},DbDocumentMutation}();DbDocumentMutation.store="documentMutations",DbDocumentMutation.PLACEHOLDER=new DbDocumentMutation;var DbNoDocument=function DbNoDocument(path,readTime){this.path=path,this.readTime=readTime},DbUnknownDocument=function DbUnknownDocument(path,version){this.path=path,this.version=version},DbRemoteDocument=function DbRemoteDocument(unknownDocument,noDocument,document,hasCommittedMutations,readTime,parentPath){this.unknownDocument=unknownDocument,this.noDocument=noDocument,this.document=document,this.hasCommittedMutations=hasCommittedMutations,this.readTime=readTime,this.parentPath=parentPath};DbRemoteDocument.store="remoteDocuments",DbRemoteDocument.readTimeIndex="readTimeIndex",DbRemoteDocument.readTimeIndexPath="readTime",DbRemoteDocument.collectionReadTimeIndex="collectionReadTimeIndex",DbRemoteDocument.collectionReadTimeIndexPath=["parentPath","readTime"];var DbRemoteDocumentGlobal=function DbRemoteDocumentGlobal(byteSize){this.byteSize=byteSize};DbRemoteDocumentGlobal.store="remoteDocumentGlobal",DbRemoteDocumentGlobal.key="remoteDocumentGlobalKey";var DbTarget=function DbTarget(targetId,canonicalId,readTime,resumeToken,lastListenSequenceNumber,lastLimboFreeSnapshotVersion,query){this.targetId=targetId,this.canonicalId=canonicalId,this.readTime=readTime,this.resumeToken=resumeToken,this.lastListenSequenceNumber=lastListenSequenceNumber,this.lastLimboFreeSnapshotVersion=lastLimboFreeSnapshotVersion,this.query=query};DbTarget.store="targets",DbTarget.keyPath="targetId",DbTarget.queryTargetsIndexName="queryTargetsIndex",DbTarget.queryTargetsKeyPath=["canonicalId","targetId"];var DbTargetDocument=function DbTargetDocument(targetId,path,sequenceNumber){this.targetId=targetId,this.path=path,this.sequenceNumber=sequenceNumber};DbTargetDocument.store="targetDocuments",DbTargetDocument.keyPath=["targetId","path"],DbTargetDocument.documentTargetsIndex="documentTargetsIndex",DbTargetDocument.documentTargetsKeyPath=["path","targetId"];var DbTargetGlobal=function DbTargetGlobal(highestTargetId,highestListenSequenceNumber,lastRemoteSnapshotVersion,targetCount){this.highestTargetId=highestTargetId,this.highestListenSequenceNumber=highestListenSequenceNumber,this.lastRemoteSnapshotVersion=lastRemoteSnapshotVersion,this.targetCount=targetCount};DbTargetGlobal.key="targetGlobalKey",DbTargetGlobal.store="targetGlobal";var DbCollectionParent=function DbCollectionParent(collectionId,parent){this.collectionId=collectionId,this.parent=parent};DbCollectionParent.store="collectionParents",DbCollectionParent.keyPath=["collectionId","parent"];var DbClientMetadata=function DbClientMetadata(clientId,updateTimeMs,networkEnabled,inForeground){this.clientId=clientId,this.updateTimeMs=updateTimeMs,this.networkEnabled=networkEnabled,this.inForeground=inForeground};DbClientMetadata.store="clientMetadata",DbClientMetadata.keyPath="clientId";var DbBundle=function DbBundle(bundleId,createTime,version){this.bundleId=bundleId,this.createTime=createTime,this.version=version};DbBundle.store="bundles",DbBundle.keyPath="bundleId";var DbNamedQuery=function DbNamedQuery(name,readTime,bundledQuery){this.name=name,this.readTime=readTime,this.bundledQuery=bundledQuery};DbNamedQuery.store="namedQueries",DbNamedQuery.keyPath="name";var V3_STORES=[DbMutationQueue.store,DbMutationBatch.store,DbDocumentMutation.store,DbRemoteDocument.store,DbTarget.store,DbPrimaryClient.store,DbTargetGlobal.store,DbTargetDocument.store],V4_STORES=tslib.__spreadArray(tslib.__spreadArray([],V3_STORES),[DbClientMetadata.store]),V6_STORES=tslib.__spreadArray(tslib.__spreadArray([],V4_STORES),[DbRemoteDocumentGlobal.store]),V8_STORES=tslib.__spreadArray(tslib.__spreadArray([],V6_STORES),[DbCollectionParent.store]),ALL_STORES=tslib.__spreadArray(tslib.__spreadArray([],V8_STORES),[DbBundle.store,DbNamedQuery.store]),PRIMARY_LEASE_LOST_ERROR_MSG="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",PersistenceTransaction=function(){function PersistenceTransaction(){this.onCommittedListeners=[]}return PersistenceTransaction.prototype.addOnCommittedListener=function(listener){this.onCommittedListeners.push(listener)},PersistenceTransaction.prototype.raiseOnCommittedEvent=function(){this.onCommittedListeners.forEach(function(listener){return listener()})},PersistenceTransaction}(),Deferred=function Deferred(){var _this=this;this.promise=new Promise(function(resolve,reject){_this.resolve=resolve,_this.reject=reject})},PersistencePromise=function(){function PersistencePromise(callback){var _this=this;this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,callback(function(value){_this.isDone=!0,_this.result=value,_this.nextCallback&&_this.nextCallback(value)},function(error){_this.isDone=!0,_this.error=error,_this.catchCallback&&_this.catchCallback(error)})}return PersistencePromise.prototype.catch=function(fn){return this.next(void 0,fn)},PersistencePromise.prototype.next=function(nextFn,catchFn){var _this=this;return this.callbackAttached&&fail(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(catchFn,this.error):this.wrapSuccess(nextFn,this.result):new PersistencePromise(function(resolve,reject){_this.nextCallback=function(value){_this.wrapSuccess(nextFn,value).next(resolve,reject)},_this.catchCallback=function(error){_this.wrapFailure(catchFn,error).next(resolve,reject)}})},PersistencePromise.prototype.toPromise=function(){var _this=this;return new Promise(function(resolve,reject){_this.next(resolve,reject)})},PersistencePromise.prototype.wrapUserFunction=function(fn){try{var result=fn();return result instanceof PersistencePromise?result:PersistencePromise.resolve(result)}catch(e){return PersistencePromise.reject(e)}},PersistencePromise.prototype.wrapSuccess=function(nextFn,value){return nextFn?this.wrapUserFunction(function(){return nextFn(value)}):PersistencePromise.resolve(value)},PersistencePromise.prototype.wrapFailure=function(catchFn,error){return catchFn?this.wrapUserFunction(function(){return catchFn(error)}):PersistencePromise.reject(error)},PersistencePromise.resolve=function(result){return new PersistencePromise(function(resolve,reject){resolve(result)})},PersistencePromise.reject=function(error){return new PersistencePromise(function(resolve,reject){reject(error)})},PersistencePromise.waitFor=function(all){return new PersistencePromise(function(resolve,reject){var expectedCount=0,resolvedCount=0,done=!1;all.forEach(function(element){++expectedCount,element.next(function(){++resolvedCount,done&&resolvedCount===expectedCount&&resolve()},function(err){return reject(err)})}),done=!0,resolvedCount===expectedCount&&resolve()})},PersistencePromise.or=function(predicates){for(var p=PersistencePromise.resolve(!1),_loop_1=function(predicate){p=p.next(function(isTrue){return isTrue?PersistencePromise.resolve(isTrue):predicate()})},_i=0,predicates_1=predicates;_i<predicates_1.length;_i++){_loop_1(predicates_1[_i])}return p},PersistencePromise.forEach=function(collection,f){var _this=this,promises=[];return collection.forEach(function(r,s){promises.push(f.call(_this,r,s))}),this.waitFor(promises)},PersistencePromise}(),SimpleDbTransaction=function(){function SimpleDbTransaction(action,transaction){var _this=this;this.action=action,this.transaction=transaction,this.aborted=!1,this.completionDeferred=new Deferred,this.transaction.oncomplete=function(){_this.completionDeferred.resolve()},this.transaction.onabort=function(){transaction.error?_this.completionDeferred.reject(new IndexedDbTransactionError(action,transaction.error)):_this.completionDeferred.resolve()},this.transaction.onerror=function(event){var error=checkForAndReportiOSError(event.target.error);_this.completionDeferred.reject(new IndexedDbTransactionError(action,error))}}return SimpleDbTransaction.open=function(db,action,mode,objectStoreNames){try{return new SimpleDbTransaction(action,db.transaction(objectStoreNames,mode))}catch(e){throw new IndexedDbTransactionError(action,e)}},Object.defineProperty(SimpleDbTransaction.prototype,"completionPromise",{get:function(){return this.completionDeferred.promise},enumerable:!1,configurable:!0}),SimpleDbTransaction.prototype.abort=function(error){error&&this.completionDeferred.reject(error),this.aborted||(logDebug("SimpleDb","Aborting transaction:",error?error.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())},SimpleDbTransaction.prototype.store=function(storeName){var store=this.transaction.objectStore(storeName);return new SimpleDbStore(store)},SimpleDbTransaction}(),SimpleDb=function(){function SimpleDb(name,version,schemaConverter){this.name=name,this.version=version,this.schemaConverter=schemaConverter,12.2===SimpleDb.getIOSVersion(util.getUA())&&logError("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}return SimpleDb.delete=function(name){return logDebug("SimpleDb","Removing database:",name),wrapRequest(window.indexedDB.deleteDatabase(name)).toPromise()},SimpleDb.isAvailable=function(){if("undefined"==typeof indexedDB)return!1;if(SimpleDb.isMockPersistence())return!0;var ua=util.getUA(),iOSVersion=SimpleDb.getIOSVersion(ua),isUnsupportedIOS=0<iOSVersion&&iOSVersion<10,androidVersion=SimpleDb.getAndroidVersion(ua),isUnsupportedAndroid=0<androidVersion&&androidVersion<4.5;return!(ua.indexOf("MSIE ")>0||ua.indexOf("Trident/")>0||ua.indexOf("Edge/")>0||isUnsupportedIOS||isUnsupportedAndroid)},SimpleDb.isMockPersistence=function(){var _a;return"undefined"!=typeof process&&"YES"===(null===(_a=process.env)||void 0===_a?void 0:_a.USE_MOCK_PERSISTENCE)},SimpleDb.getStore=function(txn,store){return txn.store(store)},SimpleDb.getIOSVersion=function(ua){var iOSVersionRegex=ua.match(/i(?:phone|pad|pod) os ([\d_]+)/i),version=iOSVersionRegex?iOSVersionRegex[1].split("_").slice(0,2).join("."):"-1";return Number(version)},SimpleDb.getAndroidVersion=function(ua){var androidVersionRegex=ua.match(/Android ([\d.]+)/i),version=androidVersionRegex?androidVersionRegex[1].split(".").slice(0,2).join("."):"-1";return Number(version)},SimpleDb.prototype.ensureDb=function(action){return tslib.__awaiter(this,void 0,void 0,function(){var _d,_this=this;return tslib.__generator(this,function(_e){switch(_e.label){case 0:return this.db?[3,2]:(logDebug("SimpleDb","Opening database:",this.name),_d=this,[4,new Promise(function(resolve,reject){var request=indexedDB.open(_this.name,_this.version);request.onsuccess=function(event){var db=event.target.result;resolve(db)},request.onblocked=function(){reject(new IndexedDbTransactionError(action,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},request.onerror=function(event){var error=event.target.error;"VersionError"===error.name?reject(new FirestoreError(Code_FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):reject(new IndexedDbTransactionError(action,error))},request.onupgradeneeded=function(event){logDebug("SimpleDb",'Database "'+_this.name+'" requires upgrade from version:',event.oldVersion);var db=event.target.result;_this.schemaConverter.createOrUpgrade(db,request.transaction,event.oldVersion,_this.version).next(function(){logDebug("SimpleDb","Database upgrade to version "+_this.version+" complete")})}})]);case 1:_d.db=_e.sent(),_e.label=2;case 2:return this.versionchangelistener&&(this.db.onversionchange=function(event){return _this.versionchangelistener(event)}),[2,this.db]}})})},SimpleDb.prototype.setVersionChangeListener=function(versionChangeListener){this.versionchangelistener=versionChangeListener,this.db&&(this.db.onversionchange=function(event){return versionChangeListener(event)})},SimpleDb.prototype.runTransaction=function(action,mode,objectStores,transactionFn){return tslib.__awaiter(this,void 0,void 0,function(){var readonly,attemptNumber,_loop_2,this_1,state_1;return tslib.__generator(this,function(_d){switch(_d.label){case 0:readonly="readonly"===mode,attemptNumber=0,_loop_2=function(){var transaction_1,transactionFnResult,error_1,retryable;return tslib.__generator(this,function(_e){switch(_e.label){case 0:++attemptNumber,_e.label=1;case 1:return _e.trys.push([1,4,,5]),[4,this_1.ensureDb(action)];case 2:return this_1.db=_e.sent(),transaction_1=SimpleDbTransaction.open(this_1.db,action,readonly?"readonly":"readwrite",objectStores),(transactionFnResult=transactionFn(transaction_1).catch(function(error){return transaction_1.abort(error),PersistencePromise.reject(error)}).toPromise()).catch(function(){}),[4,transaction_1.completionPromise];case 3:return _e.sent(),[2,{value:transactionFnResult}];case 4:return error_1=_e.sent(),retryable="FirebaseError"!==error_1.name&&attemptNumber<3,logDebug("SimpleDb","Transaction failed with error:",error_1.message,"Retrying:",retryable),this_1.close(),retryable?[3,5]:[2,{value:Promise.reject(error_1)}];case 5:return[2]}})},this_1=this,_d.label=1;case 1:return[5,_loop_2()];case 2:return"object"==typeof(state_1=_d.sent())?[2,state_1.value]:[3,1];case 3:return[2]}})})},SimpleDb.prototype.close=function(){this.db&&this.db.close(),this.db=void 0},SimpleDb}(),IterationController=function(){function IterationController(dbCursor){this.dbCursor=dbCursor,this.shouldStop=!1,this.nextKey=null}return Object.defineProperty(IterationController.prototype,"isDone",{get:function(){return this.shouldStop},enumerable:!1,configurable:!0}),Object.defineProperty(IterationController.prototype,"skipToKey",{get:function(){return this.nextKey},enumerable:!1,configurable:!0}),Object.defineProperty(IterationController.prototype,"cursor",{set:function(value){this.dbCursor=value},enumerable:!1,configurable:!0}),IterationController.prototype.done=function(){this.shouldStop=!0},IterationController.prototype.skip=function(key){this.nextKey=key},IterationController.prototype.delete=function(){return wrapRequest(this.dbCursor.delete())},IterationController}(),IndexedDbTransactionError=function(_super){function IndexedDbTransactionError(actionName,cause){var _this=_super.call(this,Code_UNAVAILABLE,"IndexedDB transaction '"+actionName+"' failed: "+cause)||this;return _this.name="IndexedDbTransactionError",_this}return tslib.__extends(IndexedDbTransactionError,_super),IndexedDbTransactionError}(FirestoreError);function isIndexedDbTransactionError(e){return"IndexedDbTransactionError"===e.name}var SimpleDbStore=function(){function SimpleDbStore(store){this.store=store}return SimpleDbStore.prototype.put=function(keyOrValue,value){var request;return void 0!==value?(logDebug("SimpleDb","PUT",this.store.name,keyOrValue,value),request=this.store.put(value,keyOrValue)):(logDebug("SimpleDb","PUT",this.store.name,"<auto-key>",keyOrValue),request=this.store.put(keyOrValue)),wrapRequest(request)},SimpleDbStore.prototype.add=function(value){return logDebug("SimpleDb","ADD",this.store.name,value,value),wrapRequest(this.store.add(value))},SimpleDbStore.prototype.get=function(key){var _this=this;return wrapRequest(this.store.get(key)).next(function(result){return void 0===result&&(result=null),logDebug("SimpleDb","GET",_this.store.name,key,result),result})},SimpleDbStore.prototype.delete=function(key){return logDebug("SimpleDb","DELETE",this.store.name,key),wrapRequest(this.store.delete(key))},SimpleDbStore.prototype.count=function(){return logDebug("SimpleDb","COUNT",this.store.name),wrapRequest(this.store.count())},SimpleDbStore.prototype.loadAll=function(indexOrRange,range){var cursor=this.cursor(this.options(indexOrRange,range)),results=[];return this.iterateCursor(cursor,function(key,value){results.push(value)}).next(function(){return results})},SimpleDbStore.prototype.deleteAll=function(indexOrRange,range){logDebug("SimpleDb","DELETE ALL",this.store.name);var options=this.options(indexOrRange,range);options.keysOnly=!1;var cursor=this.cursor(options);return this.iterateCursor(cursor,function(key,value,control){return control.delete()})},SimpleDbStore.prototype.iterate=function(optionsOrCallback,callback){var options;callback?options=optionsOrCallback:(options={},callback=optionsOrCallback);var cursor=this.cursor(options);return this.iterateCursor(cursor,callback)},SimpleDbStore.prototype.iterateSerial=function(callback){var cursorRequest=this.cursor({});return new PersistencePromise(function(resolve,reject){cursorRequest.onerror=function(event){var error=checkForAndReportiOSError(event.target.error);reject(error)},cursorRequest.onsuccess=function(event){var cursor=event.target.result;cursor?callback(cursor.primaryKey,cursor.value).next(function(shouldContinue){shouldContinue?cursor.continue():resolve()}):resolve()}})},SimpleDbStore.prototype.iterateCursor=function(cursorRequest,fn){var results=[];return new PersistencePromise(function(resolve,reject){cursorRequest.onerror=function(event){reject(event.target.error)},cursorRequest.onsuccess=function(event){var cursor=event.target.result;if(cursor){var controller=new IterationController(cursor),userResult=fn(cursor.primaryKey,cursor.value,controller);if(userResult instanceof PersistencePromise){var userPromise=userResult.catch(function(err){return controller.done(),PersistencePromise.reject(err)});results.push(userPromise)}controller.isDone?resolve():null===controller.skipToKey?cursor.continue():cursor.continue(controller.skipToKey)}else resolve()}}).next(function(){return PersistencePromise.waitFor(results)})},SimpleDbStore.prototype.options=function(indexOrRange,range){var indexName=void 0;return void 0!==indexOrRange&&("string"==typeof indexOrRange?indexName=indexOrRange:range=indexOrRange),{index:indexName,range:range}},SimpleDbStore.prototype.cursor=function(options){var direction="next";if(options.reverse&&(direction="prev"),options.index){var index=this.store.index(options.index);return options.keysOnly?index.openKeyCursor(options.range,direction):index.openCursor(options.range,direction)}return this.store.openCursor(options.range,direction)},SimpleDbStore}();function wrapRequest(request){return new PersistencePromise(function(resolve,reject){request.onsuccess=function(event){var result=event.target.result;resolve(result)},request.onerror=function(event){var error=checkForAndReportiOSError(event.target.error);reject(error)}})}var reportedIOSError=!1;function checkForAndReportiOSError(error){var iOSVersion=SimpleDb.getIOSVersion(util.getUA());if(iOSVersion>=12.2&&iOSVersion<13){var IOS_ERROR="An internal error was encountered in the Indexed Database server";if(error.message.indexOf(IOS_ERROR)>=0){var newError_1=new FirestoreError("internal","IOS_INDEXEDDB_BUG1: IndexedDb has thrown '"+IOS_ERROR+"'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.");return reportedIOSError||(reportedIOSError=!0,setTimeout(function(){throw newError_1},0)),newError_1}}return error}var IndexedDbTransaction=function(_super){function IndexedDbTransaction(simpleDbTransaction,currentSequenceNumber){var _this=_super.call(this)||this;return _this.simpleDbTransaction=simpleDbTransaction,_this.currentSequenceNumber=currentSequenceNumber,_this}return tslib.__extends(IndexedDbTransaction,_super),IndexedDbTransaction}(PersistenceTransaction);function getStore(txn,store){var indexedDbTransaction=debugCast(txn);return SimpleDb.getStore(indexedDbTransaction.simpleDbTransaction,store)}var AutoId=function(){function AutoId(){}return AutoId.newId=function(){for(var nBytes,chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",maxMultiple=Math.floor(256/chars.length)*chars.length,autoId="";autoId.length<20;)for(var bytes=(nBytes=40,crypto.randomBytes(nBytes)),i=0;i<bytes.length;++i)autoId.length<20&&bytes[i]<maxMultiple&&(autoId+=chars.charAt(bytes[i]%chars.length));return autoId},AutoId}();function primitiveComparator(left,right){return left<right?-1:left>right?1:0}function arrayEquals(left,right,comparator){return left.length===right.length&&left.every(function(value,index){return comparator(value,right[index])})}function immediateSuccessor(s){return s+"\0"}var Timestamp=function(){function Timestamp(seconds,nanoseconds){if(this.seconds=seconds,this.nanoseconds=nanoseconds,nanoseconds<0)throw new FirestoreError(Code_INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+nanoseconds);if(nanoseconds>=1e9)throw new FirestoreError(Code_INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+nanoseconds);if(seconds<-62135596800)throw new FirestoreError(Code_INVALID_ARGUMENT,"Timestamp seconds out of range: "+seconds);if(seconds>=253402300800)throw new FirestoreError(Code_INVALID_ARGUMENT,"Timestamp seconds out of range: "+seconds)}return Timestamp.now=function(){return Timestamp.fromMillis(Date.now())},Timestamp.fromDate=function(date){return Timestamp.fromMillis(date.getTime())},Timestamp.fromMillis=function(milliseconds){var seconds=Math.floor(milliseconds/1e3);return new Timestamp(seconds,Math.floor(1e6*(milliseconds-1e3*seconds)))},Timestamp.prototype.toDate=function(){return new Date(this.toMillis())},Timestamp.prototype.toMillis=function(){return 1e3*this.seconds+this.nanoseconds/1e6},Timestamp.prototype._compareTo=function(other){return this.seconds===other.seconds?primitiveComparator(this.nanoseconds,other.nanoseconds):primitiveComparator(this.seconds,other.seconds)},Timestamp.prototype.isEqual=function(other){return other.seconds===this.seconds&&other.nanoseconds===this.nanoseconds},Timestamp.prototype.toString=function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"},Timestamp.prototype.toJSON=function(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}},Timestamp.prototype.valueOf=function(){var adjustedSeconds=this.seconds- -62135596800;return String(adjustedSeconds).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")},Timestamp}(),SnapshotVersion=function(){function SnapshotVersion(timestamp){this.timestamp=timestamp}return SnapshotVersion.fromTimestamp=function(value){return new SnapshotVersion(value)},SnapshotVersion.min=function(){return new SnapshotVersion(new Timestamp(0,0))},SnapshotVersion.prototype.compareTo=function(other){return this.timestamp._compareTo(other.timestamp)},SnapshotVersion.prototype.isEqual=function(other){return this.timestamp.isEqual(other.timestamp)},SnapshotVersion.prototype.toMicroseconds=function(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3},SnapshotVersion.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"},SnapshotVersion.prototype.toTimestamp=function(){return this.timestamp},SnapshotVersion}();function objectSize(obj){var count=0;for(var key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&count++;return count}function forEach(obj,fn){for(var key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&fn(key,obj[key])}function isEmpty(obj){for(var key in obj)if(Object.prototype.hasOwnProperty.call(obj,key))return!1;return!0}var FieldMask=function(){function FieldMask(fields){this.fields=fields,fields.sort(FieldPath$1.comparator)}return FieldMask.prototype.covers=function(fieldPath){for(var _i=0,_d=this.fields;_i<_d.length;_i++){if(_d[_i].isPrefixOf(fieldPath))return!0}return!1},FieldMask.prototype.isEqual=function(other){return arrayEquals(this.fields,other.fields,function(l,r){return l.isEqual(r)})},FieldMask}();var ByteString=function(){function ByteString(binaryString){this.binaryString=binaryString}return ByteString.fromBase64String=function(base64){return new ByteString(function decodeBase64(encoded){if(/[^-A-Za-z0-9+/=]/.test(encoded))throw new FirestoreError(Code_INVALID_ARGUMENT,"Not a valid Base64 string: "+encoded);return new Buffer(encoded,"base64").toString("binary")}(base64))},ByteString.fromUint8Array=function(array){return new ByteString(function binaryStringFromUint8Array(array){for(var binaryString="",i=0;i<array.length;++i)binaryString+=String.fromCharCode(array[i]);return binaryString}(array))},ByteString.prototype.toBase64=function(){return function encodeBase64(raw){return new Buffer(raw,"binary").toString("base64")}(this.binaryString)},ByteString.prototype.toUint8Array=function(){return function uint8ArrayFromBinaryString(binaryString){for(var buffer=new Uint8Array(binaryString.length),i=0;i<binaryString.length;i++)buffer[i]=binaryString.charCodeAt(i);return buffer}(this.binaryString)},ByteString.prototype.approximateByteSize=function(){return 2*this.binaryString.length},ByteString.prototype.compareTo=function(other){return primitiveComparator(this.binaryString,other.binaryString)},ByteString.prototype.isEqual=function(other){return this.binaryString===other.binaryString},ByteString}();ByteString.EMPTY_BYTE_STRING=new ByteString("");var ISO_TIMESTAMP_REG_EXP=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function normalizeTimestamp(date){if(hardAssert(!!date),"string"==typeof date){var nanos=0,fraction=ISO_TIMESTAMP_REG_EXP.exec(date);if(hardAssert(!!fraction),fraction[1]){var nanoStr=fraction[1];nanoStr=(nanoStr+"000000000").substr(0,9),nanos=Number(nanoStr)}var parsedDate=new Date(date);return{seconds:Math.floor(parsedDate.getTime()/1e3),nanos:nanos}}return{seconds:normalizeNumber(date.seconds),nanos:nanos=normalizeNumber(date.nanos)}}function normalizeNumber(value){return"number"==typeof value?value:"string"==typeof value?Number(value):0}function normalizeByteString(blob){return"string"==typeof blob?ByteString.fromBase64String(blob):ByteString.fromUint8Array(blob)}function isServerTimestamp(value){var _a,_b;return"server_timestamp"===(null===(_b=((null===(_a=null==value?void 0:value.mapValue)||void 0===_a?void 0:_a.fields)||{}).__type__)||void 0===_b?void 0:_b.stringValue)}function getPreviousValue(value){var previousValue=value.mapValue.fields.__previous_value__;return isServerTimestamp(previousValue)?getPreviousValue(previousValue):previousValue}function getLocalWriteTime(value){var localWriteTime=normalizeTimestamp(value.mapValue.fields.__local_write_time__.timestampValue);return new Timestamp(localWriteTime.seconds,localWriteTime.nanos)}function isNullOrUndefined(value){return null==value}function isNegativeZero(value){return 0===value&&1/value==-1/0}function isSafeInteger(value){return"number"==typeof value&&Number.isInteger(value)&&!isNegativeZero(value)&&value<=Number.MAX_SAFE_INTEGER&&value>=Number.MIN_SAFE_INTEGER}var DocumentKey=function(){function DocumentKey(path){this.path=path}return DocumentKey.fromPath=function(path){return new DocumentKey(ResourcePath.fromString(path))},DocumentKey.fromName=function(name){return new DocumentKey(ResourcePath.fromString(name).popFirst(5))},DocumentKey.prototype.hasCollectionId=function(collectionId){return this.path.length>=2&&this.path.get(this.path.length-2)===collectionId},DocumentKey.prototype.isEqual=function(other){return null!==other&&0===ResourcePath.comparator(this.path,other.path)},DocumentKey.prototype.toString=function(){return this.path.toString()},DocumentKey.comparator=function(k1,k2){return ResourcePath.comparator(k1.path,k2.path)},DocumentKey.isDocumentKey=function(path){return path.length%2==0},DocumentKey.fromSegments=function(segments){return new DocumentKey(new ResourcePath(segments.slice()))},DocumentKey}();function typeOrder(value){return"nullValue"in value?0:"booleanValue"in value?1:"integerValue"in value||"doubleValue"in value?2:"timestampValue"in value?3:"stringValue"in value?5:"bytesValue"in value?6:"referenceValue"in value?7:"geoPointValue"in value?8:"arrayValue"in value?9:"mapValue"in value?isServerTimestamp(value)?4:10:fail()}function valueEquals(left,right){var leftType=typeOrder(left);if(leftType!==typeOrder(right))return!1;switch(leftType){case 0:return!0;case 1:return left.booleanValue===right.booleanValue;case 4:return getLocalWriteTime(left).isEqual(getLocalWriteTime(right));case 3:return function timestampEquals(left,right){if("string"==typeof left.timestampValue&&"string"==typeof right.timestampValue&&left.timestampValue.length===right.timestampValue.length)return left.timestampValue===right.timestampValue;var leftTimestamp=normalizeTimestamp(left.timestampValue),rightTimestamp=normalizeTimestamp(right.timestampValue);return leftTimestamp.seconds===rightTimestamp.seconds&&leftTimestamp.nanos===rightTimestamp.nanos}(left,right);case 5:return left.stringValue===right.stringValue;case 6:return function blobEquals(left,right){return normalizeByteString(left.bytesValue).isEqual(normalizeByteString(right.bytesValue))}(left,right);case 7:return left.referenceValue===right.referenceValue;case 8:return function geoPointEquals(left,right){return normalizeNumber(left.geoPointValue.latitude)===normalizeNumber(right.geoPointValue.latitude)&&normalizeNumber(left.geoPointValue.longitude)===normalizeNumber(right.geoPointValue.longitude)}(left,right);case 2:return function numberEquals(left,right){if("integerValue"in left&&"integerValue"in right)return normalizeNumber(left.integerValue)===normalizeNumber(right.integerValue);if("doubleValue"in left&&"doubleValue"in right){var n1=normalizeNumber(left.doubleValue),n2=normalizeNumber(right.doubleValue);return n1===n2?isNegativeZero(n1)===isNegativeZero(n2):isNaN(n1)&&isNaN(n2)}return!1}(left,right);case 9:return arrayEquals(left.arrayValue.values||[],right.arrayValue.values||[],valueEquals);case 10:return function objectEquals(left,right){var leftMap=left.mapValue.fields||{},rightMap=right.mapValue.fields||{};if(objectSize(leftMap)!==objectSize(rightMap))return!1;for(var key in leftMap)if(leftMap.hasOwnProperty(key)&&(void 0===rightMap[key]||!valueEquals(leftMap[key],rightMap[key])))return!1;return!0}(left,right);default:return fail()}}function arrayValueContains(haystack,needle){return void 0!==(haystack.values||[]).find(function(v){return valueEquals(v,needle)})}function valueCompare(left,right){var leftType=typeOrder(left),rightType=typeOrder(right);if(leftType!==rightType)return primitiveComparator(leftType,rightType);switch(leftType){case 0:return 0;case 1:return primitiveComparator(left.booleanValue,right.booleanValue);case 2:return function compareNumbers(left,right){var leftNumber=normalizeNumber(left.integerValue||left.doubleValue),rightNumber=normalizeNumber(right.integerValue||right.doubleValue);return leftNumber<rightNumber?-1:leftNumber>rightNumber?1:leftNumber===rightNumber?0:isNaN(leftNumber)?isNaN(rightNumber)?0:-1:1}(left,right);case 3:return compareTimestamps(left.timestampValue,right.timestampValue);case 4:return compareTimestamps(getLocalWriteTime(left),getLocalWriteTime(right));case 5:return primitiveComparator(left.stringValue,right.stringValue);case 6:return function compareBlobs(left,right){var leftBytes=normalizeByteString(left),rightBytes=normalizeByteString(right);return leftBytes.compareTo(rightBytes)}(left.bytesValue,right.bytesValue);case 7:return function compareReferences(leftPath,rightPath){for(var leftSegments=leftPath.split("/"),rightSegments=rightPath.split("/"),i=0;i<leftSegments.length&&i<rightSegments.length;i++){var comparison=primitiveComparator(leftSegments[i],rightSegments[i]);if(0!==comparison)return comparison}return primitiveComparator(leftSegments.length,rightSegments.length)}(left.referenceValue,right.referenceValue);case 8:return function compareGeoPoints(left,right){var comparison=primitiveComparator(normalizeNumber(left.latitude),normalizeNumber(right.latitude));if(0!==comparison)return comparison;return primitiveComparator(normalizeNumber(left.longitude),normalizeNumber(right.longitude))}(left.geoPointValue,right.geoPointValue);case 9:return function compareArrays(left,right){for(var leftArray=left.values||[],rightArray=right.values||[],i=0;i<leftArray.length&&i<rightArray.length;++i){var compare=valueCompare(leftArray[i],rightArray[i]);if(compare)return compare}return primitiveComparator(leftArray.length,rightArray.length)}(left.arrayValue,right.arrayValue);case 10:return function compareMaps(left,right){var leftMap=left.fields||{},leftKeys=Object.keys(leftMap),rightMap=right.fields||{},rightKeys=Object.keys(rightMap);leftKeys.sort(),rightKeys.sort();for(var i=0;i<leftKeys.length&&i<rightKeys.length;++i){var keyCompare=primitiveComparator(leftKeys[i],rightKeys[i]);if(0!==keyCompare)return keyCompare;var compare=valueCompare(leftMap[leftKeys[i]],rightMap[rightKeys[i]]);if(0!==compare)return compare}return primitiveComparator(leftKeys.length,rightKeys.length)}(left.mapValue,right.mapValue);default:throw fail()}}function compareTimestamps(left,right){if("string"==typeof left&&"string"==typeof right&&left.length===right.length)return primitiveComparator(left,right);var leftTimestamp=normalizeTimestamp(left),rightTimestamp=normalizeTimestamp(right),comparison=primitiveComparator(leftTimestamp.seconds,rightTimestamp.seconds);return 0!==comparison?comparison:primitiveComparator(leftTimestamp.nanos,rightTimestamp.nanos)}function canonicalId(value){return canonifyValue(value)}function canonifyValue(value){return"nullValue"in value?"null":"booleanValue"in value?""+value.booleanValue:"integerValue"in value?""+value.integerValue:"doubleValue"in value?""+value.doubleValue:"timestampValue"in value?function canonifyTimestamp(timestamp){var normalizedTimestamp=normalizeTimestamp(timestamp);return"time("+normalizedTimestamp.seconds+","+normalizedTimestamp.nanos+")"}(value.timestampValue):"stringValue"in value?value.stringValue:"bytesValue"in value?function canonifyByteString(byteString){return normalizeByteString(byteString).toBase64()}(value.bytesValue):"referenceValue"in value?function canonifyReference(referenceValue){return DocumentKey.fromName(referenceValue).toString()}(value.referenceValue):"geoPointValue"in value?function canonifyGeoPoint(geoPoint){return"geo("+geoPoint.latitude+","+geoPoint.longitude+")"}(value.geoPointValue):"arrayValue"in value?function canonifyArray(arrayValue){for(var result="[",first=!0,_i=0,_d=arrayValue.values||[];_i<_d.length;_i++){first?first=!1:result+=",",result+=canonifyValue(_d[_i])}return result+"]"}(value.arrayValue):"mapValue"in value?function canonifyMap(mapValue){for(var sortedKeys=Object.keys(mapValue.fields||{}).sort(),result="{",first=!0,_i=0,sortedKeys_1=sortedKeys;_i<sortedKeys_1.length;_i++){var key=sortedKeys_1[_i];first?first=!1:result+=",",result+=key+":"+canonifyValue(mapValue.fields[key])}return result+"}"}(value.mapValue):fail()}function refValue(databaseId,key){return{referenceValue:"projects/"+databaseId.projectId+"/databases/"+databaseId.database+"/documents/"+key.path.canonicalString()}}function isInteger(value){return!!value&&"integerValue"in value}function isArray(value){return!!value&&"arrayValue"in value}function isNullValue(value){return!!value&&"nullValue"in value}function isNanValue(value){return!!value&&"doubleValue"in value&&isNaN(Number(value.doubleValue))}function isMapValue(value){return!!value&&"mapValue"in value}function deepClone(source){if(source.geoPointValue)return{geoPointValue:Object.assign({},source.geoPointValue)};if(source.timestampValue)return{timestampValue:Object.assign({},normalizeTimestamp(source.timestampValue))};if(source.mapValue){var target_1={mapValue:{fields:{}}};return forEach(source.mapValue.fields,function(key,val){return target_1.mapValue.fields[key]=deepClone(val)}),target_1}if(source.arrayValue){for(var target={arrayValue:{values:[]}},i=0;i<(source.arrayValue.values||[]).length;++i)target.arrayValue.values[i]=deepClone(source.arrayValue.values[i]);return target}return Object.assign({},source)}var ObjectValue=function(){function ObjectValue(value){this.value=value}return ObjectValue.empty=function(){return new ObjectValue({mapValue:{}})},ObjectValue.prototype.field=function(path){if(path.isEmpty())return this.value;for(var currentLevel=this.value,i=0;i<path.length-1;++i)if(!isMapValue(currentLevel=(currentLevel.mapValue.fields||{})[path.get(i)]))return null;return(currentLevel=(currentLevel.mapValue.fields||{})[path.lastSegment()])||null},ObjectValue.prototype.set=function(path,value){this.getFieldsMap(path.popLast())[path.lastSegment()]=deepClone(value)},ObjectValue.prototype.setAll=function(data){var _this=this,parent=FieldPath$1.emptyPath(),upserts={},deletes=[];data.forEach(function(value,path){if(!parent.isImmediateParentOf(path)){var fieldsMap_1=_this.getFieldsMap(parent);_this.applyChanges(fieldsMap_1,upserts,deletes),upserts={},deletes=[],parent=path.popLast()}value?upserts[path.lastSegment()]=deepClone(value):deletes.push(path.lastSegment())});var fieldsMap=this.getFieldsMap(parent);this.applyChanges(fieldsMap,upserts,deletes)},ObjectValue.prototype.delete=function(path){var nestedValue=this.field(path.popLast());isMapValue(nestedValue)&&nestedValue.mapValue.fields&&delete nestedValue.mapValue.fields[path.lastSegment()]},ObjectValue.prototype.isEqual=function(other){return valueEquals(this.value,other.value)},ObjectValue.prototype.getFieldsMap=function(path){var current=this.value;current.mapValue.fields||(current.mapValue={fields:{}});for(var i=0;i<path.length;++i){var next=current.mapValue.fields[path.get(i)];isMapValue(next)&&next.mapValue.fields||(next={mapValue:{fields:{}}},current.mapValue.fields[path.get(i)]=next),current=next}return current.mapValue.fields},ObjectValue.prototype.applyChanges=function(fieldsMap,inserts,deletes){forEach(inserts,function(key,val){return fieldsMap[key]=val});for(var _i=0,deletes_1=deletes;_i<deletes_1.length;_i++){var field=deletes_1[_i];delete fieldsMap[field]}},ObjectValue.prototype.clone=function(){return new ObjectValue(deepClone(this.value))},ObjectValue}();function extractFieldMask(value){var fields=[];return forEach(value.fields,function(key,value){var currentPath=new FieldPath$1([key]);if(isMapValue(value)){var nestedFields=extractFieldMask(value.mapValue).fields;if(0===nestedFields.length)fields.push(currentPath);else for(var _i=0,nestedFields_1=nestedFields;_i<nestedFields_1.length;_i++){var nestedPath=nestedFields_1[_i];fields.push(currentPath.child(nestedPath))}}else fields.push(currentPath)}),new FieldMask(fields)}var MutableDocument=function(){function MutableDocument(key,documentType,version,data,documentState){this.key=key,this.documentType=documentType,this.version=version,this.data=data,this.documentState=documentState}return MutableDocument.newInvalidDocument=function(documentKey){return new MutableDocument(documentKey,0,SnapshotVersion.min(),ObjectValue.empty(),0)},MutableDocument.newFoundDocument=function(documentKey,version,value){return new MutableDocument(documentKey,1,version,value,0)},MutableDocument.newNoDocument=function(documentKey,version){return new MutableDocument(documentKey,2,version,ObjectValue.empty(),0)},MutableDocument.newUnknownDocument=function(documentKey,version){return new MutableDocument(documentKey,3,version,ObjectValue.empty(),2)},MutableDocument.prototype.convertToFoundDocument=function(version,value){return this.version=version,this.documentType=1,this.data=value,this.documentState=0,this},MutableDocument.prototype.convertToNoDocument=function(version){return this.version=version,this.documentType=2,this.data=ObjectValue.empty(),this.documentState=0,this},MutableDocument.prototype.convertToUnknownDocument=function(version){return this.version=version,this.documentType=3,this.data=ObjectValue.empty(),this.documentState=2,this},MutableDocument.prototype.setHasCommittedMutations=function(){return this.documentState=2,this},MutableDocument.prototype.setHasLocalMutations=function(){return this.documentState=1,this},Object.defineProperty(MutableDocument.prototype,"hasLocalMutations",{get:function(){return 1===this.documentState},enumerable:!1,configurable:!0}),Object.defineProperty(MutableDocument.prototype,"hasCommittedMutations",{get:function(){return 2===this.documentState},enumerable:!1,configurable:!0}),Object.defineProperty(MutableDocument.prototype,"hasPendingWrites",{get:function(){return this.hasLocalMutations||this.hasCommittedMutations},enumerable:!1,configurable:!0}),MutableDocument.prototype.isValidDocument=function(){return 0!==this.documentType},MutableDocument.prototype.isFoundDocument=function(){return 1===this.documentType},MutableDocument.prototype.isNoDocument=function(){return 2===this.documentType},MutableDocument.prototype.isUnknownDocument=function(){return 3===this.documentType},MutableDocument.prototype.isEqual=function(other){return other instanceof MutableDocument&&this.key.isEqual(other.key)&&this.version.isEqual(other.version)&&this.documentType===other.documentType&&this.documentState===other.documentState&&this.data.isEqual(other.data)},MutableDocument.prototype.clone=function(){return new MutableDocument(this.key,this.documentType,this.version,this.data.clone(),this.documentState)},MutableDocument.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+JSON.stringify(this.data.value)+", {documentType: "+this.documentType+"}), {documentState: "+this.documentState+"})"},MutableDocument}();var TargetImpl=function TargetImpl(path,collectionGroup,orderBy,filters,limit,startAt,endAt){void 0===collectionGroup&&(collectionGroup=null),void 0===orderBy&&(orderBy=[]),void 0===filters&&(filters=[]),void 0===limit&&(limit=null),void 0===startAt&&(startAt=null),void 0===endAt&&(endAt=null),this.path=path,this.collectionGroup=collectionGroup,this.orderBy=orderBy,this.filters=filters,this.limit=limit,this.startAt=startAt,this.endAt=endAt,this.memoizedCanonicalId=null};function newTarget(path,collectionGroup,orderBy,filters,limit,startAt,endAt){return void 0===collectionGroup&&(collectionGroup=null),void 0===orderBy&&(orderBy=[]),void 0===filters&&(filters=[]),void 0===limit&&(limit=null),void 0===startAt&&(startAt=null),void 0===endAt&&(endAt=null),new TargetImpl(path,collectionGroup,orderBy,filters,limit,startAt,endAt)}function canonifyTarget(target){var targetImpl=debugCast(target);if(null===targetImpl.memoizedCanonicalId){var canonicalId_1=targetImpl.path.canonicalString();null!==targetImpl.collectionGroup&&(canonicalId_1+="|cg:"+targetImpl.collectionGroup),canonicalId_1+="|f:",canonicalId_1+=targetImpl.filters.map(function(f){return function canonifyFilter(filter){return filter.field.canonicalString()+filter.op.toString()+canonicalId(filter.value)}(f)}).join(","),canonicalId_1+="|ob:",canonicalId_1+=targetImpl.orderBy.map(function(o){return function canonifyOrderBy(orderBy){return orderBy.field.canonicalString()+orderBy.dir}(o)}).join(","),isNullOrUndefined(targetImpl.limit)||(canonicalId_1+="|l:",canonicalId_1+=targetImpl.limit),targetImpl.startAt&&(canonicalId_1+="|lb:",canonicalId_1+=canonifyBound(targetImpl.startAt)),targetImpl.endAt&&(canonicalId_1+="|ub:",canonicalId_1+=canonifyBound(targetImpl.endAt)),targetImpl.memoizedCanonicalId=canonicalId_1}return targetImpl.memoizedCanonicalId}function stringifyTarget(target){var str=target.path.canonicalString();return null!==target.collectionGroup&&(str+=" collectionGroup="+target.collectionGroup),target.filters.length>0&&(str+=", filters: ["+target.filters.map(function(f){return function stringifyFilter(filter){return filter.field.canonicalString()+" "+filter.op+" "+canonicalId(filter.value)}(f)}).join(", ")+"]"),isNullOrUndefined(target.limit)||(str+=", limit: "+target.limit),target.orderBy.length>0&&(str+=", orderBy: ["+target.orderBy.map(function(o){return function stringifyOrderBy(orderBy){return orderBy.field.canonicalString()+" ("+orderBy.dir+")"}(o)}).join(", ")+"]"),target.startAt&&(str+=", startAt: "+canonifyBound(target.startAt)),target.endAt&&(str+=", endAt: "+canonifyBound(target.endAt)),"Target("+str+")"}function targetEquals(left,right){if(left.limit!==right.limit)return!1;if(left.orderBy.length!==right.orderBy.length)return!1;for(var i=0;i<left.orderBy.length;i++)if(!orderByEquals(left.orderBy[i],right.orderBy[i]))return!1;if(left.filters.length!==right.filters.length)return!1;for(i=0;i<left.filters.length;i++)if(f1=left.filters[i],f2=right.filters[i],f1.op!==f2.op||!f1.field.isEqual(f2.field)||!valueEquals(f1.value,f2.value))return!1;var f1,f2;return left.collectionGroup===right.collectionGroup&&(!!left.path.isEqual(right.path)&&(!!boundEquals(left.startAt,right.startAt)&&boundEquals(left.endAt,right.endAt)))}function isDocumentTarget(target){return DocumentKey.isDocumentKey(target.path)&&null===target.collectionGroup&&0===target.filters.length}var FieldFilter=function(_super){function FieldFilter(field,op,value){var _this=_super.call(this)||this;return _this.field=field,_this.op=op,_this.value=value,_this}return tslib.__extends(FieldFilter,_super),FieldFilter.create=function(field,op,value){return field.isKeyField()?"in"===op||"not-in"===op?this.createKeyFieldInFilter(field,op,value):new KeyFieldFilter(field,op,value):"array-contains"===op?new ArrayContainsFilter(field,value):"in"===op?new InFilter(field,value):"not-in"===op?new NotInFilter(field,value):"array-contains-any"===op?new ArrayContainsAnyFilter(field,value):new FieldFilter(field,op,value)},FieldFilter.createKeyFieldInFilter=function(field,op,value){return"in"===op?new KeyFieldInFilter(field,value):new KeyFieldNotInFilter(field,value)},FieldFilter.prototype.matches=function(doc){var other=doc.data.field(this.field);return"!="===this.op?null!==other&&this.matchesComparison(valueCompare(other,this.value)):null!==other&&typeOrder(this.value)===typeOrder(other)&&this.matchesComparison(valueCompare(other,this.value))},FieldFilter.prototype.matchesComparison=function(comparison){switch(this.op){case"<":return comparison<0;case"<=":return comparison<=0;case"==":return 0===comparison;case"!=":return 0!==comparison;case">":return comparison>0;case">=":return comparison>=0;default:return fail()}},FieldFilter.prototype.isInequality=function(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0},FieldFilter}(function Filter(){});var KeyFieldFilter=function(_super){function KeyFieldFilter(field,op,value){var _this=_super.call(this,field,op,value)||this;return _this.key=DocumentKey.fromName(value.referenceValue),_this}return tslib.__extends(KeyFieldFilter,_super),KeyFieldFilter.prototype.matches=function(doc){var comparison=DocumentKey.comparator(doc.key,this.key);return this.matchesComparison(comparison)},KeyFieldFilter}(FieldFilter),KeyFieldInFilter=function(_super){function KeyFieldInFilter(field,value){var _this=_super.call(this,field,"in",value)||this;return _this.keys=extractDocumentKeysFromArrayValue("in",value),_this}return tslib.__extends(KeyFieldInFilter,_super),KeyFieldInFilter.prototype.matches=function(doc){return this.keys.some(function(key){return key.isEqual(doc.key)})},KeyFieldInFilter}(FieldFilter),KeyFieldNotInFilter=function(_super){function KeyFieldNotInFilter(field,value){var _this=_super.call(this,field,"not-in",value)||this;return _this.keys=extractDocumentKeysFromArrayValue("not-in",value),_this}return tslib.__extends(KeyFieldNotInFilter,_super),KeyFieldNotInFilter.prototype.matches=function(doc){return!this.keys.some(function(key){return key.isEqual(doc.key)})},KeyFieldNotInFilter}(FieldFilter);function extractDocumentKeysFromArrayValue(op,value){var _a;return((null===(_a=value.arrayValue)||void 0===_a?void 0:_a.values)||[]).map(function(v){return DocumentKey.fromName(v.referenceValue)})}var ArrayContainsFilter=function(_super){function ArrayContainsFilter(field,value){return _super.call(this,field,"array-contains",value)||this}return tslib.__extends(ArrayContainsFilter,_super),ArrayContainsFilter.prototype.matches=function(doc){var other=doc.data.field(this.field);return isArray(other)&&arrayValueContains(other.arrayValue,this.value)},ArrayContainsFilter}(FieldFilter),InFilter=function(_super){function InFilter(field,value){return _super.call(this,field,"in",value)||this}return tslib.__extends(InFilter,_super),InFilter.prototype.matches=function(doc){var other=doc.data.field(this.field);return null!==other&&arrayValueContains(this.value.arrayValue,other)},InFilter}(FieldFilter),NotInFilter=function(_super){function NotInFilter(field,value){return _super.call(this,field,"not-in",value)||this}return tslib.__extends(NotInFilter,_super),NotInFilter.prototype.matches=function(doc){if(arrayValueContains(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;var other=doc.data.field(this.field);return null!==other&&!arrayValueContains(this.value.arrayValue,other)},NotInFilter}(FieldFilter),ArrayContainsAnyFilter=function(_super){function ArrayContainsAnyFilter(field,value){return _super.call(this,field,"array-contains-any",value)||this}return tslib.__extends(ArrayContainsAnyFilter,_super),ArrayContainsAnyFilter.prototype.matches=function(doc){var _this=this,other=doc.data.field(this.field);return!(!isArray(other)||!other.arrayValue.values)&&other.arrayValue.values.some(function(val){return arrayValueContains(_this.value.arrayValue,val)})},ArrayContainsAnyFilter}(FieldFilter),Bound=function Bound(position,before){this.position=position,this.before=before};function canonifyBound(bound){return(bound.before?"b":"a")+":"+bound.position.map(function(p){return canonicalId(p)}).join(",")}var OrderBy=function OrderBy(field,dir){void 0===dir&&(dir="asc"),this.field=field,this.dir=dir};function orderByEquals(left,right){return left.dir===right.dir&&left.field.isEqual(right.field)}function sortsBeforeDocument(bound,orderBy,doc){for(var comparison=0,i=0;i<bound.position.length;i++){var orderByComponent=orderBy[i],component=bound.position[i];if(orderByComponent.field.isKeyField())comparison=DocumentKey.comparator(DocumentKey.fromName(component.referenceValue),doc.key);else comparison=valueCompare(component,doc.data.field(orderByComponent.field));if("desc"===orderByComponent.dir&&(comparison*=-1),0!==comparison)break}return bound.before?comparison<=0:comparison<0}function boundEquals(left,right){if(null===left)return null===right;if(null===right)return!1;if(left.before!==right.before||left.position.length!==right.position.length)return!1;for(var i=0;i<left.position.length;i++){if(!valueEquals(left.position[i],right.position[i]))return!1}return!0}var QueryImpl=function QueryImpl(path,collectionGroup,explicitOrderBy,filters,limit,limitType,startAt,endAt){void 0===collectionGroup&&(collectionGroup=null),void 0===explicitOrderBy&&(explicitOrderBy=[]),void 0===filters&&(filters=[]),void 0===limit&&(limit=null),void 0===limitType&&(limitType="F"),void 0===startAt&&(startAt=null),void 0===endAt&&(endAt=null),this.path=path,this.collectionGroup=collectionGroup,this.explicitOrderBy=explicitOrderBy,this.filters=filters,this.limit=limit,this.limitType=limitType,this.startAt=startAt,this.endAt=endAt,this.memoizedOrderBy=null,this.memoizedTarget=null,this.startAt,this.endAt};function newQuery(path,collectionGroup,explicitOrderBy,filters,limit,limitType,startAt,endAt){return new QueryImpl(path,collectionGroup,explicitOrderBy,filters,limit,limitType,startAt,endAt)}function newQueryForPath(path){return new QueryImpl(path)}function hasLimitToFirst(query){return!isNullOrUndefined(query.limit)&&"F"===query.limitType}function hasLimitToLast(query){return!isNullOrUndefined(query.limit)&&"L"===query.limitType}function getFirstOrderByField(query){return query.explicitOrderBy.length>0?query.explicitOrderBy[0].field:null}function getInequalityFilterField(query){for(var _i=0,_d=query.filters;_i<_d.length;_i++){var filter=_d[_i];if(filter.isInequality())return filter.field}return null}function isCollectionGroupQuery(query){return null!==query.collectionGroup}function queryOrderBy(query){var queryImpl=debugCast(query);if(null===queryImpl.memoizedOrderBy){queryImpl.memoizedOrderBy=[];var inequalityField=getInequalityFilterField(queryImpl),firstOrderByField=getFirstOrderByField(queryImpl);if(null!==inequalityField&&null===firstOrderByField)inequalityField.isKeyField()||queryImpl.memoizedOrderBy.push(new OrderBy(inequalityField)),queryImpl.memoizedOrderBy.push(new OrderBy(FieldPath$1.keyField(),"asc"));else{for(var foundKeyOrdering=!1,_i=0,_d=queryImpl.explicitOrderBy;_i<_d.length;_i++){var orderBy_1=_d[_i];queryImpl.memoizedOrderBy.push(orderBy_1),orderBy_1.field.isKeyField()&&(foundKeyOrdering=!0)}if(!foundKeyOrdering){var lastDirection=queryImpl.explicitOrderBy.length>0?queryImpl.explicitOrderBy[queryImpl.explicitOrderBy.length-1].dir:"asc";queryImpl.memoizedOrderBy.push(new OrderBy(FieldPath$1.keyField(),lastDirection))}}}return queryImpl.memoizedOrderBy}function queryToTarget(query){var queryImpl=debugCast(query);if(!queryImpl.memoizedTarget)if("F"===queryImpl.limitType)queryImpl.memoizedTarget=newTarget(queryImpl.path,queryImpl.collectionGroup,queryOrderBy(queryImpl),queryImpl.filters,queryImpl.limit,queryImpl.startAt,queryImpl.endAt);else{for(var orderBys=[],_i=0,_d=queryOrderBy(queryImpl);_i<_d.length;_i++){var orderBy_2=_d[_i],dir="desc"===orderBy_2.dir?"asc":"desc";orderBys.push(new OrderBy(orderBy_2.field,dir))}var startAt_1=queryImpl.endAt?new Bound(queryImpl.endAt.position,!queryImpl.endAt.before):null,endAt_1=queryImpl.startAt?new Bound(queryImpl.startAt.position,!queryImpl.startAt.before):null;queryImpl.memoizedTarget=newTarget(queryImpl.path,queryImpl.collectionGroup,orderBys,queryImpl.filters,queryImpl.limit,startAt_1,endAt_1)}return queryImpl.memoizedTarget}function queryWithLimit(query,limit,limitType){return new QueryImpl(query.path,query.collectionGroup,query.explicitOrderBy.slice(),query.filters.slice(),limit,limitType,query.startAt,query.endAt)}function queryEquals(left,right){return targetEquals(queryToTarget(left),queryToTarget(right))&&left.limitType===right.limitType}function canonifyQuery(query){return canonifyTarget(queryToTarget(query))+"|lt:"+query.limitType}function stringifyQuery(query){return"Query(target="+stringifyTarget(queryToTarget(query))+"; limitType="+query.limitType+")"}function queryMatches(query,doc){return doc.isFoundDocument()&&function queryMatchesPathAndCollectionGroup(query,doc){var docPath=doc.key.path;return null!==query.collectionGroup?doc.key.hasCollectionId(query.collectionGroup)&&query.path.isPrefixOf(docPath):DocumentKey.isDocumentKey(query.path)?query.path.isEqual(docPath):query.path.isImmediateParentOf(docPath)}(query,doc)&&function queryMatchesOrderBy(query,doc){for(var _i=0,_d=query.explicitOrderBy;_i<_d.length;_i++){var orderBy_3=_d[_i];if(!orderBy_3.field.isKeyField()&&null===doc.data.field(orderBy_3.field))return!1}return!0}(query,doc)&&function queryMatchesFilters(query,doc){for(var _i=0,_d=query.filters;_i<_d.length;_i++){if(!_d[_i].matches(doc))return!1}return!0}(query,doc)&&function queryMatchesBounds(query,doc){if(query.startAt&&!sortsBeforeDocument(query.startAt,queryOrderBy(query),doc))return!1;if(query.endAt&&sortsBeforeDocument(query.endAt,queryOrderBy(query),doc))return!1;return!0}(query,doc)}function newQueryComparator(query){return function(d1,d2){for(var comparedOnKeyField=!1,_i=0,_d=queryOrderBy(query);_i<_d.length;_i++){var orderBy_4=_d[_i],comp=compareDocs(orderBy_4,d1,d2);if(0!==comp)return comp;comparedOnKeyField=comparedOnKeyField||orderBy_4.field.isKeyField()}return 0}}function compareDocs(orderBy,d1,d2){var comparison=orderBy.field.isKeyField()?DocumentKey.comparator(d1.key,d2.key):function compareDocumentsByField(field,d1,d2){var v1=d1.data.field(field),v2=d2.data.field(field);return null!==v1&&null!==v2?valueCompare(v1,v2):fail()}(orderBy.field,d1,d2);switch(orderBy.dir){case"asc":return comparison;case"desc":return-1*comparison;default:return fail()}}var SortedMap=function(){function SortedMap(comparator,root){this.comparator=comparator,this.root=root||LLRBNode.EMPTY}return SortedMap.prototype.insert=function(key,value){return new SortedMap(this.comparator,this.root.insert(key,value,this.comparator).copy(null,null,LLRBNode.BLACK,null,null))},SortedMap.prototype.remove=function(key){return new SortedMap(this.comparator,this.root.remove(key,this.comparator).copy(null,null,LLRBNode.BLACK,null,null))},SortedMap.prototype.get=function(key){for(var node=this.root;!node.isEmpty();){var cmp=this.comparator(key,node.key);if(0===cmp)return node.value;cmp<0?node=node.left:cmp>0&&(node=node.right)}return null},SortedMap.prototype.indexOf=function(key){for(var prunedNodes=0,node=this.root;!node.isEmpty();){var cmp=this.comparator(key,node.key);if(0===cmp)return prunedNodes+node.left.size;cmp<0?node=node.left:(prunedNodes+=node.left.size+1,node=node.right)}return-1},SortedMap.prototype.isEmpty=function(){return this.root.isEmpty()},Object.defineProperty(SortedMap.prototype,"size",{get:function(){return this.root.size},enumerable:!1,configurable:!0}),SortedMap.prototype.minKey=function(){return this.root.minKey()},SortedMap.prototype.maxKey=function(){return this.root.maxKey()},SortedMap.prototype.inorderTraversal=function(action){return this.root.inorderTraversal(action)},SortedMap.prototype.forEach=function(fn){this.inorderTraversal(function(k,v){return fn(k,v),!1})},SortedMap.prototype.toString=function(){var descriptions=[];return this.inorderTraversal(function(k,v){return descriptions.push(k+":"+v),!1}),"{"+descriptions.join(", ")+"}"},SortedMap.prototype.reverseTraversal=function(action){return this.root.reverseTraversal(action)},SortedMap.prototype.getIterator=function(){return new SortedMapIterator(this.root,null,this.comparator,!1)},SortedMap.prototype.getIteratorFrom=function(key){return new SortedMapIterator(this.root,key,this.comparator,!1)},SortedMap.prototype.getReverseIterator=function(){return new SortedMapIterator(this.root,null,this.comparator,!0)},SortedMap.prototype.getReverseIteratorFrom=function(key){return new SortedMapIterator(this.root,key,this.comparator,!0)},SortedMap}(),SortedMapIterator=function(){function SortedMapIterator(node,startKey,comparator,isReverse){this.isReverse=isReverse,this.nodeStack=[];for(var cmp=1;!node.isEmpty();)if(cmp=startKey?comparator(node.key,startKey):1,isReverse&&(cmp*=-1),cmp<0)node=this.isReverse?node.left:node.right;else{if(0===cmp){this.nodeStack.push(node);break}this.nodeStack.push(node),node=this.isReverse?node.right:node.left}}return SortedMapIterator.prototype.getNext=function(){var node=this.nodeStack.pop(),result={key:node.key,value:node.value};if(this.isReverse)for(node=node.left;!node.isEmpty();)this.nodeStack.push(node),node=node.right;else for(node=node.right;!node.isEmpty();)this.nodeStack.push(node),node=node.left;return result},SortedMapIterator.prototype.hasNext=function(){return this.nodeStack.length>0},SortedMapIterator.prototype.peek=function(){if(0===this.nodeStack.length)return null;var node=this.nodeStack[this.nodeStack.length-1];return{key:node.key,value:node.value}},SortedMapIterator}(),LLRBNode=function(){function LLRBNode(key,value,color,left,right){this.key=key,this.value=value,this.color=null!=color?color:LLRBNode.RED,this.left=null!=left?left:LLRBNode.EMPTY,this.right=null!=right?right:LLRBNode.EMPTY,this.size=this.left.size+1+this.right.size}return LLRBNode.prototype.copy=function(key,value,color,left,right){return new LLRBNode(null!=key?key:this.key,null!=value?value:this.value,null!=color?color:this.color,null!=left?left:this.left,null!=right?right:this.right)},LLRBNode.prototype.isEmpty=function(){return!1},LLRBNode.prototype.inorderTraversal=function(action){return this.left.inorderTraversal(action)||action(this.key,this.value)||this.right.inorderTraversal(action)},LLRBNode.prototype.reverseTraversal=function(action){return this.right.reverseTraversal(action)||action(this.key,this.value)||this.left.reverseTraversal(action)},LLRBNode.prototype.min=function(){return this.left.isEmpty()?this:this.left.min()},LLRBNode.prototype.minKey=function(){return this.min().key},LLRBNode.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},LLRBNode.prototype.insert=function(key,value,comparator){var n=this,cmp=comparator(key,n.key);return(n=cmp<0?n.copy(null,null,null,n.left.insert(key,value,comparator),null):0===cmp?n.copy(null,value,null,null,null):n.copy(null,null,null,null,n.right.insert(key,value,comparator))).fixUp()},LLRBNode.prototype.removeMin=function(){if(this.left.isEmpty())return LLRBNode.EMPTY;var n=this;return n.left.isRed()||n.left.left.isRed()||(n=n.moveRedLeft()),(n=n.copy(null,null,null,n.left.removeMin(),null)).fixUp()},LLRBNode.prototype.remove=function(key,comparator){var smallest,n=this;if(comparator(key,n.key)<0)n.left.isEmpty()||n.left.isRed()||n.left.left.isRed()||(n=n.moveRedLeft()),n=n.copy(null,null,null,n.left.remove(key,comparator),null);else{if(n.left.isRed()&&(n=n.rotateRight()),n.right.isEmpty()||n.right.isRed()||n.right.left.isRed()||(n=n.moveRedRight()),0===comparator(key,n.key)){if(n.right.isEmpty())return LLRBNode.EMPTY;smallest=n.right.min(),n=n.copy(smallest.key,smallest.value,null,null,n.right.removeMin())}n=n.copy(null,null,null,null,n.right.remove(key,comparator))}return n.fixUp()},LLRBNode.prototype.isRed=function(){return this.color},LLRBNode.prototype.fixUp=function(){var n=this;return n.right.isRed()&&!n.left.isRed()&&(n=n.rotateLeft()),n.left.isRed()&&n.left.left.isRed()&&(n=n.rotateRight()),n.left.isRed()&&n.right.isRed()&&(n=n.colorFlip()),n},LLRBNode.prototype.moveRedLeft=function(){var n=this.colorFlip();return n.right.left.isRed()&&(n=(n=(n=n.copy(null,null,null,null,n.right.rotateRight())).rotateLeft()).colorFlip()),n},LLRBNode.prototype.moveRedRight=function(){var n=this.colorFlip();return n.left.left.isRed()&&(n=(n=n.rotateRight()).colorFlip()),n},LLRBNode.prototype.rotateLeft=function(){var nl=this.copy(null,null,LLRBNode.RED,null,this.right.left);return this.right.copy(null,null,this.color,nl,null)},LLRBNode.prototype.rotateRight=function(){var nr=this.copy(null,null,LLRBNode.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,nr)},LLRBNode.prototype.colorFlip=function(){var left=this.left.copy(null,null,!this.left.color,null,null),right=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,left,right)},LLRBNode.prototype.checkMaxDepth=function(){var blackDepth=this.check();return Math.pow(2,blackDepth)<=this.size+1},LLRBNode.prototype.check=function(){if(this.isRed()&&this.left.isRed())throw fail();if(this.right.isRed())throw fail();var blackDepth=this.left.check();if(blackDepth!==this.right.check())throw fail();return blackDepth+(this.isRed()?0:1)},LLRBNode}();LLRBNode.EMPTY=null,LLRBNode.RED=!0,LLRBNode.BLACK=!1;var LLRBEmptyNode=function(){function LLRBEmptyNode(){this.size=0}return Object.defineProperty(LLRBEmptyNode.prototype,"key",{get:function(){throw fail()},enumerable:!1,configurable:!0}),Object.defineProperty(LLRBEmptyNode.prototype,"value",{get:function(){throw fail()},enumerable:!1,configurable:!0}),Object.defineProperty(LLRBEmptyNode.prototype,"color",{get:function(){throw fail()},enumerable:!1,configurable:!0}),Object.defineProperty(LLRBEmptyNode.prototype,"left",{get:function(){throw fail()},enumerable:!1,configurable:!0}),Object.defineProperty(LLRBEmptyNode.prototype,"right",{get:function(){throw fail()},enumerable:!1,configurable:!0}),LLRBEmptyNode.prototype.copy=function(key,value,color,left,right){return this},LLRBEmptyNode.prototype.insert=function(key,value,comparator){return new LLRBNode(key,value)},LLRBEmptyNode.prototype.remove=function(key,comparator){return this},LLRBEmptyNode.prototype.isEmpty=function(){return!0},LLRBEmptyNode.prototype.inorderTraversal=function(action){return!1},LLRBEmptyNode.prototype.reverseTraversal=function(action){return!1},LLRBEmptyNode.prototype.minKey=function(){return null},LLRBEmptyNode.prototype.maxKey=function(){return null},LLRBEmptyNode.prototype.isRed=function(){return!1},LLRBEmptyNode.prototype.checkMaxDepth=function(){return!0},LLRBEmptyNode.prototype.check=function(){return 0},LLRBEmptyNode}();LLRBNode.EMPTY=new LLRBEmptyNode;var SortedSet=function(){function SortedSet(comparator){this.comparator=comparator,this.data=new SortedMap(this.comparator)}return SortedSet.prototype.has=function(elem){return null!==this.data.get(elem)},SortedSet.prototype.first=function(){return this.data.minKey()},SortedSet.prototype.last=function(){return this.data.maxKey()},Object.defineProperty(SortedSet.prototype,"size",{get:function(){return this.data.size},enumerable:!1,configurable:!0}),SortedSet.prototype.indexOf=function(elem){return this.data.indexOf(elem)},SortedSet.prototype.forEach=function(cb){this.data.inorderTraversal(function(k,v){return cb(k),!1})},SortedSet.prototype.forEachInRange=function(range,cb){for(var iter=this.data.getIteratorFrom(range[0]);iter.hasNext();){var elem=iter.getNext();if(this.comparator(elem.key,range[1])>=0)return;cb(elem.key)}},SortedSet.prototype.forEachWhile=function(cb,start){var iter;for(iter=void 0!==start?this.data.getIteratorFrom(start):this.data.getIterator();iter.hasNext();){if(!cb(iter.getNext().key))return}},SortedSet.prototype.firstAfterOrEqual=function(elem){var iter=this.data.getIteratorFrom(elem);return iter.hasNext()?iter.getNext().key:null},SortedSet.prototype.getIterator=function(){return new SortedSetIterator(this.data.getIterator())},SortedSet.prototype.getIteratorFrom=function(key){return new SortedSetIterator(this.data.getIteratorFrom(key))},SortedSet.prototype.add=function(elem){return this.copy(this.data.remove(elem).insert(elem,!0))},SortedSet.prototype.delete=function(elem){return this.has(elem)?this.copy(this.data.remove(elem)):this},SortedSet.prototype.isEmpty=function(){return this.data.isEmpty()},SortedSet.prototype.unionWith=function(other){var result=this;return result.size<other.size&&(result=other,other=this),other.forEach(function(elem){result=result.add(elem)}),result},SortedSet.prototype.isEqual=function(other){if(!(other instanceof SortedSet))return!1;if(this.size!==other.size)return!1;for(var thisIt=this.data.getIterator(),otherIt=other.data.getIterator();thisIt.hasNext();){var thisElem=thisIt.getNext().key,otherElem=otherIt.getNext().key;if(0!==this.comparator(thisElem,otherElem))return!1}return!0},SortedSet.prototype.toArray=function(){var res=[];return this.forEach(function(targetId){res.push(targetId)}),res},SortedSet.prototype.toString=function(){var result=[];return this.forEach(function(elem){return result.push(elem)}),"SortedSet("+result.toString()+")"},SortedSet.prototype.copy=function(data){var result=new SortedSet(this.comparator);return result.data=data,result},SortedSet}(),SortedSetIterator=function(){function SortedSetIterator(iter){this.iter=iter}return SortedSetIterator.prototype.getNext=function(){return this.iter.getNext().key},SortedSetIterator.prototype.hasNext=function(){return this.iter.hasNext()},SortedSetIterator}(),EMPTY_MUTABLE_DOCUMENT_MAP=new SortedMap(DocumentKey.comparator);function mutableDocumentMap(){return EMPTY_MUTABLE_DOCUMENT_MAP}var EMPTY_DOCUMENT_MAP=new SortedMap(DocumentKey.comparator);function documentMap(){return EMPTY_DOCUMENT_MAP}var EMPTY_DOCUMENT_VERSION_MAP=new SortedMap(DocumentKey.comparator);function documentVersionMap(){return EMPTY_DOCUMENT_VERSION_MAP}var EMPTY_DOCUMENT_KEY_SET=new SortedSet(DocumentKey.comparator);function documentKeySet(){for(var keys=[],_i=0;_i<arguments.length;_i++)keys[_i]=arguments[_i];for(var set=EMPTY_DOCUMENT_KEY_SET,_d=0,keys_1=keys;_d<keys_1.length;_d++){var key=keys_1[_d];set=set.add(key)}return set}var EMPTY_TARGET_ID_SET=new SortedSet(primitiveComparator);function targetIdSet(){return EMPTY_TARGET_ID_SET}function toDouble(serializer,value){if(serializer.useProto3Json){if(isNaN(value))return{doubleValue:"NaN"};if(value===1/0)return{doubleValue:"Infinity"};if(value===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:isNegativeZero(value)?"-0":value}}function toInteger(value){return{integerValue:""+value}}function toNumber(serializer,value){return isSafeInteger(value)?toInteger(value):toDouble(serializer,value)}var TransformOperation=function TransformOperation(){this._=void 0};function applyTransformOperationToLocalView(transform,previousValue,localWriteTime){return transform instanceof ServerTimestampTransform?function serverTimestamp(localWriteTime,previousValue){var _d,mapValue={fields:(_d={},_d.__type__={stringValue:"server_timestamp"},_d.__local_write_time__={timestampValue:{seconds:localWriteTime.seconds,nanos:localWriteTime.nanoseconds}},_d)};return previousValue&&(mapValue.fields.__previous_value__=previousValue),{mapValue:mapValue}}(localWriteTime,previousValue):transform instanceof ArrayUnionTransformOperation?applyArrayUnionTransformOperation(transform,previousValue):transform instanceof ArrayRemoveTransformOperation?applyArrayRemoveTransformOperation(transform,previousValue):function applyNumericIncrementTransformOperationToLocalView(transform,previousValue){var baseValue=computeTransformOperationBaseValue(transform,previousValue),sum=asNumber(baseValue)+asNumber(transform.operand);return isInteger(baseValue)&&isInteger(transform.operand)?toInteger(sum):toDouble(transform.serializer,sum)}(transform,previousValue)}function applyTransformOperationToRemoteDocument(transform,previousValue,transformResult){return transform instanceof ArrayUnionTransformOperation?applyArrayUnionTransformOperation(transform,previousValue):transform instanceof ArrayRemoveTransformOperation?applyArrayRemoveTransformOperation(transform,previousValue):transformResult}function computeTransformOperationBaseValue(transform,previousValue){return transform instanceof NumericIncrementTransformOperation?function isNumber(value){return isInteger(value)||function isDouble(value){return!!value&&"doubleValue"in value}(value)}(previousValue)?previousValue:{integerValue:0}:null}var ServerTimestampTransform=function(_super){function ServerTimestampTransform(){return null!==_super&&_super.apply(this,arguments)||this}return tslib.__extends(ServerTimestampTransform,_super),ServerTimestampTransform}(TransformOperation),ArrayUnionTransformOperation=function(_super){function ArrayUnionTransformOperation(elements){var _this=_super.call(this)||this;return _this.elements=elements,_this}return tslib.__extends(ArrayUnionTransformOperation,_super),ArrayUnionTransformOperation}(TransformOperation);function applyArrayUnionTransformOperation(transform,previousValue){for(var values=coercedFieldValuesArray(previousValue),_loop_3=function(toUnion){values.some(function(element){return valueEquals(element,toUnion)})||values.push(toUnion)},_i=0,_d=transform.elements;_i<_d.length;_i++){_loop_3(_d[_i])}return{arrayValue:{values:values}}}var ArrayRemoveTransformOperation=function(_super){function ArrayRemoveTransformOperation(elements){var _this=_super.call(this)||this;return _this.elements=elements,_this}return tslib.__extends(ArrayRemoveTransformOperation,_super),ArrayRemoveTransformOperation}(TransformOperation);function applyArrayRemoveTransformOperation(transform,previousValue){for(var values=coercedFieldValuesArray(previousValue),_loop_4=function(toRemove){values=values.filter(function(element){return!valueEquals(element,toRemove)})},_i=0,_d=transform.elements;_i<_d.length;_i++){_loop_4(_d[_i])}return{arrayValue:{values:values}}}var NumericIncrementTransformOperation=function(_super){function NumericIncrementTransformOperation(serializer,operand){var _this=_super.call(this)||this;return _this.serializer=serializer,_this.operand=operand,_this}return tslib.__extends(NumericIncrementTransformOperation,_super),NumericIncrementTransformOperation}(TransformOperation);function asNumber(value){return normalizeNumber(value.integerValue||value.doubleValue)}function coercedFieldValuesArray(value){return isArray(value)&&value.arrayValue.values?value.arrayValue.values.slice():[]}var FieldTransform=function FieldTransform(field,transform){this.field=field,this.transform=transform};function fieldTransformEquals(left,right){return left.field.isEqual(right.field)&&function transformOperationEquals(left,right){return left instanceof ArrayUnionTransformOperation&&right instanceof ArrayUnionTransformOperation||left instanceof ArrayRemoveTransformOperation&&right instanceof ArrayRemoveTransformOperation?arrayEquals(left.elements,right.elements,valueEquals):left instanceof NumericIncrementTransformOperation&&right instanceof NumericIncrementTransformOperation?valueEquals(left.operand,right.operand):left instanceof ServerTimestampTransform&&right instanceof ServerTimestampTransform}(left.transform,right.transform)}var MutationResult=function MutationResult(version,transformResults){this.version=version,this.transformResults=transformResults},Precondition=function(){function Precondition(updateTime,exists){this.updateTime=updateTime,this.exists=exists}return Precondition.none=function(){return new Precondition},Precondition.exists=function(exists){return new Precondition(void 0,exists)},Precondition.updateTime=function(version){return new Precondition(version)},Object.defineProperty(Precondition.prototype,"isNone",{get:function(){return void 0===this.updateTime&&void 0===this.exists},enumerable:!1,configurable:!0}),Precondition.prototype.isEqual=function(other){return this.exists===other.exists&&(this.updateTime?!!other.updateTime&&this.updateTime.isEqual(other.updateTime):!other.updateTime)},Precondition}();function preconditionIsValidForDocument(precondition,document){return void 0!==precondition.updateTime?document.isFoundDocument()&&document.version.isEqual(precondition.updateTime):void 0===precondition.exists||precondition.exists===document.isFoundDocument()}var Mutation=function Mutation(){};function applyMutationToRemoteDocument(mutation,document,mutationResult){mutation instanceof SetMutation?function applySetMutationToRemoteDocument(mutation,document,mutationResult){var newData=mutation.value.clone(),transformResults=serverTransformResults(mutation.fieldTransforms,document,mutationResult.transformResults);newData.setAll(transformResults),document.convertToFoundDocument(mutationResult.version,newData).setHasCommittedMutations()}(mutation,document,mutationResult):mutation instanceof PatchMutation?function applyPatchMutationToRemoteDocument(mutation,document,mutationResult){if(!preconditionIsValidForDocument(mutation.precondition,document))return void document.convertToUnknownDocument(mutationResult.version);var transformResults=serverTransformResults(mutation.fieldTransforms,document,mutationResult.transformResults),newData=document.data;newData.setAll(getPatch(mutation)),newData.setAll(transformResults),document.convertToFoundDocument(mutationResult.version,newData).setHasCommittedMutations()}(mutation,document,mutationResult):function applyDeleteMutationToRemoteDocument(mutation,document,mutationResult){document.convertToNoDocument(mutationResult.version).setHasCommittedMutations()}(0,document,mutationResult)}function applyMutationToLocalView(mutation,document,localWriteTime){mutation instanceof SetMutation?function applySetMutationToLocalView(mutation,document,localWriteTime){if(!preconditionIsValidForDocument(mutation.precondition,document))return;var newData=mutation.value.clone(),transformResults=localTransformResults(mutation.fieldTransforms,localWriteTime,document);newData.setAll(transformResults),document.convertToFoundDocument(getPostMutationVersion(document),newData).setHasLocalMutations()}(mutation,document,localWriteTime):mutation instanceof PatchMutation?function applyPatchMutationToLocalView(mutation,document,localWriteTime){if(!preconditionIsValidForDocument(mutation.precondition,document))return;var transformResults=localTransformResults(mutation.fieldTransforms,localWriteTime,document),newData=document.data;newData.setAll(getPatch(mutation)),newData.setAll(transformResults),document.convertToFoundDocument(getPostMutationVersion(document),newData).setHasLocalMutations()}(mutation,document,localWriteTime):function applyDeleteMutationToLocalView(mutation,document){preconditionIsValidForDocument(mutation.precondition,document)&&document.convertToNoDocument(SnapshotVersion.min())}(mutation,document)}function extractMutationBaseValue(mutation,document){for(var baseObject=null,_i=0,_d=mutation.fieldTransforms;_i<_d.length;_i++){var fieldTransform=_d[_i],existingValue=document.data.field(fieldTransform.field),coercedValue=computeTransformOperationBaseValue(fieldTransform.transform,existingValue||null);null!=coercedValue&&(null==baseObject&&(baseObject=ObjectValue.empty()),baseObject.set(fieldTransform.field,coercedValue))}return baseObject||null}function mutationEquals(left,right){return left.type===right.type&&(!!left.key.isEqual(right.key)&&(!!left.precondition.isEqual(right.precondition)&&(!!function fieldTransformsAreEqual(left,right){return void 0===left&&void 0===right||!(!left||!right)&&arrayEquals(left,right,function(l,r){return fieldTransformEquals(l,r)})}(left.fieldTransforms,right.fieldTransforms)&&(0===left.type?left.value.isEqual(right.value):1!==left.type||left.data.isEqual(right.data)&&left.fieldMask.isEqual(right.fieldMask)))))}function getPostMutationVersion(document){return document.isFoundDocument()?document.version:SnapshotVersion.min()}var SetMutation=function(_super){function SetMutation(key,value,precondition,fieldTransforms){void 0===fieldTransforms&&(fieldTransforms=[]);var _this=_super.call(this)||this;return _this.key=key,_this.value=value,_this.precondition=precondition,_this.fieldTransforms=fieldTransforms,_this.type=0,_this}return tslib.__extends(SetMutation,_super),SetMutation}(Mutation);var PatchMutation=function(_super){function PatchMutation(key,data,fieldMask,precondition,fieldTransforms){void 0===fieldTransforms&&(fieldTransforms=[]);var _this=_super.call(this)||this;return _this.key=key,_this.data=data,_this.fieldMask=fieldMask,_this.precondition=precondition,_this.fieldTransforms=fieldTransforms,_this.type=1,_this}return tslib.__extends(PatchMutation,_super),PatchMutation}(Mutation);function getPatch(mutation){var result=new Map;return mutation.fieldMask.fields.forEach(function(fieldPath){if(!fieldPath.isEmpty()){var newValue=mutation.data.field(fieldPath);result.set(fieldPath,newValue)}}),result}function serverTransformResults(fieldTransforms,mutableDocument,serverTransformResults){var transformResults=new Map;hardAssert(fieldTransforms.length===serverTransformResults.length);for(var i=0;i<serverTransformResults.length;i++){var fieldTransform=fieldTransforms[i],transform=fieldTransform.transform,previousValue=mutableDocument.data.field(fieldTransform.field);transformResults.set(fieldTransform.field,applyTransformOperationToRemoteDocument(transform,previousValue,serverTransformResults[i]))}return transformResults}function localTransformResults(fieldTransforms,localWriteTime,mutableDocument){for(var transformResults=new Map,_i=0,fieldTransforms_1=fieldTransforms;_i<fieldTransforms_1.length;_i++){var fieldTransform=fieldTransforms_1[_i],transform=fieldTransform.transform,previousValue=mutableDocument.data.field(fieldTransform.field);transformResults.set(fieldTransform.field,applyTransformOperationToLocalView(transform,previousValue,localWriteTime))}return transformResults}var DeleteMutation=function(_super){function DeleteMutation(key,precondition){var _this=_super.call(this)||this;return _this.key=key,_this.precondition=precondition,_this.type=2,_this.fieldTransforms=[],_this}return tslib.__extends(DeleteMutation,_super),DeleteMutation}(Mutation);var RpcCode,VerifyMutation=function(_super){function VerifyMutation(key,precondition){var _this=_super.call(this)||this;return _this.key=key,_this.precondition=precondition,_this.type=3,_this.fieldTransforms=[],_this}return tslib.__extends(VerifyMutation,_super),VerifyMutation}(Mutation),MutationBatch=function(){function MutationBatch(batchId,localWriteTime,baseMutations,mutations){this.batchId=batchId,this.localWriteTime=localWriteTime,this.baseMutations=baseMutations,this.mutations=mutations}return MutationBatch.prototype.applyToRemoteDocument=function(document,batchResult){for(var mutationResults=batchResult.mutationResults,i=0;i<this.mutations.length;i++){var mutation=this.mutations[i];if(mutation.key.isEqual(document.key))applyMutationToRemoteDocument(mutation,document,mutationResults[i])}},MutationBatch.prototype.applyToLocalView=function(document){for(var _i=0,_d=this.baseMutations;_i<_d.length;_i++){(mutation=_d[_i]).key.isEqual(document.key)&&applyMutationToLocalView(mutation,document,this.localWriteTime)}for(var _e=0,_f=this.mutations;_e<_f.length;_e++){var mutation;(mutation=_f[_e]).key.isEqual(document.key)&&applyMutationToLocalView(mutation,document,this.localWriteTime)}},MutationBatch.prototype.applyToLocalDocumentSet=function(documentMap){var _this=this;this.mutations.forEach(function(m){var document=documentMap.get(m.key),mutableDocument=document;_this.applyToLocalView(mutableDocument),document.isValidDocument()||mutableDocument.convertToNoDocument(SnapshotVersion.min())})},MutationBatch.prototype.keys=function(){return this.mutations.reduce(function(keys,m){return keys.add(m.key)},documentKeySet())},MutationBatch.prototype.isEqual=function(other){return this.batchId===other.batchId&&arrayEquals(this.mutations,other.mutations,function(l,r){return mutationEquals(l,r)})&&arrayEquals(this.baseMutations,other.baseMutations,function(l,r){return mutationEquals(l,r)})},MutationBatch}(),MutationBatchResult=function(){function MutationBatchResult(batch,commitVersion,mutationResults,docVersions){this.batch=batch,this.commitVersion=commitVersion,this.mutationResults=mutationResults,this.docVersions=docVersions}return MutationBatchResult.from=function(batch,commitVersion,results){hardAssert(batch.mutations.length===results.length);for(var versionMap=documentVersionMap(),mutations=batch.mutations,i=0;i<mutations.length;i++)versionMap=versionMap.insert(mutations[i].key,results[i].version);return new MutationBatchResult(batch,commitVersion,results,versionMap)},MutationBatchResult}(),ExistenceFilter=function ExistenceFilter(count){this.count=count};function isPermanentError(code){switch(code){case Code_OK:return fail();case Code_CANCELLED:case Code_UNKNOWN:case Code_DEADLINE_EXCEEDED:case Code_RESOURCE_EXHAUSTED:case Code_INTERNAL:case Code_UNAVAILABLE:case Code_UNAUTHENTICATED:return!1;case Code_INVALID_ARGUMENT:case Code_NOT_FOUND:case Code_ALREADY_EXISTS:case Code_PERMISSION_DENIED:case Code_FAILED_PRECONDITION:case Code_ABORTED:case Code_OUT_OF_RANGE:case Code_UNIMPLEMENTED:case Code_DATA_LOSS:return!0;default:return fail()}}function mapCodeFromRpcCode(code){if(void 0===code)return logError("GRPC error has no .code"),Code_UNKNOWN;switch(code){case RpcCode.OK:return Code_OK;case RpcCode.CANCELLED:return Code_CANCELLED;case RpcCode.UNKNOWN:return Code_UNKNOWN;case RpcCode.DEADLINE_EXCEEDED:return Code_DEADLINE_EXCEEDED;case RpcCode.RESOURCE_EXHAUSTED:return Code_RESOURCE_EXHAUSTED;case RpcCode.INTERNAL:return Code_INTERNAL;case RpcCode.UNAVAILABLE:return Code_UNAVAILABLE;case RpcCode.UNAUTHENTICATED:return Code_UNAUTHENTICATED;case RpcCode.INVALID_ARGUMENT:return Code_INVALID_ARGUMENT;case RpcCode.NOT_FOUND:return Code_NOT_FOUND;case RpcCode.ALREADY_EXISTS:return Code_ALREADY_EXISTS;case RpcCode.PERMISSION_DENIED:return Code_PERMISSION_DENIED;case RpcCode.FAILED_PRECONDITION:return Code_FAILED_PRECONDITION;case RpcCode.ABORTED:return Code_ABORTED;case RpcCode.OUT_OF_RANGE:return Code_OUT_OF_RANGE;case RpcCode.UNIMPLEMENTED:return Code_UNIMPLEMENTED;case RpcCode.DATA_LOSS:return Code_DATA_LOSS;default:return fail()}}!function(RpcCode){RpcCode[RpcCode.OK=0]="OK",RpcCode[RpcCode.CANCELLED=1]="CANCELLED",RpcCode[RpcCode.UNKNOWN=2]="UNKNOWN",RpcCode[RpcCode.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",RpcCode[RpcCode.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",RpcCode[RpcCode.NOT_FOUND=5]="NOT_FOUND",RpcCode[RpcCode.ALREADY_EXISTS=6]="ALREADY_EXISTS",RpcCode[RpcCode.PERMISSION_DENIED=7]="PERMISSION_DENIED",RpcCode[RpcCode.UNAUTHENTICATED=16]="UNAUTHENTICATED",RpcCode[RpcCode.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",RpcCode[RpcCode.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",RpcCode[RpcCode.ABORTED=10]="ABORTED",RpcCode[RpcCode.OUT_OF_RANGE=11]="OUT_OF_RANGE",RpcCode[RpcCode.UNIMPLEMENTED=12]="UNIMPLEMENTED",RpcCode[RpcCode.INTERNAL=13]="INTERNAL",RpcCode[RpcCode.UNAVAILABLE=14]="UNAVAILABLE",RpcCode[RpcCode.DATA_LOSS=15]="DATA_LOSS"}(RpcCode||(RpcCode={}));var RemoteEvent=function(){function RemoteEvent(snapshotVersion,targetChanges,targetMismatches,documentUpdates,resolvedLimboDocuments){this.snapshotVersion=snapshotVersion,this.targetChanges=targetChanges,this.targetMismatches=targetMismatches,this.documentUpdates=documentUpdates,this.resolvedLimboDocuments=resolvedLimboDocuments}return RemoteEvent.createSynthesizedRemoteEventForCurrentChange=function(targetId,current){var targetChanges=new Map;return targetChanges.set(targetId,TargetChange.createSynthesizedTargetChangeForCurrentChange(targetId,current)),new RemoteEvent(SnapshotVersion.min(),targetChanges,targetIdSet(),mutableDocumentMap(),documentKeySet())},RemoteEvent}(),TargetChange=function(){function TargetChange(resumeToken,current,addedDocuments,modifiedDocuments,removedDocuments){this.resumeToken=resumeToken,this.current=current,this.addedDocuments=addedDocuments,this.modifiedDocuments=modifiedDocuments,this.removedDocuments=removedDocuments}return TargetChange.createSynthesizedTargetChangeForCurrentChange=function(targetId,current){return new TargetChange(ByteString.EMPTY_BYTE_STRING,current,documentKeySet(),documentKeySet(),documentKeySet())},TargetChange}(),DocumentWatchChange=function DocumentWatchChange(updatedTargetIds,removedTargetIds,key,newDoc){this.updatedTargetIds=updatedTargetIds,this.removedTargetIds=removedTargetIds,this.key=key,this.newDoc=newDoc},ExistenceFilterChange=function ExistenceFilterChange(targetId,existenceFilter){this.targetId=targetId,this.existenceFilter=existenceFilter},WatchTargetChange=function WatchTargetChange(state,targetIds,resumeToken,cause){void 0===resumeToken&&(resumeToken=ByteString.EMPTY_BYTE_STRING),void 0===cause&&(cause=null),this.state=state,this.targetIds=targetIds,this.resumeToken=resumeToken,this.cause=cause},TargetState=function(){function TargetState(){this.pendingResponses=0,this.documentChanges=snapshotChangesMap(),this._resumeToken=ByteString.EMPTY_BYTE_STRING,this._current=!1,this._hasPendingChanges=!0}return Object.defineProperty(TargetState.prototype,"current",{get:function(){return this._current},enumerable:!1,configurable:!0}),Object.defineProperty(TargetState.prototype,"resumeToken",{get:function(){return this._resumeToken},enumerable:!1,configurable:!0}),Object.defineProperty(TargetState.prototype,"isPending",{get:function(){return 0!==this.pendingResponses},enumerable:!1,configurable:!0}),Object.defineProperty(TargetState.prototype,"hasPendingChanges",{get:function(){return this._hasPendingChanges},enumerable:!1,configurable:!0}),TargetState.prototype.updateResumeToken=function(resumeToken){resumeToken.approximateByteSize()>0&&(this._hasPendingChanges=!0,this._resumeToken=resumeToken)},TargetState.prototype.toTargetChange=function(){var addedDocuments=documentKeySet(),modifiedDocuments=documentKeySet(),removedDocuments=documentKeySet();return this.documentChanges.forEach(function(key,changeType){switch(changeType){case 0:addedDocuments=addedDocuments.add(key);break;case 2:modifiedDocuments=modifiedDocuments.add(key);break;case 1:removedDocuments=removedDocuments.add(key);break;default:fail()}}),new TargetChange(this._resumeToken,this._current,addedDocuments,modifiedDocuments,removedDocuments)},TargetState.prototype.clearPendingChanges=function(){this._hasPendingChanges=!1,this.documentChanges=snapshotChangesMap()},TargetState.prototype.addDocumentChange=function(key,changeType){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.insert(key,changeType)},TargetState.prototype.removeDocumentChange=function(key){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.remove(key)},TargetState.prototype.recordPendingTargetRequest=function(){this.pendingResponses+=1},TargetState.prototype.recordTargetResponse=function(){this.pendingResponses-=1},TargetState.prototype.markCurrent=function(){this._hasPendingChanges=!0,this._current=!0},TargetState}(),WatchChangeAggregator=function(){function WatchChangeAggregator(metadataProvider){this.metadataProvider=metadataProvider,this.targetStates=new Map,this.pendingDocumentUpdates=mutableDocumentMap(),this.pendingDocumentTargetMapping=documentTargetMap(),this.pendingTargetResets=new SortedSet(primitiveComparator)}return WatchChangeAggregator.prototype.handleDocumentChange=function(docChange){for(var _i=0,_d=docChange.updatedTargetIds;_i<_d.length;_i++){var targetId=_d[_i];docChange.newDoc&&docChange.newDoc.isFoundDocument()?this.addDocumentToTarget(targetId,docChange.newDoc):this.removeDocumentFromTarget(targetId,docChange.key,docChange.newDoc)}for(var _e=0,_f=docChange.removedTargetIds;_e<_f.length;_e++){targetId=_f[_e];this.removeDocumentFromTarget(targetId,docChange.key,docChange.newDoc)}},WatchChangeAggregator.prototype.handleTargetChange=function(targetChange){var _this=this;this.forEachTarget(targetChange,function(targetId){var targetState=_this.ensureTargetState(targetId);switch(targetChange.state){case 0:_this.isActiveTarget(targetId)&&targetState.updateResumeToken(targetChange.resumeToken);break;case 1:targetState.recordTargetResponse(),targetState.isPending||targetState.clearPendingChanges(),targetState.updateResumeToken(targetChange.resumeToken);break;case 2:targetState.recordTargetResponse(),targetState.isPending||_this.removeTarget(targetId);break;case 3:_this.isActiveTarget(targetId)&&(targetState.markCurrent(),targetState.updateResumeToken(targetChange.resumeToken));break;case 4:_this.isActiveTarget(targetId)&&(_this.resetTarget(targetId),targetState.updateResumeToken(targetChange.resumeToken));break;default:fail()}})},WatchChangeAggregator.prototype.forEachTarget=function(targetChange,fn){var _this=this;targetChange.targetIds.length>0?targetChange.targetIds.forEach(fn):this.targetStates.forEach(function(_,targetId){_this.isActiveTarget(targetId)&&fn(targetId)})},WatchChangeAggregator.prototype.handleExistenceFilter=function(watchChange){var targetId=watchChange.targetId,expectedCount=watchChange.existenceFilter.count,targetData=this.targetDataForActiveTarget(targetId);if(targetData){var target=targetData.target;if(isDocumentTarget(target))if(0===expectedCount){var key=new DocumentKey(target.path);this.removeDocumentFromTarget(targetId,key,MutableDocument.newNoDocument(key,SnapshotVersion.min()))}else hardAssert(1===expectedCount);else this.getCurrentDocumentCountForTarget(targetId)!==expectedCount&&(this.resetTarget(targetId),this.pendingTargetResets=this.pendingTargetResets.add(targetId))}},WatchChangeAggregator.prototype.createRemoteEvent=function(snapshotVersion){var _this=this,targetChanges=new Map;this.targetStates.forEach(function(targetState,targetId){var targetData=_this.targetDataForActiveTarget(targetId);if(targetData){if(targetState.current&&isDocumentTarget(targetData.target)){var key=new DocumentKey(targetData.target.path);null!==_this.pendingDocumentUpdates.get(key)||_this.targetContainsDocument(targetId,key)||_this.removeDocumentFromTarget(targetId,key,MutableDocument.newNoDocument(key,snapshotVersion))}targetState.hasPendingChanges&&(targetChanges.set(targetId,targetState.toTargetChange()),targetState.clearPendingChanges())}});var resolvedLimboDocuments=documentKeySet();this.pendingDocumentTargetMapping.forEach(function(key,targets){var isOnlyLimboTarget=!0;targets.forEachWhile(function(targetId){var targetData=_this.targetDataForActiveTarget(targetId);return!targetData||2===targetData.purpose||(isOnlyLimboTarget=!1,!1)}),isOnlyLimboTarget&&(resolvedLimboDocuments=resolvedLimboDocuments.add(key))});var remoteEvent=new RemoteEvent(snapshotVersion,targetChanges,this.pendingTargetResets,this.pendingDocumentUpdates,resolvedLimboDocuments);return this.pendingDocumentUpdates=mutableDocumentMap(),this.pendingDocumentTargetMapping=documentTargetMap(),this.pendingTargetResets=new SortedSet(primitiveComparator),remoteEvent},WatchChangeAggregator.prototype.addDocumentToTarget=function(targetId,document){if(this.isActiveTarget(targetId)){var changeType=this.targetContainsDocument(targetId,document.key)?2:0;this.ensureTargetState(targetId).addDocumentChange(document.key,changeType),this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(document.key,document),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(document.key,this.ensureDocumentTargetMapping(document.key).add(targetId))}},WatchChangeAggregator.prototype.removeDocumentFromTarget=function(targetId,key,updatedDocument){if(this.isActiveTarget(targetId)){var targetState=this.ensureTargetState(targetId);this.targetContainsDocument(targetId,key)?targetState.addDocumentChange(key,1):targetState.removeDocumentChange(key),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(key,this.ensureDocumentTargetMapping(key).delete(targetId)),updatedDocument&&(this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(key,updatedDocument))}},WatchChangeAggregator.prototype.removeTarget=function(targetId){this.targetStates.delete(targetId)},WatchChangeAggregator.prototype.getCurrentDocumentCountForTarget=function(targetId){var targetChange=this.ensureTargetState(targetId).toTargetChange();return this.metadataProvider.getRemoteKeysForTarget(targetId).size+targetChange.addedDocuments.size-targetChange.removedDocuments.size},WatchChangeAggregator.prototype.recordPendingTargetRequest=function(targetId){this.ensureTargetState(targetId).recordPendingTargetRequest()},WatchChangeAggregator.prototype.ensureTargetState=function(targetId){var result=this.targetStates.get(targetId);return result||(result=new TargetState,this.targetStates.set(targetId,result)),result},WatchChangeAggregator.prototype.ensureDocumentTargetMapping=function(key){var targetMapping=this.pendingDocumentTargetMapping.get(key);return targetMapping||(targetMapping=new SortedSet(primitiveComparator),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(key,targetMapping)),targetMapping},WatchChangeAggregator.prototype.isActiveTarget=function(targetId){var targetActive=null!==this.targetDataForActiveTarget(targetId);return targetActive||logDebug("WatchChangeAggregator","Detected inactive target",targetId),targetActive},WatchChangeAggregator.prototype.targetDataForActiveTarget=function(targetId){var targetState=this.targetStates.get(targetId);return targetState&&targetState.isPending?null:this.metadataProvider.getTargetDataForTarget(targetId)},WatchChangeAggregator.prototype.resetTarget=function(targetId){var _this=this;this.targetStates.set(targetId,new TargetState),this.metadataProvider.getRemoteKeysForTarget(targetId).forEach(function(key){_this.removeDocumentFromTarget(targetId,key,null)})},WatchChangeAggregator.prototype.targetContainsDocument=function(targetId,key){return this.metadataProvider.getRemoteKeysForTarget(targetId).has(key)},WatchChangeAggregator}();function documentTargetMap(){return new SortedMap(DocumentKey.comparator)}function snapshotChangesMap(){return new SortedMap(DocumentKey.comparator)}var DIRECTIONS={asc:"ASCENDING",desc:"DESCENDING"},OPERATORS={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};var JsonProtoSerializer=function JsonProtoSerializer(databaseId,useProto3Json){this.databaseId=databaseId,this.useProto3Json=useProto3Json};function toTimestamp(serializer,timestamp){return serializer.useProto3Json?new Date(1e3*timestamp.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")+"."+("000000000"+timestamp.nanoseconds).slice(-9)+"Z":{seconds:""+timestamp.seconds,nanos:timestamp.nanoseconds}}function toBytes(serializer,bytes){return serializer.useProto3Json?bytes.toBase64():bytes.toUint8Array()}function toVersion(serializer,version){return toTimestamp(serializer,version.toTimestamp())}function fromVersion(version){return hardAssert(!!version),SnapshotVersion.fromTimestamp(function fromTimestamp(date){var timestamp=normalizeTimestamp(date);return new Timestamp(timestamp.seconds,timestamp.nanos)}(version))}function toResourceName(databaseId,path){return function fullyQualifiedPrefixPath(databaseId){return new ResourcePath(["projects",databaseId.projectId,"databases",databaseId.database])}(databaseId).child("documents").child(path).canonicalString()}function fromResourceName(name){var resource=ResourcePath.fromString(name);return hardAssert(isValidResourceName(resource)),resource}function toName(serializer,key){return toResourceName(serializer.databaseId,key.path)}function fromName(serializer,name){var resource=fromResourceName(name);if(resource.get(1)!==serializer.databaseId.projectId)throw new FirestoreError(Code_INVALID_ARGUMENT,"Tried to deserialize key from different project: "+resource.get(1)+" vs "+serializer.databaseId.projectId);if(resource.get(3)!==serializer.databaseId.database)throw new FirestoreError(Code_INVALID_ARGUMENT,"Tried to deserialize key from different database: "+resource.get(3)+" vs "+serializer.databaseId.database);return new DocumentKey(extractLocalPathFromResourceName(resource))}function toQueryPath(serializer,path){return toResourceName(serializer.databaseId,path)}function fromQueryPath(name){var resourceName=fromResourceName(name);return 4===resourceName.length?ResourcePath.emptyPath():extractLocalPathFromResourceName(resourceName)}function getEncodedDatabaseId(serializer){return new ResourcePath(["projects",serializer.databaseId.projectId,"databases",serializer.databaseId.database]).canonicalString()}function extractLocalPathFromResourceName(resourceName){return hardAssert(resourceName.length>4&&"documents"===resourceName.get(4)),resourceName.popFirst(5)}function toMutationDocument(serializer,key,fields){return{name:toName(serializer,key),fields:fields.value.mapValue.fields}}function fromDocument(serializer,document,hasCommittedMutations){var key=fromName(serializer,document.name),version=fromVersion(document.updateTime),data=new ObjectValue({mapValue:{fields:document.fields}}),result=MutableDocument.newFoundDocument(key,version,data);return hasCommittedMutations&&result.setHasCommittedMutations(),hasCommittedMutations?result.setHasCommittedMutations():result}function fromBatchGetDocumentsResponse(serializer,result){return"found"in result?function fromFound(serializer,doc){hardAssert(!!doc.found),doc.found.name,doc.found.updateTime;var key=fromName(serializer,doc.found.name),version=fromVersion(doc.found.updateTime),data=new ObjectValue({mapValue:{fields:doc.found.fields}});return MutableDocument.newFoundDocument(key,version,data)}(serializer,result):"missing"in result?function fromMissing(serializer,result){hardAssert(!!result.missing),hardAssert(!!result.readTime);var key=fromName(serializer,result.missing),version=fromVersion(result.readTime);return MutableDocument.newNoDocument(key,version)}(serializer,result):fail()}function fromWatchChange(serializer,change){var watchChange;if("targetChange"in change){change.targetChange;var state=function fromWatchTargetChangeState(state){return"NO_CHANGE"===state?0:"ADD"===state?1:"REMOVE"===state?2:"CURRENT"===state?3:"RESET"===state?4:fail()}(change.targetChange.targetChangeType||"NO_CHANGE"),targetIds=change.targetChange.targetIds||[],resumeToken=function fromBytes(serializer,value){return serializer.useProto3Json?(hardAssert(void 0===value||"string"==typeof value),ByteString.fromBase64String(value||"")):(hardAssert(void 0===value||value instanceof Uint8Array),ByteString.fromUint8Array(value||new Uint8Array))}(serializer,change.targetChange.resumeToken),causeProto=change.targetChange.cause,cause=causeProto&&function fromRpcStatus(status){var code=void 0===status.code?Code_UNKNOWN:mapCodeFromRpcCode(status.code);return new FirestoreError(code,status.message||"")}(causeProto);watchChange=new WatchTargetChange(state,targetIds,resumeToken,cause||null)}else if("documentChange"in change){change.documentChange;var entityChange=change.documentChange;entityChange.document,entityChange.document.name,entityChange.document.updateTime;var key=fromName(serializer,entityChange.document.name),version_1=fromVersion(entityChange.document.updateTime),data=new ObjectValue({mapValue:{fields:entityChange.document.fields}}),doc_1=MutableDocument.newFoundDocument(key,version_1,data),updatedTargetIds=entityChange.targetIds||[],removedTargetIds=entityChange.removedTargetIds||[];watchChange=new DocumentWatchChange(updatedTargetIds,removedTargetIds,doc_1.key,doc_1)}else if("documentDelete"in change){change.documentDelete;var docDelete=change.documentDelete;docDelete.document;key=fromName(serializer,docDelete.document);var version_2=docDelete.readTime?fromVersion(docDelete.readTime):SnapshotVersion.min(),doc_2=MutableDocument.newNoDocument(key,version_2);removedTargetIds=docDelete.removedTargetIds||[];watchChange=new DocumentWatchChange([],removedTargetIds,doc_2.key,doc_2)}else if("documentRemove"in change){change.documentRemove;var docRemove=change.documentRemove;docRemove.document;key=fromName(serializer,docRemove.document),removedTargetIds=docRemove.removedTargetIds||[];watchChange=new DocumentWatchChange([],removedTargetIds,key,null)}else{if(!("filter"in change))return fail();change.filter;var filter=change.filter;filter.targetId;var count=filter.count||0,existenceFilter=new ExistenceFilter(count),targetId=filter.targetId;watchChange=new ExistenceFilterChange(targetId,existenceFilter)}return watchChange}function toMutation(serializer,mutation){var result;if(mutation instanceof SetMutation)result={update:toMutationDocument(serializer,mutation.key,mutation.value)};else if(mutation instanceof DeleteMutation)result={delete:toName(serializer,mutation.key)};else if(mutation instanceof PatchMutation)result={update:toMutationDocument(serializer,mutation.key,mutation.data),updateMask:toDocumentMask(mutation.fieldMask)};else{if(!(mutation instanceof VerifyMutation))return fail();result={verify:toName(serializer,mutation.key)}}return mutation.fieldTransforms.length>0&&(result.updateTransforms=mutation.fieldTransforms.map(function(transform){return function toFieldTransform(serializer,fieldTransform){var transform=fieldTransform.transform;if(transform instanceof ServerTimestampTransform)return{fieldPath:fieldTransform.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(transform instanceof ArrayUnionTransformOperation)return{fieldPath:fieldTransform.field.canonicalString(),appendMissingElements:{values:transform.elements}};if(transform instanceof ArrayRemoveTransformOperation)return{fieldPath:fieldTransform.field.canonicalString(),removeAllFromArray:{values:transform.elements}};if(transform instanceof NumericIncrementTransformOperation)return{fieldPath:fieldTransform.field.canonicalString(),increment:transform.operand};throw fail()}(0,transform)})),mutation.precondition.isNone||(result.currentDocument=function toPrecondition(serializer,precondition){return void 0!==precondition.updateTime?{updateTime:toVersion(serializer,precondition.updateTime)}:void 0!==precondition.exists?{exists:precondition.exists}:fail()}(serializer,mutation.precondition)),result}function fromMutation(serializer,proto){var precondition=proto.currentDocument?function fromPrecondition(precondition){return void 0!==precondition.updateTime?Precondition.updateTime(fromVersion(precondition.updateTime)):void 0!==precondition.exists?Precondition.exists(precondition.exists):Precondition.none()}(proto.currentDocument):Precondition.none(),fieldTransforms=proto.updateTransforms?proto.updateTransforms.map(function(transform){return function fromFieldTransform(serializer,proto){var transform=null;if("setToServerValue"in proto)hardAssert("REQUEST_TIME"===proto.setToServerValue),transform=new ServerTimestampTransform;else if("appendMissingElements"in proto){var values=proto.appendMissingElements.values||[];transform=new ArrayUnionTransformOperation(values)}else if("removeAllFromArray"in proto){values=proto.removeAllFromArray.values||[];transform=new ArrayRemoveTransformOperation(values)}else"increment"in proto?transform=new NumericIncrementTransformOperation(serializer,proto.increment):fail();var fieldPath=FieldPath$1.fromServerFormat(proto.fieldPath);return new FieldTransform(fieldPath,transform)}(serializer,transform)}):[];if(proto.update){proto.update.name;var key=fromName(serializer,proto.update.name),value=new ObjectValue({mapValue:{fields:proto.update.fields}});if(proto.updateMask){var fieldMask=function fromDocumentMask(proto){var paths=proto.fieldPaths||[];return new FieldMask(paths.map(function(path){return FieldPath$1.fromServerFormat(path)}))}(proto.updateMask);return new PatchMutation(key,value,fieldMask,precondition,fieldTransforms)}return new SetMutation(key,value,precondition,fieldTransforms)}if(proto.delete){key=fromName(serializer,proto.delete);return new DeleteMutation(key,precondition)}if(proto.verify){key=fromName(serializer,proto.verify);return new VerifyMutation(key,precondition)}return fail()}function fromWriteResults(protos,commitTime){return protos&&protos.length>0?(hardAssert(void 0!==commitTime),protos.map(function(proto){return function fromWriteResult(proto,commitTime){var version=proto.updateTime?fromVersion(proto.updateTime):fromVersion(commitTime);return version.isEqual(SnapshotVersion.min())&&(version=fromVersion(commitTime)),new MutationResult(version,proto.transformResults||[])}(proto,commitTime)})):[]}function toDocumentsTarget(serializer,target){return{documents:[toQueryPath(serializer,target.path)]}}function toQueryTarget(serializer,target){var result={structuredQuery:{}},path=target.path;null!==target.collectionGroup?(result.parent=toQueryPath(serializer,path),result.structuredQuery.from=[{collectionId:target.collectionGroup,allDescendants:!0}]):(result.parent=toQueryPath(serializer,path.popLast()),result.structuredQuery.from=[{collectionId:path.lastSegment()}]);var where=function toFilter(filters){if(0===filters.length)return;var protos=filters.map(function(filter){return function toUnaryOrFieldFilter(filter){if("=="===filter.op){if(isNanValue(filter.value))return{unaryFilter:{field:toFieldPathReference(filter.field),op:"IS_NAN"}};if(isNullValue(filter.value))return{unaryFilter:{field:toFieldPathReference(filter.field),op:"IS_NULL"}}}else if("!="===filter.op){if(isNanValue(filter.value))return{unaryFilter:{field:toFieldPathReference(filter.field),op:"IS_NOT_NAN"}};if(isNullValue(filter.value))return{unaryFilter:{field:toFieldPathReference(filter.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:toFieldPathReference(filter.field),op:toOperatorName(filter.op),value:filter.value}}}(filter)});if(1===protos.length)return protos[0];return{compositeFilter:{op:"AND",filters:protos}}}(target.filters);where&&(result.structuredQuery.where=where);var orderBy=function toOrder(orderBys){if(0===orderBys.length)return;return orderBys.map(function(order){return function toPropertyOrder(orderBy){return{field:toFieldPathReference(orderBy.field),direction:toDirection(orderBy.dir)}}(order)})}(target.orderBy);orderBy&&(result.structuredQuery.orderBy=orderBy);var limit=function toInt32Proto(serializer,val){return serializer.useProto3Json||isNullOrUndefined(val)?val:{value:val}}(serializer,target.limit);return null!==limit&&(result.structuredQuery.limit=limit),target.startAt&&(result.structuredQuery.startAt=toCursor(target.startAt)),target.endAt&&(result.structuredQuery.endAt=toCursor(target.endAt)),result}function convertQueryTargetToQuery(target){var path=fromQueryPath(target.parent),query=target.structuredQuery,fromCount=query.from?query.from.length:0,collectionGroup=null;if(fromCount>0){hardAssert(1===fromCount);var from=query.from[0];from.allDescendants?collectionGroup=from.collectionId:path=path.child(from.collectionId)}var filterBy=[];query.where&&(filterBy=fromFilter(query.where));var orderBy=[];query.orderBy&&(orderBy=function fromOrder(orderBys){return orderBys.map(function(order){return function fromPropertyOrder(orderBy){return new OrderBy(fromFieldPathReference(orderBy.field),function fromDirection(dir){switch(dir){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(orderBy.direction))}(order)})}(query.orderBy));var limit=null;query.limit&&(limit=function fromInt32Proto(val){var result;return isNullOrUndefined(result="object"==typeof val?val.value:val)?null:result}(query.limit));var startAt=null;query.startAt&&(startAt=fromCursor(query.startAt));var endAt=null;return query.endAt&&(endAt=fromCursor(query.endAt)),newQuery(path,collectionGroup,orderBy,filterBy,limit,"F",startAt,endAt)}function toListenRequestLabels(serializer,targetData){var value=function toLabel(serializer,purpose){switch(purpose){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return fail()}}(0,targetData.purpose);return null==value?null:{"goog-listen-tags":value}}function fromFilter(filter){return filter?void 0!==filter.unaryFilter?[fromUnaryFilter(filter)]:void 0!==filter.fieldFilter?[fromFieldFilter(filter)]:void 0!==filter.compositeFilter?filter.compositeFilter.filters.map(function(f){return fromFilter(f)}).reduce(function(accum,current){return accum.concat(current)}):fail():[]}function toCursor(cursor){return{before:cursor.before,values:cursor.position}}function fromCursor(cursor){var before=!!cursor.before,position=cursor.values||[];return new Bound(position,before)}function toDirection(dir){return DIRECTIONS[dir]}function toOperatorName(op){return OPERATORS[op]}function toFieldPathReference(path){return{fieldPath:path.canonicalString()}}function fromFieldPathReference(fieldReference){return FieldPath$1.fromServerFormat(fieldReference.fieldPath)}function fromFieldFilter(filter){return FieldFilter.create(fromFieldPathReference(filter.fieldFilter.field),function fromOperatorName(op){switch(op){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";case"OPERATOR_UNSPECIFIED":default:return fail()}}(filter.fieldFilter.op),filter.fieldFilter.value)}function fromUnaryFilter(filter){switch(filter.unaryFilter.op){case"IS_NAN":var nanField=fromFieldPathReference(filter.unaryFilter.field);return FieldFilter.create(nanField,"==",{doubleValue:NaN});case"IS_NULL":var nullField=fromFieldPathReference(filter.unaryFilter.field);return FieldFilter.create(nullField,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":var notNanField=fromFieldPathReference(filter.unaryFilter.field);return FieldFilter.create(notNanField,"!=",{doubleValue:NaN});case"IS_NOT_NULL":var notNullField=fromFieldPathReference(filter.unaryFilter.field);return FieldFilter.create(notNullField,"!=",{nullValue:"NULL_VALUE"});case"OPERATOR_UNSPECIFIED":default:return fail()}}function toDocumentMask(fieldMask){var canonicalFields=[];return fieldMask.fields.forEach(function(field){return canonicalFields.push(field.canonicalString())}),{fieldPaths:canonicalFields}}function isValidResourceName(path){return path.length>=4&&"projects"===path.get(0)&&"databases"===path.get(2)}var TargetData=function(){function TargetData(target,targetId,purpose,sequenceNumber,snapshotVersion,lastLimboFreeSnapshotVersion,resumeToken){void 0===snapshotVersion&&(snapshotVersion=SnapshotVersion.min()),void 0===lastLimboFreeSnapshotVersion&&(lastLimboFreeSnapshotVersion=SnapshotVersion.min()),void 0===resumeToken&&(resumeToken=ByteString.EMPTY_BYTE_STRING),this.target=target,this.targetId=targetId,this.purpose=purpose,this.sequenceNumber=sequenceNumber,this.snapshotVersion=snapshotVersion,this.lastLimboFreeSnapshotVersion=lastLimboFreeSnapshotVersion,this.resumeToken=resumeToken}return TargetData.prototype.withSequenceNumber=function(sequenceNumber){return new TargetData(this.target,this.targetId,this.purpose,sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)},TargetData.prototype.withResumeToken=function(resumeToken,snapshotVersion){return new TargetData(this.target,this.targetId,this.purpose,this.sequenceNumber,snapshotVersion,this.lastLimboFreeSnapshotVersion,resumeToken)},TargetData.prototype.withLastLimboFreeSnapshotVersion=function(lastLimboFreeSnapshotVersion){return new TargetData(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,lastLimboFreeSnapshotVersion,this.resumeToken)},TargetData}(),LocalSerializer=function LocalSerializer(remoteSerializer){this.remoteSerializer=remoteSerializer};function fromDbRemoteDocument(localSerializer,remoteDoc){if(remoteDoc.document)return fromDocument(localSerializer.remoteSerializer,remoteDoc.document,!!remoteDoc.hasCommittedMutations);if(remoteDoc.noDocument){var key=DocumentKey.fromSegments(remoteDoc.noDocument.path),version_3=fromDbTimestamp(remoteDoc.noDocument.readTime),document_1=MutableDocument.newNoDocument(key,version_3);return remoteDoc.hasCommittedMutations?document_1.setHasCommittedMutations():document_1}if(remoteDoc.unknownDocument){key=DocumentKey.fromSegments(remoteDoc.unknownDocument.path);var version_4=fromDbTimestamp(remoteDoc.unknownDocument.version);return MutableDocument.newUnknownDocument(key,version_4)}return fail()}function toDbRemoteDocument(localSerializer,document,readTime){var dbReadTime=toDbTimestampKey(readTime),parentPath=document.key.path.popLast().toArray();if(document.isFoundDocument()){var doc_3=function toDocument(serializer,document){return{name:toName(serializer,document.key),fields:document.data.value.mapValue.fields,updateTime:toTimestamp(serializer,document.version.toTimestamp())}}(localSerializer.remoteSerializer,document),hasCommittedMutations=document.hasCommittedMutations;return new DbRemoteDocument(null,null,doc_3,hasCommittedMutations,dbReadTime,parentPath)}if(document.isNoDocument()){var path=document.key.path.toArray(),readTime_1=toDbTimestamp(document.version);hasCommittedMutations=document.hasCommittedMutations;return new DbRemoteDocument(null,new DbNoDocument(path,readTime_1),null,hasCommittedMutations,dbReadTime,parentPath)}if(document.isUnknownDocument()){path=document.key.path.toArray();var readTime_2=toDbTimestamp(document.version);return new DbRemoteDocument(new DbUnknownDocument(path,readTime_2),null,null,!0,dbReadTime,parentPath)}return fail()}function toDbTimestampKey(snapshotVersion){var timestamp=snapshotVersion.toTimestamp();return[timestamp.seconds,timestamp.nanoseconds]}function fromDbTimestampKey(dbTimestampKey){var timestamp=new Timestamp(dbTimestampKey[0],dbTimestampKey[1]);return SnapshotVersion.fromTimestamp(timestamp)}function toDbTimestamp(snapshotVersion){var timestamp=snapshotVersion.toTimestamp();return new DbTimestamp(timestamp.seconds,timestamp.nanoseconds)}function fromDbTimestamp(dbTimestamp){var timestamp=new Timestamp(dbTimestamp.seconds,dbTimestamp.nanoseconds);return SnapshotVersion.fromTimestamp(timestamp)}function fromDbMutationBatch(localSerializer,dbBatch){for(var baseMutations=(dbBatch.baseMutations||[]).map(function(m){return fromMutation(localSerializer.remoteSerializer,m)}),i=0;i<dbBatch.mutations.length-1;++i){var currentMutation=dbBatch.mutations[i];if(i+1<dbBatch.mutations.length&&void 0!==dbBatch.mutations[i+1].transform){var transformMutation=dbBatch.mutations[i+1];currentMutation.updateTransforms=transformMutation.transform.fieldTransforms,dbBatch.mutations.splice(i+1,1),++i}}var mutations=dbBatch.mutations.map(function(m){return fromMutation(localSerializer.remoteSerializer,m)}),timestamp=Timestamp.fromMillis(dbBatch.localWriteTimeMs);return new MutationBatch(dbBatch.batchId,timestamp,baseMutations,mutations)}function fromDbTarget(dbTarget){var target,version=fromDbTimestamp(dbTarget.readTime),lastLimboFreeSnapshotVersion=void 0!==dbTarget.lastLimboFreeSnapshotVersion?fromDbTimestamp(dbTarget.lastLimboFreeSnapshotVersion):SnapshotVersion.min();return target=function isDocumentQuery(dbQuery){return void 0!==dbQuery.documents}(dbTarget.query)?function fromDocumentsTarget(documentsTarget){return hardAssert(1===documentsTarget.documents.length),queryToTarget(newQueryForPath(fromQueryPath(documentsTarget.documents[0])))}(dbTarget.query):function fromQueryTarget(target){return queryToTarget(convertQueryTargetToQuery(target))}(dbTarget.query),new TargetData(target,dbTarget.targetId,0,dbTarget.lastListenSequenceNumber,version,lastLimboFreeSnapshotVersion,ByteString.fromBase64String(dbTarget.resumeToken))}function toDbTarget(localSerializer,targetData){var queryProto,dbTimestamp=toDbTimestamp(targetData.snapshotVersion),dbLastLimboFreeTimestamp=toDbTimestamp(targetData.lastLimboFreeSnapshotVersion);queryProto=isDocumentTarget(targetData.target)?toDocumentsTarget(localSerializer.remoteSerializer,targetData.target):toQueryTarget(localSerializer.remoteSerializer,targetData.target);var resumeToken=targetData.resumeToken.toBase64();return new DbTarget(targetData.targetId,canonifyTarget(targetData.target),dbTimestamp,resumeToken,targetData.sequenceNumber,dbLastLimboFreeTimestamp,queryProto)}function fromBundledQuery(bundledQuery){var query=convertQueryTargetToQuery({parent:bundledQuery.parent,structuredQuery:bundledQuery.structuredQuery});return"LAST"===bundledQuery.limitType?queryWithLimit(query,query.limit,"L"):query}var IndexedDbBundleCache=function(){function IndexedDbBundleCache(){}return IndexedDbBundleCache.prototype.getBundleMetadata=function(transaction,bundleId){return bundlesStore(transaction).get(bundleId).next(function(bundle){if(bundle)return function fromDbBundle(dbBundle){return{id:dbBundle.bundleId,createTime:fromDbTimestamp(dbBundle.createTime),version:dbBundle.version}}(bundle)})},IndexedDbBundleCache.prototype.saveBundleMetadata=function(transaction,bundleMetadata){return bundlesStore(transaction).put(function toDbBundle(metadata){return{bundleId:metadata.id,createTime:toDbTimestamp(fromVersion(metadata.createTime)),version:metadata.version}}(bundleMetadata))},IndexedDbBundleCache.prototype.getNamedQuery=function(transaction,queryName){return namedQueriesStore(transaction).get(queryName).next(function(query){if(query)return function fromDbNamedQuery(dbNamedQuery){return{name:dbNamedQuery.name,query:fromBundledQuery(dbNamedQuery.bundledQuery),readTime:fromDbTimestamp(dbNamedQuery.readTime)}}(query)})},IndexedDbBundleCache.prototype.saveNamedQuery=function(transaction,query){return namedQueriesStore(transaction).put(function toDbNamedQuery(query){return{name:query.name,readTime:toDbTimestamp(fromVersion(query.readTime)),bundledQuery:query.bundledQuery}}(query))},IndexedDbBundleCache}();function bundlesStore(txn){return getStore(txn,DbBundle.store)}function namedQueriesStore(txn){return getStore(txn,DbNamedQuery.store)}var MemoryIndexManager=function(){function MemoryIndexManager(){this.collectionParentIndex=new MemoryCollectionParentIndex}return MemoryIndexManager.prototype.addToCollectionParentIndex=function(transaction,collectionPath){return this.collectionParentIndex.add(collectionPath),PersistencePromise.resolve()},MemoryIndexManager.prototype.getCollectionParents=function(transaction,collectionId){return PersistencePromise.resolve(this.collectionParentIndex.getEntries(collectionId))},MemoryIndexManager}(),MemoryCollectionParentIndex=function(){function MemoryCollectionParentIndex(){this.index={}}return MemoryCollectionParentIndex.prototype.add=function(collectionPath){var collectionId=collectionPath.lastSegment(),parentPath=collectionPath.popLast(),existingParents=this.index[collectionId]||new SortedSet(ResourcePath.comparator),added=!existingParents.has(parentPath);return this.index[collectionId]=existingParents.add(parentPath),added},MemoryCollectionParentIndex.prototype.has=function(collectionPath){var collectionId=collectionPath.lastSegment(),parentPath=collectionPath.popLast(),existingParents=this.index[collectionId];return existingParents&&existingParents.has(parentPath)},MemoryCollectionParentIndex.prototype.getEntries=function(collectionId){return(this.index[collectionId]||new SortedSet(ResourcePath.comparator)).toArray()},MemoryCollectionParentIndex}(),IndexedDbIndexManager=function(){function IndexedDbIndexManager(){this.collectionParentsCache=new MemoryCollectionParentIndex}return IndexedDbIndexManager.prototype.addToCollectionParentIndex=function(transaction,collectionPath){var _this=this;if(!this.collectionParentsCache.has(collectionPath)){var collectionId=collectionPath.lastSegment(),parentPath=collectionPath.popLast();transaction.addOnCommittedListener(function(){_this.collectionParentsCache.add(collectionPath)});var collectionParent={collectionId:collectionId,parent:encodeResourcePath(parentPath)};return collectionParentsStore(transaction).put(collectionParent)}return PersistencePromise.resolve()},IndexedDbIndexManager.prototype.getCollectionParents=function(transaction,collectionId){var parentPaths=[],range=IDBKeyRange.bound([collectionId,""],[immediateSuccessor(collectionId),""],!1,!0);return collectionParentsStore(transaction).loadAll(range).next(function(entries){for(var _i=0,entries_1=entries;_i<entries_1.length;_i++){var entry=entries_1[_i];if(entry.collectionId!==collectionId)break;parentPaths.push(decodeResourcePath(entry.parent))}return parentPaths})},IndexedDbIndexManager}();function collectionParentsStore(txn){return getStore(txn,DbCollectionParent.store)}function removeMutationBatch(txn,userId,batch){var mutationStore=txn.store(DbMutationBatch.store),indexTxn=txn.store(DbDocumentMutation.store),promises=[],range=IDBKeyRange.only(batch.batchId),numDeleted=0,removePromise=mutationStore.iterate({range:range},function(key,value,control){return numDeleted++,control.delete()});promises.push(removePromise.next(function(){hardAssert(1===numDeleted)}));for(var removedDocuments=[],_i=0,_d=batch.mutations;_i<_d.length;_i++){var mutation=_d[_i],indexKey=DbDocumentMutation.key(userId,mutation.key.path,batch.batchId);promises.push(indexTxn.delete(indexKey)),removedDocuments.push(mutation.key)}return PersistencePromise.waitFor(promises).next(function(){return removedDocuments})}function dbDocumentSize(doc){if(!doc)return 0;var value;if(doc.document)value=doc.document;else if(doc.unknownDocument)value=doc.unknownDocument;else{if(!doc.noDocument)throw fail();value=doc.noDocument}return JSON.stringify(value).length}var IndexedDbMutationQueue=function(){function IndexedDbMutationQueue(userId,serializer,indexManager,referenceDelegate){this.userId=userId,this.serializer=serializer,this.indexManager=indexManager,this.referenceDelegate=referenceDelegate,this.documentKeysByBatchId={}}return IndexedDbMutationQueue.forUser=function(user,serializer,indexManager,referenceDelegate){return hardAssert(""!==user.uid),new IndexedDbMutationQueue(user.isAuthenticated()?user.uid:"",serializer,indexManager,referenceDelegate)},IndexedDbMutationQueue.prototype.checkEmpty=function(transaction){var empty=!0,range=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return mutationsStore(transaction).iterate({index:DbMutationBatch.userMutationsIndex,range:range},function(key,value,control){empty=!1,control.done()}).next(function(){return empty})},IndexedDbMutationQueue.prototype.addMutationBatch=function(transaction,localWriteTime,baseMutations,mutations){var _this=this,documentStore=documentMutationsStore(transaction),mutationStore=mutationsStore(transaction);return mutationStore.add({}).next(function(batchId){hardAssert("number"==typeof batchId);for(var batch=new MutationBatch(batchId,localWriteTime,baseMutations,mutations),dbBatch=function toDbMutationBatch(localSerializer,userId,batch){var serializedBaseMutations=batch.baseMutations.map(function(m){return toMutation(localSerializer.remoteSerializer,m)}),serializedMutations=batch.mutations.map(function(m){return toMutation(localSerializer.remoteSerializer,m)});return new DbMutationBatch(userId,batch.batchId,batch.localWriteTime.toMillis(),serializedBaseMutations,serializedMutations)}(_this.serializer,_this.userId,batch),promises=[],collectionParents=new SortedSet(function(l,r){return primitiveComparator(l.canonicalString(),r.canonicalString())}),_i=0,mutations_1=mutations;_i<mutations_1.length;_i++){var mutation=mutations_1[_i],indexKey=DbDocumentMutation.key(_this.userId,mutation.key.path,batchId);collectionParents=collectionParents.add(mutation.key.path.popLast()),promises.push(mutationStore.put(dbBatch)),promises.push(documentStore.put(indexKey,DbDocumentMutation.PLACEHOLDER))}return collectionParents.forEach(function(parent){promises.push(_this.indexManager.addToCollectionParentIndex(transaction,parent))}),transaction.addOnCommittedListener(function(){_this.documentKeysByBatchId[batchId]=batch.keys()}),PersistencePromise.waitFor(promises).next(function(){return batch})})},IndexedDbMutationQueue.prototype.lookupMutationBatch=function(transaction,batchId){var _this=this;return mutationsStore(transaction).get(batchId).next(function(dbBatch){return dbBatch?(hardAssert(dbBatch.userId===_this.userId),fromDbMutationBatch(_this.serializer,dbBatch)):null})},IndexedDbMutationQueue.prototype.lookupMutationKeys=function(transaction,batchId){var _this=this;return this.documentKeysByBatchId[batchId]?PersistencePromise.resolve(this.documentKeysByBatchId[batchId]):this.lookupMutationBatch(transaction,batchId).next(function(batch){if(batch){var keys=batch.keys();return _this.documentKeysByBatchId[batchId]=keys,keys}return null})},IndexedDbMutationQueue.prototype.getNextMutationBatchAfterBatchId=function(transaction,batchId){var _this=this,nextBatchId=batchId+1,range=IDBKeyRange.lowerBound([this.userId,nextBatchId]),foundBatch=null;return mutationsStore(transaction).iterate({index:DbMutationBatch.userMutationsIndex,range:range},function(key,dbBatch,control){dbBatch.userId===_this.userId&&(hardAssert(dbBatch.batchId>=nextBatchId),foundBatch=fromDbMutationBatch(_this.serializer,dbBatch)),control.done()}).next(function(){return foundBatch})},IndexedDbMutationQueue.prototype.getHighestUnacknowledgedBatchId=function(transaction){var range=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),batchId=-1;return mutationsStore(transaction).iterate({index:DbMutationBatch.userMutationsIndex,range:range,reverse:!0},function(key,dbBatch,control){batchId=dbBatch.batchId,control.done()}).next(function(){return batchId})},IndexedDbMutationQueue.prototype.getAllMutationBatches=function(transaction){var _this=this,range=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return mutationsStore(transaction).loadAll(DbMutationBatch.userMutationsIndex,range).next(function(dbBatches){return dbBatches.map(function(dbBatch){return fromDbMutationBatch(_this.serializer,dbBatch)})})},IndexedDbMutationQueue.prototype.getAllMutationBatchesAffectingDocumentKey=function(transaction,documentKey){var _this=this,indexPrefix=DbDocumentMutation.prefixForPath(this.userId,documentKey.path),indexStart=IDBKeyRange.lowerBound(indexPrefix),results=[];return documentMutationsStore(transaction).iterate({range:indexStart},function(indexKey,_,control){var userID=indexKey[0],encodedPath=indexKey[1],batchId=indexKey[2],path=decodeResourcePath(encodedPath);if(userID===_this.userId&&documentKey.path.isEqual(path))return mutationsStore(transaction).get(batchId).next(function(mutation){if(!mutation)throw fail();hardAssert(mutation.userId===_this.userId),results.push(fromDbMutationBatch(_this.serializer,mutation))});control.done()}).next(function(){return results})},IndexedDbMutationQueue.prototype.getAllMutationBatchesAffectingDocumentKeys=function(transaction,documentKeys){var _this=this,uniqueBatchIDs=new SortedSet(primitiveComparator),promises=[];return documentKeys.forEach(function(documentKey){var indexStart=DbDocumentMutation.prefixForPath(_this.userId,documentKey.path),range=IDBKeyRange.lowerBound(indexStart),promise=documentMutationsStore(transaction).iterate({range:range},function(indexKey,_,control){var userID=indexKey[0],encodedPath=indexKey[1],batchID=indexKey[2],path=decodeResourcePath(encodedPath);userID===_this.userId&&documentKey.path.isEqual(path)?uniqueBatchIDs=uniqueBatchIDs.add(batchID):control.done()});promises.push(promise)}),PersistencePromise.waitFor(promises).next(function(){return _this.lookupMutationBatches(transaction,uniqueBatchIDs)})},IndexedDbMutationQueue.prototype.getAllMutationBatchesAffectingQuery=function(transaction,query){var _this=this,queryPath=query.path,immediateChildrenLength=queryPath.length+1,indexPrefix=DbDocumentMutation.prefixForPath(this.userId,queryPath),indexStart=IDBKeyRange.lowerBound(indexPrefix),uniqueBatchIDs=new SortedSet(primitiveComparator);return documentMutationsStore(transaction).iterate({range:indexStart},function(indexKey,_,control){var userID=indexKey[0],encodedPath=indexKey[1],batchID=indexKey[2],path=decodeResourcePath(encodedPath);userID===_this.userId&&queryPath.isPrefixOf(path)?path.length===immediateChildrenLength&&(uniqueBatchIDs=uniqueBatchIDs.add(batchID)):control.done()}).next(function(){return _this.lookupMutationBatches(transaction,uniqueBatchIDs)})},IndexedDbMutationQueue.prototype.lookupMutationBatches=function(transaction,batchIDs){var _this=this,results=[],promises=[];return batchIDs.forEach(function(batchId){promises.push(mutationsStore(transaction).get(batchId).next(function(mutation){if(null===mutation)throw fail();hardAssert(mutation.userId===_this.userId),results.push(fromDbMutationBatch(_this.serializer,mutation))}))}),PersistencePromise.waitFor(promises).next(function(){return results})},IndexedDbMutationQueue.prototype.removeMutationBatch=function(transaction,batch){var _this=this;return removeMutationBatch(transaction.simpleDbTransaction,this.userId,batch).next(function(removedDocuments){return transaction.addOnCommittedListener(function(){_this.removeCachedMutationKeys(batch.batchId)}),PersistencePromise.forEach(removedDocuments,function(key){return _this.referenceDelegate.markPotentiallyOrphaned(transaction,key)})})},IndexedDbMutationQueue.prototype.removeCachedMutationKeys=function(batchId){delete this.documentKeysByBatchId[batchId]},IndexedDbMutationQueue.prototype.performConsistencyCheck=function(txn){var _this=this;return this.checkEmpty(txn).next(function(empty){if(!empty)return PersistencePromise.resolve();var startRange=IDBKeyRange.lowerBound(DbDocumentMutation.prefixForUser(_this.userId)),danglingMutationReferences=[];return documentMutationsStore(txn).iterate({range:startRange},function(key,_,control){if(key[0]===_this.userId){var path=decodeResourcePath(key[1]);danglingMutationReferences.push(path)}else control.done()}).next(function(){hardAssert(0===danglingMutationReferences.length)})})},IndexedDbMutationQueue.prototype.containsKey=function(txn,key){return mutationQueueContainsKey(txn,this.userId,key)},IndexedDbMutationQueue.prototype.getMutationQueueMetadata=function(transaction){var _this=this;return mutationQueuesStore(transaction).get(this.userId).next(function(metadata){return metadata||new DbMutationQueue(_this.userId,-1,"")})},IndexedDbMutationQueue}();function mutationQueueContainsKey(txn,userId,key){var indexKey=DbDocumentMutation.prefixForPath(userId,key.path),encodedPath=indexKey[1],startRange=IDBKeyRange.lowerBound(indexKey),containsKey=!1;return documentMutationsStore(txn).iterate({range:startRange,keysOnly:!0},function(key,value,control){var userID=key[0],keyPath=key[1];key[2],userID===userId&&keyPath===encodedPath&&(containsKey=!0),control.done()}).next(function(){return containsKey})}function mutationsStore(txn){return getStore(txn,DbMutationBatch.store)}function documentMutationsStore(txn){return getStore(txn,DbDocumentMutation.store)}function mutationQueuesStore(txn){return getStore(txn,DbMutationQueue.store)}var TargetIdGenerator=function(){function TargetIdGenerator(lastId){this.lastId=lastId}return TargetIdGenerator.prototype.next=function(){return this.lastId+=2,this.lastId},TargetIdGenerator.forTargetCache=function(){return new TargetIdGenerator(0)},TargetIdGenerator.forSyncEngine=function(){return new TargetIdGenerator(-1)},TargetIdGenerator}(),IndexedDbTargetCache=function(){function IndexedDbTargetCache(referenceDelegate,serializer){this.referenceDelegate=referenceDelegate,this.serializer=serializer}return IndexedDbTargetCache.prototype.allocateTargetId=function(transaction){var _this=this;return this.retrieveMetadata(transaction).next(function(metadata){var targetIdGenerator=new TargetIdGenerator(metadata.highestTargetId);return metadata.highestTargetId=targetIdGenerator.next(),_this.saveMetadata(transaction,metadata).next(function(){return metadata.highestTargetId})})},IndexedDbTargetCache.prototype.getLastRemoteSnapshotVersion=function(transaction){return this.retrieveMetadata(transaction).next(function(metadata){return SnapshotVersion.fromTimestamp(new Timestamp(metadata.lastRemoteSnapshotVersion.seconds,metadata.lastRemoteSnapshotVersion.nanoseconds))})},IndexedDbTargetCache.prototype.getHighestSequenceNumber=function(transaction){return this.retrieveMetadata(transaction).next(function(targetGlobal){return targetGlobal.highestListenSequenceNumber})},IndexedDbTargetCache.prototype.setTargetsMetadata=function(transaction,highestListenSequenceNumber,lastRemoteSnapshotVersion){var _this=this;return this.retrieveMetadata(transaction).next(function(metadata){return metadata.highestListenSequenceNumber=highestListenSequenceNumber,lastRemoteSnapshotVersion&&(metadata.lastRemoteSnapshotVersion=lastRemoteSnapshotVersion.toTimestamp()),highestListenSequenceNumber>metadata.highestListenSequenceNumber&&(metadata.highestListenSequenceNumber=highestListenSequenceNumber),_this.saveMetadata(transaction,metadata)})},IndexedDbTargetCache.prototype.addTargetData=function(transaction,targetData){var _this=this;return this.saveTargetData(transaction,targetData).next(function(){return _this.retrieveMetadata(transaction).next(function(metadata){return metadata.targetCount+=1,_this.updateMetadataFromTargetData(targetData,metadata),_this.saveMetadata(transaction,metadata)})})},IndexedDbTargetCache.prototype.updateTargetData=function(transaction,targetData){return this.saveTargetData(transaction,targetData)},IndexedDbTargetCache.prototype.removeTargetData=function(transaction,targetData){var _this=this;return this.removeMatchingKeysForTargetId(transaction,targetData.targetId).next(function(){return targetsStore(transaction).delete(targetData.targetId)}).next(function(){return _this.retrieveMetadata(transaction)}).next(function(metadata){return hardAssert(metadata.targetCount>0),metadata.targetCount-=1,_this.saveMetadata(transaction,metadata)})},IndexedDbTargetCache.prototype.removeTargets=function(txn,upperBound,activeTargetIds){var _this=this,count=0,promises=[];return targetsStore(txn).iterate(function(key,value){var targetData=fromDbTarget(value);targetData.sequenceNumber<=upperBound&&null===activeTargetIds.get(targetData.targetId)&&(count++,promises.push(_this.removeTargetData(txn,targetData)))}).next(function(){return PersistencePromise.waitFor(promises)}).next(function(){return count})},IndexedDbTargetCache.prototype.forEachTarget=function(txn,f){return targetsStore(txn).iterate(function(key,value){var targetData=fromDbTarget(value);f(targetData)})},IndexedDbTargetCache.prototype.retrieveMetadata=function(transaction){return globalTargetStore(transaction).get(DbTargetGlobal.key).next(function(metadata){return hardAssert(null!==metadata),metadata})},IndexedDbTargetCache.prototype.saveMetadata=function(transaction,metadata){return globalTargetStore(transaction).put(DbTargetGlobal.key,metadata)},IndexedDbTargetCache.prototype.saveTargetData=function(transaction,targetData){return targetsStore(transaction).put(toDbTarget(this.serializer,targetData))},IndexedDbTargetCache.prototype.updateMetadataFromTargetData=function(targetData,metadata){var updated=!1;return targetData.targetId>metadata.highestTargetId&&(metadata.highestTargetId=targetData.targetId,updated=!0),targetData.sequenceNumber>metadata.highestListenSequenceNumber&&(metadata.highestListenSequenceNumber=targetData.sequenceNumber,updated=!0),updated},IndexedDbTargetCache.prototype.getTargetCount=function(transaction){return this.retrieveMetadata(transaction).next(function(metadata){return metadata.targetCount})},IndexedDbTargetCache.prototype.getTargetData=function(transaction,target){var canonicalId=canonifyTarget(target),range=IDBKeyRange.bound([canonicalId,Number.NEGATIVE_INFINITY],[canonicalId,Number.POSITIVE_INFINITY]),result=null;return targetsStore(transaction).iterate({range:range,index:DbTarget.queryTargetsIndexName},function(key,value,control){var found=fromDbTarget(value);targetEquals(target,found.target)&&(result=found,control.done())}).next(function(){return result})},IndexedDbTargetCache.prototype.addMatchingKeys=function(txn,keys,targetId){var _this=this,promises=[],store=documentTargetStore(txn);return keys.forEach(function(key){var path=encodeResourcePath(key.path);promises.push(store.put(new DbTargetDocument(targetId,path))),promises.push(_this.referenceDelegate.addReference(txn,targetId,key))}),PersistencePromise.waitFor(promises)},IndexedDbTargetCache.prototype.removeMatchingKeys=function(txn,keys,targetId){var _this=this,store=documentTargetStore(txn);return PersistencePromise.forEach(keys,function(key){var path=encodeResourcePath(key.path);return PersistencePromise.waitFor([store.delete([targetId,path]),_this.referenceDelegate.removeReference(txn,targetId,key)])})},IndexedDbTargetCache.prototype.removeMatchingKeysForTargetId=function(txn,targetId){var store=documentTargetStore(txn),range=IDBKeyRange.bound([targetId],[targetId+1],!1,!0);return store.delete(range)},IndexedDbTargetCache.prototype.getMatchingKeysForTargetId=function(txn,targetId){var range=IDBKeyRange.bound([targetId],[targetId+1],!1,!0),store=documentTargetStore(txn),result=documentKeySet();return store.iterate({range:range,keysOnly:!0},function(key,_,control){var path=decodeResourcePath(key[1]),docKey=new DocumentKey(path);result=result.add(docKey)}).next(function(){return result})},IndexedDbTargetCache.prototype.containsKey=function(txn,key){var path=encodeResourcePath(key.path),range=IDBKeyRange.bound([path],[immediateSuccessor(path)],!1,!0),count=0;return documentTargetStore(txn).iterate({index:DbTargetDocument.documentTargetsIndex,keysOnly:!0,range:range},function(_d,_,control){var targetId=_d[0];_d[1],0!==targetId&&(count++,control.done())}).next(function(){return count>0})},IndexedDbTargetCache.prototype.getTargetDataForTarget=function(transaction,targetId){return targetsStore(transaction).get(targetId).next(function(found){return found?fromDbTarget(found):null})},IndexedDbTargetCache}();function targetsStore(txn){return getStore(txn,DbTarget.store)}function globalTargetStore(txn){return getStore(txn,DbTargetGlobal.store)}function documentTargetStore(txn){return getStore(txn,DbTargetDocument.store)}function ignoreIfPrimaryLeaseLoss(err){return tslib.__awaiter(this,void 0,void 0,function(){return tslib.__generator(this,function(_d){if(err.code!==Code_FAILED_PRECONDITION||err.message!==PRIMARY_LEASE_LOST_ERROR_MSG)throw err;return logDebug("LocalStore","Unexpectedly lost primary lease"),[2]})})}var GC_DID_NOT_RUN={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},LruParams=function(){function LruParams(cacheSizeCollectionThreshold,percentileToCollect,maximumSequenceNumbersToCollect){this.cacheSizeCollectionThreshold=cacheSizeCollectionThreshold,this.percentileToCollect=percentileToCollect,this.maximumSequenceNumbersToCollect=maximumSequenceNumbersToCollect}return LruParams.withCacheSize=function(cacheSize){return new LruParams(cacheSize,LruParams.DEFAULT_COLLECTION_PERCENTILE,LruParams.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)},LruParams}();LruParams.DEFAULT_COLLECTION_PERCENTILE=10,LruParams.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,LruParams.DEFAULT=new LruParams(41943040,LruParams.DEFAULT_COLLECTION_PERCENTILE,LruParams.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),LruParams.DISABLED=new LruParams(-1,0,0);function bufferEntryComparator(_d,_e){var aSequence=_d[0],aIndex=_d[1],bSequence=_e[0],bIndex=_e[1],seqCmp=primitiveComparator(aSequence,bSequence);return 0===seqCmp?primitiveComparator(aIndex,bIndex):seqCmp}var RollingSequenceNumberBuffer=function(){function RollingSequenceNumberBuffer(maxElements){this.maxElements=maxElements,this.buffer=new SortedSet(bufferEntryComparator),this.previousIndex=0}return RollingSequenceNumberBuffer.prototype.nextIndex=function(){return++this.previousIndex},RollingSequenceNumberBuffer.prototype.addElement=function(sequenceNumber){var entry=[sequenceNumber,this.nextIndex()];if(this.buffer.size<this.maxElements)this.buffer=this.buffer.add(entry);else{var highestValue=this.buffer.last();bufferEntryComparator(entry,highestValue)<0&&(this.buffer=this.buffer.delete(highestValue).add(entry))}},Object.defineProperty(RollingSequenceNumberBuffer.prototype,"maxValue",{get:function(){return this.buffer.last()[0]},enumerable:!1,configurable:!0}),RollingSequenceNumberBuffer}(),LruScheduler=function(){function LruScheduler(garbageCollector,asyncQueue){this.garbageCollector=garbageCollector,this.asyncQueue=asyncQueue,this.hasRun=!1,this.gcTask=null}return LruScheduler.prototype.start=function(localStore){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.scheduleGC(localStore)},LruScheduler.prototype.stop=function(){this.gcTask&&(this.gcTask.cancel(),this.gcTask=null)},Object.defineProperty(LruScheduler.prototype,"started",{get:function(){return null!==this.gcTask},enumerable:!1,configurable:!0}),LruScheduler.prototype.scheduleGC=function(localStore){var _this=this,delay=this.hasRun?3e5:6e4;logDebug("LruGarbageCollector","Garbage collection scheduled in "+delay+"ms"),this.gcTask=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",delay,function(){return tslib.__awaiter(_this,void 0,void 0,function(){var e_1;return tslib.__generator(this,function(_d){switch(_d.label){case 0:this.gcTask=null,this.hasRun=!0,_d.label=1;case 1:return _d.trys.push([1,3,,7]),[4,localStore.collectGarbage(this.garbageCollector)];case 2:return _d.sent(),[3,7];case 3:return isIndexedDbTransactionError(e_1=_d.sent())?(logDebug("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e_1),[3,6]):[3,4];case 4:return[4,ignoreIfPrimaryLeaseLoss(e_1)];case 5:_d.sent(),_d.label=6;case 6:return[3,7];case 7:return[4,this.scheduleGC(localStore)];case 8:return _d.sent(),[2]}})})})},LruScheduler}(),LruGarbageCollectorImpl=function(){function LruGarbageCollectorImpl(delegate,params){this.delegate=delegate,this.params=params}return LruGarbageCollectorImpl.prototype.calculateTargetCount=function(txn,percentile){return this.delegate.getSequenceNumberCount(txn).next(function(targetCount){return Math.floor(percentile/100*targetCount)})},LruGarbageCollectorImpl.prototype.nthSequenceNumber=function(txn,n){var _this=this;if(0===n)return PersistencePromise.resolve(ListenSequence.INVALID);var buffer=new RollingSequenceNumberBuffer(n);return this.delegate.forEachTarget(txn,function(target){return buffer.addElement(target.sequenceNumber)}).next(function(){return _this.delegate.forEachOrphanedDocumentSequenceNumber(txn,function(sequenceNumber){return buffer.addElement(sequenceNumber)})}).next(function(){return buffer.maxValue})},LruGarbageCollectorImpl.prototype.removeTargets=function(txn,upperBound,activeTargetIds){return this.delegate.removeTargets(txn,upperBound,activeTargetIds)},LruGarbageCollectorImpl.prototype.removeOrphanedDocuments=function(txn,upperBound){return this.delegate.removeOrphanedDocuments(txn,upperBound)},LruGarbageCollectorImpl.prototype.collect=function(txn,activeTargetIds){var _this=this;return-1===this.params.cacheSizeCollectionThreshold?(logDebug("LruGarbageCollector","Garbage collection skipped; disabled"),PersistencePromise.resolve(GC_DID_NOT_RUN)):this.getCacheSize(txn).next(function(cacheSize){return cacheSize<_this.params.cacheSizeCollectionThreshold?(logDebug("LruGarbageCollector","Garbage collection skipped; Cache size "+cacheSize+" is lower than threshold "+_this.params.cacheSizeCollectionThreshold),GC_DID_NOT_RUN):_this.runGarbageCollection(txn,activeTargetIds)})},LruGarbageCollectorImpl.prototype.getCacheSize=function(txn){return this.delegate.getCacheSize(txn)},LruGarbageCollectorImpl.prototype.runGarbageCollection=function(txn,activeTargetIds){var upperBoundSequenceNumber,sequenceNumbersToCollect,targetsRemoved,countedTargetsTs,foundUpperBoundTs,removedTargetsTs,removedDocumentsTs,_this=this,startTs=Date.now();return this.calculateTargetCount(txn,this.params.percentileToCollect).next(function(sequenceNumbers){return sequenceNumbers>_this.params.maximumSequenceNumbersToCollect?(logDebug("LruGarbageCollector","Capping sequence numbers to collect down to the maximum of "+_this.params.maximumSequenceNumbersToCollect+" from "+sequenceNumbers),sequenceNumbersToCollect=_this.params.maximumSequenceNumbersToCollect):sequenceNumbersToCollect=sequenceNumbers,countedTargetsTs=Date.now(),_this.nthSequenceNumber(txn,sequenceNumbersToCollect)}).next(function(upperBound){return upperBoundSequenceNumber=upperBound,foundUpperBoundTs=Date.now(),_this.removeTargets(txn,upperBoundSequenceNumber,activeTargetIds)}).next(function(numTargetsRemoved){return targetsRemoved=numTargetsRemoved,removedTargetsTs=Date.now(),_this.removeOrphanedDocuments(txn,upperBoundSequenceNumber)}).next(function(documentsRemoved){(removedDocumentsTs=Date.now(),getLogLevel()<=logger.LogLevel.DEBUG)&&logDebug("LruGarbageCollector","LRU Garbage Collection\n\tCounted targets in "+(countedTargetsTs-startTs)+"ms\n\tDetermined least recently used "+sequenceNumbersToCollect+" in "+(foundUpperBoundTs-countedTargetsTs)+"ms\n\tRemoved "+targetsRemoved+" targets in "+(removedTargetsTs-foundUpperBoundTs)+"ms\n\tRemoved "+documentsRemoved+" documents in "+(removedDocumentsTs-removedTargetsTs)+"ms\nTotal Duration: "+(removedDocumentsTs-startTs)+"ms");return PersistencePromise.resolve({didRun:!0,sequenceNumbersCollected:sequenceNumbersToCollect,targetsRemoved:targetsRemoved,documentsRemoved:documentsRemoved})})},LruGarbageCollectorImpl}();var IndexedDbLruDelegateImpl=function(){function IndexedDbLruDelegateImpl(db,params){this.db=db,this.garbageCollector=function newLruGarbageCollector(delegate,params){return new LruGarbageCollectorImpl(delegate,params)}(this,params)}return IndexedDbLruDelegateImpl.prototype.getSequenceNumberCount=function(txn){var docCountPromise=this.orphanedDocumentCount(txn);return this.db.getTargetCache().getTargetCount(txn).next(function(targetCount){return docCountPromise.next(function(docCount){return targetCount+docCount})})},IndexedDbLruDelegateImpl.prototype.orphanedDocumentCount=function(txn){var orphanedCount=0;return this.forEachOrphanedDocumentSequenceNumber(txn,function(_){orphanedCount++}).next(function(){return orphanedCount})},IndexedDbLruDelegateImpl.prototype.forEachTarget=function(txn,f){return this.db.getTargetCache().forEachTarget(txn,f)},IndexedDbLruDelegateImpl.prototype.forEachOrphanedDocumentSequenceNumber=function(txn,f){return this.forEachOrphanedDocument(txn,function(docKey,sequenceNumber){return f(sequenceNumber)})},IndexedDbLruDelegateImpl.prototype.addReference=function(txn,targetId,key){return writeSentinelKey(txn,key)},IndexedDbLruDelegateImpl.prototype.removeReference=function(txn,targetId,key){return writeSentinelKey(txn,key)},IndexedDbLruDelegateImpl.prototype.removeTargets=function(txn,upperBound,activeTargetIds){return this.db.getTargetCache().removeTargets(txn,upperBound,activeTargetIds)},IndexedDbLruDelegateImpl.prototype.markPotentiallyOrphaned=function(txn,key){return writeSentinelKey(txn,key)},IndexedDbLruDelegateImpl.prototype.isPinned=function(txn,docKey){return function mutationQueuesContainKey(txn,docKey){var found=!1;return mutationQueuesStore(txn).iterateSerial(function(userId){return mutationQueueContainsKey(txn,userId,docKey).next(function(containsKey){return containsKey&&(found=!0),PersistencePromise.resolve(!containsKey)})}).next(function(){return found})}(txn,docKey)},IndexedDbLruDelegateImpl.prototype.removeOrphanedDocuments=function(txn,upperBound){var _this=this,changeBuffer=this.db.getRemoteDocumentCache().newChangeBuffer(),promises=[],documentCount=0;return this.forEachOrphanedDocument(txn,function(docKey,sequenceNumber){if(sequenceNumber<=upperBound){var p=_this.isPinned(txn,docKey).next(function(isPinned){if(!isPinned)return documentCount++,changeBuffer.getEntry(txn,docKey).next(function(){return changeBuffer.removeEntry(docKey),documentTargetStore(txn).delete(function sentinelKey$1(key){return[0,encodeResourcePath(key.path)]}(docKey))})});promises.push(p)}}).next(function(){return PersistencePromise.waitFor(promises)}).next(function(){return changeBuffer.apply(txn)}).next(function(){return documentCount})},IndexedDbLruDelegateImpl.prototype.removeTarget=function(txn,targetData){var updated=targetData.withSequenceNumber(txn.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(txn,updated)},IndexedDbLruDelegateImpl.prototype.updateLimboDocument=function(txn,key){return writeSentinelKey(txn,key)},IndexedDbLruDelegateImpl.prototype.forEachOrphanedDocument=function(txn,f){var nextPath,store=documentTargetStore(txn),nextToReport=ListenSequence.INVALID;return store.iterate({index:DbTargetDocument.documentTargetsIndex},function(_d,_e){var targetId=_d[0];_d[1];var path=_e.path,sequenceNumber=_e.sequenceNumber;0===targetId?(nextToReport!==ListenSequence.INVALID&&f(new DocumentKey(decodeResourcePath(nextPath)),nextToReport),nextToReport=sequenceNumber,nextPath=path):nextToReport=ListenSequence.INVALID}).next(function(){nextToReport!==ListenSequence.INVALID&&f(new DocumentKey(decodeResourcePath(nextPath)),nextToReport)})},IndexedDbLruDelegateImpl.prototype.getCacheSize=function(txn){return this.db.getRemoteDocumentCache().getSize(txn)},IndexedDbLruDelegateImpl}();function writeSentinelKey(txn,key){return documentTargetStore(txn).put(function sentinelRow(key,sequenceNumber){return new DbTargetDocument(0,encodeResourcePath(key.path),sequenceNumber)}(key,txn.currentSequenceNumber))}var ObjectMap=function(){function ObjectMap(mapKeyFn,equalsFn){this.mapKeyFn=mapKeyFn,this.equalsFn=equalsFn,this.inner={}}return ObjectMap.prototype.get=function(key){var id=this.mapKeyFn(key),matches=this.inner[id];if(void 0!==matches)for(var _i=0,matches_1=matches;_i<matches_1.length;_i++){var _d=matches_1[_i],otherKey=_d[0],value=_d[1];if(this.equalsFn(otherKey,key))return value}},ObjectMap.prototype.has=function(key){return void 0!==this.get(key)},ObjectMap.prototype.set=function(key,value){var id=this.mapKeyFn(key),matches=this.inner[id];if(void 0!==matches){for(var i=0;i<matches.length;i++)if(this.equalsFn(matches[i][0],key))return void(matches[i]=[key,value]);matches.push([key,value])}else this.inner[id]=[[key,value]]},ObjectMap.prototype.delete=function(key){var id=this.mapKeyFn(key),matches=this.inner[id];if(void 0===matches)return!1;for(var i=0;i<matches.length;i++)if(this.equalsFn(matches[i][0],key))return 1===matches.length?delete this.inner[id]:matches.splice(i,1),!0;return!1},ObjectMap.prototype.forEach=function(fn){forEach(this.inner,function(_,entries){for(var _i=0,entries_2=entries;_i<entries_2.length;_i++){var _d=entries_2[_i],k=_d[0],v=_d[1];fn(k,v)}})},ObjectMap.prototype.isEmpty=function(){return isEmpty(this.inner)},ObjectMap}(),RemoteDocumentChangeBuffer=function(){function RemoteDocumentChangeBuffer(){this.changes=new ObjectMap(function(key){return key.toString()},function(l,r){return l.isEqual(r)}),this.changesApplied=!1}return RemoteDocumentChangeBuffer.prototype.getReadTime=function(key){var change=this.changes.get(key);return change?change.readTime:SnapshotVersion.min()},RemoteDocumentChangeBuffer.prototype.addEntry=function(document,readTime){this.assertNotApplied(),this.changes.set(document.key,{document:document,readTime:readTime})},RemoteDocumentChangeBuffer.prototype.removeEntry=function(key,readTime){void 0===readTime&&(readTime=null),this.assertNotApplied(),this.changes.set(key,{document:MutableDocument.newInvalidDocument(key),readTime:readTime})},RemoteDocumentChangeBuffer.prototype.getEntry=function(transaction,documentKey){this.assertNotApplied();var bufferedEntry=this.changes.get(documentKey);return void 0!==bufferedEntry?PersistencePromise.resolve(bufferedEntry.document):this.getFromCache(transaction,documentKey)},RemoteDocumentChangeBuffer.prototype.getEntries=function(transaction,documentKeys){return this.getAllFromCache(transaction,documentKeys)},RemoteDocumentChangeBuffer.prototype.apply=function(transaction){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(transaction)},RemoteDocumentChangeBuffer.prototype.assertNotApplied=function(){},RemoteDocumentChangeBuffer}(),IndexedDbRemoteDocumentCacheImpl=function(){function IndexedDbRemoteDocumentCacheImpl(serializer,indexManager){this.serializer=serializer,this.indexManager=indexManager}return IndexedDbRemoteDocumentCacheImpl.prototype.addEntry=function(transaction,key,doc){return remoteDocumentsStore(transaction).put(dbKey(key),doc)},IndexedDbRemoteDocumentCacheImpl.prototype.removeEntry=function(transaction,documentKey){var store=remoteDocumentsStore(transaction),key=dbKey(documentKey);return store.delete(key)},IndexedDbRemoteDocumentCacheImpl.prototype.updateMetadata=function(transaction,sizeDelta){var _this=this;return this.getMetadata(transaction).next(function(metadata){return metadata.byteSize+=sizeDelta,_this.setMetadata(transaction,metadata)})},IndexedDbRemoteDocumentCacheImpl.prototype.getEntry=function(transaction,documentKey){var _this=this;return remoteDocumentsStore(transaction).get(dbKey(documentKey)).next(function(dbRemoteDoc){return _this.maybeDecodeDocument(documentKey,dbRemoteDoc)})},IndexedDbRemoteDocumentCacheImpl.prototype.getSizedEntry=function(transaction,documentKey){var _this=this;return remoteDocumentsStore(transaction).get(dbKey(documentKey)).next(function(dbRemoteDoc){return{document:_this.maybeDecodeDocument(documentKey,dbRemoteDoc),size:dbDocumentSize(dbRemoteDoc)}})},IndexedDbRemoteDocumentCacheImpl.prototype.getEntries=function(transaction,documentKeys){var _this=this,results=mutableDocumentMap();return this.forEachDbEntry(transaction,documentKeys,function(key,dbRemoteDoc){var doc=_this.maybeDecodeDocument(key,dbRemoteDoc);results=results.insert(key,doc)}).next(function(){return results})},IndexedDbRemoteDocumentCacheImpl.prototype.getSizedEntries=function(transaction,documentKeys){var _this=this,results=mutableDocumentMap(),sizeMap=new SortedMap(DocumentKey.comparator);return this.forEachDbEntry(transaction,documentKeys,function(key,dbRemoteDoc){var doc=_this.maybeDecodeDocument(key,dbRemoteDoc);results=results.insert(key,doc),sizeMap=sizeMap.insert(key,dbDocumentSize(dbRemoteDoc))}).next(function(){return{documents:results,sizeMap:sizeMap}})},IndexedDbRemoteDocumentCacheImpl.prototype.forEachDbEntry=function(transaction,documentKeys,callback){if(documentKeys.isEmpty())return PersistencePromise.resolve();var range=IDBKeyRange.bound(documentKeys.first().path.toArray(),documentKeys.last().path.toArray()),keyIter=documentKeys.getIterator(),nextKey=keyIter.getNext();return remoteDocumentsStore(transaction).iterate({range:range},function(potentialKeyRaw,dbRemoteDoc,control){for(var potentialKey=DocumentKey.fromSegments(potentialKeyRaw);nextKey&&DocumentKey.comparator(nextKey,potentialKey)<0;)callback(nextKey,null),nextKey=keyIter.getNext();nextKey&&nextKey.isEqual(potentialKey)&&(callback(nextKey,dbRemoteDoc),nextKey=keyIter.hasNext()?keyIter.getNext():null),nextKey?control.skip(nextKey.path.toArray()):control.done()}).next(function(){for(;nextKey;)callback(nextKey,null),nextKey=keyIter.hasNext()?keyIter.getNext():null})},IndexedDbRemoteDocumentCacheImpl.prototype.getDocumentsMatchingQuery=function(transaction,query,sinceReadTime){var _this=this,results=mutableDocumentMap(),immediateChildrenPathLength=query.path.length+1,iterationOptions={};if(sinceReadTime.isEqual(SnapshotVersion.min())){var startKey=query.path.toArray();iterationOptions.range=IDBKeyRange.lowerBound(startKey)}else{var collectionKey=query.path.toArray(),readTimeKey=toDbTimestampKey(sinceReadTime);iterationOptions.range=IDBKeyRange.lowerBound([collectionKey,readTimeKey],!0),iterationOptions.index=DbRemoteDocument.collectionReadTimeIndex}return remoteDocumentsStore(transaction).iterate(iterationOptions,function(key,dbRemoteDoc,control){if(key.length===immediateChildrenPathLength){var document=fromDbRemoteDocument(_this.serializer,dbRemoteDoc);query.path.isPrefixOf(document.key.path)?queryMatches(query,document)&&(results=results.insert(document.key,document)):control.done()}}).next(function(){return results})},IndexedDbRemoteDocumentCacheImpl.prototype.newChangeBuffer=function(options){return new IndexedDbRemoteDocumentChangeBuffer(this,!!options&&options.trackRemovals)},IndexedDbRemoteDocumentCacheImpl.prototype.getSize=function(txn){return this.getMetadata(txn).next(function(metadata){return metadata.byteSize})},IndexedDbRemoteDocumentCacheImpl.prototype.getMetadata=function(txn){return documentGlobalStore(txn).get(DbRemoteDocumentGlobal.key).next(function(metadata){return hardAssert(!!metadata),metadata})},IndexedDbRemoteDocumentCacheImpl.prototype.setMetadata=function(txn,metadata){return documentGlobalStore(txn).put(DbRemoteDocumentGlobal.key,metadata)},IndexedDbRemoteDocumentCacheImpl.prototype.maybeDecodeDocument=function(documentKey,dbRemoteDoc){if(dbRemoteDoc){var doc_4=fromDbRemoteDocument(this.serializer,dbRemoteDoc);if(!(doc_4.isNoDocument()&&doc_4.version.isEqual(SnapshotVersion.min())))return doc_4}return MutableDocument.newInvalidDocument(documentKey)},IndexedDbRemoteDocumentCacheImpl}();var IndexedDbRemoteDocumentChangeBuffer=function(_super){function IndexedDbRemoteDocumentChangeBuffer(documentCache,trackRemovals){var _this=_super.call(this)||this;return _this.documentCache=documentCache,_this.trackRemovals=trackRemovals,_this.documentSizes=new ObjectMap(function(key){return key.toString()},function(l,r){return l.isEqual(r)}),_this}return tslib.__extends(IndexedDbRemoteDocumentChangeBuffer,_super),IndexedDbRemoteDocumentChangeBuffer.prototype.applyChanges=function(transaction){var _this=this,promises=[],sizeDelta=0,collectionParents=new SortedSet(function(l,r){return primitiveComparator(l.canonicalString(),r.canonicalString())});return this.changes.forEach(function(key,documentChange){var previousSize=_this.documentSizes.get(key);if(documentChange.document.isValidDocument()){var doc_5=toDbRemoteDocument(_this.documentCache.serializer,documentChange.document,_this.getReadTime(key));collectionParents=collectionParents.add(key.path.popLast());var size=dbDocumentSize(doc_5);sizeDelta+=size-previousSize,promises.push(_this.documentCache.addEntry(transaction,key,doc_5))}else if(sizeDelta-=previousSize,_this.trackRemovals){var deletedDoc=toDbRemoteDocument(_this.documentCache.serializer,MutableDocument.newNoDocument(key,SnapshotVersion.min()),_this.getReadTime(key));promises.push(_this.documentCache.addEntry(transaction,key,deletedDoc))}else promises.push(_this.documentCache.removeEntry(transaction,key))}),collectionParents.forEach(function(parent){promises.push(_this.documentCache.indexManager.addToCollectionParentIndex(transaction,parent))}),promises.push(this.documentCache.updateMetadata(transaction,sizeDelta)),PersistencePromise.waitFor(promises)},IndexedDbRemoteDocumentChangeBuffer.prototype.getFromCache=function(transaction,documentKey){var _this=this;return this.documentCache.getSizedEntry(transaction,documentKey).next(function(getResult){return _this.documentSizes.set(documentKey,getResult.size),getResult.document})},IndexedDbRemoteDocumentChangeBuffer.prototype.getAllFromCache=function(transaction,documentKeys){var _this=this;return this.documentCache.getSizedEntries(transaction,documentKeys).next(function(_d){var documents=_d.documents;return _d.sizeMap.forEach(function(documentKey,size){_this.documentSizes.set(documentKey,size)}),documents})},IndexedDbRemoteDocumentChangeBuffer}(RemoteDocumentChangeBuffer);function documentGlobalStore(txn){return getStore(txn,DbRemoteDocumentGlobal.store)}function remoteDocumentsStore(txn){return getStore(txn,DbRemoteDocument.store)}function dbKey(docKey){return docKey.path.toArray()}var SchemaConverter=function(){function SchemaConverter(serializer){this.serializer=serializer}return SchemaConverter.prototype.createOrUpgrade=function(db,txn,fromVersion,toVersion){var _this=this;hardAssert(fromVersion<toVersion&&fromVersion>=0&&toVersion<=11);var simpleDbTransaction=new SimpleDbTransaction("createOrUpgrade",txn);fromVersion<1&&toVersion>=1&&(!function createPrimaryClientStore(db){db.createObjectStore(DbPrimaryClient.store)}(db),function createMutationQueue(db){db.createObjectStore(DbMutationQueue.store,{keyPath:DbMutationQueue.keyPath}),db.createObjectStore(DbMutationBatch.store,{keyPath:DbMutationBatch.keyPath,autoIncrement:!0}).createIndex(DbMutationBatch.userMutationsIndex,DbMutationBatch.userMutationsKeyPath,{unique:!0}),db.createObjectStore(DbDocumentMutation.store)}(db),createQueryCache(db),function createRemoteDocumentCache(db){db.createObjectStore(DbRemoteDocument.store)}(db));var p=PersistencePromise.resolve();return fromVersion<3&&toVersion>=3&&(0!==fromVersion&&(!function dropQueryCache(db){db.deleteObjectStore(DbTargetDocument.store),db.deleteObjectStore(DbTarget.store),db.deleteObjectStore(DbTargetGlobal.store)}(db),createQueryCache(db)),p=p.next(function(){return function writeEmptyTargetGlobalEntry(txn){var globalStore=txn.store(DbTargetGlobal.store),metadata=new DbTargetGlobal(0,0,SnapshotVersion.min().toTimestamp(),0);return globalStore.put(DbTargetGlobal.key,metadata)}(simpleDbTransaction)})),fromVersion<4&&toVersion>=4&&(0!==fromVersion&&(p=p.next(function(){return function upgradeMutationBatchSchemaAndMigrateData(db,txn){return txn.store(DbMutationBatch.store).loadAll().next(function(existingMutations){db.deleteObjectStore(DbMutationBatch.store),db.createObjectStore(DbMutationBatch.store,{keyPath:DbMutationBatch.keyPath,autoIncrement:!0}).createIndex(DbMutationBatch.userMutationsIndex,DbMutationBatch.userMutationsKeyPath,{unique:!0});var v3MutationsStore=txn.store(DbMutationBatch.store),writeAll=existingMutations.map(function(mutation){return v3MutationsStore.put(mutation)});return PersistencePromise.waitFor(writeAll)})}(db,simpleDbTransaction)})),p=p.next(function(){!function createClientMetadataStore(db){db.createObjectStore(DbClientMetadata.store,{keyPath:DbClientMetadata.keyPath})}(db)})),fromVersion<5&&toVersion>=5&&(p=p.next(function(){return _this.removeAcknowledgedMutations(simpleDbTransaction)})),fromVersion<6&&toVersion>=6&&(p=p.next(function(){return function createDocumentGlobalStore(db){db.createObjectStore(DbRemoteDocumentGlobal.store)}(db),_this.addDocumentGlobal(simpleDbTransaction)})),fromVersion<7&&toVersion>=7&&(p=p.next(function(){return _this.ensureSequenceNumbers(simpleDbTransaction)})),fromVersion<8&&toVersion>=8&&(p=p.next(function(){return _this.createCollectionParentIndex(db,simpleDbTransaction)})),fromVersion<9&&toVersion>=9&&(p=p.next(function(){!function dropRemoteDocumentChangesStore(db){db.objectStoreNames.contains("remoteDocumentChanges")&&db.deleteObjectStore("remoteDocumentChanges")}(db),function createRemoteDocumentReadTimeIndex(txn){var remoteDocumentStore=txn.objectStore(DbRemoteDocument.store);remoteDocumentStore.createIndex(DbRemoteDocument.readTimeIndex,DbRemoteDocument.readTimeIndexPath,{unique:!1}),remoteDocumentStore.createIndex(DbRemoteDocument.collectionReadTimeIndex,DbRemoteDocument.collectionReadTimeIndexPath,{unique:!1})}(txn)})),fromVersion<10&&toVersion>=10&&(p=p.next(function(){return _this.rewriteCanonicalIds(simpleDbTransaction)})),fromVersion<11&&toVersion>=11&&(p=p.next(function(){!function createBundlesStore(db){db.createObjectStore(DbBundle.store,{keyPath:DbBundle.keyPath})}(db),function createNamedQueriesStore(db){db.createObjectStore(DbNamedQuery.store,{keyPath:DbNamedQuery.keyPath})}(db)})),p},SchemaConverter.prototype.addDocumentGlobal=function(txn){var byteCount=0;return txn.store(DbRemoteDocument.store).iterate(function(_,doc){byteCount+=dbDocumentSize(doc)}).next(function(){var metadata=new DbRemoteDocumentGlobal(byteCount);return txn.store(DbRemoteDocumentGlobal.store).put(DbRemoteDocumentGlobal.key,metadata)})},SchemaConverter.prototype.removeAcknowledgedMutations=function(txn){var _this=this,queuesStore=txn.store(DbMutationQueue.store),mutationsStore=txn.store(DbMutationBatch.store);return queuesStore.loadAll().next(function(queues){return PersistencePromise.forEach(queues,function(queue){var range=IDBKeyRange.bound([queue.userId,-1],[queue.userId,queue.lastAcknowledgedBatchId]);return mutationsStore.loadAll(DbMutationBatch.userMutationsIndex,range).next(function(dbBatches){return PersistencePromise.forEach(dbBatches,function(dbBatch){hardAssert(dbBatch.userId===queue.userId);var batch=fromDbMutationBatch(_this.serializer,dbBatch);return removeMutationBatch(txn,queue.userId,batch).next(function(){})})})})})},SchemaConverter.prototype.ensureSequenceNumbers=function(txn){var documentTargetStore=txn.store(DbTargetDocument.store),documentsStore=txn.store(DbRemoteDocument.store);return txn.store(DbTargetGlobal.store).get(DbTargetGlobal.key).next(function(metadata){var promises=[];return documentsStore.iterate(function(key,doc){var path=new ResourcePath(key),docSentinelKey=function sentinelKey(path){return[0,encodeResourcePath(path)]}(path);promises.push(documentTargetStore.get(docSentinelKey).next(function(maybeSentinel){return maybeSentinel?PersistencePromise.resolve():function(path){return documentTargetStore.put(new DbTargetDocument(0,encodeResourcePath(path),metadata.highestListenSequenceNumber))}(path)}))}).next(function(){return PersistencePromise.waitFor(promises)})})},SchemaConverter.prototype.createCollectionParentIndex=function(db,txn){db.createObjectStore(DbCollectionParent.store,{keyPath:DbCollectionParent.keyPath});var collectionParentsStore=txn.store(DbCollectionParent.store),cache=new MemoryCollectionParentIndex,addEntry=function(collectionPath){if(cache.add(collectionPath)){var collectionId=collectionPath.lastSegment(),parentPath=collectionPath.popLast();return collectionParentsStore.put({collectionId:collectionId,parent:encodeResourcePath(parentPath)})}};return txn.store(DbRemoteDocument.store).iterate({keysOnly:!0},function(pathSegments,_){var path=new ResourcePath(pathSegments);return addEntry(path.popLast())}).next(function(){return txn.store(DbDocumentMutation.store).iterate({keysOnly:!0},function(_d,_){_d[0];var encodedPath=_d[1];_d[2];var path=decodeResourcePath(encodedPath);return addEntry(path.popLast())})})},SchemaConverter.prototype.rewriteCanonicalIds=function(txn){var _this=this,targetStore=txn.store(DbTarget.store);return targetStore.iterate(function(key,originalDbTarget){var originalTargetData=fromDbTarget(originalDbTarget),updatedDbTarget=toDbTarget(_this.serializer,originalTargetData);return targetStore.put(updatedDbTarget)})},SchemaConverter}();function createQueryCache(db){db.createObjectStore(DbTargetDocument.store,{keyPath:DbTargetDocument.keyPath}).createIndex(DbTargetDocument.documentTargetsIndex,DbTargetDocument.documentTargetsKeyPath,{unique:!0}),db.createObjectStore(DbTarget.store,{keyPath:DbTarget.keyPath}).createIndex(DbTarget.queryTargetsIndexName,DbTarget.queryTargetsKeyPath,{unique:!0}),db.createObjectStore(DbTargetGlobal.store)}var LOG_TAG$d="IndexedDbPersistence",PRIMARY_LEASE_EXCLUSIVE_ERROR_MSG="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",IndexedDbPersistence=function(){function IndexedDbPersistence(allowTabSynchronization,persistenceKey,clientId,lruParams,queue,window,document,serializer,sequenceNumberSyncer,forceOwningTab){if(this.allowTabSynchronization=allowTabSynchronization,this.persistenceKey=persistenceKey,this.clientId=clientId,this.queue=queue,this.window=window,this.document=document,this.sequenceNumberSyncer=sequenceNumberSyncer,this.forceOwningTab=forceOwningTab,this.listenSequence=null,this._started=!1,this.isPrimary=!1,this.networkEnabled=!0,this.windowUnloadHandler=null,this.inForeground=!1,this.documentVisibilityHandler=null,this.clientMetadataRefresher=null,this.lastGarbageCollectionTime=Number.NEGATIVE_INFINITY,this.primaryStateListener=function(_){return Promise.resolve()},!IndexedDbPersistence.isAvailable())throw new FirestoreError(Code_UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new IndexedDbLruDelegateImpl(this,lruParams),this.dbName=persistenceKey+"main",this.serializer=new LocalSerializer(serializer),this.simpleDb=new SimpleDb(this.dbName,11,new SchemaConverter(this.serializer)),this.targetCache=new IndexedDbTargetCache(this.referenceDelegate,this.serializer),this.indexManager=new IndexedDbIndexManager,this.remoteDocumentCache=function newIndexedDbRemoteDocumentCache(serializer,indexManager){return new IndexedDbRemoteDocumentCacheImpl(serializer,indexManager)}(this.serializer,this.indexManager),this.bundleCache=new IndexedDbBundleCache,this.window&&this.window.localStorage?this.webStorage=this.window.localStorage:(this.webStorage=null,!1===forceOwningTab&&logError(LOG_TAG$d,"LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}return IndexedDbPersistence.prototype.start=function(){var _this=this;return this.updateClientMetadataAndTryBecomePrimary().then(function(){if(!_this.isPrimary&&!_this.allowTabSynchronization)throw new FirestoreError(Code_FAILED_PRECONDITION,PRIMARY_LEASE_EXCLUSIVE_ERROR_MSG);return _this.attachVisibilityHandler(),_this.attachWindowUnloadHook(),_this.scheduleClientMetadataAndPrimaryLeaseRefreshes(),_this.runTransaction("getHighestListenSequenceNumber","readonly",function(txn){return _this.targetCache.getHighestSequenceNumber(txn)})}).then(function(highestListenSequenceNumber){_this.listenSequence=new ListenSequence(highestListenSequenceNumber,_this.sequenceNumberSyncer)}).then(function(){_this._started=!0}).catch(function(reason){return _this.simpleDb&&_this.simpleDb.close(),Promise.reject(reason)})},IndexedDbPersistence.prototype.setPrimaryStateListener=function(primaryStateListener){var _this=this;return this.primaryStateListener=function(primaryState){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){return this.started?[2,primaryStateListener(primaryState)]:[2]})})},primaryStateListener(this.isPrimary)},IndexedDbPersistence.prototype.setDatabaseDeletedListener=function(databaseDeletedListener){var _this=this;this.simpleDb.setVersionChangeListener(function(event){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return null!==event.newVersion?[3,2]:[4,databaseDeletedListener()];case 1:_d.sent(),_d.label=2;case 2:return[2]}})})})},IndexedDbPersistence.prototype.setNetworkEnabled=function(networkEnabled){var _this=this;this.networkEnabled!==networkEnabled&&(this.networkEnabled=networkEnabled,this.queue.enqueueAndForget(function(){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return this.started?[4,this.updateClientMetadataAndTryBecomePrimary()]:[3,2];case 1:_d.sent(),_d.label=2;case 2:return[2]}})})}))},IndexedDbPersistence.prototype.updateClientMetadataAndTryBecomePrimary=function(){var _this=this;return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",function(txn){return clientMetadataStore(txn).put(new DbClientMetadata(_this.clientId,Date.now(),_this.networkEnabled,_this.inForeground)).next(function(){if(_this.isPrimary)return _this.verifyPrimaryLease(txn).next(function(success){success||(_this.isPrimary=!1,_this.queue.enqueueRetryable(function(){return _this.primaryStateListener(!1)}))})}).next(function(){return _this.canActAsPrimary(txn)}).next(function(canActAsPrimary){return _this.isPrimary&&!canActAsPrimary?_this.releasePrimaryLeaseIfHeld(txn).next(function(){return!1}):!!canActAsPrimary&&_this.acquireOrExtendPrimaryLease(txn).next(function(){return!0})})}).catch(function(e){if(isIndexedDbTransactionError(e))return logDebug(LOG_TAG$d,"Failed to extend owner lease: ",e),_this.isPrimary;if(!_this.allowTabSynchronization)throw e;return logDebug(LOG_TAG$d,"Releasing owner lease after error during lease refresh",e),!1}).then(function(isPrimary){_this.isPrimary!==isPrimary&&_this.queue.enqueueRetryable(function(){return _this.primaryStateListener(isPrimary)}),_this.isPrimary=isPrimary})},IndexedDbPersistence.prototype.verifyPrimaryLease=function(txn){var _this=this;return primaryClientStore(txn).get(DbPrimaryClient.key).next(function(primaryClient){return PersistencePromise.resolve(_this.isLocalClient(primaryClient))})},IndexedDbPersistence.prototype.removeClientMetadata=function(txn){return clientMetadataStore(txn).delete(this.clientId)},IndexedDbPersistence.prototype.maybeGarbageCollectMultiClientState=function(){return tslib.__awaiter(this,void 0,void 0,function(){var inactiveClients,_i,inactiveClients_1,inactiveClient,_this=this;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return!this.isPrimary||this.isWithinAge(this.lastGarbageCollectionTime,18e5)?[3,2]:(this.lastGarbageCollectionTime=Date.now(),[4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",function(txn){var metadataStore=getStore(txn,DbClientMetadata.store);return metadataStore.loadAll().next(function(existingClients){var active=_this.filterActiveClients(existingClients,18e5),inactive=existingClients.filter(function(client){return-1===active.indexOf(client)});return PersistencePromise.forEach(inactive,function(inactiveClient){return metadataStore.delete(inactiveClient.clientId)}).next(function(){return inactive})})}).catch(function(){return[]})]);case 1:if(inactiveClients=_d.sent(),this.webStorage)for(_i=0,inactiveClients_1=inactiveClients;_i<inactiveClients_1.length;_i++)inactiveClient=inactiveClients_1[_i],this.webStorage.removeItem(this.zombiedClientLocalStorageKey(inactiveClient.clientId));_d.label=2;case 2:return[2]}})})},IndexedDbPersistence.prototype.scheduleClientMetadataAndPrimaryLeaseRefreshes=function(){var _this=this;this.clientMetadataRefresher=this.queue.enqueueAfterDelay("client_metadata_refresh",4e3,function(){return _this.updateClientMetadataAndTryBecomePrimary().then(function(){return _this.maybeGarbageCollectMultiClientState()}).then(function(){return _this.scheduleClientMetadataAndPrimaryLeaseRefreshes()})})},IndexedDbPersistence.prototype.isLocalClient=function(client){return!!client&&client.ownerId===this.clientId},IndexedDbPersistence.prototype.canActAsPrimary=function(txn){var _this=this;return this.forceOwningTab?PersistencePromise.resolve(!0):primaryClientStore(txn).get(DbPrimaryClient.key).next(function(currentPrimary){if(null!==currentPrimary&&_this.isWithinAge(currentPrimary.leaseTimestampMs,5e3)&&!_this.isClientZombied(currentPrimary.ownerId)){if(_this.isLocalClient(currentPrimary)&&_this.networkEnabled)return!0;if(!_this.isLocalClient(currentPrimary)){if(!currentPrimary.allowTabSynchronization)throw new FirestoreError(Code_FAILED_PRECONDITION,PRIMARY_LEASE_EXCLUSIVE_ERROR_MSG);return!1}}return!(!_this.networkEnabled||!_this.inForeground)||clientMetadataStore(txn).loadAll().next(function(existingClients){return void 0===_this.filterActiveClients(existingClients,5e3).find(function(otherClient){if(_this.clientId!==otherClient.clientId){var otherClientHasBetterNetworkState=!_this.networkEnabled&&otherClient.networkEnabled,otherClientHasBetterVisibility=!_this.inForeground&&otherClient.inForeground,otherClientHasSameNetworkState=_this.networkEnabled===otherClient.networkEnabled;if(otherClientHasBetterNetworkState||otherClientHasBetterVisibility&&otherClientHasSameNetworkState)return!0}return!1})})}).next(function(canActAsPrimary){return _this.isPrimary!==canActAsPrimary&&logDebug(LOG_TAG$d,"Client "+(canActAsPrimary?"is":"is not")+" eligible for a primary lease."),canActAsPrimary})},IndexedDbPersistence.prototype.shutdown=function(){return tslib.__awaiter(this,void 0,void 0,function(){var _this=this;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return this._started=!1,this.markClientZombied(),this.clientMetadataRefresher&&(this.clientMetadataRefresher.cancel(),this.clientMetadataRefresher=null),this.detachVisibilityHandler(),this.detachWindowUnloadHook(),[4,this.simpleDb.runTransaction("shutdown","readwrite",[DbPrimaryClient.store,DbClientMetadata.store],function(simpleDbTxn){var persistenceTransaction=new IndexedDbTransaction(simpleDbTxn,ListenSequence.INVALID);return _this.releasePrimaryLeaseIfHeld(persistenceTransaction).next(function(){return _this.removeClientMetadata(persistenceTransaction)})})];case 1:return _d.sent(),this.simpleDb.close(),this.removeClientZombiedEntry(),[2]}})})},IndexedDbPersistence.prototype.filterActiveClients=function(clients,activityThresholdMs){var _this=this;return clients.filter(function(client){return _this.isWithinAge(client.updateTimeMs,activityThresholdMs)&&!_this.isClientZombied(client.clientId)})},IndexedDbPersistence.prototype.getActiveClients=function(){var _this=this;return this.runTransaction("getActiveClients","readonly",function(txn){return clientMetadataStore(txn).loadAll().next(function(clients){return _this.filterActiveClients(clients,18e5).map(function(clientMetadata){return clientMetadata.clientId})})})},Object.defineProperty(IndexedDbPersistence.prototype,"started",{get:function(){return this._started},enumerable:!1,configurable:!0}),IndexedDbPersistence.prototype.getMutationQueue=function(user){return IndexedDbMutationQueue.forUser(user,this.serializer,this.indexManager,this.referenceDelegate)},IndexedDbPersistence.prototype.getTargetCache=function(){return this.targetCache},IndexedDbPersistence.prototype.getRemoteDocumentCache=function(){return this.remoteDocumentCache},IndexedDbPersistence.prototype.getIndexManager=function(){return this.indexManager},IndexedDbPersistence.prototype.getBundleCache=function(){return this.bundleCache},IndexedDbPersistence.prototype.runTransaction=function(action,mode,transactionOperation){var _this=this;logDebug(LOG_TAG$d,"Starting transaction:",action);var persistenceTransaction,simpleDbMode="readonly"===mode?"readonly":"readwrite";return this.simpleDb.runTransaction(action,simpleDbMode,ALL_STORES,function(simpleDbTxn){return persistenceTransaction=new IndexedDbTransaction(simpleDbTxn,_this.listenSequence?_this.listenSequence.next():ListenSequence.INVALID),"readwrite-primary"===mode?_this.verifyPrimaryLease(persistenceTransaction).next(function(holdsPrimaryLease){return!!holdsPrimaryLease||_this.canActAsPrimary(persistenceTransaction)}).next(function(holdsPrimaryLease){if(!holdsPrimaryLease)throw logError("Failed to obtain primary lease for action '"+action+"'."),_this.isPrimary=!1,_this.queue.enqueueRetryable(function(){return _this.primaryStateListener(!1)}),new FirestoreError(Code_FAILED_PRECONDITION,PRIMARY_LEASE_LOST_ERROR_MSG);return transactionOperation(persistenceTransaction)}).next(function(result){return _this.acquireOrExtendPrimaryLease(persistenceTransaction).next(function(){return result})}):_this.verifyAllowTabSynchronization(persistenceTransaction).next(function(){return transactionOperation(persistenceTransaction)})}).then(function(result){return persistenceTransaction.raiseOnCommittedEvent(),result})},IndexedDbPersistence.prototype.verifyAllowTabSynchronization=function(txn){var _this=this;return primaryClientStore(txn).get(DbPrimaryClient.key).next(function(currentPrimary){if(null!==currentPrimary&&_this.isWithinAge(currentPrimary.leaseTimestampMs,5e3)&&!_this.isClientZombied(currentPrimary.ownerId)&&!_this.isLocalClient(currentPrimary)&&!(_this.forceOwningTab||_this.allowTabSynchronization&&currentPrimary.allowTabSynchronization))throw new FirestoreError(Code_FAILED_PRECONDITION,PRIMARY_LEASE_EXCLUSIVE_ERROR_MSG)})},IndexedDbPersistence.prototype.acquireOrExtendPrimaryLease=function(txn){var newPrimary=new DbPrimaryClient(this.clientId,this.allowTabSynchronization,Date.now());return primaryClientStore(txn).put(DbPrimaryClient.key,newPrimary)},IndexedDbPersistence.isAvailable=function(){return SimpleDb.isAvailable()},IndexedDbPersistence.prototype.releasePrimaryLeaseIfHeld=function(txn){var _this=this,store=primaryClientStore(txn);return store.get(DbPrimaryClient.key).next(function(primaryClient){return _this.isLocalClient(primaryClient)?(logDebug(LOG_TAG$d,"Releasing primary lease."),store.delete(DbPrimaryClient.key)):PersistencePromise.resolve()})},IndexedDbPersistence.prototype.isWithinAge=function(updateTimeMs,maxAgeMs){var now=Date.now();return!(updateTimeMs<now-maxAgeMs)&&(!(updateTimeMs>now)||(logError("Detected an update time that is in the future: "+updateTimeMs+" > "+now),!1))},IndexedDbPersistence.prototype.attachVisibilityHandler=function(){var _this=this;null!==this.document&&"function"==typeof this.document.addEventListener&&(this.documentVisibilityHandler=function(){_this.queue.enqueueAndForget(function(){return _this.inForeground="visible"===_this.document.visibilityState,_this.updateClientMetadataAndTryBecomePrimary()})},this.document.addEventListener("visibilitychange",this.documentVisibilityHandler),this.inForeground="visible"===this.document.visibilityState)},IndexedDbPersistence.prototype.detachVisibilityHandler=function(){this.documentVisibilityHandler&&(this.document.removeEventListener("visibilitychange",this.documentVisibilityHandler),this.documentVisibilityHandler=null)},IndexedDbPersistence.prototype.attachWindowUnloadHook=function(){var _a,_this=this;"function"==typeof(null===(_a=this.window)||void 0===_a?void 0:_a.addEventListener)&&(this.windowUnloadHandler=function(){_this.markClientZombied(),_this.queue.enqueueAndForget(function(){return _this.shutdown()})},this.window.addEventListener("pagehide",this.windowUnloadHandler))},IndexedDbPersistence.prototype.detachWindowUnloadHook=function(){this.windowUnloadHandler&&(this.window.removeEventListener("pagehide",this.windowUnloadHandler),this.windowUnloadHandler=null)},IndexedDbPersistence.prototype.isClientZombied=function(clientId){var _a;try{var isZombied=null!==(null===(_a=this.webStorage)||void 0===_a?void 0:_a.getItem(this.zombiedClientLocalStorageKey(clientId)));return logDebug(LOG_TAG$d,"Client '"+clientId+"' "+(isZombied?"is":"is not")+" zombied in LocalStorage"),isZombied}catch(e){return logError(LOG_TAG$d,"Failed to get zombied client id.",e),!1}},IndexedDbPersistence.prototype.markClientZombied=function(){if(this.webStorage)try{this.webStorage.setItem(this.zombiedClientLocalStorageKey(this.clientId),String(Date.now()))}catch(e){logError("Failed to set zombie client id.",e)}},IndexedDbPersistence.prototype.removeClientZombiedEntry=function(){if(this.webStorage)try{this.webStorage.removeItem(this.zombiedClientLocalStorageKey(this.clientId))}catch(e){}},IndexedDbPersistence.prototype.zombiedClientLocalStorageKey=function(clientId){return"firestore_zombie_"+this.persistenceKey+"_"+clientId},IndexedDbPersistence}();function primaryClientStore(txn){return getStore(txn,DbPrimaryClient.store)}function clientMetadataStore(txn){return getStore(txn,DbClientMetadata.store)}function indexedDbStoragePrefix(databaseId,persistenceKey){var database=databaseId.projectId;return databaseId.isDefaultDatabase||(database+="."+databaseId.database),"firestore/"+persistenceKey+"/"+database+"/"}function indexedDbClearPersistence(persistenceKey){return tslib.__awaiter(this,void 0,void 0,function(){var dbName;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return SimpleDb.isAvailable()?(dbName=persistenceKey+"main",[4,SimpleDb.delete(dbName)]):[2,Promise.resolve()];case 1:return _d.sent(),[2]}})})}var LocalDocumentsView=function(){function LocalDocumentsView(remoteDocumentCache,mutationQueue,indexManager){this.remoteDocumentCache=remoteDocumentCache,this.mutationQueue=mutationQueue,this.indexManager=indexManager}return LocalDocumentsView.prototype.getDocument=function(transaction,key){var _this=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKey(transaction,key).next(function(batches){return _this.getDocumentInternal(transaction,key,batches)})},LocalDocumentsView.prototype.getDocumentInternal=function(transaction,key,inBatches){return this.remoteDocumentCache.getEntry(transaction,key).next(function(doc){for(var _i=0,inBatches_1=inBatches;_i<inBatches_1.length;_i++){inBatches_1[_i].applyToLocalView(doc)}return doc})},LocalDocumentsView.prototype.applyLocalMutationsToDocuments=function(docs,batches){docs.forEach(function(key,localView){for(var _i=0,batches_1=batches;_i<batches_1.length;_i++){batches_1[_i].applyToLocalView(localView)}})},LocalDocumentsView.prototype.getDocuments=function(transaction,keys){var _this=this;return this.remoteDocumentCache.getEntries(transaction,keys).next(function(docs){return _this.applyLocalViewToDocuments(transaction,docs).next(function(){return docs})})},LocalDocumentsView.prototype.applyLocalViewToDocuments=function(transaction,baseDocs){var _this=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(transaction,baseDocs).next(function(batches){return _this.applyLocalMutationsToDocuments(baseDocs,batches)})},LocalDocumentsView.prototype.getDocumentsMatchingQuery=function(transaction,query,sinceReadTime){return function isDocumentQuery$1(query){return DocumentKey.isDocumentKey(query.path)&&null===query.collectionGroup&&0===query.filters.length}(query)?this.getDocumentsMatchingDocumentQuery(transaction,query.path):isCollectionGroupQuery(query)?this.getDocumentsMatchingCollectionGroupQuery(transaction,query,sinceReadTime):this.getDocumentsMatchingCollectionQuery(transaction,query,sinceReadTime)},LocalDocumentsView.prototype.getDocumentsMatchingDocumentQuery=function(transaction,docPath){return this.getDocument(transaction,new DocumentKey(docPath)).next(function(document){var result=documentMap();return document.isFoundDocument()&&(result=result.insert(document.key,document)),result})},LocalDocumentsView.prototype.getDocumentsMatchingCollectionGroupQuery=function(transaction,query,sinceReadTime){var _this=this,collectionId=query.collectionGroup,results=documentMap();return this.indexManager.getCollectionParents(transaction,collectionId).next(function(parents){return PersistencePromise.forEach(parents,function(parent){var collectionQuery=function asCollectionQueryAtPath(query,path){return new QueryImpl(path,null,query.explicitOrderBy.slice(),query.filters.slice(),query.limit,query.limitType,query.startAt,query.endAt)}(query,parent.child(collectionId));return _this.getDocumentsMatchingCollectionQuery(transaction,collectionQuery,sinceReadTime).next(function(r){r.forEach(function(key,doc){results=results.insert(key,doc)})})}).next(function(){return results})})},LocalDocumentsView.prototype.getDocumentsMatchingCollectionQuery=function(transaction,query,sinceReadTime){var results,mutationBatches,_this=this;return this.remoteDocumentCache.getDocumentsMatchingQuery(transaction,query,sinceReadTime).next(function(queryResults){return results=queryResults,_this.mutationQueue.getAllMutationBatchesAffectingQuery(transaction,query)}).next(function(matchingMutationBatches){return mutationBatches=matchingMutationBatches,_this.addMissingBaseDocuments(transaction,mutationBatches,results).next(function(mergedDocuments){results=mergedDocuments;for(var _i=0,mutationBatches_1=mutationBatches;_i<mutationBatches_1.length;_i++)for(var batch=mutationBatches_1[_i],_d=0,_e=batch.mutations;_d<_e.length;_d++){var mutation=_e[_d],key=mutation.key,document_2=results.get(key);null==document_2&&(document_2=MutableDocument.newInvalidDocument(key),results=results.insert(key,document_2)),applyMutationToLocalView(mutation,document_2,batch.localWriteTime),document_2.isFoundDocument()||(results=results.remove(key))}})}).next(function(){return results.forEach(function(key,doc){queryMatches(query,doc)||(results=results.remove(key))}),results})},LocalDocumentsView.prototype.addMissingBaseDocuments=function(transaction,matchingMutationBatches,existingDocuments){for(var missingBaseDocEntriesForPatching=documentKeySet(),_i=0,matchingMutationBatches_1=matchingMutationBatches;_i<matchingMutationBatches_1.length;_i++)for(var _d=0,_e=matchingMutationBatches_1[_i].mutations;_d<_e.length;_d++){var mutation=_e[_d];mutation instanceof PatchMutation&&null===existingDocuments.get(mutation.key)&&(missingBaseDocEntriesForPatching=missingBaseDocEntriesForPatching.add(mutation.key))}var mergedDocuments=existingDocuments;return this.remoteDocumentCache.getEntries(transaction,missingBaseDocEntriesForPatching).next(function(missingBaseDocs){return missingBaseDocs.forEach(function(key,doc){doc.isFoundDocument()&&(mergedDocuments=mergedDocuments.insert(key,doc))}),mergedDocuments})},LocalDocumentsView}(),LocalStoreImpl=function(){function LocalStoreImpl(persistence,queryEngine,initialUser,serializer){this.persistence=persistence,this.queryEngine=queryEngine,this.serializer=serializer,this.targetDataByTarget=new SortedMap(primitiveComparator),this.targetIdByTarget=new ObjectMap(function(t){return canonifyTarget(t)},targetEquals),this.lastDocumentChangeReadTime=SnapshotVersion.min(),this.mutationQueue=persistence.getMutationQueue(initialUser),this.remoteDocuments=persistence.getRemoteDocumentCache(),this.targetCache=persistence.getTargetCache(),this.localDocuments=new LocalDocumentsView(this.remoteDocuments,this.mutationQueue,this.persistence.getIndexManager()),this.bundleCache=persistence.getBundleCache(),this.queryEngine.setLocalDocumentsView(this.localDocuments)}return LocalStoreImpl.prototype.collectGarbage=function(garbageCollector){var _this=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary",function(txn){return garbageCollector.collect(txn,_this.targetDataByTarget)})},LocalStoreImpl}();function newLocalStore(persistence,queryEngine,initialUser,serializer){return new LocalStoreImpl(persistence,queryEngine,initialUser,serializer)}function localStoreHandleUserChange(localStore,user){return tslib.__awaiter(this,void 0,void 0,function(){var localStoreImpl,newMutationQueue,newLocalDocuments,result;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return localStoreImpl=debugCast(localStore),newMutationQueue=localStoreImpl.mutationQueue,newLocalDocuments=localStoreImpl.localDocuments,[4,localStoreImpl.persistence.runTransaction("Handle user change","readonly",function(txn){var oldBatches;return localStoreImpl.mutationQueue.getAllMutationBatches(txn).next(function(promisedOldBatches){return oldBatches=promisedOldBatches,newMutationQueue=localStoreImpl.persistence.getMutationQueue(user),newLocalDocuments=new LocalDocumentsView(localStoreImpl.remoteDocuments,newMutationQueue,localStoreImpl.persistence.getIndexManager()),newMutationQueue.getAllMutationBatches(txn)}).next(function(newBatches){for(var removedBatchIds=[],addedBatchIds=[],changedKeys=documentKeySet(),_i=0,oldBatches_1=oldBatches;_i<oldBatches_1.length;_i++){var batch=oldBatches_1[_i];removedBatchIds.push(batch.batchId);for(var _d=0,_e=batch.mutations;_d<_e.length;_d++){var mutation=_e[_d];changedKeys=changedKeys.add(mutation.key)}}for(var _f=0,newBatches_1=newBatches;_f<newBatches_1.length;_f++){batch=newBatches_1[_f];addedBatchIds.push(batch.batchId);for(var _g=0,_h=batch.mutations;_g<_h.length;_g++){mutation=_h[_g];changedKeys=changedKeys.add(mutation.key)}}return newLocalDocuments.getDocuments(txn,changedKeys).next(function(affectedDocuments){return{affectedDocuments:affectedDocuments,removedBatchIds:removedBatchIds,addedBatchIds:addedBatchIds}})})})];case 1:return result=_d.sent(),localStoreImpl.mutationQueue=newMutationQueue,localStoreImpl.localDocuments=newLocalDocuments,localStoreImpl.queryEngine.setLocalDocumentsView(localStoreImpl.localDocuments),[2,result]}})})}function localStoreAcknowledgeBatch(localStore,batchResult){var localStoreImpl=debugCast(localStore);return localStoreImpl.persistence.runTransaction("Acknowledge batch","readwrite-primary",function(txn){var affected=batchResult.batch.keys(),documentBuffer=localStoreImpl.remoteDocuments.newChangeBuffer({trackRemovals:!0});return function applyWriteToRemoteDocuments(localStoreImpl,txn,batchResult,documentBuffer){var batch=batchResult.batch,docKeys=batch.keys(),promiseChain=PersistencePromise.resolve();return docKeys.forEach(function(docKey){promiseChain=promiseChain.next(function(){return documentBuffer.getEntry(txn,docKey)}).next(function(doc){var ackVersion=batchResult.docVersions.get(docKey);hardAssert(null!==ackVersion),doc.version.compareTo(ackVersion)<0&&(batch.applyToRemoteDocument(doc,batchResult),doc.isValidDocument()&&documentBuffer.addEntry(doc,batchResult.commitVersion))})}),promiseChain.next(function(){return localStoreImpl.mutationQueue.removeMutationBatch(txn,batch)})}(localStoreImpl,txn,batchResult,documentBuffer).next(function(){return documentBuffer.apply(txn)}).next(function(){return localStoreImpl.mutationQueue.performConsistencyCheck(txn)}).next(function(){return localStoreImpl.localDocuments.getDocuments(txn,affected)})})}function localStoreRejectBatch(localStore,batchId){var localStoreImpl=debugCast(localStore);return localStoreImpl.persistence.runTransaction("Reject batch","readwrite-primary",function(txn){var affectedKeys;return localStoreImpl.mutationQueue.lookupMutationBatch(txn,batchId).next(function(batch){return hardAssert(null!==batch),affectedKeys=batch.keys(),localStoreImpl.mutationQueue.removeMutationBatch(txn,batch)}).next(function(){return localStoreImpl.mutationQueue.performConsistencyCheck(txn)}).next(function(){return localStoreImpl.localDocuments.getDocuments(txn,affectedKeys)})})}function localStoreGetLastRemoteSnapshotVersion(localStore){var localStoreImpl=debugCast(localStore);return localStoreImpl.persistence.runTransaction("Get last remote snapshot version","readonly",function(txn){return localStoreImpl.targetCache.getLastRemoteSnapshotVersion(txn)})}function localStoreApplyRemoteEventToLocalCache(localStore,remoteEvent){var localStoreImpl=debugCast(localStore),remoteVersion=remoteEvent.snapshotVersion,newTargetDataByTargetMap=localStoreImpl.targetDataByTarget;return localStoreImpl.persistence.runTransaction("Apply remote event","readwrite-primary",function(txn){var documentBuffer=localStoreImpl.remoteDocuments.newChangeBuffer({trackRemovals:!0});newTargetDataByTargetMap=localStoreImpl.targetDataByTarget;var promises=[];remoteEvent.targetChanges.forEach(function(change,targetId){var oldTargetData=newTargetDataByTargetMap.get(targetId);if(oldTargetData){promises.push(localStoreImpl.targetCache.removeMatchingKeys(txn,change.removedDocuments,targetId).next(function(){return localStoreImpl.targetCache.addMatchingKeys(txn,change.addedDocuments,targetId)}));var resumeToken=change.resumeToken;if(resumeToken.approximateByteSize()>0){var newTargetData=oldTargetData.withResumeToken(resumeToken,remoteVersion).withSequenceNumber(txn.currentSequenceNumber);newTargetDataByTargetMap=newTargetDataByTargetMap.insert(targetId,newTargetData),function shouldPersistTargetData(oldTargetData,newTargetData,change){if(hardAssert(newTargetData.resumeToken.approximateByteSize()>0),0===oldTargetData.resumeToken.approximateByteSize())return!0;if(newTargetData.snapshotVersion.toMicroseconds()-oldTargetData.snapshotVersion.toMicroseconds()>=3e8)return!0;return change.addedDocuments.size+change.modifiedDocuments.size+change.removedDocuments.size>0}(oldTargetData,newTargetData,change)&&promises.push(localStoreImpl.targetCache.updateTargetData(txn,newTargetData))}}});var changedDocs=mutableDocumentMap();if(remoteEvent.documentUpdates.forEach(function(key,doc){remoteEvent.resolvedLimboDocuments.has(key)&&promises.push(localStoreImpl.persistence.referenceDelegate.updateLimboDocument(txn,key))}),promises.push(populateDocumentChangeBuffer(txn,documentBuffer,remoteEvent.documentUpdates,remoteVersion,void 0).next(function(result){changedDocs=result})),!remoteVersion.isEqual(SnapshotVersion.min())){var updateRemoteVersion=localStoreImpl.targetCache.getLastRemoteSnapshotVersion(txn).next(function(lastRemoteSnapshotVersion){return localStoreImpl.targetCache.setTargetsMetadata(txn,txn.currentSequenceNumber,remoteVersion)});promises.push(updateRemoteVersion)}return PersistencePromise.waitFor(promises).next(function(){return documentBuffer.apply(txn)}).next(function(){return localStoreImpl.localDocuments.applyLocalViewToDocuments(txn,changedDocs)}).next(function(){return changedDocs})}).then(function(changedDocs){return localStoreImpl.targetDataByTarget=newTargetDataByTargetMap,changedDocs})}function populateDocumentChangeBuffer(txn,documentBuffer,documents,globalVersion,documentVersions){var updatedKeys=documentKeySet();return documents.forEach(function(k){return updatedKeys=updatedKeys.add(k)}),documentBuffer.getEntries(txn,updatedKeys).next(function(existingDocs){var changedDocs=mutableDocumentMap();return documents.forEach(function(key,doc){var existingDoc=existingDocs.get(key),docReadTime=(null==documentVersions?void 0:documentVersions.get(key))||globalVersion;doc.isNoDocument()&&doc.version.isEqual(SnapshotVersion.min())?(documentBuffer.removeEntry(key,docReadTime),changedDocs=changedDocs.insert(key,doc)):!existingDoc.isValidDocument()||doc.version.compareTo(existingDoc.version)>0||0===doc.version.compareTo(existingDoc.version)&&existingDoc.hasPendingWrites?(documentBuffer.addEntry(doc,docReadTime),changedDocs=changedDocs.insert(key,doc)):logDebug("LocalStore","Ignoring outdated watch update for ",key,". Current version:",existingDoc.version," Watch version:",doc.version)}),changedDocs})}function localStoreNotifyLocalViewChanges(localStore,viewChanges){return tslib.__awaiter(this,void 0,void 0,function(){var localStoreImpl,e_2,_i,viewChanges_1,viewChange,targetId,targetData,lastLimboFreeSnapshotVersion,updatedTargetData;return tslib.__generator(this,function(_d){switch(_d.label){case 0:localStoreImpl=debugCast(localStore),_d.label=1;case 1:return _d.trys.push([1,3,,4]),[4,localStoreImpl.persistence.runTransaction("notifyLocalViewChanges","readwrite",function(txn){return PersistencePromise.forEach(viewChanges,function(viewChange){return PersistencePromise.forEach(viewChange.addedKeys,function(key){return localStoreImpl.persistence.referenceDelegate.addReference(txn,viewChange.targetId,key)}).next(function(){return PersistencePromise.forEach(viewChange.removedKeys,function(key){return localStoreImpl.persistence.referenceDelegate.removeReference(txn,viewChange.targetId,key)})})})})];case 2:return _d.sent(),[3,4];case 3:if(!isIndexedDbTransactionError(e_2=_d.sent()))throw e_2;return logDebug("LocalStore","Failed to update sequence numbers: "+e_2),[3,4];case 4:for(_i=0,viewChanges_1=viewChanges;_i<viewChanges_1.length;_i++)viewChange=viewChanges_1[_i],targetId=viewChange.targetId,viewChange.fromCache||(targetData=localStoreImpl.targetDataByTarget.get(targetId),lastLimboFreeSnapshotVersion=targetData.snapshotVersion,updatedTargetData=targetData.withLastLimboFreeSnapshotVersion(lastLimboFreeSnapshotVersion),localStoreImpl.targetDataByTarget=localStoreImpl.targetDataByTarget.insert(targetId,updatedTargetData));return[2]}})})}function localStoreReadDocument(localStore,key){var localStoreImpl=debugCast(localStore);return localStoreImpl.persistence.runTransaction("read document","readonly",function(txn){return localStoreImpl.localDocuments.getDocument(txn,key)})}function localStoreAllocateTarget(localStore,target){var localStoreImpl=debugCast(localStore);return localStoreImpl.persistence.runTransaction("Allocate target","readwrite",function(txn){var targetData;return localStoreImpl.targetCache.getTargetData(txn,target).next(function(cached){return cached?(targetData=cached,PersistencePromise.resolve(targetData)):localStoreImpl.targetCache.allocateTargetId(txn).next(function(targetId){return targetData=new TargetData(target,targetId,0,txn.currentSequenceNumber),localStoreImpl.targetCache.addTargetData(txn,targetData).next(function(){return targetData})})})}).then(function(targetData){var cachedTargetData=localStoreImpl.targetDataByTarget.get(targetData.targetId);return(null===cachedTargetData||targetData.snapshotVersion.compareTo(cachedTargetData.snapshotVersion)>0)&&(localStoreImpl.targetDataByTarget=localStoreImpl.targetDataByTarget.insert(targetData.targetId,targetData),localStoreImpl.targetIdByTarget.set(target,targetData.targetId)),targetData})}function localStoreReleaseTarget(localStore,targetId,keepPersistedTargetData){return tslib.__awaiter(this,void 0,void 0,function(){var localStoreImpl,targetData,mode,e_3;return tslib.__generator(this,function(_d){switch(_d.label){case 0:localStoreImpl=debugCast(localStore),targetData=localStoreImpl.targetDataByTarget.get(targetId),mode=keepPersistedTargetData?"readwrite":"readwrite-primary",_d.label=1;case 1:return _d.trys.push([1,4,,5]),keepPersistedTargetData?[3,3]:[4,localStoreImpl.persistence.runTransaction("Release target",mode,function(txn){return localStoreImpl.persistence.referenceDelegate.removeTarget(txn,targetData)})];case 2:_d.sent(),_d.label=3;case 3:return[3,5];case 4:if(!isIndexedDbTransactionError(e_3=_d.sent()))throw e_3;return logDebug("LocalStore","Failed to update sequence numbers for target "+targetId+": "+e_3),[3,5];case 5:return localStoreImpl.targetDataByTarget=localStoreImpl.targetDataByTarget.remove(targetId),localStoreImpl.targetIdByTarget.delete(targetData.target),[2]}})})}function localStoreExecuteQuery(localStore,query,usePreviousResults){var localStoreImpl=debugCast(localStore),lastLimboFreeSnapshotVersion=SnapshotVersion.min(),remoteKeys=documentKeySet();return localStoreImpl.persistence.runTransaction("Execute query","readonly",function(txn){return function localStoreGetTargetData(localStore,transaction,target){var localStoreImpl=debugCast(localStore),targetId=localStoreImpl.targetIdByTarget.get(target);return void 0!==targetId?PersistencePromise.resolve(localStoreImpl.targetDataByTarget.get(targetId)):localStoreImpl.targetCache.getTargetData(transaction,target)}(localStoreImpl,txn,queryToTarget(query)).next(function(targetData){if(targetData)return lastLimboFreeSnapshotVersion=targetData.lastLimboFreeSnapshotVersion,localStoreImpl.targetCache.getMatchingKeysForTargetId(txn,targetData.targetId).next(function(result){remoteKeys=result})}).next(function(){return localStoreImpl.queryEngine.getDocumentsMatchingQuery(txn,query,usePreviousResults?lastLimboFreeSnapshotVersion:SnapshotVersion.min(),usePreviousResults?remoteKeys:documentKeySet())}).next(function(documents){return{documents:documents,remoteKeys:remoteKeys}})})}function localStoreLookupMutationDocuments(localStore,batchId){var localStoreImpl=debugCast(localStore),mutationQueueImpl=debugCast(localStoreImpl.mutationQueue);return localStoreImpl.persistence.runTransaction("Lookup mutation documents","readonly",function(txn){return mutationQueueImpl.lookupMutationKeys(txn,batchId).next(function(keys){return keys?localStoreImpl.localDocuments.getDocuments(txn,keys):PersistencePromise.resolve(null)})})}function localStoreGetCachedTarget(localStore,targetId){var localStoreImpl=debugCast(localStore),targetCacheImpl=debugCast(localStoreImpl.targetCache),cachedTargetData=localStoreImpl.targetDataByTarget.get(targetId);return cachedTargetData?Promise.resolve(cachedTargetData.target):localStoreImpl.persistence.runTransaction("Get target data","readonly",function(txn){return targetCacheImpl.getTargetDataForTarget(txn,targetId).next(function(targetData){return targetData?targetData.target:null})})}function localStoreGetNewDocumentChanges(localStore){var localStoreImpl=debugCast(localStore);return localStoreImpl.persistence.runTransaction("Get new document changes","readonly",function(txn){return function remoteDocumentCacheGetNewDocumentChanges(remoteDocumentCache,transaction,sinceReadTime){var remoteDocumentCacheImpl=debugCast(remoteDocumentCache),changedDocs=mutableDocumentMap(),lastReadTime=toDbTimestampKey(sinceReadTime),documentsStore=remoteDocumentsStore(transaction),range=IDBKeyRange.lowerBound(lastReadTime,!0);return documentsStore.iterate({index:DbRemoteDocument.readTimeIndex,range:range},function(_,dbRemoteDoc){var doc=fromDbRemoteDocument(remoteDocumentCacheImpl.serializer,dbRemoteDoc);changedDocs=changedDocs.insert(doc.key,doc),lastReadTime=dbRemoteDoc.readTime}).next(function(){return{changedDocs:changedDocs,readTime:fromDbTimestampKey(lastReadTime)}})}(localStoreImpl.remoteDocuments,txn,localStoreImpl.lastDocumentChangeReadTime)}).then(function(_d){var changedDocs=_d.changedDocs,readTime=_d.readTime;return localStoreImpl.lastDocumentChangeReadTime=readTime,changedDocs})}function localStoreSynchronizeLastDocumentChangeReadTime(localStore){return tslib.__awaiter(this,void 0,void 0,function(){var localStoreImpl;return tslib.__generator(this,function(_d){return[2,(localStoreImpl=debugCast(localStore)).persistence.runTransaction("Synchronize last document change read time","readonly",function(txn){return function remoteDocumentCacheGetLastReadTime(transaction){var documentsStore=remoteDocumentsStore(transaction),readTime=SnapshotVersion.min();return documentsStore.iterate({index:DbRemoteDocument.readTimeIndex,reverse:!0},function(key,dbRemoteDoc,control){dbRemoteDoc.readTime&&(readTime=fromDbTimestampKey(dbRemoteDoc.readTime)),control.done()}).next(function(){return readTime})}(txn)}).then(function(readTime){localStoreImpl.lastDocumentChangeReadTime=readTime})]})})}function umbrellaTarget(bundleName){return queryToTarget(newQueryForPath(ResourcePath.fromString("__bundle__/docs/"+bundleName)))}function localStoreApplyBundledDocuments(localStore,bundleConverter,documents,bundleName){return tslib.__awaiter(this,void 0,void 0,function(){var localStoreImpl,documentKeys,documentMap,versionMap,_i,documents_1,bundleDoc,documentKey,documentBuffer,umbrellaTargetData;return tslib.__generator(this,function(_d){switch(_d.label){case 0:for(localStoreImpl=debugCast(localStore),documentKeys=documentKeySet(),documentMap=mutableDocumentMap(),versionMap=documentVersionMap(),_i=0,documents_1=documents;_i<documents_1.length;_i++)bundleDoc=documents_1[_i],documentKey=bundleConverter.toDocumentKey(bundleDoc.metadata.name),bundleDoc.document&&(documentKeys=documentKeys.add(documentKey)),documentMap=documentMap.insert(documentKey,bundleConverter.toMutableDocument(bundleDoc)),versionMap=versionMap.insert(documentKey,bundleConverter.toSnapshotVersion(bundleDoc.metadata.readTime));return documentBuffer=localStoreImpl.remoteDocuments.newChangeBuffer({trackRemovals:!0}),[4,localStoreAllocateTarget(localStoreImpl,umbrellaTarget(bundleName))];case 1:return umbrellaTargetData=_d.sent(),[2,localStoreImpl.persistence.runTransaction("Apply bundle documents","readwrite",function(txn){return populateDocumentChangeBuffer(txn,documentBuffer,documentMap,SnapshotVersion.min(),versionMap).next(function(changedDocs){return documentBuffer.apply(txn),changedDocs}).next(function(changedDocs){return localStoreImpl.targetCache.removeMatchingKeysForTargetId(txn,umbrellaTargetData.targetId).next(function(){return localStoreImpl.targetCache.addMatchingKeys(txn,documentKeys,umbrellaTargetData.targetId)}).next(function(){return localStoreImpl.localDocuments.applyLocalViewToDocuments(txn,changedDocs)}).next(function(){return changedDocs})})})]}})})}function localStoreHasNewerBundle(localStore,bundleMetadata){var localStoreImpl=debugCast(localStore),currentReadTime=fromVersion(bundleMetadata.createTime);return localStoreImpl.persistence.runTransaction("hasNewerBundle","readonly",function(transaction){return localStoreImpl.bundleCache.getBundleMetadata(transaction,bundleMetadata.id)}).then(function(cached){return!!cached&&cached.createTime.compareTo(currentReadTime)>=0})}function localStoreSaveBundle(localStore,bundleMetadata){var localStoreImpl=debugCast(localStore);return localStoreImpl.persistence.runTransaction("Save bundle","readwrite",function(transaction){return localStoreImpl.bundleCache.saveBundleMetadata(transaction,bundleMetadata)})}function localStoreGetNamedQuery(localStore,queryName){var localStoreImpl=debugCast(localStore);return localStoreImpl.persistence.runTransaction("Get named query","readonly",function(transaction){return localStoreImpl.bundleCache.getNamedQuery(transaction,queryName)})}function localStoreSaveNamedQuery(localStore,query,documents){return void 0===documents&&(documents=documentKeySet()),tslib.__awaiter(this,void 0,void 0,function(){var allocated,localStoreImpl;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,localStoreAllocateTarget(localStore,queryToTarget(fromBundledQuery(query.bundledQuery)))];case 1:return allocated=_d.sent(),[2,(localStoreImpl=debugCast(localStore)).persistence.runTransaction("Save named query","readwrite",function(transaction){var readTime=fromVersion(query.readTime);if(allocated.snapshotVersion.compareTo(readTime)>=0)return localStoreImpl.bundleCache.saveNamedQuery(transaction,query);var newTargetData=allocated.withResumeToken(ByteString.EMPTY_BYTE_STRING,readTime);return localStoreImpl.targetDataByTarget=localStoreImpl.targetDataByTarget.insert(newTargetData.targetId,newTargetData),localStoreImpl.targetCache.updateTargetData(transaction,newTargetData).next(function(){return localStoreImpl.targetCache.removeMatchingKeysForTargetId(transaction,allocated.targetId)}).next(function(){return localStoreImpl.targetCache.addMatchingKeys(transaction,documents,allocated.targetId)}).next(function(){return localStoreImpl.bundleCache.saveNamedQuery(transaction,query)})})]}})})}var MemoryBundleCache=function(){function MemoryBundleCache(serializer){this.serializer=serializer,this.bundles=new Map,this.namedQueries=new Map}return MemoryBundleCache.prototype.getBundleMetadata=function(transaction,bundleId){return PersistencePromise.resolve(this.bundles.get(bundleId))},MemoryBundleCache.prototype.saveBundleMetadata=function(transaction,bundleMetadata){return this.bundles.set(bundleMetadata.id,function fromBundleMetadata(metadata){return{id:metadata.id,version:metadata.version,createTime:fromVersion(metadata.createTime)}}(bundleMetadata)),PersistencePromise.resolve()},MemoryBundleCache.prototype.getNamedQuery=function(transaction,queryName){return PersistencePromise.resolve(this.namedQueries.get(queryName))},MemoryBundleCache.prototype.saveNamedQuery=function(transaction,query){return this.namedQueries.set(query.name,function fromProtoNamedQuery(namedQuery){return{name:namedQuery.name,query:fromBundledQuery(namedQuery.bundledQuery),readTime:fromVersion(namedQuery.readTime)}}(query)),PersistencePromise.resolve()},MemoryBundleCache}(),ReferenceSet=function(){function ReferenceSet(){this.refsByKey=new SortedSet(DocReference.compareByKey),this.refsByTarget=new SortedSet(DocReference.compareByTargetId)}return ReferenceSet.prototype.isEmpty=function(){return this.refsByKey.isEmpty()},ReferenceSet.prototype.addReference=function(key,id){var ref=new DocReference(key,id);this.refsByKey=this.refsByKey.add(ref),this.refsByTarget=this.refsByTarget.add(ref)},ReferenceSet.prototype.addReferences=function(keys,id){var _this=this;keys.forEach(function(key){return _this.addReference(key,id)})},ReferenceSet.prototype.removeReference=function(key,id){this.removeRef(new DocReference(key,id))},ReferenceSet.prototype.removeReferences=function(keys,id){var _this=this;keys.forEach(function(key){return _this.removeReference(key,id)})},ReferenceSet.prototype.removeReferencesForId=function(id){var _this=this,emptyKey=new DocumentKey(new ResourcePath([])),startRef=new DocReference(emptyKey,id),endRef=new DocReference(emptyKey,id+1),keys=[];return this.refsByTarget.forEachInRange([startRef,endRef],function(ref){_this.removeRef(ref),keys.push(ref.key)}),keys},ReferenceSet.prototype.removeAllReferences=function(){var _this=this;this.refsByKey.forEach(function(ref){return _this.removeRef(ref)})},ReferenceSet.prototype.removeRef=function(ref){this.refsByKey=this.refsByKey.delete(ref),this.refsByTarget=this.refsByTarget.delete(ref)},ReferenceSet.prototype.referencesForId=function(id){var emptyKey=new DocumentKey(new ResourcePath([])),startRef=new DocReference(emptyKey,id),endRef=new DocReference(emptyKey,id+1),keys=documentKeySet();return this.refsByTarget.forEachInRange([startRef,endRef],function(ref){keys=keys.add(ref.key)}),keys},ReferenceSet.prototype.containsKey=function(key){var ref=new DocReference(key,0),firstRef=this.refsByKey.firstAfterOrEqual(ref);return null!==firstRef&&key.isEqual(firstRef.key)},ReferenceSet}(),DocReference=function(){function DocReference(key,targetOrBatchId){this.key=key,this.targetOrBatchId=targetOrBatchId}return DocReference.compareByKey=function(left,right){return DocumentKey.comparator(left.key,right.key)||primitiveComparator(left.targetOrBatchId,right.targetOrBatchId)},DocReference.compareByTargetId=function(left,right){return primitiveComparator(left.targetOrBatchId,right.targetOrBatchId)||DocumentKey.comparator(left.key,right.key)},DocReference}(),MemoryMutationQueue=function(){function MemoryMutationQueue(indexManager,referenceDelegate){this.indexManager=indexManager,this.referenceDelegate=referenceDelegate,this.mutationQueue=[],this.nextBatchId=1,this.batchesByDocumentKey=new SortedSet(DocReference.compareByKey)}return MemoryMutationQueue.prototype.checkEmpty=function(transaction){return PersistencePromise.resolve(0===this.mutationQueue.length)},MemoryMutationQueue.prototype.addMutationBatch=function(transaction,localWriteTime,baseMutations,mutations){var batchId=this.nextBatchId;this.nextBatchId++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];var batch=new MutationBatch(batchId,localWriteTime,baseMutations,mutations);this.mutationQueue.push(batch);for(var _i=0,mutations_3=mutations;_i<mutations_3.length;_i++){var mutation=mutations_3[_i];this.batchesByDocumentKey=this.batchesByDocumentKey.add(new DocReference(mutation.key,batchId)),this.indexManager.addToCollectionParentIndex(transaction,mutation.key.path.popLast())}return PersistencePromise.resolve(batch)},MemoryMutationQueue.prototype.lookupMutationBatch=function(transaction,batchId){return PersistencePromise.resolve(this.findMutationBatch(batchId))},MemoryMutationQueue.prototype.getNextMutationBatchAfterBatchId=function(transaction,batchId){var nextBatchId=batchId+1,rawIndex=this.indexOfBatchId(nextBatchId),index=rawIndex<0?0:rawIndex;return PersistencePromise.resolve(this.mutationQueue.length>index?this.mutationQueue[index]:null)},MemoryMutationQueue.prototype.getHighestUnacknowledgedBatchId=function(){return PersistencePromise.resolve(0===this.mutationQueue.length?-1:this.nextBatchId-1)},MemoryMutationQueue.prototype.getAllMutationBatches=function(transaction){return PersistencePromise.resolve(this.mutationQueue.slice())},MemoryMutationQueue.prototype.getAllMutationBatchesAffectingDocumentKey=function(transaction,documentKey){var _this=this,start=new DocReference(documentKey,0),end=new DocReference(documentKey,Number.POSITIVE_INFINITY),result=[];return this.batchesByDocumentKey.forEachInRange([start,end],function(ref){var batch=_this.findMutationBatch(ref.targetOrBatchId);result.push(batch)}),PersistencePromise.resolve(result)},MemoryMutationQueue.prototype.getAllMutationBatchesAffectingDocumentKeys=function(transaction,documentKeys){var _this=this,uniqueBatchIDs=new SortedSet(primitiveComparator);return documentKeys.forEach(function(documentKey){var start=new DocReference(documentKey,0),end=new DocReference(documentKey,Number.POSITIVE_INFINITY);_this.batchesByDocumentKey.forEachInRange([start,end],function(ref){uniqueBatchIDs=uniqueBatchIDs.add(ref.targetOrBatchId)})}),PersistencePromise.resolve(this.findMutationBatches(uniqueBatchIDs))},MemoryMutationQueue.prototype.getAllMutationBatchesAffectingQuery=function(transaction,query){var prefix=query.path,immediateChildrenPathLength=prefix.length+1,startPath=prefix;DocumentKey.isDocumentKey(startPath)||(startPath=startPath.child(""));var start=new DocReference(new DocumentKey(startPath),0),uniqueBatchIDs=new SortedSet(primitiveComparator);return this.batchesByDocumentKey.forEachWhile(function(ref){var rowKeyPath=ref.key.path;return!!prefix.isPrefixOf(rowKeyPath)&&(rowKeyPath.length===immediateChildrenPathLength&&(uniqueBatchIDs=uniqueBatchIDs.add(ref.targetOrBatchId)),!0)},start),PersistencePromise.resolve(this.findMutationBatches(uniqueBatchIDs))},MemoryMutationQueue.prototype.findMutationBatches=function(batchIDs){var _this=this,result=[];return batchIDs.forEach(function(batchId){var batch=_this.findMutationBatch(batchId);null!==batch&&result.push(batch)}),result},MemoryMutationQueue.prototype.removeMutationBatch=function(transaction,batch){var _this=this;hardAssert(0===this.indexOfExistingBatchId(batch.batchId,"removed")),this.mutationQueue.shift();var references=this.batchesByDocumentKey;return PersistencePromise.forEach(batch.mutations,function(mutation){var ref=new DocReference(mutation.key,batch.batchId);return references=references.delete(ref),_this.referenceDelegate.markPotentiallyOrphaned(transaction,mutation.key)}).next(function(){_this.batchesByDocumentKey=references})},MemoryMutationQueue.prototype.removeCachedMutationKeys=function(batchId){},MemoryMutationQueue.prototype.containsKey=function(txn,key){var ref=new DocReference(key,0),firstRef=this.batchesByDocumentKey.firstAfterOrEqual(ref);return PersistencePromise.resolve(key.isEqual(firstRef&&firstRef.key))},MemoryMutationQueue.prototype.performConsistencyCheck=function(txn){return this.mutationQueue.length,PersistencePromise.resolve()},MemoryMutationQueue.prototype.indexOfExistingBatchId=function(batchId,action){return this.indexOfBatchId(batchId)},MemoryMutationQueue.prototype.indexOfBatchId=function(batchId){return 0===this.mutationQueue.length?0:batchId-this.mutationQueue[0].batchId},MemoryMutationQueue.prototype.findMutationBatch=function(batchId){var index=this.indexOfBatchId(batchId);return index<0||index>=this.mutationQueue.length?null:this.mutationQueue[index]},MemoryMutationQueue}();var MemoryRemoteDocumentCacheImpl=function(){function MemoryRemoteDocumentCacheImpl(indexManager,sizer){this.indexManager=indexManager,this.sizer=sizer,this.docs=function documentEntryMap(){return new SortedMap(DocumentKey.comparator)}(),this.size=0}return MemoryRemoteDocumentCacheImpl.prototype.addEntry=function(transaction,doc,readTime){var key=doc.key,entry=this.docs.get(key),previousSize=entry?entry.size:0,currentSize=this.sizer(doc);return this.docs=this.docs.insert(key,{document:doc.clone(),size:currentSize,readTime:readTime}),this.size+=currentSize-previousSize,this.indexManager.addToCollectionParentIndex(transaction,key.path.popLast())},MemoryRemoteDocumentCacheImpl.prototype.removeEntry=function(documentKey){var entry=this.docs.get(documentKey);entry&&(this.docs=this.docs.remove(documentKey),this.size-=entry.size)},MemoryRemoteDocumentCacheImpl.prototype.getEntry=function(transaction,documentKey){var entry=this.docs.get(documentKey);return PersistencePromise.resolve(entry?entry.document.clone():MutableDocument.newInvalidDocument(documentKey))},MemoryRemoteDocumentCacheImpl.prototype.getEntries=function(transaction,documentKeys){var _this=this,results=mutableDocumentMap();return documentKeys.forEach(function(documentKey){var entry=_this.docs.get(documentKey);results=results.insert(documentKey,entry?entry.document.clone():MutableDocument.newInvalidDocument(documentKey))}),PersistencePromise.resolve(results)},MemoryRemoteDocumentCacheImpl.prototype.getDocumentsMatchingQuery=function(transaction,query,sinceReadTime){for(var results=mutableDocumentMap(),prefix=new DocumentKey(query.path.child("")),iterator=this.docs.getIteratorFrom(prefix);iterator.hasNext();){var _d=iterator.getNext(),key=_d.key,_e=_d.value,document_3=_e.document,readTime=_e.readTime;if(!query.path.isPrefixOf(key.path))break;readTime.compareTo(sinceReadTime)<=0||queryMatches(query,document_3)&&(results=results.insert(document_3.key,document_3.clone()))}return PersistencePromise.resolve(results)},MemoryRemoteDocumentCacheImpl.prototype.forEachDocumentKey=function(transaction,f){return PersistencePromise.forEach(this.docs,function(key){return f(key)})},MemoryRemoteDocumentCacheImpl.prototype.newChangeBuffer=function(options){return new MemoryRemoteDocumentChangeBuffer(this)},MemoryRemoteDocumentCacheImpl.prototype.getSize=function(txn){return PersistencePromise.resolve(this.size)},MemoryRemoteDocumentCacheImpl}();var MemoryRemoteDocumentChangeBuffer=function(_super){function MemoryRemoteDocumentChangeBuffer(documentCache){var _this=_super.call(this)||this;return _this.documentCache=documentCache,_this}return tslib.__extends(MemoryRemoteDocumentChangeBuffer,_super),MemoryRemoteDocumentChangeBuffer.prototype.applyChanges=function(transaction){var _this=this,promises=[];return this.changes.forEach(function(key,doc){doc.document.isValidDocument()?promises.push(_this.documentCache.addEntry(transaction,doc.document,_this.getReadTime(key))):_this.documentCache.removeEntry(key)}),PersistencePromise.waitFor(promises)},MemoryRemoteDocumentChangeBuffer.prototype.getFromCache=function(transaction,documentKey){return this.documentCache.getEntry(transaction,documentKey)},MemoryRemoteDocumentChangeBuffer.prototype.getAllFromCache=function(transaction,documentKeys){return this.documentCache.getEntries(transaction,documentKeys)},MemoryRemoteDocumentChangeBuffer}(RemoteDocumentChangeBuffer),MemoryTargetCache=function(){function MemoryTargetCache(persistence){this.persistence=persistence,this.targets=new ObjectMap(function(t){return canonifyTarget(t)},targetEquals),this.lastRemoteSnapshotVersion=SnapshotVersion.min(),this.highestTargetId=0,this.highestSequenceNumber=0,this.references=new ReferenceSet,this.targetCount=0,this.targetIdGenerator=TargetIdGenerator.forTargetCache()}return MemoryTargetCache.prototype.forEachTarget=function(txn,f){return this.targets.forEach(function(_,targetData){return f(targetData)}),PersistencePromise.resolve()},MemoryTargetCache.prototype.getLastRemoteSnapshotVersion=function(transaction){return PersistencePromise.resolve(this.lastRemoteSnapshotVersion)},MemoryTargetCache.prototype.getHighestSequenceNumber=function(transaction){return PersistencePromise.resolve(this.highestSequenceNumber)},MemoryTargetCache.prototype.allocateTargetId=function(transaction){return this.highestTargetId=this.targetIdGenerator.next(),PersistencePromise.resolve(this.highestTargetId)},MemoryTargetCache.prototype.setTargetsMetadata=function(transaction,highestListenSequenceNumber,lastRemoteSnapshotVersion){return lastRemoteSnapshotVersion&&(this.lastRemoteSnapshotVersion=lastRemoteSnapshotVersion),highestListenSequenceNumber>this.highestSequenceNumber&&(this.highestSequenceNumber=highestListenSequenceNumber),PersistencePromise.resolve()},MemoryTargetCache.prototype.saveTargetData=function(targetData){this.targets.set(targetData.target,targetData);var targetId=targetData.targetId;targetId>this.highestTargetId&&(this.targetIdGenerator=new TargetIdGenerator(targetId),this.highestTargetId=targetId),targetData.sequenceNumber>this.highestSequenceNumber&&(this.highestSequenceNumber=targetData.sequenceNumber)},MemoryTargetCache.prototype.addTargetData=function(transaction,targetData){return this.saveTargetData(targetData),this.targetCount+=1,PersistencePromise.resolve()},MemoryTargetCache.prototype.updateTargetData=function(transaction,targetData){return this.saveTargetData(targetData),PersistencePromise.resolve()},MemoryTargetCache.prototype.removeTargetData=function(transaction,targetData){return this.targets.delete(targetData.target),this.references.removeReferencesForId(targetData.targetId),this.targetCount-=1,PersistencePromise.resolve()},MemoryTargetCache.prototype.removeTargets=function(transaction,upperBound,activeTargetIds){var _this=this,count=0,removals=[];return this.targets.forEach(function(key,targetData){targetData.sequenceNumber<=upperBound&&null===activeTargetIds.get(targetData.targetId)&&(_this.targets.delete(key),removals.push(_this.removeMatchingKeysForTargetId(transaction,targetData.targetId)),count++)}),PersistencePromise.waitFor(removals).next(function(){return count})},MemoryTargetCache.prototype.getTargetCount=function(transaction){return PersistencePromise.resolve(this.targetCount)},MemoryTargetCache.prototype.getTargetData=function(transaction,target){var targetData=this.targets.get(target)||null;return PersistencePromise.resolve(targetData)},MemoryTargetCache.prototype.addMatchingKeys=function(txn,keys,targetId){return this.references.addReferences(keys,targetId),PersistencePromise.resolve()},MemoryTargetCache.prototype.removeMatchingKeys=function(txn,keys,targetId){this.references.removeReferences(keys,targetId);var referenceDelegate=this.persistence.referenceDelegate,promises=[];return referenceDelegate&&keys.forEach(function(key){promises.push(referenceDelegate.markPotentiallyOrphaned(txn,key))}),PersistencePromise.waitFor(promises)},MemoryTargetCache.prototype.removeMatchingKeysForTargetId=function(txn,targetId){return this.references.removeReferencesForId(targetId),PersistencePromise.resolve()},MemoryTargetCache.prototype.getMatchingKeysForTargetId=function(txn,targetId){var matchingKeys=this.references.referencesForId(targetId);return PersistencePromise.resolve(matchingKeys)},MemoryTargetCache.prototype.containsKey=function(txn,key){return PersistencePromise.resolve(this.references.containsKey(key))},MemoryTargetCache}(),MemoryPersistence=function(){function MemoryPersistence(referenceDelegateFactory,serializer){var _this=this;this.mutationQueues={},this.listenSequence=new ListenSequence(0),this._started=!1,this._started=!0,this.referenceDelegate=referenceDelegateFactory(this),this.targetCache=new MemoryTargetCache(this);this.indexManager=new MemoryIndexManager,this.remoteDocumentCache=function newMemoryRemoteDocumentCache(indexManager,sizer){return new MemoryRemoteDocumentCacheImpl(indexManager,sizer)}(this.indexManager,function(doc){return _this.referenceDelegate.documentSize(doc)}),this.serializer=new LocalSerializer(serializer),this.bundleCache=new MemoryBundleCache(this.serializer)}return MemoryPersistence.prototype.start=function(){return Promise.resolve()},MemoryPersistence.prototype.shutdown=function(){return this._started=!1,Promise.resolve()},Object.defineProperty(MemoryPersistence.prototype,"started",{get:function(){return this._started},enumerable:!1,configurable:!0}),MemoryPersistence.prototype.setDatabaseDeletedListener=function(){},MemoryPersistence.prototype.setNetworkEnabled=function(){},MemoryPersistence.prototype.getIndexManager=function(){return this.indexManager},MemoryPersistence.prototype.getMutationQueue=function(user){var queue=this.mutationQueues[user.toKey()];return queue||(queue=new MemoryMutationQueue(this.indexManager,this.referenceDelegate),this.mutationQueues[user.toKey()]=queue),queue},MemoryPersistence.prototype.getTargetCache=function(){return this.targetCache},MemoryPersistence.prototype.getRemoteDocumentCache=function(){return this.remoteDocumentCache},MemoryPersistence.prototype.getBundleCache=function(){return this.bundleCache},MemoryPersistence.prototype.runTransaction=function(action,mode,transactionOperation){var _this=this;logDebug("MemoryPersistence","Starting transaction:",action);var txn=new MemoryTransaction(this.listenSequence.next());return this.referenceDelegate.onTransactionStarted(),transactionOperation(txn).next(function(result){return _this.referenceDelegate.onTransactionCommitted(txn).next(function(){return result})}).toPromise().then(function(result){return txn.raiseOnCommittedEvent(),result})},MemoryPersistence.prototype.mutationQueuesContainKey=function(transaction,key){return PersistencePromise.or(Object.values(this.mutationQueues).map(function(queue){return function(){return queue.containsKey(transaction,key)}}))},MemoryPersistence}(),MemoryTransaction=function(_super){function MemoryTransaction(currentSequenceNumber){var _this=_super.call(this)||this;return _this.currentSequenceNumber=currentSequenceNumber,_this}return tslib.__extends(MemoryTransaction,_super),MemoryTransaction}(PersistenceTransaction),MemoryEagerDelegate=function(){function MemoryEagerDelegate(persistence){this.persistence=persistence,this.localViewReferences=new ReferenceSet,this._orphanedDocuments=null}return MemoryEagerDelegate.factory=function(persistence){return new MemoryEagerDelegate(persistence)},Object.defineProperty(MemoryEagerDelegate.prototype,"orphanedDocuments",{get:function(){if(this._orphanedDocuments)return this._orphanedDocuments;throw fail()},enumerable:!1,configurable:!0}),MemoryEagerDelegate.prototype.addReference=function(txn,targetId,key){return this.localViewReferences.addReference(key,targetId),this.orphanedDocuments.delete(key.toString()),PersistencePromise.resolve()},MemoryEagerDelegate.prototype.removeReference=function(txn,targetId,key){return this.localViewReferences.removeReference(key,targetId),this.orphanedDocuments.add(key.toString()),PersistencePromise.resolve()},MemoryEagerDelegate.prototype.markPotentiallyOrphaned=function(txn,key){return this.orphanedDocuments.add(key.toString()),PersistencePromise.resolve()},MemoryEagerDelegate.prototype.removeTarget=function(txn,targetData){var _this=this;this.localViewReferences.removeReferencesForId(targetData.targetId).forEach(function(key){return _this.orphanedDocuments.add(key.toString())});var cache=this.persistence.getTargetCache();return cache.getMatchingKeysForTargetId(txn,targetData.targetId).next(function(keys){keys.forEach(function(key){return _this.orphanedDocuments.add(key.toString())})}).next(function(){return cache.removeTargetData(txn,targetData)})},MemoryEagerDelegate.prototype.onTransactionStarted=function(){this._orphanedDocuments=new Set},MemoryEagerDelegate.prototype.onTransactionCommitted=function(txn){var _this=this,changeBuffer=this.persistence.getRemoteDocumentCache().newChangeBuffer();return PersistencePromise.forEach(this.orphanedDocuments,function(path){var key=DocumentKey.fromPath(path);return _this.isReferenced(txn,key).next(function(isReferenced){isReferenced||changeBuffer.removeEntry(key)})}).next(function(){return _this._orphanedDocuments=null,changeBuffer.apply(txn)})},MemoryEagerDelegate.prototype.updateLimboDocument=function(txn,key){var _this=this;return this.isReferenced(txn,key).next(function(isReferenced){isReferenced?_this.orphanedDocuments.delete(key.toString()):_this.orphanedDocuments.add(key.toString())})},MemoryEagerDelegate.prototype.documentSize=function(doc){return 0},MemoryEagerDelegate.prototype.isReferenced=function(txn,key){var _this=this;return PersistencePromise.or([function(){return PersistencePromise.resolve(_this.localViewReferences.containsKey(key))},function(){return _this.persistence.getTargetCache().containsKey(txn,key)},function(){return _this.persistence.mutationQueuesContainKey(txn,key)}])},MemoryEagerDelegate}(),QueryEngine=function(){function QueryEngine(){}return QueryEngine.prototype.setLocalDocumentsView=function(localDocuments){this.localDocumentsView=localDocuments},QueryEngine.prototype.getDocumentsMatchingQuery=function(transaction,query,lastLimboFreeSnapshotVersion,remoteKeys){var _this=this;return function matchesAllDocuments(query){return 0===query.filters.length&&null===query.limit&&null==query.startAt&&null==query.endAt&&(0===query.explicitOrderBy.length||1===query.explicitOrderBy.length&&query.explicitOrderBy[0].field.isKeyField())}(query)||lastLimboFreeSnapshotVersion.isEqual(SnapshotVersion.min())?this.executeFullCollectionScan(transaction,query):this.localDocumentsView.getDocuments(transaction,remoteKeys).next(function(documents){var previousResults=_this.applyQuery(query,documents);return(hasLimitToFirst(query)||hasLimitToLast(query))&&_this.needsRefill(query.limitType,previousResults,remoteKeys,lastLimboFreeSnapshotVersion)?_this.executeFullCollectionScan(transaction,query):(getLogLevel()<=logger.LogLevel.DEBUG&&logDebug("QueryEngine","Re-using previous result from %s to execute query: %s",lastLimboFreeSnapshotVersion.toString(),stringifyQuery(query)),_this.localDocumentsView.getDocumentsMatchingQuery(transaction,query,lastLimboFreeSnapshotVersion).next(function(updatedResults){return previousResults.forEach(function(doc){updatedResults=updatedResults.insert(doc.key,doc)}),updatedResults}))})},QueryEngine.prototype.applyQuery=function(query,documents){var queryResults=new SortedSet(newQueryComparator(query));return documents.forEach(function(_,maybeDoc){queryMatches(query,maybeDoc)&&(queryResults=queryResults.add(maybeDoc))}),queryResults},QueryEngine.prototype.needsRefill=function(limitType,sortedPreviousResults,remoteKeys,limboFreeSnapshotVersion){if(remoteKeys.size!==sortedPreviousResults.size)return!0;var docAtLimitEdge="F"===limitType?sortedPreviousResults.last():sortedPreviousResults.first();return!!docAtLimitEdge&&(docAtLimitEdge.hasPendingWrites||docAtLimitEdge.version.compareTo(limboFreeSnapshotVersion)>0)},QueryEngine.prototype.executeFullCollectionScan=function(transaction,query){return getLogLevel()<=logger.LogLevel.DEBUG&&logDebug("QueryEngine","Using full collection scan to execute query:",stringifyQuery(query)),this.localDocumentsView.getDocumentsMatchingQuery(transaction,query,SnapshotVersion.min())},QueryEngine}(),User=function(){function User(uid){this.uid=uid}return User.prototype.isAuthenticated=function(){return null!=this.uid},User.prototype.toKey=function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"},User.prototype.isEqual=function(otherUser){return otherUser.uid===this.uid},User}();User.UNAUTHENTICATED=new User(null),User.GOOGLE_CREDENTIALS=new User("google-credentials-uid"),User.FIRST_PARTY=new User("first-party-uid");function createWebStorageClientStateKey(persistenceKey,clientId){return"firestore_clients_"+persistenceKey+"_"+clientId}function createWebStorageMutationBatchKey(persistenceKey,user,batchId){var mutationKey="firestore_mutations_"+persistenceKey+"_"+batchId;return user.isAuthenticated()&&(mutationKey+="_"+user.uid),mutationKey}function createWebStorageQueryTargetMetadataKey(persistenceKey,targetId){return"firestore_targets_"+persistenceKey+"_"+targetId}var LOG_TAG$a="SharedClientState",MutationMetadata=function(){function MutationMetadata(user,batchId,state,error){this.user=user,this.batchId=batchId,this.state=state,this.error=error}return MutationMetadata.fromWebStorageEntry=function(user,batchId,value){var mutationBatch=JSON.parse(value),validData="object"==typeof mutationBatch&&-1!==["pending","acknowledged","rejected"].indexOf(mutationBatch.state)&&(void 0===mutationBatch.error||"object"==typeof mutationBatch.error),firestoreError=void 0;return validData&&mutationBatch.error&&(validData="string"==typeof mutationBatch.error.message&&"string"==typeof mutationBatch.error.code)&&(firestoreError=new FirestoreError(mutationBatch.error.code,mutationBatch.error.message)),validData?new MutationMetadata(user,batchId,mutationBatch.state,firestoreError):(logError(LOG_TAG$a,"Failed to parse mutation state for ID '"+batchId+"': "+value),null)},MutationMetadata.prototype.toWebStorageJSON=function(){var batchMetadata={state:this.state,updateTimeMs:Date.now()};return this.error&&(batchMetadata.error={code:this.error.code,message:this.error.message}),JSON.stringify(batchMetadata)},MutationMetadata}(),QueryTargetMetadata=function(){function QueryTargetMetadata(targetId,state,error){this.targetId=targetId,this.state=state,this.error=error}return QueryTargetMetadata.fromWebStorageEntry=function(targetId,value){var targetState=JSON.parse(value),validData="object"==typeof targetState&&-1!==["not-current","current","rejected"].indexOf(targetState.state)&&(void 0===targetState.error||"object"==typeof targetState.error),firestoreError=void 0;return validData&&targetState.error&&(validData="string"==typeof targetState.error.message&&"string"==typeof targetState.error.code)&&(firestoreError=new FirestoreError(targetState.error.code,targetState.error.message)),validData?new QueryTargetMetadata(targetId,targetState.state,firestoreError):(logError(LOG_TAG$a,"Failed to parse target state for ID '"+targetId+"': "+value),null)},QueryTargetMetadata.prototype.toWebStorageJSON=function(){var targetState={state:this.state,updateTimeMs:Date.now()};return this.error&&(targetState.error={code:this.error.code,message:this.error.message}),JSON.stringify(targetState)},QueryTargetMetadata}(),RemoteClientState=function(){function RemoteClientState(clientId,activeTargetIds){this.clientId=clientId,this.activeTargetIds=activeTargetIds}return RemoteClientState.fromWebStorageEntry=function(clientId,value){for(var clientState=JSON.parse(value),validData="object"==typeof clientState&&clientState.activeTargetIds instanceof Array,activeTargetIdsSet=targetIdSet(),i=0;validData&&i<clientState.activeTargetIds.length;++i)validData=isSafeInteger(clientState.activeTargetIds[i]),activeTargetIdsSet=activeTargetIdsSet.add(clientState.activeTargetIds[i]);return validData?new RemoteClientState(clientId,activeTargetIdsSet):(logError(LOG_TAG$a,"Failed to parse client data for instance '"+clientId+"': "+value),null)},RemoteClientState}(),SharedOnlineState=function(){function SharedOnlineState(clientId,onlineState){this.clientId=clientId,this.onlineState=onlineState}return SharedOnlineState.fromWebStorageEntry=function(value){var onlineState=JSON.parse(value);return"object"==typeof onlineState&&-1!==["Unknown","Online","Offline"].indexOf(onlineState.onlineState)&&"string"==typeof onlineState.clientId?new SharedOnlineState(onlineState.clientId,onlineState.onlineState):(logError(LOG_TAG$a,"Failed to parse online state: "+value),null)},SharedOnlineState}(),LocalClientState=function(){function LocalClientState(){this.activeTargetIds=targetIdSet()}return LocalClientState.prototype.addQueryTarget=function(targetId){this.activeTargetIds=this.activeTargetIds.add(targetId)},LocalClientState.prototype.removeQueryTarget=function(targetId){this.activeTargetIds=this.activeTargetIds.delete(targetId)},LocalClientState.prototype.toWebStorageJSON=function(){var data={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(data)},LocalClientState}(),WebStorageSharedClientState=function(){function WebStorageSharedClientState(window,queue,persistenceKey,localClientId,initialUser){this.window=window,this.queue=queue,this.persistenceKey=persistenceKey,this.localClientId=localClientId,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.storageListener=this.handleWebStorageEvent.bind(this),this.activeClients=new SortedMap(primitiveComparator),this.started=!1,this.earlyEvents=[];var escapedPersistenceKey=persistenceKey.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=initialUser,this.localClientStorageKey=createWebStorageClientStateKey(this.persistenceKey,this.localClientId),this.sequenceNumberKey=function createWebStorageSequenceNumberKey(persistenceKey){return"firestore_sequence_number_"+persistenceKey}(this.persistenceKey),this.activeClients=this.activeClients.insert(this.localClientId,new LocalClientState),this.clientStateKeyRe=new RegExp("^firestore_clients_"+escapedPersistenceKey+"_([^_]*)$"),this.mutationBatchKeyRe=new RegExp("^firestore_mutations_"+escapedPersistenceKey+"_(\\d+)(?:_(.*))?$"),this.queryTargetKeyRe=new RegExp("^firestore_targets_"+escapedPersistenceKey+"_(\\d+)$"),this.onlineStateKey=function createWebStorageOnlineStateKey(persistenceKey){return"firestore_online_state_"+persistenceKey}(this.persistenceKey),this.bundleLoadedKey=function createBundleLoadedKey(persistenceKey){return"firestore_bundle_loaded_"+persistenceKey}(this.persistenceKey),this.window.addEventListener("storage",this.storageListener)}return WebStorageSharedClientState.isAvailable=function(window){return!(!window||!window.localStorage)},WebStorageSharedClientState.prototype.start=function(){return tslib.__awaiter(this,void 0,void 0,function(){var existingClients,_i,existingClients_1,clientId,storageItem,clientState,onlineStateJSON,onlineState,_d,_e,event_1,_this=this;return tslib.__generator(this,function(_f){switch(_f.label){case 0:return[4,this.syncEngine.getActiveClients()];case 1:for(existingClients=_f.sent(),_i=0,existingClients_1=existingClients;_i<existingClients_1.length;_i++)(clientId=existingClients_1[_i])!==this.localClientId&&(storageItem=this.getItem(createWebStorageClientStateKey(this.persistenceKey,clientId)))&&(clientState=RemoteClientState.fromWebStorageEntry(clientId,storageItem))&&(this.activeClients=this.activeClients.insert(clientState.clientId,clientState));for(this.persistClientState(),(onlineStateJSON=this.storage.getItem(this.onlineStateKey))&&(onlineState=this.fromWebStorageOnlineState(onlineStateJSON))&&this.handleOnlineStateEvent(onlineState),_d=0,_e=this.earlyEvents;_d<_e.length;_d++)event_1=_e[_d],this.handleWebStorageEvent(event_1);return this.earlyEvents=[],this.window.addEventListener("pagehide",function(){return _this.shutdown()}),this.started=!0,[2]}})})},WebStorageSharedClientState.prototype.writeSequenceNumber=function(sequenceNumber){this.setItem(this.sequenceNumberKey,JSON.stringify(sequenceNumber))},WebStorageSharedClientState.prototype.getAllActiveQueryTargets=function(){return this.extractActiveQueryTargets(this.activeClients)},WebStorageSharedClientState.prototype.isActiveQueryTarget=function(targetId){var found=!1;return this.activeClients.forEach(function(key,value){value.activeTargetIds.has(targetId)&&(found=!0)}),found},WebStorageSharedClientState.prototype.addPendingMutation=function(batchId){this.persistMutationState(batchId,"pending")},WebStorageSharedClientState.prototype.updateMutationState=function(batchId,state,error){this.persistMutationState(batchId,state,error),this.removeMutationState(batchId)},WebStorageSharedClientState.prototype.addLocalQueryTarget=function(targetId){var queryState="not-current";if(this.isActiveQueryTarget(targetId)){var storageItem=this.storage.getItem(createWebStorageQueryTargetMetadataKey(this.persistenceKey,targetId));if(storageItem){var metadata=QueryTargetMetadata.fromWebStorageEntry(targetId,storageItem);metadata&&(queryState=metadata.state)}}return this.localClientState.addQueryTarget(targetId),this.persistClientState(),queryState},WebStorageSharedClientState.prototype.removeLocalQueryTarget=function(targetId){this.localClientState.removeQueryTarget(targetId),this.persistClientState()},WebStorageSharedClientState.prototype.isLocalQueryTarget=function(targetId){return this.localClientState.activeTargetIds.has(targetId)},WebStorageSharedClientState.prototype.clearQueryState=function(targetId){this.removeItem(createWebStorageQueryTargetMetadataKey(this.persistenceKey,targetId))},WebStorageSharedClientState.prototype.updateQueryState=function(targetId,state,error){this.persistQueryTargetState(targetId,state,error)},WebStorageSharedClientState.prototype.handleUserChange=function(user,removedBatchIds,addedBatchIds){var _this=this;removedBatchIds.forEach(function(batchId){_this.removeMutationState(batchId)}),this.currentUser=user,addedBatchIds.forEach(function(batchId){_this.addPendingMutation(batchId)})},WebStorageSharedClientState.prototype.setOnlineState=function(onlineState){this.persistOnlineState(onlineState)},WebStorageSharedClientState.prototype.notifyBundleLoaded=function(){this.persistBundleLoadedState()},WebStorageSharedClientState.prototype.shutdown=function(){this.started&&(this.window.removeEventListener("storage",this.storageListener),this.removeItem(this.localClientStorageKey),this.started=!1)},WebStorageSharedClientState.prototype.getItem=function(key){var value=this.storage.getItem(key);return logDebug(LOG_TAG$a,"READ",key,value),value},WebStorageSharedClientState.prototype.setItem=function(key,value){logDebug(LOG_TAG$a,"SET",key,value),this.storage.setItem(key,value)},WebStorageSharedClientState.prototype.removeItem=function(key){logDebug(LOG_TAG$a,"REMOVE",key),this.storage.removeItem(key)},WebStorageSharedClientState.prototype.handleWebStorageEvent=function(event){var _this=this,storageEvent=event;if(storageEvent.storageArea===this.storage){if(logDebug(LOG_TAG$a,"EVENT",storageEvent.key,storageEvent.newValue),storageEvent.key===this.localClientStorageKey)return void logError("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.queue.enqueueRetryable(function(){return tslib.__awaiter(_this,void 0,void 0,function(){var clientState,clientId,mutationMetadata,queryTargetMetadata,onlineState,sequenceNumber;return tslib.__generator(this,function(_d){if(!this.started)return this.earlyEvents.push(storageEvent),[2];if(null===storageEvent.key)return[2];if(this.clientStateKeyRe.test(storageEvent.key)){if(null==storageEvent.newValue)return clientId=this.fromWebStorageClientStateKey(storageEvent.key),[2,this.handleClientStateEvent(clientId,null)];if(clientState=this.fromWebStorageClientState(storageEvent.key,storageEvent.newValue))return[2,this.handleClientStateEvent(clientState.clientId,clientState)]}else if(this.mutationBatchKeyRe.test(storageEvent.key)){if(null!==storageEvent.newValue&&(mutationMetadata=this.fromWebStorageMutationMetadata(storageEvent.key,storageEvent.newValue)))return[2,this.handleMutationBatchEvent(mutationMetadata)]}else if(this.queryTargetKeyRe.test(storageEvent.key)){if(null!==storageEvent.newValue&&(queryTargetMetadata=this.fromWebStorageQueryTargetMetadata(storageEvent.key,storageEvent.newValue)))return[2,this.handleQueryTargetEvent(queryTargetMetadata)]}else if(storageEvent.key===this.onlineStateKey){if(null!==storageEvent.newValue&&(onlineState=this.fromWebStorageOnlineState(storageEvent.newValue)))return[2,this.handleOnlineStateEvent(onlineState)]}else if(storageEvent.key===this.sequenceNumberKey)(sequenceNumber=function fromWebStorageSequenceNumber(seqString){var sequenceNumber=ListenSequence.INVALID;if(null!=seqString)try{var parsed=JSON.parse(seqString);hardAssert("number"==typeof parsed),sequenceNumber=parsed}catch(e){logError(LOG_TAG$a,"Failed to read sequence number from WebStorage",e)}return sequenceNumber}(storageEvent.newValue))!==ListenSequence.INVALID&&this.sequenceNumberHandler(sequenceNumber);else if(storageEvent.key===this.bundleLoadedKey)return[2,this.syncEngine.synchronizeWithChangedDocuments()];return[2]})})})}},Object.defineProperty(WebStorageSharedClientState.prototype,"localClientState",{get:function(){return this.activeClients.get(this.localClientId)},enumerable:!1,configurable:!0}),WebStorageSharedClientState.prototype.persistClientState=function(){this.setItem(this.localClientStorageKey,this.localClientState.toWebStorageJSON())},WebStorageSharedClientState.prototype.persistMutationState=function(batchId,state,error){var mutationState=new MutationMetadata(this.currentUser,batchId,state,error),mutationKey=createWebStorageMutationBatchKey(this.persistenceKey,this.currentUser,batchId);this.setItem(mutationKey,mutationState.toWebStorageJSON())},WebStorageSharedClientState.prototype.removeMutationState=function(batchId){var mutationKey=createWebStorageMutationBatchKey(this.persistenceKey,this.currentUser,batchId);this.removeItem(mutationKey)},WebStorageSharedClientState.prototype.persistOnlineState=function(onlineState){var entry={clientId:this.localClientId,onlineState:onlineState};this.storage.setItem(this.onlineStateKey,JSON.stringify(entry))},WebStorageSharedClientState.prototype.persistQueryTargetState=function(targetId,state,error){var targetKey=createWebStorageQueryTargetMetadataKey(this.persistenceKey,targetId),targetMetadata=new QueryTargetMetadata(targetId,state,error);this.setItem(targetKey,targetMetadata.toWebStorageJSON())},WebStorageSharedClientState.prototype.persistBundleLoadedState=function(){this.setItem(this.bundleLoadedKey,"value-not-used")},WebStorageSharedClientState.prototype.fromWebStorageClientStateKey=function(key){var match=this.clientStateKeyRe.exec(key);return match?match[1]:null},WebStorageSharedClientState.prototype.fromWebStorageClientState=function(key,value){var clientId=this.fromWebStorageClientStateKey(key);return RemoteClientState.fromWebStorageEntry(clientId,value)},WebStorageSharedClientState.prototype.fromWebStorageMutationMetadata=function(key,value){var match=this.mutationBatchKeyRe.exec(key),batchId=Number(match[1]),userId=void 0!==match[2]?match[2]:null;return MutationMetadata.fromWebStorageEntry(new User(userId),batchId,value)},WebStorageSharedClientState.prototype.fromWebStorageQueryTargetMetadata=function(key,value){var match=this.queryTargetKeyRe.exec(key),targetId=Number(match[1]);return QueryTargetMetadata.fromWebStorageEntry(targetId,value)},WebStorageSharedClientState.prototype.fromWebStorageOnlineState=function(value){return SharedOnlineState.fromWebStorageEntry(value)},WebStorageSharedClientState.prototype.handleMutationBatchEvent=function(mutationBatch){return tslib.__awaiter(this,void 0,void 0,function(){return tslib.__generator(this,function(_d){return mutationBatch.user.uid!==this.currentUser.uid?(logDebug(LOG_TAG$a,"Ignoring mutation for non-active user "+mutationBatch.user.uid),[2]):[2,this.syncEngine.applyBatchState(mutationBatch.batchId,mutationBatch.state,mutationBatch.error)]})})},WebStorageSharedClientState.prototype.handleQueryTargetEvent=function(targetMetadata){return this.syncEngine.applyTargetState(targetMetadata.targetId,targetMetadata.state,targetMetadata.error)},WebStorageSharedClientState.prototype.handleClientStateEvent=function(clientId,clientState){var _this=this,updatedClients=clientState?this.activeClients.insert(clientId,clientState):this.activeClients.remove(clientId),existingTargets=this.extractActiveQueryTargets(this.activeClients),newTargets=this.extractActiveQueryTargets(updatedClients),addedTargets=[],removedTargets=[];return newTargets.forEach(function(targetId){existingTargets.has(targetId)||addedTargets.push(targetId)}),existingTargets.forEach(function(targetId){newTargets.has(targetId)||removedTargets.push(targetId)}),this.syncEngine.applyActiveTargetsChange(addedTargets,removedTargets).then(function(){_this.activeClients=updatedClients})},WebStorageSharedClientState.prototype.handleOnlineStateEvent=function(onlineState){this.activeClients.get(onlineState.clientId)&&this.onlineStateHandler(onlineState.onlineState)},WebStorageSharedClientState.prototype.extractActiveQueryTargets=function(clients){var activeTargets=targetIdSet();return clients.forEach(function(kev,value){activeTargets=activeTargets.unionWith(value.activeTargetIds)}),activeTargets},WebStorageSharedClientState}();var MemorySharedClientState=function(){function MemorySharedClientState(){this.localState=new LocalClientState,this.queryState={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}return MemorySharedClientState.prototype.addPendingMutation=function(batchId){},MemorySharedClientState.prototype.updateMutationState=function(batchId,state,error){},MemorySharedClientState.prototype.addLocalQueryTarget=function(targetId){return this.localState.addQueryTarget(targetId),this.queryState[targetId]||"not-current"},MemorySharedClientState.prototype.updateQueryState=function(targetId,state,error){this.queryState[targetId]=state},MemorySharedClientState.prototype.removeLocalQueryTarget=function(targetId){this.localState.removeQueryTarget(targetId)},MemorySharedClientState.prototype.isLocalQueryTarget=function(targetId){return this.localState.activeTargetIds.has(targetId)},MemorySharedClientState.prototype.clearQueryState=function(targetId){delete this.queryState[targetId]},MemorySharedClientState.prototype.getAllActiveQueryTargets=function(){return this.localState.activeTargetIds},MemorySharedClientState.prototype.isActiveQueryTarget=function(targetId){return this.localState.activeTargetIds.has(targetId)},MemorySharedClientState.prototype.start=function(){return this.localState=new LocalClientState,Promise.resolve()},MemorySharedClientState.prototype.handleUserChange=function(user,removedBatchIds,addedBatchIds){},MemorySharedClientState.prototype.setOnlineState=function(onlineState){},MemorySharedClientState.prototype.shutdown=function(){},MemorySharedClientState.prototype.writeSequenceNumber=function(sequenceNumber){},MemorySharedClientState.prototype.notifyBundleLoaded=function(){},MemorySharedClientState}(),NoopConnectivityMonitor=function(){function NoopConnectivityMonitor(){}return NoopConnectivityMonitor.prototype.addCallback=function(callback){},NoopConnectivityMonitor.prototype.shutdown=function(){},NoopConnectivityMonitor}(),StreamBridge=function(){function StreamBridge(args){this.sendFn=args.sendFn,this.closeFn=args.closeFn}return StreamBridge.prototype.onOpen=function(callback){this.wrappedOnOpen=callback},StreamBridge.prototype.onClose=function(callback){this.wrappedOnClose=callback},StreamBridge.prototype.onMessage=function(callback){this.wrappedOnMessage=callback},StreamBridge.prototype.close=function(){this.closeFn()},StreamBridge.prototype.send=function(msg){this.sendFn(msg)},StreamBridge.prototype.callOnOpen=function(){this.wrappedOnOpen()},StreamBridge.prototype.callOnClose=function(err){this.wrappedOnClose(err)},StreamBridge.prototype.callOnMessage=function(msg){this.wrappedOnMessage(msg)},StreamBridge}();var LOG_TAG$9="Connection",X_GOOG_API_CLIENT_VALUE="gl-node/"+process.versions.node+" fire/8.7.0 grpc/"+package_json.version;function createMetadata(databasePath,token,appId){hardAssert(null===token||"OAuth"===token.type);var metadata=new grpcJs.Metadata;if(token)for(var header in token.authHeaders)token.authHeaders.hasOwnProperty(header)&&metadata.set(header,token.authHeaders[header]);return appId&&metadata.set("X-Firebase-GMPID",appId),metadata.set("X-Goog-Api-Client",X_GOOG_API_CLIENT_VALUE),metadata.set("Google-Cloud-Resource-Prefix",databasePath),metadata}var GrpcConnection=function(){function GrpcConnection(protos,databaseInfo){this.databaseInfo=databaseInfo,this.cachedStub=null,this.firestore=protos.google.firestore.v1,this.databasePath="projects/"+databaseInfo.databaseId.projectId+"/databases/"+databaseInfo.databaseId.database}return GrpcConnection.prototype.ensureActiveStub=function(){if(!this.cachedStub){logDebug(LOG_TAG$9,"Creating Firestore stub.");var credentials$1=this.databaseInfo.ssl?grpcJs.credentials.createSsl():grpcJs.credentials.createInsecure();this.cachedStub=new this.firestore.Firestore(this.databaseInfo.host,credentials$1)}return this.cachedStub},GrpcConnection.prototype.invokeRPC=function(rpcName,path,request,token){var stub=this.ensureActiveStub(),metadata=createMetadata(this.databasePath,token,this.databaseInfo.appId),jsonRequest=Object.assign({database:this.databasePath},request);return function nodePromise(action){return new Promise(function(resolve,reject){action(function(error,value){error?reject(error):resolve(value)})})}(function(callback){return logDebug(LOG_TAG$9,"RPC '"+rpcName+"' invoked with request:",request),stub[rpcName](jsonRequest,metadata,function(grpcError,value){grpcError?(logDebug(LOG_TAG$9,"RPC '"+rpcName+"' failed with error:",grpcError),callback(new FirestoreError(mapCodeFromRpcCode(grpcError.code),grpcError.message))):(logDebug(LOG_TAG$9,"RPC '"+rpcName+"' completed with response:",value),callback(void 0,value))})})},GrpcConnection.prototype.invokeStreamingRPC=function(rpcName,path,request,token){var results=[],responseDeferred=new Deferred;logDebug(LOG_TAG$9,"RPC '"+rpcName+"' invoked (streaming) with request:",request);var stub=this.ensureActiveStub(),metadata=createMetadata(this.databasePath,token,this.databaseInfo.appId),jsonRequest=Object.assign(Object.assign({},request),{database:this.databasePath}),stream=stub[rpcName](jsonRequest,metadata);return stream.on("data",function(response){logDebug(LOG_TAG$9,"RPC "+rpcName+" received result:",response),results.push(response)}),stream.on("end",function(){logDebug(LOG_TAG$9,"RPC '"+rpcName+"' completed."),responseDeferred.resolve(results)}),stream.on("error",function(grpcError){logDebug(LOG_TAG$9,"RPC '"+rpcName+"' failed with error:",grpcError);var code=mapCodeFromRpcCode(grpcError.code);responseDeferred.reject(new FirestoreError(code,grpcError.message))}),responseDeferred.promise},GrpcConnection.prototype.openStream=function(rpcName,token){var stub=this.ensureActiveStub(),metadata=createMetadata(this.databasePath,token,this.databaseInfo.appId),grpcStream=stub[rpcName](metadata),closed=!1,close=function(err){closed||(closed=!0,stream.callOnClose(err),grpcStream.end())},stream=new StreamBridge({sendFn:function(msg){if(closed)logDebug(LOG_TAG$9,"Not sending because gRPC stream is closed:",msg);else{logDebug(LOG_TAG$9,"GRPC stream sending:",msg);try{grpcStream.write(msg)}catch(e){throw logError("Failure sending:",msg),logError("Error:",e),e}}},closeFn:function(){logDebug(LOG_TAG$9,"GRPC stream closed locally via close()."),close()}});return grpcStream.on("data",function(msg){closed||(logDebug(LOG_TAG$9,"GRPC stream received:",msg),stream.callOnMessage(msg))}),grpcStream.on("end",function(){logDebug(LOG_TAG$9,"GRPC stream ended."),close()}),grpcStream.on("error",function(grpcError){if(!closed){logWarn(LOG_TAG$9,"GRPC stream error. Code:",grpcError.code,"Message:",grpcError.message);var code=mapCodeFromRpcCode(grpcError.code);close(new FirestoreError(code,grpcError.message))}}),logDebug(LOG_TAG$9,"Opening GRPC stream"),setTimeout(function(){stream.callOnOpen()},0),stream},GrpcConnection}(),protoLoaderOptions={longs:String,enums:String,defaults:!0,oneofs:!1};function newConnection(databaseInfo){var protos=function loadProtos(){var root=path.resolve(__dirname,"../protos"),firestoreProtoFile=path.join(root,"google/firestore/v1/firestore.proto"),packageDefinition=protoLoader.loadSync(firestoreProtoFile,Object.assign(Object.assign({},protoLoaderOptions),{includeDirs:[root]}));return grpcJs.loadPackageDefinition(packageDefinition)}();return new GrpcConnection(protos,databaseInfo)}function getWindow(){return"YES"===process.env.USE_MOCK_PERSISTENCE?window:null}function newSerializer(databaseId){return new JsonProtoSerializer(databaseId,!1)}var ExponentialBackoff=function(){function ExponentialBackoff(queue,timerId,initialDelayMs,backoffFactor,maxDelayMs){void 0===initialDelayMs&&(initialDelayMs=1e3),void 0===backoffFactor&&(backoffFactor=1.5),void 0===maxDelayMs&&(maxDelayMs=6e4),this.queue=queue,this.timerId=timerId,this.initialDelayMs=initialDelayMs,this.backoffFactor=backoffFactor,this.maxDelayMs=maxDelayMs,this.currentBaseMs=0,this.timerPromise=null,this.lastAttemptTime=Date.now(),this.reset()}return ExponentialBackoff.prototype.reset=function(){this.currentBaseMs=0},ExponentialBackoff.prototype.resetToMax=function(){this.currentBaseMs=this.maxDelayMs},ExponentialBackoff.prototype.backoffAndRun=function(op){var _this=this;this.cancel();var desiredDelayWithJitterMs=Math.floor(this.currentBaseMs+this.jitterDelayMs()),delaySoFarMs=Math.max(0,Date.now()-this.lastAttemptTime),remainingDelayMs=Math.max(0,desiredDelayWithJitterMs-delaySoFarMs);remainingDelayMs>0&&logDebug("ExponentialBackoff","Backing off for "+remainingDelayMs+" ms (base delay: "+this.currentBaseMs+" ms, delay with jitter: "+desiredDelayWithJitterMs+" ms, last attempt: "+delaySoFarMs+" ms ago)"),this.timerPromise=this.queue.enqueueAfterDelay(this.timerId,remainingDelayMs,function(){return _this.lastAttemptTime=Date.now(),op()}),this.currentBaseMs*=this.backoffFactor,this.currentBaseMs<this.initialDelayMs&&(this.currentBaseMs=this.initialDelayMs),this.currentBaseMs>this.maxDelayMs&&(this.currentBaseMs=this.maxDelayMs)},ExponentialBackoff.prototype.skipBackoff=function(){null!==this.timerPromise&&(this.timerPromise.skipDelay(),this.timerPromise=null)},ExponentialBackoff.prototype.cancel=function(){null!==this.timerPromise&&(this.timerPromise.cancel(),this.timerPromise=null)},ExponentialBackoff.prototype.jitterDelayMs=function(){return(Math.random()-.5)*this.currentBaseMs},ExponentialBackoff}(),PersistentStream=function(){function PersistentStream(queue,connectionTimerId,idleTimerId,connection,credentialsProvider,listener){this.queue=queue,this.idleTimerId=idleTimerId,this.connection=connection,this.credentialsProvider=credentialsProvider,this.listener=listener,this.state=0,this.closeCount=0,this.idleTimer=null,this.stream=null,this.backoff=new ExponentialBackoff(queue,connectionTimerId)}return PersistentStream.prototype.isStarted=function(){return 1===this.state||2===this.state||4===this.state},PersistentStream.prototype.isOpen=function(){return 2===this.state},PersistentStream.prototype.start=function(){3!==this.state?this.auth():this.performBackoff()},PersistentStream.prototype.stop=function(){return tslib.__awaiter(this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return this.isStarted()?[4,this.close(0)]:[3,2];case 1:_d.sent(),_d.label=2;case 2:return[2]}})})},PersistentStream.prototype.inhibitBackoff=function(){this.state=0,this.backoff.reset()},PersistentStream.prototype.markIdle=function(){var _this=this;this.isOpen()&&null===this.idleTimer&&(this.idleTimer=this.queue.enqueueAfterDelay(this.idleTimerId,6e4,function(){return _this.handleIdleCloseTimer()}))},PersistentStream.prototype.sendRequest=function(msg){this.cancelIdleCheck(),this.stream.send(msg)},PersistentStream.prototype.handleIdleCloseTimer=function(){return tslib.__awaiter(this,void 0,void 0,function(){return tslib.__generator(this,function(_d){return this.isOpen()?[2,this.close(0)]:[2]})})},PersistentStream.prototype.cancelIdleCheck=function(){this.idleTimer&&(this.idleTimer.cancel(),this.idleTimer=null)},PersistentStream.prototype.close=function(finalState,error){return tslib.__awaiter(this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return this.cancelIdleCheck(),this.backoff.cancel(),this.closeCount++,3!==finalState?this.backoff.reset():error&&error.code===Code_RESOURCE_EXHAUSTED?(logError(error.toString()),logError("Using maximum backoff delay to prevent overloading the backend."),this.backoff.resetToMax()):error&&error.code===Code_UNAUTHENTICATED&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.tearDown(),this.stream.close(),this.stream=null),this.state=finalState,[4,this.listener.onClose(error)];case 1:return _d.sent(),[2]}})})},PersistentStream.prototype.tearDown=function(){},PersistentStream.prototype.auth=function(){var _this=this;this.state=1;var dispatchIfNotClosed=this.getCloseGuardedDispatcher(this.closeCount),closeCount=this.closeCount;this.credentialsProvider.getToken().then(function(token){_this.closeCount===closeCount&&_this.startStream(token)},function(error){dispatchIfNotClosed(function(){var rpcError=new FirestoreError(Code_UNKNOWN,"Fetching auth token failed: "+error.message);return _this.handleStreamClose(rpcError)})})},PersistentStream.prototype.startStream=function(token){var _this=this,dispatchIfNotClosed=this.getCloseGuardedDispatcher(this.closeCount);this.stream=this.startRpc(token),this.stream.onOpen(function(){dispatchIfNotClosed(function(){return _this.state=2,_this.listener.onOpen()})}),this.stream.onClose(function(error){dispatchIfNotClosed(function(){return _this.handleStreamClose(error)})}),this.stream.onMessage(function(msg){dispatchIfNotClosed(function(){return _this.onMessage(msg)})})},PersistentStream.prototype.performBackoff=function(){var _this=this;this.state=4,this.backoff.backoffAndRun(function(){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){return this.state=0,this.start(),[2]})})})},PersistentStream.prototype.handleStreamClose=function(error){return logDebug("PersistentStream","close with error: "+error),this.stream=null,this.close(3,error)},PersistentStream.prototype.getCloseGuardedDispatcher=function(startCloseCount){var _this=this;return function(fn){_this.queue.enqueueAndForget(function(){return _this.closeCount===startCloseCount?fn():(logDebug("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())})}},PersistentStream}(),PersistentListenStream=function(_super){function PersistentListenStream(queue,connection,credentials,serializer,listener){var _this=_super.call(this,queue,"listen_stream_connection_backoff","listen_stream_idle",connection,credentials,listener)||this;return _this.serializer=serializer,_this}return tslib.__extends(PersistentListenStream,_super),PersistentListenStream.prototype.startRpc=function(token){return this.connection.openStream("Listen",token)},PersistentListenStream.prototype.onMessage=function(watchChangeProto){this.backoff.reset();var watchChange=fromWatchChange(this.serializer,watchChangeProto),snapshot=function versionFromListenResponse(change){if(!("targetChange"in change))return SnapshotVersion.min();var targetChange=change.targetChange;return targetChange.targetIds&&targetChange.targetIds.length?SnapshotVersion.min():targetChange.readTime?fromVersion(targetChange.readTime):SnapshotVersion.min()}(watchChangeProto);return this.listener.onWatchChange(watchChange,snapshot)},PersistentListenStream.prototype.watch=function(targetData){var request={};request.database=getEncodedDatabaseId(this.serializer),request.addTarget=function toTarget(serializer,targetData){var result,target=targetData.target;return(result=isDocumentTarget(target)?{documents:toDocumentsTarget(serializer,target)}:{query:toQueryTarget(serializer,target)}).targetId=targetData.targetId,targetData.resumeToken.approximateByteSize()>0?result.resumeToken=toBytes(serializer,targetData.resumeToken):targetData.snapshotVersion.compareTo(SnapshotVersion.min())>0&&(result.readTime=toTimestamp(serializer,targetData.snapshotVersion.toTimestamp())),result}(this.serializer,targetData);var labels=toListenRequestLabels(this.serializer,targetData);labels&&(request.labels=labels),this.sendRequest(request)},PersistentListenStream.prototype.unwatch=function(targetId){var request={};request.database=getEncodedDatabaseId(this.serializer),request.removeTarget=targetId,this.sendRequest(request)},PersistentListenStream}(PersistentStream),PersistentWriteStream=function(_super){function PersistentWriteStream(queue,connection,credentials,serializer,listener){var _this=_super.call(this,queue,"write_stream_connection_backoff","write_stream_idle",connection,credentials,listener)||this;return _this.serializer=serializer,_this.handshakeComplete_=!1,_this}return tslib.__extends(PersistentWriteStream,_super),Object.defineProperty(PersistentWriteStream.prototype,"handshakeComplete",{get:function(){return this.handshakeComplete_},enumerable:!1,configurable:!0}),PersistentWriteStream.prototype.start=function(){this.handshakeComplete_=!1,this.lastStreamToken=void 0,_super.prototype.start.call(this)},PersistentWriteStream.prototype.tearDown=function(){this.handshakeComplete_&&this.writeMutations([])},PersistentWriteStream.prototype.startRpc=function(token){return this.connection.openStream("Write",token)},PersistentWriteStream.prototype.onMessage=function(responseProto){if(hardAssert(!!responseProto.streamToken),this.lastStreamToken=responseProto.streamToken,this.handshakeComplete_){this.backoff.reset();var results=fromWriteResults(responseProto.writeResults,responseProto.commitTime),commitVersion=fromVersion(responseProto.commitTime);return this.listener.onMutationResult(commitVersion,results)}return hardAssert(!responseProto.writeResults||0===responseProto.writeResults.length),this.handshakeComplete_=!0,this.listener.onHandshakeComplete()},PersistentWriteStream.prototype.writeHandshake=function(){var request={};request.database=getEncodedDatabaseId(this.serializer),this.sendRequest(request)},PersistentWriteStream.prototype.writeMutations=function(mutations){var _this=this,request={streamToken:this.lastStreamToken,writes:mutations.map(function(mutation){return toMutation(_this.serializer,mutation)})};this.sendRequest(request)},PersistentWriteStream}(PersistentStream),DatastoreImpl=function(_super){function DatastoreImpl(credentials,connection,serializer){var _this=_super.call(this)||this;return _this.credentials=credentials,_this.connection=connection,_this.serializer=serializer,_this.terminated=!1,_this}return tslib.__extends(DatastoreImpl,_super),DatastoreImpl.prototype.verifyInitialized=function(){if(this.terminated)throw new FirestoreError(Code_FAILED_PRECONDITION,"The client has already been terminated.")},DatastoreImpl.prototype.invokeRPC=function(rpcName,path,request){var _this=this;return this.verifyInitialized(),this.credentials.getToken().then(function(token){return _this.connection.invokeRPC(rpcName,path,request,token)}).catch(function(error){throw"FirebaseError"===error.name?(error.code===Code_UNAUTHENTICATED&&_this.credentials.invalidateToken(),error):new FirestoreError(Code_UNKNOWN,error.toString())})},DatastoreImpl.prototype.invokeStreamingRPC=function(rpcName,path,request){var _this=this;return this.verifyInitialized(),this.credentials.getToken().then(function(token){return _this.connection.invokeStreamingRPC(rpcName,path,request,token)}).catch(function(error){throw"FirebaseError"===error.name?(error.code===Code_UNAUTHENTICATED&&_this.credentials.invalidateToken(),error):new FirestoreError(Code_UNKNOWN,error.toString())})},DatastoreImpl.prototype.terminate=function(){this.terminated=!0},DatastoreImpl}(function Datastore(){});function invokeCommitRpc(datastore,mutations){return tslib.__awaiter(this,void 0,void 0,function(){var datastoreImpl,path,request;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return datastoreImpl=debugCast(datastore),path=getEncodedDatabaseId(datastoreImpl.serializer)+"/documents",request={writes:mutations.map(function(m){return toMutation(datastoreImpl.serializer,m)})},[4,datastoreImpl.invokeRPC("Commit",path,request)];case 1:return _d.sent(),[2]}})})}function invokeBatchGetDocumentsRpc(datastore,keys){return tslib.__awaiter(this,void 0,void 0,function(){var datastoreImpl,path,request,response,docs,result;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return datastoreImpl=debugCast(datastore),path=getEncodedDatabaseId(datastoreImpl.serializer)+"/documents",request={documents:keys.map(function(k){return toName(datastoreImpl.serializer,k)})},[4,datastoreImpl.invokeStreamingRPC("BatchGetDocuments",path,request)];case 1:return response=_d.sent(),docs=new Map,response.forEach(function(proto){var doc=fromBatchGetDocumentsResponse(datastoreImpl.serializer,proto);docs.set(doc.key.toString(),doc)}),result=[],keys.forEach(function(key){var doc=docs.get(key.toString());hardAssert(!!doc),result.push(doc)}),[2,result]}})})}var OnlineStateTracker=function(){function OnlineStateTracker(asyncQueue,onlineStateHandler){this.asyncQueue=asyncQueue,this.onlineStateHandler=onlineStateHandler,this.state="Unknown",this.watchStreamFailures=0,this.onlineStateTimer=null,this.shouldWarnClientIsOffline=!0}return OnlineStateTracker.prototype.handleWatchStreamStart=function(){var _this=this;0===this.watchStreamFailures&&(this.setAndBroadcast("Unknown"),this.onlineStateTimer=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,function(){return _this.onlineStateTimer=null,_this.logClientOfflineWarningIfNecessary("Backend didn't respond within 10 seconds."),_this.setAndBroadcast("Offline"),Promise.resolve()}))},OnlineStateTracker.prototype.handleWatchStreamFailure=function(error){"Online"===this.state?this.setAndBroadcast("Unknown"):(this.watchStreamFailures++,this.watchStreamFailures>=1&&(this.clearOnlineStateTimer(),this.logClientOfflineWarningIfNecessary("Connection failed 1 times. Most recent error: "+error.toString()),this.setAndBroadcast("Offline")))},OnlineStateTracker.prototype.set=function(newState){this.clearOnlineStateTimer(),this.watchStreamFailures=0,"Online"===newState&&(this.shouldWarnClientIsOffline=!1),this.setAndBroadcast(newState)},OnlineStateTracker.prototype.setAndBroadcast=function(newState){newState!==this.state&&(this.state=newState,this.onlineStateHandler(newState))},OnlineStateTracker.prototype.logClientOfflineWarningIfNecessary=function(details){var message="Could not reach Cloud Firestore backend. "+details+"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";this.shouldWarnClientIsOffline?(logError(message),this.shouldWarnClientIsOffline=!1):logDebug("OnlineStateTracker",message)},OnlineStateTracker.prototype.clearOnlineStateTimer=function(){null!==this.onlineStateTimer&&(this.onlineStateTimer.cancel(),this.onlineStateTimer=null)},OnlineStateTracker}(),LOG_TAG$5="RemoteStore",RemoteStoreImpl=function RemoteStoreImpl(localStore,datastore,asyncQueue,onlineStateHandler,connectivityMonitor){var _this=this;this.localStore=localStore,this.datastore=datastore,this.asyncQueue=asyncQueue,this.remoteSyncer={},this.writePipeline=[],this.listenTargets=new Map,this.offlineCauses=new Set,this.onNetworkStatusChange=[],this.connectivityMonitor=connectivityMonitor,this.connectivityMonitor.addCallback(function(_){asyncQueue.enqueueAndForget(function(){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return canUseNetwork(this)?(logDebug(LOG_TAG$5,"Restarting streams for network reachability change."),[4,restartNetwork(this)]):[3,2];case 1:_d.sent(),_d.label=2;case 2:return[2]}})})})}),this.onlineStateTracker=new OnlineStateTracker(asyncQueue,onlineStateHandler)};function remoteStoreEnableNetwork(remoteStore){var remoteStoreImpl=debugCast(remoteStore);return remoteStoreImpl.offlineCauses.delete(0),enableNetworkInternal(remoteStoreImpl)}function enableNetworkInternal(remoteStoreImpl){return tslib.__awaiter(this,void 0,void 0,function(){var _i,_d;return tslib.__generator(this,function(_e){switch(_e.label){case 0:if(!canUseNetwork(remoteStoreImpl))return[3,4];_i=0,_d=remoteStoreImpl.onNetworkStatusChange,_e.label=1;case 1:return _i<_d.length?[4,(0,_d[_i])(!0)]:[3,4];case 2:_e.sent(),_e.label=3;case 3:return _i++,[3,1];case 4:return[2]}})})}function remoteStoreDisableNetwork(remoteStore){return tslib.__awaiter(this,void 0,void 0,function(){var remoteStoreImpl;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return(remoteStoreImpl=debugCast(remoteStore)).offlineCauses.add(0),[4,disableNetworkInternal(remoteStoreImpl)];case 1:return _d.sent(),remoteStoreImpl.onlineStateTracker.set("Offline"),[2]}})})}function disableNetworkInternal(remoteStoreImpl){return tslib.__awaiter(this,void 0,void 0,function(){var _i,_d;return tslib.__generator(this,function(_e){switch(_e.label){case 0:_i=0,_d=remoteStoreImpl.onNetworkStatusChange,_e.label=1;case 1:return _i<_d.length?[4,(0,_d[_i])(!1)]:[3,4];case 2:_e.sent(),_e.label=3;case 3:return _i++,[3,1];case 4:return[2]}})})}function remoteStoreListen(remoteStore,targetData){var remoteStoreImpl=debugCast(remoteStore);remoteStoreImpl.listenTargets.has(targetData.targetId)||(remoteStoreImpl.listenTargets.set(targetData.targetId,targetData),shouldStartWatchStream(remoteStoreImpl)?startWatchStream(remoteStoreImpl):ensureWatchStream(remoteStoreImpl).isOpen()&&sendWatchRequest(remoteStoreImpl,targetData))}function remoteStoreUnlisten(remoteStore,targetId){var remoteStoreImpl=debugCast(remoteStore),watchStream=ensureWatchStream(remoteStoreImpl);remoteStoreImpl.listenTargets.delete(targetId),watchStream.isOpen()&&sendUnwatchRequest(remoteStoreImpl,targetId),0===remoteStoreImpl.listenTargets.size&&(watchStream.isOpen()?watchStream.markIdle():canUseNetwork(remoteStoreImpl)&&remoteStoreImpl.onlineStateTracker.set("Unknown"))}function sendWatchRequest(remoteStoreImpl,targetData){remoteStoreImpl.watchChangeAggregator.recordPendingTargetRequest(targetData.targetId),ensureWatchStream(remoteStoreImpl).watch(targetData)}function sendUnwatchRequest(remoteStoreImpl,targetId){remoteStoreImpl.watchChangeAggregator.recordPendingTargetRequest(targetId),ensureWatchStream(remoteStoreImpl).unwatch(targetId)}function startWatchStream(remoteStoreImpl){remoteStoreImpl.watchChangeAggregator=new WatchChangeAggregator({getRemoteKeysForTarget:function(targetId){return remoteStoreImpl.remoteSyncer.getRemoteKeysForTarget(targetId)},getTargetDataForTarget:function(targetId){return remoteStoreImpl.listenTargets.get(targetId)||null}}),ensureWatchStream(remoteStoreImpl).start(),remoteStoreImpl.onlineStateTracker.handleWatchStreamStart()}function shouldStartWatchStream(remoteStoreImpl){return canUseNetwork(remoteStoreImpl)&&!ensureWatchStream(remoteStoreImpl).isStarted()&&remoteStoreImpl.listenTargets.size>0}function canUseNetwork(remoteStore){return 0===debugCast(remoteStore).offlineCauses.size}function cleanUpWatchStreamState(remoteStoreImpl){remoteStoreImpl.watchChangeAggregator=void 0}function onWatchStreamOpen(remoteStoreImpl){return tslib.__awaiter(this,void 0,void 0,function(){return tslib.__generator(this,function(_d){return remoteStoreImpl.listenTargets.forEach(function(targetData,targetId){sendWatchRequest(remoteStoreImpl,targetData)}),[2]})})}function onWatchStreamClose(remoteStoreImpl,error){return tslib.__awaiter(this,void 0,void 0,function(){return tslib.__generator(this,function(_d){return cleanUpWatchStreamState(remoteStoreImpl),shouldStartWatchStream(remoteStoreImpl)?(remoteStoreImpl.onlineStateTracker.handleWatchStreamFailure(error),startWatchStream(remoteStoreImpl)):remoteStoreImpl.onlineStateTracker.set("Unknown"),[2]})})}function onWatchStreamChange(remoteStoreImpl,watchChange,snapshotVersion){return tslib.__awaiter(this,void 0,void 0,function(){var e_4,lastRemoteSnapshotVersion,e_5;return tslib.__generator(this,function(_d){switch(_d.label){case 0:if(remoteStoreImpl.onlineStateTracker.set("Online"),!(watchChange instanceof WatchTargetChange&&2===watchChange.state&&watchChange.cause))return[3,6];_d.label=1;case 1:return _d.trys.push([1,3,,5]),[4,handleTargetError(remoteStoreImpl,watchChange)];case 2:return _d.sent(),[3,5];case 3:return e_4=_d.sent(),logDebug(LOG_TAG$5,"Failed to remove targets %s: %s ",watchChange.targetIds.join(","),e_4),[4,disableNetworkUntilRecovery(remoteStoreImpl,e_4)];case 4:return _d.sent(),[3,5];case 5:return[2];case 6:if(watchChange instanceof DocumentWatchChange?remoteStoreImpl.watchChangeAggregator.handleDocumentChange(watchChange):watchChange instanceof ExistenceFilterChange?remoteStoreImpl.watchChangeAggregator.handleExistenceFilter(watchChange):remoteStoreImpl.watchChangeAggregator.handleTargetChange(watchChange),snapshotVersion.isEqual(SnapshotVersion.min()))return[3,13];_d.label=7;case 7:return _d.trys.push([7,11,,13]),[4,localStoreGetLastRemoteSnapshotVersion(remoteStoreImpl.localStore)];case 8:return lastRemoteSnapshotVersion=_d.sent(),snapshotVersion.compareTo(lastRemoteSnapshotVersion)>=0?[4,raiseWatchSnapshot(remoteStoreImpl,snapshotVersion)]:[3,10];case 9:_d.sent(),_d.label=10;case 10:return[3,13];case 11:return e_5=_d.sent(),logDebug(LOG_TAG$5,"Failed to raise snapshot:",e_5),[4,disableNetworkUntilRecovery(remoteStoreImpl,e_5)];case 12:return _d.sent(),[3,13];case 13:return[2]}})})}function disableNetworkUntilRecovery(remoteStoreImpl,e,op){return tslib.__awaiter(this,void 0,void 0,function(){var _this=this;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return isIndexedDbTransactionError(e)?(remoteStoreImpl.offlineCauses.add(1),[4,disableNetworkInternal(remoteStoreImpl)]):[3,2];case 1:return _d.sent(),remoteStoreImpl.onlineStateTracker.set("Offline"),op||(op=function(){return localStoreGetLastRemoteSnapshotVersion(remoteStoreImpl.localStore)}),remoteStoreImpl.asyncQueue.enqueueRetryable(function(){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return logDebug(LOG_TAG$5,"Retrying IndexedDB access"),[4,op()];case 1:return _d.sent(),remoteStoreImpl.offlineCauses.delete(1),[4,enableNetworkInternal(remoteStoreImpl)];case 2:return _d.sent(),[2]}})})}),[3,3];case 2:throw e;case 3:return[2]}})})}function executeWithRecovery(remoteStoreImpl,op){return op().catch(function(e){return disableNetworkUntilRecovery(remoteStoreImpl,e,op)})}function raiseWatchSnapshot(remoteStoreImpl,snapshotVersion){var remoteEvent=remoteStoreImpl.watchChangeAggregator.createRemoteEvent(snapshotVersion);return remoteEvent.targetChanges.forEach(function(change,targetId){if(change.resumeToken.approximateByteSize()>0){var targetData=remoteStoreImpl.listenTargets.get(targetId);targetData&&remoteStoreImpl.listenTargets.set(targetId,targetData.withResumeToken(change.resumeToken,snapshotVersion))}}),remoteEvent.targetMismatches.forEach(function(targetId){var targetData=remoteStoreImpl.listenTargets.get(targetId);if(targetData){remoteStoreImpl.listenTargets.set(targetId,targetData.withResumeToken(ByteString.EMPTY_BYTE_STRING,targetData.snapshotVersion)),sendUnwatchRequest(remoteStoreImpl,targetId);var requestTargetData=new TargetData(targetData.target,targetId,1,targetData.sequenceNumber);sendWatchRequest(remoteStoreImpl,requestTargetData)}}),remoteStoreImpl.remoteSyncer.applyRemoteEvent(remoteEvent)}function handleTargetError(remoteStoreImpl,watchChange){return tslib.__awaiter(this,void 0,void 0,function(){var error,_i,_d,targetId;return tslib.__generator(this,function(_e){switch(_e.label){case 0:error=watchChange.cause,_i=0,_d=watchChange.targetIds,_e.label=1;case 1:return _i<_d.length?(targetId=_d[_i],remoteStoreImpl.listenTargets.has(targetId)?[4,remoteStoreImpl.remoteSyncer.rejectListen(targetId,error)]:[3,3]):[3,4];case 2:_e.sent(),remoteStoreImpl.listenTargets.delete(targetId),remoteStoreImpl.watchChangeAggregator.removeTarget(targetId),_e.label=3;case 3:return _i++,[3,1];case 4:return[2]}})})}function fillWritePipeline(remoteStore){return tslib.__awaiter(this,void 0,void 0,function(){var remoteStoreImpl,writeStream,lastBatchIdRetrieved,batch,e_6;return tslib.__generator(this,function(_d){switch(_d.label){case 0:remoteStoreImpl=debugCast(remoteStore),writeStream=ensureWriteStream(remoteStoreImpl),lastBatchIdRetrieved=remoteStoreImpl.writePipeline.length>0?remoteStoreImpl.writePipeline[remoteStoreImpl.writePipeline.length-1].batchId:-1,_d.label=1;case 1:if(!function canAddToWritePipeline(remoteStoreImpl){return canUseNetwork(remoteStoreImpl)&&remoteStoreImpl.writePipeline.length<10}(remoteStoreImpl))return[3,7];_d.label=2;case 2:return _d.trys.push([2,4,,6]),[4,(localStore=remoteStoreImpl.localStore,afterBatchId=lastBatchIdRetrieved,localStoreImpl=debugCast(localStore),localStoreImpl.persistence.runTransaction("Get next mutation batch","readonly",function(txn){return void 0===afterBatchId&&(afterBatchId=-1),localStoreImpl.mutationQueue.getNextMutationBatchAfterBatchId(txn,afterBatchId)}))];case 3:return null===(batch=_d.sent())?(0===remoteStoreImpl.writePipeline.length&&writeStream.markIdle(),[3,7]):(lastBatchIdRetrieved=batch.batchId,function addToWritePipeline(remoteStoreImpl,batch){remoteStoreImpl.writePipeline.push(batch);var writeStream=ensureWriteStream(remoteStoreImpl);writeStream.isOpen()&&writeStream.handshakeComplete&&writeStream.writeMutations(batch.mutations)}(remoteStoreImpl,batch),[3,6]);case 4:return e_6=_d.sent(),[4,disableNetworkUntilRecovery(remoteStoreImpl,e_6)];case 5:return _d.sent(),[3,6];case 6:return[3,1];case 7:return shouldStartWriteStream(remoteStoreImpl)&&startWriteStream(remoteStoreImpl),[2]}var localStore,afterBatchId,localStoreImpl})})}function shouldStartWriteStream(remoteStoreImpl){return canUseNetwork(remoteStoreImpl)&&!ensureWriteStream(remoteStoreImpl).isStarted()&&remoteStoreImpl.writePipeline.length>0}function startWriteStream(remoteStoreImpl){ensureWriteStream(remoteStoreImpl).start()}function onWriteStreamOpen(remoteStoreImpl){return tslib.__awaiter(this,void 0,void 0,function(){return tslib.__generator(this,function(_d){return ensureWriteStream(remoteStoreImpl).writeHandshake(),[2]})})}function onWriteHandshakeComplete(remoteStoreImpl){return tslib.__awaiter(this,void 0,void 0,function(){var writeStream,_i,_d,batch;return tslib.__generator(this,function(_e){for(writeStream=ensureWriteStream(remoteStoreImpl),_i=0,_d=remoteStoreImpl.writePipeline;_i<_d.length;_i++)batch=_d[_i],writeStream.writeMutations(batch.mutations);return[2]})})}function onMutationResult(remoteStoreImpl,commitVersion,results){return tslib.__awaiter(this,void 0,void 0,function(){var batch,success;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return batch=remoteStoreImpl.writePipeline.shift(),success=MutationBatchResult.from(batch,commitVersion,results),[4,executeWithRecovery(remoteStoreImpl,function(){return remoteStoreImpl.remoteSyncer.applySuccessfulWrite(success)})];case 1:return _d.sent(),[4,fillWritePipeline(remoteStoreImpl)];case 2:return _d.sent(),[2]}})})}function onWriteStreamClose(remoteStoreImpl,error){return tslib.__awaiter(this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return error&&ensureWriteStream(remoteStoreImpl).handshakeComplete?[4,handleWriteError(remoteStoreImpl,error)]:[3,2];case 1:_d.sent(),_d.label=2;case 2:return shouldStartWriteStream(remoteStoreImpl)&&startWriteStream(remoteStoreImpl),[2]}})})}function handleWriteError(remoteStoreImpl,error){return tslib.__awaiter(this,void 0,void 0,function(){var batch_1;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return function isPermanentWriteError(code){return isPermanentError(code)&&code!==Code_ABORTED}(error.code)?(batch_1=remoteStoreImpl.writePipeline.shift(),ensureWriteStream(remoteStoreImpl).inhibitBackoff(),[4,executeWithRecovery(remoteStoreImpl,function(){return remoteStoreImpl.remoteSyncer.rejectFailedWrite(batch_1.batchId,error)})]):[3,3];case 1:return _d.sent(),[4,fillWritePipeline(remoteStoreImpl)];case 2:_d.sent(),_d.label=3;case 3:return[2]}})})}function restartNetwork(remoteStore){return tslib.__awaiter(this,void 0,void 0,function(){var remoteStoreImpl;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return(remoteStoreImpl=debugCast(remoteStore)).offlineCauses.add(4),[4,disableNetworkInternal(remoteStoreImpl)];case 1:return _d.sent(),remoteStoreImpl.onlineStateTracker.set("Unknown"),remoteStoreImpl.offlineCauses.delete(4),[4,enableNetworkInternal(remoteStoreImpl)];case 2:return _d.sent(),[2]}})})}function remoteStoreApplyPrimaryState(remoteStore,isPrimary){return tslib.__awaiter(this,void 0,void 0,function(){var remoteStoreImpl;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return remoteStoreImpl=debugCast(remoteStore),isPrimary?(remoteStoreImpl.offlineCauses.delete(2),[4,enableNetworkInternal(remoteStoreImpl)]):[3,2];case 1:return _d.sent(),[3,4];case 2:return isPrimary?[3,4]:(remoteStoreImpl.offlineCauses.add(2),[4,disableNetworkInternal(remoteStoreImpl)]);case 3:_d.sent(),remoteStoreImpl.onlineStateTracker.set("Unknown"),_d.label=4;case 4:return[2]}})})}function ensureWatchStream(remoteStoreImpl){var _this=this;return remoteStoreImpl.watchStream||(remoteStoreImpl.watchStream=function newPersistentWatchStream(datastore,queue,listener){var datastoreImpl=debugCast(datastore);return datastoreImpl.verifyInitialized(),new PersistentListenStream(queue,datastoreImpl.connection,datastoreImpl.credentials,datastoreImpl.serializer,listener)}(remoteStoreImpl.datastore,remoteStoreImpl.asyncQueue,{onOpen:onWatchStreamOpen.bind(null,remoteStoreImpl),onClose:onWatchStreamClose.bind(null,remoteStoreImpl),onWatchChange:onWatchStreamChange.bind(null,remoteStoreImpl)}),remoteStoreImpl.onNetworkStatusChange.push(function(enabled){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return enabled?(remoteStoreImpl.watchStream.inhibitBackoff(),shouldStartWatchStream(remoteStoreImpl)?startWatchStream(remoteStoreImpl):remoteStoreImpl.onlineStateTracker.set("Unknown"),[3,3]):[3,1];case 1:return[4,remoteStoreImpl.watchStream.stop()];case 2:_d.sent(),cleanUpWatchStreamState(remoteStoreImpl),_d.label=3;case 3:return[2]}})})})),remoteStoreImpl.watchStream}function ensureWriteStream(remoteStoreImpl){var _this=this;return remoteStoreImpl.writeStream||(remoteStoreImpl.writeStream=function newPersistentWriteStream(datastore,queue,listener){var datastoreImpl=debugCast(datastore);return datastoreImpl.verifyInitialized(),new PersistentWriteStream(queue,datastoreImpl.connection,datastoreImpl.credentials,datastoreImpl.serializer,listener)}(remoteStoreImpl.datastore,remoteStoreImpl.asyncQueue,{onOpen:onWriteStreamOpen.bind(null,remoteStoreImpl),onClose:onWriteStreamClose.bind(null,remoteStoreImpl),onHandshakeComplete:onWriteHandshakeComplete.bind(null,remoteStoreImpl),onMutationResult:onMutationResult.bind(null,remoteStoreImpl)}),remoteStoreImpl.onNetworkStatusChange.push(function(enabled){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return enabled?(remoteStoreImpl.writeStream.inhibitBackoff(),[4,fillWritePipeline(remoteStoreImpl)]):[3,2];case 1:return _d.sent(),[3,4];case 2:return[4,remoteStoreImpl.writeStream.stop()];case 3:_d.sent(),remoteStoreImpl.writePipeline.length>0&&(logDebug(LOG_TAG$5,"Stopping write stream with "+remoteStoreImpl.writePipeline.length+" pending writes"),remoteStoreImpl.writePipeline=[]),_d.label=4;case 4:return[2]}})})})),remoteStoreImpl.writeStream}var DelayedOperation=function(){function DelayedOperation(asyncQueue,timerId,targetTimeMs,op,removalCallback){this.asyncQueue=asyncQueue,this.timerId=timerId,this.targetTimeMs=targetTimeMs,this.op=op,this.removalCallback=removalCallback,this.deferred=new Deferred,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(function(err){})}return DelayedOperation.createAndSchedule=function(asyncQueue,timerId,delayMs,op,removalCallback){var delayedOp=new DelayedOperation(asyncQueue,timerId,Date.now()+delayMs,op,removalCallback);return delayedOp.start(delayMs),delayedOp},DelayedOperation.prototype.start=function(delayMs){var _this=this;this.timerHandle=setTimeout(function(){return _this.handleDelayElapsed()},delayMs)},DelayedOperation.prototype.skipDelay=function(){return this.handleDelayElapsed()},DelayedOperation.prototype.cancel=function(reason){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new FirestoreError(Code_CANCELLED,"Operation cancelled"+(reason?": "+reason:""))))},DelayedOperation.prototype.handleDelayElapsed=function(){var _this=this;this.asyncQueue.enqueueAndForget(function(){return null!==_this.timerHandle?(_this.clearTimeout(),_this.op().then(function(result){return _this.deferred.resolve(result)})):Promise.resolve()})},DelayedOperation.prototype.clearTimeout=function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)},DelayedOperation}();function wrapInUserErrorIfRecoverable(e,msg){if(logError("AsyncQueue",msg+": "+e),isIndexedDbTransactionError(e))return new FirestoreError(Code_UNAVAILABLE,msg+": "+e);throw e}var DocumentSet=function(){function DocumentSet(comp){this.comparator=comp?function(d1,d2){return comp(d1,d2)||DocumentKey.comparator(d1.key,d2.key)}:function(d1,d2){return DocumentKey.comparator(d1.key,d2.key)},this.keyedMap=documentMap(),this.sortedSet=new SortedMap(this.comparator)}return DocumentSet.emptySet=function(oldSet){return new DocumentSet(oldSet.comparator)},DocumentSet.prototype.has=function(key){return null!=this.keyedMap.get(key)},DocumentSet.prototype.get=function(key){return this.keyedMap.get(key)},DocumentSet.prototype.first=function(){return this.sortedSet.minKey()},DocumentSet.prototype.last=function(){return this.sortedSet.maxKey()},DocumentSet.prototype.isEmpty=function(){return this.sortedSet.isEmpty()},DocumentSet.prototype.indexOf=function(key){var doc=this.keyedMap.get(key);return doc?this.sortedSet.indexOf(doc):-1},Object.defineProperty(DocumentSet.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:!1,configurable:!0}),DocumentSet.prototype.forEach=function(cb){this.sortedSet.inorderTraversal(function(k,v){return cb(k),!1})},DocumentSet.prototype.add=function(doc){var set=this.delete(doc.key);return set.copy(set.keyedMap.insert(doc.key,doc),set.sortedSet.insert(doc,null))},DocumentSet.prototype.delete=function(key){var doc=this.get(key);return doc?this.copy(this.keyedMap.remove(key),this.sortedSet.remove(doc)):this},DocumentSet.prototype.isEqual=function(other){if(!(other instanceof DocumentSet))return!1;if(this.size!==other.size)return!1;for(var thisIt=this.sortedSet.getIterator(),otherIt=other.sortedSet.getIterator();thisIt.hasNext();){var thisDoc=thisIt.getNext().key,otherDoc=otherIt.getNext().key;if(!thisDoc.isEqual(otherDoc))return!1}return!0},DocumentSet.prototype.toString=function(){var docStrings=[];return this.forEach(function(doc){docStrings.push(doc.toString())}),0===docStrings.length?"DocumentSet ()":"DocumentSet (\n  "+docStrings.join("  \n")+"\n)"},DocumentSet.prototype.copy=function(keyedMap,sortedSet){var newSet=new DocumentSet;return newSet.comparator=this.comparator,newSet.keyedMap=keyedMap,newSet.sortedSet=sortedSet,newSet},DocumentSet}(),DocumentChangeSet=function(){function DocumentChangeSet(){this.changeMap=new SortedMap(DocumentKey.comparator)}return DocumentChangeSet.prototype.track=function(change){var key=change.doc.key,oldChange=this.changeMap.get(key);oldChange?0!==change.type&&3===oldChange.type?this.changeMap=this.changeMap.insert(key,change):3===change.type&&1!==oldChange.type?this.changeMap=this.changeMap.insert(key,{type:oldChange.type,doc:change.doc}):2===change.type&&2===oldChange.type?this.changeMap=this.changeMap.insert(key,{type:2,doc:change.doc}):2===change.type&&0===oldChange.type?this.changeMap=this.changeMap.insert(key,{type:0,doc:change.doc}):1===change.type&&0===oldChange.type?this.changeMap=this.changeMap.remove(key):1===change.type&&2===oldChange.type?this.changeMap=this.changeMap.insert(key,{type:1,doc:oldChange.doc}):0===change.type&&1===oldChange.type?this.changeMap=this.changeMap.insert(key,{type:2,doc:change.doc}):fail():this.changeMap=this.changeMap.insert(key,change)},DocumentChangeSet.prototype.getChanges=function(){var changes=[];return this.changeMap.inorderTraversal(function(key,change){changes.push(change)}),changes},DocumentChangeSet}(),ViewSnapshot=function(){function ViewSnapshot(query,docs,oldDocs,docChanges,mutatedKeys,fromCache,syncStateChanged,excludesMetadataChanges){this.query=query,this.docs=docs,this.oldDocs=oldDocs,this.docChanges=docChanges,this.mutatedKeys=mutatedKeys,this.fromCache=fromCache,this.syncStateChanged=syncStateChanged,this.excludesMetadataChanges=excludesMetadataChanges}return ViewSnapshot.fromInitialDocuments=function(query,documents,mutatedKeys,fromCache){var changes=[];return documents.forEach(function(doc){changes.push({type:0,doc:doc})}),new ViewSnapshot(query,documents,DocumentSet.emptySet(documents),changes,mutatedKeys,fromCache,!0,!1)},Object.defineProperty(ViewSnapshot.prototype,"hasPendingWrites",{get:function(){return!this.mutatedKeys.isEmpty()},enumerable:!1,configurable:!0}),ViewSnapshot.prototype.isEqual=function(other){if(!(this.fromCache===other.fromCache&&this.syncStateChanged===other.syncStateChanged&&this.mutatedKeys.isEqual(other.mutatedKeys)&&queryEquals(this.query,other.query)&&this.docs.isEqual(other.docs)&&this.oldDocs.isEqual(other.oldDocs)))return!1;var changes=this.docChanges,otherChanges=other.docChanges;if(changes.length!==otherChanges.length)return!1;for(var i=0;i<changes.length;i++)if(changes[i].type!==otherChanges[i].type||!changes[i].doc.isEqual(otherChanges[i].doc))return!1;return!0},ViewSnapshot}(),QueryListenersInfo=function QueryListenersInfo(){this.viewSnap=void 0,this.listeners=[]};var EventManagerImpl=function EventManagerImpl(){this.queries=new ObjectMap(function(q){return canonifyQuery(q)},queryEquals),this.onlineState="Unknown",this.snapshotsInSyncListeners=new Set};function eventManagerListen(eventManager,listener){return tslib.__awaiter(this,void 0,void 0,function(){var eventManagerImpl,query,firstListen,queryInfo,_d,e_7,firestoreError;return tslib.__generator(this,function(_e){switch(_e.label){case 0:if(eventManagerImpl=debugCast(eventManager),query=listener.query,firstListen=!1,(queryInfo=eventManagerImpl.queries.get(query))||(firstListen=!0,queryInfo=new QueryListenersInfo),!firstListen)return[3,4];_e.label=1;case 1:return _e.trys.push([1,3,,4]),_d=queryInfo,[4,eventManagerImpl.onListen(query)];case 2:return _d.viewSnap=_e.sent(),[3,4];case 3:return e_7=_e.sent(),firestoreError=wrapInUserErrorIfRecoverable(e_7,"Initialization of query '"+stringifyQuery(listener.query)+"' failed"),listener.onError(firestoreError),[2];case 4:return eventManagerImpl.queries.set(query,queryInfo),queryInfo.listeners.push(listener),listener.applyOnlineStateChange(eventManagerImpl.onlineState),queryInfo.viewSnap&&listener.onViewSnapshot(queryInfo.viewSnap)&&raiseSnapshotsInSyncEvent(eventManagerImpl),[2]}})})}function eventManagerUnlisten(eventManager,listener){return tslib.__awaiter(this,void 0,void 0,function(){var eventManagerImpl,query,lastListen,queryInfo,i;return tslib.__generator(this,function(_d){return eventManagerImpl=debugCast(eventManager),query=listener.query,lastListen=!1,(queryInfo=eventManagerImpl.queries.get(query))&&(i=queryInfo.listeners.indexOf(listener))>=0&&(queryInfo.listeners.splice(i,1),lastListen=0===queryInfo.listeners.length),lastListen?(eventManagerImpl.queries.delete(query),[2,eventManagerImpl.onUnlisten(query)]):[2]})})}function eventManagerOnWatchChange(eventManager,viewSnaps){for(var eventManagerImpl=debugCast(eventManager),raisedEvent=!1,_i=0,viewSnaps_1=viewSnaps;_i<viewSnaps_1.length;_i++){var viewSnap=viewSnaps_1[_i],query_1=viewSnap.query,queryInfo=eventManagerImpl.queries.get(query_1);if(queryInfo){for(var _d=0,_e=queryInfo.listeners;_d<_e.length;_d++){_e[_d].onViewSnapshot(viewSnap)&&(raisedEvent=!0)}queryInfo.viewSnap=viewSnap}}raisedEvent&&raiseSnapshotsInSyncEvent(eventManagerImpl)}function eventManagerOnWatchError(eventManager,query,error){var eventManagerImpl=debugCast(eventManager),queryInfo=eventManagerImpl.queries.get(query);if(queryInfo)for(var _i=0,_d=queryInfo.listeners;_i<_d.length;_i++){_d[_i].onError(error)}eventManagerImpl.queries.delete(query)}function addSnapshotsInSyncListener(eventManager,observer){debugCast(eventManager).snapshotsInSyncListeners.add(observer),observer.next()}function removeSnapshotsInSyncListener(eventManager,observer){debugCast(eventManager).snapshotsInSyncListeners.delete(observer)}function raiseSnapshotsInSyncEvent(eventManagerImpl){eventManagerImpl.snapshotsInSyncListeners.forEach(function(observer){observer.next()})}var QueryListener=function(){function QueryListener(query,queryObserver,options){this.query=query,this.queryObserver=queryObserver,this.raisedInitialEvent=!1,this.snap=null,this.onlineState="Unknown",this.options=options||{}}return QueryListener.prototype.onViewSnapshot=function(snap){if(!this.options.includeMetadataChanges){for(var docChanges=[],_i=0,_d=snap.docChanges;_i<_d.length;_i++){var docChange=_d[_i];3!==docChange.type&&docChanges.push(docChange)}snap=new ViewSnapshot(snap.query,snap.docs,snap.oldDocs,docChanges,snap.mutatedKeys,snap.fromCache,snap.syncStateChanged,!0)}var raisedEvent=!1;return this.raisedInitialEvent?this.shouldRaiseEvent(snap)&&(this.queryObserver.next(snap),raisedEvent=!0):this.shouldRaiseInitialEvent(snap,this.onlineState)&&(this.raiseInitialEvent(snap),raisedEvent=!0),this.snap=snap,raisedEvent},QueryListener.prototype.onError=function(error){this.queryObserver.error(error)},QueryListener.prototype.applyOnlineStateChange=function(onlineState){this.onlineState=onlineState;var raisedEvent=!1;return this.snap&&!this.raisedInitialEvent&&this.shouldRaiseInitialEvent(this.snap,onlineState)&&(this.raiseInitialEvent(this.snap),raisedEvent=!0),raisedEvent},QueryListener.prototype.shouldRaiseInitialEvent=function(snap,onlineState){if(!snap.fromCache)return!0;var maybeOnline="Offline"!==onlineState;return(!this.options.waitForSyncWhenOnline||!maybeOnline)&&(!snap.docs.isEmpty()||"Offline"===onlineState)},QueryListener.prototype.shouldRaiseEvent=function(snap){if(snap.docChanges.length>0)return!0;var hasPendingWritesChanged=this.snap&&this.snap.hasPendingWrites!==snap.hasPendingWrites;return!(!snap.syncStateChanged&&!hasPendingWritesChanged)&&!0===this.options.includeMetadataChanges},QueryListener.prototype.raiseInitialEvent=function(snap){snap=ViewSnapshot.fromInitialDocuments(snap.query,snap.docs,snap.mutatedKeys,snap.fromCache),this.raisedInitialEvent=!0,this.queryObserver.next(snap)},QueryListener}(),LocalViewChanges=function(){function LocalViewChanges(targetId,fromCache,addedKeys,removedKeys){this.targetId=targetId,this.fromCache=fromCache,this.addedKeys=addedKeys,this.removedKeys=removedKeys}return LocalViewChanges.fromSnapshot=function(targetId,viewSnapshot){for(var addedKeys=documentKeySet(),removedKeys=documentKeySet(),_i=0,_d=viewSnapshot.docChanges;_i<_d.length;_i++){var docChange=_d[_i];switch(docChange.type){case 0:addedKeys=addedKeys.add(docChange.doc.key);break;case 1:removedKeys=removedKeys.add(docChange.doc.key)}}return new LocalViewChanges(targetId,viewSnapshot.fromCache,addedKeys,removedKeys)},LocalViewChanges}(),BundleLoadResult=function BundleLoadResult(progress,changedDocs){this.progress=progress,this.changedDocs=changedDocs},BundleConverterImpl=function(){function BundleConverterImpl(serializer){this.serializer=serializer}return BundleConverterImpl.prototype.toDocumentKey=function(name){return fromName(this.serializer,name)},BundleConverterImpl.prototype.toMutableDocument=function(bundledDoc){return bundledDoc.metadata.exists?fromDocument(this.serializer,bundledDoc.document,!1):MutableDocument.newNoDocument(this.toDocumentKey(bundledDoc.metadata.name),this.toSnapshotVersion(bundledDoc.metadata.readTime))},BundleConverterImpl.prototype.toSnapshotVersion=function(time){return fromVersion(time)},BundleConverterImpl}(),BundleLoader=function(){function BundleLoader(bundleMetadata,localStore,serializer){this.bundleMetadata=bundleMetadata,this.localStore=localStore,this.serializer=serializer,this.queries=[],this.documents=[],this.progress=bundleInitialProgress(bundleMetadata)}return BundleLoader.prototype.addSizedElement=function(element){this.progress.bytesLoaded+=element.byteLength;var documentsLoaded=this.progress.documentsLoaded;return element.payload.namedQuery?this.queries.push(element.payload.namedQuery):element.payload.documentMetadata?(this.documents.push({metadata:element.payload.documentMetadata}),element.payload.documentMetadata.exists||++documentsLoaded):element.payload.document&&(this.documents[this.documents.length-1].document=element.payload.document,++documentsLoaded),documentsLoaded!==this.progress.documentsLoaded?(this.progress.documentsLoaded=documentsLoaded,Object.assign({},this.progress)):null},BundleLoader.prototype.getQueryDocumentMapping=function(documents){for(var queryDocumentMap=new Map,bundleConverter=new BundleConverterImpl(this.serializer),_i=0,documents_2=documents;_i<documents_2.length;_i++){var bundleDoc=documents_2[_i];if(bundleDoc.metadata.queries)for(var documentKey=bundleConverter.toDocumentKey(bundleDoc.metadata.name),_d=0,_e=bundleDoc.metadata.queries;_d<_e.length;_d++){var queryName=_e[_d],documentKeys=(queryDocumentMap.get(queryName)||documentKeySet()).add(documentKey);queryDocumentMap.set(queryName,documentKeys)}}return queryDocumentMap},BundleLoader.prototype.complete=function(){return tslib.__awaiter(this,void 0,void 0,function(){var changedDocuments,queryDocumentMap,_i,_d,q;return tslib.__generator(this,function(_e){switch(_e.label){case 0:return[4,localStoreApplyBundledDocuments(this.localStore,new BundleConverterImpl(this.serializer),this.documents,this.bundleMetadata.id)];case 1:changedDocuments=_e.sent(),queryDocumentMap=this.getQueryDocumentMapping(this.documents),_i=0,_d=this.queries,_e.label=2;case 2:return _i<_d.length?(q=_d[_i],[4,localStoreSaveNamedQuery(this.localStore,q,queryDocumentMap.get(q.name))]):[3,5];case 3:_e.sent(),_e.label=4;case 4:return _i++,[3,2];case 5:return this.progress.taskState="Success",[2,new BundleLoadResult(Object.assign({},this.progress),changedDocuments)]}})})},BundleLoader}();function bundleInitialProgress(metadata){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:metadata.totalDocuments,totalBytes:metadata.totalBytes}}var AddedLimboDocument=function AddedLimboDocument(key){this.key=key},RemovedLimboDocument=function RemovedLimboDocument(key){this.key=key},View=function(){function View(query,_syncedDocuments){this.query=query,this._syncedDocuments=_syncedDocuments,this.syncState=null,this.current=!1,this.limboDocuments=documentKeySet(),this.mutatedKeys=documentKeySet(),this.docComparator=newQueryComparator(query),this.documentSet=new DocumentSet(this.docComparator)}return Object.defineProperty(View.prototype,"syncedDocuments",{get:function(){return this._syncedDocuments},enumerable:!1,configurable:!0}),View.prototype.computeDocChanges=function(docChanges,previousChanges){var _this=this,changeSet=previousChanges?previousChanges.changeSet:new DocumentChangeSet,oldDocumentSet=previousChanges?previousChanges.documentSet:this.documentSet,newMutatedKeys=previousChanges?previousChanges.mutatedKeys:this.mutatedKeys,newDocumentSet=oldDocumentSet,needsRefill=!1,lastDocInLimit=hasLimitToFirst(this.query)&&oldDocumentSet.size===this.query.limit?oldDocumentSet.last():null,firstDocInLimit=hasLimitToLast(this.query)&&oldDocumentSet.size===this.query.limit?oldDocumentSet.first():null;if(docChanges.inorderTraversal(function(key,entry){var oldDoc=oldDocumentSet.get(key),newDoc=queryMatches(_this.query,entry)?entry:null,oldDocHadPendingMutations=!!oldDoc&&_this.mutatedKeys.has(oldDoc.key),newDocHasPendingMutations=!!newDoc&&(newDoc.hasLocalMutations||_this.mutatedKeys.has(newDoc.key)&&newDoc.hasCommittedMutations),changeApplied=!1;oldDoc&&newDoc?oldDoc.data.isEqual(newDoc.data)?oldDocHadPendingMutations!==newDocHasPendingMutations&&(changeSet.track({type:3,doc:newDoc}),changeApplied=!0):_this.shouldWaitForSyncedDocument(oldDoc,newDoc)||(changeSet.track({type:2,doc:newDoc}),changeApplied=!0,(lastDocInLimit&&_this.docComparator(newDoc,lastDocInLimit)>0||firstDocInLimit&&_this.docComparator(newDoc,firstDocInLimit)<0)&&(needsRefill=!0)):!oldDoc&&newDoc?(changeSet.track({type:0,doc:newDoc}),changeApplied=!0):oldDoc&&!newDoc&&(changeSet.track({type:1,doc:oldDoc}),changeApplied=!0,(lastDocInLimit||firstDocInLimit)&&(needsRefill=!0));changeApplied&&(newDoc?(newDocumentSet=newDocumentSet.add(newDoc),newMutatedKeys=newDocHasPendingMutations?newMutatedKeys.add(key):newMutatedKeys.delete(key)):(newDocumentSet=newDocumentSet.delete(key),newMutatedKeys=newMutatedKeys.delete(key)))}),hasLimitToFirst(this.query)||hasLimitToLast(this.query))for(;newDocumentSet.size>this.query.limit;){var oldDoc=hasLimitToFirst(this.query)?newDocumentSet.last():newDocumentSet.first();newDocumentSet=newDocumentSet.delete(oldDoc.key),newMutatedKeys=newMutatedKeys.delete(oldDoc.key),changeSet.track({type:1,doc:oldDoc})}return{documentSet:newDocumentSet,changeSet:changeSet,needsRefill:needsRefill,mutatedKeys:newMutatedKeys}},View.prototype.shouldWaitForSyncedDocument=function(oldDoc,newDoc){return oldDoc.hasLocalMutations&&newDoc.hasCommittedMutations&&!newDoc.hasLocalMutations},View.prototype.applyChanges=function(docChanges,updateLimboDocuments,targetChange){var _this=this,oldDocs=this.documentSet;this.documentSet=docChanges.documentSet,this.mutatedKeys=docChanges.mutatedKeys;var changes=docChanges.changeSet.getChanges();changes.sort(function(c1,c2){return function compareChangeType(c1,c2){var order=function(change){switch(change){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return fail()}};return order(c1)-order(c2)}(c1.type,c2.type)||_this.docComparator(c1.doc,c2.doc)}),this.applyTargetChange(targetChange);var limboChanges=updateLimboDocuments?this.updateLimboDocuments():[],newSyncState=0===this.limboDocuments.size&&this.current?1:0,syncStateChanged=newSyncState!==this.syncState;return this.syncState=newSyncState,0!==changes.length||syncStateChanged?{snapshot:new ViewSnapshot(this.query,docChanges.documentSet,oldDocs,changes,docChanges.mutatedKeys,0===newSyncState,syncStateChanged,!1),limboChanges:limboChanges}:{limboChanges:limboChanges}},View.prototype.applyOnlineStateChange=function(onlineState){return this.current&&"Offline"===onlineState?(this.current=!1,this.applyChanges({documentSet:this.documentSet,changeSet:new DocumentChangeSet,mutatedKeys:this.mutatedKeys,needsRefill:!1},!1)):{limboChanges:[]}},View.prototype.shouldBeInLimbo=function(key){return!this._syncedDocuments.has(key)&&(!!this.documentSet.has(key)&&!this.documentSet.get(key).hasLocalMutations)},View.prototype.applyTargetChange=function(targetChange){var _this=this;targetChange&&(targetChange.addedDocuments.forEach(function(key){return _this._syncedDocuments=_this._syncedDocuments.add(key)}),targetChange.modifiedDocuments.forEach(function(key){}),targetChange.removedDocuments.forEach(function(key){return _this._syncedDocuments=_this._syncedDocuments.delete(key)}),this.current=targetChange.current)},View.prototype.updateLimboDocuments=function(){var _this=this;if(!this.current)return[];var oldLimboDocuments=this.limboDocuments;this.limboDocuments=documentKeySet(),this.documentSet.forEach(function(doc){_this.shouldBeInLimbo(doc.key)&&(_this.limboDocuments=_this.limboDocuments.add(doc.key))});var changes=[];return oldLimboDocuments.forEach(function(key){_this.limboDocuments.has(key)||changes.push(new RemovedLimboDocument(key))}),this.limboDocuments.forEach(function(key){oldLimboDocuments.has(key)||changes.push(new AddedLimboDocument(key))}),changes},View.prototype.synchronizeWithPersistedState=function(queryResult){this._syncedDocuments=queryResult.remoteKeys,this.limboDocuments=documentKeySet();var docChanges=this.computeDocChanges(queryResult.documents);return this.applyChanges(docChanges,!0)},View.prototype.computeInitialSnapshot=function(){return ViewSnapshot.fromInitialDocuments(this.query,this.documentSet,this.mutatedKeys,0===this.syncState)},View}();var LOG_TAG$3="SyncEngine",QueryView=function QueryView(query,targetId,view){this.query=query,this.targetId=targetId,this.view=view},LimboResolution=function LimboResolution(key){this.key=key,this.receivedDocument=!1},SyncEngineImpl=function(){function SyncEngineImpl(localStore,remoteStore,eventManager,sharedClientState,currentUser,maxConcurrentLimboResolutions){this.localStore=localStore,this.remoteStore=remoteStore,this.eventManager=eventManager,this.sharedClientState=sharedClientState,this.currentUser=currentUser,this.maxConcurrentLimboResolutions=maxConcurrentLimboResolutions,this.syncEngineListener={},this.queryViewsByQuery=new ObjectMap(function(q){return canonifyQuery(q)},queryEquals),this.queriesByTarget=new Map,this.enqueuedLimboResolutions=new Set,this.activeLimboTargetsByKey=new SortedMap(DocumentKey.comparator),this.activeLimboResolutionsByTarget=new Map,this.limboDocumentRefs=new ReferenceSet,this.mutationUserCallbacks={},this.pendingWritesCallbacks=new Map,this.limboTargetIdGenerator=TargetIdGenerator.forSyncEngine(),this.onlineState="Unknown",this._isPrimaryClient=void 0}return Object.defineProperty(SyncEngineImpl.prototype,"isPrimaryClient",{get:function(){return!0===this._isPrimaryClient},enumerable:!1,configurable:!0}),SyncEngineImpl}();function syncEngineListen(syncEngine,query){return tslib.__awaiter(this,void 0,void 0,function(){var syncEngineImpl,targetId,viewSnapshot,queryView,targetData,status_1;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return syncEngineImpl=ensureWatchCallbacks(syncEngine),(queryView=syncEngineImpl.queryViewsByQuery.get(query))?(targetId=queryView.targetId,syncEngineImpl.sharedClientState.addLocalQueryTarget(targetId),viewSnapshot=queryView.view.computeInitialSnapshot(),[3,4]):[3,1];case 1:return[4,localStoreAllocateTarget(syncEngineImpl.localStore,queryToTarget(query))];case 2:return targetData=_d.sent(),status_1=syncEngineImpl.sharedClientState.addLocalQueryTarget(targetData.targetId),targetId=targetData.targetId,[4,initializeViewAndComputeSnapshot(syncEngineImpl,query,targetId,"current"===status_1)];case 3:viewSnapshot=_d.sent(),syncEngineImpl.isPrimaryClient&&remoteStoreListen(syncEngineImpl.remoteStore,targetData),_d.label=4;case 4:return[2,viewSnapshot]}})})}function initializeViewAndComputeSnapshot(syncEngineImpl,query,targetId,current){return tslib.__awaiter(this,void 0,void 0,function(){var queryResult,view,viewDocChanges,synthesizedTargetChange,viewChange,data;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return syncEngineImpl.applyDocChanges=function(queryView,changes,remoteEvent){return function applyDocChanges(syncEngineImpl,queryView,changes,remoteEvent){return tslib.__awaiter(this,void 0,void 0,function(){var viewDocChanges,targetChange,viewChange;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return(viewDocChanges=queryView.view.computeDocChanges(changes)).needsRefill?[4,localStoreExecuteQuery(syncEngineImpl.localStore,queryView.query,!1).then(function(_d){var documents=_d.documents;return queryView.view.computeDocChanges(documents,viewDocChanges)})]:[3,2];case 1:viewDocChanges=_d.sent(),_d.label=2;case 2:return targetChange=remoteEvent&&remoteEvent.targetChanges.get(queryView.targetId),viewChange=queryView.view.applyChanges(viewDocChanges,syncEngineImpl.isPrimaryClient,targetChange),updateTrackedLimbos(syncEngineImpl,queryView.targetId,viewChange.limboChanges),[2,viewChange.snapshot]}})})}(syncEngineImpl,queryView,changes,remoteEvent)},[4,localStoreExecuteQuery(syncEngineImpl.localStore,query,!0)];case 1:return queryResult=_d.sent(),view=new View(query,queryResult.remoteKeys),viewDocChanges=view.computeDocChanges(queryResult.documents),synthesizedTargetChange=TargetChange.createSynthesizedTargetChangeForCurrentChange(targetId,current&&"Offline"!==syncEngineImpl.onlineState),viewChange=view.applyChanges(viewDocChanges,syncEngineImpl.isPrimaryClient,synthesizedTargetChange),updateTrackedLimbos(syncEngineImpl,targetId,viewChange.limboChanges),data=new QueryView(query,targetId,view),syncEngineImpl.queryViewsByQuery.set(query,data),syncEngineImpl.queriesByTarget.has(targetId)?syncEngineImpl.queriesByTarget.get(targetId).push(query):syncEngineImpl.queriesByTarget.set(targetId,[query]),[2,viewChange.snapshot]}})})}function syncEngineUnlisten(syncEngine,query){return tslib.__awaiter(this,void 0,void 0,function(){var syncEngineImpl,queryView,queries;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return syncEngineImpl=debugCast(syncEngine),queryView=syncEngineImpl.queryViewsByQuery.get(query),(queries=syncEngineImpl.queriesByTarget.get(queryView.targetId)).length>1?(syncEngineImpl.queriesByTarget.set(queryView.targetId,queries.filter(function(q){return!queryEquals(q,query)})),syncEngineImpl.queryViewsByQuery.delete(query),[2]):syncEngineImpl.isPrimaryClient?(syncEngineImpl.sharedClientState.removeLocalQueryTarget(queryView.targetId),syncEngineImpl.sharedClientState.isActiveQueryTarget(queryView.targetId)?[3,2]:[4,localStoreReleaseTarget(syncEngineImpl.localStore,queryView.targetId,!1).then(function(){syncEngineImpl.sharedClientState.clearQueryState(queryView.targetId),remoteStoreUnlisten(syncEngineImpl.remoteStore,queryView.targetId),removeAndCleanupTarget(syncEngineImpl,queryView.targetId)}).catch(ignoreIfPrimaryLeaseLoss)]):[3,3];case 1:_d.sent(),_d.label=2;case 2:return[3,5];case 3:return removeAndCleanupTarget(syncEngineImpl,queryView.targetId),[4,localStoreReleaseTarget(syncEngineImpl.localStore,queryView.targetId,!0)];case 4:_d.sent(),_d.label=5;case 5:return[2]}})})}function syncEngineWrite(syncEngine,batch,userCallback){return tslib.__awaiter(this,void 0,void 0,function(){var syncEngineImpl,result,e_8,error;return tslib.__generator(this,function(_d){switch(_d.label){case 0:syncEngineImpl=syncEngineEnsureWriteCallbacks(syncEngine),_d.label=1;case 1:return _d.trys.push([1,5,,6]),[4,(localStore=syncEngineImpl.localStore,mutations=batch,localStoreImpl=debugCast(localStore),localWriteTime=Timestamp.now(),keys=mutations.reduce(function(keys,m){return keys.add(m.key)},documentKeySet()),localStoreImpl.persistence.runTransaction("Locally write mutations","readwrite",function(txn){return localStoreImpl.localDocuments.getDocuments(txn,keys).next(function(docs){existingDocs=docs;for(var baseMutations=[],_i=0,mutations_2=mutations;_i<mutations_2.length;_i++){var mutation=mutations_2[_i],baseValue=extractMutationBaseValue(mutation,existingDocs.get(mutation.key));null!=baseValue&&baseMutations.push(new PatchMutation(mutation.key,baseValue,extractFieldMask(baseValue.value.mapValue),Precondition.exists(!0)))}return localStoreImpl.mutationQueue.addMutationBatch(txn,localWriteTime,baseMutations,mutations)})}).then(function(batch){return batch.applyToLocalDocumentSet(existingDocs),{batchId:batch.batchId,changes:existingDocs}}))];case 2:return result=_d.sent(),syncEngineImpl.sharedClientState.addPendingMutation(result.batchId),function addMutationCallback(syncEngineImpl,batchId,callback){var newCallbacks=syncEngineImpl.mutationUserCallbacks[syncEngineImpl.currentUser.toKey()];newCallbacks||(newCallbacks=new SortedMap(primitiveComparator));newCallbacks=newCallbacks.insert(batchId,callback),syncEngineImpl.mutationUserCallbacks[syncEngineImpl.currentUser.toKey()]=newCallbacks}(syncEngineImpl,result.batchId,userCallback),[4,syncEngineEmitNewSnapsAndNotifyLocalStore(syncEngineImpl,result.changes)];case 3:return _d.sent(),[4,fillWritePipeline(syncEngineImpl.remoteStore)];case 4:return _d.sent(),[3,6];case 5:return e_8=_d.sent(),error=wrapInUserErrorIfRecoverable(e_8,"Failed to persist write"),userCallback.reject(error),[3,6];case 6:return[2]}var localStore,mutations,existingDocs,localStoreImpl,localWriteTime,keys})})}function syncEngineApplyRemoteEvent(syncEngine,remoteEvent){return tslib.__awaiter(this,void 0,void 0,function(){var syncEngineImpl,changes;return tslib.__generator(this,function(_d){switch(_d.label){case 0:syncEngineImpl=debugCast(syncEngine),_d.label=1;case 1:return _d.trys.push([1,4,,6]),[4,localStoreApplyRemoteEventToLocalCache(syncEngineImpl.localStore,remoteEvent)];case 2:return changes=_d.sent(),remoteEvent.targetChanges.forEach(function(targetChange,targetId){var limboResolution=syncEngineImpl.activeLimboResolutionsByTarget.get(targetId);limboResolution&&(hardAssert(targetChange.addedDocuments.size+targetChange.modifiedDocuments.size+targetChange.removedDocuments.size<=1),targetChange.addedDocuments.size>0?limboResolution.receivedDocument=!0:targetChange.modifiedDocuments.size>0?hardAssert(limboResolution.receivedDocument):targetChange.removedDocuments.size>0&&(hardAssert(limboResolution.receivedDocument),limboResolution.receivedDocument=!1))}),[4,syncEngineEmitNewSnapsAndNotifyLocalStore(syncEngineImpl,changes,remoteEvent)];case 3:return _d.sent(),[3,6];case 4:return[4,ignoreIfPrimaryLeaseLoss(_d.sent())];case 5:return _d.sent(),[3,6];case 6:return[2]}})})}function syncEngineApplyOnlineStateChange(syncEngine,onlineState,source){var syncEngineImpl=debugCast(syncEngine);if(syncEngineImpl.isPrimaryClient&&0===source||!syncEngineImpl.isPrimaryClient&&1===source){var newViewSnapshots_1=[];syncEngineImpl.queryViewsByQuery.forEach(function(query,queryView){var viewChange=queryView.view.applyOnlineStateChange(onlineState);viewChange.snapshot&&newViewSnapshots_1.push(viewChange.snapshot)}),function eventManagerOnOnlineStateChange(eventManager,onlineState){var eventManagerImpl=debugCast(eventManager);eventManagerImpl.onlineState=onlineState;var raisedEvent=!1;eventManagerImpl.queries.forEach(function(_,queryInfo){for(var _i=0,_d=queryInfo.listeners;_i<_d.length;_i++)_d[_i].applyOnlineStateChange(onlineState)&&(raisedEvent=!0)}),raisedEvent&&raiseSnapshotsInSyncEvent(eventManagerImpl)}(syncEngineImpl.eventManager,onlineState),newViewSnapshots_1.length&&syncEngineImpl.syncEngineListener.onWatchChange(newViewSnapshots_1),syncEngineImpl.onlineState=onlineState,syncEngineImpl.isPrimaryClient&&syncEngineImpl.sharedClientState.setOnlineState(onlineState)}}function syncEngineRejectListen(syncEngine,targetId,err){return tslib.__awaiter(this,void 0,void 0,function(){var syncEngineImpl,limboResolution,limboKey,documentUpdates,resolvedLimboDocuments,event_2;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return(syncEngineImpl=debugCast(syncEngine)).sharedClientState.updateQueryState(targetId,"rejected",err),limboResolution=syncEngineImpl.activeLimboResolutionsByTarget.get(targetId),(limboKey=limboResolution&&limboResolution.key)?(documentUpdates=(documentUpdates=new SortedMap(DocumentKey.comparator)).insert(limboKey,MutableDocument.newNoDocument(limboKey,SnapshotVersion.min())),resolvedLimboDocuments=documentKeySet().add(limboKey),event_2=new RemoteEvent(SnapshotVersion.min(),new Map,new SortedSet(primitiveComparator),documentUpdates,resolvedLimboDocuments),[4,syncEngineApplyRemoteEvent(syncEngineImpl,event_2)]):[3,2];case 1:return _d.sent(),syncEngineImpl.activeLimboTargetsByKey=syncEngineImpl.activeLimboTargetsByKey.remove(limboKey),syncEngineImpl.activeLimboResolutionsByTarget.delete(targetId),pumpEnqueuedLimboResolutions(syncEngineImpl),[3,4];case 2:return[4,localStoreReleaseTarget(syncEngineImpl.localStore,targetId,!1).then(function(){return removeAndCleanupTarget(syncEngineImpl,targetId,err)}).catch(ignoreIfPrimaryLeaseLoss)];case 3:_d.sent(),_d.label=4;case 4:return[2]}})})}function syncEngineApplySuccessfulWrite(syncEngine,mutationBatchResult){return tslib.__awaiter(this,void 0,void 0,function(){var syncEngineImpl,batchId,changes;return tslib.__generator(this,function(_d){switch(_d.label){case 0:syncEngineImpl=debugCast(syncEngine),batchId=mutationBatchResult.batch.batchId,_d.label=1;case 1:return _d.trys.push([1,4,,6]),[4,localStoreAcknowledgeBatch(syncEngineImpl.localStore,mutationBatchResult)];case 2:return changes=_d.sent(),processUserCallback(syncEngineImpl,batchId,null),triggerPendingWritesCallbacks(syncEngineImpl,batchId),syncEngineImpl.sharedClientState.updateMutationState(batchId,"acknowledged"),[4,syncEngineEmitNewSnapsAndNotifyLocalStore(syncEngineImpl,changes)];case 3:return _d.sent(),[3,6];case 4:return[4,ignoreIfPrimaryLeaseLoss(_d.sent())];case 5:return _d.sent(),[3,6];case 6:return[2]}})})}function syncEngineRejectFailedWrite(syncEngine,batchId,error){return tslib.__awaiter(this,void 0,void 0,function(){var syncEngineImpl,changes;return tslib.__generator(this,function(_d){switch(_d.label){case 0:syncEngineImpl=debugCast(syncEngine),_d.label=1;case 1:return _d.trys.push([1,4,,6]),[4,localStoreRejectBatch(syncEngineImpl.localStore,batchId)];case 2:return changes=_d.sent(),processUserCallback(syncEngineImpl,batchId,error),triggerPendingWritesCallbacks(syncEngineImpl,batchId),syncEngineImpl.sharedClientState.updateMutationState(batchId,"rejected",error),[4,syncEngineEmitNewSnapsAndNotifyLocalStore(syncEngineImpl,changes)];case 3:return _d.sent(),[3,6];case 4:return[4,ignoreIfPrimaryLeaseLoss(_d.sent())];case 5:return _d.sent(),[3,6];case 6:return[2]}})})}function syncEngineRegisterPendingWritesCallback(syncEngine,callback){return tslib.__awaiter(this,void 0,void 0,function(){var syncEngineImpl,highestBatchId,callbacks,e_9,firestoreError;return tslib.__generator(this,function(_d){switch(_d.label){case 0:canUseNetwork((syncEngineImpl=debugCast(syncEngine)).remoteStore)||logDebug(LOG_TAG$3,"The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled."),_d.label=1;case 1:return _d.trys.push([1,3,,4]),[4,(localStore=syncEngineImpl.localStore,localStoreImpl=debugCast(localStore),localStoreImpl.persistence.runTransaction("Get highest unacknowledged batch id","readonly",function(txn){return localStoreImpl.mutationQueue.getHighestUnacknowledgedBatchId(txn)}))];case 2:return-1===(highestBatchId=_d.sent())?(callback.resolve(),[2]):((callbacks=syncEngineImpl.pendingWritesCallbacks.get(highestBatchId)||[]).push(callback),syncEngineImpl.pendingWritesCallbacks.set(highestBatchId,callbacks),[3,4]);case 3:return e_9=_d.sent(),firestoreError=wrapInUserErrorIfRecoverable(e_9,"Initialization of waitForPendingWrites() operation failed"),callback.reject(firestoreError),[3,4];case 4:return[2]}var localStore,localStoreImpl})})}function triggerPendingWritesCallbacks(syncEngineImpl,batchId){(syncEngineImpl.pendingWritesCallbacks.get(batchId)||[]).forEach(function(callback){callback.resolve()}),syncEngineImpl.pendingWritesCallbacks.delete(batchId)}function processUserCallback(syncEngine,batchId,error){var syncEngineImpl=debugCast(syncEngine),newCallbacks=syncEngineImpl.mutationUserCallbacks[syncEngineImpl.currentUser.toKey()];if(newCallbacks){var callback=newCallbacks.get(batchId);callback&&(error?callback.reject(error):callback.resolve(),newCallbacks=newCallbacks.remove(batchId)),syncEngineImpl.mutationUserCallbacks[syncEngineImpl.currentUser.toKey()]=newCallbacks}}function removeAndCleanupTarget(syncEngineImpl,targetId,error){void 0===error&&(error=null),syncEngineImpl.sharedClientState.removeLocalQueryTarget(targetId);for(var _i=0,_d=syncEngineImpl.queriesByTarget.get(targetId);_i<_d.length;_i++){var query_2=_d[_i];syncEngineImpl.queryViewsByQuery.delete(query_2),error&&syncEngineImpl.syncEngineListener.onWatchError(query_2,error)}(syncEngineImpl.queriesByTarget.delete(targetId),syncEngineImpl.isPrimaryClient)&&syncEngineImpl.limboDocumentRefs.removeReferencesForId(targetId).forEach(function(limboKey){syncEngineImpl.limboDocumentRefs.containsKey(limboKey)||removeLimboTarget(syncEngineImpl,limboKey)})}function removeLimboTarget(syncEngineImpl,key){syncEngineImpl.enqueuedLimboResolutions.delete(key.path.canonicalString());var limboTargetId=syncEngineImpl.activeLimboTargetsByKey.get(key);null!==limboTargetId&&(remoteStoreUnlisten(syncEngineImpl.remoteStore,limboTargetId),syncEngineImpl.activeLimboTargetsByKey=syncEngineImpl.activeLimboTargetsByKey.remove(key),syncEngineImpl.activeLimboResolutionsByTarget.delete(limboTargetId),pumpEnqueuedLimboResolutions(syncEngineImpl))}function updateTrackedLimbos(syncEngineImpl,targetId,limboChanges){for(var _i=0,limboChanges_1=limboChanges;_i<limboChanges_1.length;_i++){var limboChange=limboChanges_1[_i];if(limboChange instanceof AddedLimboDocument)syncEngineImpl.limboDocumentRefs.addReference(limboChange.key,targetId),trackLimboChange(syncEngineImpl,limboChange);else if(limboChange instanceof RemovedLimboDocument){logDebug(LOG_TAG$3,"Document no longer in limbo: "+limboChange.key),syncEngineImpl.limboDocumentRefs.removeReference(limboChange.key,targetId),syncEngineImpl.limboDocumentRefs.containsKey(limboChange.key)||removeLimboTarget(syncEngineImpl,limboChange.key)}else fail()}}function trackLimboChange(syncEngineImpl,limboChange){var key=limboChange.key,keyString=key.path.canonicalString();syncEngineImpl.activeLimboTargetsByKey.get(key)||syncEngineImpl.enqueuedLimboResolutions.has(keyString)||(logDebug(LOG_TAG$3,"New document in limbo: "+key),syncEngineImpl.enqueuedLimboResolutions.add(keyString),pumpEnqueuedLimboResolutions(syncEngineImpl))}function pumpEnqueuedLimboResolutions(syncEngineImpl){for(;syncEngineImpl.enqueuedLimboResolutions.size>0&&syncEngineImpl.activeLimboTargetsByKey.size<syncEngineImpl.maxConcurrentLimboResolutions;){var keyString=syncEngineImpl.enqueuedLimboResolutions.values().next().value;syncEngineImpl.enqueuedLimboResolutions.delete(keyString);var key=new DocumentKey(ResourcePath.fromString(keyString)),limboTargetId=syncEngineImpl.limboTargetIdGenerator.next();syncEngineImpl.activeLimboResolutionsByTarget.set(limboTargetId,new LimboResolution(key)),syncEngineImpl.activeLimboTargetsByKey=syncEngineImpl.activeLimboTargetsByKey.insert(key,limboTargetId),remoteStoreListen(syncEngineImpl.remoteStore,new TargetData(queryToTarget(newQueryForPath(key.path)),limboTargetId,2,ListenSequence.INVALID))}}function syncEngineEmitNewSnapsAndNotifyLocalStore(syncEngine,changes,remoteEvent){return tslib.__awaiter(this,void 0,void 0,function(){var syncEngineImpl,newSnaps,docChangesInAllViews,queriesProcessed;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return syncEngineImpl=debugCast(syncEngine),newSnaps=[],docChangesInAllViews=[],queriesProcessed=[],syncEngineImpl.queryViewsByQuery.isEmpty()?[2]:(syncEngineImpl.queryViewsByQuery.forEach(function(_,queryView){queriesProcessed.push(syncEngineImpl.applyDocChanges(queryView,changes,remoteEvent).then(function(viewSnapshot){if(viewSnapshot){syncEngineImpl.isPrimaryClient&&syncEngineImpl.sharedClientState.updateQueryState(queryView.targetId,viewSnapshot.fromCache?"not-current":"current"),newSnaps.push(viewSnapshot);var docChanges=LocalViewChanges.fromSnapshot(queryView.targetId,viewSnapshot);docChangesInAllViews.push(docChanges)}}))}),[4,Promise.all(queriesProcessed)]);case 1:return _d.sent(),syncEngineImpl.syncEngineListener.onWatchChange(newSnaps),[4,localStoreNotifyLocalViewChanges(syncEngineImpl.localStore,docChangesInAllViews)];case 2:return _d.sent(),[2]}})})}function syncEngineHandleCredentialChange(syncEngine,user){return tslib.__awaiter(this,void 0,void 0,function(){var syncEngineImpl,result;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return syncEngineImpl=debugCast(syncEngine),!syncEngineImpl.currentUser.isEqual(user)?(logDebug(LOG_TAG$3,"User change. New user:",user.toKey()),[4,localStoreHandleUserChange(syncEngineImpl.localStore,user)]):[3,3];case 1:return result=_d.sent(),syncEngineImpl.currentUser=user,function rejectOutstandingPendingWritesCallbacks(syncEngineImpl,errorMessage){syncEngineImpl.pendingWritesCallbacks.forEach(function(callbacks){callbacks.forEach(function(callback){callback.reject(new FirestoreError(Code_CANCELLED,errorMessage))})}),syncEngineImpl.pendingWritesCallbacks.clear()}(syncEngineImpl,"'waitForPendingWrites' promise is rejected due to a user change."),syncEngineImpl.sharedClientState.handleUserChange(user,result.removedBatchIds,result.addedBatchIds),[4,syncEngineEmitNewSnapsAndNotifyLocalStore(syncEngineImpl,result.affectedDocuments)];case 2:_d.sent(),_d.label=3;case 3:return[2]}})})}function syncEngineGetRemoteKeysForTarget(syncEngine,targetId){var syncEngineImpl=debugCast(syncEngine),limboResolution=syncEngineImpl.activeLimboResolutionsByTarget.get(targetId);if(limboResolution&&limboResolution.receivedDocument)return documentKeySet().add(limboResolution.key);var keySet=documentKeySet(),queries=syncEngineImpl.queriesByTarget.get(targetId);if(!queries)return keySet;for(var _i=0,queries_1=queries;_i<queries_1.length;_i++){var query_3=queries_1[_i],queryView=syncEngineImpl.queryViewsByQuery.get(query_3);keySet=keySet.unionWith(queryView.view.syncedDocuments)}return keySet}function synchronizeViewAndComputeSnapshot(syncEngine,queryView){return tslib.__awaiter(this,void 0,void 0,function(){var syncEngineImpl,queryResult,viewSnapshot;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,localStoreExecuteQuery((syncEngineImpl=debugCast(syncEngine)).localStore,queryView.query,!0)];case 1:return queryResult=_d.sent(),viewSnapshot=queryView.view.synchronizeWithPersistedState(queryResult),syncEngineImpl.isPrimaryClient&&updateTrackedLimbos(syncEngineImpl,queryView.targetId,viewSnapshot.limboChanges),[2,viewSnapshot]}})})}function syncEngineSynchronizeWithChangedDocuments(syncEngine){return tslib.__awaiter(this,void 0,void 0,function(){var syncEngineImpl;return tslib.__generator(this,function(_d){return[2,localStoreGetNewDocumentChanges((syncEngineImpl=debugCast(syncEngine)).localStore).then(function(changes){return syncEngineEmitNewSnapsAndNotifyLocalStore(syncEngineImpl,changes)})]})})}function syncEngineApplyBatchState(syncEngine,batchId,batchState,error){return tslib.__awaiter(this,void 0,void 0,function(){var syncEngineImpl,documents;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,localStoreLookupMutationDocuments((syncEngineImpl=debugCast(syncEngine)).localStore,batchId)];case 1:return null===(documents=_d.sent())?(logDebug(LOG_TAG$3,"Cannot apply mutation batch with id: "+batchId),[2]):"pending"!==batchState?[3,3]:[4,fillWritePipeline(syncEngineImpl.remoteStore)];case 2:return _d.sent(),[3,4];case 3:"acknowledged"===batchState||"rejected"===batchState?(processUserCallback(syncEngineImpl,batchId,error||null),triggerPendingWritesCallbacks(syncEngineImpl,batchId),function localStoreRemoveCachedMutationBatchMetadata(localStore,batchId){debugCast(debugCast(localStore).mutationQueue).removeCachedMutationKeys(batchId)}(syncEngineImpl.localStore,batchId)):fail(),_d.label=4;case 4:return[4,syncEngineEmitNewSnapsAndNotifyLocalStore(syncEngineImpl,documents)];case 5:return _d.sent(),[2]}})})}function syncEngineApplyPrimaryState(syncEngine,isPrimary){return tslib.__awaiter(this,void 0,void 0,function(){var syncEngineImpl,activeTargets,activeQueries,_i,activeQueries_1,targetData,activeTargets_1,p_1;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return ensureWatchCallbacks(syncEngineImpl=debugCast(syncEngine)),syncEngineEnsureWriteCallbacks(syncEngineImpl),!0!==isPrimary||!0===syncEngineImpl._isPrimaryClient?[3,3]:(activeTargets=syncEngineImpl.sharedClientState.getAllActiveQueryTargets(),[4,synchronizeQueryViewsAndRaiseSnapshots(syncEngineImpl,activeTargets.toArray())]);case 1:return activeQueries=_d.sent(),syncEngineImpl._isPrimaryClient=!0,[4,remoteStoreApplyPrimaryState(syncEngineImpl.remoteStore,!0)];case 2:for(_d.sent(),_i=0,activeQueries_1=activeQueries;_i<activeQueries_1.length;_i++)targetData=activeQueries_1[_i],remoteStoreListen(syncEngineImpl.remoteStore,targetData);return[3,7];case 3:return!1!==isPrimary||!1===syncEngineImpl._isPrimaryClient?[3,7]:(activeTargets_1=[],p_1=Promise.resolve(),syncEngineImpl.queriesByTarget.forEach(function(_,targetId){syncEngineImpl.sharedClientState.isLocalQueryTarget(targetId)?activeTargets_1.push(targetId):p_1=p_1.then(function(){return removeAndCleanupTarget(syncEngineImpl,targetId),localStoreReleaseTarget(syncEngineImpl.localStore,targetId,!0)}),remoteStoreUnlisten(syncEngineImpl.remoteStore,targetId)}),[4,p_1]);case 4:return _d.sent(),[4,synchronizeQueryViewsAndRaiseSnapshots(syncEngineImpl,activeTargets_1)];case 5:return _d.sent(),function resetLimboDocuments(syncEngine){var syncEngineImpl=debugCast(syncEngine);syncEngineImpl.activeLimboResolutionsByTarget.forEach(function(_,targetId){remoteStoreUnlisten(syncEngineImpl.remoteStore,targetId)}),syncEngineImpl.limboDocumentRefs.removeAllReferences(),syncEngineImpl.activeLimboResolutionsByTarget=new Map,syncEngineImpl.activeLimboTargetsByKey=new SortedMap(DocumentKey.comparator)}(syncEngineImpl),syncEngineImpl._isPrimaryClient=!1,[4,remoteStoreApplyPrimaryState(syncEngineImpl.remoteStore,!1)];case 6:_d.sent(),_d.label=7;case 7:return[2]}})})}function synchronizeQueryViewsAndRaiseSnapshots(syncEngine,targets,transitionToPrimary){return tslib.__awaiter(this,void 0,void 0,function(){var syncEngineImpl,activeQueries,newViewSnapshots,_i,targets_1,targetId,targetData,queries,_d,queries_2,query_4,queryView,viewChange,target;return tslib.__generator(this,function(_e){switch(_e.label){case 0:syncEngineImpl=debugCast(syncEngine),activeQueries=[],newViewSnapshots=[],_i=0,targets_1=targets,_e.label=1;case 1:return _i<targets_1.length?(targetId=targets_1[_i],targetData=void 0,(queries=syncEngineImpl.queriesByTarget.get(targetId))&&0!==queries.length?[4,localStoreAllocateTarget(syncEngineImpl.localStore,queryToTarget(queries[0]))]:[3,7]):[3,13];case 2:targetData=_e.sent(),_d=0,queries_2=queries,_e.label=3;case 3:return _d<queries_2.length?(query_4=queries_2[_d],queryView=syncEngineImpl.queryViewsByQuery.get(query_4),[4,synchronizeViewAndComputeSnapshot(syncEngineImpl,queryView)]):[3,6];case 4:(viewChange=_e.sent()).snapshot&&newViewSnapshots.push(viewChange.snapshot),_e.label=5;case 5:return _d++,[3,3];case 6:return[3,11];case 7:return[4,localStoreGetCachedTarget(syncEngineImpl.localStore,targetId)];case 8:return target=_e.sent(),[4,localStoreAllocateTarget(syncEngineImpl.localStore,target)];case 9:return targetData=_e.sent(),[4,initializeViewAndComputeSnapshot(syncEngineImpl,synthesizeTargetToQuery(target),targetId,!1)];case 10:_e.sent(),_e.label=11;case 11:activeQueries.push(targetData),_e.label=12;case 12:return _i++,[3,1];case 13:return syncEngineImpl.syncEngineListener.onWatchChange(newViewSnapshots),[2,activeQueries]}})})}function synthesizeTargetToQuery(target){return newQuery(target.path,target.collectionGroup,target.orderBy,target.filters,target.limit,"F",target.startAt,target.endAt)}function syncEngineGetActiveClients(syncEngine){return function localStoreGetActiveClients(localStore){return debugCast(debugCast(localStore).persistence).getActiveClients()}(debugCast(syncEngine).localStore)}function syncEngineApplyTargetState(syncEngine,targetId,state,error){return tslib.__awaiter(this,void 0,void 0,function(){var syncEngineImpl,changes,synthesizedRemoteEvent;return tslib.__generator(this,function(_e){switch(_e.label){case 0:if((syncEngineImpl=debugCast(syncEngine))._isPrimaryClient)return logDebug(LOG_TAG$3,"Ignoring unexpected query state notification."),[2];if(!syncEngineImpl.queriesByTarget.has(targetId))return[3,7];switch(state){case"current":case"not-current":return[3,1];case"rejected":return[3,4]}return[3,6];case 1:return[4,localStoreGetNewDocumentChanges(syncEngineImpl.localStore)];case 2:return changes=_e.sent(),synthesizedRemoteEvent=RemoteEvent.createSynthesizedRemoteEventForCurrentChange(targetId,"current"===state),[4,syncEngineEmitNewSnapsAndNotifyLocalStore(syncEngineImpl,changes,synthesizedRemoteEvent)];case 3:return _e.sent(),[3,7];case 4:return[4,localStoreReleaseTarget(syncEngineImpl.localStore,targetId,!0)];case 5:return _e.sent(),removeAndCleanupTarget(syncEngineImpl,targetId,error),[3,7];case 6:fail(),_e.label=7;case 7:return[2]}})})}function syncEngineApplyActiveTargetsChange(syncEngine,added,removed){return tslib.__awaiter(this,void 0,void 0,function(){var syncEngineImpl,_i,added_1,target,targetData,_loop_5,_d,removed_1,targetId;return tslib.__generator(this,function(_e){switch(_e.label){case 0:if(!(syncEngineImpl=ensureWatchCallbacks(syncEngine))._isPrimaryClient)return[2];_i=0,added_1=added,_e.label=1;case 1:return _i<added_1.length?(targetId=added_1[_i],syncEngineImpl.queriesByTarget.has(targetId)?(logDebug(LOG_TAG$3,"Adding an already active target "+targetId),[3,5]):[4,localStoreGetCachedTarget(syncEngineImpl.localStore,targetId)]):[3,6];case 2:return target=_e.sent(),[4,localStoreAllocateTarget(syncEngineImpl.localStore,target)];case 3:return targetData=_e.sent(),[4,initializeViewAndComputeSnapshot(syncEngineImpl,synthesizeTargetToQuery(target),targetData.targetId,!1)];case 4:_e.sent(),remoteStoreListen(syncEngineImpl.remoteStore,targetData),_e.label=5;case 5:return _i++,[3,1];case 6:_loop_5=function(targetId){return tslib.__generator(this,function(_f){switch(_f.label){case 0:return syncEngineImpl.queriesByTarget.has(targetId)?[4,localStoreReleaseTarget(syncEngineImpl.localStore,targetId,!1).then(function(){remoteStoreUnlisten(syncEngineImpl.remoteStore,targetId),removeAndCleanupTarget(syncEngineImpl,targetId)}).catch(ignoreIfPrimaryLeaseLoss)]:[2,"continue"];case 1:return _f.sent(),[2]}})},_d=0,removed_1=removed,_e.label=7;case 7:return _d<removed_1.length?(targetId=removed_1[_d],[5,_loop_5(targetId)]):[3,10];case 8:_e.sent(),_e.label=9;case 9:return _d++,[3,7];case 10:return[2]}})})}function ensureWatchCallbacks(syncEngine){var syncEngineImpl=debugCast(syncEngine);return syncEngineImpl.remoteStore.remoteSyncer.applyRemoteEvent=syncEngineApplyRemoteEvent.bind(null,syncEngineImpl),syncEngineImpl.remoteStore.remoteSyncer.getRemoteKeysForTarget=syncEngineGetRemoteKeysForTarget.bind(null,syncEngineImpl),syncEngineImpl.remoteStore.remoteSyncer.rejectListen=syncEngineRejectListen.bind(null,syncEngineImpl),syncEngineImpl.syncEngineListener.onWatchChange=eventManagerOnWatchChange.bind(null,syncEngineImpl.eventManager),syncEngineImpl.syncEngineListener.onWatchError=eventManagerOnWatchError.bind(null,syncEngineImpl.eventManager),syncEngineImpl}function syncEngineEnsureWriteCallbacks(syncEngine){var syncEngineImpl=debugCast(syncEngine);return syncEngineImpl.remoteStore.remoteSyncer.applySuccessfulWrite=syncEngineApplySuccessfulWrite.bind(null,syncEngineImpl),syncEngineImpl.remoteStore.remoteSyncer.rejectFailedWrite=syncEngineRejectFailedWrite.bind(null,syncEngineImpl),syncEngineImpl}function syncEngineLoadBundle(syncEngine,bundleReader,task){var syncEngineImpl=debugCast(syncEngine);(function loadBundleImpl(syncEngine,reader,task){return tslib.__awaiter(this,void 0,void 0,function(){var metadata,loader,element,progress,result,e_10;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return _d.trys.push([0,13,,14]),[4,reader.getMetadata()];case 1:return metadata=_d.sent(),[4,localStoreHasNewerBundle(syncEngine.localStore,metadata)];case 2:return _d.sent()?[4,reader.close()]:[3,4];case 3:return _d.sent(),task._completeWith(function bundleSuccessProgress(metadata){return{taskState:"Success",documentsLoaded:metadata.totalDocuments,bytesLoaded:metadata.totalBytes,totalDocuments:metadata.totalDocuments,totalBytes:metadata.totalBytes}}(metadata)),[2];case 4:return task._updateProgress(bundleInitialProgress(metadata)),loader=new BundleLoader(metadata,syncEngine.localStore,reader.serializer),[4,reader.nextElement()];case 5:element=_d.sent(),_d.label=6;case 6:return element?[4,loader.addSizedElement(element)]:[3,9];case 7:return(progress=_d.sent())&&task._updateProgress(progress),[4,reader.nextElement()];case 8:return element=_d.sent(),[3,6];case 9:return[4,loader.complete()];case 10:return result=_d.sent(),[4,syncEngineEmitNewSnapsAndNotifyLocalStore(syncEngine,result.changedDocs,void 0)];case 11:return _d.sent(),[4,localStoreSaveBundle(syncEngine.localStore,metadata)];case 12:return _d.sent(),task._completeWith(result.progress),[3,14];case 13:return e_10=_d.sent(),logWarn(LOG_TAG$3,"Loading bundle failed with "+e_10),task._failWith(e_10),[3,14];case 14:return[2]}})})})(syncEngineImpl,bundleReader,task).then(function(){syncEngineImpl.sharedClientState.notifyBundleLoaded()})}var MemoryOfflineComponentProvider=function(){function MemoryOfflineComponentProvider(){this.synchronizeTabs=!1}return MemoryOfflineComponentProvider.prototype.initialize=function(cfg){return tslib.__awaiter(this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return this.serializer=newSerializer(cfg.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(cfg),this.persistence=this.createPersistence(cfg),[4,this.persistence.start()];case 1:return _d.sent(),this.gcScheduler=this.createGarbageCollectionScheduler(cfg),this.localStore=this.createLocalStore(cfg),[2]}})})},MemoryOfflineComponentProvider.prototype.createGarbageCollectionScheduler=function(cfg){return null},MemoryOfflineComponentProvider.prototype.createLocalStore=function(cfg){return newLocalStore(this.persistence,new QueryEngine,cfg.initialUser,this.serializer)},MemoryOfflineComponentProvider.prototype.createPersistence=function(cfg){return new MemoryPersistence(MemoryEagerDelegate.factory,this.serializer)},MemoryOfflineComponentProvider.prototype.createSharedClientState=function(cfg){return new MemorySharedClientState},MemoryOfflineComponentProvider.prototype.terminate=function(){return tslib.__awaiter(this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return this.gcScheduler&&this.gcScheduler.stop(),[4,this.sharedClientState.shutdown()];case 1:return _d.sent(),[4,this.persistence.shutdown()];case 2:return _d.sent(),[2]}})})},MemoryOfflineComponentProvider}(),IndexedDbOfflineComponentProvider=function(_super){function IndexedDbOfflineComponentProvider(onlineComponentProvider,cacheSizeBytes,forceOwnership){var _this=_super.call(this)||this;return _this.onlineComponentProvider=onlineComponentProvider,_this.cacheSizeBytes=cacheSizeBytes,_this.forceOwnership=forceOwnership,_this.synchronizeTabs=!1,_this}return tslib.__extends(IndexedDbOfflineComponentProvider,_super),IndexedDbOfflineComponentProvider.prototype.initialize=function(cfg){return tslib.__awaiter(this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,_super.prototype.initialize.call(this,cfg)];case 1:return _d.sent(),[4,localStoreSynchronizeLastDocumentChangeReadTime(this.localStore)];case 2:return _d.sent(),[4,this.onlineComponentProvider.initialize(this,cfg)];case 3:return _d.sent(),[4,syncEngineEnsureWriteCallbacks(this.onlineComponentProvider.syncEngine)];case 4:return _d.sent(),[4,fillWritePipeline(this.onlineComponentProvider.remoteStore)];case 5:return _d.sent(),[2]}})})},IndexedDbOfflineComponentProvider.prototype.createLocalStore=function(cfg){return newLocalStore(this.persistence,new QueryEngine,cfg.initialUser,this.serializer)},IndexedDbOfflineComponentProvider.prototype.createGarbageCollectionScheduler=function(cfg){var garbageCollector=this.persistence.referenceDelegate.garbageCollector;return new LruScheduler(garbageCollector,cfg.asyncQueue)},IndexedDbOfflineComponentProvider.prototype.createPersistence=function(cfg){var persistenceKey=indexedDbStoragePrefix(cfg.databaseInfo.databaseId,cfg.databaseInfo.persistenceKey),lruParams=void 0!==this.cacheSizeBytes?LruParams.withCacheSize(this.cacheSizeBytes):LruParams.DEFAULT;return new IndexedDbPersistence(this.synchronizeTabs,persistenceKey,cfg.clientId,lruParams,cfg.asyncQueue,getWindow(),null,this.serializer,this.sharedClientState,!!this.forceOwnership)},IndexedDbOfflineComponentProvider.prototype.createSharedClientState=function(cfg){return new MemorySharedClientState},IndexedDbOfflineComponentProvider}(MemoryOfflineComponentProvider),MultiTabOfflineComponentProvider=function(_super){function MultiTabOfflineComponentProvider(onlineComponentProvider,cacheSizeBytes){var _this=_super.call(this,onlineComponentProvider,cacheSizeBytes,!1)||this;return _this.onlineComponentProvider=onlineComponentProvider,_this.cacheSizeBytes=cacheSizeBytes,_this.synchronizeTabs=!0,_this}return tslib.__extends(MultiTabOfflineComponentProvider,_super),MultiTabOfflineComponentProvider.prototype.initialize=function(cfg){return tslib.__awaiter(this,void 0,void 0,function(){var syncEngine,_this=this;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,_super.prototype.initialize.call(this,cfg)];case 1:return _d.sent(),syncEngine=this.onlineComponentProvider.syncEngine,this.sharedClientState instanceof WebStorageSharedClientState?(this.sharedClientState.syncEngine={applyBatchState:syncEngineApplyBatchState.bind(null,syncEngine),applyTargetState:syncEngineApplyTargetState.bind(null,syncEngine),applyActiveTargetsChange:syncEngineApplyActiveTargetsChange.bind(null,syncEngine),getActiveClients:syncEngineGetActiveClients.bind(null,syncEngine),synchronizeWithChangedDocuments:syncEngineSynchronizeWithChangedDocuments.bind(null,syncEngine)},[4,this.sharedClientState.start()]):[3,3];case 2:_d.sent(),_d.label=3;case 3:return[4,this.persistence.setPrimaryStateListener(function(isPrimary){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,syncEngineApplyPrimaryState(this.onlineComponentProvider.syncEngine,isPrimary)];case 1:return _d.sent(),this.gcScheduler&&(isPrimary&&!this.gcScheduler.started?this.gcScheduler.start(this.localStore):isPrimary||this.gcScheduler.stop()),[2]}})})})];case 4:return _d.sent(),[2]}})})},MultiTabOfflineComponentProvider.prototype.createSharedClientState=function(cfg){var window=getWindow();if(!WebStorageSharedClientState.isAvailable(window))throw new FirestoreError(Code_UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var persistenceKey=indexedDbStoragePrefix(cfg.databaseInfo.databaseId,cfg.databaseInfo.persistenceKey);return new WebStorageSharedClientState(window,cfg.asyncQueue,persistenceKey,cfg.clientId,cfg.initialUser)},MultiTabOfflineComponentProvider}(IndexedDbOfflineComponentProvider),OnlineComponentProvider=function(){function OnlineComponentProvider(){}return OnlineComponentProvider.prototype.initialize=function(offlineComponentProvider,cfg){return tslib.__awaiter(this,void 0,void 0,function(){var _this=this;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return this.localStore?[2]:(this.localStore=offlineComponentProvider.localStore,this.sharedClientState=offlineComponentProvider.sharedClientState,this.datastore=this.createDatastore(cfg),this.remoteStore=this.createRemoteStore(cfg),this.eventManager=this.createEventManager(cfg),this.syncEngine=this.createSyncEngine(cfg,!offlineComponentProvider.synchronizeTabs),this.sharedClientState.onlineStateHandler=function(onlineState){return syncEngineApplyOnlineStateChange(_this.syncEngine,onlineState,1)},this.remoteStore.remoteSyncer.handleCredentialChange=syncEngineHandleCredentialChange.bind(null,this.syncEngine),[4,remoteStoreApplyPrimaryState(this.remoteStore,this.syncEngine.isPrimaryClient)]);case 1:return _d.sent(),[2]}})})},OnlineComponentProvider.prototype.createEventManager=function(cfg){return function newEventManager(){return new EventManagerImpl}()},OnlineComponentProvider.prototype.createDatastore=function(cfg){var serializer=newSerializer(cfg.databaseInfo.databaseId),connection=newConnection(cfg.databaseInfo);return function newDatastore(credentials,connection,serializer){return new DatastoreImpl(credentials,connection,serializer)}(cfg.credentials,connection,serializer)},OnlineComponentProvider.prototype.createRemoteStore=function(cfg){var _this=this;return function newRemoteStore(localStore,datastore,asyncQueue,onlineStateHandler,connectivityMonitor){return new RemoteStoreImpl(localStore,datastore,asyncQueue,onlineStateHandler,connectivityMonitor)}(this.localStore,this.datastore,cfg.asyncQueue,function(onlineState){return syncEngineApplyOnlineStateChange(_this.syncEngine,onlineState,0)},function newConnectivityMonitor(){return new NoopConnectivityMonitor}())},OnlineComponentProvider.prototype.createSyncEngine=function(cfg,startAsPrimary){return function newSyncEngine(localStore,remoteStore,eventManager,sharedClientState,currentUser,maxConcurrentLimboResolutions,isPrimary){var syncEngine=new SyncEngineImpl(localStore,remoteStore,eventManager,sharedClientState,currentUser,maxConcurrentLimboResolutions);return isPrimary&&(syncEngine._isPrimaryClient=!0),syncEngine}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,cfg.initialUser,cfg.maxConcurrentLimboResolutions,startAsPrimary)},OnlineComponentProvider.prototype.terminate=function(){return function remoteStoreShutdown(remoteStore){return tslib.__awaiter(this,void 0,void 0,function(){var remoteStoreImpl;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return remoteStoreImpl=debugCast(remoteStore),logDebug(LOG_TAG$5,"RemoteStore shutting down."),remoteStoreImpl.offlineCauses.add(5),[4,disableNetworkInternal(remoteStoreImpl)];case 1:return _d.sent(),remoteStoreImpl.connectivityMonitor.shutdown(),remoteStoreImpl.onlineStateTracker.set("Unknown"),[2]}})})}(this.remoteStore)},OnlineComponentProvider}();function validateNonEmptyArgument(functionName,argumentName,argument){if(!argument)throw new FirestoreError(Code_INVALID_ARGUMENT,"Function "+functionName+"() cannot be called with an empty "+argumentName+".")}function validateSetOptions(methodName,options){if(void 0===options)return{merge:!1};if(void 0!==options.mergeFields&&void 0!==options.merge)throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid options passed to function "+methodName+'(): You cannot specify both "merge" and "mergeFields".');return options}function validateIsNotUsedTogether(optionName1,argument1,optionName2,argument2){if(!0===argument1&&!0===argument2)throw new FirestoreError(Code_INVALID_ARGUMENT,optionName1+" and "+optionName2+" cannot be used together.")}function validateDocumentPath(path){if(!DocumentKey.isDocumentKey(path))throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+path+" has "+path.length+".")}function validateCollectionPath(path){if(DocumentKey.isDocumentKey(path))throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+path+" has "+path.length+".")}function valueDescription(input){if(void 0===input)return"undefined";if(null===input)return"null";if("string"==typeof input)return input.length>20&&(input=input.substring(0,20)+"..."),JSON.stringify(input);if("number"==typeof input||"boolean"==typeof input)return""+input;if("object"==typeof input){if(input instanceof Array)return"an array";var customObjectName=function tryGetCustomObjectType(input){if(input.constructor){var results=/function\s+([^\s(]+)\s*\(/.exec(input.constructor.toString());if(results&&results.length>1)return results[1]}return null}(input);return customObjectName?"a custom "+customObjectName+" object":"an object"}return"function"==typeof input?"a function":fail()}function cast(obj,constructor){if("_delegate"in obj&&(obj=obj._delegate),!(obj instanceof constructor)){if(constructor.name===obj.constructor.name)throw new FirestoreError(Code_INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");var description=valueDescription(obj);throw new FirestoreError(Code_INVALID_ARGUMENT,"Expected type '"+constructor.name+"', but it was: "+description)}return obj}function validatePositiveNumber(functionName,n){if(n<=0)throw new FirestoreError(Code_INVALID_ARGUMENT,"Function "+functionName+"() requires a positive number, but it was: "+n+".")}function toByteStreamReader(source,bytesPerRead){if(!(source instanceof Uint8Array))throw new FirestoreError(Code_INVALID_ARGUMENT,"NodePlatform.toByteStreamReader expects source to be Uint8Array, got "+valueDescription(source));return function toByteStreamReaderHelper(source,bytesPerRead){void 0===bytesPerRead&&(bytesPerRead=10240);var readFrom=0;return{read:function(){return tslib.__awaiter(this,void 0,void 0,function(){var result;return tslib.__generator(this,function(_d){return readFrom<source.byteLength?(result={value:source.slice(readFrom,readFrom+bytesPerRead),done:!1},readFrom+=bytesPerRead,[2,result]):[2,{done:!0}]})})},cancel:function(){return tslib.__awaiter(this,void 0,void 0,function(){return tslib.__generator(this,function(_d){return[2]})})},releaseLock:function(){},closed:Promise.reject("unimplemented")}}(source,bytesPerRead)}var AsyncObserver=function(){function AsyncObserver(observer){this.observer=observer,this.muted=!1}return AsyncObserver.prototype.next=function(value){this.observer.next&&this.scheduleEvent(this.observer.next,value)},AsyncObserver.prototype.error=function(error){this.observer.error?this.scheduleEvent(this.observer.error,error):console.error("Uncaught Error in snapshot listener:",error)},AsyncObserver.prototype.mute=function(){this.muted=!0},AsyncObserver.prototype.scheduleEvent=function(eventHandler,event){var _this=this;this.muted||setTimeout(function(){_this.muted||eventHandler(event)},0)},AsyncObserver}(),SizedBundleElement=function(){function SizedBundleElement(payload,byteLength){this.payload=payload,this.byteLength=byteLength}return SizedBundleElement.prototype.isBundleMetadata=function(){return"metadata"in this.payload},SizedBundleElement}(),BundleReaderImpl=function(){function BundleReaderImpl(reader,serializer){var _this=this;this.reader=reader,this.serializer=serializer,this.metadata=new Deferred,this.buffer=new Uint8Array,this.textDecoder=function newTextDecoder(){return new util$1.TextDecoder("utf-8")}(),this.nextElementImpl().then(function(element){element&&element.isBundleMetadata()?_this.metadata.resolve(element.payload.metadata):_this.metadata.reject(new Error("The first element of the bundle is not a metadata, it is\n             "+JSON.stringify(null==element?void 0:element.payload)))},function(error){return _this.metadata.reject(error)})}return BundleReaderImpl.prototype.close=function(){return this.reader.cancel()},BundleReaderImpl.prototype.getMetadata=function(){return tslib.__awaiter(this,void 0,void 0,function(){return tslib.__generator(this,function(_d){return[2,this.metadata.promise]})})},BundleReaderImpl.prototype.nextElement=function(){return tslib.__awaiter(this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,this.getMetadata()];case 1:return _d.sent(),[2,this.nextElementImpl()]}})})},BundleReaderImpl.prototype.nextElementImpl=function(){return tslib.__awaiter(this,void 0,void 0,function(){var lengthBuffer,lengthString,length,jsonString;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,this.readLength()];case 1:return null===(lengthBuffer=_d.sent())?[2,null]:(lengthString=this.textDecoder.decode(lengthBuffer),length=Number(lengthString),isNaN(length)&&this.raiseError("length string ("+lengthString+") is not valid number"),[4,this.readJsonString(length)]);case 2:return jsonString=_d.sent(),[2,new SizedBundleElement(JSON.parse(jsonString),lengthBuffer.length+length)]}})})},BundleReaderImpl.prototype.indexOfOpenBracket=function(){return this.buffer.findIndex(function(v){return v==="{".charCodeAt(0)})},BundleReaderImpl.prototype.readLength=function(){return tslib.__awaiter(this,void 0,void 0,function(){var position,result;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return this.indexOfOpenBracket()<0?[4,this.pullMoreDataToBuffer()]:[3,2];case 1:return _d.sent()?[3,2]:[3,0];case 2:return 0===this.buffer.length?[2,null]:((position=this.indexOfOpenBracket())<0&&this.raiseError("Reached the end of bundle when a length string is expected."),result=this.buffer.slice(0,position),this.buffer=this.buffer.slice(position),[2,result])}})})},BundleReaderImpl.prototype.readJsonString=function(length){return tslib.__awaiter(this,void 0,void 0,function(){var result;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return this.buffer.length<length?[4,this.pullMoreDataToBuffer()]:[3,2];case 1:return _d.sent()&&this.raiseError("Reached the end of bundle when more is expected."),[3,0];case 2:return result=this.textDecoder.decode(this.buffer.slice(0,length)),this.buffer=this.buffer.slice(length),[2,result]}})})},BundleReaderImpl.prototype.raiseError=function(message){throw this.reader.cancel(),new Error("Invalid bundle format: "+message)},BundleReaderImpl.prototype.pullMoreDataToBuffer=function(){return tslib.__awaiter(this,void 0,void 0,function(){var result,newBuffer;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,this.reader.read()];case 1:return(result=_d.sent()).done||((newBuffer=new Uint8Array(this.buffer.length+result.value.length)).set(this.buffer),newBuffer.set(result.value,this.buffer.length),this.buffer=newBuffer),[2,result.done]}})})},BundleReaderImpl}();var Transaction$3=function(){function Transaction$3(datastore){this.datastore=datastore,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}return Transaction$3.prototype.lookup=function(keys){return tslib.__awaiter(this,void 0,void 0,function(){var docs,_this=this;return tslib.__generator(this,function(_d){switch(_d.label){case 0:if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new FirestoreError(Code_INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");return[4,invokeBatchGetDocumentsRpc(this.datastore,keys)];case 1:return(docs=_d.sent()).forEach(function(doc){return _this.recordVersion(doc)}),[2,docs]}})})},Transaction$3.prototype.set=function(key,data){this.write(data.toMutation(key,this.precondition(key))),this.writtenDocs.add(key.toString())},Transaction$3.prototype.update=function(key,data){try{this.write(data.toMutation(key,this.preconditionForUpdate(key)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(key.toString())},Transaction$3.prototype.delete=function(key){this.write(new DeleteMutation(key,this.precondition(key))),this.writtenDocs.add(key.toString())},Transaction$3.prototype.commit=function(){return tslib.__awaiter(this,void 0,void 0,function(){var unwritten,_this=this;return tslib.__generator(this,function(_d){switch(_d.label){case 0:if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;return unwritten=this.readVersions,this.mutations.forEach(function(mutation){unwritten.delete(mutation.key.toString())}),unwritten.forEach(function(_,path){var key=DocumentKey.fromPath(path);_this.mutations.push(new VerifyMutation(key,_this.precondition(key)))}),[4,invokeCommitRpc(this.datastore,this.mutations)];case 1:return _d.sent(),this.committed=!0,[2]}})})},Transaction$3.prototype.recordVersion=function(doc){var docVersion;if(doc.isFoundDocument())docVersion=doc.version;else{if(!doc.isNoDocument())throw fail();docVersion=SnapshotVersion.min()}var existingVersion=this.readVersions.get(doc.key.toString());if(existingVersion){if(!docVersion.isEqual(existingVersion))throw new FirestoreError(Code_ABORTED,"Document version changed between two reads.")}else this.readVersions.set(doc.key.toString(),docVersion)},Transaction$3.prototype.precondition=function(key){var version=this.readVersions.get(key.toString());return!this.writtenDocs.has(key.toString())&&version?Precondition.updateTime(version):Precondition.none()},Transaction$3.prototype.preconditionForUpdate=function(key){var version=this.readVersions.get(key.toString());if(!this.writtenDocs.has(key.toString())&&version){if(version.isEqual(SnapshotVersion.min()))throw new FirestoreError(Code_INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Precondition.updateTime(version)}return Precondition.exists(!0)},Transaction$3.prototype.write=function(mutation){this.ensureCommitNotCalled(),this.mutations.push(mutation)},Transaction$3.prototype.ensureCommitNotCalled=function(){},Transaction$3}(),TransactionRunner=function(){function TransactionRunner(asyncQueue,datastore,updateFunction,deferred){this.asyncQueue=asyncQueue,this.datastore=datastore,this.updateFunction=updateFunction,this.deferred=deferred,this.attemptsRemaining=5,this.backoff=new ExponentialBackoff(this.asyncQueue,"transaction_retry")}return TransactionRunner.prototype.run=function(){this.attemptsRemaining-=1,this.runWithBackOff()},TransactionRunner.prototype.runWithBackOff=function(){var _this=this;this.backoff.backoffAndRun(function(){return tslib.__awaiter(_this,void 0,void 0,function(){var transaction,userPromise,_this=this;return tslib.__generator(this,function(_d){return transaction=new Transaction$3(this.datastore),(userPromise=this.tryRunUpdateFunction(transaction))&&userPromise.then(function(result){_this.asyncQueue.enqueueAndForget(function(){return transaction.commit().then(function(){_this.deferred.resolve(result)}).catch(function(commitError){_this.handleTransactionError(commitError)})})}).catch(function(userPromiseError){_this.handleTransactionError(userPromiseError)}),[2]})})})},TransactionRunner.prototype.tryRunUpdateFunction=function(transaction){try{var userPromise=this.updateFunction(transaction);return!isNullOrUndefined(userPromise)&&userPromise.catch&&userPromise.then?userPromise:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(error){return this.deferred.reject(error),null}},TransactionRunner.prototype.handleTransactionError=function(error){var _this=this;this.attemptsRemaining>0&&this.isRetryableTransactionError(error)?(this.attemptsRemaining-=1,this.asyncQueue.enqueueAndForget(function(){return _this.runWithBackOff(),Promise.resolve()})):this.deferred.reject(error)},TransactionRunner.prototype.isRetryableTransactionError=function(error){if("FirebaseError"===error.name){var code=error.code;return"aborted"===code||"failed-precondition"===code||!isPermanentError(code)}return!1},TransactionRunner}(),LOG_TAG$2="FirestoreClient",FirestoreClient=function(){function FirestoreClient(credentials,asyncQueue,databaseInfo){var _this=this;this.credentials=credentials,this.asyncQueue=asyncQueue,this.databaseInfo=databaseInfo,this.user=User.UNAUTHENTICATED,this.clientId=AutoId.newId(),this.credentialListener=function(){return Promise.resolve()},this.credentials.setChangeListener(asyncQueue,function(user){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return logDebug(LOG_TAG$2,"Received user=",user.uid),[4,this.credentialListener(user)];case 1:return _d.sent(),this.user=user,[2]}})})})}return FirestoreClient.prototype.getConfiguration=function(){return tslib.__awaiter(this,void 0,void 0,function(){return tslib.__generator(this,function(_d){return[2,{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,credentials:this.credentials,initialUser:this.user,maxConcurrentLimboResolutions:100}]})})},FirestoreClient.prototype.setCredentialChangeListener=function(listener){this.credentialListener=listener},FirestoreClient.prototype.verifyNotTerminated=function(){if(this.asyncQueue.isShuttingDown)throw new FirestoreError(Code_FAILED_PRECONDITION,"The client has already been terminated.")},FirestoreClient.prototype.terminate=function(){var _this=this;this.asyncQueue.enterRestrictedMode();var deferred=new Deferred;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(function(){return tslib.__awaiter(_this,void 0,void 0,function(){var e_11,firestoreError;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return _d.trys.push([0,5,,6]),this.onlineComponents?[4,this.onlineComponents.terminate()]:[3,2];case 1:_d.sent(),_d.label=2;case 2:return this.offlineComponents?[4,this.offlineComponents.terminate()]:[3,4];case 3:_d.sent(),_d.label=4;case 4:return this.credentials.removeChangeListener(),deferred.resolve(),[3,6];case 5:return e_11=_d.sent(),firestoreError=wrapInUserErrorIfRecoverable(e_11,"Failed to shutdown persistence"),deferred.reject(firestoreError),[3,6];case 6:return[2]}})})}),deferred.promise},FirestoreClient}();function setOfflineComponentProvider(client,offlineComponentProvider){return tslib.__awaiter(this,void 0,void 0,function(){var configuration,currentUser,_this=this;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return client.asyncQueue.verifyOperationInProgress(),logDebug(LOG_TAG$2,"Initializing OfflineComponentProvider"),[4,client.getConfiguration()];case 1:return configuration=_d.sent(),[4,offlineComponentProvider.initialize(configuration)];case 2:return _d.sent(),currentUser=configuration.initialUser,client.setCredentialChangeListener(function(user){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return currentUser.isEqual(user)?[3,2]:[4,localStoreHandleUserChange(offlineComponentProvider.localStore,user)];case 1:_d.sent(),currentUser=user,_d.label=2;case 2:return[2]}})})}),offlineComponentProvider.persistence.setDatabaseDeletedListener(function(){return client.terminate()}),client.offlineComponents=offlineComponentProvider,[2]}})})}function setOnlineComponentProvider(client,onlineComponentProvider){return tslib.__awaiter(this,void 0,void 0,function(){var offlineComponentProvider,configuration;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return client.asyncQueue.verifyOperationInProgress(),[4,ensureOfflineComponents(client)];case 1:return offlineComponentProvider=_d.sent(),logDebug(LOG_TAG$2,"Initializing OnlineComponentProvider"),[4,client.getConfiguration()];case 2:return configuration=_d.sent(),[4,onlineComponentProvider.initialize(offlineComponentProvider,configuration)];case 3:return _d.sent(),client.setCredentialChangeListener(function(user){return function remoteStoreHandleCredentialChange(remoteStore,user){return tslib.__awaiter(this,void 0,void 0,function(){var remoteStoreImpl,usesNetwork;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return(remoteStoreImpl=debugCast(remoteStore)).asyncQueue.verifyOperationInProgress(),logDebug(LOG_TAG$5,"RemoteStore received new credentials"),usesNetwork=canUseNetwork(remoteStoreImpl),remoteStoreImpl.offlineCauses.add(3),[4,disableNetworkInternal(remoteStoreImpl)];case 1:return _d.sent(),usesNetwork&&remoteStoreImpl.onlineStateTracker.set("Unknown"),[4,remoteStoreImpl.remoteSyncer.handleCredentialChange(user)];case 2:return _d.sent(),remoteStoreImpl.offlineCauses.delete(3),[4,enableNetworkInternal(remoteStoreImpl)];case 3:return _d.sent(),[2]}})})}(onlineComponentProvider.remoteStore,user)}),client.onlineComponents=onlineComponentProvider,[2]}})})}function ensureOfflineComponents(client){return tslib.__awaiter(this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return client.offlineComponents?[3,2]:(logDebug(LOG_TAG$2,"Using default OfflineComponentProvider"),[4,setOfflineComponentProvider(client,new MemoryOfflineComponentProvider)]);case 1:_d.sent(),_d.label=2;case 2:return[2,client.offlineComponents]}})})}function ensureOnlineComponents(client){return tslib.__awaiter(this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return client.onlineComponents?[3,2]:(logDebug(LOG_TAG$2,"Using default OnlineComponentProvider"),[4,setOnlineComponentProvider(client,new OnlineComponentProvider)]);case 1:_d.sent(),_d.label=2;case 2:return[2,client.onlineComponents]}})})}function getPersistence(client){return ensureOfflineComponents(client).then(function(c){return c.persistence})}function getLocalStore(client){return ensureOfflineComponents(client).then(function(c){return c.localStore})}function getRemoteStore(client){return ensureOnlineComponents(client).then(function(c){return c.remoteStore})}function getSyncEngine(client){return ensureOnlineComponents(client).then(function(c){return c.syncEngine})}function getDatastore(client){return ensureOnlineComponents(client).then(function(c){return c.datastore})}function getEventManager(client){return tslib.__awaiter(this,void 0,void 0,function(){var onlineComponentProvider,eventManager;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,ensureOnlineComponents(client)];case 1:return onlineComponentProvider=_d.sent(),(eventManager=onlineComponentProvider.eventManager).onListen=syncEngineListen.bind(null,onlineComponentProvider.syncEngine),eventManager.onUnlisten=syncEngineUnlisten.bind(null,onlineComponentProvider.syncEngine),[2,eventManager]}})})}function firestoreClientListen(client,query,options,observer){var _this=this,wrappedObserver=new AsyncObserver(observer),listener=new QueryListener(query,wrappedObserver,options);return client.asyncQueue.enqueueAndForget(function(){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,getEventManager(client)];case 1:return[2,eventManagerListen(_d.sent(),listener)]}})})}),function(){wrappedObserver.mute(),client.asyncQueue.enqueueAndForget(function(){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,getEventManager(client)];case 1:return[2,eventManagerUnlisten(_d.sent(),listener)]}})})})}}function firestoreClientGetDocumentViaSnapshotListener(client,key,options){var _this=this;void 0===options&&(options={});var deferred=new Deferred;return client.asyncQueue.enqueueAndForget(function(){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,getEventManager(client)];case 1:return[2,readDocumentViaSnapshotListener(_d.sent(),client.asyncQueue,key,options,deferred)]}})})}),deferred.promise}function firestoreClientGetDocumentsViaSnapshotListener(client,query,options){var _this=this;void 0===options&&(options={});var deferred=new Deferred;return client.asyncQueue.enqueueAndForget(function(){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,getEventManager(client)];case 1:return[2,executeQueryViaSnapshotListener(_d.sent(),client.asyncQueue,query,options,deferred)]}})})}),deferred.promise}function readDocumentFromCache(localStore,docKey,result){return tslib.__awaiter(this,void 0,void 0,function(){var document_4,e_12,firestoreError;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return _d.trys.push([0,2,,3]),[4,localStoreReadDocument(localStore,docKey)];case 1:return(document_4=_d.sent()).isFoundDocument()?result.resolve(document_4):document_4.isNoDocument()?result.resolve(null):result.reject(new FirestoreError(Code_UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")),[3,3];case 2:return e_12=_d.sent(),firestoreError=wrapInUserErrorIfRecoverable(e_12,"Failed to get document '"+docKey+" from cache"),result.reject(firestoreError),[3,3];case 3:return[2]}})})}function readDocumentViaSnapshotListener(eventManager,asyncQueue,key,options,result){var wrappedObserver=new AsyncObserver({next:function(snap){asyncQueue.enqueueAndForget(function(){return eventManagerUnlisten(eventManager,listener)});var exists=snap.docs.has(key);!exists&&snap.fromCache?result.reject(new FirestoreError(Code_UNAVAILABLE,"Failed to get document because the client is offline.")):exists&&snap.fromCache&&options&&"server"===options.source?result.reject(new FirestoreError(Code_UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):result.resolve(snap)},error:function(e){return result.reject(e)}}),listener=new QueryListener(newQueryForPath(key.path),wrappedObserver,{includeMetadataChanges:!0,waitForSyncWhenOnline:!0});return eventManagerListen(eventManager,listener)}function executeQueryFromCache(localStore,query,result){return tslib.__awaiter(this,void 0,void 0,function(){var queryResult,view,viewDocChanges,viewChange,e_13,firestoreError;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return _d.trys.push([0,2,,3]),[4,localStoreExecuteQuery(localStore,query,!0)];case 1:return queryResult=_d.sent(),view=new View(query,queryResult.remoteKeys),viewDocChanges=view.computeDocChanges(queryResult.documents),viewChange=view.applyChanges(viewDocChanges,!1),result.resolve(viewChange.snapshot),[3,3];case 2:return e_13=_d.sent(),firestoreError=wrapInUserErrorIfRecoverable(e_13,"Failed to execute query '"+query+" against cache"),result.reject(firestoreError),[3,3];case 3:return[2]}})})}function executeQueryViaSnapshotListener(eventManager,asyncQueue,query,options,result){var wrappedObserver=new AsyncObserver({next:function(snapshot){asyncQueue.enqueueAndForget(function(){return eventManagerUnlisten(eventManager,listener)}),snapshot.fromCache&&"server"===options.source?result.reject(new FirestoreError(Code_UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):result.resolve(snapshot)},error:function(e){return result.reject(e)}}),listener=new QueryListener(query,wrappedObserver,{includeMetadataChanges:!0,waitForSyncWhenOnline:!0});return eventManagerListen(eventManager,listener)}function firestoreClientLoadBundle(client,databaseId,data,resultTask){var _this=this,reader=function createBundleReader(data,serializer){var content;content="string"==typeof data?function newTextEncoder(){return new util$1.TextEncoder}().encode(data):data;return function newBundleReader(reader,serializer){return new BundleReaderImpl(reader,serializer)}(toByteStreamReader(content),serializer)}(data,newSerializer(databaseId));client.asyncQueue.enqueueAndForget(function(){return tslib.__awaiter(_this,void 0,void 0,function(){var _d;return tslib.__generator(this,function(_e){switch(_e.label){case 0:return _d=syncEngineLoadBundle,[4,getSyncEngine(client)];case 1:return _d.apply(void 0,[_e.sent(),reader,resultTask]),[2]}})})})}var DatabaseInfo=function DatabaseInfo(databaseId,appId,persistenceKey,host,ssl,forceLongPolling,autoDetectLongPolling,useFetchStreams){this.databaseId=databaseId,this.appId=appId,this.persistenceKey=persistenceKey,this.host=host,this.ssl=ssl,this.forceLongPolling=forceLongPolling,this.autoDetectLongPolling=autoDetectLongPolling,this.useFetchStreams=useFetchStreams},DatabaseId=function(){function DatabaseId(projectId,database){this.projectId=projectId,this.database=database||"(default)"}return Object.defineProperty(DatabaseId.prototype,"isDefaultDatabase",{get:function(){return"(default)"===this.database},enumerable:!1,configurable:!0}),DatabaseId.prototype.isEqual=function(other){return other instanceof DatabaseId&&other.projectId===this.projectId&&other.database===this.database},DatabaseId}(),datastoreInstances=new Map;var OAuthToken=function OAuthToken(value,user){this.user=user,this.type="OAuth",this.authHeaders={},this.authHeaders.Authorization="Bearer "+value},EmptyCredentialsProvider=function(){function EmptyCredentialsProvider(){this.changeListener=null}return EmptyCredentialsProvider.prototype.getToken=function(){return Promise.resolve(null)},EmptyCredentialsProvider.prototype.invalidateToken=function(){},EmptyCredentialsProvider.prototype.setChangeListener=function(asyncQueue,changeListener){this.changeListener=changeListener,asyncQueue.enqueueRetryable(function(){return changeListener(User.UNAUTHENTICATED)})},EmptyCredentialsProvider.prototype.removeChangeListener=function(){this.changeListener=null},EmptyCredentialsProvider}(),EmulatorCredentialsProvider=function(){function EmulatorCredentialsProvider(token){this.token=token,this.changeListener=null}return EmulatorCredentialsProvider.prototype.getToken=function(){return Promise.resolve(this.token)},EmulatorCredentialsProvider.prototype.invalidateToken=function(){},EmulatorCredentialsProvider.prototype.setChangeListener=function(asyncQueue,changeListener){var _this=this;this.changeListener=changeListener,asyncQueue.enqueueRetryable(function(){return changeListener(_this.token.user)})},EmulatorCredentialsProvider.prototype.removeChangeListener=function(){this.changeListener=null},EmulatorCredentialsProvider}(),FirebaseCredentialsProvider=function(){function FirebaseCredentialsProvider(authProvider){var _this=this;this.currentUser=User.UNAUTHENTICATED,this.authDeferred=new Deferred,this.tokenCounter=0,this.forceRefresh=!1,this.auth=null,this.asyncQueue=null,this.tokenListener=function(){_this.tokenCounter++,_this.currentUser=_this.getUser(),_this.authDeferred.resolve(),_this.changeListener&&_this.asyncQueue.enqueueRetryable(function(){return _this.changeListener(_this.currentUser)})};var registerAuth=function(auth){logDebug("FirebaseCredentialsProvider","Auth detected"),_this.auth=auth,_this.auth.addAuthTokenListener(_this.tokenListener)};authProvider.onInit(function(auth){return registerAuth(auth)}),setTimeout(function(){if(!_this.auth){var auth=authProvider.getImmediate({optional:!0});auth?registerAuth(auth):(logDebug("FirebaseCredentialsProvider","Auth not yet detected"),_this.authDeferred.resolve())}},0)}return FirebaseCredentialsProvider.prototype.getToken=function(){var _this=this,initialTokenCounter=this.tokenCounter,forceRefresh=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(forceRefresh).then(function(tokenData){return _this.tokenCounter!==initialTokenCounter?(logDebug("FirebaseCredentialsProvider","getToken aborted due to token change."),_this.getToken()):tokenData?(hardAssert("string"==typeof tokenData.accessToken),new OAuthToken(tokenData.accessToken,_this.currentUser)):null}):Promise.resolve(null)},FirebaseCredentialsProvider.prototype.invalidateToken=function(){this.forceRefresh=!0},FirebaseCredentialsProvider.prototype.setChangeListener=function(asyncQueue,changeListener){var _this=this;this.asyncQueue=asyncQueue,this.asyncQueue.enqueueRetryable(function(){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,this.authDeferred.promise];case 1:return _d.sent(),[4,changeListener(this.currentUser)];case 2:return _d.sent(),this.changeListener=changeListener,[2]}})})})},FirebaseCredentialsProvider.prototype.removeChangeListener=function(){this.auth&&this.auth.removeAuthTokenListener(this.tokenListener),this.changeListener=function(){return Promise.resolve()}},FirebaseCredentialsProvider.prototype.getUser=function(){var currentUid=this.auth&&this.auth.getUid();return hardAssert(null===currentUid||"string"==typeof currentUid),new User(currentUid)},FirebaseCredentialsProvider}(),FirstPartyToken=function(){function FirstPartyToken(gapi,sessionIndex,iamToken){this.gapi=gapi,this.sessionIndex=sessionIndex,this.iamToken=iamToken,this.type="FirstParty",this.user=User.FIRST_PARTY}return Object.defineProperty(FirstPartyToken.prototype,"authHeaders",{get:function(){var headers={"X-Goog-AuthUser":this.sessionIndex},authHeader=this.gapi.auth.getAuthHeaderValueForFirstParty([]);return authHeader&&(headers.Authorization=authHeader),this.iamToken&&(headers["X-Goog-Iam-Authorization-Token"]=this.iamToken),headers},enumerable:!1,configurable:!0}),FirstPartyToken}(),FirstPartyCredentialsProvider=function(){function FirstPartyCredentialsProvider(gapi,sessionIndex,iamToken){this.gapi=gapi,this.sessionIndex=sessionIndex,this.iamToken=iamToken}return FirstPartyCredentialsProvider.prototype.getToken=function(){return Promise.resolve(new FirstPartyToken(this.gapi,this.sessionIndex,this.iamToken))},FirstPartyCredentialsProvider.prototype.setChangeListener=function(asyncQueue,changeListener){asyncQueue.enqueueRetryable(function(){return changeListener(User.FIRST_PARTY)})},FirstPartyCredentialsProvider.prototype.removeChangeListener=function(){},FirstPartyCredentialsProvider.prototype.invalidateToken=function(){},FirstPartyCredentialsProvider}();var FirestoreSettings=function(){function FirestoreSettings(settings){var _a;if(void 0===settings.host){if(void 0!==settings.ssl)throw new FirestoreError(Code_INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=true}else this.host=settings.host,this.ssl=null===(_a=settings.ssl)||void 0===_a||_a;if(this.credentials=settings.credentials,this.ignoreUndefinedProperties=!!settings.ignoreUndefinedProperties,void 0===settings.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==settings.cacheSizeBytes&&settings.cacheSizeBytes<1048576)throw new FirestoreError(Code_INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=settings.cacheSizeBytes}this.experimentalForceLongPolling=!!settings.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!settings.experimentalAutoDetectLongPolling,this.useFetchStreams=!!settings.useFetchStreams,validateIsNotUsedTogether("experimentalForceLongPolling",settings.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",settings.experimentalAutoDetectLongPolling)}return FirestoreSettings.prototype.isEqual=function(other){return this.host===other.host&&this.ssl===other.ssl&&this.credentials===other.credentials&&this.cacheSizeBytes===other.cacheSizeBytes&&this.experimentalForceLongPolling===other.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===other.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===other.ignoreUndefinedProperties&&this.useFetchStreams===other.useFetchStreams},FirestoreSettings}(),FirebaseFirestore$1=function(){function FirebaseFirestore$1(databaseIdOrApp,authProvider){this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new FirestoreSettings({}),this._settingsFrozen=!1,databaseIdOrApp instanceof DatabaseId?(this._databaseId=databaseIdOrApp,this._credentials=new EmptyCredentialsProvider):(this._app=databaseIdOrApp,this._databaseId=function databaseIdFromApp(app){if(!Object.prototype.hasOwnProperty.apply(app.options,["projectId"]))throw new FirestoreError(Code_INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new DatabaseId(app.options.projectId)}(databaseIdOrApp),this._credentials=new FirebaseCredentialsProvider(authProvider))}return Object.defineProperty(FirebaseFirestore$1.prototype,"app",{get:function(){if(!this._app)throw new FirestoreError(Code_FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app},enumerable:!1,configurable:!0}),Object.defineProperty(FirebaseFirestore$1.prototype,"_initialized",{get:function(){return this._settingsFrozen},enumerable:!1,configurable:!0}),Object.defineProperty(FirebaseFirestore$1.prototype,"_terminated",{get:function(){return void 0!==this._terminateTask},enumerable:!1,configurable:!0}),FirebaseFirestore$1.prototype._setSettings=function(settings){if(this._settingsFrozen)throw new FirestoreError(Code_FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new FirestoreSettings(settings),void 0!==settings.credentials&&(this._credentials=function makeCredentialsProvider(credentials){if(!credentials)return new EmptyCredentialsProvider;switch(credentials.type){case"gapi":var client=credentials.client;return hardAssert(!("object"!=typeof client||null===client||!client.auth||!client.auth.getAuthHeaderValueForFirstParty)),new FirstPartyCredentialsProvider(client,credentials.sessionIndex||"0",credentials.iamToken||null);case"provider":return credentials.client;default:throw new FirestoreError(Code_INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}(settings.credentials))},FirebaseFirestore$1.prototype._getSettings=function(){return this._settings},FirebaseFirestore$1.prototype._freezeSettings=function(){return this._settingsFrozen=!0,this._settings},FirebaseFirestore$1.prototype._delete=function(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask},FirebaseFirestore$1.prototype.toJSON=function(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}},FirebaseFirestore$1.prototype._terminate=function(){return function removeComponents(firestore){var datastore=datastoreInstances.get(firestore);datastore&&(logDebug("ComponentProvider","Removing Datastore"),datastoreInstances.delete(firestore),datastore.terminate())}(this),Promise.resolve()},FirebaseFirestore$1}();var DocumentReference$1=function(){function DocumentReference$1(firestore,converter,_key){this.converter=converter,this._key=_key,this.type="document",this.firestore=firestore}return Object.defineProperty(DocumentReference$1.prototype,"_path",{get:function(){return this._key.path},enumerable:!1,configurable:!0}),Object.defineProperty(DocumentReference$1.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!1,configurable:!0}),Object.defineProperty(DocumentReference$1.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:!1,configurable:!0}),Object.defineProperty(DocumentReference$1.prototype,"parent",{get:function(){return new CollectionReference$1(this.firestore,this.converter,this._key.path.popLast())},enumerable:!1,configurable:!0}),DocumentReference$1.prototype.withConverter=function(converter){return new DocumentReference$1(this.firestore,converter,this._key)},DocumentReference$1}(),Query$1=function(){function Query$1(firestore,converter,_query){this.converter=converter,this._query=_query,this.type="query",this.firestore=firestore}return Query$1.prototype.withConverter=function(converter){return new Query$1(this.firestore,converter,this._query)},Query$1}(),CollectionReference$1=function(_super){function CollectionReference$1(firestore,converter,_path){var _this=_super.call(this,firestore,converter,newQueryForPath(_path))||this;return _this._path=_path,_this.type="collection",_this}return tslib.__extends(CollectionReference$1,_super),Object.defineProperty(CollectionReference$1.prototype,"id",{get:function(){return this._query.path.lastSegment()},enumerable:!1,configurable:!0}),Object.defineProperty(CollectionReference$1.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:!1,configurable:!0}),Object.defineProperty(CollectionReference$1.prototype,"parent",{get:function(){var parentPath=this._path.popLast();return parentPath.isEmpty()?null:new DocumentReference$1(this.firestore,null,new DocumentKey(parentPath))},enumerable:!1,configurable:!0}),CollectionReference$1.prototype.withConverter=function(converter){return new CollectionReference$1(this.firestore,converter,this._path)},CollectionReference$1}(Query$1);function collection(parent,path){for(var absolutePath,pathSegments=[],_i=2;_i<arguments.length;_i++)pathSegments[_i-2]=arguments[_i];if(parent=util.getModularInstance(parent),validateNonEmptyArgument("collection","path",path),parent instanceof FirebaseFirestore$1)return validateCollectionPath(absolutePath=ResourcePath.fromString.apply(ResourcePath,tslib.__spreadArray([path],pathSegments))),new CollectionReference$1(parent,null,absolutePath);if(!(parent instanceof DocumentReference$1||parent instanceof CollectionReference$1))throw new FirestoreError(Code_INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");return validateCollectionPath(absolutePath=ResourcePath.fromString.apply(ResourcePath,tslib.__spreadArray([parent.path],pathSegments)).child(ResourcePath.fromString(path))),new CollectionReference$1(parent.firestore,null,absolutePath)}function collectionGroup(firestore,collectionId){if(firestore=cast(firestore,FirebaseFirestore$1),validateNonEmptyArgument("collectionGroup","collection id",collectionId),collectionId.indexOf("/")>=0)throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid collection ID '"+collectionId+"' passed to function collectionGroup(). Collection IDs must not contain '/'.");return new Query$1(firestore,null,function newQueryForCollectionGroup(collectionId){return new QueryImpl(ResourcePath.emptyPath(),collectionId)}(collectionId))}function doc(parent,path){for(var absolutePath,pathSegments=[],_i=2;_i<arguments.length;_i++)pathSegments[_i-2]=arguments[_i];if(parent=util.getModularInstance(parent),1===arguments.length&&(path=AutoId.newId()),validateNonEmptyArgument("doc","path",path),parent instanceof FirebaseFirestore$1)return validateDocumentPath(absolutePath=ResourcePath.fromString.apply(ResourcePath,tslib.__spreadArray([path],pathSegments))),new DocumentReference$1(parent,null,new DocumentKey(absolutePath));if(!(parent instanceof DocumentReference$1||parent instanceof CollectionReference$1))throw new FirestoreError(Code_INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");return validateDocumentPath(absolutePath=parent._path.child(ResourcePath.fromString.apply(ResourcePath,tslib.__spreadArray([path],pathSegments)))),new DocumentReference$1(parent.firestore,parent instanceof CollectionReference$1?parent.converter:null,new DocumentKey(absolutePath))}function refEqual(left,right){return left=util.getModularInstance(left),right=util.getModularInstance(right),(left instanceof DocumentReference$1||left instanceof CollectionReference$1)&&(right instanceof DocumentReference$1||right instanceof CollectionReference$1)&&(left.firestore===right.firestore&&left.path===right.path&&left.converter===right.converter)}function queryEqual(left,right){return left=util.getModularInstance(left),right=util.getModularInstance(right),left instanceof Query$1&&right instanceof Query$1&&(left.firestore===right.firestore&&queryEquals(left._query,right._query)&&left.converter===right.converter)}var AsyncQueueImpl=function(){function AsyncQueueImpl(){var _this=this;this.tail=Promise.resolve(),this.retryableOps=[],this._isShuttingDown=!1,this.delayedOperations=[],this.failure=null,this.operationInProgress=!1,this.timerIdsToSkip=[],this.backoff=new ExponentialBackoff(this,"async_queue_retry"),this.visibilityHandler=function(){_this.backoff.skipBackoff()}}return Object.defineProperty(AsyncQueueImpl.prototype,"isShuttingDown",{get:function(){return this._isShuttingDown},enumerable:!1,configurable:!0}),AsyncQueueImpl.prototype.enqueueAndForget=function(op){this.enqueue(op)},AsyncQueueImpl.prototype.enqueueAndForgetEvenWhileRestricted=function(op){this.verifyNotFailed(),this.enqueueInternal(op)},AsyncQueueImpl.prototype.enterRestrictedMode=function(){this._isShuttingDown||(this._isShuttingDown=!0)},AsyncQueueImpl.prototype.enqueue=function(op){return this.verifyNotFailed(),this._isShuttingDown?new Promise(function(resolve){}):this.enqueueInternal(op)},AsyncQueueImpl.prototype.enqueueRetryable=function(op){var _this=this;this.enqueueAndForget(function(){return _this.retryableOps.push(op),_this.retryNextOp()})},AsyncQueueImpl.prototype.retryNextOp=function(){return tslib.__awaiter(this,void 0,void 0,function(){var e_14,_this=this;return tslib.__generator(this,function(_d){switch(_d.label){case 0:if(0===this.retryableOps.length)return[2];_d.label=1;case 1:return _d.trys.push([1,3,,4]),[4,this.retryableOps[0]()];case 2:return _d.sent(),this.retryableOps.shift(),this.backoff.reset(),[3,4];case 3:if(!isIndexedDbTransactionError(e_14=_d.sent()))throw e_14;return logDebug("AsyncQueue","Operation failed with retryable error: "+e_14),[3,4];case 4:return this.retryableOps.length>0&&this.backoff.backoffAndRun(function(){return _this.retryNextOp()}),[2]}})})},AsyncQueueImpl.prototype.enqueueInternal=function(op){var _this=this,newTail=this.tail.then(function(){return _this.operationInProgress=!0,op().catch(function(error){throw _this.failure=error,_this.operationInProgress=!1,logError("INTERNAL UNHANDLED ERROR: ",function getMessageOrStack(error){var message=error.message||"";error.stack&&(message=error.stack.includes(error.message)?error.stack:error.message+"\n"+error.stack);return message}(error)),error}).then(function(result){return _this.operationInProgress=!1,result})});return this.tail=newTail,newTail},AsyncQueueImpl.prototype.enqueueAfterDelay=function(timerId,delayMs,op){var _this=this;this.verifyNotFailed(),this.timerIdsToSkip.indexOf(timerId)>-1&&(delayMs=0);var delayedOp=DelayedOperation.createAndSchedule(this,timerId,delayMs,op,function(removedOp){return _this.removeDelayedOperation(removedOp)});return this.delayedOperations.push(delayedOp),delayedOp},AsyncQueueImpl.prototype.verifyNotFailed=function(){this.failure&&fail()},AsyncQueueImpl.prototype.verifyOperationInProgress=function(){},AsyncQueueImpl.prototype.drain=function(){return tslib.__awaiter(this,void 0,void 0,function(){var currentTail;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,currentTail=this.tail];case 1:_d.sent(),_d.label=2;case 2:if(currentTail!==this.tail)return[3,0];_d.label=3;case 3:return[2]}})})},AsyncQueueImpl.prototype.containsDelayedOperation=function(timerId){for(var _i=0,_d=this.delayedOperations;_i<_d.length;_i++){if(_d[_i].timerId===timerId)return!0}return!1},AsyncQueueImpl.prototype.runAllDelayedOperationsUntil=function(lastTimerId){var _this=this;return this.drain().then(function(){_this.delayedOperations.sort(function(a,b){return a.targetTimeMs-b.targetTimeMs});for(var _i=0,_d=_this.delayedOperations;_i<_d.length;_i++){var op=_d[_i];if(op.skipDelay(),"all"!==lastTimerId&&op.timerId===lastTimerId)break}return _this.drain()})},AsyncQueueImpl.prototype.skipDelaysForTimerId=function(timerId){this.timerIdsToSkip.push(timerId)},AsyncQueueImpl.prototype.removeDelayedOperation=function(op){var index=this.delayedOperations.indexOf(op);this.delayedOperations.splice(index,1)},AsyncQueueImpl}();var LoadBundleTask=function(){function LoadBundleTask(){this._progressObserver={},this._taskCompletionResolver=new Deferred,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}return LoadBundleTask.prototype.onProgress=function(next,error,complete){this._progressObserver={next:next,error:error,complete:complete}},LoadBundleTask.prototype.catch=function(onRejected){return this._taskCompletionResolver.promise.catch(onRejected)},LoadBundleTask.prototype.then=function(onFulfilled,onRejected){return this._taskCompletionResolver.promise.then(onFulfilled,onRejected)},LoadBundleTask.prototype._completeWith=function(progress){this._updateProgress(progress),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(progress)},LoadBundleTask.prototype._failWith=function(error){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(error),this._taskCompletionResolver.reject(error)},LoadBundleTask.prototype._updateProgress=function(progress){this._lastProgress=progress,this._progressObserver.next&&this._progressObserver.next(progress)},LoadBundleTask}(),FirebaseFirestore=function(_super){function FirebaseFirestore(databaseIdOrApp,authProvider){var _this=_super.call(this,databaseIdOrApp,authProvider)||this;return _this.type="firestore",_this._queue=function newAsyncQueue(){return new AsyncQueueImpl}(),_this._persistenceKey="name"in databaseIdOrApp?databaseIdOrApp.name:"[DEFAULT]",_this}return tslib.__extends(FirebaseFirestore,_super),FirebaseFirestore.prototype._terminate=function(){return this._firestoreClient||configureFirestore(this),this._firestoreClient.terminate()},FirebaseFirestore}(FirebaseFirestore$1);function ensureFirestoreConfigured(firestore){return firestore._firestoreClient||configureFirestore(firestore),firestore._firestoreClient.verifyNotTerminated(),firestore._firestoreClient}function configureFirestore(firestore){var _a,settings=firestore._freezeSettings(),databaseInfo=function makeDatabaseInfo(databaseId,appId,persistenceKey,settings){return new DatabaseInfo(databaseId,appId,persistenceKey,settings.host,settings.ssl,settings.experimentalForceLongPolling,settings.experimentalAutoDetectLongPolling,settings.useFetchStreams)}(firestore._databaseId,(null===(_a=firestore._app)||void 0===_a?void 0:_a.options.appId)||"",firestore._persistenceKey,settings);firestore._firestoreClient=new FirestoreClient(firestore._credentials,firestore._queue,databaseInfo)}function setPersistenceProviders(client,onlineComponentProvider,offlineComponentProvider){var _this=this,persistenceResult=new Deferred;return client.asyncQueue.enqueue(function(){return tslib.__awaiter(_this,void 0,void 0,function(){var e_15;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return _d.trys.push([0,3,,4]),[4,setOfflineComponentProvider(client,offlineComponentProvider)];case 1:return _d.sent(),[4,setOnlineComponentProvider(client,onlineComponentProvider)];case 2:return _d.sent(),persistenceResult.resolve(),[3,4];case 3:if(!function canFallbackFromIndexedDbError(error){if("FirebaseError"===error.name)return error.code===Code_FAILED_PRECONDITION||error.code===Code_UNIMPLEMENTED;if("undefined"!=typeof DOMException&&error instanceof DOMException)return 22===error.code||20===error.code||11===error.code;return!0}(e_15=_d.sent()))throw e_15;return console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+e_15),persistenceResult.reject(e_15),[3,4];case 4:return[2]}})})}).then(function(){return persistenceResult.promise})}function waitForPendingWrites(firestore){return function firestoreClientWaitForPendingWrites(client){var _this=this,deferred=new Deferred;return client.asyncQueue.enqueueAndForget(function(){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,getSyncEngine(client)];case 1:return[2,syncEngineRegisterPendingWritesCallback(_d.sent(),deferred)]}})})}),deferred.promise}(ensureFirestoreConfigured(firestore=cast(firestore,FirebaseFirestore)))}function enableNetwork(firestore){return function firestoreClientEnableNetwork(client){var _this=this;return client.asyncQueue.enqueue(function(){return tslib.__awaiter(_this,void 0,void 0,function(){var persistence,remoteStore;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,getPersistence(client)];case 1:return persistence=_d.sent(),[4,getRemoteStore(client)];case 2:return remoteStore=_d.sent(),persistence.setNetworkEnabled(!0),[2,remoteStoreEnableNetwork(remoteStore)]}})})})}(ensureFirestoreConfigured(firestore=cast(firestore,FirebaseFirestore)))}function disableNetwork(firestore){return function firestoreClientDisableNetwork(client){var _this=this;return client.asyncQueue.enqueue(function(){return tslib.__awaiter(_this,void 0,void 0,function(){var persistence,remoteStore;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,getPersistence(client)];case 1:return persistence=_d.sent(),[4,getRemoteStore(client)];case 2:return remoteStore=_d.sent(),persistence.setNetworkEnabled(!1),[2,remoteStoreDisableNetwork(remoteStore)]}})})})}(ensureFirestoreConfigured(firestore=cast(firestore,FirebaseFirestore)))}function verifyNotInitialized(firestore){if(firestore._initialized||firestore._terminated)throw new FirestoreError(Code_FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}var FieldPath=function(){function FieldPath(){for(var fieldNames=[],_i=0;_i<arguments.length;_i++)fieldNames[_i]=arguments[_i];for(var i=0;i<fieldNames.length;++i)if(0===fieldNames[i].length)throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new FieldPath$1(fieldNames)}return FieldPath.prototype.isEqual=function(other){return this._internalPath.isEqual(other._internalPath)},FieldPath}(),Bytes=function(){function Bytes(byteString){this._byteString=byteString}return Bytes.fromBase64String=function(base64){try{return new Bytes(ByteString.fromBase64String(base64))}catch(e){throw new FirestoreError(Code_INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}},Bytes.fromUint8Array=function(array){return new Bytes(ByteString.fromUint8Array(array))},Bytes.prototype.toBase64=function(){return this._byteString.toBase64()},Bytes.prototype.toUint8Array=function(){return this._byteString.toUint8Array()},Bytes.prototype.toString=function(){return"Bytes(base64: "+this.toBase64()+")"},Bytes.prototype.isEqual=function(other){return this._byteString.isEqual(other._byteString)},Bytes}(),FieldValue=function FieldValue(_methodName){this._methodName=_methodName},GeoPoint=function(){function GeoPoint(latitude,longitude){if(!isFinite(latitude)||latitude<-90||latitude>90)throw new FirestoreError(Code_INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+latitude);if(!isFinite(longitude)||longitude<-180||longitude>180)throw new FirestoreError(Code_INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+longitude);this._lat=latitude,this._long=longitude}return Object.defineProperty(GeoPoint.prototype,"latitude",{get:function(){return this._lat},enumerable:!1,configurable:!0}),Object.defineProperty(GeoPoint.prototype,"longitude",{get:function(){return this._long},enumerable:!1,configurable:!0}),GeoPoint.prototype.isEqual=function(other){return this._lat===other._lat&&this._long===other._long},GeoPoint.prototype.toJSON=function(){return{latitude:this._lat,longitude:this._long}},GeoPoint.prototype._compareTo=function(other){return primitiveComparator(this._lat,other._lat)||primitiveComparator(this._long,other._long)},GeoPoint}(),RESERVED_FIELD_REGEX=/^__.*__$/,ParsedSetData=function(){function ParsedSetData(data,fieldMask,fieldTransforms){this.data=data,this.fieldMask=fieldMask,this.fieldTransforms=fieldTransforms}return ParsedSetData.prototype.toMutation=function(key,precondition){return null!==this.fieldMask?new PatchMutation(key,this.data,this.fieldMask,precondition,this.fieldTransforms):new SetMutation(key,this.data,precondition,this.fieldTransforms)},ParsedSetData}(),ParsedUpdateData=function(){function ParsedUpdateData(data,fieldMask,fieldTransforms){this.data=data,this.fieldMask=fieldMask,this.fieldTransforms=fieldTransforms}return ParsedUpdateData.prototype.toMutation=function(key,precondition){return new PatchMutation(key,this.data,this.fieldMask,precondition,this.fieldTransforms)},ParsedUpdateData}();function isWrite(dataSource){switch(dataSource){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw fail()}}var ParseContextImpl=function(){function ParseContextImpl(settings,databaseId,serializer,ignoreUndefinedProperties,fieldTransforms,fieldMask){this.settings=settings,this.databaseId=databaseId,this.serializer=serializer,this.ignoreUndefinedProperties=ignoreUndefinedProperties,void 0===fieldTransforms&&this.validatePath(),this.fieldTransforms=fieldTransforms||[],this.fieldMask=fieldMask||[]}return Object.defineProperty(ParseContextImpl.prototype,"path",{get:function(){return this.settings.path},enumerable:!1,configurable:!0}),Object.defineProperty(ParseContextImpl.prototype,"dataSource",{get:function(){return this.settings.dataSource},enumerable:!1,configurable:!0}),ParseContextImpl.prototype.contextWith=function(configuration){return new ParseContextImpl(Object.assign(Object.assign({},this.settings),configuration),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)},ParseContextImpl.prototype.childContextForField=function(field){var _a,childPath=null===(_a=this.path)||void 0===_a?void 0:_a.child(field),context=this.contextWith({path:childPath,arrayElement:!1});return context.validatePathSegment(field),context},ParseContextImpl.prototype.childContextForFieldPath=function(field){var _a,childPath=null===(_a=this.path)||void 0===_a?void 0:_a.child(field),context=this.contextWith({path:childPath,arrayElement:!1});return context.validatePath(),context},ParseContextImpl.prototype.childContextForArray=function(index){return this.contextWith({path:void 0,arrayElement:!0})},ParseContextImpl.prototype.createError=function(reason){return createError(reason,this.settings.methodName,this.settings.hasConverter||!1,this.path,this.settings.targetDoc)},ParseContextImpl.prototype.contains=function(fieldPath){return void 0!==this.fieldMask.find(function(field){return fieldPath.isPrefixOf(field)})||void 0!==this.fieldTransforms.find(function(transform){return fieldPath.isPrefixOf(transform.field)})},ParseContextImpl.prototype.validatePath=function(){if(this.path)for(var i=0;i<this.path.length;i++)this.validatePathSegment(this.path.get(i))},ParseContextImpl.prototype.validatePathSegment=function(segment){if(0===segment.length)throw this.createError("Document fields must not be empty");if(isWrite(this.dataSource)&&RESERVED_FIELD_REGEX.test(segment))throw this.createError('Document fields cannot begin and end with "__"')},ParseContextImpl}(),UserDataReader=function(){function UserDataReader(databaseId,ignoreUndefinedProperties,serializer){this.databaseId=databaseId,this.ignoreUndefinedProperties=ignoreUndefinedProperties,this.serializer=serializer||newSerializer(databaseId)}return UserDataReader.prototype.createContext=function(dataSource,methodName,targetDoc,hasConverter){return void 0===hasConverter&&(hasConverter=!1),new ParseContextImpl({dataSource:dataSource,methodName:methodName,targetDoc:targetDoc,path:FieldPath$1.emptyPath(),arrayElement:!1,hasConverter:hasConverter},this.databaseId,this.serializer,this.ignoreUndefinedProperties)},UserDataReader}();function newUserDataReader(firestore){var settings=firestore._freezeSettings(),serializer=newSerializer(firestore._databaseId);return new UserDataReader(firestore._databaseId,!!settings.ignoreUndefinedProperties,serializer)}function parseSetData(userDataReader,methodName,targetDoc,input,hasConverter,options){void 0===options&&(options={});var context=userDataReader.createContext(options.merge||options.mergeFields?2:0,methodName,targetDoc,hasConverter);validatePlainObject("Data must be an object, but it was:",context,input);var fieldMask,fieldTransforms,updateData=parseObject(input,context);if(options.merge)fieldMask=new FieldMask(context.fieldMask),fieldTransforms=context.fieldTransforms;else if(options.mergeFields){for(var validatedFieldPaths=[],_i=0,_d=options.mergeFields;_i<_d.length;_i++){var fieldPath=fieldPathFromArgument$1(methodName,_d[_i],targetDoc);if(!context.contains(fieldPath))throw new FirestoreError(Code_INVALID_ARGUMENT,"Field '"+fieldPath+"' is specified in your field mask but missing from your input data.");fieldMaskContains(validatedFieldPaths,fieldPath)||validatedFieldPaths.push(fieldPath)}fieldMask=new FieldMask(validatedFieldPaths),fieldTransforms=context.fieldTransforms.filter(function(transform){return fieldMask.covers(transform.field)})}else fieldMask=null,fieldTransforms=context.fieldTransforms;return new ParsedSetData(new ObjectValue(updateData),fieldMask,fieldTransforms)}var DeleteFieldValueImpl=function(_super){function DeleteFieldValueImpl(){return null!==_super&&_super.apply(this,arguments)||this}return tslib.__extends(DeleteFieldValueImpl,_super),DeleteFieldValueImpl.prototype._toFieldTransform=function(context){if(2!==context.dataSource)throw 1===context.dataSource?context.createError(this._methodName+"() can only appear at the top level of your update data"):context.createError(this._methodName+"() cannot be used with set() unless you pass {merge:true}");return context.fieldMask.push(context.path),null},DeleteFieldValueImpl.prototype.isEqual=function(other){return other instanceof DeleteFieldValueImpl},DeleteFieldValueImpl}(FieldValue);function createSentinelChildContext(fieldValue,context,arrayElement){return new ParseContextImpl({dataSource:3,targetDoc:context.settings.targetDoc,methodName:fieldValue._methodName,arrayElement:arrayElement},context.databaseId,context.serializer,context.ignoreUndefinedProperties)}var ServerTimestampFieldValueImpl=function(_super){function ServerTimestampFieldValueImpl(){return null!==_super&&_super.apply(this,arguments)||this}return tslib.__extends(ServerTimestampFieldValueImpl,_super),ServerTimestampFieldValueImpl.prototype._toFieldTransform=function(context){return new FieldTransform(context.path,new ServerTimestampTransform)},ServerTimestampFieldValueImpl.prototype.isEqual=function(other){return other instanceof ServerTimestampFieldValueImpl},ServerTimestampFieldValueImpl}(FieldValue),ArrayUnionFieldValueImpl=function(_super){function ArrayUnionFieldValueImpl(methodName,_elements){var _this=_super.call(this,methodName)||this;return _this._elements=_elements,_this}return tslib.__extends(ArrayUnionFieldValueImpl,_super),ArrayUnionFieldValueImpl.prototype._toFieldTransform=function(context){var parseContext=createSentinelChildContext(this,context,!0),parsedElements=this._elements.map(function(element){return parseData(element,parseContext)}),arrayUnion=new ArrayUnionTransformOperation(parsedElements);return new FieldTransform(context.path,arrayUnion)},ArrayUnionFieldValueImpl.prototype.isEqual=function(other){return this===other},ArrayUnionFieldValueImpl}(FieldValue),ArrayRemoveFieldValueImpl=function(_super){function ArrayRemoveFieldValueImpl(methodName,_elements){var _this=_super.call(this,methodName)||this;return _this._elements=_elements,_this}return tslib.__extends(ArrayRemoveFieldValueImpl,_super),ArrayRemoveFieldValueImpl.prototype._toFieldTransform=function(context){var parseContext=createSentinelChildContext(this,context,!0),parsedElements=this._elements.map(function(element){return parseData(element,parseContext)}),arrayUnion=new ArrayRemoveTransformOperation(parsedElements);return new FieldTransform(context.path,arrayUnion)},ArrayRemoveFieldValueImpl.prototype.isEqual=function(other){return this===other},ArrayRemoveFieldValueImpl}(FieldValue),NumericIncrementFieldValueImpl=function(_super){function NumericIncrementFieldValueImpl(methodName,_operand){var _this=_super.call(this,methodName)||this;return _this._operand=_operand,_this}return tslib.__extends(NumericIncrementFieldValueImpl,_super),NumericIncrementFieldValueImpl.prototype._toFieldTransform=function(context){var numericIncrement=new NumericIncrementTransformOperation(context.serializer,toNumber(context.serializer,this._operand));return new FieldTransform(context.path,numericIncrement)},NumericIncrementFieldValueImpl.prototype.isEqual=function(other){return this===other},NumericIncrementFieldValueImpl}(FieldValue);function parseUpdateData(userDataReader,methodName,targetDoc,input){var context=userDataReader.createContext(1,methodName,targetDoc);validatePlainObject("Data must be an object, but it was:",context,input);var fieldMaskPaths=[],updateData=ObjectValue.empty();forEach(input,function(key,value){var path=fieldPathFromDotSeparatedString(methodName,key,targetDoc);value=util.getModularInstance(value);var childContext=context.childContextForFieldPath(path);if(value instanceof DeleteFieldValueImpl)fieldMaskPaths.push(path);else{var parsedValue=parseData(value,childContext);null!=parsedValue&&(fieldMaskPaths.push(path),updateData.set(path,parsedValue))}});var mask=new FieldMask(fieldMaskPaths);return new ParsedUpdateData(updateData,mask,context.fieldTransforms)}function parseUpdateVarargs(userDataReader,methodName,targetDoc,field,value,moreFieldsAndValues){var context=userDataReader.createContext(1,methodName,targetDoc),keys=[fieldPathFromArgument$1(methodName,field,targetDoc)],values=[value];if(moreFieldsAndValues.length%2!=0)throw new FirestoreError(Code_INVALID_ARGUMENT,"Function "+methodName+"() needs to be called with an even number of arguments that alternate between field names and values.");for(var i=0;i<moreFieldsAndValues.length;i+=2)keys.push(fieldPathFromArgument$1(methodName,moreFieldsAndValues[i])),values.push(moreFieldsAndValues[i+1]);var fieldMaskPaths=[],updateData=ObjectValue.empty();for(i=keys.length-1;i>=0;--i)if(!fieldMaskContains(fieldMaskPaths,keys[i])){var path=keys[i],value_1=values[i];value_1=util.getModularInstance(value_1);var childContext=context.childContextForFieldPath(path);if(value_1 instanceof DeleteFieldValueImpl)fieldMaskPaths.push(path);else{var parsedValue=parseData(value_1,childContext);null!=parsedValue&&(fieldMaskPaths.push(path),updateData.set(path,parsedValue))}}var mask=new FieldMask(fieldMaskPaths);return new ParsedUpdateData(updateData,mask,context.fieldTransforms)}function parseQueryValue(userDataReader,methodName,input,allowArrays){return void 0===allowArrays&&(allowArrays=!1),parseData(input,userDataReader.createContext(allowArrays?4:3,methodName))}function parseData(input,context){if(looksLikeJsonObject(input=util.getModularInstance(input)))return validatePlainObject("Unsupported field value:",context,input),parseObject(input,context);if(input instanceof FieldValue)return function parseSentinelFieldValue(value,context){if(!isWrite(context.dataSource))throw context.createError(value._methodName+"() can only be used with update() and set()");if(!context.path)throw context.createError(value._methodName+"() is not currently supported inside arrays");var fieldTransform=value._toFieldTransform(context);fieldTransform&&context.fieldTransforms.push(fieldTransform)}(input,context),null;if(void 0===input&&context.ignoreUndefinedProperties)return null;if(context.path&&context.fieldMask.push(context.path),input instanceof Array){if(context.settings.arrayElement&&4!==context.dataSource)throw context.createError("Nested arrays are not supported");return function parseArray(array,context){for(var values=[],entryIndex=0,_i=0,array_1=array;_i<array_1.length;_i++){var parsedEntry=parseData(array_1[_i],context.childContextForArray(entryIndex));null==parsedEntry&&(parsedEntry={nullValue:"NULL_VALUE"}),values.push(parsedEntry),entryIndex++}return{arrayValue:{values:values}}}(input,context)}return function parseScalarValue(value,context){if(null===(value=util.getModularInstance(value)))return{nullValue:"NULL_VALUE"};if("number"==typeof value)return toNumber(context.serializer,value);if("boolean"==typeof value)return{booleanValue:value};if("string"==typeof value)return{stringValue:value};if(value instanceof Date){var timestamp=Timestamp.fromDate(value);return{timestampValue:toTimestamp(context.serializer,timestamp)}}if(value instanceof Timestamp){timestamp=new Timestamp(value.seconds,1e3*Math.floor(value.nanoseconds/1e3));return{timestampValue:toTimestamp(context.serializer,timestamp)}}if(value instanceof GeoPoint)return{geoPointValue:{latitude:value.latitude,longitude:value.longitude}};if(value instanceof Bytes)return{bytesValue:toBytes(context.serializer,value._byteString)};if(value instanceof DocumentReference$1){var thisDb=context.databaseId,otherDb=value.firestore._databaseId;if(!otherDb.isEqual(thisDb))throw context.createError("Document reference is for database "+otherDb.projectId+"/"+otherDb.database+" but should be for database "+thisDb.projectId+"/"+thisDb.database);return{referenceValue:toResourceName(value.firestore._databaseId||context.databaseId,value._key.path)}}throw context.createError("Unsupported field value: "+valueDescription(value))}(input,context)}function parseObject(obj,context){var fields={};return isEmpty(obj)?context.path&&context.path.length>0&&context.fieldMask.push(context.path):forEach(obj,function(key,val){var parsedValue=parseData(val,context.childContextForField(key));null!=parsedValue&&(fields[key]=parsedValue)}),{mapValue:{fields:fields}}}function looksLikeJsonObject(input){return!("object"!=typeof input||null===input||input instanceof Array||input instanceof Date||input instanceof Timestamp||input instanceof GeoPoint||input instanceof Bytes||input instanceof DocumentReference$1||input instanceof FieldValue)}function validatePlainObject(message,context,input){if(!looksLikeJsonObject(input)||!function isPlainObject(input){return"object"==typeof input&&null!==input&&(Object.getPrototypeOf(input)===Object.prototype||null===Object.getPrototypeOf(input))}(input)){var description=valueDescription(input);throw"an object"===description?context.createError(message+" a custom object"):context.createError(message+" "+description)}}function fieldPathFromArgument$1(methodName,path,targetDoc){if((path=util.getModularInstance(path))instanceof FieldPath)return path._internalPath;if("string"==typeof path)return fieldPathFromDotSeparatedString(methodName,path);throw createError("Field path arguments must be of type string or FieldPath.",methodName,!1,void 0,targetDoc)}var FIELD_PATH_RESERVED=new RegExp("[~\\*/\\[\\]]");function fieldPathFromDotSeparatedString(methodName,path,targetDoc){if(path.search(FIELD_PATH_RESERVED)>=0)throw createError("Invalid field path ("+path+"). Paths must not contain '~', '*', '/', '[', or ']'",methodName,!1,void 0,targetDoc);try{return(new(FieldPath.bind.apply(FieldPath,tslib.__spreadArray([void 0],path.split(".")))))._internalPath}catch(e){throw createError("Invalid field path ("+path+"). Paths must not be empty, begin with '.', end with '.', or contain '..'",methodName,!1,void 0,targetDoc)}}function createError(reason,methodName,hasConverter,path,targetDoc){var hasPath=path&&!path.isEmpty(),hasDocument=void 0!==targetDoc,message="Function "+methodName+"() called with invalid data";hasConverter&&(message+=" (via `toFirestore()`)");var description="";return(hasPath||hasDocument)&&(description+=" (found",hasPath&&(description+=" in field "+path),hasDocument&&(description+=" in document "+targetDoc),description+=")"),new FirestoreError(Code_INVALID_ARGUMENT,(message+=". ")+reason+description)}function fieldMaskContains(haystack,needle){return haystack.some(function(v){return v.isEqual(needle)})}var DocumentSnapshot$2=function(){function DocumentSnapshot$2(_firestore,_userDataWriter,_key,_document,_converter){this._firestore=_firestore,this._userDataWriter=_userDataWriter,this._key=_key,this._document=_document,this._converter=_converter}return Object.defineProperty(DocumentSnapshot$2.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!1,configurable:!0}),Object.defineProperty(DocumentSnapshot$2.prototype,"ref",{get:function(){return new DocumentReference$1(this._firestore,this._converter,this._key)},enumerable:!1,configurable:!0}),DocumentSnapshot$2.prototype.exists=function(){return null!==this._document},DocumentSnapshot$2.prototype.data=function(){if(this._document){if(this._converter){var snapshot=new QueryDocumentSnapshot$2(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(snapshot)}return this._userDataWriter.convertValue(this._document.data.value)}},DocumentSnapshot$2.prototype.get=function(fieldPath){if(this._document){var value=this._document.data.field(fieldPathFromArgument("DocumentSnapshot.get",fieldPath));if(null!==value)return this._userDataWriter.convertValue(value)}},DocumentSnapshot$2}(),QueryDocumentSnapshot$2=function(_super){function QueryDocumentSnapshot$2(){return null!==_super&&_super.apply(this,arguments)||this}return tslib.__extends(QueryDocumentSnapshot$2,_super),QueryDocumentSnapshot$2.prototype.data=function(){return _super.prototype.data.call(this)},QueryDocumentSnapshot$2}(DocumentSnapshot$2);function fieldPathFromArgument(methodName,arg){return"string"==typeof arg?fieldPathFromDotSeparatedString(methodName,arg):arg instanceof FieldPath?arg._internalPath:arg._delegate._internalPath}var SnapshotMetadata=function(){function SnapshotMetadata(hasPendingWrites,fromCache){this.hasPendingWrites=hasPendingWrites,this.fromCache=fromCache}return SnapshotMetadata.prototype.isEqual=function(other){return this.hasPendingWrites===other.hasPendingWrites&&this.fromCache===other.fromCache},SnapshotMetadata}(),DocumentSnapshot$1=function(_super){function DocumentSnapshot$1(_firestore,userDataWriter,key,document,metadata,converter){var _this=_super.call(this,_firestore,userDataWriter,key,document,converter)||this;return _this._firestore=_firestore,_this._firestoreImpl=_firestore,_this.metadata=metadata,_this}return tslib.__extends(DocumentSnapshot$1,_super),DocumentSnapshot$1.prototype.exists=function(){return _super.prototype.exists.call(this)},DocumentSnapshot$1.prototype.data=function(options){if(void 0===options&&(options={}),this._document){if(this._converter){var snapshot=new QueryDocumentSnapshot$1(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(snapshot,options)}return this._userDataWriter.convertValue(this._document.data.value,options.serverTimestamps)}},DocumentSnapshot$1.prototype.get=function(fieldPath,options){if(void 0===options&&(options={}),this._document){var value=this._document.data.field(fieldPathFromArgument("DocumentSnapshot.get",fieldPath));if(null!==value)return this._userDataWriter.convertValue(value,options.serverTimestamps)}},DocumentSnapshot$1}(DocumentSnapshot$2),QueryDocumentSnapshot$1=function(_super){function QueryDocumentSnapshot$1(){return null!==_super&&_super.apply(this,arguments)||this}return tslib.__extends(QueryDocumentSnapshot$1,_super),QueryDocumentSnapshot$1.prototype.data=function(options){return void 0===options&&(options={}),_super.prototype.data.call(this,options)},QueryDocumentSnapshot$1}(DocumentSnapshot$1),QuerySnapshot$1=function(){function QuerySnapshot$1(_firestore,_userDataWriter,query,_snapshot){this._firestore=_firestore,this._userDataWriter=_userDataWriter,this._snapshot=_snapshot,this.metadata=new SnapshotMetadata(_snapshot.hasPendingWrites,_snapshot.fromCache),this.query=query}return Object.defineProperty(QuerySnapshot$1.prototype,"docs",{get:function(){var result=[];return this.forEach(function(doc){return result.push(doc)}),result},enumerable:!1,configurable:!0}),Object.defineProperty(QuerySnapshot$1.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:!1,configurable:!0}),Object.defineProperty(QuerySnapshot$1.prototype,"empty",{get:function(){return 0===this.size},enumerable:!1,configurable:!0}),QuerySnapshot$1.prototype.forEach=function(callback,thisArg){var _this=this;this._snapshot.docs.forEach(function(doc){callback.call(thisArg,new QueryDocumentSnapshot$1(_this._firestore,_this._userDataWriter,doc.key,doc,new SnapshotMetadata(_this._snapshot.mutatedKeys.has(doc.key),_this._snapshot.fromCache),_this.query.converter))})},QuerySnapshot$1.prototype.docChanges=function(options){void 0===options&&(options={});var includeMetadataChanges=!!options.includeMetadataChanges;if(includeMetadataChanges&&this._snapshot.excludesMetadataChanges)throw new FirestoreError(Code_INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===includeMetadataChanges||(this._cachedChanges=function changesFromSnapshot(querySnapshot,includeMetadataChanges){if(querySnapshot._snapshot.oldDocs.isEmpty()){var index_1=0;return querySnapshot._snapshot.docChanges.map(function(change){return{type:"added",doc:new QueryDocumentSnapshot$1(querySnapshot._firestore,querySnapshot._userDataWriter,change.doc.key,change.doc,new SnapshotMetadata(querySnapshot._snapshot.mutatedKeys.has(change.doc.key),querySnapshot._snapshot.fromCache),querySnapshot.query.converter),oldIndex:-1,newIndex:index_1++}})}var indexTracker_1=querySnapshot._snapshot.oldDocs;return querySnapshot._snapshot.docChanges.filter(function(change){return includeMetadataChanges||3!==change.type}).map(function(change){var doc=new QueryDocumentSnapshot$1(querySnapshot._firestore,querySnapshot._userDataWriter,change.doc.key,change.doc,new SnapshotMetadata(querySnapshot._snapshot.mutatedKeys.has(change.doc.key),querySnapshot._snapshot.fromCache),querySnapshot.query.converter),oldIndex=-1,newIndex=-1;return 0!==change.type&&(oldIndex=indexTracker_1.indexOf(change.doc.key),indexTracker_1=indexTracker_1.delete(change.doc.key)),1!==change.type&&(newIndex=(indexTracker_1=indexTracker_1.add(change.doc)).indexOf(change.doc.key)),{type:resultChangeType(change.type),doc:doc,oldIndex:oldIndex,newIndex:newIndex}})}(this,includeMetadataChanges),this._cachedChangesIncludeMetadataChanges=includeMetadataChanges),this._cachedChanges},QuerySnapshot$1}();function resultChangeType(type){switch(type){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return fail()}}function snapshotEqual(left,right){return left instanceof DocumentSnapshot$1&&right instanceof DocumentSnapshot$1?left._firestore===right._firestore&&left._key.isEqual(right._key)&&(null===left._document?null===right._document:left._document.isEqual(right._document))&&left._converter===right._converter:left instanceof QuerySnapshot$1&&right instanceof QuerySnapshot$1&&(left._firestore===right._firestore&&queryEqual(left.query,right.query)&&left.metadata.isEqual(right.metadata)&&left._snapshot.isEqual(right._snapshot))}function validateHasExplicitOrderByForLimitToLast(query){if(hasLimitToLast(query)&&0===query.explicitOrderBy.length)throw new FirestoreError(Code_UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}var QueryConstraint=function QueryConstraint(){};function query(query){for(var queryConstraints=[],_i=1;_i<arguments.length;_i++)queryConstraints[_i-1]=arguments[_i];for(var _d=0,queryConstraints_1=queryConstraints;_d<queryConstraints_1.length;_d++){var constraint=queryConstraints_1[_d];query=constraint._apply(query)}return query}var QueryFilterConstraint=function(_super){function QueryFilterConstraint(_field,_op,_value){var _this=_super.call(this)||this;return _this._field=_field,_this._op=_op,_this._value=_value,_this.type="where",_this}return tslib.__extends(QueryFilterConstraint,_super),QueryFilterConstraint.prototype._apply=function(query){var reader=newUserDataReader(query.firestore),filter=function newQueryFilter(query,methodName,dataReader,databaseId,fieldPath,op,value){var fieldValue;if(fieldPath.isKeyField()){if("array-contains"===op||"array-contains-any"===op)throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid Query. You can't perform '"+op+"' queries on FieldPath.documentId().");if("in"===op||"not-in"===op){validateDisjunctiveFilterElements(value,op);for(var referenceList=[],_i=0,value_2=value;_i<value_2.length;_i++){var arrayValue=value_2[_i];referenceList.push(parseDocumentIdValue(databaseId,query,arrayValue))}fieldValue={arrayValue:{values:referenceList}}}else fieldValue=parseDocumentIdValue(databaseId,query,value)}else"in"!==op&&"not-in"!==op&&"array-contains-any"!==op||validateDisjunctiveFilterElements(value,op),fieldValue=parseQueryValue(dataReader,methodName,value,"in"===op||"not-in"===op);var filter=FieldFilter.create(fieldPath,op,fieldValue);return function validateNewFilter(query,filter){if(filter.isInequality()){var existingField=getInequalityFilterField(query);if(null!==existingField&&!existingField.isEqual(filter.field))throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '"+existingField.toString()+"' and '"+filter.field.toString()+"'");var firstOrderByField=getFirstOrderByField(query);null!==firstOrderByField&&validateOrderByAndInequalityMatch(query,filter.field,firstOrderByField)}var conflictingOp=function findFilterOperator(query,operators){for(var _i=0,_d=query.filters;_i<_d.length;_i++){var filter=_d[_i];if(operators.indexOf(filter.op)>=0)return filter.op}return null}(query,function conflictingOps(op){switch(op){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(filter.op));if(null!==conflictingOp)throw conflictingOp===filter.op?new FirestoreError(Code_INVALID_ARGUMENT,"Invalid query. You cannot use more than one '"+filter.op.toString()+"' filter."):new FirestoreError(Code_INVALID_ARGUMENT,"Invalid query. You cannot use '"+filter.op.toString()+"' filters with '"+conflictingOp.toString()+"' filters.")}(query,filter),filter}(query._query,"where",reader,query.firestore._databaseId,this._field,this._op,this._value);return new Query$1(query.firestore,query.converter,function queryWithAddedFilter(query,filter){var newFilters=query.filters.concat([filter]);return new QueryImpl(query.path,query.collectionGroup,query.explicitOrderBy.slice(),newFilters,query.limit,query.limitType,query.startAt,query.endAt)}(query._query,filter))},QueryFilterConstraint}(QueryConstraint);var QueryOrderByConstraint=function(_super){function QueryOrderByConstraint(_field,_direction){var _this=_super.call(this)||this;return _this._field=_field,_this._direction=_direction,_this.type="orderBy",_this}return tslib.__extends(QueryOrderByConstraint,_super),QueryOrderByConstraint.prototype._apply=function(query){var orderBy=function newQueryOrderBy(query,fieldPath,direction){if(null!==query.startAt)throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==query.endAt)throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");var orderBy=new OrderBy(fieldPath,direction);return function validateNewOrderBy(query,orderBy){if(null===getFirstOrderByField(query)){var inequalityField=getInequalityFilterField(query);null!==inequalityField&&validateOrderByAndInequalityMatch(query,inequalityField,orderBy.field)}}(query,orderBy),orderBy}(query._query,this._field,this._direction);return new Query$1(query.firestore,query.converter,function queryWithAddedOrderBy(query,orderBy){var newOrderBy=query.explicitOrderBy.concat([orderBy]);return new QueryImpl(query.path,query.collectionGroup,newOrderBy,query.filters.slice(),query.limit,query.limitType,query.startAt,query.endAt)}(query._query,orderBy))},QueryOrderByConstraint}(QueryConstraint);var QueryLimitConstraint=function(_super){function QueryLimitConstraint(type,_limit,_limitType){var _this=_super.call(this)||this;return _this.type=type,_this._limit=_limit,_this._limitType=_limitType,_this}return tslib.__extends(QueryLimitConstraint,_super),QueryLimitConstraint.prototype._apply=function(query){return new Query$1(query.firestore,query.converter,queryWithLimit(query._query,this._limit,this._limitType))},QueryLimitConstraint}(QueryConstraint);var QueryStartAtConstraint=function(_super){function QueryStartAtConstraint(type,_docOrFields,_before){var _this=_super.call(this)||this;return _this.type=type,_this._docOrFields=_docOrFields,_this._before=_before,_this}return tslib.__extends(QueryStartAtConstraint,_super),QueryStartAtConstraint.prototype._apply=function(query){var bound=newQueryBoundFromDocOrFields(query,this.type,this._docOrFields,this._before);return new Query$1(query.firestore,query.converter,function queryWithStartAt(query,bound){return new QueryImpl(query.path,query.collectionGroup,query.explicitOrderBy.slice(),query.filters.slice(),query.limit,query.limitType,bound,query.endAt)}(query._query,bound))},QueryStartAtConstraint}(QueryConstraint);function startAt(){for(var docOrFields=[],_i=0;_i<arguments.length;_i++)docOrFields[_i]=arguments[_i];return new QueryStartAtConstraint("startAt",docOrFields,!0)}function startAfter(){for(var docOrFields=[],_i=0;_i<arguments.length;_i++)docOrFields[_i]=arguments[_i];return new QueryStartAtConstraint("startAfter",docOrFields,!1)}var QueryEndAtConstraint=function(_super){function QueryEndAtConstraint(type,_docOrFields,_before){var _this=_super.call(this)||this;return _this.type=type,_this._docOrFields=_docOrFields,_this._before=_before,_this}return tslib.__extends(QueryEndAtConstraint,_super),QueryEndAtConstraint.prototype._apply=function(query){var bound=newQueryBoundFromDocOrFields(query,this.type,this._docOrFields,this._before);return new Query$1(query.firestore,query.converter,function queryWithEndAt(query,bound){return new QueryImpl(query.path,query.collectionGroup,query.explicitOrderBy.slice(),query.filters.slice(),query.limit,query.limitType,query.startAt,bound)}(query._query,bound))},QueryEndAtConstraint}(QueryConstraint);function endBefore(){for(var docOrFields=[],_i=0;_i<arguments.length;_i++)docOrFields[_i]=arguments[_i];return new QueryEndAtConstraint("endBefore",docOrFields,!0)}function endAt(){for(var docOrFields=[],_i=0;_i<arguments.length;_i++)docOrFields[_i]=arguments[_i];return new QueryEndAtConstraint("endAt",docOrFields,!1)}function newQueryBoundFromDocOrFields(query,methodName,docOrFields,before){if(docOrFields[0]=util.getModularInstance(docOrFields[0]),docOrFields[0]instanceof DocumentSnapshot$2)return function newQueryBoundFromDocument(query,databaseId,methodName,doc,before){if(!doc)throw new FirestoreError(Code_NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+methodName+"().");for(var components=[],_i=0,_d=queryOrderBy(query);_i<_d.length;_i++){var orderBy_5=_d[_i];if(orderBy_5.field.isKeyField())components.push(refValue(databaseId,doc.key));else{var value=doc.data.field(orderBy_5.field);if(isServerTimestamp(value))throw new FirestoreError(Code_INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+orderBy_5.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===value){var field=orderBy_5.field.canonicalString();throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '"+field+"' (used as the orderBy) does not exist.")}components.push(value)}}return new Bound(components,before)}(query._query,query.firestore._databaseId,methodName,docOrFields[0]._document,before);var reader=newUserDataReader(query.firestore);return function newQueryBoundFromFields(query,databaseId,dataReader,methodName,values,before){var orderBy=query.explicitOrderBy;if(values.length>orderBy.length)throw new FirestoreError(Code_INVALID_ARGUMENT,"Too many arguments provided to "+methodName+"(). The number of arguments must be less than or equal to the number of orderBy() clauses");for(var components=[],i=0;i<values.length;i++){var rawValue=values[i];if(orderBy[i].field.isKeyField()){if("string"!=typeof rawValue)throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+methodName+"(), but got a "+typeof rawValue);if(!isCollectionGroupQuery(query)&&-1!==rawValue.indexOf("/"))throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to "+methodName+"() must be a plain document ID, but '"+rawValue+"' contains a slash.");var path=query.path.child(ResourcePath.fromString(rawValue));if(!DocumentKey.isDocumentKey(path))throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to "+methodName+"() must result in a valid document path, but '"+path+"' is not because it contains an odd number of segments.");var key=new DocumentKey(path);components.push(refValue(databaseId,key))}else{var wrapped=parseQueryValue(dataReader,methodName,rawValue);components.push(wrapped)}}return new Bound(components,before)}(query._query,query.firestore._databaseId,reader,methodName,docOrFields,before)}function parseDocumentIdValue(databaseId,query,documentIdValue){if("string"==typeof(documentIdValue=util.getModularInstance(documentIdValue))){if(""===documentIdValue)throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid document ID, but it was an empty string.");if(!isCollectionGroupQuery(query)&&-1!==documentIdValue.indexOf("/"))throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid query. When querying a collection by FieldPath.documentId(), you must provide a plain document ID, but '"+documentIdValue+"' contains a '/' character.");var path=query.path.child(ResourcePath.fromString(documentIdValue));if(!DocumentKey.isDocumentKey(path))throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid query. When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '"+path+"' is not because it has an odd number of segments ("+path.length+").");return refValue(databaseId,new DocumentKey(path))}if(documentIdValue instanceof DocumentReference$1)return refValue(databaseId,documentIdValue._key);throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid string or a DocumentReference, but it was: "+valueDescription(documentIdValue)+".")}function validateDisjunctiveFilterElements(value,operator){if(!Array.isArray(value)||0===value.length)throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid Query. A non-empty array is required for '"+operator.toString()+"' filters.");if(value.length>10)throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid Query. '"+operator.toString()+"' filters support a maximum of 10 elements in the value array.")}function validateOrderByAndInequalityMatch(baseQuery,inequality,orderBy){if(!orderBy.isEqual(inequality))throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '"+inequality.toString()+"' and so you must also use '"+inequality.toString()+"' as your first argument to orderBy(), but your first orderBy() is on field '"+orderBy.toString()+"' instead.")}var AbstractUserDataWriter=function(){function AbstractUserDataWriter(){}return AbstractUserDataWriter.prototype.convertValue=function(value,serverTimestampBehavior){switch(void 0===serverTimestampBehavior&&(serverTimestampBehavior="none"),typeOrder(value)){case 0:return null;case 1:return value.booleanValue;case 2:return normalizeNumber(value.integerValue||value.doubleValue);case 3:return this.convertTimestamp(value.timestampValue);case 4:return this.convertServerTimestamp(value,serverTimestampBehavior);case 5:return value.stringValue;case 6:return this.convertBytes(normalizeByteString(value.bytesValue));case 7:return this.convertReference(value.referenceValue);case 8:return this.convertGeoPoint(value.geoPointValue);case 9:return this.convertArray(value.arrayValue,serverTimestampBehavior);case 10:return this.convertObject(value.mapValue,serverTimestampBehavior);default:throw fail()}},AbstractUserDataWriter.prototype.convertObject=function(mapValue,serverTimestampBehavior){var _this=this,result={};return forEach(mapValue.fields,function(key,value){result[key]=_this.convertValue(value,serverTimestampBehavior)}),result},AbstractUserDataWriter.prototype.convertGeoPoint=function(value){return new GeoPoint(normalizeNumber(value.latitude),normalizeNumber(value.longitude))},AbstractUserDataWriter.prototype.convertArray=function(arrayValue,serverTimestampBehavior){var _this=this;return(arrayValue.values||[]).map(function(value){return _this.convertValue(value,serverTimestampBehavior)})},AbstractUserDataWriter.prototype.convertServerTimestamp=function(value,serverTimestampBehavior){switch(serverTimestampBehavior){case"previous":var previousValue=getPreviousValue(value);return null==previousValue?null:this.convertValue(previousValue,serverTimestampBehavior);case"estimate":return this.convertTimestamp(getLocalWriteTime(value));default:return null}},AbstractUserDataWriter.prototype.convertTimestamp=function(value){var normalizedValue=normalizeTimestamp(value);return new Timestamp(normalizedValue.seconds,normalizedValue.nanos)},AbstractUserDataWriter.prototype.convertDocumentKey=function(name,expectedDatabaseId){var resourcePath=ResourcePath.fromString(name);hardAssert(isValidResourceName(resourcePath));var databaseId=new DatabaseId(resourcePath.get(1),resourcePath.get(3)),key=new DocumentKey(resourcePath.popFirst(5));return databaseId.isEqual(expectedDatabaseId)||logError("Document "+key+" contains a document reference within a different database ("+databaseId.projectId+"/"+databaseId.database+") which is not supported. It will be treated as a reference in the current database ("+expectedDatabaseId.projectId+"/"+expectedDatabaseId.database+") instead."),key},AbstractUserDataWriter}();function applyFirestoreDataConverter(converter,value,options){return converter?options&&(options.merge||options.mergeFields)?converter.toFirestore(value,options):converter.toFirestore(value):value}var LiteUserDataWriter=function(_super){function LiteUserDataWriter(firestore){var _this=_super.call(this)||this;return _this.firestore=firestore,_this}return tslib.__extends(LiteUserDataWriter,_super),LiteUserDataWriter.prototype.convertBytes=function(bytes){return new Bytes(bytes)},LiteUserDataWriter.prototype.convertReference=function(name){var key=this.convertDocumentKey(name,this.firestore._databaseId);return new DocumentReference$1(this.firestore,null,key)},LiteUserDataWriter}(AbstractUserDataWriter),WriteBatch$1=function(){function WriteBatch$1(_firestore,_commitHandler){this._firestore=_firestore,this._commitHandler=_commitHandler,this._mutations=[],this._committed=!1,this._dataReader=newUserDataReader(_firestore)}return WriteBatch$1.prototype.set=function(documentRef,data,options){this._verifyNotCommitted();var ref=validateReference(documentRef,this._firestore),convertedValue=applyFirestoreDataConverter(ref.converter,data,options),parsed=parseSetData(this._dataReader,"WriteBatch.set",ref._key,convertedValue,null!==ref.converter,options);return this._mutations.push(parsed.toMutation(ref._key,Precondition.none())),this},WriteBatch$1.prototype.update=function(documentRef,fieldOrUpdateData,value){for(var moreFieldsAndValues=[],_i=3;_i<arguments.length;_i++)moreFieldsAndValues[_i-3]=arguments[_i];this._verifyNotCommitted();var parsed,ref=validateReference(documentRef,this._firestore);return parsed="string"==typeof(fieldOrUpdateData=util.getModularInstance(fieldOrUpdateData))||fieldOrUpdateData instanceof FieldPath?parseUpdateVarargs(this._dataReader,"WriteBatch.update",ref._key,fieldOrUpdateData,value,moreFieldsAndValues):parseUpdateData(this._dataReader,"WriteBatch.update",ref._key,fieldOrUpdateData),this._mutations.push(parsed.toMutation(ref._key,Precondition.exists(!0))),this},WriteBatch$1.prototype.delete=function(documentRef){this._verifyNotCommitted();var ref=validateReference(documentRef,this._firestore);return this._mutations=this._mutations.concat(new DeleteMutation(ref._key,Precondition.none())),this},WriteBatch$1.prototype.commit=function(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()},WriteBatch$1.prototype._verifyNotCommitted=function(){if(this._committed)throw new FirestoreError(Code_FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")},WriteBatch$1}();function validateReference(documentRef,firestore){if((documentRef=util.getModularInstance(documentRef)).firestore!==firestore)throw new FirestoreError(Code_INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return documentRef}var Transaction$2=function(){function Transaction$2(_firestore,_transaction){this._firestore=_firestore,this._transaction=_transaction,this._dataReader=newUserDataReader(_firestore)}return Transaction$2.prototype.get=function(documentRef){var _this=this,ref=validateReference(documentRef,this._firestore),userDataWriter=new LiteUserDataWriter(this._firestore);return this._transaction.lookup([ref._key]).then(function(docs){if(!docs||1!==docs.length)return fail();var doc=docs[0];if(doc.isFoundDocument())return new DocumentSnapshot$2(_this._firestore,userDataWriter,doc.key,doc,ref.converter);if(doc.isNoDocument())return new DocumentSnapshot$2(_this._firestore,userDataWriter,ref._key,null,ref.converter);throw fail()})},Transaction$2.prototype.set=function(documentRef,value,options){var ref=validateReference(documentRef,this._firestore),convertedValue=applyFirestoreDataConverter(ref.converter,value,options),parsed=parseSetData(this._dataReader,"Transaction.set",ref._key,convertedValue,null!==ref.converter,options);return this._transaction.set(ref._key,parsed),this},Transaction$2.prototype.update=function(documentRef,fieldOrUpdateData,value){for(var moreFieldsAndValues=[],_i=3;_i<arguments.length;_i++)moreFieldsAndValues[_i-3]=arguments[_i];var parsed,ref=validateReference(documentRef,this._firestore);return parsed="string"==typeof(fieldOrUpdateData=util.getModularInstance(fieldOrUpdateData))||fieldOrUpdateData instanceof FieldPath?parseUpdateVarargs(this._dataReader,"Transaction.update",ref._key,fieldOrUpdateData,value,moreFieldsAndValues):parseUpdateData(this._dataReader,"Transaction.update",ref._key,fieldOrUpdateData),this._transaction.update(ref._key,parsed),this},Transaction$2.prototype.delete=function(documentRef){var ref=validateReference(documentRef,this._firestore);return this._transaction.delete(ref._key),this},Transaction$2}();function isPartialObserver(obj){return function implementsAnyMethods(obj,methods){if("object"!=typeof obj||null===obj)return!1;for(var object=obj,_i=0,methods_1=methods;_i<methods_1.length;_i++){var method=methods_1[_i];if(method in object&&"function"==typeof object[method])return!0}return!1}(obj,["next","error","complete"])}var ExpUserDataWriter=function(_super){function ExpUserDataWriter(firestore){var _this=_super.call(this)||this;return _this.firestore=firestore,_this}return tslib.__extends(ExpUserDataWriter,_super),ExpUserDataWriter.prototype.convertBytes=function(bytes){return new Bytes(bytes)},ExpUserDataWriter.prototype.convertReference=function(name){var key=this.convertDocumentKey(name,this.firestore._databaseId);return new DocumentReference$1(this.firestore,null,key)},ExpUserDataWriter}(AbstractUserDataWriter);function getDocFromCache(reference){reference=cast(reference,DocumentReference$1);var firestore=cast(reference.firestore,FirebaseFirestore),client=ensureFirestoreConfigured(firestore),userDataWriter=new ExpUserDataWriter(firestore);return function firestoreClientGetDocumentFromLocalCache(client,docKey){var _this=this,deferred=new Deferred;return client.asyncQueue.enqueueAndForget(function(){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,getLocalStore(client)];case 1:return[2,readDocumentFromCache(_d.sent(),docKey,deferred)]}})})}),deferred.promise}(client,reference._key).then(function(doc){return new DocumentSnapshot$1(firestore,userDataWriter,reference._key,doc,new SnapshotMetadata(null!==doc&&doc.hasLocalMutations,!0),reference.converter)})}function getDocsFromCache(query){query=cast(query,Query$1);var firestore=cast(query.firestore,FirebaseFirestore),client=ensureFirestoreConfigured(firestore),userDataWriter=new ExpUserDataWriter(firestore);return function firestoreClientGetDocumentsFromLocalCache(client,query){var _this=this,deferred=new Deferred;return client.asyncQueue.enqueueAndForget(function(){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,getLocalStore(client)];case 1:return[2,executeQueryFromCache(_d.sent(),query,deferred)]}})})}),deferred.promise}(client,query._query).then(function(snapshot){return new QuerySnapshot$1(firestore,userDataWriter,query,snapshot)})}function updateDoc(reference,fieldOrUpdateData,value){for(var moreFieldsAndValues=[],_i=3;_i<arguments.length;_i++)moreFieldsAndValues[_i-3]=arguments[_i];reference=cast(reference,DocumentReference$1);var firestore=cast(reference.firestore,FirebaseFirestore),dataReader=newUserDataReader(firestore),mutation=("string"==typeof(fieldOrUpdateData=util.getModularInstance(fieldOrUpdateData))||fieldOrUpdateData instanceof FieldPath?parseUpdateVarargs(dataReader,"updateDoc",reference._key,fieldOrUpdateData,value,moreFieldsAndValues):parseUpdateData(dataReader,"updateDoc",reference._key,fieldOrUpdateData)).toMutation(reference._key,Precondition.exists(!0));return executeWrite(firestore,[mutation])}function onSnapshot(reference){for(var _a,_b,_c,args=[],_i=1;_i<arguments.length;_i++)args[_i-1]=arguments[_i];reference=util.getModularInstance(reference);var options={includeMetadataChanges:!1},currArg=0;"object"!=typeof args[currArg]||isPartialObserver(args[currArg])||(options=args[currArg],currArg++);var observer,firestore,internalQuery,internalOptions={includeMetadataChanges:options.includeMetadataChanges};if(isPartialObserver(args[currArg])){var userObserver=args[currArg];args[currArg]=null===(_a=userObserver.next)||void 0===_a?void 0:_a.bind(userObserver),args[currArg+1]=null===(_b=userObserver.error)||void 0===_b?void 0:_b.bind(userObserver),args[currArg+2]=null===(_c=userObserver.complete)||void 0===_c?void 0:_c.bind(userObserver)}if(reference instanceof DocumentReference$1)firestore=cast(reference.firestore,FirebaseFirestore),internalQuery=newQueryForPath(reference._key.path),observer={next:function(snapshot){args[currArg]&&args[currArg](convertToDocSnapshot(firestore,reference,snapshot))},error:args[currArg+1],complete:args[currArg+2]};else{var query_5=cast(reference,Query$1);firestore=cast(query_5.firestore,FirebaseFirestore),internalQuery=query_5._query;var userDataWriter_1=new ExpUserDataWriter(firestore);observer={next:function(snapshot){args[currArg]&&args[currArg](new QuerySnapshot$1(firestore,userDataWriter_1,query_5,snapshot))},error:args[currArg+1],complete:args[currArg+2]},validateHasExplicitOrderByForLimitToLast(reference._query)}var client=ensureFirestoreConfigured(firestore);return firestoreClientListen(client,internalQuery,internalOptions,observer)}function onSnapshotsInSync(firestore,arg){return function firestoreClientAddSnapshotsInSyncListener(client,observer){var _this=this,wrappedObserver=new AsyncObserver(observer);return client.asyncQueue.enqueueAndForget(function(){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,getEventManager(client)];case 1:return[2,addSnapshotsInSyncListener(_d.sent(),wrappedObserver)]}})})}),function(){wrappedObserver.mute(),client.asyncQueue.enqueueAndForget(function(){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,getEventManager(client)];case 1:return[2,removeSnapshotsInSyncListener(_d.sent(),wrappedObserver)]}})})})}}(ensureFirestoreConfigured(firestore=cast(firestore,FirebaseFirestore)),isPartialObserver(arg)?arg:{next:arg})}function executeWrite(firestore,mutations){return function firestoreClientWrite(client,mutations){var _this=this,deferred=new Deferred;return client.asyncQueue.enqueueAndForget(function(){return tslib.__awaiter(_this,void 0,void 0,function(){return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,getSyncEngine(client)];case 1:return[2,syncEngineWrite(_d.sent(),mutations,deferred)]}})})}),deferred.promise}(ensureFirestoreConfigured(firestore),mutations)}function convertToDocSnapshot(firestore,ref,snapshot){var doc=snapshot.docs.get(ref._key),userDataWriter=new ExpUserDataWriter(firestore);return new DocumentSnapshot$1(firestore,userDataWriter,ref._key,doc,new SnapshotMetadata(snapshot.hasPendingWrites,snapshot.fromCache),ref.converter)}var Transaction$1=function(_super){function Transaction$1(_firestore,_transaction){var _this=_super.call(this,_firestore,_transaction)||this;return _this._firestore=_firestore,_this}return tslib.__extends(Transaction$1,_super),Transaction$1.prototype.get=function(documentRef){var _this=this,ref=validateReference(documentRef,this._firestore),userDataWriter=new ExpUserDataWriter(this._firestore);return _super.prototype.get.call(this,documentRef).then(function(liteDocumentSnapshot){return new DocumentSnapshot$1(_this._firestore,userDataWriter,ref._key,liteDocumentSnapshot._document,new SnapshotMetadata(!1,!1),ref.converter)})},Transaction$1}(Transaction$2);function runTransaction(firestore,updateFunction){return function firestoreClientTransaction(client,updateFunction){var _this=this,deferred=new Deferred;return client.asyncQueue.enqueueAndForget(function(){return tslib.__awaiter(_this,void 0,void 0,function(){var datastore;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return[4,getDatastore(client)];case 1:return datastore=_d.sent(),new TransactionRunner(client.asyncQueue,datastore,updateFunction,deferred).run(),[2]}})})}),deferred.promise}(ensureFirestoreConfigured(firestore),function(internalTransaction){return updateFunction(new Transaction$1(firestore,internalTransaction))})}function assertUint8ArrayAvailable(){if("undefined"==typeof Uint8Array)throw new FirestoreError(Code_UNIMPLEMENTED,"Uint8Arrays are not available in this environment.")}var Blob=function(){function Blob(_delegate){this._delegate=_delegate}return Blob.fromBase64String=function(base64){return new Blob(Bytes.fromBase64String(base64))},Blob.fromUint8Array=function(array){return assertUint8ArrayAvailable(),new Blob(Bytes.fromUint8Array(array))},Blob.prototype.toBase64=function(){return this._delegate.toBase64()},Blob.prototype.toUint8Array=function(){return assertUint8ArrayAvailable(),this._delegate.toUint8Array()},Blob.prototype.isEqual=function(other){return this._delegate.isEqual(other._delegate)},Blob.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"},Blob}(),IndexedDbPersistenceProvider=function(){function IndexedDbPersistenceProvider(){}return IndexedDbPersistenceProvider.prototype.enableIndexedDbPersistence=function(firestore,forceOwnership){return function enableIndexedDbPersistence(firestore,persistenceSettings){verifyNotInitialized(firestore=cast(firestore,FirebaseFirestore));var client=ensureFirestoreConfigured(firestore),settings=firestore._freezeSettings(),onlineComponentProvider=new OnlineComponentProvider;return setPersistenceProviders(client,onlineComponentProvider,new IndexedDbOfflineComponentProvider(onlineComponentProvider,settings.cacheSizeBytes,null==persistenceSettings?void 0:persistenceSettings.forceOwnership))}(firestore._delegate,{forceOwnership:forceOwnership})},IndexedDbPersistenceProvider.prototype.enableMultiTabIndexedDbPersistence=function(firestore){return function enableMultiTabIndexedDbPersistence(firestore){verifyNotInitialized(firestore=cast(firestore,FirebaseFirestore));var client=ensureFirestoreConfigured(firestore),settings=firestore._freezeSettings(),onlineComponentProvider=new OnlineComponentProvider;return setPersistenceProviders(client,onlineComponentProvider,new MultiTabOfflineComponentProvider(onlineComponentProvider,settings.cacheSizeBytes))}(firestore._delegate)},IndexedDbPersistenceProvider.prototype.clearIndexedDbPersistence=function(firestore){return function clearIndexedDbPersistence(firestore){var _this=this;if(firestore._initialized&&!firestore._terminated)throw new FirestoreError(Code_FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");var deferred=new Deferred;return firestore._queue.enqueueAndForgetEvenWhileRestricted(function(){return tslib.__awaiter(_this,void 0,void 0,function(){var e_16;return tslib.__generator(this,function(_d){switch(_d.label){case 0:return _d.trys.push([0,2,,3]),[4,indexedDbClearPersistence(indexedDbStoragePrefix(firestore._databaseId,firestore._persistenceKey))];case 1:return _d.sent(),deferred.resolve(),[3,3];case 2:return e_16=_d.sent(),deferred.reject(e_16),[3,3];case 3:return[2]}})})}),deferred.promise}(firestore._delegate)},IndexedDbPersistenceProvider}(),Firestore=function(){function Firestore(databaseIdOrApp,_delegate,_persistenceProvider){var _this=this;this._delegate=_delegate,this._persistenceProvider=_persistenceProvider,this.INTERNAL={delete:function(){return _this.terminate()}},databaseIdOrApp instanceof DatabaseId||(this._appCompat=databaseIdOrApp)}return Object.defineProperty(Firestore.prototype,"_databaseId",{get:function(){return this._delegate._databaseId},enumerable:!1,configurable:!0}),Firestore.prototype.settings=function(settingsLiteral){var currentSettings=this._delegate._getSettings();settingsLiteral.merge||currentSettings.host===settingsLiteral.host||logWarn("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),settingsLiteral.merge&&delete(settingsLiteral=Object.assign(Object.assign({},currentSettings),settingsLiteral)).merge,this._delegate._setSettings(settingsLiteral)},Firestore.prototype.useEmulator=function(host,port,options){void 0===options&&(options={}),function useFirestoreEmulator(firestore,host,port,options){void 0===options&&(options={});var settings=(firestore=cast(firestore,FirebaseFirestore$1))._getSettings();if("firestore.googleapis.com"!==settings.host&&settings.host!==host&&logWarn("Host has been set in both settings() and useEmulator(), emulator host will be used"),firestore._setSettings(Object.assign(Object.assign({},settings),{host:host+":"+port,ssl:!1})),options.mockUserToken){var token=util.createMockUserToken(options.mockUserToken),uid=options.mockUserToken.sub||options.mockUserToken.user_id;if(!uid)throw new FirestoreError(Code_INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");firestore._credentials=new EmulatorCredentialsProvider(new OAuthToken(token,new User(uid)))}}(this._delegate,host,port,options)},Firestore.prototype.enableNetwork=function(){return enableNetwork(this._delegate)},Firestore.prototype.disableNetwork=function(){return disableNetwork(this._delegate)},Firestore.prototype.enablePersistence=function(settings){var synchronizeTabs=!1,experimentalForceOwningTab=!1;return settings&&validateIsNotUsedTogether("synchronizeTabs",synchronizeTabs=!!settings.synchronizeTabs,"experimentalForceOwningTab",experimentalForceOwningTab=!!settings.experimentalForceOwningTab),synchronizeTabs?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,experimentalForceOwningTab)},Firestore.prototype.clearPersistence=function(){return this._persistenceProvider.clearIndexedDbPersistence(this)},Firestore.prototype.terminate=function(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore"),this._appCompat._removeServiceInstance("firestore-exp")),this._delegate._delete()},Firestore.prototype.waitForPendingWrites=function(){return waitForPendingWrites(this._delegate)},Firestore.prototype.onSnapshotsInSync=function(arg){return onSnapshotsInSync(this._delegate,arg)},Object.defineProperty(Firestore.prototype,"app",{get:function(){if(!this._appCompat)throw new FirestoreError(Code_FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat},enumerable:!1,configurable:!0}),Firestore.prototype.collection=function(pathString){try{return new CollectionReference(this,collection(this._delegate,pathString))}catch(e){throw replaceFunctionName(e,"collection()","Firestore.collection()")}},Firestore.prototype.doc=function(pathString){try{return new DocumentReference(this,doc(this._delegate,pathString))}catch(e){throw replaceFunctionName(e,"doc()","Firestore.doc()")}},Firestore.prototype.collectionGroup=function(collectionId){try{return new Query(this,collectionGroup(this._delegate,collectionId))}catch(e){throw replaceFunctionName(e,"collectionGroup()","Firestore.collectionGroup()")}},Firestore.prototype.runTransaction=function(updateFunction){var _this=this;return runTransaction(this._delegate,function(transaction){return updateFunction(new Transaction(_this,transaction))})},Firestore.prototype.batch=function(){var _this=this;return ensureFirestoreConfigured(this._delegate),new WriteBatch(new WriteBatch$1(this._delegate,function(mutations){return executeWrite(_this._delegate,mutations)}))},Firestore.prototype.loadBundle=function(bundleData){throw new FirestoreError(Code_FAILED_PRECONDITION,'"loadBundle()" does not exist, have you imported "firebase/firestore/bundle"?')},Firestore.prototype.namedQuery=function(name){throw new FirestoreError(Code_FAILED_PRECONDITION,'"namedQuery()" does not exist, have you imported "firebase/firestore/bundle"?')},Firestore}(),UserDataWriter=function(_super){function UserDataWriter(firestore){var _this=_super.call(this)||this;return _this.firestore=firestore,_this}return tslib.__extends(UserDataWriter,_super),UserDataWriter.prototype.convertBytes=function(bytes){return new Blob(new Bytes(bytes))},UserDataWriter.prototype.convertReference=function(name){var key=this.convertDocumentKey(name,this.firestore._databaseId);return DocumentReference.forKey(key,this.firestore,null)},UserDataWriter}(AbstractUserDataWriter);var Transaction=function(){function Transaction(_firestore,_delegate){this._firestore=_firestore,this._delegate=_delegate,this._userDataWriter=new UserDataWriter(_firestore)}return Transaction.prototype.get=function(documentRef){var _this=this,ref=castReference(documentRef);return this._delegate.get(ref).then(function(result){return new DocumentSnapshot(_this._firestore,new DocumentSnapshot$1(_this._firestore._delegate,_this._userDataWriter,result._key,result._document,result.metadata,ref.converter))})},Transaction.prototype.set=function(documentRef,data,options){var ref=castReference(documentRef);return options?(validateSetOptions("Transaction.set",options),this._delegate.set(ref,data,options)):this._delegate.set(ref,data),this},Transaction.prototype.update=function(documentRef,dataOrField,value){for(var _d,moreFieldsAndValues=[],_i=3;_i<arguments.length;_i++)moreFieldsAndValues[_i-3]=arguments[_i];var ref=castReference(documentRef);return 2===arguments.length?this._delegate.update(ref,dataOrField):(_d=this._delegate).update.apply(_d,tslib.__spreadArray([ref,dataOrField,value],moreFieldsAndValues)),this},Transaction.prototype.delete=function(documentRef){var ref=castReference(documentRef);return this._delegate.delete(ref),this},Transaction}(),WriteBatch=function(){function WriteBatch(_delegate){this._delegate=_delegate}return WriteBatch.prototype.set=function(documentRef,data,options){var ref=castReference(documentRef);return options?(validateSetOptions("WriteBatch.set",options),this._delegate.set(ref,data,options)):this._delegate.set(ref,data),this},WriteBatch.prototype.update=function(documentRef,dataOrField,value){for(var _d,moreFieldsAndValues=[],_i=3;_i<arguments.length;_i++)moreFieldsAndValues[_i-3]=arguments[_i];var ref=castReference(documentRef);return 2===arguments.length?this._delegate.update(ref,dataOrField):(_d=this._delegate).update.apply(_d,tslib.__spreadArray([ref,dataOrField,value],moreFieldsAndValues)),this},WriteBatch.prototype.delete=function(documentRef){var ref=castReference(documentRef);return this._delegate.delete(ref),this},WriteBatch.prototype.commit=function(){return this._delegate.commit()},WriteBatch}(),FirestoreDataConverter=function(){function FirestoreDataConverter(_firestore,_userDataWriter,_delegate){this._firestore=_firestore,this._userDataWriter=_userDataWriter,this._delegate=_delegate}return FirestoreDataConverter.prototype.fromFirestore=function(snapshot,options){var expSnapshot=new QueryDocumentSnapshot$1(this._firestore._delegate,this._userDataWriter,snapshot._key,snapshot._document,snapshot.metadata,null);return this._delegate.fromFirestore(new QueryDocumentSnapshot(this._firestore,expSnapshot),null!=options?options:{})},FirestoreDataConverter.prototype.toFirestore=function(modelObject,options){return options?this._delegate.toFirestore(modelObject,options):this._delegate.toFirestore(modelObject)},FirestoreDataConverter.getInstance=function(firestore,converter){var converterMapByFirestore=FirestoreDataConverter.INSTANCES,untypedConverterByConverter=converterMapByFirestore.get(firestore);untypedConverterByConverter||(untypedConverterByConverter=new WeakMap,converterMapByFirestore.set(firestore,untypedConverterByConverter));var instance=untypedConverterByConverter.get(converter);return instance||(instance=new FirestoreDataConverter(firestore,new UserDataWriter(firestore),converter),untypedConverterByConverter.set(converter,instance)),instance},FirestoreDataConverter}();FirestoreDataConverter.INSTANCES=new WeakMap;var DocumentReference=function(){function DocumentReference(firestore,_delegate){this.firestore=firestore,this._delegate=_delegate,this._userDataWriter=new UserDataWriter(firestore)}return DocumentReference.forPath=function(path,firestore,converter){if(path.length%2!=0)throw new FirestoreError(Code_INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+path.canonicalString()+" has "+path.length);return new DocumentReference(firestore,new DocumentReference$1(firestore._delegate,converter,new DocumentKey(path)))},DocumentReference.forKey=function(key,firestore,converter){return new DocumentReference(firestore,new DocumentReference$1(firestore._delegate,converter,key))},Object.defineProperty(DocumentReference.prototype,"id",{get:function(){return this._delegate.id},enumerable:!1,configurable:!0}),Object.defineProperty(DocumentReference.prototype,"parent",{get:function(){return new CollectionReference(this.firestore,this._delegate.parent)},enumerable:!1,configurable:!0}),Object.defineProperty(DocumentReference.prototype,"path",{get:function(){return this._delegate.path},enumerable:!1,configurable:!0}),DocumentReference.prototype.collection=function(pathString){try{return new CollectionReference(this.firestore,collection(this._delegate,pathString))}catch(e){throw replaceFunctionName(e,"collection()","DocumentReference.collection()")}},DocumentReference.prototype.isEqual=function(other){return(other=util.getModularInstance(other))instanceof DocumentReference$1&&refEqual(this._delegate,other)},DocumentReference.prototype.set=function(value,options){options=validateSetOptions("DocumentReference.set",options);try{return function setDoc(reference,data,options){reference=cast(reference,DocumentReference$1);var firestore=cast(reference.firestore,FirebaseFirestore),convertedValue=applyFirestoreDataConverter(reference.converter,data,options);return executeWrite(firestore,[parseSetData(newUserDataReader(firestore),"setDoc",reference._key,convertedValue,null!==reference.converter,options).toMutation(reference._key,Precondition.none())])}(this._delegate,value,options)}catch(e){throw replaceFunctionName(e,"setDoc()","DocumentReference.set()")}},DocumentReference.prototype.update=function(fieldOrUpdateData,value){for(var moreFieldsAndValues=[],_i=2;_i<arguments.length;_i++)moreFieldsAndValues[_i-2]=arguments[_i];try{return 1===arguments.length?updateDoc(this._delegate,fieldOrUpdateData):updateDoc.apply(void 0,tslib.__spreadArray([this._delegate,fieldOrUpdateData,value],moreFieldsAndValues))}catch(e){throw replaceFunctionName(e,"updateDoc()","DocumentReference.update()")}},DocumentReference.prototype.delete=function(){return function deleteDoc(reference){return executeWrite(cast(reference.firestore,FirebaseFirestore),[new DeleteMutation(reference._key,Precondition.none())])}(this._delegate)},DocumentReference.prototype.onSnapshot=function(){for(var _this=this,args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];var options=extractSnapshotOptions(args),observer=wrapObserver(args,function(result){return new DocumentSnapshot(_this.firestore,new DocumentSnapshot$1(_this.firestore._delegate,_this._userDataWriter,result._key,result._document,result.metadata,_this._delegate.converter))});return onSnapshot(this._delegate,options,observer)},DocumentReference.prototype.get=function(options){var _this=this;return("cache"===(null==options?void 0:options.source)?getDocFromCache(this._delegate):"server"===(null==options?void 0:options.source)?function getDocFromServer(reference){reference=cast(reference,DocumentReference$1);var firestore=cast(reference.firestore,FirebaseFirestore);return firestoreClientGetDocumentViaSnapshotListener(ensureFirestoreConfigured(firestore),reference._key,{source:"server"}).then(function(snapshot){return convertToDocSnapshot(firestore,reference,snapshot)})}(this._delegate):function getDoc(reference){reference=cast(reference,DocumentReference$1);var firestore=cast(reference.firestore,FirebaseFirestore);return firestoreClientGetDocumentViaSnapshotListener(ensureFirestoreConfigured(firestore),reference._key).then(function(snapshot){return convertToDocSnapshot(firestore,reference,snapshot)})}(this._delegate)).then(function(result){return new DocumentSnapshot(_this.firestore,new DocumentSnapshot$1(_this.firestore._delegate,_this._userDataWriter,result._key,result._document,result.metadata,_this._delegate.converter))})},DocumentReference.prototype.withConverter=function(converter){return new DocumentReference(this.firestore,converter?this._delegate.withConverter(FirestoreDataConverter.getInstance(this.firestore,converter)):this._delegate.withConverter(null))},DocumentReference}();function replaceFunctionName(e,original,updated){return e.message=e.message.replace(original,updated),e}function extractSnapshotOptions(args){for(var _i=0,args_1=args;_i<args_1.length;_i++){var arg=args_1[_i];if("object"==typeof arg&&!isPartialObserver(arg))return arg}return{}}function wrapObserver(args,wrapper){var _a,_b,userObserver;return{next:function(val){userObserver.next&&userObserver.next(wrapper(val))},error:null===(_a=(userObserver=isPartialObserver(args[0])?args[0]:isPartialObserver(args[1])?args[1]:"function"==typeof args[0]?{next:args[0],error:args[1],complete:args[2]}:{next:args[1],error:args[2],complete:args[3]}).error)||void 0===_a?void 0:_a.bind(userObserver),complete:null===(_b=userObserver.complete)||void 0===_b?void 0:_b.bind(userObserver)}}var DocumentSnapshot=function(){function DocumentSnapshot(_firestore,_delegate){this._firestore=_firestore,this._delegate=_delegate}return Object.defineProperty(DocumentSnapshot.prototype,"ref",{get:function(){return new DocumentReference(this._firestore,this._delegate.ref)},enumerable:!1,configurable:!0}),Object.defineProperty(DocumentSnapshot.prototype,"id",{get:function(){return this._delegate.id},enumerable:!1,configurable:!0}),Object.defineProperty(DocumentSnapshot.prototype,"metadata",{get:function(){return this._delegate.metadata},enumerable:!1,configurable:!0}),Object.defineProperty(DocumentSnapshot.prototype,"exists",{get:function(){return this._delegate.exists()},enumerable:!1,configurable:!0}),DocumentSnapshot.prototype.data=function(options){return this._delegate.data(options)},DocumentSnapshot.prototype.get=function(fieldPath,options){return this._delegate.get(fieldPath,options)},DocumentSnapshot.prototype.isEqual=function(other){return snapshotEqual(this._delegate,other._delegate)},DocumentSnapshot}(),QueryDocumentSnapshot=function(_super){function QueryDocumentSnapshot(){return null!==_super&&_super.apply(this,arguments)||this}return tslib.__extends(QueryDocumentSnapshot,_super),QueryDocumentSnapshot.prototype.data=function(options){return this._delegate.data(options)},QueryDocumentSnapshot}(DocumentSnapshot),Query=function(){function Query(firestore,_delegate){this.firestore=firestore,this._delegate=_delegate,this._userDataWriter=new UserDataWriter(firestore)}return Query.prototype.where=function(fieldPath,opStr,value){try{return new Query(this.firestore,query(this._delegate,function where(fieldPath,opStr,value){var op=opStr,field=fieldPathFromArgument("where",fieldPath);return new QueryFilterConstraint(field,op,value)}(fieldPath,opStr,value)))}catch(e){throw replaceFunctionName(e,/(orderBy|where)\(\)/,"Query.$1()")}},Query.prototype.orderBy=function(fieldPath,directionStr){try{return new Query(this.firestore,query(this._delegate,function orderBy(fieldPath,directionStr){void 0===directionStr&&(directionStr="asc");var direction=directionStr,path=fieldPathFromArgument("orderBy",fieldPath);return new QueryOrderByConstraint(path,direction)}(fieldPath,directionStr)))}catch(e){throw replaceFunctionName(e,/(orderBy|where)\(\)/,"Query.$1()")}},Query.prototype.limit=function(n){try{return new Query(this.firestore,query(this._delegate,function limit(limit){return validatePositiveNumber("limit",limit),new QueryLimitConstraint("limit",limit,"F")}(n)))}catch(e){throw replaceFunctionName(e,"limit()","Query.limit()")}},Query.prototype.limitToLast=function(n){try{return new Query(this.firestore,query(this._delegate,function limitToLast(limit){return validatePositiveNumber("limitToLast",limit),new QueryLimitConstraint("limitToLast",limit,"L")}(n)))}catch(e){throw replaceFunctionName(e,"limitToLast()","Query.limitToLast()")}},Query.prototype.startAt=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];try{return new Query(this.firestore,query(this._delegate,startAt.apply(void 0,args)))}catch(e){throw replaceFunctionName(e,"startAt()","Query.startAt()")}},Query.prototype.startAfter=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];try{return new Query(this.firestore,query(this._delegate,startAfter.apply(void 0,args)))}catch(e){throw replaceFunctionName(e,"startAfter()","Query.startAfter()")}},Query.prototype.endBefore=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];try{return new Query(this.firestore,query(this._delegate,endBefore.apply(void 0,args)))}catch(e){throw replaceFunctionName(e,"endBefore()","Query.endBefore()")}},Query.prototype.endAt=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];try{return new Query(this.firestore,query(this._delegate,endAt.apply(void 0,args)))}catch(e){throw replaceFunctionName(e,"endAt()","Query.endAt()")}},Query.prototype.isEqual=function(other){return queryEqual(this._delegate,other._delegate)},Query.prototype.get=function(options){var _this=this;return("cache"===(null==options?void 0:options.source)?getDocsFromCache(this._delegate):"server"===(null==options?void 0:options.source)?function getDocsFromServer(query){query=cast(query,Query$1);var firestore=cast(query.firestore,FirebaseFirestore),client=ensureFirestoreConfigured(firestore),userDataWriter=new ExpUserDataWriter(firestore);return firestoreClientGetDocumentsViaSnapshotListener(client,query._query,{source:"server"}).then(function(snapshot){return new QuerySnapshot$1(firestore,userDataWriter,query,snapshot)})}(this._delegate):function getDocs(query){query=cast(query,Query$1);var firestore=cast(query.firestore,FirebaseFirestore),client=ensureFirestoreConfigured(firestore),userDataWriter=new ExpUserDataWriter(firestore);return validateHasExplicitOrderByForLimitToLast(query._query),firestoreClientGetDocumentsViaSnapshotListener(client,query._query).then(function(snapshot){return new QuerySnapshot$1(firestore,userDataWriter,query,snapshot)})}(this._delegate)).then(function(result){return new QuerySnapshot(_this.firestore,new QuerySnapshot$1(_this.firestore._delegate,_this._userDataWriter,_this._delegate,result._snapshot))})},Query.prototype.onSnapshot=function(){for(var _this=this,args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];var options=extractSnapshotOptions(args),observer=wrapObserver(args,function(snap){return new QuerySnapshot(_this.firestore,new QuerySnapshot$1(_this.firestore._delegate,_this._userDataWriter,_this._delegate,snap._snapshot))});return onSnapshot(this._delegate,options,observer)},Query.prototype.withConverter=function(converter){return new Query(this.firestore,converter?this._delegate.withConverter(FirestoreDataConverter.getInstance(this.firestore,converter)):this._delegate.withConverter(null))},Query}(),DocumentChange=function(){function DocumentChange(_firestore,_delegate){this._firestore=_firestore,this._delegate=_delegate}return Object.defineProperty(DocumentChange.prototype,"type",{get:function(){return this._delegate.type},enumerable:!1,configurable:!0}),Object.defineProperty(DocumentChange.prototype,"doc",{get:function(){return new QueryDocumentSnapshot(this._firestore,this._delegate.doc)},enumerable:!1,configurable:!0}),Object.defineProperty(DocumentChange.prototype,"oldIndex",{get:function(){return this._delegate.oldIndex},enumerable:!1,configurable:!0}),Object.defineProperty(DocumentChange.prototype,"newIndex",{get:function(){return this._delegate.newIndex},enumerable:!1,configurable:!0}),DocumentChange}(),QuerySnapshot=function(){function QuerySnapshot(_firestore,_delegate){this._firestore=_firestore,this._delegate=_delegate}return Object.defineProperty(QuerySnapshot.prototype,"query",{get:function(){return new Query(this._firestore,this._delegate.query)},enumerable:!1,configurable:!0}),Object.defineProperty(QuerySnapshot.prototype,"metadata",{get:function(){return this._delegate.metadata},enumerable:!1,configurable:!0}),Object.defineProperty(QuerySnapshot.prototype,"size",{get:function(){return this._delegate.size},enumerable:!1,configurable:!0}),Object.defineProperty(QuerySnapshot.prototype,"empty",{get:function(){return this._delegate.empty},enumerable:!1,configurable:!0}),Object.defineProperty(QuerySnapshot.prototype,"docs",{get:function(){var _this=this;return this._delegate.docs.map(function(doc){return new QueryDocumentSnapshot(_this._firestore,doc)})},enumerable:!1,configurable:!0}),QuerySnapshot.prototype.docChanges=function(options){var _this=this;return this._delegate.docChanges(options).map(function(docChange){return new DocumentChange(_this._firestore,docChange)})},QuerySnapshot.prototype.forEach=function(callback,thisArg){var _this=this;this._delegate.forEach(function(snapshot){callback.call(thisArg,new QueryDocumentSnapshot(_this._firestore,snapshot))})},QuerySnapshot.prototype.isEqual=function(other){return snapshotEqual(this._delegate,other._delegate)},QuerySnapshot}(),CollectionReference=function(_super){function CollectionReference(firestore,_delegate){var _this=_super.call(this,firestore,_delegate)||this;return _this.firestore=firestore,_this._delegate=_delegate,_this}return tslib.__extends(CollectionReference,_super),Object.defineProperty(CollectionReference.prototype,"id",{get:function(){return this._delegate.id},enumerable:!1,configurable:!0}),Object.defineProperty(CollectionReference.prototype,"path",{get:function(){return this._delegate.path},enumerable:!1,configurable:!0}),Object.defineProperty(CollectionReference.prototype,"parent",{get:function(){var docRef=this._delegate.parent;return docRef?new DocumentReference(this.firestore,docRef):null},enumerable:!1,configurable:!0}),CollectionReference.prototype.doc=function(documentPath){try{return new DocumentReference(this.firestore,void 0===documentPath?doc(this._delegate):doc(this._delegate,documentPath))}catch(e){throw replaceFunctionName(e,"doc()","CollectionReference.doc()")}},CollectionReference.prototype.add=function(data){var _this=this;return function addDoc(reference,data){var firestore=cast(reference.firestore,FirebaseFirestore),docRef=doc(reference),convertedValue=applyFirestoreDataConverter(reference.converter,data);return executeWrite(firestore,[parseSetData(newUserDataReader(reference.firestore),"addDoc",docRef._key,convertedValue,null!==reference.converter,{}).toMutation(docRef._key,Precondition.exists(!1))]).then(function(){return docRef})}(this._delegate,data).then(function(docRef){return new DocumentReference(_this.firestore,docRef)})},CollectionReference.prototype.isEqual=function(other){return refEqual(this._delegate,other._delegate)},CollectionReference.prototype.withConverter=function(converter){return new CollectionReference(this.firestore,converter?this._delegate.withConverter(FirestoreDataConverter.getInstance(this.firestore,converter)):this._delegate.withConverter(null))},CollectionReference}(Query);function castReference(documentRef){return cast(documentRef,DocumentReference$1)}exports.ArrayRemoveFieldValueImpl=ArrayRemoveFieldValueImpl,exports.ArrayUnionFieldValueImpl=ArrayUnionFieldValueImpl,exports.Blob=Blob,exports.CACHE_SIZE_UNLIMITED=-1,exports.CollectionReference=CollectionReference,exports.DeleteFieldValueImpl=DeleteFieldValueImpl,exports.DocumentReference=DocumentReference,exports.DocumentSnapshot=DocumentSnapshot,exports.FieldPath=FieldPath,exports.FieldPath$1=FieldPath$1,exports.FirebaseFirestore=FirebaseFirestore,exports.Firestore=Firestore,exports.GeoPoint=GeoPoint,exports.IndexedDbPersistenceProvider=IndexedDbPersistenceProvider,exports.NumericIncrementFieldValueImpl=NumericIncrementFieldValueImpl,exports.Query=Query,exports.QueryDocumentSnapshot=QueryDocumentSnapshot,exports.QuerySnapshot=QuerySnapshot,exports.ServerTimestampFieldValueImpl=ServerTimestampFieldValueImpl,exports.Timestamp=Timestamp,exports.Transaction=Transaction,exports.WriteBatch=WriteBatch,exports.loadBundle=function loadBundle(firestore,bundleData){var client=ensureFirestoreConfigured(firestore=cast(firestore,FirebaseFirestore)),resultTask=new LoadBundleTask;return firestoreClientLoadBundle(client,firestore._databaseId,bundleData,resultTask),resultTask},exports.namedQuery=function namedQuery(firestore,name){return function firestoreClientGetNamedQuery(client,queryName){var _this=this;return client.asyncQueue.enqueue(function(){return tslib.__awaiter(_this,void 0,void 0,function(){var _d;return tslib.__generator(this,function(_e){switch(_e.label){case 0:return _d=localStoreGetNamedQuery,[4,getLocalStore(client)];case 1:return[2,_d.apply(void 0,[_e.sent(),queryName])]}})})})}(ensureFirestoreConfigured(firestore=cast(firestore,FirebaseFirestore)),name).then(function(namedQuery){return namedQuery?new Query$1(firestore,null,namedQuery.query):null})},exports.setLogLevel=function setLogLevel(level){!function setLogLevel$1(logLevel){logClient.setLogLevel(logLevel)}(level)}},uKrT:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ServerCredentials=void 0;const tls_helpers_1=__webpack_require__("CelR");class ServerCredentials{static createInsecure(){return new InsecureServerCredentials}static createSsl(rootCerts,keyCertPairs,checkClientCertificate=!1){if(null!==rootCerts&&!Buffer.isBuffer(rootCerts))throw new TypeError("rootCerts must be null or a Buffer");if(!Array.isArray(keyCertPairs))throw new TypeError("keyCertPairs must be an array");if("boolean"!=typeof checkClientCertificate)throw new TypeError("checkClientCertificate must be a boolean");const cert=[],key=[];for(let i=0;i<keyCertPairs.length;i++){const pair=keyCertPairs[i];if(null===pair||"object"!=typeof pair)throw new TypeError(`keyCertPair[${i}] must be an object`);if(!Buffer.isBuffer(pair.private_key))throw new TypeError(`keyCertPair[${i}].private_key must be a Buffer`);if(!Buffer.isBuffer(pair.cert_chain))throw new TypeError(`keyCertPair[${i}].cert_chain must be a Buffer`);cert.push(pair.cert_chain),key.push(pair.private_key)}return new SecureServerCredentials({ca:rootCerts||tls_helpers_1.getDefaultRootsData()||void 0,cert:cert,key:key,requestCert:checkClientCertificate,ciphers:tls_helpers_1.CIPHER_SUITES})}}exports.ServerCredentials=ServerCredentials;class InsecureServerCredentials extends ServerCredentials{_isSecure(){return!1}_getSettings(){return null}}class SecureServerCredentials extends ServerCredentials{constructor(options){super(),this.options=options}_isSecure(){return!0}_getSettings(){return this.options}}},uhwk:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.setup=exports.RoundRobinLoadBalancer=void 0;const load_balancer_1=__webpack_require__("JG2R"),channel_1=__webpack_require__("6XSn"),picker_1=__webpack_require__("mVN3"),subchannel_1=__webpack_require__("Ikg5"),logging=__webpack_require__("xQiD"),constants_1=__webpack_require__("8o9P");function trace(text){logging.trace(constants_1.LogVerbosity.DEBUG,"round_robin",text)}class RoundRobinLoadBalancingConfig{getLoadBalancerName(){return"round_robin"}constructor(){}toJsonObject(){return{round_robin:{}}}static createFromJson(obj){return new RoundRobinLoadBalancingConfig}}class RoundRobinPicker{constructor(subchannelList,nextIndex=0){this.subchannelList=subchannelList,this.nextIndex=nextIndex}pick(pickArgs){const pickedSubchannel=this.subchannelList[this.nextIndex];return this.nextIndex=(this.nextIndex+1)%this.subchannelList.length,{pickResultType:picker_1.PickResultType.COMPLETE,subchannel:pickedSubchannel,status:null,extraFilterFactory:null,onCallStarted:null}}peekNextSubchannel(){return this.subchannelList[this.nextIndex]}}class RoundRobinLoadBalancer{constructor(channelControlHelper){this.channelControlHelper=channelControlHelper,this.subchannels=[],this.currentState=channel_1.ConnectivityState.IDLE,this.currentReadyPicker=null,this.subchannelStateCounts={[channel_1.ConnectivityState.CONNECTING]:0,[channel_1.ConnectivityState.IDLE]:0,[channel_1.ConnectivityState.READY]:0,[channel_1.ConnectivityState.SHUTDOWN]:0,[channel_1.ConnectivityState.TRANSIENT_FAILURE]:0},this.subchannelStateListener=(subchannel,previousState,newState)=>{this.subchannelStateCounts[previousState]-=1,this.subchannelStateCounts[newState]+=1,this.calculateAndUpdateState(),newState!==channel_1.ConnectivityState.TRANSIENT_FAILURE&&newState!==channel_1.ConnectivityState.IDLE||(this.channelControlHelper.requestReresolution(),subchannel.startConnecting())}}calculateAndUpdateState(){if(this.subchannelStateCounts[channel_1.ConnectivityState.READY]>0){const readySubchannels=this.subchannels.filter(subchannel=>subchannel.getConnectivityState()===channel_1.ConnectivityState.READY);let index=0;null!==this.currentReadyPicker&&(index=readySubchannels.indexOf(this.currentReadyPicker.peekNextSubchannel()),index<0&&(index=0)),this.updateState(channel_1.ConnectivityState.READY,new RoundRobinPicker(readySubchannels,index))}else this.subchannelStateCounts[channel_1.ConnectivityState.CONNECTING]>0?this.updateState(channel_1.ConnectivityState.CONNECTING,new picker_1.QueuePicker(this)):this.subchannelStateCounts[channel_1.ConnectivityState.TRANSIENT_FAILURE]>0?this.updateState(channel_1.ConnectivityState.TRANSIENT_FAILURE,new picker_1.UnavailablePicker):this.updateState(channel_1.ConnectivityState.IDLE,new picker_1.QueuePicker(this))}updateState(newState,picker){trace(channel_1.ConnectivityState[this.currentState]+" -> "+channel_1.ConnectivityState[newState]),newState===channel_1.ConnectivityState.READY?this.currentReadyPicker=picker:this.currentReadyPicker=null,this.currentState=newState,this.channelControlHelper.updateState(newState,picker)}resetSubchannelList(){for(const subchannel of this.subchannels)subchannel.removeConnectivityStateListener(this.subchannelStateListener),subchannel.unref();this.subchannelStateCounts={[channel_1.ConnectivityState.CONNECTING]:0,[channel_1.ConnectivityState.IDLE]:0,[channel_1.ConnectivityState.READY]:0,[channel_1.ConnectivityState.SHUTDOWN]:0,[channel_1.ConnectivityState.TRANSIENT_FAILURE]:0},this.subchannels=[]}updateAddressList(addressList,lbConfig){this.resetSubchannelList(),trace("Connect to address list "+addressList.map(address=>subchannel_1.subchannelAddressToString(address))),this.subchannels=addressList.map(address=>this.channelControlHelper.createSubchannel(address,{}));for(const subchannel of this.subchannels){subchannel.ref(),subchannel.addConnectivityStateListener(this.subchannelStateListener);const subchannelState=subchannel.getConnectivityState();this.subchannelStateCounts[subchannelState]+=1,subchannelState!==channel_1.ConnectivityState.IDLE&&subchannelState!==channel_1.ConnectivityState.TRANSIENT_FAILURE||subchannel.startConnecting()}this.calculateAndUpdateState()}exitIdle(){for(const subchannel of this.subchannels)subchannel.startConnecting()}resetBackoff(){}destroy(){this.resetSubchannelList()}getTypeName(){return"round_robin"}}exports.RoundRobinLoadBalancer=RoundRobinLoadBalancer,exports.setup=function setup(){load_balancer_1.registerLoadBalancerType("round_robin",RoundRobinLoadBalancer,RoundRobinLoadBalancingConfig)}},"v+/A":function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CallCredentialsFilterFactory=exports.CallCredentialsFilter=void 0;const filter_1=__webpack_require__("nC4N"),constants_1=__webpack_require__("8o9P"),uri_parser_1=__webpack_require__("x8Ej");class CallCredentialsFilter extends filter_1.BaseFilter{constructor(channel,stream){var _a,_b;super(),this.channel=channel,this.stream=stream,this.channel=channel,this.stream=stream;const splitPath=stream.getMethod().split("/");let serviceName="";splitPath.length>=2&&(serviceName=splitPath[1]);const hostname=null!==(_b=null===(_a=uri_parser_1.splitHostPort(stream.getHost()))||void 0===_a?void 0:_a.host)&&void 0!==_b?_b:"localhost";this.serviceUrl=`https://${hostname}/${serviceName}`}async sendMetadata(metadata){const credsMetadata=this.stream.getCredentials().generateMetadata({service_url:this.serviceUrl}),resultMetadata=await metadata;try{resultMetadata.merge(await credsMetadata)}catch(error){return this.stream.cancelWithStatus(constants_1.Status.UNAUTHENTICATED,`Failed to retrieve auth metadata with error: ${error.message}`),Promise.reject("Failed to retrieve auth metadata")}return resultMetadata.get("authorization").length>1?(this.stream.cancelWithStatus(constants_1.Status.INTERNAL,'"authorization" metadata cannot have multiple values'),Promise.reject('"authorization" metadata cannot have multiple values')):resultMetadata}}exports.CallCredentialsFilter=CallCredentialsFilter;exports.CallCredentialsFilterFactory=class{constructor(channel){this.channel=channel,this.channel=channel}createFilter(callStream){return new CallCredentialsFilter(this.channel,callStream)}}},vREW:function(module,exports,__webpack_require__){"use strict";module.exports=Enum;var ReflectionObject=__webpack_require__("iuWj");((Enum.prototype=Object.create(ReflectionObject.prototype)).constructor=Enum).className="Enum";var Namespace=__webpack_require__("fgco"),util=__webpack_require__("y9PA");function Enum(name,values,options,comment,comments){if(ReflectionObject.call(this,name,options),values&&"object"!=typeof values)throw TypeError("values must be an object");if(this.valuesById={},this.values=Object.create(this.valuesById),this.comment=comment,this.comments=comments||{},this.reserved=void 0,values)for(var keys=Object.keys(values),i=0;i<keys.length;++i)"number"==typeof values[keys[i]]&&(this.valuesById[this.values[keys[i]]=values[keys[i]]]=keys[i])}Enum.fromJSON=function fromJSON(name,json){var enm=new Enum(name,json.values,json.options,json.comment,json.comments);return enm.reserved=json.reserved,enm},Enum.prototype.toJSON=function toJSON(toJSONOptions){var keepComments=!!toJSONOptions&&Boolean(toJSONOptions.keepComments);return util.toObject(["options",this.options,"values",this.values,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"comment",keepComments?this.comment:void 0,"comments",keepComments?this.comments:void 0])},Enum.prototype.add=function add(name,id,comment){if(!util.isString(name))throw TypeError("name must be a string");if(!util.isInteger(id))throw TypeError("id must be an integer");if(void 0!==this.values[name])throw Error("duplicate name '"+name+"' in "+this);if(this.isReservedId(id))throw Error("id "+id+" is reserved in "+this);if(this.isReservedName(name))throw Error("name '"+name+"' is reserved in "+this);if(void 0!==this.valuesById[id]){if(!this.options||!this.options.allow_alias)throw Error("duplicate id "+id+" in "+this);this.values[name]=id}else this.valuesById[this.values[name]=id]=name;return this.comments[name]=comment||null,this},Enum.prototype.remove=function remove(name){if(!util.isString(name))throw TypeError("name must be a string");var val=this.values[name];if(null==val)throw Error("name '"+name+"' does not exist in "+this);return delete this.valuesById[val],delete this.values[name],delete this.comments[name],this},Enum.prototype.isReservedId=function isReservedId(id){return Namespace.isReservedId(this.reserved,id)},Enum.prototype.isReservedName=function isReservedName(name){return Namespace.isReservedName(this.reserved,name)}},x8Ej:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.uriToString=exports.splitHostPort=exports.parseUri=void 0;const URI_REGEX=/^(?:([A-Za-z0-9+.-]+):)?(?:\/\/([^/]*)\/)?(.+)$/;exports.parseUri=function parseUri(uriString){const parsedUri=URI_REGEX.exec(uriString);return null===parsedUri?null:{scheme:parsedUri[1],authority:parsedUri[2],path:parsedUri[3]}};const NUMBER_REGEX=/^\d+$/;exports.splitHostPort=function splitHostPort(path){if(path.startsWith("[")){const hostEnd=path.indexOf("]");if(-1===hostEnd)return null;const host=path.substring(1,hostEnd);if(-1===host.indexOf(":"))return null;if(path.length>hostEnd+1){if(":"===path[hostEnd+1]){const portString=path.substring(hostEnd+2);return NUMBER_REGEX.test(portString)?{host:host,port:+portString}:null}return null}return{host:host}}{const splitPath=path.split(":");return 2===splitPath.length?NUMBER_REGEX.test(splitPath[1])?{host:splitPath[0],port:+splitPath[1]}:null:{host:path}}},exports.uriToString=function uriToString(uri){let result="";return void 0!==uri.scheme&&(result+=uri.scheme+":"),void 0!==uri.authority&&(result+="//"+uri.authority+"/"),result+=uri.path,result}},xN2E:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.DeadlineFilterFactory=exports.DeadlineFilter=void 0;const constants_1=__webpack_require__("8o9P"),filter_1=__webpack_require__("nC4N"),units=[["m",1],["S",1e3],["M",6e4],["H",36e5]];class DeadlineFilter extends filter_1.BaseFilter{constructor(channel,callStream){var _a,_b;super(),this.channel=channel,this.callStream=callStream,this.timer=null;const callDeadline=callStream.getDeadline();callDeadline instanceof Date?this.deadline=callDeadline.getTime():this.deadline=callDeadline;const now=(new Date).getTime();let timeout=this.deadline-now;timeout<=0?process.nextTick(()=>{callStream.cancelWithStatus(constants_1.Status.DEADLINE_EXCEEDED,"Deadline exceeded")}):this.deadline!==1/0&&(this.timer=setTimeout(()=>{callStream.cancelWithStatus(constants_1.Status.DEADLINE_EXCEEDED,"Deadline exceeded")},timeout),null===(_b=(_a=this.timer).unref)||void 0===_b||_b.call(_a))}async sendMetadata(metadata){if(this.deadline===1/0)return metadata;const finalMetadata=await metadata,timeoutString=function getDeadline(deadline){const now=(new Date).getTime(),timeoutMs=Math.max(deadline-now,0);for(const[unit,factor]of units){const amount=timeoutMs/factor;if(amount<1e8)return String(Math.ceil(amount))+unit}throw new Error("Deadline is too far in the future")}(this.deadline);return finalMetadata.set("grpc-timeout",timeoutString),finalMetadata}receiveTrailers(status){return this.timer&&clearTimeout(this.timer),status}}exports.DeadlineFilter=DeadlineFilter;exports.DeadlineFilterFactory=class{constructor(channel){this.channel=channel}createFilter(callStream){return new DeadlineFilter(this.channel,callStream)}}},xQiD:function(module,exports,__webpack_require__){"use strict";var _a,_b,_c,_d;Object.defineProperty(exports,"__esModule",{value:!0}),exports.trace=exports.log=exports.setLoggerVerbosity=exports.setLogger=exports.getLogger=void 0;const constants_1=__webpack_require__("8o9P");let _logger=console,_logVerbosity=constants_1.LogVerbosity.ERROR;switch((null!==(_b=null!==(_a=process.env.GRPC_NODE_VERBOSITY)&&void 0!==_a?_a:process.env.GRPC_VERBOSITY)&&void 0!==_b?_b:"").toUpperCase()){case"DEBUG":_logVerbosity=constants_1.LogVerbosity.DEBUG;break;case"INFO":_logVerbosity=constants_1.LogVerbosity.INFO;break;case"ERROR":_logVerbosity=constants_1.LogVerbosity.ERROR;break;case"NONE":_logVerbosity=constants_1.LogVerbosity.NONE}exports.getLogger=()=>_logger,exports.setLogger=logger=>{_logger=logger},exports.setLoggerVerbosity=verbosity=>{_logVerbosity=verbosity},exports.log=(severity,...args)=>{severity>=_logVerbosity&&"function"==typeof _logger.error&&_logger.error(...args)};const tracersString=null!==(_d=null!==(_c=process.env.GRPC_NODE_TRACE)&&void 0!==_c?_c:process.env.GRPC_TRACE)&&void 0!==_d?_d:"",enabledTracers=new Set,disabledTracers=new Set;for(const tracerName of tracersString.split(","))tracerName.startsWith("-")?disabledTracers.add(tracerName.substring(1)):enabledTracers.add(tracerName);const allEnabled=enabledTracers.has("all");exports.trace=function trace(severity,tracer,text){disabledTracers.has(tracer)||!allEnabled&&!enabledTracers.has(tracer)||exports.log(severity,(new Date).toISOString()+" | "+tracer+" | "+text)}},xTBj:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Server=void 0;const http2=__webpack_require__("MG4E"),constants_1=__webpack_require__("8o9P"),metadata_1=__webpack_require__("m7sO"),server_call_1=__webpack_require__("z8sR"),resolver_1=__webpack_require__("9rQR"),logging=__webpack_require__("xQiD"),subchannel_1=__webpack_require__("Ikg5"),uri_parser_1=__webpack_require__("x8Ej");function trace(text){logging.trace(constants_1.LogVerbosity.DEBUG,"server",text)}function noop(){}function getUnimplementedStatusResponse(methodName){return{code:constants_1.Status.UNIMPLEMENTED,details:`The server does not implement the method ${methodName}`,metadata:new metadata_1.Metadata}}exports.Server=class{constructor(options){this.http2ServerList=[],this.handlers=new Map,this.sessions=new Set,this.started=!1,this.options=null!=options?options:{}}addProtoService(){throw new Error("Not implemented. Use addService() instead")}addService(service,implementation){if(null===service||"object"!=typeof service||null===implementation||"object"!=typeof implementation)throw new Error("addService() requires two objects as arguments");const serviceKeys=Object.keys(service);if(0===serviceKeys.length)throw new Error("Cannot add an empty service to a server");serviceKeys.forEach(name=>{const attrs=service[name];let methodType;methodType=attrs.requestStream?attrs.responseStream?"bidi":"clientStream":attrs.responseStream?"serverStream":"unary";let impl,implFn=implementation[name];void 0===implFn&&"string"==typeof attrs.originalName&&(implFn=implementation[attrs.originalName]),impl=void 0!==implFn?implFn.bind(implementation):function getDefaultHandler(handlerType,methodName){const unimplementedStatusResponse=getUnimplementedStatusResponse(methodName);switch(handlerType){case"unary":case"clientStream":return(call,callback)=>{callback(unimplementedStatusResponse,null)};case"serverStream":case"bidi":return call=>{call.emit("error",unimplementedStatusResponse)};default:throw new Error(`Invalid handlerType ${handlerType}`)}}(methodType,name);if(!1===this.register(attrs.path,impl,attrs.responseSerialize,attrs.requestDeserialize,methodType))throw new Error(`Method handler for ${attrs.path} already provided.`)})}removeService(service){if(null===service||"object"!=typeof service)throw new Error("removeService() requires object as argument");Object.keys(service).forEach(name=>{const attrs=service[name];this.unregister(attrs.path)})}bind(port,creds){throw new Error("Not implemented. Use bindAsync() instead")}bindAsync(port,creds,callback){if(!0===this.started)throw new Error("server is already started");if("string"!=typeof port)throw new TypeError("port must be a string");if(null===creds||"object"!=typeof creds)throw new TypeError("creds must be an object");if("function"!=typeof callback)throw new TypeError("callback must be a function");const initialPortUri=uri_parser_1.parseUri(port);if(null===initialPortUri)throw new Error(`Could not parse port "${port}"`);const portUri=resolver_1.mapUriDefaultScheme(initialPortUri);if(null===portUri)throw new Error(`Could not get a default scheme for port "${port}"`);const serverOptions={maxSendHeaderBlockLength:Number.MAX_SAFE_INTEGER};"grpc-node.max_session_memory"in this.options&&(serverOptions.maxSessionMemory=this.options["grpc-node.max_session_memory"]),"grpc.max_concurrent_streams"in this.options&&(serverOptions.settings={maxConcurrentStreams:this.options["grpc.max_concurrent_streams"]});const setupServer=()=>{let http2Server;if(creds._isSecure()){const secureServerOptions=Object.assign(serverOptions,creds._getSettings());http2Server=http2.createSecureServer(secureServerOptions)}else http2Server=http2.createServer(serverOptions);return http2Server.setTimeout(0,noop),this._setupHandlers(http2Server),http2Server},bindSpecificPort=(addressList,portNum,previousCount)=>0===addressList.length?Promise.resolve({port:portNum,count:previousCount}):Promise.all(addressList.map(address=>{let addr;trace("Attempting to bind "+subchannel_1.subchannelAddressToString(address)),addr=subchannel_1.isTcpSubchannelAddress(address)?{host:address.host,port:portNum}:address;const http2Server=setupServer();return new Promise((resolve,reject)=>{function onError(err){resolve(err)}http2Server.once("error",onError),http2Server.listen(addr,()=>{trace("Successfully bound "+subchannel_1.subchannelAddressToString(address)),this.http2ServerList.push(http2Server);const boundAddress=http2Server.address();resolve("string"==typeof boundAddress?portNum:boundAddress.port),http2Server.removeListener("error",onError)})})})).then(results=>{let count=0;for(const result of results)if("number"==typeof result&&(count+=1,result!==portNum))throw new Error("Invalid state: multiple port numbers added from single address");return{port:portNum,count:count+previousCount}}),bindWildcardPort=addressList=>{if(0===addressList.length)return Promise.resolve({port:0,count:0});const address=addressList[0],http2Server=setupServer();return new Promise((resolve,reject)=>{function onError(err){resolve(bindWildcardPort(addressList.slice(1)))}http2Server.once("error",onError),http2Server.listen(address,()=>{this.http2ServerList.push(http2Server),resolve(bindSpecificPort(addressList.slice(1),http2Server.address().port,1)),http2Server.removeListener("error",onError)})})},resolverListener={onSuccessfulResolution:(addressList,serviceConfig,serviceConfigError)=>{if(resolverListener.onSuccessfulResolution=()=>{},0===addressList.length)return void callback(new Error(`No addresses resolved for port ${port}`),0);let bindResultPromise;bindResultPromise=subchannel_1.isTcpSubchannelAddress(addressList[0])?0===addressList[0].port?bindWildcardPort(addressList):bindSpecificPort(addressList,addressList[0].port,0):bindSpecificPort(addressList,1,0),bindResultPromise.then(bindResult=>{if(0===bindResult.count){const errorString=`No address added out of total ${addressList.length} resolved`;logging.log(constants_1.LogVerbosity.ERROR,errorString),callback(new Error(errorString),0)}else bindResult.count<addressList.length&&logging.log(constants_1.LogVerbosity.INFO,`WARNING Only ${bindResult.count} addresses added out of total ${addressList.length} resolved`),callback(null,bindResult.port)},error=>{const errorString=`No address added out of total ${addressList.length} resolved`;logging.log(constants_1.LogVerbosity.ERROR,errorString),callback(new Error(errorString),0)})},onError:error=>{callback(new Error(error.details),0)}};resolver_1.createResolver(portUri,resolverListener,this.options).updateResolution()}forceShutdown(){for(const http2Server of this.http2ServerList)http2Server.listening&&http2Server.close();this.started=!1,this.sessions.forEach(session=>{session.destroy(http2.constants.NGHTTP2_CANCEL)}),this.sessions.clear()}register(name,handler,serialize,deserialize,type){return!this.handlers.has(name)&&(this.handlers.set(name,{func:handler,serialize:serialize,deserialize:deserialize,type:type,path:name}),!0)}unregister(name){return this.handlers.delete(name)}start(){if(0===this.http2ServerList.length||this.http2ServerList.every(http2Server=>!0!==http2Server.listening))throw new Error("server must be bound in order to start");if(!0===this.started)throw new Error("server is already started");this.started=!0}tryShutdown(callback){let pendingChecks=0;function maybeCallback(){pendingChecks--,0===pendingChecks&&callback()}this.started=!1;for(const http2Server of this.http2ServerList)http2Server.listening&&(pendingChecks++,http2Server.close(maybeCallback));this.sessions.forEach(session=>{session.closed||(pendingChecks+=1,session.close(maybeCallback))}),0===pendingChecks&&callback()}addHttp2Port(){throw new Error("Not yet implemented")}_setupHandlers(http2Server){null!==http2Server&&(http2Server.on("stream",(stream,headers)=>{const contentType=headers[http2.constants.HTTP2_HEADER_CONTENT_TYPE];if("string"==typeof contentType&&contentType.startsWith("application/grpc"))try{const path=headers[http2.constants.HTTP2_HEADER_PATH],serverAddress=http2Server.address();let serverAddressString="null";serverAddress&&(serverAddressString="string"==typeof serverAddress?serverAddress:serverAddress.address+":"+serverAddress.port),trace("Received call to method "+path+" at address "+serverAddressString);const handler=this.handlers.get(path);if(void 0===handler)throw trace("No handler registered for method "+path+". Sending UNIMPLEMENTED status."),getUnimplementedStatusResponse(path);const call=new server_call_1.Http2ServerCallStream(stream,handler,this.options),metadata=call.receiveMetadata(headers);switch(handler.type){case"unary":!async function handleUnary(call,handler,metadata){const request=await call.receiveUnaryMessage();if(void 0===request||call.cancelled)return;const emitter=new server_call_1.ServerUnaryCallImpl(call,metadata,request);handler.func(emitter,(err,value,trailer,flags)=>{call.sendUnaryMessage(err,value,trailer,flags)})}(call,handler,metadata);break;case"clientStream":!function handleClientStreaming(call,handler,metadata){const stream=new server_call_1.ServerReadableStreamImpl(call,metadata,handler.deserialize);function respond(err,value,trailer,flags){stream.destroy(),call.sendUnaryMessage(err,value,trailer,flags)}if(call.cancelled)return;stream.on("error",respond),handler.func(stream,respond)}(call,handler,metadata);break;case"serverStream":!async function handleServerStreaming(call,handler,metadata){const request=await call.receiveUnaryMessage();if(void 0===request||call.cancelled)return;const stream=new server_call_1.ServerWritableStreamImpl(call,metadata,handler.serialize,request);handler.func(stream)}(call,handler,metadata);break;case"bidi":!function handleBidiStreaming(call,handler,metadata){const stream=new server_call_1.ServerDuplexStreamImpl(call,metadata,handler.serialize,handler.deserialize);if(call.cancelled)return;handler.func(stream)}(call,handler,metadata);break;default:throw new Error(`Unknown handler type: ${handler.type}`)}}catch(err){const call=new server_call_1.Http2ServerCallStream(stream,null,this.options);void 0===err.code&&(err.code=constants_1.Status.INTERNAL),call.sendError(err)}else stream.respond({[http2.constants.HTTP2_HEADER_STATUS]:http2.constants.HTTP_STATUS_UNSUPPORTED_MEDIA_TYPE},{endStream:!0})}),http2Server.on("session",session=>{this.started?(this.sessions.add(session),session.on("close",()=>{this.sessions.delete(session)})):session.destroy()}))}}},"y+4D":function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CallCredentials=void 0;const metadata_1=__webpack_require__("m7sO");class CallCredentials{static createFromMetadataGenerator(metadataGenerator){return new SingleCallCredentials(metadataGenerator)}static createFromGoogleCredential(googleCredentials){return CallCredentials.createFromMetadataGenerator((options,callback)=>{let getHeaders;getHeaders=function isCurrentOauth2Client(client){return"getRequestHeaders"in client&&"function"==typeof client.getRequestHeaders}(googleCredentials)?googleCredentials.getRequestHeaders(options.service_url):new Promise((resolve,reject)=>{googleCredentials.getRequestMetadata(options.service_url,(err,headers)=>{err?reject(err):resolve(headers)})}),getHeaders.then(headers=>{const metadata=new metadata_1.Metadata;for(const key of Object.keys(headers))metadata.add(key,headers[key]);callback(null,metadata)},err=>{callback(err)})})}static createEmpty(){return new EmptyCallCredentials}}exports.CallCredentials=CallCredentials;class ComposedCallCredentials extends CallCredentials{constructor(creds){super(),this.creds=creds}async generateMetadata(options){const base=new metadata_1.Metadata,generated=await Promise.all(this.creds.map(cred=>cred.generateMetadata(options)));for(const gen of generated)base.merge(gen);return base}compose(other){return new ComposedCallCredentials(this.creds.concat([other]))}_equals(other){return this===other||other instanceof ComposedCallCredentials&&this.creds.every((value,index)=>value._equals(other.creds[index]))}}class SingleCallCredentials extends CallCredentials{constructor(metadataGenerator){super(),this.metadataGenerator=metadataGenerator}generateMetadata(options){return new Promise((resolve,reject)=>{this.metadataGenerator(options,(err,metadata)=>{void 0!==metadata?resolve(metadata):reject(err)})})}compose(other){return new ComposedCallCredentials([this,other])}_equals(other){return this===other||other instanceof SingleCallCredentials&&this.metadataGenerator===other.metadataGenerator}}class EmptyCallCredentials extends CallCredentials{generateMetadata(options){return Promise.resolve(new metadata_1.Metadata)}compose(other){return other}_equals(other){return other instanceof EmptyCallCredentials}}},y9PA:function(module,exports,__webpack_require__){"use strict";var Type,Enum,util=module.exports=__webpack_require__("6Tgl"),roots=__webpack_require__("Bko/");util.codegen=__webpack_require__("6wl5"),util.fetch=__webpack_require__("eroE"),util.path=__webpack_require__("LZp6"),util.fs=util.inquire("fs"),util.toArray=function toArray(object){if(object){for(var keys=Object.keys(object),array=new Array(keys.length),index=0;index<keys.length;)array[index]=object[keys[index++]];return array}return[]},util.toObject=function toObject(array){for(var object={},index=0;index<array.length;){var key=array[index++],val=array[index++];void 0!==val&&(object[key]=val)}return object};var safePropBackslashRe=/\\/g,safePropQuoteRe=/"/g;util.isReserved=function isReserved(name){return/^(?:do|if|in|for|let|new|try|var|case|else|enum|eval|false|null|this|true|void|with|break|catch|class|const|super|throw|while|yield|delete|export|import|public|return|static|switch|typeof|default|extends|finally|package|private|continue|debugger|function|arguments|interface|protected|implements|instanceof)$/.test(name)},util.safeProp=function safeProp(prop){return!/^[$\w_]+$/.test(prop)||util.isReserved(prop)?'["'+prop.replace(safePropBackslashRe,"\\\\").replace(safePropQuoteRe,'\\"')+'"]':"."+prop},util.ucFirst=function ucFirst(str){return str.charAt(0).toUpperCase()+str.substring(1)};var camelCaseRe=/_([a-z])/g;util.camelCase=function camelCase(str){return str.substring(0,1)+str.substring(1).replace(camelCaseRe,function($0,$1){return $1.toUpperCase()})},util.compareFieldsById=function compareFieldsById(a,b){return a.id-b.id},util.decorateType=function decorateType(ctor,typeName){if(ctor.$type)return typeName&&ctor.$type.name!==typeName&&(util.decorateRoot.remove(ctor.$type),ctor.$type.name=typeName,util.decorateRoot.add(ctor.$type)),ctor.$type;Type||(Type=__webpack_require__("bs9O"));var type=new Type(typeName||ctor.name);return util.decorateRoot.add(type),type.ctor=ctor,Object.defineProperty(ctor,"$type",{value:type,enumerable:!1}),Object.defineProperty(ctor.prototype,"$type",{value:type,enumerable:!1}),type};var decorateEnumIndex=0;util.decorateEnum=function decorateEnum(object){if(object.$type)return object.$type;Enum||(Enum=__webpack_require__("vREW"));var enm=new Enum("Enum"+decorateEnumIndex++,object);return util.decorateRoot.add(enm),Object.defineProperty(object,"$type",{value:enm,enumerable:!1}),enm},util.setProperty=function setProperty(dst,path,value){if("object"!=typeof dst)throw TypeError("dst must be an object");if(!path)throw TypeError("path must be specified");return function setProp(dst,path,value){var part=path.shift();if(path.length>0)dst[part]=setProp(dst[part]||{},path,value);else{var prevValue=dst[part];prevValue&&(value=[].concat(prevValue).concat(value)),dst[part]=value}return dst}(dst,path=path.split("."),value)},Object.defineProperty(util,"decorateRoot",{get:function(){return roots.decorated||(roots.decorated=new(__webpack_require__("7m6H")))}})},yNTq:function(module,exports,__webpack_require__){"use strict";var utf8=exports;utf8.length=function utf8_length(string){for(var len=0,c=0,i=0;i<string.length;++i)(c=string.charCodeAt(i))<128?len+=1:c<2048?len+=2:55296==(64512&c)&&56320==(64512&string.charCodeAt(i+1))?(++i,len+=4):len+=3;return len},utf8.read=function utf8_read(buffer,start,end){if(end-start<1)return"";for(var t,parts=null,chunk=[],i=0;start<end;)(t=buffer[start++])<128?chunk[i++]=t:t>191&&t<224?chunk[i++]=(31&t)<<6|63&buffer[start++]:t>239&&t<365?(t=((7&t)<<18|(63&buffer[start++])<<12|(63&buffer[start++])<<6|63&buffer[start++])-65536,chunk[i++]=55296+(t>>10),chunk[i++]=56320+(1023&t)):chunk[i++]=(15&t)<<12|(63&buffer[start++])<<6|63&buffer[start++],i>8191&&((parts||(parts=[])).push(String.fromCharCode.apply(String,chunk)),i=0);return parts?(i&&parts.push(String.fromCharCode.apply(String,chunk.slice(0,i))),parts.join("")):String.fromCharCode.apply(String,chunk.slice(0,i))},utf8.write=function utf8_write(string,buffer,offset){for(var c1,c2,start=offset,i=0;i<string.length;++i)(c1=string.charCodeAt(i))<128?buffer[offset++]=c1:c1<2048?(buffer[offset++]=c1>>6|192,buffer[offset++]=63&c1|128):55296==(64512&c1)&&56320==(64512&(c2=string.charCodeAt(i+1)))?(c1=65536+((1023&c1)<<10)+(1023&c2),++i,buffer[offset++]=c1>>18|240,buffer[offset++]=c1>>12&63|128,buffer[offset++]=c1>>6&63|128,buffer[offset++]=63&c1|128):(buffer[offset++]=c1>>12|224,buffer[offset++]=c1>>6&63|128,buffer[offset++]=63&c1|128);return offset-start}},z8EH:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ChildLoadBalancerHandler=void 0;const load_balancer_1=__webpack_require__("JG2R"),channel_1=__webpack_require__("6XSn");exports.ChildLoadBalancerHandler=class{constructor(channelControlHelper){this.channelControlHelper=channelControlHelper,this.currentChild=null,this.pendingChild=null,this.ChildPolicyHelper=class{constructor(parent){this.parent=parent,this.child=null}createSubchannel(subchannelAddress,subchannelArgs){return this.parent.channelControlHelper.createSubchannel(subchannelAddress,subchannelArgs)}updateState(connectivityState,picker){var _a;if(this.calledByPendingChild()){if(connectivityState!==channel_1.ConnectivityState.READY)return;null===(_a=this.parent.currentChild)||void 0===_a||_a.destroy(),this.parent.currentChild=this.parent.pendingChild,this.parent.pendingChild=null}else if(!this.calledByCurrentChild())return;this.parent.channelControlHelper.updateState(connectivityState,picker)}requestReresolution(){var _a;const latestChild=null!==(_a=this.parent.pendingChild)&&void 0!==_a?_a:this.parent.currentChild;this.child===latestChild&&this.parent.channelControlHelper.requestReresolution()}setChild(newChild){this.child=newChild}calledByPendingChild(){return this.child===this.parent.pendingChild}calledByCurrentChild(){return this.child===this.parent.currentChild}}}updateAddressList(addressList,lbConfig,attributes){let childToUpdate;if(null===this.currentChild||this.currentChild.getTypeName()!==lbConfig.getLoadBalancerName()){const newHelper=new this.ChildPolicyHelper(this),newChild=load_balancer_1.createLoadBalancer(lbConfig,newHelper);newHelper.setChild(newChild),null===this.currentChild?(this.currentChild=newChild,childToUpdate=this.currentChild):(this.pendingChild&&this.pendingChild.destroy(),this.pendingChild=newChild,childToUpdate=this.pendingChild)}else childToUpdate=null===this.pendingChild?this.currentChild:this.pendingChild;childToUpdate.updateAddressList(addressList,lbConfig,attributes)}exitIdle(){this.currentChild&&(this.currentChild.resetBackoff(),this.pendingChild&&this.pendingChild.resetBackoff())}resetBackoff(){this.currentChild&&(this.currentChild.resetBackoff(),this.pendingChild&&this.pendingChild.resetBackoff())}destroy(){this.currentChild&&(this.currentChild.destroy(),this.currentChild=null),this.pendingChild&&(this.pendingChild.destroy(),this.pendingChild=null)}getTypeName(){return"child_load_balancer_helper"}}},z8sR:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Http2ServerCallStream=exports.ServerDuplexStreamImpl=exports.ServerWritableStreamImpl=exports.ServerReadableStreamImpl=exports.ServerUnaryCallImpl=void 0;const events_1=__webpack_require__("/0p4"),http2=__webpack_require__("MG4E"),stream_1=__webpack_require__("msIP"),constants_1=__webpack_require__("8o9P"),metadata_1=__webpack_require__("m7sO"),stream_decoder_1=__webpack_require__("lvRS"),logging=__webpack_require__("xQiD");function trace(text){logging.trace(constants_1.LogVerbosity.DEBUG,"server_call",text)}const DEADLINE_REGEX=/(\d{1,8})\s*([HMSmun])/,deadlineUnitsToMs={H:36e5,M:6e4,S:1e3,m:1,u:.001,n:1e-6},defaultResponseHeaders={"grpc-accept-encoding":"identity","grpc-encoding":"identity",[http2.constants.HTTP2_HEADER_STATUS]:http2.constants.HTTP_STATUS_OK,[http2.constants.HTTP2_HEADER_CONTENT_TYPE]:"application/grpc+proto"},defaultResponseOptions={waitForTrailers:!0};class ServerUnaryCallImpl extends events_1.EventEmitter{constructor(call,metadata,request){super(),this.call=call,this.metadata=metadata,this.request=request,this.cancelled=!1,this.call.setupSurfaceCall(this)}getPeer(){return this.call.getPeer()}sendMetadata(responseMetadata){this.call.sendMetadata(responseMetadata)}getDeadline(){return this.call.getDeadline()}}exports.ServerUnaryCallImpl=ServerUnaryCallImpl;class ServerReadableStreamImpl extends stream_1.Readable{constructor(call,metadata,deserialize){super({objectMode:!0}),this.call=call,this.metadata=metadata,this.deserialize=deserialize,this.cancelled=!1,this.call.setupSurfaceCall(this),this.call.setupReadable(this)}_read(size){this.call.consumeUnpushedMessages(this)&&this.call.resume()}getPeer(){return this.call.getPeer()}sendMetadata(responseMetadata){this.call.sendMetadata(responseMetadata)}getDeadline(){return this.call.getDeadline()}}exports.ServerReadableStreamImpl=ServerReadableStreamImpl;class ServerWritableStreamImpl extends stream_1.Writable{constructor(call,metadata,serialize,request){super({objectMode:!0}),this.call=call,this.metadata=metadata,this.serialize=serialize,this.request=request,this.cancelled=!1,this.trailingMetadata=new metadata_1.Metadata,this.call.setupSurfaceCall(this),this.on("error",err=>{this.call.sendError(err),this.end()})}getPeer(){return this.call.getPeer()}sendMetadata(responseMetadata){this.call.sendMetadata(responseMetadata)}getDeadline(){return this.call.getDeadline()}_write(chunk,encoding,callback){try{const response=this.call.serializeMessage(chunk);if(!this.call.write(response))return void this.call.once("drain",callback)}catch(err){err.code=constants_1.Status.INTERNAL,this.emit("error",err)}callback()}_final(callback){this.call.sendStatus({code:constants_1.Status.OK,details:"OK",metadata:this.trailingMetadata}),callback(null)}end(metadata){metadata&&(this.trailingMetadata=metadata),super.end()}}exports.ServerWritableStreamImpl=ServerWritableStreamImpl;class ServerDuplexStreamImpl extends stream_1.Duplex{constructor(call,metadata,serialize,deserialize){super({objectMode:!0}),this.call=call,this.metadata=metadata,this.serialize=serialize,this.deserialize=deserialize,this.cancelled=!1,this.trailingMetadata=new metadata_1.Metadata,this.call.setupSurfaceCall(this),this.call.setupReadable(this),this.on("error",err=>{this.call.sendError(err),this.end()})}getPeer(){return this.call.getPeer()}sendMetadata(responseMetadata){this.call.sendMetadata(responseMetadata)}getDeadline(){return this.call.getDeadline()}end(metadata){metadata&&(this.trailingMetadata=metadata),super.end()}}exports.ServerDuplexStreamImpl=ServerDuplexStreamImpl,ServerDuplexStreamImpl.prototype._read=ServerReadableStreamImpl.prototype._read,ServerDuplexStreamImpl.prototype._write=ServerWritableStreamImpl.prototype._write,ServerDuplexStreamImpl.prototype._final=ServerWritableStreamImpl.prototype._final,ServerDuplexStreamImpl.prototype.end=ServerWritableStreamImpl.prototype.end;class Http2ServerCallStream extends events_1.EventEmitter{constructor(stream,handler,options){super(),this.stream=stream,this.handler=handler,this.options=options,this.cancelled=!1,this.deadlineTimer=setTimeout(()=>{},0),this.deadline=1/0,this.wantTrailers=!1,this.metadataSent=!1,this.canPush=!1,this.isPushPending=!1,this.bufferedMessages=[],this.messagesToPush=[],this.maxSendMessageSize=constants_1.DEFAULT_MAX_SEND_MESSAGE_LENGTH,this.maxReceiveMessageSize=constants_1.DEFAULT_MAX_RECEIVE_MESSAGE_LENGTH,this.stream.once("error",err=>{}),this.stream.once("close",()=>{var _a;trace("Request to method "+(null===(_a=this.handler)||void 0===_a?void 0:_a.path)+" stream closed with rstCode "+this.stream.rstCode),this.cancelled=!0,this.emit("cancelled","cancelled")}),this.stream.on("drain",()=>{this.emit("drain")}),"grpc.max_send_message_length"in options&&(this.maxSendMessageSize=options["grpc.max_send_message_length"]),"grpc.max_receive_message_length"in options&&(this.maxReceiveMessageSize=options["grpc.max_receive_message_length"]),clearTimeout(this.deadlineTimer)}checkCancelled(){return this.stream.destroyed&&(this.cancelled=!0),this.cancelled}sendMetadata(customMetadata){if(this.checkCancelled())return;if(this.metadataSent)return;this.metadataSent=!0;const custom=customMetadata?customMetadata.toHttp2Headers():null,headers=Object.assign({},defaultResponseHeaders,custom);this.stream.respond(headers,defaultResponseOptions)}receiveMetadata(headers){const metadata=metadata_1.Metadata.fromHttp2Headers(headers),timeoutHeader=metadata.get("grpc-timeout");if(timeoutHeader.length>0){const match=timeoutHeader[0].toString().match(DEADLINE_REGEX);if(null===match){const err=new Error("Invalid deadline");return err.code=constants_1.Status.OUT_OF_RANGE,void this.sendError(err)}const timeout=+match[1]*deadlineUnitsToMs[match[2]]|0,now=new Date;this.deadline=now.setMilliseconds(now.getMilliseconds()+timeout),this.deadlineTimer=setTimeout(handleExpiredDeadline,timeout,this),metadata.remove("grpc-timeout")}return metadata.remove(http2.constants.HTTP2_HEADER_ACCEPT_ENCODING),metadata.remove(http2.constants.HTTP2_HEADER_TE),metadata.remove(http2.constants.HTTP2_HEADER_CONTENT_TYPE),metadata.remove("grpc-encoding"),metadata.remove("grpc-accept-encoding"),metadata}receiveUnaryMessage(){return new Promise((resolve,reject)=>{const stream=this.stream,chunks=[];let totalLength=0;stream.on("data",data=>{chunks.push(data),totalLength+=data.byteLength}),stream.once("end",async()=>{try{const requestBytes=Buffer.concat(chunks,totalLength);-1!==this.maxReceiveMessageSize&&requestBytes.length>this.maxReceiveMessageSize&&(this.sendError({code:constants_1.Status.RESOURCE_EXHAUSTED,details:`Received message larger than max (${requestBytes.length} vs. ${this.maxReceiveMessageSize})`}),resolve()),resolve(this.deserializeMessage(requestBytes))}catch(err){err.code=constants_1.Status.INTERNAL,this.sendError(err),resolve()}})})}serializeMessage(value){const messageBuffer=this.handler.serialize(value),byteLength=messageBuffer.byteLength,output=Buffer.allocUnsafe(byteLength+5);return output.writeUInt8(0,0),output.writeUInt32BE(byteLength,1),messageBuffer.copy(output,5),output}deserializeMessage(bytes){const receivedMessage=bytes.slice(5);return this.handler.deserialize(receivedMessage)}async sendUnaryMessage(err,value,metadata,flags){if(!this.checkCancelled()){if(metadata||(metadata=new metadata_1.Metadata),err)return Object.prototype.hasOwnProperty.call(err,"metadata")||(err.metadata=metadata),void this.sendError(err);try{const response=this.serializeMessage(value);this.write(response),this.sendStatus({code:constants_1.Status.OK,details:"OK",metadata:metadata})}catch(err){err.code=constants_1.Status.INTERNAL,this.sendError(err)}}}sendStatus(statusObj){var _a;this.checkCancelled()||(trace("Request to method "+(null===(_a=this.handler)||void 0===_a?void 0:_a.path)+" ended with status code: "+constants_1.Status[statusObj.code]+" details: "+statusObj.details),clearTimeout(this.deadlineTimer),this.wantTrailers||(this.wantTrailers=!0,this.stream.once("wantTrailers",()=>{const trailersToSend=Object.assign({"grpc-status":statusObj.code,"grpc-message":encodeURI(statusObj.details)},statusObj.metadata.toHttp2Headers());this.stream.sendTrailers(trailersToSend)}),this.sendMetadata(),this.stream.end()))}sendError(error){if(this.checkCancelled())return;const status={code:constants_1.Status.UNKNOWN,details:"message"in error?error.message:"Unknown Error",metadata:"metadata"in error&&void 0!==error.metadata?error.metadata:new metadata_1.Metadata};"code"in error&&"number"==typeof error.code&&Number.isInteger(error.code)&&(status.code=error.code,"details"in error&&"string"==typeof error.details&&(status.details=error.details)),this.sendStatus(status)}write(chunk){if(!this.checkCancelled()){if(!(-1!==this.maxSendMessageSize&&chunk.length>this.maxSendMessageSize))return this.sendMetadata(),this.stream.write(chunk);this.sendError({code:constants_1.Status.RESOURCE_EXHAUSTED,details:`Sent message larger than max (${chunk.length} vs. ${this.maxSendMessageSize})`})}}resume(){this.stream.resume()}setupSurfaceCall(call){this.once("cancelled",reason=>{call.cancelled=!0,call.emit("cancelled",reason)})}setupReadable(readable){const decoder=new stream_decoder_1.StreamDecoder;this.stream.on("data",async data=>{const messages=decoder.write(data);for(const message of messages){if(-1!==this.maxReceiveMessageSize&&message.length>this.maxReceiveMessageSize)return void this.sendError({code:constants_1.Status.RESOURCE_EXHAUSTED,details:`Received message larger than max (${message.length} vs. ${this.maxReceiveMessageSize})`});this.pushOrBufferMessage(readable,message)}}),this.stream.once("end",()=>{this.pushOrBufferMessage(readable,null)})}consumeUnpushedMessages(readable){for(this.canPush=!0;this.messagesToPush.length>0;){const nextMessage=this.messagesToPush.shift(),canPush=readable.push(nextMessage);if(null===nextMessage||!1===canPush){this.canPush=!1;break}}return this.canPush}pushOrBufferMessage(readable,messageBytes){this.isPushPending?this.bufferedMessages.push(messageBytes):this.pushMessage(readable,messageBytes)}async pushMessage(readable,messageBytes){if(null!==messageBytes){this.isPushPending=!0;try{const deserialized=await this.deserializeMessage(messageBytes);this.canPush?readable.push(deserialized)||(this.canPush=!1,this.stream.pause()):this.messagesToPush.push(deserialized)}catch(error){this.bufferedMessages.length=0,"code"in error&&"number"==typeof error.code&&Number.isInteger(error.code)&&error.code>=constants_1.Status.OK&&error.code<=constants_1.Status.UNAUTHENTICATED||(error.code=constants_1.Status.INTERNAL),readable.emit("error",error)}this.isPushPending=!1,this.bufferedMessages.length>0&&this.pushMessage(readable,this.bufferedMessages.shift())}else this.canPush?readable.push(null):this.messagesToPush.push(null)}getPeer(){const socket=this.stream.session.socket;return socket.remoteAddress?socket.remotePort?`${socket.remoteAddress}:${socket.remotePort}`:socket.remoteAddress:"unknown"}getDeadline(){return this.deadline}}function handleExpiredDeadline(call){const err=new Error("Deadline exceeded");err.code=constants_1.Status.DEADLINE_EXCEEDED,call.sendError(err),call.cancelled=!0,call.emit("cancelled","deadline")}exports.Http2ServerCallStream=Http2ServerCallStream}};