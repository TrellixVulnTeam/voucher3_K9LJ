exports.ids=[1],exports.modules={"+7ve":function(module,exports,__webpack_require__){"use strict";var RingBuffer=__webpack_require__("u5A6"),Pledge=function(){this._complete=!1,this._callbacks=new RingBuffer(Pledge.QUEUE_SIZE)};Pledge.QUEUE_SIZE=4,Pledge.all=function(list){var pledge=new Pledge,pending=list.length,n=pending;for(0===pending&&pledge.done();n--;)list[n].then(function(){0===(pending-=1)&&pledge.done()});return pledge},Pledge.prototype.then=function(callback){this._complete?callback():this._callbacks.push(callback)},Pledge.prototype.done=function(){this._complete=!0;for(var callback,callbacks=this._callbacks;callback=callbacks.shift();)callback()},module.exports=Pledge},"2RBK":function(module,exports,__webpack_require__){"use strict";var Stream=__webpack_require__("msIP").Stream,util=__webpack_require__("jK02"),driver=__webpack_require__("qf7z"),EventTarget=__webpack_require__("sWNQ"),Event=__webpack_require__("AhIK"),API=function(options){options=options||{},driver.validateOptions(options,["headers","extensions","maxLength","ping","proxy","tls","ca"]),this.readable=this.writable=!0;var headers=options.headers;if(headers)for(var name in headers)this._driver.setHeader(name,headers[name]);var extensions=options.extensions;extensions&&[].concat(extensions).forEach(this._driver.addExtension,this._driver),this._ping=options.ping,this._pingId=0,this.readyState=API.CONNECTING,this.bufferedAmount=0,this.protocol="",this.url=this._driver.url,this.version=this._driver.version;var self=this;this._driver.on("open",function(e){self._open()}),this._driver.on("message",function(e){self._receiveMessage(e.data)}),this._driver.on("close",function(e){self._beginClose(e.reason,e.code)}),this._driver.on("error",function(error){self._emitError(error.message)}),this.on("error",function(){}),this._driver.messages.on("drain",function(){self.emit("drain")}),this._ping&&(this._pingTimer=setInterval(function(){self._pingId+=1,self.ping(self._pingId.toString())},1e3*this._ping)),this._configureStream(),this._proxy||(this._stream.pipe(this._driver.io),this._driver.io.pipe(this._stream))};util.inherits(API,Stream),API.CONNECTING=0,API.OPEN=1,API.CLOSING=2,API.CLOSED=3,API.CLOSE_TIMEOUT=3e4;var instance={write:function(data){return this.send(data)},end:function(data){void 0!==data&&this.send(data),this.close()},pause:function(){return this._driver.messages.pause()},resume:function(){return this._driver.messages.resume()},send:function(data){return!(this.readyState>API.OPEN)&&(data instanceof Buffer||(data=String(data)),this._driver.messages.write(data))},ping:function(message,callback){return!(this.readyState>API.OPEN)&&this._driver.ping(message,callback)},close:function(code,reason){if(void 0===code&&(code=1e3),void 0===reason&&(reason=""),1e3!==code&&(code<3e3||code>4999))throw new Error("Failed to execute 'close' on WebSocket: The code must be either 1000, or between 3000 and 4999. "+code+" is neither.");this.readyState!==API.CLOSED&&(this.readyState=API.CLOSING);var self=this;this._closeTimer=setTimeout(function(){self._beginClose("",1006)},API.CLOSE_TIMEOUT),this._driver.close(reason,code)},_configureStream:function(){var self=this;this._stream.setTimeout(0),this._stream.setNoDelay(!0),["close","end"].forEach(function(event){this._stream.on(event,function(){self._finalizeClose()})},this),this._stream.on("error",function(error){self._emitError("Network error: "+self.url+": "+error.message),self._finalizeClose()})},_open:function(){if(this.readyState===API.CONNECTING){this.readyState=API.OPEN,this.protocol=this._driver.protocol||"";var event=new Event("open");event.initEvent("open",!1,!1),this.dispatchEvent(event)}},_receiveMessage:function(data){if(this.readyState>API.OPEN)return!1;this.readable&&this.emit("data",data);var event=new Event("message",{data:data});event.initEvent("message",!1,!1),this.dispatchEvent(event)},_emitError:function(message){if(!(this.readyState>=API.CLOSING)){var event=new Event("error",{message:message});event.initEvent("error",!1,!1),this.dispatchEvent(event)}},_beginClose:function(reason,code){this.readyState!==API.CLOSED&&(this.readyState=API.CLOSING,this._closeParams=[reason,code],this._stream&&(this._stream.destroy(),this._stream.readable||this._finalizeClose()))},_finalizeClose:function(){if(this.readyState!==API.CLOSED){this.readyState=API.CLOSED,this._closeTimer&&clearTimeout(this._closeTimer),this._pingTimer&&clearInterval(this._pingTimer),this._stream&&this._stream.end(),this.readable&&this.emit("end"),this.readable=this.writable=!1;var reason=this._closeParams?this._closeParams[0]:"",code=this._closeParams?this._closeParams[1]:1006,event=new Event("close",{code:code,reason:reason});event.initEvent("close",!1,!1),this.dispatchEvent(event)}}};for(var method in instance)API.prototype[method]=instance[method];for(var key in EventTarget)API.prototype[key]=EventTarget[key];module.exports=API},"2SO9":function(module,exports,__webpack_require__){"use strict";var Parser=__webpack_require__("IAmK"),Pipeline=__webpack_require__("8HKJ"),Extensions=function(){this._rsv1=this._rsv2=this._rsv3=null,this._byName={},this._inOrder=[],this._sessions=[],this._index={}};Extensions.MESSAGE_OPCODES=[1,2];var instance={add:function(ext){if("string"!=typeof ext.name)throw new TypeError("extension.name must be a string");if("permessage"!==ext.type)throw new TypeError('extension.type must be "permessage"');if("boolean"!=typeof ext.rsv1)throw new TypeError("extension.rsv1 must be true or false");if("boolean"!=typeof ext.rsv2)throw new TypeError("extension.rsv2 must be true or false");if("boolean"!=typeof ext.rsv3)throw new TypeError("extension.rsv3 must be true or false");if(this._byName.hasOwnProperty(ext.name))throw new TypeError('An extension with name "'+ext.name+'" is already registered');this._byName[ext.name]=ext,this._inOrder.push(ext)},generateOffer:function(){var sessions=[],offer=[],index={};return this._inOrder.forEach(function(ext){var session=ext.createClientSession();if(session){var record=[ext,session];sessions.push(record),index[ext.name]=record;var offers=session.generateOffer();(offers=offers?[].concat(offers):[]).forEach(function(off){offer.push(Parser.serializeParams(ext.name,off))},this)}},this),this._sessions=sessions,this._index=index,offer.length>0?offer.join(", "):null},activate:function(header){var responses=Parser.parseHeader(header),sessions=[];responses.eachOffer(function(name,params){var record=this._index[name];if(!record)throw new Error('Server sent an extension response for unknown extension "'+name+'"');var ext=record[0],session=record[1],reserved=this._reserved(ext);if(reserved)throw new Error("Server sent two extension responses that use the RSV"+reserved[0]+' bit: "'+reserved[1]+'" and "'+ext.name+'"');if(!0!==session.activate(params))throw new Error("Server sent unacceptable extension parameters: "+Parser.serializeParams(name,params));this._reserve(ext),sessions.push(record)},this),this._sessions=sessions,this._pipeline=new Pipeline(sessions)},generateResponse:function(header){var sessions=[],response=[],offers=Parser.parseHeader(header);return this._inOrder.forEach(function(ext){var offer=offers.byName(ext.name);if(0!==offer.length&&!this._reserved(ext)){var session=ext.createServerSession(offer);session&&(this._reserve(ext),sessions.push([ext,session]),response.push(Parser.serializeParams(ext.name,session.generateResponse())))}},this),this._sessions=sessions,this._pipeline=new Pipeline(sessions),response.length>0?response.join(", "):null},validFrameRsv:function(frame){var ext,allowed={rsv1:!1,rsv2:!1,rsv3:!1};if(Extensions.MESSAGE_OPCODES.indexOf(frame.opcode)>=0)for(var i=0,n=this._sessions.length;i<n;i++)ext=this._sessions[i][0],allowed.rsv1=allowed.rsv1||ext.rsv1,allowed.rsv2=allowed.rsv2||ext.rsv2,allowed.rsv3=allowed.rsv3||ext.rsv3;return(allowed.rsv1||!frame.rsv1)&&(allowed.rsv2||!frame.rsv2)&&(allowed.rsv3||!frame.rsv3)},processIncomingMessage:function(message,callback,context){this._pipeline.processIncomingMessage(message,callback,context)},processOutgoingMessage:function(message,callback,context){this._pipeline.processOutgoingMessage(message,callback,context)},close:function(callback,context){if(!this._pipeline)return callback.call(context);this._pipeline.close(callback,context)},_reserve:function(ext){this._rsv1=this._rsv1||ext.rsv1&&ext.name,this._rsv2=this._rsv2||ext.rsv2&&ext.name,this._rsv3=this._rsv3||ext.rsv3&&ext.name},_reserved:function(ext){return this._rsv1&&ext.rsv1?[1,this._rsv1]:this._rsv2&&ext.rsv2?[2,this._rsv2]:!(!this._rsv3||!ext.rsv3)&&[3,this._rsv3]}};for(var key in instance)Extensions.prototype[key]=instance[key];module.exports=Extensions},"2nJ2":function(module,exports,__webpack_require__){"use strict";var Buffer=__webpack_require__("hwdV").Buffer,StreamReader=function(){this._queue=[],this._queueSize=0,this._offset=0};StreamReader.prototype.put=function(buffer){buffer&&0!==buffer.length&&(Buffer.isBuffer(buffer)||(buffer=Buffer.from(buffer)),this._queue.push(buffer),this._queueSize+=buffer.length)},StreamReader.prototype.read=function(length){if(length>this._queueSize)return null;if(0===length)return Buffer.alloc(0);this._queueSize-=length;var buffers,buffer,queue=this._queue,remain=length,first=queue[0];if(first.length>=length)return first.length===length?queue.shift():(buffer=first.slice(0,length),queue[0]=first.slice(length),buffer);for(var i=0,n=queue.length;i<n&&!(remain<queue[i].length);i++)remain-=queue[i].length;return buffers=queue.splice(0,i),remain>0&&queue.length>0&&(buffers.push(queue[0].slice(0,remain)),queue[0]=queue[0].slice(remain)),Buffer.concat(buffers,length)},StreamReader.prototype.eachByte=function(callback,context){for(var buffer,n,index;this._queue.length>0;){for(n=(buffer=this._queue[0]).length;this._offset<n;)index=this._offset,this._offset+=1,callback.call(context,buffer[index]);this._offset=0,this._queue.shift()}},module.exports=StreamReader},"7X3U":function(module,exports,__webpack_require__){"use strict";var Stream=__webpack_require__("msIP").Stream,util=__webpack_require__("jK02"),driver=__webpack_require__("qf7z"),Headers=__webpack_require__("q+85"),API=__webpack_require__("2RBK"),EventTarget=__webpack_require__("sWNQ"),Event=__webpack_require__("AhIK"),EventSource=function(request,response,options){this.writable=!0,options=options||{},this._stream=response.socket,this._ping=options.ping||this.DEFAULT_PING,this._retry=options.retry||this.DEFAULT_RETRY;var scheme=driver.isSecureRequest(request)?"https:":"http:";this.url=scheme+"//"+request.headers.host+request.url,this.lastEventId=request.headers["last-event-id"]||"",this.readyState=API.CONNECTING;var headers=new Headers,self=this;if(options.headers)for(var key in options.headers)headers.set(key,options.headers[key]);if(this._stream&&this._stream.writable){process.nextTick(function(){self._open()}),this._stream.setTimeout(0),this._stream.setNoDelay(!0);var handshake="HTTP/1.1 200 OK\r\nContent-Type: text/event-stream\r\nCache-Control: no-cache, no-store\r\nConnection: close\r\n"+headers.toString()+"\r\nretry: "+Math.floor(1e3*this._retry)+"\r\n\r\n";this._write(handshake),this._stream.on("drain",function(){self.emit("drain")}),this._ping&&(this._pingTimer=setInterval(function(){self.ping()},1e3*this._ping)),["error","end"].forEach(function(event){self._stream.on(event,function(){self.close()})})}};util.inherits(EventSource,Stream),EventSource.isEventSource=function(request){return"GET"===request.method&&(request.headers.accept||"").split(/\s*,\s*/).indexOf("text/event-stream")>=0};var instance={DEFAULT_PING:10,DEFAULT_RETRY:5,_write:function(chunk){if(!this.writable)return!1;try{return this._stream.write(chunk,"utf8")}catch(e){return!1}},_open:function(){if(this.readyState===API.CONNECTING){this.readyState=API.OPEN;var event=new Event("open");event.initEvent("open",!1,!1),this.dispatchEvent(event)}},write:function(message){return this.send(message)},end:function(message){void 0!==message&&this.write(message),this.close()},send:function(message,options){if(this.readyState>API.OPEN)return!1;message=String(message).replace(/(\r\n|\r|\n)/g,"$1data: ");var frame="";return(options=options||{}).event&&(frame+="event: "+options.event+"\r\n"),options.id&&(frame+="id: "+options.id+"\r\n"),frame+="data: "+message+"\r\n\r\n",this._write(frame)},ping:function(){return this._write(":\r\n\r\n")},close:function(){if(this.readyState>API.OPEN)return!1;this.readyState=API.CLOSED,this.writable=!1,this._pingTimer&&clearInterval(this._pingTimer),this._stream&&this._stream.end();var event=new Event("close");return event.initEvent("close",!1,!1),this.dispatchEvent(event),!0}};for(var method in instance)EventSource.prototype[method]=instance[method];for(var key in EventTarget)EventSource.prototype[key]=EventTarget[key];module.exports=EventSource},"8HKJ":function(module,exports,__webpack_require__){"use strict";var Cell=__webpack_require__("N1ro"),Pledge=__webpack_require__("+7ve"),Pipeline=function(sessions){this._cells=sessions.map(function(session){return new Cell(session)}),this._stopped={incoming:!1,outgoing:!1}};Pipeline.prototype.processIncomingMessage=function(message,callback,context){this._stopped.incoming||this._loop("incoming",this._cells.length-1,-1,-1,message,callback,context)},Pipeline.prototype.processOutgoingMessage=function(message,callback,context){this._stopped.outgoing||this._loop("outgoing",0,this._cells.length,1,message,callback,context)},Pipeline.prototype.close=function(callback,context){this._stopped={incoming:!0,outgoing:!0};var closed=this._cells.map(function(a){return a.close()});callback&&Pledge.all(closed).then(function(){callback.call(context)})},Pipeline.prototype._loop=function(direction,start,end,step,message,callback,context){for(var cells=this._cells,n=cells.length,self=this;n--;)cells[n].pending(direction);var pipe=function(index,error,msg){if(index===end)return callback.call(context,error,msg);cells[index][direction](error,msg,function(err,m){err&&(self._stopped[direction]=!0),pipe(index+step,err,m)})};pipe(start,null,message)},module.exports=Pipeline},AhIK:function(module,exports,__webpack_require__){"use strict";var Event=function(eventType,options){for(var key in this.type=eventType,options)this[key]=options[key]};Event.prototype.initEvent=function(eventType,canBubble,cancelable){this.type=eventType,this.bubbles=canBubble,this.cancelable=cancelable},Event.prototype.stopPropagation=function(){},Event.prototype.preventDefault=function(){},Event.CAPTURING_PHASE=1,Event.AT_TARGET=2,Event.BUBBLING_PHASE=3,module.exports=Event},AzCm:function(module,exports,__webpack_require__){"use strict";var Buffer=__webpack_require__("hwdV").Buffer,crypto=__webpack_require__("PJMN"),url=__webpack_require__("bzos"),util=__webpack_require__("jK02"),HttpParser=__webpack_require__("ziip"),Base=__webpack_require__("Wdmt"),Hybi=__webpack_require__("dt2+"),Proxy=__webpack_require__("zzpY"),Client=function(_url,options){this.version="hybi-"+Hybi.VERSION,Hybi.call(this,null,_url,options),this.readyState=-1,this._key=Client.generateKey(),this._accept=Hybi.generateAccept(this._key),this._http=new HttpParser("response");var uri=url.parse(this.url),auth=uri.auth&&Buffer.from(uri.auth,"utf8").toString("base64");if(this.VALID_PROTOCOLS.indexOf(uri.protocol)<0)throw new Error(this.url+" is not a valid WebSocket URL");this._pathname=(uri.pathname||"/")+(uri.search||""),this._headers.set("Host",uri.host),this._headers.set("Upgrade","websocket"),this._headers.set("Connection","Upgrade"),this._headers.set("Sec-WebSocket-Key",this._key),this._headers.set("Sec-WebSocket-Version",Hybi.VERSION),this._protocols.length>0&&this._headers.set("Sec-WebSocket-Protocol",this._protocols.join(", ")),auth&&this._headers.set("Authorization","Basic "+auth)};util.inherits(Client,Hybi),Client.generateKey=function(){return crypto.randomBytes(16).toString("base64")};var instance={VALID_PROTOCOLS:["ws:","wss:"],proxy:function(origin,options){return new Proxy(this,origin,options)},start:function(){return-1===this.readyState&&(this._write(this._handshakeRequest()),this.readyState=0,!0)},parse:function(chunk){if(3!==this.readyState){if(this.readyState>0)return Hybi.prototype.parse.call(this,chunk);this._http.parse(chunk),this._http.isComplete()&&(this._validateHandshake(),3!==this.readyState&&(this._open(),this.parse(this._http.body)))}},_handshakeRequest:function(){var extensions=this._extensions.generateOffer();extensions&&this._headers.set("Sec-WebSocket-Extensions",extensions);var headers=["GET "+this._pathname+" HTTP/1.1",this._headers.toString(),""];return Buffer.from(headers.join("\r\n"),"utf8")},_failHandshake:function(message){message="Error during WebSocket handshake: "+message,this.readyState=3,this.emit("error",new Error(message)),this.emit("close",new Base.CloseEvent(this.ERRORS.protocol_error,message))},_validateHandshake:function(){if(this.statusCode=this._http.statusCode,this.headers=this._http.headers,this._http.error)return this._failHandshake(this._http.error.message);if(101!==this._http.statusCode)return this._failHandshake("Unexpected response code: "+this._http.statusCode);var headers=this._http.headers,upgrade=headers.upgrade||"",connection=headers.connection||"",accept=headers["sec-websocket-accept"]||"",protocol=headers["sec-websocket-protocol"]||"";if(""===upgrade)return this._failHandshake("'Upgrade' header is missing");if("websocket"!==upgrade.toLowerCase())return this._failHandshake("'Upgrade' header value is not 'WebSocket'");if(""===connection)return this._failHandshake("'Connection' header is missing");if("upgrade"!==connection.toLowerCase())return this._failHandshake("'Connection' header value is not 'Upgrade'");if(accept!==this._accept)return this._failHandshake("Sec-WebSocket-Accept mismatch");if(this.protocol=null,""!==protocol){if(this._protocols.indexOf(protocol)<0)return this._failHandshake("Sec-WebSocket-Protocol mismatch");this.protocol=protocol}try{this._extensions.activate(this.headers["sec-websocket-extensions"])}catch(e){return this._failHandshake(e.message)}}};for(var key in instance)Client.prototype[key]=instance[key];module.exports=Client},Ejeu:function(module,exports,__webpack_require__){"use strict";var Frame=function(){},instance={final:!1,rsv1:!1,rsv2:!1,rsv3:!1,opcode:null,masked:!1,maskingKey:null,lengthBytes:1,length:0,payload:null};for(var key in instance)Frame.prototype[key]=instance[key];module.exports=Frame},Gfnk:function(module,exports,__webpack_require__){"use strict";var RingBuffer=__webpack_require__("u5A6"),Functor=function(session,method){this._session=session,this._method=method,this._queue=new RingBuffer(Functor.QUEUE_SIZE),this._stopped=!1,this.pending=0};Functor.QUEUE_SIZE=8,Functor.prototype.call=function(error,message,callback,context){if(!this._stopped){var record={error:error,message:message,callback:callback,context:context,done:!1},called=!1,self=this;if(this._queue.push(record),record.error)return record.done=!0,this._stop(),this._flushQueue();var handler=function(err,msg){called^(called=!0)&&(err?(self._stop(),record.error=err,record.message=null):record.message=msg,record.done=!0,self._flushQueue())};try{this._session[this._method](message,handler)}catch(err){handler(err)}}},Functor.prototype._stop=function(){this.pending=this._queue.length,this._stopped=!0},Functor.prototype._flushQueue=function(){for(var record,queue=this._queue;queue.length>0&&queue.peek().done;)(record=queue.shift()).error?(this.pending=0,queue.clear()):this.pending-=1,record.callback.call(record.context,record.error,record.message)},module.exports=Functor},HJXK:function(module,exports,__webpack_require__){"use strict";var Buffer=__webpack_require__("hwdV").Buffer,Base=__webpack_require__("Wdmt"),Draft75=__webpack_require__("O1VW"),crypto=__webpack_require__("PJMN"),util=__webpack_require__("jK02"),numberFromKey=function(key){return parseInt((key.match(/[0-9]/g)||[]).join(""),10)},spacesInKey=function(key){return(key.match(/ /g)||[]).length},Draft76=function(request,url,options){Draft75.apply(this,arguments),this._stage=-1,this._body=[],this.version="hixie-76",this._headers.clear(),this._headers.set("Upgrade","WebSocket"),this._headers.set("Connection","Upgrade"),this._headers.set("Sec-WebSocket-Origin",this._request.headers.origin),this._headers.set("Sec-WebSocket-Location",this.url)};util.inherits(Draft76,Draft75);var instance={BODY_SIZE:8,start:function(){return!!Draft75.prototype.start.call(this)&&(this._started=!0,this._sendHandshakeBody(),!0)},close:function(){return 3!==this.readyState&&(1===this.readyState&&this._write(Buffer.from([255,0])),this.readyState=3,this.emit("close",new Base.CloseEvent(null,null)),!0)},_handshakeResponse:function(){var key1=(headers=this._request.headers)["sec-websocket-key1"],key2=headers["sec-websocket-key2"];if(!key1)throw new Error("Missing required header: Sec-WebSocket-Key1");if(!key2)throw new Error("Missing required header: Sec-WebSocket-Key2");var number1=numberFromKey(key1),spaces1=spacesInKey(key1),number2=numberFromKey(key2),spaces2=spacesInKey(key2);if(number1%spaces1!=0||number2%spaces2!=0)throw new Error("Client sent invalid Sec-WebSocket-Key headers");this._keyValues=[number1/spaces1,number2/spaces2];var headers=["HTTP/1.1 101 WebSocket Protocol Handshake",this._headers.toString(),""];return Buffer.from(headers.join("\r\n"),"binary")},_handshakeSignature:function(){if(this._body.length<this.BODY_SIZE)return null;var md5=crypto.createHash("md5"),buffer=Buffer.allocUnsafe(8+this.BODY_SIZE);return buffer.writeUInt32BE(this._keyValues[0],0),buffer.writeUInt32BE(this._keyValues[1],4),Buffer.from(this._body).copy(buffer,8,0,this.BODY_SIZE),md5.update(buffer),Buffer.from(md5.digest("binary"),"binary")},_sendHandshakeBody:function(){if(this._started){var signature=this._handshakeSignature();signature&&(this._write(signature),this._stage=0,this._open(),this._body.length>this.BODY_SIZE&&this.parse(this._body.slice(this.BODY_SIZE)))}},_parseLeadingByte:function(octet){if(255!==octet)return Draft75.prototype._parseLeadingByte.call(this,octet);this._closing=!0,this._length=0,this._stage=1}};for(var key in instance)Draft76.prototype[key]=instance[key];module.exports=Draft76},IAmK:function(module,exports,__webpack_require__){"use strict";var TOKEN=/([!#\$%&'\*\+\-\.\^_`\|~0-9A-Za-z]+)/,NOTOKEN=/([^!#\$%&'\*\+\-\.\^_`\|~0-9A-Za-z])/g,PARAM=new RegExp(TOKEN.source+"(?:=(?:"+TOKEN.source+"|"+/"((?:\\[\x00-\x7f]|[^\x00-\x08\x0a-\x1f\x7f"\\])*)"/.source+"))?"),EXT=new RegExp(TOKEN.source+"(?: *; *"+PARAM.source+")*","g"),EXT_LIST=new RegExp("^"+EXT.source+"(?: *, *"+EXT.source+")*$"),NUMBER=/^-?(0|[1-9][0-9]*)(\.[0-9]+)?$/,hasOwnProperty=Object.prototype.hasOwnProperty,Parser={parseHeader:function(header){var offers=new Offers;if(""===header||void 0===header)return offers;if(!EXT_LIST.test(header))throw new SyntaxError("Invalid Sec-WebSocket-Extensions header: "+header);return header.match(EXT).forEach(function(value){var params=value.match(new RegExp(PARAM.source,"g")),name=params.shift(),offer={};params.forEach(function(param){var data,args=param.match(PARAM),key=args[1];data=void 0!==args[2]?args[2]:void 0===args[3]||args[3].replace(/\\/g,""),NUMBER.test(data)&&(data=parseFloat(data)),hasOwnProperty.call(offer,key)?(offer[key]=[].concat(offer[key]),offer[key].push(data)):offer[key]=data},this),offers.push(name,offer)},this),offers},serializeParams:function(name,params){var values=[],print=function(key,value){value instanceof Array?value.forEach(function(v){print(key,v)}):!0===value?values.push(key):"number"==typeof value?values.push(key+"="+value):NOTOKEN.test(value)?values.push(key+'="'+value.replace(/"/g,'\\"')+'"'):values.push(key+"="+value)};for(var key in params)print(key,params[key]);return[name].concat(values).join("; ")}},Offers=function(){this._byName={},this._inOrder=[]};Offers.prototype.push=function(name,params){hasOwnProperty.call(this._byName,name)||(this._byName[name]=[]),this._byName[name].push(params),this._inOrder.push({name:name,params:params})},Offers.prototype.eachOffer=function(callback,context){for(var list=this._inOrder,i=0,n=list.length;i<n;i++)callback.call(context,list[i].name,list[i].params)},Offers.prototype.byName=function(name){return this._byName[name]||[]},Offers.prototype.toArray=function(){return this._inOrder.slice()},module.exports=Parser},N1ro:function(module,exports,__webpack_require__){"use strict";var Functor=__webpack_require__("Gfnk"),Pledge=__webpack_require__("+7ve"),Cell=function(tuple){this._ext=tuple[0],this._session=tuple[1],this._functors={incoming:new Functor(this._session,"processIncomingMessage"),outgoing:new Functor(this._session,"processOutgoingMessage")}};Cell.prototype.pending=function(direction){var functor=this._functors[direction];functor._stopped||(functor.pending+=1)},Cell.prototype.incoming=function(error,message,callback,context){this._exec("incoming",error,message,callback,context)},Cell.prototype.outgoing=function(error,message,callback,context){this._exec("outgoing",error,message,callback,context)},Cell.prototype.close=function(){return this._closed=this._closed||new Pledge,this._doClose(),this._closed},Cell.prototype._exec=function(direction,error,message,callback,context){this._functors[direction].call(error,message,function(err,msg){err&&(err.message=this._ext.name+": "+err.message),callback.call(context,err,msg),this._doClose()},this)},Cell.prototype._doClose=function(){var fin=this._functors.incoming,fout=this._functors.outgoing;this._closed&&fin.pending+fout.pending===0&&(this._session&&this._session.close(),this._session=null,this._closed.done())},module.exports=Cell},O1VW:function(module,exports,__webpack_require__){"use strict";var Buffer=__webpack_require__("hwdV").Buffer,Base=__webpack_require__("Wdmt"),Draft75=function(request,url,options){Base.apply(this,arguments),this._stage=0,this.version="hixie-75",this._headers.set("Upgrade","WebSocket"),this._headers.set("Connection","Upgrade"),this._headers.set("WebSocket-Origin",this._request.headers.origin),this._headers.set("WebSocket-Location",this.url)};__webpack_require__("jK02").inherits(Draft75,Base);var instance={close:function(){return 3!==this.readyState&&(this.readyState=3,this.emit("close",new Base.CloseEvent(null,null)),!0)},parse:function(chunk){this.readyState>1||(this._reader.put(chunk),this._reader.eachByte(function(octet){var message;switch(this._stage){case-1:this._body.push(octet),this._sendHandshakeBody();break;case 0:this._parseLeadingByte(octet);break;case 1:if(this._length=(127&octet)+128*this._length,this._closing&&0===this._length)return this.close();128!=(128&octet)&&(0===this._length?this._stage=0:(this._skipped=0,this._stage=2));break;case 2:if(255===octet)this._stage=0,message=Buffer.from(this._buffer).toString("utf8",0,this._buffer.length),this.emit("message",new Base.MessageEvent(message));else if(this._length)this._skipped+=1,this._skipped===this._length&&(this._stage=0);else if(this._buffer.push(octet),this._buffer.length>this._maxLength)return this.close()}},this))},frame:function(buffer){if(0===this.readyState)return this._queue([buffer]);if(this.readyState>1)return!1;"string"!=typeof buffer&&(buffer=buffer.toString());var length=Buffer.byteLength(buffer),frame=Buffer.allocUnsafe(length+2);return frame[0]=0,frame.write(buffer,1),frame[frame.length-1]=255,this._write(frame),!0},_handshakeResponse:function(){var headers=["HTTP/1.1 101 Web Socket Protocol Handshake",this._headers.toString(),""];return Buffer.from(headers.join("\r\n"),"utf8")},_parseLeadingByte:function(octet){128==(128&octet)?(this._length=0,this._stage=1):(delete this._length,delete this._skipped,this._buffer=[],this._stage=2)}};for(var key in instance)Draft75.prototype[key]=instance[key];module.exports=Draft75},ViYL:function(module,exports,__webpack_require__){"use strict";var util=__webpack_require__("jK02"),HttpParser=__webpack_require__("ziip"),Base=__webpack_require__("Wdmt"),Draft75=__webpack_require__("O1VW"),Draft76=__webpack_require__("HJXK"),Hybi=__webpack_require__("dt2+"),Server=function(options){Base.call(this,null,null,options),this._http=new HttpParser("request")};util.inherits(Server,Base);var instance={EVENTS:["open","message","error","close","ping","pong"],_bindEventListeners:function(){this.messages.on("error",function(){}),this.on("error",function(){})},parse:function(chunk){if(this._delegate)return this._delegate.parse(chunk);if(this._http.parse(chunk),this._http.isComplete()){this.method=this._http.method,this.url=this._http.url,this.headers=this._http.headers,this.body=this._http.body;var self=this;this._delegate=Server.http(this,this._options),this._delegate.messages=this.messages,this._delegate.io=this.io,this._open(),this.EVENTS.forEach(function(event){this._delegate.on(event,function(e){self.emit(event,e)})},this),this.protocol=this._delegate.protocol,this.version=this._delegate.version,this.parse(this._http.body),this.emit("connect",new Base.ConnectEvent)}},_open:function(){this.__queue.forEach(function(msg){this._delegate[msg[0]].apply(this._delegate,msg[1])},this),this.__queue=[]}};for(var key in["addExtension","setHeader","start","frame","text","binary","ping","close"].forEach(function(method){instance[method]=function(){return this._delegate?this._delegate[method].apply(this._delegate,arguments):(this.__queue.push([method,arguments]),!0)}}),instance)Server.prototype[key]=instance[key];Server.isSecureRequest=function(request){if(request.connection&&void 0!==request.connection.authorized)return!0;if(request.socket&&request.socket.secure)return!0;var headers=request.headers;return!!headers&&("on"===headers.https||("on"===headers["x-forwarded-ssl"]||("https"===headers["x-forwarded-scheme"]||"https"===headers["x-forwarded-proto"])))},Server.determineUrl=function(request){return(this.isSecureRequest(request)?"wss:":"ws:")+"//"+request.headers.host+request.url},Server.http=function(request,options){void 0===(options=options||{}).requireMasking&&(options.requireMasking=!0);var headers=request.headers,version=headers["sec-websocket-version"],key=headers["sec-websocket-key"],key1=headers["sec-websocket-key1"],key2=headers["sec-websocket-key2"],url=this.determineUrl(request);return version||key?new Hybi(request,url,options):key1||key2?new Draft76(request,url,options):new Draft75(request,url,options)},module.exports=Server},Wdmt:function(module,exports,__webpack_require__){"use strict";var Buffer=__webpack_require__("hwdV").Buffer,Emitter=__webpack_require__("/0p4").EventEmitter,util=__webpack_require__("jK02"),streams=__webpack_require__("u4G8"),Headers=__webpack_require__("q+85"),Reader=__webpack_require__("2nJ2"),Base=function(request,url,options){Emitter.call(this),Base.validateOptions(options||{},["maxLength","masking","requireMasking","protocols"]),this._request=request,this._reader=new Reader,this._options=options||{},this._maxLength=this._options.maxLength||this.MAX_LENGTH,this._headers=new Headers,this.__queue=[],this.readyState=0,this.url=url,this.io=new streams.IO(this),this.messages=new streams.Messages(this),this._bindEventListeners()};util.inherits(Base,Emitter),Base.isWebSocket=function(request){var connection=request.headers.connection||"",upgrade=request.headers.upgrade||"";return"GET"===request.method&&connection.toLowerCase().split(/ *, */).indexOf("upgrade")>=0&&"websocket"===upgrade.toLowerCase()},Base.validateOptions=function(options,validKeys){for(var key in options)if(validKeys.indexOf(key)<0)throw new Error("Unrecognized option: "+key)};var instance={MAX_LENGTH:67108863,STATES:["connecting","open","closing","closed"],_bindEventListeners:function(){var self=this;this.messages.on("error",function(){}),this.on("message",function(event){var messages=self.messages;messages.readable&&messages.emit("data",event.data)}),this.on("error",function(error){var messages=self.messages;messages.readable&&messages.emit("error",error)}),this.on("close",function(){var messages=self.messages;messages.readable&&(messages.readable=messages.writable=!1,messages.emit("end"))})},getState:function(){return this.STATES[this.readyState]||null},addExtension:function(extension){return!1},setHeader:function(name,value){return!(this.readyState>0)&&(this._headers.set(name,value),!0)},start:function(){if(0!==this.readyState)return!1;if(!Base.isWebSocket(this._request))return this._failHandshake(new Error("Not a WebSocket request"));var response;try{response=this._handshakeResponse()}catch(error){return this._failHandshake(error)}return this._write(response),-1!==this._stage&&this._open(),!0},_failHandshake:function(error){var headers=new Headers;return headers.set("Content-Type","text/plain"),headers.set("Content-Length",Buffer.byteLength(error.message,"utf8")),headers=["HTTP/1.1 400 Bad Request",headers.toString(),error.message],this._write(Buffer.from(headers.join("\r\n"),"utf8")),this._fail("protocol_error",error.message),!1},text:function(message){return this.frame(message)},binary:function(message){return!1},ping:function(){return!1},pong:function(){return!1},close:function(reason,code){return 1===this.readyState&&(this.readyState=3,this.emit("close",new Base.CloseEvent(null,null)),!0)},_open:function(){this.readyState=1,this.__queue.forEach(function(args){this.frame.apply(this,args)},this),this.__queue=[],this.emit("open",new Base.OpenEvent)},_queue:function(message){return this.__queue.push(message),!0},_write:function(chunk){var io=this.io;io.readable&&io.emit("data",chunk)},_fail:function(type,message){this.readyState=2,this.emit("error",new Error(message)),this.close()}};for(var key in instance)Base.prototype[key]=instance[key];Base.ConnectEvent=function(){},Base.OpenEvent=function(){},Base.CloseEvent=function(code,reason){this.code=code,this.reason=reason},Base.MessageEvent=function(data){this.data=data},Base.PingEvent=function(data){this.data=data},Base.PongEvent=function(data){this.data=data},module.exports=Base},Xsdi:function(module,exports,__webpack_require__){"use strict";var Buffer=__webpack_require__("hwdV").Buffer,Message=function(){this.rsv1=!1,this.rsv2=!1,this.rsv3=!1,this.opcode=null,this.length=0,this._chunks=[]},instance={read:function(){return this.data=this.data||Buffer.concat(this._chunks,this.length)},pushFrame:function(frame){this.rsv1=this.rsv1||frame.rsv1,this.rsv2=this.rsv2||frame.rsv2,this.rsv3=this.rsv3||frame.rsv3,null===this.opcode&&(this.opcode=frame.opcode),this._chunks.push(frame.payload),this.length+=frame.length}};for(var key in instance)Message.prototype[key]=instance[key];module.exports=Message},cKJ5:function(module,exports,__webpack_require__){var assert=__webpack_require__("Qs3B");function HTTPParser(type){assert.ok(type===HTTPParser.REQUEST||type===HTTPParser.RESPONSE||void 0===type),void 0===type||this.initialize(type)}exports.HTTPParser=HTTPParser,HTTPParser.prototype.initialize=function(type,async_resource){assert.ok(type===HTTPParser.REQUEST||type===HTTPParser.RESPONSE),this.type=type,this.state=type+"_LINE",this.info={headers:[],upgrade:!1},this.trailers=[],this.line="",this.isChunked=!1,this.connection="",this.headerSize=0,this.body_bytes=null,this.isUserCall=!1,this.hadError=!1},HTTPParser.encoding="ascii",HTTPParser.maxHeaderSize=81920,HTTPParser.REQUEST="REQUEST",HTTPParser.RESPONSE="RESPONSE";var kOnHeaders=HTTPParser.kOnHeaders=1,kOnHeadersComplete=HTTPParser.kOnHeadersComplete=2,kOnBody=HTTPParser.kOnBody=3,kOnMessageComplete=HTTPParser.kOnMessageComplete=4;HTTPParser.prototype[kOnHeaders]=HTTPParser.prototype[kOnHeadersComplete]=HTTPParser.prototype[kOnBody]=HTTPParser.prototype[kOnMessageComplete]=function(){};var compatMode0_12=!0;Object.defineProperty(HTTPParser,"kOnExecute",{get:function(){return compatMode0_12=!1,99}});var methods=exports.methods=HTTPParser.methods=["DELETE","GET","HEAD","POST","PUT","CONNECT","OPTIONS","TRACE","COPY","LOCK","MKCOL","MOVE","PROPFIND","PROPPATCH","SEARCH","UNLOCK","BIND","REBIND","UNBIND","ACL","REPORT","MKACTIVITY","CHECKOUT","MERGE","M-SEARCH","NOTIFY","SUBSCRIBE","UNSUBSCRIBE","PATCH","PURGE","MKCALENDAR","LINK","UNLINK"],method_connect=methods.indexOf("CONNECT");HTTPParser.prototype.reinitialize=HTTPParser,HTTPParser.prototype.close=HTTPParser.prototype.pause=HTTPParser.prototype.resume=HTTPParser.prototype.free=function(){},HTTPParser.prototype._compatMode0_11=!1,HTTPParser.prototype.getAsyncId=function(){return 0};var headerState={REQUEST_LINE:!0,RESPONSE_LINE:!0,HEADER:!0};HTTPParser.prototype.execute=function(chunk,start,length){if(!(this instanceof HTTPParser))throw new TypeError("not a HTTPParser");start=start||0,length="number"==typeof length?length:chunk.length,this.chunk=chunk,this.offset=start;var end=this.end=start+length;try{for(;this.offset<end&&!this[this.state](););}catch(err){if(this.isUserCall)throw err;return this.hadError=!0,err}return this.chunk=null,length=this.offset-start,headerState[this.state]&&(this.headerSize+=length,this.headerSize>HTTPParser.maxHeaderSize)?new Error("max header size exceeded"):length};var stateFinishAllowed={REQUEST_LINE:!0,RESPONSE_LINE:!0,BODY_RAW:!0};HTTPParser.prototype.finish=function(){if(!this.hadError)return stateFinishAllowed[this.state]?void("BODY_RAW"===this.state&&this.userCall()(this[kOnMessageComplete]())):new Error("invalid state for EOF")},HTTPParser.prototype.consume=HTTPParser.prototype.unconsume=HTTPParser.prototype.getCurrentBuffer=function(){},HTTPParser.prototype.userCall=function(){this.isUserCall=!0;var self=this;return function(ret){return self.isUserCall=!1,ret}},HTTPParser.prototype.nextRequest=function(){this.userCall()(this[kOnMessageComplete]()),this.reinitialize(this.type)},HTTPParser.prototype.consumeLine=function(){for(var end=this.end,chunk=this.chunk,i=this.offset;i<end;i++)if(10===chunk[i]){var line=this.line+chunk.toString(HTTPParser.encoding,this.offset,i);return"\r"===line.charAt(line.length-1)&&(line=line.substr(0,line.length-1)),this.line="",this.offset=i+1,line}this.line+=chunk.toString(HTTPParser.encoding,this.offset,this.end),this.offset=this.end};var headerExp=/^([^: \t]+):[ \t]*((?:.*[^ \t])|)/,headerContinueExp=/^[ \t]+(.*[^ \t])/;HTTPParser.prototype.parseHeader=function(line,headers){if(-1!==line.indexOf("\r"))throw parseErrorCode("HPE_LF_EXPECTED");var match=headerExp.exec(line),k=match&&match[1];if(k)headers.push(k),headers.push(match[2]);else{var matchContinue=headerContinueExp.exec(line);matchContinue&&headers.length&&(headers[headers.length-1]&&(headers[headers.length-1]+=" "),headers[headers.length-1]+=matchContinue[1])}};var requestExp=/^([A-Z-]+) ([^ ]+) HTTP\/(\d)\.(\d)$/;HTTPParser.prototype.REQUEST_LINE=function(){var line=this.consumeLine();if(line){var match=requestExp.exec(line);if(null===match)throw parseErrorCode("HPE_INVALID_CONSTANT");if(this.info.method=this._compatMode0_11?match[1]:methods.indexOf(match[1]),-1===this.info.method)throw new Error("invalid request method");this.info.url=match[2],this.info.versionMajor=+match[3],this.info.versionMinor=+match[4],this.body_bytes=0,this.state="HEADER"}};var responseExp=/^HTTP\/(\d)\.(\d) (\d{3}) ?(.*)$/;function parseErrorCode(code){var err=new Error("Parse Error");return err.code=code,err}HTTPParser.prototype.RESPONSE_LINE=function(){var line=this.consumeLine();if(line){var match=responseExp.exec(line);if(null===match)throw parseErrorCode("HPE_INVALID_CONSTANT");this.info.versionMajor=+match[1],this.info.versionMinor=+match[2];var statusCode=this.info.statusCode=+match[3];this.info.statusMessage=match[4],1!=(statusCode/100|0)&&204!==statusCode&&304!==statusCode||(this.body_bytes=0),this.state="HEADER"}},HTTPParser.prototype.shouldKeepAlive=function(){if(this.info.versionMajor>0&&this.info.versionMinor>0){if(-1!==this.connection.indexOf("close"))return!1}else if(-1===this.connection.indexOf("keep-alive"))return!1;return!(null===this.body_bytes&&!this.isChunked)},HTTPParser.prototype.HEADER=function(){var line=this.consumeLine();if(void 0!==line){var info=this.info;if(line)this.parseHeader(line,info.headers);else{for(var currentContentLengthValue,skipBody,headers=info.headers,hasContentLength=!1,hasUpgradeHeader=!1,i=0;i<headers.length;i+=2)switch(headers[i].toLowerCase()){case"transfer-encoding":this.isChunked="chunked"===headers[i+1].toLowerCase();break;case"content-length":if(currentContentLengthValue=+headers[i+1],hasContentLength){if(currentContentLengthValue!==this.body_bytes)throw parseErrorCode("HPE_UNEXPECTED_CONTENT_LENGTH")}else hasContentLength=!0,this.body_bytes=currentContentLengthValue;break;case"connection":this.connection+=headers[i+1].toLowerCase();break;case"upgrade":hasUpgradeHeader=!0}if(this.isChunked&&hasContentLength&&(hasContentLength=!1,this.body_bytes=null),hasUpgradeHeader&&-1!=this.connection.indexOf("upgrade")?info.upgrade=this.type===HTTPParser.REQUEST||101===info.statusCode:info.upgrade=info.method===method_connect,this.isChunked&&info.upgrade&&(this.isChunked=!1),info.shouldKeepAlive=this.shouldKeepAlive(),2===(skipBody=compatMode0_12?this.userCall()(this[kOnHeadersComplete](info)):this.userCall()(this[kOnHeadersComplete](info.versionMajor,info.versionMinor,info.headers,info.method,info.url,info.statusCode,info.statusMessage,info.upgrade,info.shouldKeepAlive))))return this.nextRequest(),!0;if(this.isChunked&&!skipBody)this.state="BODY_CHUNKHEAD";else{if(skipBody||0===this.body_bytes)return this.nextRequest(),info.upgrade;null===this.body_bytes?this.state="BODY_RAW":this.state="BODY_SIZED"}}}},HTTPParser.prototype.BODY_CHUNKHEAD=function(){var line=this.consumeLine();void 0!==line&&(this.body_bytes=parseInt(line,16),this.body_bytes?this.state="BODY_CHUNK":this.state="BODY_CHUNKTRAILERS")},HTTPParser.prototype.BODY_CHUNK=function(){var length=Math.min(this.end-this.offset,this.body_bytes);this.userCall()(this[kOnBody](this.chunk,this.offset,length)),this.offset+=length,this.body_bytes-=length,this.body_bytes||(this.state="BODY_CHUNKEMPTYLINE")},HTTPParser.prototype.BODY_CHUNKEMPTYLINE=function(){var line=this.consumeLine();void 0!==line&&(assert.equal(line,""),this.state="BODY_CHUNKHEAD")},HTTPParser.prototype.BODY_CHUNKTRAILERS=function(){var line=this.consumeLine();void 0!==line&&(line?this.parseHeader(line,this.trailers):(this.trailers.length&&this.userCall()(this[kOnHeaders](this.trailers,"")),this.nextRequest()))},HTTPParser.prototype.BODY_RAW=function(){var length=this.end-this.offset;this.userCall()(this[kOnBody](this.chunk,this.offset,length)),this.offset=this.end},HTTPParser.prototype.BODY_SIZED=function(){var length=Math.min(this.end-this.offset,this.body_bytes);this.userCall()(this[kOnBody](this.chunk,this.offset,length)),this.offset+=length,this.body_bytes-=length,this.body_bytes||this.nextRequest()},["Headers","HeadersComplete","Body","MessageComplete"].forEach(function(name){var k=HTTPParser["kOn"+name];Object.defineProperty(HTTPParser.prototype,"on"+name,{get:function(){return this[k]},set:function(to){return this._compatMode0_11=!0,method_connect="CONNECT",this[k]=to}})})},"dt2+":function(module,exports,__webpack_require__){"use strict";var Buffer=__webpack_require__("hwdV").Buffer,crypto=__webpack_require__("PJMN"),util=__webpack_require__("jK02"),Extensions=__webpack_require__("2SO9"),Base=__webpack_require__("Wdmt"),Frame=__webpack_require__("Ejeu"),Message=__webpack_require__("Xsdi"),Hybi=function(request,url,options){if(Base.apply(this,arguments),this._extensions=new Extensions,this._stage=0,this._masking=this._options.masking,this._protocols=this._options.protocols||[],this._requireMasking=this._options.requireMasking,this._pingCallbacks={},"string"==typeof this._protocols&&(this._protocols=this._protocols.split(/ *, */)),this._request){var protos=this._request.headers["sec-websocket-protocol"],supported=this._protocols;void 0!==protos&&("string"==typeof protos&&(protos=protos.split(/ *, */)),this.protocol=protos.filter(function(p){return supported.indexOf(p)>=0})[0]),this.version="hybi-"+Hybi.VERSION}};util.inherits(Hybi,Base),Hybi.VERSION="13",Hybi.mask=function(payload,mask,offset){if(!mask||0===mask.length)return payload;offset=offset||0;for(var i=0,n=payload.length-offset;i<n;i++)payload[offset+i]=payload[offset+i]^mask[i%4];return payload},Hybi.generateAccept=function(key){var sha1=crypto.createHash("sha1");return sha1.update(key+Hybi.GUID),sha1.digest("base64")},Hybi.GUID="258EAFA5-E914-47DA-95CA-C5AB0DC85B11";var instance={FIN:128,MASK:128,RSV1:64,RSV2:32,RSV3:16,OPCODE:15,LENGTH:127,OPCODES:{continuation:0,text:1,binary:2,close:8,ping:9,pong:10},OPCODE_CODES:[0,1,2,8,9,10],MESSAGE_OPCODES:[0,1,2],OPENING_OPCODES:[1,2],ERRORS:{normal_closure:1e3,going_away:1001,protocol_error:1002,unacceptable:1003,encoding_error:1007,policy_violation:1008,too_large:1009,extension_error:1010,unexpected_condition:1011},ERROR_CODES:[1e3,1001,1002,1003,1007,1008,1009,1010,1011],DEFAULT_ERROR_CODE:1e3,MIN_RESERVED_ERROR:3e3,MAX_RESERVED_ERROR:4999,UTF8_MATCH:/^([\x00-\x7F]|[\xC2-\xDF][\x80-\xBF]|\xE0[\xA0-\xBF][\x80-\xBF]|[\xE1-\xEC\xEE\xEF][\x80-\xBF]{2}|\xED[\x80-\x9F][\x80-\xBF]|\xF0[\x90-\xBF][\x80-\xBF]{2}|[\xF1-\xF3][\x80-\xBF]{3}|\xF4[\x80-\x8F][\x80-\xBF]{2})*$/,addExtension:function(extension){return this._extensions.add(extension),!0},parse:function(chunk){this._reader.put(chunk);for(var buffer=!0;buffer;)switch(this._stage){case 0:(buffer=this._reader.read(1))&&this._parseOpcode(buffer[0]);break;case 1:(buffer=this._reader.read(1))&&this._parseLength(buffer[0]);break;case 2:(buffer=this._reader.read(this._frame.lengthBytes))&&this._parseExtendedLength(buffer);break;case 3:(buffer=this._reader.read(4))&&(this._stage=4,this._frame.maskingKey=buffer);break;case 4:(buffer=this._reader.read(this._frame.length))&&(this._stage=0,this._emitFrame(buffer));break;default:buffer=null}},text:function(message){return!(this.readyState>1)&&this.frame(message,"text")},binary:function(message){return!(this.readyState>1)&&this.frame(message,"binary")},ping:function(message,callback){return!(this.readyState>1)&&(message=message||"",callback&&(this._pingCallbacks[message]=callback),this.frame(message,"ping"))},pong:function(message){return!(this.readyState>1)&&(message=message||"",this.frame(message,"pong"))},close:function(reason,code){return reason=reason||"",code=code||this.ERRORS.normal_closure,this.readyState<=0?(this.readyState=3,this.emit("close",new Base.CloseEvent(code,reason)),!0):1===this.readyState&&(this.readyState=2,this._extensions.close(function(){this.frame(reason,"close",code)},this),!0)},frame:function(buffer,type,code){if(this.readyState<=0)return this._queue([buffer,type,code]);if(this.readyState>2)return!1;buffer instanceof Array&&(buffer=Buffer.from(buffer)),"number"==typeof buffer&&(buffer=buffer.toString());var payload,copy,message=new Message,isText="string"==typeof buffer;message.rsv1=message.rsv2=message.rsv3=!1,message.opcode=this.OPCODES[type||(isText?"text":"binary")],payload=isText?Buffer.from(buffer,"utf8"):buffer,code&&(copy=payload,(payload=Buffer.allocUnsafe(2+copy.length)).writeUInt16BE(code,0),copy.copy(payload,2)),message.data=payload;var onMessageReady=function(message){var frame=new Frame;frame.final=!0,frame.rsv1=message.rsv1,frame.rsv2=message.rsv2,frame.rsv3=message.rsv3,frame.opcode=message.opcode,frame.masked=!!this._masking,frame.length=message.data.length,frame.payload=message.data,frame.masked&&(frame.maskingKey=crypto.randomBytes(4)),this._sendFrame(frame)};return this.MESSAGE_OPCODES.indexOf(message.opcode)>=0?this._extensions.processOutgoingMessage(message,function(error,message){if(error)return this._fail("extension_error",error.message);onMessageReady.call(this,message)},this):onMessageReady.call(this,message),!0},_sendFrame:function(frame){var length=frame.length,header=length<=125?2:length<=65535?4:10,offset=header+(frame.masked?4:0),buffer=Buffer.allocUnsafe(offset+length),masked=frame.masked?this.MASK:0;buffer[0]=(frame.final?this.FIN:0)|(frame.rsv1?this.RSV1:0)|(frame.rsv2?this.RSV2:0)|(frame.rsv3?this.RSV3:0)|frame.opcode,length<=125?buffer[1]=masked|length:length<=65535?(buffer[1]=126|masked,buffer.writeUInt16BE(length,2)):(buffer[1]=127|masked,buffer.writeUInt32BE(Math.floor(length/4294967296),2),buffer.writeUInt32BE(length%4294967296,6)),frame.payload.copy(buffer,offset),frame.masked&&(frame.maskingKey.copy(buffer,header),Hybi.mask(buffer,frame.maskingKey,offset)),this._write(buffer)},_handshakeResponse:function(){var secKey=this._request.headers["sec-websocket-key"],version=this._request.headers["sec-websocket-version"];if(version!==Hybi.VERSION)throw new Error("Unsupported WebSocket version: "+version);if("string"!=typeof secKey)throw new Error("Missing handshake request header: Sec-WebSocket-Key");this._headers.set("Upgrade","websocket"),this._headers.set("Connection","Upgrade"),this._headers.set("Sec-WebSocket-Accept",Hybi.generateAccept(secKey)),this.protocol&&this._headers.set("Sec-WebSocket-Protocol",this.protocol);var extensions=this._extensions.generateResponse(this._request.headers["sec-websocket-extensions"]);extensions&&this._headers.set("Sec-WebSocket-Extensions",extensions);var headers=["HTTP/1.1 101 Switching Protocols",this._headers.toString(),""];return Buffer.from(headers.join("\r\n"),"utf8")},_shutdown:function(code,reason,error){delete this._frame,delete this._message,this._stage=5;var sendCloseFrame=1===this.readyState;this.readyState=2,this._extensions.close(function(){sendCloseFrame&&this.frame(reason,"close",code),this.readyState=3,error&&this.emit("error",new Error(reason)),this.emit("close",new Base.CloseEvent(code,reason))},this)},_fail:function(type,message){this.readyState>1||this._shutdown(this.ERRORS[type],message,!0)},_parseOpcode:function(octet){var rsvs=[this.RSV1,this.RSV2,this.RSV3].map(function(rsv){return(octet&rsv)===rsv}),frame=this._frame=new Frame;return frame.final=(octet&this.FIN)===this.FIN,frame.rsv1=rsvs[0],frame.rsv2=rsvs[1],frame.rsv3=rsvs[2],frame.opcode=octet&this.OPCODE,this._stage=1,this._extensions.validFrameRsv(frame)?this.OPCODE_CODES.indexOf(frame.opcode)<0?this._fail("protocol_error","Unrecognized frame opcode: "+frame.opcode):this.MESSAGE_OPCODES.indexOf(frame.opcode)<0&&!frame.final?this._fail("protocol_error","Received fragmented control frame: opcode = "+frame.opcode):this._message&&this.OPENING_OPCODES.indexOf(frame.opcode)>=0?this._fail("protocol_error","Received new data frame but previous continuous frame is unfinished"):void 0:this._fail("protocol_error","One or more reserved bits are on: reserved1 = "+(frame.rsv1?1:0)+", reserved2 = "+(frame.rsv2?1:0)+", reserved3 = "+(frame.rsv3?1:0))},_parseLength:function(octet){var frame=this._frame;if(frame.masked=(octet&this.MASK)===this.MASK,frame.length=octet&this.LENGTH,frame.length>=0&&frame.length<=125){if(this._stage=frame.masked?3:4,!this._checkFrameLength())return}else this._stage=2,frame.lengthBytes=126===frame.length?2:8;if(this._requireMasking&&!frame.masked)return this._fail("unacceptable","Received unmasked frame but masking is required")},_parseExtendedLength:function(buffer){var frame=this._frame;if(frame.length=this._readUInt(buffer),this._stage=frame.masked?3:4,this.MESSAGE_OPCODES.indexOf(frame.opcode)<0&&frame.length>125)return this._fail("protocol_error","Received control frame having too long payload: "+frame.length);this._checkFrameLength()},_checkFrameLength:function(){return!((this._message?this._message.length:0)+this._frame.length>this._maxLength)||(this._fail("too_large","WebSocket frame length too large"),!1)},_emitFrame:function(buffer){var message,code,reason,callbacks,callback,frame=this._frame,payload=frame.payload=Hybi.mask(buffer,frame.maskingKey),opcode=frame.opcode;if(delete this._frame,opcode===this.OPCODES.continuation){if(!this._message)return this._fail("protocol_error","Received unexpected continuation frame");this._message.pushFrame(frame)}if(opcode!==this.OPCODES.text&&opcode!==this.OPCODES.binary||(this._message=new Message,this._message.pushFrame(frame)),frame.final&&this.MESSAGE_OPCODES.indexOf(opcode)>=0)return this._emitMessage(this._message);opcode===this.OPCODES.close&&(code=payload.length>=2?payload.readUInt16BE(0):null,reason=payload.length>2?this._encode(payload.slice(2)):null,0!==payload.length&&!(null!==code&&code>=this.MIN_RESERVED_ERROR&&code<=this.MAX_RESERVED_ERROR)&&this.ERROR_CODES.indexOf(code)<0&&(code=this.ERRORS.protocol_error),(payload.length>125||payload.length>2&&!reason)&&(code=this.ERRORS.protocol_error),this._shutdown(code||this.DEFAULT_ERROR_CODE,reason||"")),opcode===this.OPCODES.ping&&(this.frame(payload,"pong"),this.emit("ping",new Base.PingEvent(payload.toString()))),opcode===this.OPCODES.pong&&(callback=(callbacks=this._pingCallbacks)[message=this._encode(payload)],delete callbacks[message],callback&&callback(),this.emit("pong",new Base.PongEvent(payload.toString())))},_emitMessage:function(message){(message=this._message).read(),delete this._message,this._extensions.processIncomingMessage(message,function(error,message){if(error)return this._fail("extension_error",error.message);var payload=message.data;if(message.opcode===this.OPCODES.text&&(payload=this._encode(payload)),null===payload)return this._fail("encoding_error","Could not decode a text frame as UTF-8");this.emit("message",new Base.MessageEvent(payload))},this)},_encode:function(buffer){try{var string=buffer.toString("binary",0,buffer.length);if(!this.UTF8_MATCH.test(string))return null}catch(e){}return buffer.toString("utf8",0,buffer.length)},_readUInt:function(buffer){return 2===buffer.length?buffer.readUInt16BE(0):4294967296*buffer.readUInt32BE(0)+buffer.readUInt32BE(4)}};for(var key in instance)Hybi.prototype[key]=instance[key];module.exports=Hybi},pu1m:function(module,exports,__webpack_require__){"use strict";var util=__webpack_require__("jK02"),net=__webpack_require__("Qs2e"),tls=__webpack_require__("ugmf"),url=__webpack_require__("bzos"),driver=__webpack_require__("qf7z"),API=__webpack_require__("2RBK"),DEFAULT_PORTS=(__webpack_require__("AhIK"),{"http:":80,"https:":443,"ws:":80,"wss:":443}),SECURE_PROTOCOLS=["https:","wss:"],Client=function(_url,protocols,options){options=options||{},this.url=_url,this._driver=driver.client(this.url,{maxLength:options.maxLength,protocols:protocols}),["open","error"].forEach(function(event){this._driver.on(event,function(){self.headers=self._driver.headers,self.statusCode=self._driver.statusCode})},this);var proxy=options.proxy||{},endpoint=url.parse(proxy.origin||this.url),port=endpoint.port||DEFAULT_PORTS[endpoint.protocol],secure=SECURE_PROTOCOLS.indexOf(endpoint.protocol)>=0,onConnect=function(){self._onConnect()},netOptions=options.net||{},originTLS=options.tls||{},socketTLS=proxy.origin?proxy.tls||{}:originTLS,self=this;netOptions.host=socketTLS.host=endpoint.hostname,netOptions.port=socketTLS.port=port,originTLS.ca=originTLS.ca||options.ca,socketTLS.servername=socketTLS.servername||endpoint.hostname,this._stream=secure?tls.connect(socketTLS,onConnect):net.connect(netOptions,onConnect),proxy.origin&&this._configureProxy(proxy,originTLS),API.call(this,options)};util.inherits(Client,API),Client.prototype._onConnect=function(){(this._proxy||this._driver).start()},Client.prototype._configureProxy=function(proxy,originTLS){var name,uri=url.parse(this.url),secure=SECURE_PROTOCOLS.indexOf(uri.protocol)>=0,self=this;if(this._proxy=this._driver.proxy(proxy.origin),proxy.headers)for(name in proxy.headers)this._proxy.setHeader(name,proxy.headers[name]);this._proxy.pipe(this._stream,{end:!1}),this._stream.pipe(this._proxy),this._proxy.on("connect",function(){if(secure){var options={socket:self._stream,servername:uri.hostname};for(name in originTLS)options[name]=originTLS[name];self._stream=tls.connect(options),self._configureStream()}self._driver.io.pipe(self._stream),self._stream.pipe(self._driver.io),self._driver.start()}),this._proxy.on("error",function(error){self._driver.emit("error",error)})},module.exports=Client},"q+85":function(module,exports,__webpack_require__){"use strict";var Headers=function(){this.clear()};Headers.prototype.ALLOWED_DUPLICATES=["set-cookie","set-cookie2","warning","www-authenticate"],Headers.prototype.clear=function(){this._sent={},this._lines=[]},Headers.prototype.set=function(name,value){if(void 0!==value){name=this._strip(name),value=this._strip(value);var key=name.toLowerCase();(!this._sent.hasOwnProperty(key)||this.ALLOWED_DUPLICATES.indexOf(key)>=0)&&(this._sent[key]=!0,this._lines.push(name+": "+value+"\r\n"))}},Headers.prototype.toString=function(){return this._lines.join("")},Headers.prototype._strip=function(string){return string.toString().replace(/^ */,"").replace(/ *$/,"")},module.exports=Headers},qf7z:function(module,exports,__webpack_require__){"use strict";var Base=__webpack_require__("Wdmt"),Client=__webpack_require__("AzCm"),Server=__webpack_require__("ViYL"),Driver={client:function(url,options){return void 0===(options=options||{}).masking&&(options.masking=!0),new Client(url,options)},server:function(options){return void 0===(options=options||{}).requireMasking&&(options.requireMasking=!0),new Server(options)},http:function(){return Server.http.apply(Server,arguments)},isSecureRequest:function(request){return Server.isSecureRequest(request)},isWebSocket:function(request){return Base.isWebSocket(request)},validateOptions:function(options,validKeys){Base.validateOptions(options,validKeys)}};module.exports=Driver},qlMm:function(module,exports,__webpack_require__){"use strict";var util=__webpack_require__("jK02"),driver=__webpack_require__("qf7z"),API=__webpack_require__("2RBK"),WebSocket=function(request,socket,body,protocols,options){options=options||{},this._stream=socket,this._driver=driver.http(request,{maxLength:options.maxLength,protocols:protocols});var self=this;if(this._stream&&this._stream.writable){if(!this._stream.readable)return this._stream.end();var catchup=function(){self._stream.removeListener("data",catchup)};this._stream.on("data",catchup),API.call(this,options),process.nextTick(function(){self._driver.start(),self._driver.io.write(body)})}};util.inherits(WebSocket,API),WebSocket.isWebSocket=function(request){return driver.isWebSocket(request)},WebSocket.validateOptions=function(options,validKeys){driver.validateOptions(options,validKeys)},WebSocket.WebSocket=WebSocket,WebSocket.Client=__webpack_require__("pu1m"),WebSocket.EventSource=__webpack_require__("7X3U"),module.exports=WebSocket},rjtV:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var component=__webpack_require__("S+S0"),util=__webpack_require__("Jv5v"),fayeWebsocket=__webpack_require__("qlMm"),tslib=__webpack_require__("zOht"),logger$1=__webpack_require__("NcST"),SDK_VERSION="";function setSDKVersion(version){SDK_VERSION=version}var id,DOMStorageWrapper=function(){function DOMStorageWrapper(domStorage_){this.domStorage_=domStorage_,this.prefix_="firebase:"}return DOMStorageWrapper.prototype.set=function(key,value){null==value?this.domStorage_.removeItem(this.prefixedName_(key)):this.domStorage_.setItem(this.prefixedName_(key),util.stringify(value))},DOMStorageWrapper.prototype.get=function(key){var storedVal=this.domStorage_.getItem(this.prefixedName_(key));return null==storedVal?null:util.jsonEval(storedVal)},DOMStorageWrapper.prototype.remove=function(key){this.domStorage_.removeItem(this.prefixedName_(key))},DOMStorageWrapper.prototype.prefixedName_=function(name){return this.prefix_+name},DOMStorageWrapper.prototype.toString=function(){return this.domStorage_.toString()},DOMStorageWrapper}(),MemoryStorage=function(){function MemoryStorage(){this.cache_={},this.isInMemoryStorage=!0}return MemoryStorage.prototype.set=function(key,value){null==value?delete this.cache_[key]:this.cache_[key]=value},MemoryStorage.prototype.get=function(key){return util.contains(this.cache_,key)?this.cache_[key]:null},MemoryStorage.prototype.remove=function(key){delete this.cache_[key]},MemoryStorage}(),createStoragefor=function(domStorageName){try{if("undefined"!=typeof window&&void 0!==window[domStorageName]){var domStorage=window[domStorageName];return domStorage.setItem("firebase:sentinel","cache"),domStorage.removeItem("firebase:sentinel"),new DOMStorageWrapper(domStorage)}}catch(e){}return new MemoryStorage},PersistentStorage=createStoragefor("localStorage"),SessionStorage=createStoragefor("sessionStorage"),logClient=new logger$1.Logger("@firebase/database"),LUIDGenerator=(id=1,function(){return id++}),sha1=function(str){var utf8Bytes=util.stringToByteArray(str),sha1=new util.Sha1;sha1.update(utf8Bytes);var sha1Bytes=sha1.digest();return util.base64.encodeByteArray(sha1Bytes)},buildLogMessage_=function(){for(var varArgs=[],_i=0;_i<arguments.length;_i++)varArgs[_i]=arguments[_i];for(var message="",i=0;i<varArgs.length;i++){var arg=varArgs[i];Array.isArray(arg)||arg&&"object"==typeof arg&&"number"==typeof arg.length?message+=buildLogMessage_.apply(null,arg):message+="object"==typeof arg?util.stringify(arg):arg,message+=" "}return message},logger=null,firstLog_=!0,enableLogging$1=function(logger_,persistent){util.assert(!persistent||!0===logger_||!1===logger_,"Can't turn on custom loggers persistently."),!0===logger_?(logClient.logLevel=logger$1.LogLevel.VERBOSE,logger=logClient.log.bind(logClient),persistent&&SessionStorage.set("logging_enabled",!0)):"function"==typeof logger_?logger=logger_:(logger=null,SessionStorage.remove("logging_enabled"))},log=function(){for(var varArgs=[],_i=0;_i<arguments.length;_i++)varArgs[_i]=arguments[_i];if(!0===firstLog_&&(firstLog_=!1,null===logger&&!0===SessionStorage.get("logging_enabled")&&enableLogging$1(!0)),logger){var message=buildLogMessage_.apply(null,varArgs);logger(message)}},logWrapper=function(prefix){return function(){for(var varArgs=[],_i=0;_i<arguments.length;_i++)varArgs[_i]=arguments[_i];log.apply(void 0,tslib.__spreadArray([prefix],tslib.__read(varArgs)))}},error=function(){for(var varArgs=[],_i=0;_i<arguments.length;_i++)varArgs[_i]=arguments[_i];var message="FIREBASE INTERNAL ERROR: "+buildLogMessage_.apply(void 0,tslib.__spreadArray([],tslib.__read(varArgs)));logClient.error(message)},fatal=function(){for(var varArgs=[],_i=0;_i<arguments.length;_i++)varArgs[_i]=arguments[_i];var message="FIREBASE FATAL ERROR: "+buildLogMessage_.apply(void 0,tslib.__spreadArray([],tslib.__read(varArgs)));throw logClient.error(message),new Error(message)},warn=function(){for(var varArgs=[],_i=0;_i<arguments.length;_i++)varArgs[_i]=arguments[_i];var message="FIREBASE WARNING: "+buildLogMessage_.apply(void 0,tslib.__spreadArray([],tslib.__read(varArgs)));logClient.warn(message)},isInvalidJSONNumber=function(data){return"number"==typeof data&&(data!=data||data===Number.POSITIVE_INFINITY||data===Number.NEGATIVE_INFINITY)},MIN_NAME="[MIN_NAME]",MAX_NAME="[MAX_NAME]",nameCompare=function(a,b){if(a===b)return 0;if(a===MIN_NAME||b===MAX_NAME)return-1;if(b===MIN_NAME||a===MAX_NAME)return 1;var aAsInt=tryParseInt(a),bAsInt=tryParseInt(b);return null!==aAsInt?null!==bAsInt?aAsInt-bAsInt==0?a.length-b.length:aAsInt-bAsInt:-1:null!==bAsInt?1:a<b?-1:1},stringCompare=function(a,b){return a===b?0:a<b?-1:1},requireKey=function(key,obj){if(obj&&key in obj)return obj[key];throw new Error("Missing required key ("+key+") in object: "+util.stringify(obj))},ObjectToUniqueKey=function(obj){if("object"!=typeof obj||null===obj)return util.stringify(obj);var keys=[];for(var k in obj)keys.push(k);keys.sort();for(var key="{",i=0;i<keys.length;i++)0!==i&&(key+=","),key+=util.stringify(keys[i]),key+=":",key+=ObjectToUniqueKey(obj[keys[i]]);return key+="}"},splitStringBySize=function(str,segsize){var len=str.length;if(len<=segsize)return[str];for(var dataSegs=[],c=0;c<len;c+=segsize)c+segsize>len?dataSegs.push(str.substring(c,len)):dataSegs.push(str.substring(c,c+segsize));return dataSegs};function each(obj,fn){for(var key in obj)obj.hasOwnProperty(key)&&fn(key,obj[key])}var doubleToIEEE754String=function(v){util.assert(!isInvalidJSONNumber(v),"Invalid JSON number");var s,e,f,ln,i;0===v?(e=0,f=0,s=1/v==-1/0?1:0):(s=v<0,(v=Math.abs(v))>=Math.pow(2,-1022)?(e=(ln=Math.min(Math.floor(Math.log(v)/Math.LN2),1023))+1023,f=Math.round(v*Math.pow(2,52-ln)-Math.pow(2,52))):(e=0,f=Math.round(v/Math.pow(2,-1074))));var bits=[];for(i=52;i;i-=1)bits.push(f%2?1:0),f=Math.floor(f/2);for(i=11;i;i-=1)bits.push(e%2?1:0),e=Math.floor(e/2);bits.push(s?1:0),bits.reverse();var str=bits.join(""),hexByteString="";for(i=0;i<64;i+=8){var hexByte=parseInt(str.substr(i,8),2).toString(16);1===hexByte.length&&(hexByte="0"+hexByte),hexByteString+=hexByte}return hexByteString.toLowerCase()};var INTEGER_REGEXP_=new RegExp("^-?(0*)\\d{1,10}$"),tryParseInt=function(str){if(INTEGER_REGEXP_.test(str)){var intVal=Number(str);if(intVal>=-2147483648&&intVal<=2147483647)return intVal}return null},exceptionGuard=function(fn){try{fn()}catch(e){setTimeout(function(){var stack=e.stack||"";throw warn("Exception was thrown by user callback.",stack),e},Math.floor(0))}},setTimeoutNonBlocking=function(fn,time){var timeout=setTimeout(fn,time);return"object"==typeof timeout&&timeout.unref&&timeout.unref(),timeout},AppCheckTokenProvider=function(){function AppCheckTokenProvider(appName_,appCheckProvider){var _this=this;this.appName_=appName_,this.appCheckProvider=appCheckProvider,this.appCheck=null==appCheckProvider?void 0:appCheckProvider.getImmediate({optional:!0}),this.appCheck||null==appCheckProvider||appCheckProvider.get().then(function(appCheck){return _this.appCheck=appCheck})}return AppCheckTokenProvider.prototype.getToken=function(forceRefresh){var _this=this;return this.appCheck?this.appCheck.getToken(forceRefresh):new Promise(function(resolve,reject){setTimeout(function(){_this.appCheck?_this.getToken(forceRefresh).then(resolve,reject):resolve(null)},0)})},AppCheckTokenProvider.prototype.addTokenChangeListener=function(listener){var _a;null===(_a=this.appCheckProvider)||void 0===_a||_a.get().then(function(appCheck){return appCheck.addTokenListener(listener)})},AppCheckTokenProvider.prototype.notifyForInvalidToken=function(){warn('Provided AppCheck credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly.')},AppCheckTokenProvider}(),FirebaseAuthTokenProvider=function(){function FirebaseAuthTokenProvider(appName_,firebaseOptions_,authProvider_){var _this=this;this.appName_=appName_,this.firebaseOptions_=firebaseOptions_,this.authProvider_=authProvider_,this.auth_=null,this.auth_=authProvider_.getImmediate({optional:!0}),this.auth_||authProvider_.onInit(function(auth){return _this.auth_=auth})}return FirebaseAuthTokenProvider.prototype.getToken=function(forceRefresh){var _this=this;return this.auth_?this.auth_.getToken(forceRefresh).catch(function(error){return error&&"auth/token-not-initialized"===error.code?(log("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(error)}):new Promise(function(resolve,reject){setTimeout(function(){_this.auth_?_this.getToken(forceRefresh).then(resolve,reject):resolve(null)},0)})},FirebaseAuthTokenProvider.prototype.addTokenChangeListener=function(listener){this.auth_?this.auth_.addAuthTokenListener(listener):this.authProvider_.get().then(function(auth){return auth.addAuthTokenListener(listener)})},FirebaseAuthTokenProvider.prototype.removeTokenChangeListener=function(listener){this.authProvider_.get().then(function(auth){return auth.removeAuthTokenListener(listener)})},FirebaseAuthTokenProvider.prototype.notifyForInvalidToken=function(){var errorMessage='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?errorMessage+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?errorMessage+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':errorMessage+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',warn(errorMessage)},FirebaseAuthTokenProvider}(),EmulatorTokenProvider=function(){function EmulatorTokenProvider(accessToken){this.accessToken=accessToken}return EmulatorTokenProvider.prototype.getToken=function(forceRefresh){return Promise.resolve({accessToken:this.accessToken})},EmulatorTokenProvider.prototype.addTokenChangeListener=function(listener){listener(this.accessToken)},EmulatorTokenProvider.prototype.removeTokenChangeListener=function(listener){},EmulatorTokenProvider.prototype.notifyForInvalidToken=function(){},EmulatorTokenProvider.OWNER="owner",EmulatorTokenProvider}(),FORGE_DOMAIN_RE=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,RepoInfo=function(){function RepoInfo(host,secure,namespace,webSocketOnly,nodeAdmin,persistenceKey,includeNamespaceInQueryParams){void 0===nodeAdmin&&(nodeAdmin=!1),void 0===persistenceKey&&(persistenceKey=""),void 0===includeNamespaceInQueryParams&&(includeNamespaceInQueryParams=!1),this.secure=secure,this.namespace=namespace,this.webSocketOnly=webSocketOnly,this.nodeAdmin=nodeAdmin,this.persistenceKey=persistenceKey,this.includeNamespaceInQueryParams=includeNamespaceInQueryParams,this._host=host.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=PersistentStorage.get("host:"+host)||this._host}return RepoInfo.prototype.isCacheableHost=function(){return"s-"===this.internalHost.substr(0,2)},RepoInfo.prototype.isCustomHost=function(){return"firebaseio.com"!==this._domain&&"firebaseio-demo.com"!==this._domain},Object.defineProperty(RepoInfo.prototype,"host",{get:function(){return this._host},set:function(newHost){newHost!==this.internalHost&&(this.internalHost=newHost,this.isCacheableHost()&&PersistentStorage.set("host:"+this._host,this.internalHost))},enumerable:!1,configurable:!0}),RepoInfo.prototype.toString=function(){var str=this.toURLString();return this.persistenceKey&&(str+="<"+this.persistenceKey+">"),str},RepoInfo.prototype.toURLString=function(){var protocol=this.secure?"https://":"http://",query=this.includeNamespaceInQueryParams?"?ns="+this.namespace:"";return""+protocol+this.host+"/"+query},RepoInfo}();function repoInfoConnectionURL(repoInfo,type,params){var connURL;if(util.assert("string"==typeof type,"typeof type must == string"),util.assert("object"==typeof params,"typeof params must == object"),"websocket"===type)connURL=(repoInfo.secure?"wss://":"ws://")+repoInfo.internalHost+"/.ws?";else{if("long_polling"!==type)throw new Error("Unknown connection type: "+type);connURL=(repoInfo.secure?"https://":"http://")+repoInfo.internalHost+"/.lp?"}(function repoInfoNeedsQueryParam(repoInfo){return repoInfo.host!==repoInfo.internalHost||repoInfo.isCustomHost()||repoInfo.includeNamespaceInQueryParams})(repoInfo)&&(params.ns=repoInfo.namespace);var pairs=[];return each(params,function(key,value){pairs.push(key+"="+value)}),connURL+pairs.join("&")}var StatsCollection=function(){function StatsCollection(){this.counters_={}}return StatsCollection.prototype.incrementCounter=function(name,amount){void 0===amount&&(amount=1),util.contains(this.counters_,name)||(this.counters_[name]=0),this.counters_[name]+=amount},StatsCollection.prototype.get=function(){return util.deepCopy(this.counters_)},StatsCollection}(),collections={},reporters={};function statsManagerGetCollection(repoInfo){var hashString=repoInfo.toString();return collections[hashString]||(collections[hashString]=new StatsCollection),collections[hashString]}var PacketReceiver=function(){function PacketReceiver(onMessage_){this.onMessage_=onMessage_,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}return PacketReceiver.prototype.closeAfter=function(responseNum,callback){this.closeAfterResponse=responseNum,this.onClose=callback,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)},PacketReceiver.prototype.handleResponse=function(requestNum,data){var _this=this;this.pendingResponses[requestNum]=data;for(var _loop_1=function(){var toProcess=this_1.pendingResponses[this_1.currentResponseNum];delete this_1.pendingResponses[this_1.currentResponseNum];for(var _loop_2=function(i){toProcess[i]&&exceptionGuard(function(){_this.onMessage_(toProcess[i])})},i=0;i<toProcess.length;++i)_loop_2(i);if(this_1.currentResponseNum===this_1.closeAfterResponse)return this_1.onClose&&(this_1.onClose(),this_1.onClose=null),"break";this_1.currentResponseNum++},this_1=this;this.pendingResponses[this.currentResponseNum];){if("break"===_loop_1())break}},PacketReceiver}(),BrowserPollConnection=function(){function BrowserPollConnection(connId,repoInfo,applicationId,appCheckToken,authToken,transportSessionId,lastSessionId){var _this=this;this.connId=connId,this.repoInfo=repoInfo,this.applicationId=applicationId,this.appCheckToken=appCheckToken,this.authToken=authToken,this.transportSessionId=transportSessionId,this.lastSessionId=lastSessionId,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=logWrapper(connId),this.stats_=statsManagerGetCollection(repoInfo),this.urlFn=function(params){return _this.appCheckToken&&(params.ac=_this.appCheckToken),repoInfoConnectionURL(repoInfo,"long_polling",params)}}return BrowserPollConnection.prototype.open=function(onMessage,onDisconnect){var _this=this;this.curSegmentNum=0,this.onDisconnect_=onDisconnect,this.myPacketOrderer=new PacketReceiver(onMessage),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(function(){_this.log_("Timed out trying to connect."),_this.onClosed_(),_this.connectTimeoutTimer_=null},Math.floor(3e4)),function(fn){if(util.isNodeSdk()||"complete"===document.readyState)fn();else{var called_1=!1,wrappedFn_1=function(){document.body?called_1||(called_1=!0,fn()):setTimeout(wrappedFn_1,Math.floor(10))};document.addEventListener?(document.addEventListener("DOMContentLoaded",wrappedFn_1,!1),window.addEventListener("load",wrappedFn_1,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",function(){"complete"===document.readyState&&wrappedFn_1()}),window.attachEvent("onload",wrappedFn_1))}}(function(){if(!_this.isClosed_){_this.scriptTagHolder=new FirebaseIFrameScriptHolder(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];var _a=tslib.__read(args,5),command=_a[0],arg1=_a[1],arg2=_a[2];if(_a[3],_a[4],_this.incrementIncomingBytes_(args),_this.scriptTagHolder)if(_this.connectTimeoutTimer_&&(clearTimeout(_this.connectTimeoutTimer_),_this.connectTimeoutTimer_=null),_this.everConnected_=!0,"start"===command)_this.id=arg1,_this.password=arg2;else{if("close"!==command)throw new Error("Unrecognized command received: "+command);arg1?(_this.scriptTagHolder.sendNewPolls=!1,_this.myPacketOrderer.closeAfter(arg1,function(){_this.onClosed_()})):_this.onClosed_()}},function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];var _a=tslib.__read(args,2),pN=_a[0],data=_a[1];_this.incrementIncomingBytes_(args),_this.myPacketOrderer.handleResponse(pN,data)},function(){_this.onClosed_()},_this.urlFn);var urlParams={start:"t"};urlParams.ser=Math.floor(1e8*Math.random()),_this.scriptTagHolder.uniqueCallbackIdentifier&&(urlParams.cb=_this.scriptTagHolder.uniqueCallbackIdentifier),urlParams.v="5",_this.transportSessionId&&(urlParams.s=_this.transportSessionId),_this.lastSessionId&&(urlParams.ls=_this.lastSessionId),_this.applicationId&&(urlParams.p=_this.applicationId),_this.appCheckToken&&(urlParams.ac=_this.appCheckToken),"undefined"!=typeof location&&location.hostname&&FORGE_DOMAIN_RE.test(location.hostname)&&(urlParams.r="f");var connectURL=_this.urlFn(urlParams);_this.log_("Connecting via long-poll to "+connectURL),_this.scriptTagHolder.addTag(connectURL,function(){})}})},BrowserPollConnection.prototype.start=function(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)},BrowserPollConnection.forceAllow=function(){BrowserPollConnection.forceAllow_=!0},BrowserPollConnection.forceDisallow=function(){BrowserPollConnection.forceDisallow_=!0},BrowserPollConnection.isAvailable=function(){return!util.isNodeSdk()&&(!!BrowserPollConnection.forceAllow_||!(BrowserPollConnection.forceDisallow_||"undefined"==typeof document||null==document.createElement||"object"==typeof window&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href)||"object"==typeof Windows&&"object"==typeof Windows.UI))},BrowserPollConnection.prototype.markConnectionHealthy=function(){},BrowserPollConnection.prototype.shutdown_=function(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)},BrowserPollConnection.prototype.onClosed_=function(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))},BrowserPollConnection.prototype.close=function(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())},BrowserPollConnection.prototype.send=function(data){var dataStr=util.stringify(data);this.bytesSent+=dataStr.length,this.stats_.incrementCounter("bytes_sent",dataStr.length);for(var base64data=util.base64Encode(dataStr),dataSegs=splitStringBySize(base64data,1840),i=0;i<dataSegs.length;i++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,dataSegs.length,dataSegs[i]),this.curSegmentNum++},BrowserPollConnection.prototype.addDisconnectPingFrame=function(id,pw){if(!util.isNodeSdk()){this.myDisconnFrame=document.createElement("iframe");var urlParams={dframe:"t"};urlParams.id=id,urlParams.pw=pw,this.myDisconnFrame.src=this.urlFn(urlParams),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}},BrowserPollConnection.prototype.incrementIncomingBytes_=function(args){var bytesReceived=util.stringify(args).length;this.bytesReceived+=bytesReceived,this.stats_.incrementCounter("bytes_received",bytesReceived)},BrowserPollConnection}(),FirebaseIFrameScriptHolder=function(){function FirebaseIFrameScriptHolder(commandCB,onMessageCB,onDisconnect,urlFn){if(this.onDisconnect=onDisconnect,this.urlFn=urlFn,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(1e8*Math.random()),this.sendNewPolls=!0,util.isNodeSdk())this.commandCB=commandCB,this.onMessageCB=onMessageCB;else{this.uniqueCallbackIdentifier=LUIDGenerator(),window["pLPCommand"+this.uniqueCallbackIdentifier]=commandCB,window["pRTLPCB"+this.uniqueCallbackIdentifier]=onMessageCB,this.myIFrame=FirebaseIFrameScriptHolder.createIFrame_();var script="";if(this.myIFrame.src&&"javascript:"===this.myIFrame.src.substr(0,"javascript:".length))script='<script>document.domain="'+document.domain+'";<\/script>';var iframeContents="<html><body>"+script+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(iframeContents),this.myIFrame.doc.close()}catch(e){log("frame writing exception"),e.stack&&log(e.stack),log(e)}}}return FirebaseIFrameScriptHolder.createIFrame_=function(){var iframe=document.createElement("iframe");if(iframe.style.display="none",!document.body)throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";document.body.appendChild(iframe);try{iframe.contentWindow.document||log("No IE domain setting required")}catch(e){var domain=document.domain;iframe.src="javascript:void((function(){document.open();document.domain='"+domain+"';document.close();})())"}return iframe.contentDocument?iframe.doc=iframe.contentDocument:iframe.contentWindow?iframe.doc=iframe.contentWindow.document:iframe.document&&(iframe.doc=iframe.document),iframe},FirebaseIFrameScriptHolder.prototype.close=function(){var _this=this;this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.innerHTML="",setTimeout(function(){null!==_this.myIFrame&&(document.body.removeChild(_this.myIFrame),_this.myIFrame=null)},Math.floor(0)));var onDisconnect=this.onDisconnect;onDisconnect&&(this.onDisconnect=null,onDisconnect())},FirebaseIFrameScriptHolder.prototype.startLongPoll=function(id,pw){for(this.myID=id,this.myPW=pw,this.alive=!0;this.newRequest_(););},FirebaseIFrameScriptHolder.prototype.newRequest_=function(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;var urlParams={};urlParams.id=this.myID,urlParams.pw=this.myPW,urlParams.ser=this.currentSerial;for(var theURL=this.urlFn(urlParams),curDataString="",i=0;this.pendingSegs.length>0;){if(!(this.pendingSegs[0].d.length+30+curDataString.length<=1870))break;var theSeg=this.pendingSegs.shift();curDataString=curDataString+"&seg"+i+"="+theSeg.seg+"&ts"+i+"="+theSeg.ts+"&d"+i+"="+theSeg.d,i++}return theURL+=curDataString,this.addLongPollTag_(theURL,this.currentSerial),!0}return!1},FirebaseIFrameScriptHolder.prototype.enqueueSegment=function(segnum,totalsegs,data){this.pendingSegs.push({seg:segnum,ts:totalsegs,d:data}),this.alive&&this.newRequest_()},FirebaseIFrameScriptHolder.prototype.addLongPollTag_=function(url,serial){var _this=this;this.outstandingRequests.add(serial);var doNewRequest=function(){_this.outstandingRequests.delete(serial),_this.newRequest_()},keepaliveTimeout=setTimeout(doNewRequest,Math.floor(25e3));this.addTag(url,function(){clearTimeout(keepaliveTimeout),doNewRequest()})},FirebaseIFrameScriptHolder.prototype.addTag=function(url,loadCB){var _this=this;util.isNodeSdk()?this.doNodeLongPoll(url,loadCB):setTimeout(function(){try{if(!_this.sendNewPolls)return;var newScript_1=_this.myIFrame.doc.createElement("script");newScript_1.type="text/javascript",newScript_1.async=!0,newScript_1.src=url,newScript_1.onload=newScript_1.onreadystatechange=function(){var rstate=newScript_1.readyState;rstate&&"loaded"!==rstate&&"complete"!==rstate||(newScript_1.onload=newScript_1.onreadystatechange=null,newScript_1.parentNode&&newScript_1.parentNode.removeChild(newScript_1),loadCB())},newScript_1.onerror=function(){log("Long-poll script failed to load: "+url),_this.sendNewPolls=!1,_this.close()},_this.myIFrame.doc.body.appendChild(newScript_1)}catch(e){}},Math.floor(1))},FirebaseIFrameScriptHolder}(),WebSocketImpl=null;"undefined"!=typeof MozWebSocket?WebSocketImpl=MozWebSocket:"undefined"!=typeof WebSocket&&(WebSocketImpl=WebSocket);var WebSocketConnection=function(){function WebSocketConnection(connId,repoInfo,applicationId,appCheckToken,authToken,transportSessionId,lastSessionId){this.connId=connId,this.applicationId=applicationId,this.appCheckToken=appCheckToken,this.authToken=authToken,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=logWrapper(this.connId),this.stats_=statsManagerGetCollection(repoInfo),this.connURL=WebSocketConnection.connectionURL_(repoInfo,transportSessionId,lastSessionId,appCheckToken),this.nodeAdmin=repoInfo.nodeAdmin}return WebSocketConnection.connectionURL_=function(repoInfo,transportSessionId,lastSessionId,appCheckToken){var urlParams={v:"5"};return!util.isNodeSdk()&&"undefined"!=typeof location&&location.hostname&&FORGE_DOMAIN_RE.test(location.hostname)&&(urlParams.r="f"),transportSessionId&&(urlParams.s=transportSessionId),lastSessionId&&(urlParams.ls=lastSessionId),appCheckToken&&(urlParams.ac=appCheckToken),repoInfoConnectionURL(repoInfo,"websocket",urlParams)},WebSocketConnection.prototype.open=function(onMessage,onDisconnect){var _this=this;this.onDisconnect=onDisconnect,this.onMessage=onMessage,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,PersistentStorage.set("previous_websocket_failure",!0);try{if(util.isNodeSdk()){var device=this.nodeAdmin?"AdminNode":"Node",options={headers:{"User-Agent":"Firebase/5/"+SDK_VERSION+"/"+process.platform+"/"+device,"X-Firebase-GMPID":this.applicationId||""}};this.authToken&&(options.headers.Authorization=this.authToken),this.appCheckToken&&(options.headers["X-Firebase-AppCheck"]=this.appCheckToken);var env=process.env,proxy=0===this.connURL.indexOf("wss://")?env.HTTPS_PROXY||env.https_proxy:env.HTTP_PROXY||env.http_proxy;proxy&&(options.proxy={origin:proxy}),this.mySock=new WebSocketImpl(this.connURL,[],options)}else{options={headers:{"X-Firebase-GMPID":this.applicationId||"","X-Firebase-AppCheck":this.appCheckToken||""}};this.mySock=new WebSocketImpl(this.connURL,[],options)}}catch(e){this.log_("Error instantiating WebSocket.");var error=e.message||e.data;return error&&this.log_(error),void this.onClosed_()}this.mySock.onopen=function(){_this.log_("Websocket connected."),_this.everConnected_=!0},this.mySock.onclose=function(){_this.log_("Websocket connection was disconnected."),_this.mySock=null,_this.onClosed_()},this.mySock.onmessage=function(m){_this.handleIncomingFrame(m)},this.mySock.onerror=function(e){_this.log_("WebSocket error.  Closing connection.");var error=e.message||e.data;error&&_this.log_(error),_this.onClosed_()}},WebSocketConnection.prototype.start=function(){},WebSocketConnection.forceDisallow=function(){WebSocketConnection.forceDisallow_=!0},WebSocketConnection.isAvailable=function(){var isOldAndroid=!1;if("undefined"!=typeof navigator&&navigator.userAgent){var oldAndroidMatch=navigator.userAgent.match(/Android ([0-9]{0,}\.[0-9]{0,})/);oldAndroidMatch&&oldAndroidMatch.length>1&&parseFloat(oldAndroidMatch[1])<4.4&&(isOldAndroid=!0)}return!isOldAndroid&&null!==WebSocketImpl&&!WebSocketConnection.forceDisallow_},WebSocketConnection.previouslyFailed=function(){return PersistentStorage.isInMemoryStorage||!0===PersistentStorage.get("previous_websocket_failure")},WebSocketConnection.prototype.markConnectionHealthy=function(){PersistentStorage.remove("previous_websocket_failure")},WebSocketConnection.prototype.appendFrame_=function(data){if(this.frames.push(data),this.frames.length===this.totalFrames){var fullMess=this.frames.join("");this.frames=null;var jsonMess=util.jsonEval(fullMess);this.onMessage(jsonMess)}},WebSocketConnection.prototype.handleNewFrameCount_=function(frameCount){this.totalFrames=frameCount,this.frames=[]},WebSocketConnection.prototype.extractFrameCount_=function(data){if(util.assert(null===this.frames,"We already have a frame buffer"),data.length<=6){var frameCount=Number(data);if(!isNaN(frameCount))return this.handleNewFrameCount_(frameCount),null}return this.handleNewFrameCount_(1),data},WebSocketConnection.prototype.handleIncomingFrame=function(mess){if(null!==this.mySock){var data=mess.data;if(this.bytesReceived+=data.length,this.stats_.incrementCounter("bytes_received",data.length),this.resetKeepAlive(),null!==this.frames)this.appendFrame_(data);else{var remainingData=this.extractFrameCount_(data);null!==remainingData&&this.appendFrame_(remainingData)}}},WebSocketConnection.prototype.send=function(data){this.resetKeepAlive();var dataStr=util.stringify(data);this.bytesSent+=dataStr.length,this.stats_.incrementCounter("bytes_sent",dataStr.length);var dataSegs=splitStringBySize(dataStr,16384);dataSegs.length>1&&this.sendString_(String(dataSegs.length));for(var i=0;i<dataSegs.length;i++)this.sendString_(dataSegs[i])},WebSocketConnection.prototype.shutdown_=function(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)},WebSocketConnection.prototype.onClosed_=function(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))},WebSocketConnection.prototype.close=function(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())},WebSocketConnection.prototype.resetKeepAlive=function(){var _this=this;clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(function(){_this.mySock&&_this.sendString_("0"),_this.resetKeepAlive()},Math.floor(45e3))},WebSocketConnection.prototype.sendString_=function(str){try{this.mySock.send(str)}catch(e){this.log_("Exception thrown from WebSocket.send():",e.message||e.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}},WebSocketConnection.responsesRequiredToBeHealthy=2,WebSocketConnection.healthyTimeout=3e4,WebSocketConnection}(),TransportManager=function(){function TransportManager(repoInfo){this.initTransports_(repoInfo)}return Object.defineProperty(TransportManager,"ALL_TRANSPORTS",{get:function(){return[BrowserPollConnection,WebSocketConnection]},enumerable:!1,configurable:!0}),TransportManager.prototype.initTransports_=function(repoInfo){var e_1,_a,isWebSocketsAvailable=WebSocketConnection&&WebSocketConnection.isAvailable(),isSkipPollConnection=isWebSocketsAvailable&&!WebSocketConnection.previouslyFailed();if(repoInfo.webSocketOnly&&(isWebSocketsAvailable||warn("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),isSkipPollConnection=!0),isSkipPollConnection)this.transports_=[WebSocketConnection];else{var transports=this.transports_=[];try{for(var _b=tslib.__values(TransportManager.ALL_TRANSPORTS),_c=_b.next();!_c.done;_c=_b.next()){var transport=_c.value;transport&&transport.isAvailable()&&transports.push(transport)}}catch(e_1_1){e_1={error:e_1_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_1)throw e_1.error}}}},TransportManager.prototype.initialTransport=function(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")},TransportManager.prototype.upgradeTransport=function(){return this.transports_.length>1?this.transports_[1]:null},TransportManager}(),Connection=function(){function Connection(id,repoInfo_,applicationId_,appCheckToken_,authToken_,onMessage_,onReady_,onDisconnect_,onKill_,lastSessionId){this.id=id,this.repoInfo_=repoInfo_,this.applicationId_=applicationId_,this.appCheckToken_=appCheckToken_,this.authToken_=authToken_,this.onMessage_=onMessage_,this.onReady_=onReady_,this.onDisconnect_=onDisconnect_,this.onKill_=onKill_,this.lastSessionId=lastSessionId,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=logWrapper("c:"+this.id+":"),this.transportManager_=new TransportManager(repoInfo_),this.log_("Connection created"),this.start_()}return Connection.prototype.start_=function(){var _this=this,conn=this.transportManager_.initialTransport();this.conn_=new conn(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.lastSessionId),this.primaryResponsesRequired_=conn.responsesRequiredToBeHealthy||0;var onMessageReceived=this.connReceiver_(this.conn_),onConnectionLost=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(function(){_this.conn_&&_this.conn_.open(onMessageReceived,onConnectionLost)},Math.floor(0));var healthyTimeoutMS=conn.healthyTimeout||0;healthyTimeoutMS>0&&(this.healthyTimeout_=setTimeoutNonBlocking(function(){_this.healthyTimeout_=null,_this.isHealthy_||(_this.conn_&&_this.conn_.bytesReceived>102400?(_this.log_("Connection exceeded healthy timeout but has received "+_this.conn_.bytesReceived+" bytes.  Marking connection healthy."),_this.isHealthy_=!0,_this.conn_.markConnectionHealthy()):_this.conn_&&_this.conn_.bytesSent>10240?_this.log_("Connection exceeded healthy timeout but has sent "+_this.conn_.bytesSent+" bytes.  Leaving connection alive."):(_this.log_("Closing unhealthy connection after timeout."),_this.close()))},Math.floor(healthyTimeoutMS)))},Connection.prototype.nextTransportId_=function(){return"c:"+this.id+":"+this.connectionCount++},Connection.prototype.disconnReceiver_=function(conn){var _this=this;return function(everConnected){conn===_this.conn_?_this.onConnectionLost_(everConnected):conn===_this.secondaryConn_?(_this.log_("Secondary connection lost."),_this.onSecondaryConnectionLost_()):_this.log_("closing an old connection")}},Connection.prototype.connReceiver_=function(conn){var _this=this;return function(message){2!==_this.state_&&(conn===_this.rx_?_this.onPrimaryMessageReceived_(message):conn===_this.secondaryConn_?_this.onSecondaryMessageReceived_(message):_this.log_("message on old connection"))}},Connection.prototype.sendRequest=function(dataMsg){var msg={t:"d",d:dataMsg};this.sendData_(msg)},Connection.prototype.tryCleanupConnection=function(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)},Connection.prototype.onSecondaryControl_=function(controlData){if("t"in controlData){var cmd=controlData.t;"a"===cmd?this.upgradeIfSecondaryHealthy_():"r"===cmd?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),this.tx_!==this.secondaryConn_&&this.rx_!==this.secondaryConn_||this.close()):"o"===cmd&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}},Connection.prototype.onSecondaryMessageReceived_=function(parsedData){var layer=requireKey("t",parsedData),data=requireKey("d",parsedData);if("c"===layer)this.onSecondaryControl_(data);else{if("d"!==layer)throw new Error("Unknown protocol layer: "+layer);this.pendingDataMessages.push(data)}},Connection.prototype.upgradeIfSecondaryHealthy_=function(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:"p",d:{}}}))},Connection.prototype.proceedWithUpgrade_=function(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:"a",d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:"n",d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()},Connection.prototype.onPrimaryMessageReceived_=function(parsedData){var layer=requireKey("t",parsedData),data=requireKey("d",parsedData);"c"===layer?this.onControl_(data):"d"===layer&&this.onDataMessage_(data)},Connection.prototype.onDataMessage_=function(message){this.onPrimaryResponse_(),this.onMessage_(message)},Connection.prototype.onPrimaryResponse_=function(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))},Connection.prototype.onControl_=function(controlData){var cmd=requireKey("t",controlData);if("d"in controlData){var payload=controlData.d;if("h"===cmd)this.onHandshake_(payload);else if("n"===cmd){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(var i=0;i<this.pendingDataMessages.length;++i)this.onDataMessage_(this.pendingDataMessages[i]);this.pendingDataMessages=[],this.tryCleanupConnection()}else"s"===cmd?this.onConnectionShutdown_(payload):"r"===cmd?this.onReset_(payload):"e"===cmd?error("Server Error: "+payload):"o"===cmd?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):error("Unknown control packet command: "+cmd)}},Connection.prototype.onHandshake_=function(handshake){var timestamp=handshake.ts,version=handshake.v,host=handshake.h;this.sessionId=handshake.s,this.repoInfo_.host=host,0===this.state_&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,timestamp),"5"!==version&&warn("Protocol version mismatch detected"),this.tryStartUpgrade_())},Connection.prototype.tryStartUpgrade_=function(){var conn=this.transportManager_.upgradeTransport();conn&&this.startUpgrade_(conn)},Connection.prototype.startUpgrade_=function(conn){var _this=this;this.secondaryConn_=new conn(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=conn.responsesRequiredToBeHealthy||0;var onMessage=this.connReceiver_(this.secondaryConn_),onDisconnect=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(onMessage,onDisconnect),setTimeoutNonBlocking(function(){_this.secondaryConn_&&(_this.log_("Timed out trying to upgrade."),_this.secondaryConn_.close())},Math.floor(6e4))},Connection.prototype.onReset_=function(host){this.log_("Reset packet received.  New host: "+host),this.repoInfo_.host=host,1===this.state_?this.close():(this.closeConnections_(),this.start_())},Connection.prototype.onConnectionEstablished_=function(conn,timestamp){var _this=this;this.log_("Realtime connection established."),this.conn_=conn,this.state_=1,this.onReady_&&(this.onReady_(timestamp,this.sessionId),this.onReady_=null),0===this.primaryResponsesRequired_?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):setTimeoutNonBlocking(function(){_this.sendPingOnPrimaryIfNecessary_()},Math.floor(5e3))},Connection.prototype.sendPingOnPrimaryIfNecessary_=function(){this.isHealthy_||1!==this.state_||(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:"p",d:{}}}))},Connection.prototype.onSecondaryConnectionLost_=function(){var conn=this.secondaryConn_;this.secondaryConn_=null,this.tx_!==conn&&this.rx_!==conn||this.close()},Connection.prototype.onConnectionLost_=function(everConnected){this.conn_=null,everConnected||0!==this.state_?1===this.state_&&this.log_("Realtime connection lost."):(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(PersistentStorage.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)),this.close()},Connection.prototype.onConnectionShutdown_=function(reason){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(reason),this.onKill_=null),this.onDisconnect_=null,this.close()},Connection.prototype.sendData_=function(data){if(1!==this.state_)throw"Connection is not connected";this.tx_.send(data)},Connection.prototype.close=function(){2!==this.state_&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))},Connection.prototype.closeConnections_=function(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)},Connection}(),ServerActions=function(){function ServerActions(){}return ServerActions.prototype.put=function(pathString,data,onComplete,hash){},ServerActions.prototype.merge=function(pathString,data,onComplete,hash){},ServerActions.prototype.refreshAuthToken=function(token){},ServerActions.prototype.refreshAppCheckToken=function(token){},ServerActions.prototype.onDisconnectPut=function(pathString,data,onComplete){},ServerActions.prototype.onDisconnectMerge=function(pathString,data,onComplete){},ServerActions.prototype.onDisconnectCancel=function(pathString,onComplete){},ServerActions.prototype.reportStats=function(stats){},ServerActions}(),EventEmitter=function(){function EventEmitter(allowedEvents_){this.allowedEvents_=allowedEvents_,this.listeners_={},util.assert(Array.isArray(allowedEvents_)&&allowedEvents_.length>0,"Requires a non-empty array")}return EventEmitter.prototype.trigger=function(eventType){for(var varArgs=[],_i=1;_i<arguments.length;_i++)varArgs[_i-1]=arguments[_i];if(Array.isArray(this.listeners_[eventType]))for(var listeners=tslib.__spreadArray([],tslib.__read(this.listeners_[eventType])),i=0;i<listeners.length;i++)listeners[i].callback.apply(listeners[i].context,varArgs)},EventEmitter.prototype.on=function(eventType,callback,context){this.validateEventType_(eventType),this.listeners_[eventType]=this.listeners_[eventType]||[],this.listeners_[eventType].push({callback:callback,context:context});var eventData=this.getInitialEvent(eventType);eventData&&callback.apply(context,eventData)},EventEmitter.prototype.off=function(eventType,callback,context){this.validateEventType_(eventType);for(var listeners=this.listeners_[eventType]||[],i=0;i<listeners.length;i++)if(listeners[i].callback===callback&&(!context||context===listeners[i].context))return void listeners.splice(i,1)},EventEmitter.prototype.validateEventType_=function(eventType){util.assert(this.allowedEvents_.find(function(et){return et===eventType}),"Unknown event: "+eventType)},EventEmitter}(),OnlineMonitor=function(_super){function OnlineMonitor(){var _this=_super.call(this,["online"])||this;return _this.online_=!0,"undefined"==typeof window||void 0===window.addEventListener||util.isMobileCordova()||(window.addEventListener("online",function(){_this.online_||(_this.online_=!0,_this.trigger("online",!0))},!1),window.addEventListener("offline",function(){_this.online_&&(_this.online_=!1,_this.trigger("online",!1))},!1)),_this}return tslib.__extends(OnlineMonitor,_super),OnlineMonitor.getInstance=function(){return new OnlineMonitor},OnlineMonitor.prototype.getInitialEvent=function(eventType){return util.assert("online"===eventType,"Unknown event type: "+eventType),[this.online_]},OnlineMonitor.prototype.currentlyOnline=function(){return this.online_},OnlineMonitor}(EventEmitter),Path=function(){function Path(pathOrString,pieceNum){if(void 0===pieceNum){this.pieces_=pathOrString.split("/");for(var copyTo=0,i=0;i<this.pieces_.length;i++)this.pieces_[i].length>0&&(this.pieces_[copyTo]=this.pieces_[i],copyTo++);this.pieces_.length=copyTo,this.pieceNum_=0}else this.pieces_=pathOrString,this.pieceNum_=pieceNum}return Path.prototype.toString=function(){for(var pathString="",i=this.pieceNum_;i<this.pieces_.length;i++)""!==this.pieces_[i]&&(pathString+="/"+this.pieces_[i]);return pathString||"/"},Path}();function newEmptyPath(){return new Path("")}function pathGetFront(path){return path.pieceNum_>=path.pieces_.length?null:path.pieces_[path.pieceNum_]}function pathGetLength(path){return path.pieces_.length-path.pieceNum_}function pathPopFront(path){var pieceNum=path.pieceNum_;return pieceNum<path.pieces_.length&&pieceNum++,new Path(path.pieces_,pieceNum)}function pathGetBack(path){return path.pieceNum_<path.pieces_.length?path.pieces_[path.pieces_.length-1]:null}function pathSlice(path,begin){return void 0===begin&&(begin=0),path.pieces_.slice(path.pieceNum_+begin)}function pathParent(path){if(path.pieceNum_>=path.pieces_.length)return null;for(var pieces=[],i=path.pieceNum_;i<path.pieces_.length-1;i++)pieces.push(path.pieces_[i]);return new Path(pieces,0)}function pathChild(path,childPathObj){for(var pieces=[],i=path.pieceNum_;i<path.pieces_.length;i++)pieces.push(path.pieces_[i]);if(childPathObj instanceof Path)for(i=childPathObj.pieceNum_;i<childPathObj.pieces_.length;i++)pieces.push(childPathObj.pieces_[i]);else{var childPieces=childPathObj.split("/");for(i=0;i<childPieces.length;i++)childPieces[i].length>0&&pieces.push(childPieces[i])}return new Path(pieces,0)}function pathIsEmpty(path){return path.pieceNum_>=path.pieces_.length}function newRelativePath(outerPath,innerPath){var outer=pathGetFront(outerPath),inner=pathGetFront(innerPath);if(null===outer)return innerPath;if(outer===inner)return newRelativePath(pathPopFront(outerPath),pathPopFront(innerPath));throw new Error("INTERNAL ERROR: innerPath ("+innerPath+") is not within outerPath ("+outerPath+")")}function pathCompare(left,right){for(var leftKeys=pathSlice(left,0),rightKeys=pathSlice(right,0),i=0;i<leftKeys.length&&i<rightKeys.length;i++){var cmp=nameCompare(leftKeys[i],rightKeys[i]);if(0!==cmp)return cmp}return leftKeys.length===rightKeys.length?0:leftKeys.length<rightKeys.length?-1:1}function pathEquals(path,other){if(pathGetLength(path)!==pathGetLength(other))return!1;for(var i=path.pieceNum_,j=other.pieceNum_;i<=path.pieces_.length;i++,j++)if(path.pieces_[i]!==other.pieces_[j])return!1;return!0}function pathContains(path,other){var i=path.pieceNum_,j=other.pieceNum_;if(pathGetLength(path)>pathGetLength(other))return!1;for(;i<path.pieces_.length;){if(path.pieces_[i]!==other.pieces_[j])return!1;++i,++j}return!0}var ValidationPath=function ValidationPath(path,errorPrefix_){this.errorPrefix_=errorPrefix_,this.parts_=pathSlice(path,0),this.byteLength_=Math.max(1,this.parts_.length);for(var i=0;i<this.parts_.length;i++)this.byteLength_+=util.stringLength(this.parts_[i]);validationPathCheckValid(this)};function validationPathCheckValid(validationPath){if(validationPath.byteLength_>768)throw new Error(validationPath.errorPrefix_+"has a key path longer than 768 bytes ("+validationPath.byteLength_+").");if(validationPath.parts_.length>32)throw new Error(validationPath.errorPrefix_+"path specified exceeds the maximum depth that can be written (32) or object contains a cycle "+validationPathToErrorString(validationPath))}function validationPathToErrorString(validationPath){return 0===validationPath.parts_.length?"":"in property '"+validationPath.parts_.join(".")+"'"}var __EMPTY_NODE,MAX_NODE$2,VisibilityMonitor=function(_super){function VisibilityMonitor(){var hidden,visibilityChange,_this=_super.call(this,["visible"])||this;return"undefined"!=typeof document&&void 0!==document.addEventListener&&(void 0!==document.hidden?(visibilityChange="visibilitychange",hidden="hidden"):void 0!==document.mozHidden?(visibilityChange="mozvisibilitychange",hidden="mozHidden"):void 0!==document.msHidden?(visibilityChange="msvisibilitychange",hidden="msHidden"):void 0!==document.webkitHidden&&(visibilityChange="webkitvisibilitychange",hidden="webkitHidden")),_this.visible_=!0,visibilityChange&&document.addEventListener(visibilityChange,function(){var visible=!document[hidden];visible!==_this.visible_&&(_this.visible_=visible,_this.trigger("visible",visible))},!1),_this}return tslib.__extends(VisibilityMonitor,_super),VisibilityMonitor.getInstance=function(){return new VisibilityMonitor},VisibilityMonitor.prototype.getInitialEvent=function(eventType){return util.assert("visible"===eventType,"Unknown event type: "+eventType),[this.visible_]},VisibilityMonitor}(EventEmitter),PersistentConnection=function(_super){function PersistentConnection(repoInfo_,applicationId_,onDataUpdate_,onConnectStatus_,onServerInfoUpdate_,authTokenProvider_,appCheckTokenProvider_,authOverride_){var _this=_super.call(this)||this;if(_this.repoInfo_=repoInfo_,_this.applicationId_=applicationId_,_this.onDataUpdate_=onDataUpdate_,_this.onConnectStatus_=onConnectStatus_,_this.onServerInfoUpdate_=onServerInfoUpdate_,_this.authTokenProvider_=authTokenProvider_,_this.appCheckTokenProvider_=appCheckTokenProvider_,_this.authOverride_=authOverride_,_this.id=PersistentConnection.nextPersistentConnectionId_++,_this.log_=logWrapper("p:"+_this.id+":"),_this.interruptReasons_={},_this.listens=new Map,_this.outstandingPuts_=[],_this.outstandingGets_=[],_this.outstandingPutCount_=0,_this.outstandingGetCount_=0,_this.onDisconnectRequestQueue_=[],_this.connected_=!1,_this.reconnectDelay_=1e3,_this.maxReconnectDelay_=3e5,_this.securityDebugCallback_=null,_this.lastSessionId=null,_this.establishConnectionTimer_=null,_this.visible_=!1,_this.requestCBHash_={},_this.requestNumber_=0,_this.realtime_=null,_this.authToken_=null,_this.appCheckToken_=null,_this.forceTokenRefresh_=!1,_this.invalidAuthTokenCount_=0,_this.invalidAppCheckTokenCount_=0,_this.firstConnection_=!0,_this.lastConnectionAttemptTime_=null,_this.lastConnectionEstablishedTime_=null,authOverride_&&!util.isNodeSdk())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");return VisibilityMonitor.getInstance().on("visible",_this.onVisible_,_this),-1===repoInfo_.host.indexOf("fblocal")&&OnlineMonitor.getInstance().on("online",_this.onOnline_,_this),_this}return tslib.__extends(PersistentConnection,_super),PersistentConnection.prototype.sendRequest=function(action,body,onResponse){var curReqNum=++this.requestNumber_,msg={r:curReqNum,a:action,b:body};this.log_(util.stringify(msg)),util.assert(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(msg),onResponse&&(this.requestCBHash_[curReqNum]=onResponse)},PersistentConnection.prototype.get=function(query){var _this=this;this.initConnection_();var deferred=new util.Deferred,request={p:query._path.toString(),q:query._queryObject},outstandingGet={action:"g",request:request,onComplete:function(message){var payload=message.d;"ok"===message.s?(_this.onDataUpdate_(request.p,payload,!1,null),deferred.resolve(payload)):deferred.reject(payload)}};this.outstandingGets_.push(outstandingGet),this.outstandingGetCount_++;var index=this.outstandingGets_.length-1;return this.connected_||setTimeout(function(){var get=_this.outstandingGets_[index];void 0!==get&&outstandingGet===get&&(delete _this.outstandingGets_[index],_this.outstandingGetCount_--,0===_this.outstandingGetCount_&&(_this.outstandingGets_=[]),_this.log_("get "+index+" timed out on connection"),deferred.reject(new Error("Client is offline.")))},3e3),this.connected_&&this.sendGet_(index),deferred.promise},PersistentConnection.prototype.listen=function(query,currentHashFn,tag,onComplete){this.initConnection_();var queryId=query._queryIdentifier,pathString=query._path.toString();this.log_("Listen called for "+pathString+" "+queryId),this.listens.has(pathString)||this.listens.set(pathString,new Map),util.assert(query._queryParams.isDefault()||!query._queryParams.loadsAllData(),"listen() called for non-default but complete query"),util.assert(!this.listens.get(pathString).has(queryId),"listen() called twice for same path/queryId.");var listenSpec={onComplete:onComplete,hashFn:currentHashFn,query:query,tag:tag};this.listens.get(pathString).set(queryId,listenSpec),this.connected_&&this.sendListen_(listenSpec)},PersistentConnection.prototype.sendGet_=function(index){var _this=this,get=this.outstandingGets_[index];this.sendRequest("g",get.request,function(message){delete _this.outstandingGets_[index],_this.outstandingGetCount_--,0===_this.outstandingGetCount_&&(_this.outstandingGets_=[]),get.onComplete&&get.onComplete(message)})},PersistentConnection.prototype.sendListen_=function(listenSpec){var _this=this,query=listenSpec.query,pathString=query._path.toString(),queryId=query._queryIdentifier;this.log_("Listen on "+pathString+" for "+queryId);var req={p:pathString};listenSpec.tag&&(req.q=query._queryObject,req.t=listenSpec.tag),req.h=listenSpec.hashFn(),this.sendRequest("q",req,function(message){var payload=message.d,status=message.s;PersistentConnection.warnOnListenWarnings_(payload,query),(_this.listens.get(pathString)&&_this.listens.get(pathString).get(queryId))===listenSpec&&(_this.log_("listen response",message),"ok"!==status&&_this.removeListen_(pathString,queryId),listenSpec.onComplete&&listenSpec.onComplete(status,payload))})},PersistentConnection.warnOnListenWarnings_=function(payload,query){if(payload&&"object"==typeof payload&&util.contains(payload,"w")){var warnings=util.safeGet(payload,"w");if(Array.isArray(warnings)&&~warnings.indexOf("no_index")){var indexSpec='".indexOn": "'+query._queryParams.getIndex().toString()+'"',indexPath=query._path.toString();warn("Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding "+indexSpec+" at "+indexPath+" to your security rules for better performance.")}}},PersistentConnection.prototype.refreshAuthToken=function(token){this.authToken_=token,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},function(){}),this.reduceReconnectDelayIfAdminCredential_(token)},PersistentConnection.prototype.reduceReconnectDelayIfAdminCredential_=function(credential){(credential&&40===credential.length||util.isAdmin(credential))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=3e4)},PersistentConnection.prototype.refreshAppCheckToken=function(token){this.appCheckToken_=token,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},function(){})},PersistentConnection.prototype.tryAuth=function(){var _this=this;if(this.connected_&&this.authToken_){var token_1=this.authToken_,authMethod=util.isValidFormat(token_1)?"auth":"gauth",requestData={cred:token_1};null===this.authOverride_?requestData.noauth=!0:"object"==typeof this.authOverride_&&(requestData.authvar=this.authOverride_),this.sendRequest(authMethod,requestData,function(res){var status=res.s,data=res.d||"error";_this.authToken_===token_1&&("ok"===status?_this.invalidAuthTokenCount_=0:_this.onAuthRevoked_(status,data))})}},PersistentConnection.prototype.tryAppCheck=function(){var _this=this;this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},function(res){var status=res.s,data=res.d||"error";"ok"===status?_this.invalidAppCheckTokenCount_=0:_this.onAppCheckRevoked_(status,data)})},PersistentConnection.prototype.unlisten=function(query,tag){var pathString=query._path.toString(),queryId=query._queryIdentifier;this.log_("Unlisten called for "+pathString+" "+queryId),util.assert(query._queryParams.isDefault()||!query._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(pathString,queryId)&&this.connected_&&this.sendUnlisten_(pathString,queryId,query._queryObject,tag)},PersistentConnection.prototype.sendUnlisten_=function(pathString,queryId,queryObj,tag){this.log_("Unlisten on "+pathString+" for "+queryId);var req={p:pathString};tag&&(req.q=queryObj,req.t=tag),this.sendRequest("n",req)},PersistentConnection.prototype.onDisconnectPut=function(pathString,data,onComplete){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",pathString,data,onComplete):this.onDisconnectRequestQueue_.push({pathString:pathString,action:"o",data:data,onComplete:onComplete})},PersistentConnection.prototype.onDisconnectMerge=function(pathString,data,onComplete){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",pathString,data,onComplete):this.onDisconnectRequestQueue_.push({pathString:pathString,action:"om",data:data,onComplete:onComplete})},PersistentConnection.prototype.onDisconnectCancel=function(pathString,onComplete){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",pathString,null,onComplete):this.onDisconnectRequestQueue_.push({pathString:pathString,action:"oc",data:null,onComplete:onComplete})},PersistentConnection.prototype.sendOnDisconnect_=function(action,pathString,data,onComplete){var request={p:pathString,d:data};this.log_("onDisconnect "+action,request),this.sendRequest(action,request,function(response){onComplete&&setTimeout(function(){onComplete(response.s,response.d)},Math.floor(0))})},PersistentConnection.prototype.put=function(pathString,data,onComplete,hash){this.putInternal("p",pathString,data,onComplete,hash)},PersistentConnection.prototype.merge=function(pathString,data,onComplete,hash){this.putInternal("m",pathString,data,onComplete,hash)},PersistentConnection.prototype.putInternal=function(action,pathString,data,onComplete,hash){this.initConnection_();var request={p:pathString,d:data};void 0!==hash&&(request.h=hash),this.outstandingPuts_.push({action:action,request:request,onComplete:onComplete}),this.outstandingPutCount_++;var index=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(index):this.log_("Buffering put: "+pathString)},PersistentConnection.prototype.sendPut_=function(index){var _this=this,action=this.outstandingPuts_[index].action,request=this.outstandingPuts_[index].request,onComplete=this.outstandingPuts_[index].onComplete;this.outstandingPuts_[index].queued=this.connected_,this.sendRequest(action,request,function(message){_this.log_(action+" response",message),delete _this.outstandingPuts_[index],_this.outstandingPutCount_--,0===_this.outstandingPutCount_&&(_this.outstandingPuts_=[]),onComplete&&onComplete(message.s,message.d)})},PersistentConnection.prototype.reportStats=function(stats){var _this=this;if(this.connected_){var request={c:stats};this.log_("reportStats",request),this.sendRequest("s",request,function(result){if("ok"!==result.s){var errorReason=result.d;_this.log_("reportStats","Error sending stats: "+errorReason)}})}},PersistentConnection.prototype.onDataMessage_=function(message){if("r"in message){this.log_("from server: "+util.stringify(message));var reqNum=message.r,onResponse=this.requestCBHash_[reqNum];onResponse&&(delete this.requestCBHash_[reqNum],onResponse(message.b))}else{if("error"in message)throw"A server-side error has occurred: "+message.error;"a"in message&&this.onDataPush_(message.a,message.b)}},PersistentConnection.prototype.onDataPush_=function(action,body){this.log_("handleServerMessage",action,body),"d"===action?this.onDataUpdate_(body.p,body.d,!1,body.t):"m"===action?this.onDataUpdate_(body.p,body.d,!0,body.t):"c"===action?this.onListenRevoked_(body.p,body.q):"ac"===action?this.onAuthRevoked_(body.s,body.d):"apc"===action?this.onAppCheckRevoked_(body.s,body.d):"sd"===action?this.onSecurityDebugPacket_(body):error("Unrecognized action received from server: "+util.stringify(action)+"\nAre you using the latest client?")},PersistentConnection.prototype.onReady_=function(timestamp,sessionId){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=(new Date).getTime(),this.handleTimestamp_(timestamp),this.lastSessionId=sessionId,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)},PersistentConnection.prototype.scheduleConnect_=function(timeout){var _this=this;util.assert(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(function(){_this.establishConnectionTimer_=null,_this.establishConnection_()},Math.floor(timeout))},PersistentConnection.prototype.initConnection_=function(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)},PersistentConnection.prototype.onVisible_=function(visible){visible&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=1e3,this.realtime_||this.scheduleConnect_(0)),this.visible_=visible},PersistentConnection.prototype.onOnline_=function(online){online?(this.log_("Browser went online."),this.reconnectDelay_=1e3,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())},PersistentConnection.prototype.onRealtimeDisconnect_=function(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){if(this.visible_){if(this.lastConnectionEstablishedTime_){(new Date).getTime()-this.lastConnectionEstablishedTime_>3e4&&(this.reconnectDelay_=1e3),this.lastConnectionEstablishedTime_=null}}else this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=(new Date).getTime();var timeSinceLastConnectAttempt=(new Date).getTime()-this.lastConnectionAttemptTime_,reconnectDelay=Math.max(0,this.reconnectDelay_-timeSinceLastConnectAttempt);reconnectDelay=Math.random()*reconnectDelay,this.log_("Trying to reconnect in "+reconnectDelay+"ms"),this.scheduleConnect_(reconnectDelay),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,1.3*this.reconnectDelay_)}this.onConnectStatus_(!1)},PersistentConnection.prototype.establishConnection_=function(){return tslib.__awaiter(this,void 0,void 0,function(){var onDataMessage,onReady,onDisconnect_1,connId,lastSessionId,canceled_1,connection_1,closeFn,sendRequestFn,forceRefresh,_a,authToken,appCheckToken,error_1,_this=this;return tslib.__generator(this,function(_b){switch(_b.label){case 0:if(!this.shouldReconnect_())return[3,4];this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=(new Date).getTime(),this.lastConnectionEstablishedTime_=null,onDataMessage=this.onDataMessage_.bind(this),onReady=this.onReady_.bind(this),onDisconnect_1=this.onRealtimeDisconnect_.bind(this),connId=this.id+":"+PersistentConnection.nextConnectionId_++,lastSessionId=this.lastSessionId,canceled_1=!1,connection_1=null,closeFn=function(){connection_1?connection_1.close():(canceled_1=!0,onDisconnect_1())},sendRequestFn=function(msg){util.assert(connection_1,"sendRequest call when we're not connected not allowed."),connection_1.sendRequest(msg)},this.realtime_={close:closeFn,sendRequest:sendRequestFn},forceRefresh=this.forceTokenRefresh_,this.forceTokenRefresh_=!1,_b.label=1;case 1:return _b.trys.push([1,3,,4]),[4,Promise.all([this.authTokenProvider_.getToken(forceRefresh),this.appCheckTokenProvider_.getToken(forceRefresh)])];case 2:return _a=tslib.__read.apply(void 0,[_b.sent(),2]),authToken=_a[0],appCheckToken=_a[1],canceled_1?log("getToken() completed but was canceled"):(log("getToken() completed. Creating connection."),this.authToken_=authToken&&authToken.accessToken,this.appCheckToken_=appCheckToken&&appCheckToken.token,connection_1=new Connection(connId,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,onDataMessage,onReady,onDisconnect_1,function(reason){warn(reason+" ("+_this.repoInfo_.toString()+")"),_this.interrupt("server_kill")},lastSessionId)),[3,4];case 3:return error_1=_b.sent(),this.log_("Failed to get token: "+error_1),canceled_1||(this.repoInfo_.nodeAdmin&&warn(error_1),closeFn()),[3,4];case 4:return[2]}})})},PersistentConnection.prototype.interrupt=function(reason){log("Interrupting connection for reason: "+reason),this.interruptReasons_[reason]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())},PersistentConnection.prototype.resume=function(reason){log("Resuming connection for reason: "+reason),delete this.interruptReasons_[reason],util.isEmpty(this.interruptReasons_)&&(this.reconnectDelay_=1e3,this.realtime_||this.scheduleConnect_(0))},PersistentConnection.prototype.handleTimestamp_=function(timestamp){var delta=timestamp-(new Date).getTime();this.onServerInfoUpdate_({serverTimeOffset:delta})},PersistentConnection.prototype.cancelSentTransactions_=function(){for(var i=0;i<this.outstandingPuts_.length;i++){var put=this.outstandingPuts_[i];put&&"h"in put.request&&put.queued&&(put.onComplete&&put.onComplete("disconnect"),delete this.outstandingPuts_[i],this.outstandingPutCount_--)}0===this.outstandingPutCount_&&(this.outstandingPuts_=[])},PersistentConnection.prototype.onListenRevoked_=function(pathString,query){var queryId;queryId=query?query.map(function(q){return ObjectToUniqueKey(q)}).join("$"):"default";var listen=this.removeListen_(pathString,queryId);listen&&listen.onComplete&&listen.onComplete("permission_denied")},PersistentConnection.prototype.removeListen_=function(pathString,queryId){var listen,normalizedPathString=new Path(pathString).toString();if(this.listens.has(normalizedPathString)){var map=this.listens.get(normalizedPathString);listen=map.get(queryId),map.delete(queryId),0===map.size&&this.listens.delete(normalizedPathString)}else listen=void 0;return listen},PersistentConnection.prototype.onAuthRevoked_=function(statusCode,explanation){log("Auth token revoked: "+statusCode+"/"+explanation),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),"invalid_token"!==statusCode&&"permission_denied"!==statusCode||(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=3&&(this.reconnectDelay_=3e4,this.authTokenProvider_.notifyForInvalidToken()))},PersistentConnection.prototype.onAppCheckRevoked_=function(statusCode,explanation){log("App check token revoked: "+statusCode+"/"+explanation),this.appCheckToken_=null,this.forceTokenRefresh_=!0,"invalid_token"!==statusCode&&"permission_denied"!==statusCode||(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=3&&this.appCheckTokenProvider_.notifyForInvalidToken())},PersistentConnection.prototype.onSecurityDebugPacket_=function(body){this.securityDebugCallback_?this.securityDebugCallback_(body):"msg"in body&&console.log("FIREBASE: "+body.msg.replace("\n","\nFIREBASE: "))},PersistentConnection.prototype.restoreState_=function(){var e_1,_a,e_2,_b;this.tryAuth(),this.tryAppCheck();try{for(var _c=tslib.__values(this.listens.values()),_d=_c.next();!_d.done;_d=_c.next()){var queries=_d.value;try{for(var _e=(e_2=void 0,tslib.__values(queries.values())),_f=_e.next();!_f.done;_f=_e.next()){var listenSpec=_f.value;this.sendListen_(listenSpec)}}catch(e_2_1){e_2={error:e_2_1}}finally{try{_f&&!_f.done&&(_b=_e.return)&&_b.call(_e)}finally{if(e_2)throw e_2.error}}}}catch(e_1_1){e_1={error:e_1_1}}finally{try{_d&&!_d.done&&(_a=_c.return)&&_a.call(_c)}finally{if(e_1)throw e_1.error}}for(var i=0;i<this.outstandingPuts_.length;i++)this.outstandingPuts_[i]&&this.sendPut_(i);for(;this.onDisconnectRequestQueue_.length;){var request=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(request.action,request.pathString,request.data,request.onComplete)}for(i=0;i<this.outstandingGets_.length;i++)this.outstandingGets_[i]&&this.sendGet_(i)},PersistentConnection.prototype.sendConnectStats_=function(){var stats={},clientName="js";util.isNodeSdk()&&(clientName=this.repoInfo_.nodeAdmin?"admin_node":"node"),stats["sdk."+clientName+"."+SDK_VERSION.replace(/\./g,"-")]=1,util.isMobileCordova()?stats["framework.cordova"]=1:util.isReactNative()&&(stats["framework.reactnative"]=1),this.reportStats(stats)},PersistentConnection.prototype.shouldReconnect_=function(){var online=OnlineMonitor.getInstance().currentlyOnline();return util.isEmpty(this.interruptReasons_)&&online},PersistentConnection.nextPersistentConnectionId_=0,PersistentConnection.nextConnectionId_=0,PersistentConnection}(ServerActions),NamedNode=function(){function NamedNode(name,node){this.name=name,this.node=node}return NamedNode.Wrap=function(name,node){return new NamedNode(name,node)},NamedNode}(),Index=function(){function Index(){}return Index.prototype.getCompare=function(){return this.compare.bind(this)},Index.prototype.indexedValueChanged=function(oldNode,newNode){var oldWrapped=new NamedNode(MIN_NAME,oldNode),newWrapped=new NamedNode(MIN_NAME,newNode);return 0!==this.compare(oldWrapped,newWrapped)},Index.prototype.minPost=function(){return NamedNode.MIN},Index}(),KeyIndex=function(_super){function KeyIndex(){return null!==_super&&_super.apply(this,arguments)||this}return tslib.__extends(KeyIndex,_super),Object.defineProperty(KeyIndex,"__EMPTY_NODE",{get:function(){return __EMPTY_NODE},set:function(val){__EMPTY_NODE=val},enumerable:!1,configurable:!0}),KeyIndex.prototype.compare=function(a,b){return nameCompare(a.name,b.name)},KeyIndex.prototype.isDefinedOn=function(node){throw util.assertionError("KeyIndex.isDefinedOn not expected to be called.")},KeyIndex.prototype.indexedValueChanged=function(oldNode,newNode){return!1},KeyIndex.prototype.minPost=function(){return NamedNode.MIN},KeyIndex.prototype.maxPost=function(){return new NamedNode(MAX_NAME,__EMPTY_NODE)},KeyIndex.prototype.makePost=function(indexValue,name){return util.assert("string"==typeof indexValue,"KeyIndex indexValue must always be a string."),new NamedNode(indexValue,__EMPTY_NODE)},KeyIndex.prototype.toString=function(){return".key"},KeyIndex}(Index),KEY_INDEX=new KeyIndex,SortedMapIterator=function(){function SortedMapIterator(node,startKey,comparator,isReverse_,resultGenerator_){void 0===resultGenerator_&&(resultGenerator_=null),this.isReverse_=isReverse_,this.resultGenerator_=resultGenerator_,this.nodeStack_=[];for(var cmp=1;!node.isEmpty();)if(node=node,cmp=startKey?comparator(node.key,startKey):1,isReverse_&&(cmp*=-1),cmp<0)node=this.isReverse_?node.left:node.right;else{if(0===cmp){this.nodeStack_.push(node);break}this.nodeStack_.push(node),node=this.isReverse_?node.right:node.left}}return SortedMapIterator.prototype.getNext=function(){if(0===this.nodeStack_.length)return null;var result,node=this.nodeStack_.pop();if(result=this.resultGenerator_?this.resultGenerator_(node.key,node.value):{key:node.key,value:node.value},this.isReverse_)for(node=node.left;!node.isEmpty();)this.nodeStack_.push(node),node=node.right;else for(node=node.right;!node.isEmpty();)this.nodeStack_.push(node),node=node.left;return result},SortedMapIterator.prototype.hasNext=function(){return this.nodeStack_.length>0},SortedMapIterator.prototype.peek=function(){if(0===this.nodeStack_.length)return null;var node=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(node.key,node.value):{key:node.key,value:node.value}},SortedMapIterator}(),LLRBNode=function(){function LLRBNode(key,value,color,left,right){this.key=key,this.value=value,this.color=null!=color?color:LLRBNode.RED,this.left=null!=left?left:SortedMap.EMPTY_NODE,this.right=null!=right?right:SortedMap.EMPTY_NODE}return LLRBNode.prototype.copy=function(key,value,color,left,right){return new LLRBNode(null!=key?key:this.key,null!=value?value:this.value,null!=color?color:this.color,null!=left?left:this.left,null!=right?right:this.right)},LLRBNode.prototype.count=function(){return this.left.count()+1+this.right.count()},LLRBNode.prototype.isEmpty=function(){return!1},LLRBNode.prototype.inorderTraversal=function(action){return this.left.inorderTraversal(action)||!!action(this.key,this.value)||this.right.inorderTraversal(action)},LLRBNode.prototype.reverseTraversal=function(action){return this.right.reverseTraversal(action)||action(this.key,this.value)||this.left.reverseTraversal(action)},LLRBNode.prototype.min_=function(){return this.left.isEmpty()?this:this.left.min_()},LLRBNode.prototype.minKey=function(){return this.min_().key},LLRBNode.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},LLRBNode.prototype.insert=function(key,value,comparator){var n=this,cmp=comparator(key,n.key);return(n=cmp<0?n.copy(null,null,null,n.left.insert(key,value,comparator),null):0===cmp?n.copy(null,value,null,null,null):n.copy(null,null,null,null,n.right.insert(key,value,comparator))).fixUp_()},LLRBNode.prototype.removeMin_=function(){if(this.left.isEmpty())return SortedMap.EMPTY_NODE;var n=this;return n.left.isRed_()||n.left.left.isRed_()||(n=n.moveRedLeft_()),(n=n.copy(null,null,null,n.left.removeMin_(),null)).fixUp_()},LLRBNode.prototype.remove=function(key,comparator){var n,smallest;if(comparator(key,(n=this).key)<0)n.left.isEmpty()||n.left.isRed_()||n.left.left.isRed_()||(n=n.moveRedLeft_()),n=n.copy(null,null,null,n.left.remove(key,comparator),null);else{if(n.left.isRed_()&&(n=n.rotateRight_()),n.right.isEmpty()||n.right.isRed_()||n.right.left.isRed_()||(n=n.moveRedRight_()),0===comparator(key,n.key)){if(n.right.isEmpty())return SortedMap.EMPTY_NODE;smallest=n.right.min_(),n=n.copy(smallest.key,smallest.value,null,null,n.right.removeMin_())}n=n.copy(null,null,null,null,n.right.remove(key,comparator))}return n.fixUp_()},LLRBNode.prototype.isRed_=function(){return this.color},LLRBNode.prototype.fixUp_=function(){var n=this;return n.right.isRed_()&&!n.left.isRed_()&&(n=n.rotateLeft_()),n.left.isRed_()&&n.left.left.isRed_()&&(n=n.rotateRight_()),n.left.isRed_()&&n.right.isRed_()&&(n=n.colorFlip_()),n},LLRBNode.prototype.moveRedLeft_=function(){var n=this.colorFlip_();return n.right.left.isRed_()&&(n=(n=(n=n.copy(null,null,null,null,n.right.rotateRight_())).rotateLeft_()).colorFlip_()),n},LLRBNode.prototype.moveRedRight_=function(){var n=this.colorFlip_();return n.left.left.isRed_()&&(n=(n=n.rotateRight_()).colorFlip_()),n},LLRBNode.prototype.rotateLeft_=function(){var nl=this.copy(null,null,LLRBNode.RED,null,this.right.left);return this.right.copy(null,null,this.color,nl,null)},LLRBNode.prototype.rotateRight_=function(){var nr=this.copy(null,null,LLRBNode.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,nr)},LLRBNode.prototype.colorFlip_=function(){var left=this.left.copy(null,null,!this.left.color,null,null),right=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,left,right)},LLRBNode.prototype.checkMaxDepth_=function(){var blackDepth=this.check_();return Math.pow(2,blackDepth)<=this.count()+1},LLRBNode.prototype.check_=function(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");var blackDepth=this.left.check_();if(blackDepth!==this.right.check_())throw new Error("Black depths differ");return blackDepth+(this.isRed_()?0:1)},LLRBNode.RED=!0,LLRBNode.BLACK=!1,LLRBNode}(),LLRBEmptyNode=function(){function LLRBEmptyNode(){}return LLRBEmptyNode.prototype.copy=function(key,value,color,left,right){return this},LLRBEmptyNode.prototype.insert=function(key,value,comparator){return new LLRBNode(key,value,null)},LLRBEmptyNode.prototype.remove=function(key,comparator){return this},LLRBEmptyNode.prototype.count=function(){return 0},LLRBEmptyNode.prototype.isEmpty=function(){return!0},LLRBEmptyNode.prototype.inorderTraversal=function(action){return!1},LLRBEmptyNode.prototype.reverseTraversal=function(action){return!1},LLRBEmptyNode.prototype.minKey=function(){return null},LLRBEmptyNode.prototype.maxKey=function(){return null},LLRBEmptyNode.prototype.check_=function(){return 0},LLRBEmptyNode.prototype.isRed_=function(){return!1},LLRBEmptyNode}(),SortedMap=function(){function SortedMap(comparator_,root_){void 0===root_&&(root_=SortedMap.EMPTY_NODE),this.comparator_=comparator_,this.root_=root_}return SortedMap.prototype.insert=function(key,value){return new SortedMap(this.comparator_,this.root_.insert(key,value,this.comparator_).copy(null,null,LLRBNode.BLACK,null,null))},SortedMap.prototype.remove=function(key){return new SortedMap(this.comparator_,this.root_.remove(key,this.comparator_).copy(null,null,LLRBNode.BLACK,null,null))},SortedMap.prototype.get=function(key){for(var cmp,node=this.root_;!node.isEmpty();){if(0===(cmp=this.comparator_(key,node.key)))return node.value;cmp<0?node=node.left:cmp>0&&(node=node.right)}return null},SortedMap.prototype.getPredecessorKey=function(key){for(var cmp,node=this.root_,rightParent=null;!node.isEmpty();){if(0===(cmp=this.comparator_(key,node.key))){if(node.left.isEmpty())return rightParent?rightParent.key:null;for(node=node.left;!node.right.isEmpty();)node=node.right;return node.key}cmp<0?node=node.left:cmp>0&&(rightParent=node,node=node.right)}throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")},SortedMap.prototype.isEmpty=function(){return this.root_.isEmpty()},SortedMap.prototype.count=function(){return this.root_.count()},SortedMap.prototype.minKey=function(){return this.root_.minKey()},SortedMap.prototype.maxKey=function(){return this.root_.maxKey()},SortedMap.prototype.inorderTraversal=function(action){return this.root_.inorderTraversal(action)},SortedMap.prototype.reverseTraversal=function(action){return this.root_.reverseTraversal(action)},SortedMap.prototype.getIterator=function(resultGenerator){return new SortedMapIterator(this.root_,null,this.comparator_,!1,resultGenerator)},SortedMap.prototype.getIteratorFrom=function(key,resultGenerator){return new SortedMapIterator(this.root_,key,this.comparator_,!1,resultGenerator)},SortedMap.prototype.getReverseIteratorFrom=function(key,resultGenerator){return new SortedMapIterator(this.root_,key,this.comparator_,!0,resultGenerator)},SortedMap.prototype.getReverseIterator=function(resultGenerator){return new SortedMapIterator(this.root_,null,this.comparator_,!0,resultGenerator)},SortedMap.EMPTY_NODE=new LLRBEmptyNode,SortedMap}();function NAME_ONLY_COMPARATOR(left,right){return nameCompare(left.name,right.name)}function NAME_COMPARATOR(left,right){return nameCompare(left,right)}var __childrenNodeConstructor,nodeFromJSON$1,MAX_NODE$1,priorityHashText=function(priority){return"number"==typeof priority?"number:"+doubleToIEEE754String(priority):"string:"+priority},validatePriorityNode=function(priorityNode){if(priorityNode.isLeafNode()){var val=priorityNode.val();util.assert("string"==typeof val||"number"==typeof val||"object"==typeof val&&util.contains(val,".sv"),"Priority must be a string or number.")}else util.assert(priorityNode===MAX_NODE$2||priorityNode.isEmpty(),"priority of unexpected type.");util.assert(priorityNode===MAX_NODE$2||priorityNode.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")},LeafNode=function(){function LeafNode(value_,priorityNode_){void 0===priorityNode_&&(priorityNode_=LeafNode.__childrenNodeConstructor.EMPTY_NODE),this.value_=value_,this.priorityNode_=priorityNode_,this.lazyHash_=null,util.assert(void 0!==this.value_&&null!==this.value_,"LeafNode shouldn't be created with null/undefined value."),validatePriorityNode(this.priorityNode_)}return Object.defineProperty(LeafNode,"__childrenNodeConstructor",{get:function(){return __childrenNodeConstructor},set:function(val){__childrenNodeConstructor=val},enumerable:!1,configurable:!0}),LeafNode.prototype.isLeafNode=function(){return!0},LeafNode.prototype.getPriority=function(){return this.priorityNode_},LeafNode.prototype.updatePriority=function(newPriorityNode){return new LeafNode(this.value_,newPriorityNode)},LeafNode.prototype.getImmediateChild=function(childName){return".priority"===childName?this.priorityNode_:LeafNode.__childrenNodeConstructor.EMPTY_NODE},LeafNode.prototype.getChild=function(path){return pathIsEmpty(path)?this:".priority"===pathGetFront(path)?this.priorityNode_:LeafNode.__childrenNodeConstructor.EMPTY_NODE},LeafNode.prototype.hasChild=function(){return!1},LeafNode.prototype.getPredecessorChildName=function(childName,childNode){return null},LeafNode.prototype.updateImmediateChild=function(childName,newChildNode){return".priority"===childName?this.updatePriority(newChildNode):newChildNode.isEmpty()&&".priority"!==childName?this:LeafNode.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(childName,newChildNode).updatePriority(this.priorityNode_)},LeafNode.prototype.updateChild=function(path,newChildNode){var front=pathGetFront(path);return null===front?newChildNode:newChildNode.isEmpty()&&".priority"!==front?this:(util.assert(".priority"!==front||1===pathGetLength(path),".priority must be the last token in a path"),this.updateImmediateChild(front,LeafNode.__childrenNodeConstructor.EMPTY_NODE.updateChild(pathPopFront(path),newChildNode)))},LeafNode.prototype.isEmpty=function(){return!1},LeafNode.prototype.numChildren=function(){return 0},LeafNode.prototype.forEachChild=function(index,action){return!1},LeafNode.prototype.val=function(exportFormat){return exportFormat&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()},LeafNode.prototype.hash=function(){if(null===this.lazyHash_){var toHash="";this.priorityNode_.isEmpty()||(toHash+="priority:"+priorityHashText(this.priorityNode_.val())+":");var type=typeof this.value_;toHash+=type+":",toHash+="number"===type?doubleToIEEE754String(this.value_):this.value_,this.lazyHash_=sha1(toHash)}return this.lazyHash_},LeafNode.prototype.getValue=function(){return this.value_},LeafNode.prototype.compareTo=function(other){return other===LeafNode.__childrenNodeConstructor.EMPTY_NODE?1:other instanceof LeafNode.__childrenNodeConstructor?-1:(util.assert(other.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(other))},LeafNode.prototype.compareToLeafNode_=function(otherLeaf){var otherLeafType=typeof otherLeaf.value_,thisLeafType=typeof this.value_,otherIndex=LeafNode.VALUE_TYPE_ORDER.indexOf(otherLeafType),thisIndex=LeafNode.VALUE_TYPE_ORDER.indexOf(thisLeafType);return util.assert(otherIndex>=0,"Unknown leaf type: "+otherLeafType),util.assert(thisIndex>=0,"Unknown leaf type: "+thisLeafType),otherIndex===thisIndex?"object"===thisLeafType?0:this.value_<otherLeaf.value_?-1:this.value_===otherLeaf.value_?0:1:thisIndex-otherIndex},LeafNode.prototype.withIndex=function(){return this},LeafNode.prototype.isIndexed=function(){return!0},LeafNode.prototype.equals=function(other){if(other===this)return!0;if(other.isLeafNode()){var otherLeaf=other;return this.value_===otherLeaf.value_&&this.priorityNode_.equals(otherLeaf.priorityNode_)}return!1},LeafNode.VALUE_TYPE_ORDER=["object","boolean","number","string"],LeafNode}();var _defaultIndexMap,EMPTY_NODE,PRIORITY_INDEX=new(function(_super){function PriorityIndex(){return null!==_super&&_super.apply(this,arguments)||this}return tslib.__extends(PriorityIndex,_super),PriorityIndex.prototype.compare=function(a,b){var aPriority=a.node.getPriority(),bPriority=b.node.getPriority(),indexCmp=aPriority.compareTo(bPriority);return 0===indexCmp?nameCompare(a.name,b.name):indexCmp},PriorityIndex.prototype.isDefinedOn=function(node){return!node.getPriority().isEmpty()},PriorityIndex.prototype.indexedValueChanged=function(oldNode,newNode){return!oldNode.getPriority().equals(newNode.getPriority())},PriorityIndex.prototype.minPost=function(){return NamedNode.MIN},PriorityIndex.prototype.maxPost=function(){return new NamedNode(MAX_NAME,new LeafNode("[PRIORITY-POST]",MAX_NODE$1))},PriorityIndex.prototype.makePost=function(indexValue,name){var priorityNode=nodeFromJSON$1(indexValue);return new NamedNode(name,new LeafNode("[PRIORITY-POST]",priorityNode))},PriorityIndex.prototype.toString=function(){return".priority"},PriorityIndex}(Index)),LOG_2=Math.log(2),Base12Num=function(){function Base12Num(length){var num;this.count=(num=length+1,parseInt(Math.log(num)/LOG_2,10)),this.current_=this.count-1;var bits,mask=(bits=this.count,parseInt(Array(bits+1).join("1"),2));this.bits_=length+1&mask}return Base12Num.prototype.nextBitIsOne=function(){var result=!(this.bits_&1<<this.current_);return this.current_--,result},Base12Num}(),buildChildSet=function(childList,cmp,keyFn,mapSortFn){childList.sort(cmp);var buildBalancedTree=function(low,high){var namedNode,key,length=high-low;if(0===length)return null;if(1===length)return namedNode=childList[low],key=keyFn?keyFn(namedNode):namedNode,new LLRBNode(key,namedNode.node,LLRBNode.BLACK,null,null);var middle=parseInt(length/2,10)+low,left=buildBalancedTree(low,middle),right=buildBalancedTree(middle+1,high);return namedNode=childList[middle],key=keyFn?keyFn(namedNode):namedNode,new LLRBNode(key,namedNode.node,LLRBNode.BLACK,left,right)},root=function(base12){for(var node=null,root=null,index=childList.length,buildPennant=function(chunkSize,color){var low=index-chunkSize,high=index;index-=chunkSize;var childTree=buildBalancedTree(low+1,high),namedNode=childList[low],key=keyFn?keyFn(namedNode):namedNode;attachPennant(new LLRBNode(key,namedNode.node,color,null,childTree))},attachPennant=function(pennant){node?(node.left=pennant,node=pennant):(root=pennant,node=pennant)},i=0;i<base12.count;++i){var isOne=base12.nextBitIsOne(),chunkSize=Math.pow(2,base12.count-(i+1));isOne?buildPennant(chunkSize,LLRBNode.BLACK):(buildPennant(chunkSize,LLRBNode.BLACK),buildPennant(chunkSize,LLRBNode.RED))}return root}(new Base12Num(childList.length));return new SortedMap(mapSortFn||cmp,root)},fallbackObject={},IndexMap=function(){function IndexMap(indexes_,indexSet_){this.indexes_=indexes_,this.indexSet_=indexSet_}return Object.defineProperty(IndexMap,"Default",{get:function(){return util.assert(fallbackObject&&PRIORITY_INDEX,"ChildrenNode.ts has not been loaded"),_defaultIndexMap=_defaultIndexMap||new IndexMap({".priority":fallbackObject},{".priority":PRIORITY_INDEX})},enumerable:!1,configurable:!0}),IndexMap.prototype.get=function(indexKey){var sortedMap=util.safeGet(this.indexes_,indexKey);if(!sortedMap)throw new Error("No index defined for "+indexKey);return sortedMap instanceof SortedMap?sortedMap:null},IndexMap.prototype.hasIndex=function(indexDefinition){return util.contains(this.indexSet_,indexDefinition.toString())},IndexMap.prototype.addIndex=function(indexDefinition,existingChildren){util.assert(indexDefinition!==KEY_INDEX,"KeyIndex always exists and isn't meant to be added to the IndexMap.");for(var newIndex,childList=[],sawIndexedValue=!1,iter=existingChildren.getIterator(NamedNode.Wrap),next=iter.getNext();next;)sawIndexedValue=sawIndexedValue||indexDefinition.isDefinedOn(next.node),childList.push(next),next=iter.getNext();newIndex=sawIndexedValue?buildChildSet(childList,indexDefinition.getCompare()):fallbackObject;var indexName=indexDefinition.toString(),newIndexSet=tslib.__assign({},this.indexSet_);newIndexSet[indexName]=indexDefinition;var newIndexes=tslib.__assign({},this.indexes_);return newIndexes[indexName]=newIndex,new IndexMap(newIndexes,newIndexSet)},IndexMap.prototype.addToIndexes=function(namedNode,existingChildren){var _this=this;return new IndexMap(util.map(this.indexes_,function(indexedChildren,indexName){var index=util.safeGet(_this.indexSet_,indexName);if(util.assert(index,"Missing index implementation for "+indexName),indexedChildren===fallbackObject){if(index.isDefinedOn(namedNode.node)){for(var childList=[],iter=existingChildren.getIterator(NamedNode.Wrap),next=iter.getNext();next;)next.name!==namedNode.name&&childList.push(next),next=iter.getNext();return childList.push(namedNode),buildChildSet(childList,index.getCompare())}return fallbackObject}var existingSnap=existingChildren.get(namedNode.name),newChildren=indexedChildren;return existingSnap&&(newChildren=newChildren.remove(new NamedNode(namedNode.name,existingSnap))),newChildren.insert(namedNode,namedNode.node)}),this.indexSet_)},IndexMap.prototype.removeFromIndexes=function(namedNode,existingChildren){return new IndexMap(util.map(this.indexes_,function(indexedChildren){if(indexedChildren===fallbackObject)return indexedChildren;var existingSnap=existingChildren.get(namedNode.name);return existingSnap?indexedChildren.remove(new NamedNode(namedNode.name,existingSnap)):indexedChildren}),this.indexSet_)},IndexMap}(),ChildrenNode=function(){function ChildrenNode(children_,priorityNode_,indexMap_){this.children_=children_,this.priorityNode_=priorityNode_,this.indexMap_=indexMap_,this.lazyHash_=null,this.priorityNode_&&validatePriorityNode(this.priorityNode_),this.children_.isEmpty()&&util.assert(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}return Object.defineProperty(ChildrenNode,"EMPTY_NODE",{get:function(){return EMPTY_NODE||(EMPTY_NODE=new ChildrenNode(new SortedMap(NAME_COMPARATOR),null,IndexMap.Default))},enumerable:!1,configurable:!0}),ChildrenNode.prototype.isLeafNode=function(){return!1},ChildrenNode.prototype.getPriority=function(){return this.priorityNode_||EMPTY_NODE},ChildrenNode.prototype.updatePriority=function(newPriorityNode){return this.children_.isEmpty()?this:new ChildrenNode(this.children_,newPriorityNode,this.indexMap_)},ChildrenNode.prototype.getImmediateChild=function(childName){if(".priority"===childName)return this.getPriority();var child=this.children_.get(childName);return null===child?EMPTY_NODE:child},ChildrenNode.prototype.getChild=function(path){var front=pathGetFront(path);return null===front?this:this.getImmediateChild(front).getChild(pathPopFront(path))},ChildrenNode.prototype.hasChild=function(childName){return null!==this.children_.get(childName)},ChildrenNode.prototype.updateImmediateChild=function(childName,newChildNode){if(util.assert(newChildNode,"We should always be passing snapshot nodes"),".priority"===childName)return this.updatePriority(newChildNode);var namedNode=new NamedNode(childName,newChildNode),newChildren=void 0,newIndexMap=void 0;newChildNode.isEmpty()?(newChildren=this.children_.remove(childName),newIndexMap=this.indexMap_.removeFromIndexes(namedNode,this.children_)):(newChildren=this.children_.insert(childName,newChildNode),newIndexMap=this.indexMap_.addToIndexes(namedNode,this.children_));var newPriority=newChildren.isEmpty()?EMPTY_NODE:this.priorityNode_;return new ChildrenNode(newChildren,newPriority,newIndexMap)},ChildrenNode.prototype.updateChild=function(path,newChildNode){var front=pathGetFront(path);if(null===front)return newChildNode;util.assert(".priority"!==pathGetFront(path)||1===pathGetLength(path),".priority must be the last token in a path");var newImmediateChild=this.getImmediateChild(front).updateChild(pathPopFront(path),newChildNode);return this.updateImmediateChild(front,newImmediateChild)},ChildrenNode.prototype.isEmpty=function(){return this.children_.isEmpty()},ChildrenNode.prototype.numChildren=function(){return this.children_.count()},ChildrenNode.prototype.val=function(exportFormat){if(this.isEmpty())return null;var obj={},numKeys=0,maxKey=0,allIntegerKeys=!0;if(this.forEachChild(PRIORITY_INDEX,function(key,childNode){obj[key]=childNode.val(exportFormat),numKeys++,allIntegerKeys&&ChildrenNode.INTEGER_REGEXP_.test(key)?maxKey=Math.max(maxKey,Number(key)):allIntegerKeys=!1}),!exportFormat&&allIntegerKeys&&maxKey<2*numKeys){var array=[];for(var key in obj)array[key]=obj[key];return array}return exportFormat&&!this.getPriority().isEmpty()&&(obj[".priority"]=this.getPriority().val()),obj},ChildrenNode.prototype.hash=function(){if(null===this.lazyHash_){var toHash_1="";this.getPriority().isEmpty()||(toHash_1+="priority:"+priorityHashText(this.getPriority().val())+":"),this.forEachChild(PRIORITY_INDEX,function(key,childNode){var childHash=childNode.hash();""!==childHash&&(toHash_1+=":"+key+":"+childHash)}),this.lazyHash_=""===toHash_1?"":sha1(toHash_1)}return this.lazyHash_},ChildrenNode.prototype.getPredecessorChildName=function(childName,childNode,index){var idx=this.resolveIndex_(index);if(idx){var predecessor=idx.getPredecessorKey(new NamedNode(childName,childNode));return predecessor?predecessor.name:null}return this.children_.getPredecessorKey(childName)},ChildrenNode.prototype.getFirstChildName=function(indexDefinition){var idx=this.resolveIndex_(indexDefinition);if(idx){var minKey=idx.minKey();return minKey&&minKey.name}return this.children_.minKey()},ChildrenNode.prototype.getFirstChild=function(indexDefinition){var minKey=this.getFirstChildName(indexDefinition);return minKey?new NamedNode(minKey,this.children_.get(minKey)):null},ChildrenNode.prototype.getLastChildName=function(indexDefinition){var idx=this.resolveIndex_(indexDefinition);if(idx){var maxKey=idx.maxKey();return maxKey&&maxKey.name}return this.children_.maxKey()},ChildrenNode.prototype.getLastChild=function(indexDefinition){var maxKey=this.getLastChildName(indexDefinition);return maxKey?new NamedNode(maxKey,this.children_.get(maxKey)):null},ChildrenNode.prototype.forEachChild=function(index,action){var idx=this.resolveIndex_(index);return idx?idx.inorderTraversal(function(wrappedNode){return action(wrappedNode.name,wrappedNode.node)}):this.children_.inorderTraversal(action)},ChildrenNode.prototype.getIterator=function(indexDefinition){return this.getIteratorFrom(indexDefinition.minPost(),indexDefinition)},ChildrenNode.prototype.getIteratorFrom=function(startPost,indexDefinition){var idx=this.resolveIndex_(indexDefinition);if(idx)return idx.getIteratorFrom(startPost,function(key){return key});for(var iterator=this.children_.getIteratorFrom(startPost.name,NamedNode.Wrap),next=iterator.peek();null!=next&&indexDefinition.compare(next,startPost)<0;)iterator.getNext(),next=iterator.peek();return iterator},ChildrenNode.prototype.getReverseIterator=function(indexDefinition){return this.getReverseIteratorFrom(indexDefinition.maxPost(),indexDefinition)},ChildrenNode.prototype.getReverseIteratorFrom=function(endPost,indexDefinition){var idx=this.resolveIndex_(indexDefinition);if(idx)return idx.getReverseIteratorFrom(endPost,function(key){return key});for(var iterator=this.children_.getReverseIteratorFrom(endPost.name,NamedNode.Wrap),next=iterator.peek();null!=next&&indexDefinition.compare(next,endPost)>0;)iterator.getNext(),next=iterator.peek();return iterator},ChildrenNode.prototype.compareTo=function(other){return this.isEmpty()?other.isEmpty()?0:-1:other.isLeafNode()||other.isEmpty()?1:other===MAX_NODE?-1:0},ChildrenNode.prototype.withIndex=function(indexDefinition){if(indexDefinition===KEY_INDEX||this.indexMap_.hasIndex(indexDefinition))return this;var newIndexMap=this.indexMap_.addIndex(indexDefinition,this.children_);return new ChildrenNode(this.children_,this.priorityNode_,newIndexMap)},ChildrenNode.prototype.isIndexed=function(index){return index===KEY_INDEX||this.indexMap_.hasIndex(index)},ChildrenNode.prototype.equals=function(other){if(other===this)return!0;if(other.isLeafNode())return!1;var otherChildrenNode=other;if(this.getPriority().equals(otherChildrenNode.getPriority())){if(this.children_.count()===otherChildrenNode.children_.count()){for(var thisIter=this.getIterator(PRIORITY_INDEX),otherIter=otherChildrenNode.getIterator(PRIORITY_INDEX),thisCurrent=thisIter.getNext(),otherCurrent=otherIter.getNext();thisCurrent&&otherCurrent;){if(thisCurrent.name!==otherCurrent.name||!thisCurrent.node.equals(otherCurrent.node))return!1;thisCurrent=thisIter.getNext(),otherCurrent=otherIter.getNext()}return null===thisCurrent&&null===otherCurrent}return!1}return!1},ChildrenNode.prototype.resolveIndex_=function(indexDefinition){return indexDefinition===KEY_INDEX?null:this.indexMap_.get(indexDefinition.toString())},ChildrenNode.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/,ChildrenNode}(),MAX_NODE=new(function(_super){function MaxNode(){return _super.call(this,new SortedMap(NAME_COMPARATOR),ChildrenNode.EMPTY_NODE,IndexMap.Default)||this}return tslib.__extends(MaxNode,_super),MaxNode.prototype.compareTo=function(other){return other===this?0:1},MaxNode.prototype.equals=function(other){return other===this},MaxNode.prototype.getPriority=function(){return this},MaxNode.prototype.getImmediateChild=function(childName){return ChildrenNode.EMPTY_NODE},MaxNode.prototype.isEmpty=function(){return!1},MaxNode}(ChildrenNode));Object.defineProperties(NamedNode,{MIN:{value:new NamedNode(MIN_NAME,ChildrenNode.EMPTY_NODE)},MAX:{value:new NamedNode(MAX_NAME,MAX_NODE)}}),KeyIndex.__EMPTY_NODE=ChildrenNode.EMPTY_NODE,LeafNode.__childrenNodeConstructor=ChildrenNode,function setMaxNode$1(val){MAX_NODE$2=val}(MAX_NODE),function setMaxNode(val){MAX_NODE$1=val}(MAX_NODE);function nodeFromJSON(json,priority){if(void 0===priority&&(priority=null),null===json)return ChildrenNode.EMPTY_NODE;if("object"==typeof json&&".priority"in json&&(priority=json[".priority"]),util.assert(null===priority||"string"==typeof priority||"number"==typeof priority||"object"==typeof priority&&".sv"in priority,"Invalid priority type found: "+typeof priority),"object"==typeof json&&".value"in json&&null!==json[".value"]&&(json=json[".value"]),"object"!=typeof json||".sv"in json)return new LeafNode(json,nodeFromJSON(priority));if(json instanceof Array){var node_1=ChildrenNode.EMPTY_NODE;return each(json,function(key,childData){if(util.contains(json,key)&&"."!==key.substring(0,1)){var childNode=nodeFromJSON(childData);!childNode.isLeafNode()&&childNode.isEmpty()||(node_1=node_1.updateImmediateChild(key,childNode))}}),node_1.updatePriority(nodeFromJSON(priority))}var children_1=[],childrenHavePriority_1=!1;if(each(json,function(key,child){if("."!==key.substring(0,1)){var childNode=nodeFromJSON(child);childNode.isEmpty()||(childrenHavePriority_1=childrenHavePriority_1||!childNode.getPriority().isEmpty(),children_1.push(new NamedNode(key,childNode)))}}),0===children_1.length)return ChildrenNode.EMPTY_NODE;var childSet=buildChildSet(children_1,NAME_ONLY_COMPARATOR,function(namedNode){return namedNode.name},NAME_COMPARATOR);if(childrenHavePriority_1){var sortedChildSet=buildChildSet(children_1,PRIORITY_INDEX.getCompare());return new ChildrenNode(childSet,nodeFromJSON(priority),new IndexMap({".priority":sortedChildSet},{".priority":PRIORITY_INDEX}))}return new ChildrenNode(childSet,nodeFromJSON(priority),IndexMap.Default)}!function setNodeFromJSON(val){nodeFromJSON$1=val}(nodeFromJSON);var lastPushTime,lastRandChars,PathIndex=function(_super){function PathIndex(indexPath_){var _this=_super.call(this)||this;return _this.indexPath_=indexPath_,util.assert(!pathIsEmpty(indexPath_)&&".priority"!==pathGetFront(indexPath_),"Can't create PathIndex with empty path or .priority key"),_this}return tslib.__extends(PathIndex,_super),PathIndex.prototype.extractChild=function(snap){return snap.getChild(this.indexPath_)},PathIndex.prototype.isDefinedOn=function(node){return!node.getChild(this.indexPath_).isEmpty()},PathIndex.prototype.compare=function(a,b){var aChild=this.extractChild(a.node),bChild=this.extractChild(b.node),indexCmp=aChild.compareTo(bChild);return 0===indexCmp?nameCompare(a.name,b.name):indexCmp},PathIndex.prototype.makePost=function(indexValue,name){var valueNode=nodeFromJSON(indexValue),node=ChildrenNode.EMPTY_NODE.updateChild(this.indexPath_,valueNode);return new NamedNode(name,node)},PathIndex.prototype.maxPost=function(){var node=ChildrenNode.EMPTY_NODE.updateChild(this.indexPath_,MAX_NODE);return new NamedNode(MAX_NAME,node)},PathIndex.prototype.toString=function(){return pathSlice(this.indexPath_,0).join("/")},PathIndex}(Index),VALUE_INDEX=new(function(_super){function ValueIndex(){return null!==_super&&_super.apply(this,arguments)||this}return tslib.__extends(ValueIndex,_super),ValueIndex.prototype.compare=function(a,b){var indexCmp=a.node.compareTo(b.node);return 0===indexCmp?nameCompare(a.name,b.name):indexCmp},ValueIndex.prototype.isDefinedOn=function(node){return!0},ValueIndex.prototype.indexedValueChanged=function(oldNode,newNode){return!oldNode.equals(newNode)},ValueIndex.prototype.minPost=function(){return NamedNode.MIN},ValueIndex.prototype.maxPost=function(){return NamedNode.MAX},ValueIndex.prototype.makePost=function(indexValue,name){var valueNode=nodeFromJSON(indexValue);return new NamedNode(name,valueNode)},ValueIndex.prototype.toString=function(){return".value"},ValueIndex}(Index)),PUSH_CHARS="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",nextPushId=(lastPushTime=0,lastRandChars=[],function(now){var i,duplicateTime=now===lastPushTime;lastPushTime=now;var timeStampChars=new Array(8);for(i=7;i>=0;i--)timeStampChars[i]=PUSH_CHARS.charAt(now%64),now=Math.floor(now/64);util.assert(0===now,"Cannot push at time == 0");var id=timeStampChars.join("");if(duplicateTime){for(i=11;i>=0&&63===lastRandChars[i];i--)lastRandChars[i]=0;lastRandChars[i]++}else for(i=0;i<12;i++)lastRandChars[i]=Math.floor(64*Math.random());for(i=0;i<12;i++)id+=PUSH_CHARS.charAt(lastRandChars[i]);return util.assert(20===id.length,"nextPushId: Length should be 20."),id}),successor=function(key){if("2147483647"===key)return"-";var keyAsInt=tryParseInt(key);if(null!=keyAsInt)return""+(keyAsInt+1);for(var next=new Array(key.length),i_1=0;i_1<next.length;i_1++)next[i_1]=key.charAt(i_1);if(next.length<786)return next.push("-"),next.join("");for(var i=next.length-1;i>=0&&"z"===next[i];)i--;if(-1===i)return MAX_NAME;var source=next[i],sourcePlusOne=PUSH_CHARS.charAt(PUSH_CHARS.indexOf(source)+1);return next[i]=sourcePlusOne,next.slice(0,i+1).join("")},predecessor=function(key){if("-2147483648"===key)return MIN_NAME;var keyAsInt=tryParseInt(key);if(null!=keyAsInt)return""+(keyAsInt-1);for(var next=new Array(key.length),i=0;i<next.length;i++)next[i]=key.charAt(i);return"-"===next[next.length-1]?1===next.length?"2147483647":(delete next[next.length-1],next.join("")):(next[next.length-1]=PUSH_CHARS.charAt(PUSH_CHARS.indexOf(next[next.length-1])-1),next.join("")+"z".repeat(786-next.length))};function changeValue(snapshotNode){return{type:"value",snapshotNode:snapshotNode}}function changeChildAdded(childName,snapshotNode){return{type:"child_added",snapshotNode:snapshotNode,childName:childName}}function changeChildRemoved(childName,snapshotNode){return{type:"child_removed",snapshotNode:snapshotNode,childName:childName}}function changeChildChanged(childName,snapshotNode,oldSnap){return{type:"child_changed",snapshotNode:snapshotNode,childName:childName,oldSnap:oldSnap}}var IndexedFilter=function(){function IndexedFilter(index_){this.index_=index_}return IndexedFilter.prototype.updateChild=function(snap,key,newChild,affectedPath,source,optChangeAccumulator){util.assert(snap.isIndexed(this.index_),"A node must be indexed if only a child is updated");var oldChild=snap.getImmediateChild(key);return oldChild.getChild(affectedPath).equals(newChild.getChild(affectedPath))&&oldChild.isEmpty()===newChild.isEmpty()?snap:(null!=optChangeAccumulator&&(newChild.isEmpty()?snap.hasChild(key)?optChangeAccumulator.trackChildChange(changeChildRemoved(key,oldChild)):util.assert(snap.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):oldChild.isEmpty()?optChangeAccumulator.trackChildChange(changeChildAdded(key,newChild)):optChangeAccumulator.trackChildChange(changeChildChanged(key,newChild,oldChild))),snap.isLeafNode()&&newChild.isEmpty()?snap:snap.updateImmediateChild(key,newChild).withIndex(this.index_))},IndexedFilter.prototype.updateFullNode=function(oldSnap,newSnap,optChangeAccumulator){return null!=optChangeAccumulator&&(oldSnap.isLeafNode()||oldSnap.forEachChild(PRIORITY_INDEX,function(key,childNode){newSnap.hasChild(key)||optChangeAccumulator.trackChildChange(changeChildRemoved(key,childNode))}),newSnap.isLeafNode()||newSnap.forEachChild(PRIORITY_INDEX,function(key,childNode){if(oldSnap.hasChild(key)){var oldChild=oldSnap.getImmediateChild(key);oldChild.equals(childNode)||optChangeAccumulator.trackChildChange(changeChildChanged(key,childNode,oldChild))}else optChangeAccumulator.trackChildChange(changeChildAdded(key,childNode))})),newSnap.withIndex(this.index_)},IndexedFilter.prototype.updatePriority=function(oldSnap,newPriority){return oldSnap.isEmpty()?ChildrenNode.EMPTY_NODE:oldSnap.updatePriority(newPriority)},IndexedFilter.prototype.filtersNodes=function(){return!1},IndexedFilter.prototype.getIndexedFilter=function(){return this},IndexedFilter.prototype.getIndex=function(){return this.index_},IndexedFilter}(),RangedFilter=function(){function RangedFilter(params){this.indexedFilter_=new IndexedFilter(params.getIndex()),this.index_=params.getIndex(),this.startPost_=RangedFilter.getStartPost_(params),this.endPost_=RangedFilter.getEndPost_(params)}return RangedFilter.prototype.getStartPost=function(){return this.startPost_},RangedFilter.prototype.getEndPost=function(){return this.endPost_},RangedFilter.prototype.matches=function(node){return this.index_.compare(this.getStartPost(),node)<=0&&this.index_.compare(node,this.getEndPost())<=0},RangedFilter.prototype.updateChild=function(snap,key,newChild,affectedPath,source,optChangeAccumulator){return this.matches(new NamedNode(key,newChild))||(newChild=ChildrenNode.EMPTY_NODE),this.indexedFilter_.updateChild(snap,key,newChild,affectedPath,source,optChangeAccumulator)},RangedFilter.prototype.updateFullNode=function(oldSnap,newSnap,optChangeAccumulator){newSnap.isLeafNode()&&(newSnap=ChildrenNode.EMPTY_NODE);var filtered=newSnap.withIndex(this.index_);filtered=filtered.updatePriority(ChildrenNode.EMPTY_NODE);var self=this;return newSnap.forEachChild(PRIORITY_INDEX,function(key,childNode){self.matches(new NamedNode(key,childNode))||(filtered=filtered.updateImmediateChild(key,ChildrenNode.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(oldSnap,filtered,optChangeAccumulator)},RangedFilter.prototype.updatePriority=function(oldSnap,newPriority){return oldSnap},RangedFilter.prototype.filtersNodes=function(){return!0},RangedFilter.prototype.getIndexedFilter=function(){return this.indexedFilter_},RangedFilter.prototype.getIndex=function(){return this.index_},RangedFilter.getStartPost_=function(params){if(params.hasStart()){var startName=params.getIndexStartName();return params.getIndex().makePost(params.getIndexStartValue(),startName)}return params.getIndex().minPost()},RangedFilter.getEndPost_=function(params){if(params.hasEnd()){var endName=params.getIndexEndName();return params.getIndex().makePost(params.getIndexEndValue(),endName)}return params.getIndex().maxPost()},RangedFilter}(),LimitedFilter=function(){function LimitedFilter(params){this.rangedFilter_=new RangedFilter(params),this.index_=params.getIndex(),this.limit_=params.getLimit(),this.reverse_=!params.isViewFromLeft()}return LimitedFilter.prototype.updateChild=function(snap,key,newChild,affectedPath,source,optChangeAccumulator){return this.rangedFilter_.matches(new NamedNode(key,newChild))||(newChild=ChildrenNode.EMPTY_NODE),snap.getImmediateChild(key).equals(newChild)?snap:snap.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(snap,key,newChild,affectedPath,source,optChangeAccumulator):this.fullLimitUpdateChild_(snap,key,newChild,source,optChangeAccumulator)},LimitedFilter.prototype.updateFullNode=function(oldSnap,newSnap,optChangeAccumulator){var filtered;if(newSnap.isLeafNode()||newSnap.isEmpty())filtered=ChildrenNode.EMPTY_NODE.withIndex(this.index_);else if(2*this.limit_<newSnap.numChildren()&&newSnap.isIndexed(this.index_)){filtered=ChildrenNode.EMPTY_NODE.withIndex(this.index_);var iterator=void 0;iterator=this.reverse_?newSnap.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):newSnap.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);for(var count=0;iterator.hasNext()&&count<this.limit_;){var next=iterator.getNext();if(!(this.reverse_?this.index_.compare(this.rangedFilter_.getStartPost(),next)<=0:this.index_.compare(next,this.rangedFilter_.getEndPost())<=0))break;filtered=filtered.updateImmediateChild(next.name,next.node),count++}}else{filtered=(filtered=newSnap.withIndex(this.index_)).updatePriority(ChildrenNode.EMPTY_NODE);var startPost=void 0,endPost=void 0,cmp=void 0;iterator=void 0;if(this.reverse_){iterator=filtered.getReverseIterator(this.index_),startPost=this.rangedFilter_.getEndPost(),endPost=this.rangedFilter_.getStartPost();var indexCompare_1=this.index_.getCompare();cmp=function(a,b){return indexCompare_1(b,a)}}else iterator=filtered.getIterator(this.index_),startPost=this.rangedFilter_.getStartPost(),endPost=this.rangedFilter_.getEndPost(),cmp=this.index_.getCompare();count=0;for(var foundStartPost=!1;iterator.hasNext();){next=iterator.getNext();!foundStartPost&&cmp(startPost,next)<=0&&(foundStartPost=!0),foundStartPost&&count<this.limit_&&cmp(next,endPost)<=0?count++:filtered=filtered.updateImmediateChild(next.name,ChildrenNode.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(oldSnap,filtered,optChangeAccumulator)},LimitedFilter.prototype.updatePriority=function(oldSnap,newPriority){return oldSnap},LimitedFilter.prototype.filtersNodes=function(){return!0},LimitedFilter.prototype.getIndexedFilter=function(){return this.rangedFilter_.getIndexedFilter()},LimitedFilter.prototype.getIndex=function(){return this.index_},LimitedFilter.prototype.fullLimitUpdateChild_=function(snap,childKey,childSnap,source,changeAccumulator){var cmp;if(this.reverse_){var indexCmp_1=this.index_.getCompare();cmp=function(a,b){return indexCmp_1(b,a)}}else cmp=this.index_.getCompare();var oldEventCache=snap;util.assert(oldEventCache.numChildren()===this.limit_,"");var newChildNamedNode=new NamedNode(childKey,childSnap),windowBoundary=this.reverse_?oldEventCache.getFirstChild(this.index_):oldEventCache.getLastChild(this.index_),inRange=this.rangedFilter_.matches(newChildNamedNode);if(oldEventCache.hasChild(childKey)){for(var oldChildSnap=oldEventCache.getImmediateChild(childKey),nextChild=source.getChildAfterChild(this.index_,windowBoundary,this.reverse_);null!=nextChild&&(nextChild.name===childKey||oldEventCache.hasChild(nextChild.name));)nextChild=source.getChildAfterChild(this.index_,nextChild,this.reverse_);var compareNext=null==nextChild?1:cmp(nextChild,newChildNamedNode);if(inRange&&!childSnap.isEmpty()&&compareNext>=0)return null!=changeAccumulator&&changeAccumulator.trackChildChange(changeChildChanged(childKey,childSnap,oldChildSnap)),oldEventCache.updateImmediateChild(childKey,childSnap);null!=changeAccumulator&&changeAccumulator.trackChildChange(changeChildRemoved(childKey,oldChildSnap));var newEventCache=oldEventCache.updateImmediateChild(childKey,ChildrenNode.EMPTY_NODE);return null!=nextChild&&this.rangedFilter_.matches(nextChild)?(null!=changeAccumulator&&changeAccumulator.trackChildChange(changeChildAdded(nextChild.name,nextChild.node)),newEventCache.updateImmediateChild(nextChild.name,nextChild.node)):newEventCache}return childSnap.isEmpty()?snap:inRange&&cmp(windowBoundary,newChildNamedNode)>=0?(null!=changeAccumulator&&(changeAccumulator.trackChildChange(changeChildRemoved(windowBoundary.name,windowBoundary.node)),changeAccumulator.trackChildChange(changeChildAdded(childKey,childSnap))),oldEventCache.updateImmediateChild(childKey,childSnap).updateImmediateChild(windowBoundary.name,ChildrenNode.EMPTY_NODE)):snap},LimitedFilter}(),QueryParams=function(){function QueryParams(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=PRIORITY_INDEX}return QueryParams.prototype.hasStart=function(){return this.startSet_},QueryParams.prototype.hasStartAfter=function(){return this.startAfterSet_},QueryParams.prototype.hasEndBefore=function(){return this.endBeforeSet_},QueryParams.prototype.isViewFromLeft=function(){return""===this.viewFrom_?this.startSet_:"l"===this.viewFrom_},QueryParams.prototype.getIndexStartValue=function(){return util.assert(this.startSet_,"Only valid if start has been set"),this.indexStartValue_},QueryParams.prototype.getIndexStartName=function(){return util.assert(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:MIN_NAME},QueryParams.prototype.hasEnd=function(){return this.endSet_},QueryParams.prototype.getIndexEndValue=function(){return util.assert(this.endSet_,"Only valid if end has been set"),this.indexEndValue_},QueryParams.prototype.getIndexEndName=function(){return util.assert(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:MAX_NAME},QueryParams.prototype.hasLimit=function(){return this.limitSet_},QueryParams.prototype.hasAnchoredLimit=function(){return this.limitSet_&&""!==this.viewFrom_},QueryParams.prototype.getLimit=function(){return util.assert(this.limitSet_,"Only valid if limit has been set"),this.limit_},QueryParams.prototype.getIndex=function(){return this.index_},QueryParams.prototype.loadsAllData=function(){return!(this.startSet_||this.endSet_||this.limitSet_)},QueryParams.prototype.isDefault=function(){return this.loadsAllData()&&this.index_===PRIORITY_INDEX},QueryParams.prototype.copy=function(){var copy=new QueryParams;return copy.limitSet_=this.limitSet_,copy.limit_=this.limit_,copy.startSet_=this.startSet_,copy.indexStartValue_=this.indexStartValue_,copy.startNameSet_=this.startNameSet_,copy.indexStartName_=this.indexStartName_,copy.endSet_=this.endSet_,copy.indexEndValue_=this.indexEndValue_,copy.endNameSet_=this.endNameSet_,copy.indexEndName_=this.indexEndName_,copy.index_=this.index_,copy.viewFrom_=this.viewFrom_,copy},QueryParams}();function queryParamsStartAt(queryParams,indexValue,key){var newParams=queryParams.copy();return newParams.startSet_=!0,void 0===indexValue&&(indexValue=null),newParams.indexStartValue_=indexValue,null!=key?(newParams.startNameSet_=!0,newParams.indexStartName_=key):(newParams.startNameSet_=!1,newParams.indexStartName_=""),newParams}function queryParamsEndAt(queryParams,indexValue,key){var newParams=queryParams.copy();return newParams.endSet_=!0,void 0===indexValue&&(indexValue=null),newParams.indexEndValue_=indexValue,void 0!==key?(newParams.endNameSet_=!0,newParams.indexEndName_=key):(newParams.endNameSet_=!1,newParams.indexEndName_=""),newParams}function queryParamsOrderBy(queryParams,index){var newParams=queryParams.copy();return newParams.index_=index,newParams}function queryParamsToRestQueryStringParameters(queryParams){var orderBy,qs={};return queryParams.isDefault()||(queryParams.index_===PRIORITY_INDEX?orderBy="$priority":queryParams.index_===VALUE_INDEX?orderBy="$value":queryParams.index_===KEY_INDEX?orderBy="$key":(util.assert(queryParams.index_ instanceof PathIndex,"Unrecognized index type!"),orderBy=queryParams.index_.toString()),qs.orderBy=util.stringify(orderBy),queryParams.startSet_&&(qs.startAt=util.stringify(queryParams.indexStartValue_),queryParams.startNameSet_&&(qs.startAt+=","+util.stringify(queryParams.indexStartName_))),queryParams.endSet_&&(qs.endAt=util.stringify(queryParams.indexEndValue_),queryParams.endNameSet_&&(qs.endAt+=","+util.stringify(queryParams.indexEndName_))),queryParams.limitSet_&&(queryParams.isViewFromLeft()?qs.limitToFirst=queryParams.limit_:qs.limitToLast=queryParams.limit_)),qs}function queryParamsGetQueryObject(queryParams){var obj={};if(queryParams.startSet_&&(obj.sp=queryParams.indexStartValue_,queryParams.startNameSet_&&(obj.sn=queryParams.indexStartName_)),queryParams.endSet_&&(obj.ep=queryParams.indexEndValue_,queryParams.endNameSet_&&(obj.en=queryParams.indexEndName_)),queryParams.limitSet_){obj.l=queryParams.limit_;var viewFrom=queryParams.viewFrom_;""===viewFrom&&(viewFrom=queryParams.isViewFromLeft()?"l":"r"),obj.vf=viewFrom}return queryParams.index_!==PRIORITY_INDEX&&(obj.i=queryParams.index_.toString()),obj}var ReadonlyRestClient=function(_super){function ReadonlyRestClient(repoInfo_,onDataUpdate_,authTokenProvider_,appCheckTokenProvider_){var _this=_super.call(this)||this;return _this.repoInfo_=repoInfo_,_this.onDataUpdate_=onDataUpdate_,_this.authTokenProvider_=authTokenProvider_,_this.appCheckTokenProvider_=appCheckTokenProvider_,_this.log_=logWrapper("p:rest:"),_this.listens_={},_this}return tslib.__extends(ReadonlyRestClient,_super),ReadonlyRestClient.prototype.reportStats=function(stats){throw new Error("Method not implemented.")},ReadonlyRestClient.getListenId_=function(query,tag){return void 0!==tag?"tag$"+tag:(util.assert(query._queryParams.isDefault(),"should have a tag if it's not a default query."),query._path.toString())},ReadonlyRestClient.prototype.listen=function(query,currentHashFn,tag,onComplete){var _this=this,pathString=query._path.toString();this.log_("Listen called for "+pathString+" "+query._queryIdentifier);var listenId=ReadonlyRestClient.getListenId_(query,tag),thisListen={};this.listens_[listenId]=thisListen;var queryStringParameters=queryParamsToRestQueryStringParameters(query._queryParams);this.restRequest_(pathString+".json",queryStringParameters,function(error,result){var data=result;(404===error&&(data=null,error=null),null===error&&_this.onDataUpdate_(pathString,data,!1,tag),util.safeGet(_this.listens_,listenId)===thisListen)&&onComplete(error?401===error?"permission_denied":"rest_error:"+error:"ok",null)})},ReadonlyRestClient.prototype.unlisten=function(query,tag){var listenId=ReadonlyRestClient.getListenId_(query,tag);delete this.listens_[listenId]},ReadonlyRestClient.prototype.get=function(query){var _this=this,queryStringParameters=queryParamsToRestQueryStringParameters(query._queryParams),pathString=query._path.toString(),deferred=new util.Deferred;return this.restRequest_(pathString+".json",queryStringParameters,function(error,result){var data=result;404===error&&(data=null,error=null),null===error?(_this.onDataUpdate_(pathString,data,!1,null),deferred.resolve(data)):deferred.reject(new Error(data))}),deferred.promise},ReadonlyRestClient.prototype.refreshAuthToken=function(token){},ReadonlyRestClient.prototype.restRequest_=function(pathString,queryStringParameters,callback){var _this=this;return void 0===queryStringParameters&&(queryStringParameters={}),queryStringParameters.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(function(_a){var _b=tslib.__read(_a,2),authToken=_b[0],appCheckToken=_b[1];authToken&&authToken.accessToken&&(queryStringParameters.auth=authToken.accessToken),appCheckToken&&appCheckToken.token&&(queryStringParameters.ac=appCheckToken.token);var url=(_this.repoInfo_.secure?"https://":"http://")+_this.repoInfo_.host+pathString+"?ns="+_this.repoInfo_.namespace+util.querystring(queryStringParameters);_this.log_("Sending REST request for "+url);var xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){if(callback&&4===xhr.readyState){_this.log_("REST Response for "+url+" received. status:",xhr.status,"response:",xhr.responseText);var res=null;if(xhr.status>=200&&xhr.status<300){try{res=util.jsonEval(xhr.responseText)}catch(e){warn("Failed to parse JSON response for "+url+": "+xhr.responseText)}callback(null,res)}else 401!==xhr.status&&404!==xhr.status&&warn("Got unsuccessful REST response for "+url+" Status: "+xhr.status),callback(xhr.status);callback=null}},xhr.open("GET",url,!0),xhr.send()})},ReadonlyRestClient}(ServerActions),SnapshotHolder=function(){function SnapshotHolder(){this.rootNode_=ChildrenNode.EMPTY_NODE}return SnapshotHolder.prototype.getNode=function(path){return this.rootNode_.getChild(path)},SnapshotHolder.prototype.updateSnapshot=function(path,newSnapshotNode){this.rootNode_=this.rootNode_.updateChild(path,newSnapshotNode)},SnapshotHolder}();function newSparseSnapshotTree(){return{value:null,children:new Map}}function sparseSnapshotTreeRemember(sparseSnapshotTree,path,data){if(pathIsEmpty(path))sparseSnapshotTree.value=data,sparseSnapshotTree.children.clear();else if(null!==sparseSnapshotTree.value)sparseSnapshotTree.value=sparseSnapshotTree.value.updateChild(path,data);else{var childKey=pathGetFront(path);sparseSnapshotTree.children.has(childKey)||sparseSnapshotTree.children.set(childKey,newSparseSnapshotTree()),sparseSnapshotTreeRemember(sparseSnapshotTree.children.get(childKey),path=pathPopFront(path),data)}}function sparseSnapshotTreeForget(sparseSnapshotTree,path){if(pathIsEmpty(path))return sparseSnapshotTree.value=null,sparseSnapshotTree.children.clear(),!0;if(null!==sparseSnapshotTree.value){if(sparseSnapshotTree.value.isLeafNode())return!1;var value=sparseSnapshotTree.value;return sparseSnapshotTree.value=null,value.forEachChild(PRIORITY_INDEX,function(key,tree){sparseSnapshotTreeRemember(sparseSnapshotTree,new Path(key),tree)}),sparseSnapshotTreeForget(sparseSnapshotTree,path)}if(sparseSnapshotTree.children.size>0){var childKey=pathGetFront(path);if(path=pathPopFront(path),sparseSnapshotTree.children.has(childKey))sparseSnapshotTreeForget(sparseSnapshotTree.children.get(childKey),path)&&sparseSnapshotTree.children.delete(childKey);return 0===sparseSnapshotTree.children.size}return!0}function sparseSnapshotTreeForEachTree(sparseSnapshotTree,prefixPath,func){null!==sparseSnapshotTree.value?func(prefixPath,sparseSnapshotTree.value):function sparseSnapshotTreeForEachChild(sparseSnapshotTree,func){sparseSnapshotTree.children.forEach(function(tree,key){func(key,tree)})}(sparseSnapshotTree,function(key,tree){sparseSnapshotTreeForEachTree(tree,new Path(prefixPath.toString()+"/"+key),func)})}var OperationType,StatsListener=function(){function StatsListener(collection_){this.collection_=collection_,this.last_=null}return StatsListener.prototype.get=function(){var newStats=this.collection_.get(),delta=tslib.__assign({},newStats);return this.last_&&each(this.last_,function(stat,value){delta[stat]=delta[stat]-value}),this.last_=newStats,delta},StatsListener}(),StatsReporter=function(){function StatsReporter(collection,server_){this.server_=server_,this.statsToReport_={},this.statsListener_=new StatsListener(collection);var timeout=1e4+2e4*Math.random();setTimeoutNonBlocking(this.reportStats_.bind(this),Math.floor(timeout))}return StatsReporter.prototype.reportStats_=function(){var _this=this,stats=this.statsListener_.get(),reportedStats={},haveStatsToReport=!1;each(stats,function(stat,value){value>0&&util.contains(_this.statsToReport_,stat)&&(reportedStats[stat]=value,haveStatsToReport=!0)}),haveStatsToReport&&this.server_.reportStats(reportedStats),setTimeoutNonBlocking(this.reportStats_.bind(this),Math.floor(2*Math.random()*3e5))},StatsReporter}();function newOperationSourceServerTaggedQuery(queryId){return{fromUser:!1,fromServer:!0,queryId:queryId,tagged:!0}}!function(OperationType){OperationType[OperationType.OVERWRITE=0]="OVERWRITE",OperationType[OperationType.MERGE=1]="MERGE",OperationType[OperationType.ACK_USER_WRITE=2]="ACK_USER_WRITE",OperationType[OperationType.LISTEN_COMPLETE=3]="LISTEN_COMPLETE"}(OperationType||(OperationType={}));var emptyChildrenSingleton,AckUserWrite=function(){function AckUserWrite(path,affectedTree,revert){this.path=path,this.affectedTree=affectedTree,this.revert=revert,this.type=OperationType.ACK_USER_WRITE,this.source={fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}return AckUserWrite.prototype.operationForChild=function(childName){if(pathIsEmpty(this.path)){if(null!=this.affectedTree.value)return util.assert(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;var childTree=this.affectedTree.subtree(new Path(childName));return new AckUserWrite(newEmptyPath(),childTree,this.revert)}return util.assert(pathGetFront(this.path)===childName,"operationForChild called for unrelated child."),new AckUserWrite(pathPopFront(this.path),this.affectedTree,this.revert)},AckUserWrite}(),ListenComplete=function(){function ListenComplete(source,path){this.source=source,this.path=path,this.type=OperationType.LISTEN_COMPLETE}return ListenComplete.prototype.operationForChild=function(childName){return pathIsEmpty(this.path)?new ListenComplete(this.source,newEmptyPath()):new ListenComplete(this.source,pathPopFront(this.path))},ListenComplete}(),Overwrite=function(){function Overwrite(source,path,snap){this.source=source,this.path=path,this.snap=snap,this.type=OperationType.OVERWRITE}return Overwrite.prototype.operationForChild=function(childName){return pathIsEmpty(this.path)?new Overwrite(this.source,newEmptyPath(),this.snap.getImmediateChild(childName)):new Overwrite(this.source,pathPopFront(this.path),this.snap)},Overwrite}(),Merge=function(){function Merge(source,path,children){this.source=source,this.path=path,this.children=children,this.type=OperationType.MERGE}return Merge.prototype.operationForChild=function(childName){if(pathIsEmpty(this.path)){var childTree=this.children.subtree(new Path(childName));return childTree.isEmpty()?null:childTree.value?new Overwrite(this.source,newEmptyPath(),childTree.value):new Merge(this.source,newEmptyPath(),childTree)}return util.assert(pathGetFront(this.path)===childName,"Can't get a merge for a child not on the path of the operation"),new Merge(this.source,pathPopFront(this.path),this.children)},Merge.prototype.toString=function(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"},Merge}(),CacheNode=function(){function CacheNode(node_,fullyInitialized_,filtered_){this.node_=node_,this.fullyInitialized_=fullyInitialized_,this.filtered_=filtered_}return CacheNode.prototype.isFullyInitialized=function(){return this.fullyInitialized_},CacheNode.prototype.isFiltered=function(){return this.filtered_},CacheNode.prototype.isCompleteForPath=function(path){if(pathIsEmpty(path))return this.isFullyInitialized()&&!this.filtered_;var childKey=pathGetFront(path);return this.isCompleteForChild(childKey)},CacheNode.prototype.isCompleteForChild=function(key){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(key)},CacheNode.prototype.getNode=function(){return this.node_},CacheNode}(),EventGenerator=function EventGenerator(query_){this.query_=query_,this.index_=this.query_._queryParams.getIndex()};function eventGeneratorGenerateEventsForType(eventGenerator,events,eventType,changes,registrations,eventCache){var filteredChanges=changes.filter(function(change){return change.type===eventType});filteredChanges.sort(function(a,b){return function eventGeneratorCompareChanges(eventGenerator,a,b){if(null==a.childName||null==b.childName)throw util.assertionError("Should only compare child_ events.");var aWrapped=new NamedNode(a.childName,a.snapshotNode),bWrapped=new NamedNode(b.childName,b.snapshotNode);return eventGenerator.index_.compare(aWrapped,bWrapped)}(eventGenerator,a,b)}),filteredChanges.forEach(function(change){var materializedChange=function eventGeneratorMaterializeSingleChange(eventGenerator,change,eventCache){return"value"===change.type||"child_removed"===change.type||(change.prevName=eventCache.getPredecessorChildName(change.childName,change.snapshotNode,eventGenerator.index_)),change}(eventGenerator,change,eventCache);registrations.forEach(function(registration){registration.respondsTo(change.type)&&events.push(registration.createEvent(materializedChange,eventGenerator.query_))})})}function newViewCache(eventCache,serverCache){return{eventCache:eventCache,serverCache:serverCache}}function viewCacheUpdateEventSnap(viewCache,eventSnap,complete,filtered){return newViewCache(new CacheNode(eventSnap,complete,filtered),viewCache.serverCache)}function viewCacheUpdateServerSnap(viewCache,serverSnap,complete,filtered){return newViewCache(viewCache.eventCache,new CacheNode(serverSnap,complete,filtered))}function viewCacheGetCompleteEventSnap(viewCache){return viewCache.eventCache.isFullyInitialized()?viewCache.eventCache.getNode():null}function viewCacheGetCompleteServerSnap(viewCache){return viewCache.serverCache.isFullyInitialized()?viewCache.serverCache.getNode():null}var ImmutableTree=function(){function ImmutableTree(value,children){void 0===children&&(emptyChildrenSingleton||(emptyChildrenSingleton=new SortedMap(stringCompare)),children=emptyChildrenSingleton),this.value=value,this.children=children}return ImmutableTree.fromObject=function(obj){var tree=new ImmutableTree(null);return each(obj,function(childPath,childSnap){tree=tree.set(new Path(childPath),childSnap)}),tree},ImmutableTree.prototype.isEmpty=function(){return null===this.value&&this.children.isEmpty()},ImmutableTree.prototype.findRootMostMatchingPathAndValue=function(relativePath,predicate){if(null!=this.value&&predicate(this.value))return{path:newEmptyPath(),value:this.value};if(pathIsEmpty(relativePath))return null;var front=pathGetFront(relativePath),child=this.children.get(front);if(null!==child){var childExistingPathAndValue=child.findRootMostMatchingPathAndValue(pathPopFront(relativePath),predicate);return null!=childExistingPathAndValue?{path:pathChild(new Path(front),childExistingPathAndValue.path),value:childExistingPathAndValue.value}:null}return null},ImmutableTree.prototype.findRootMostValueAndPath=function(relativePath){return this.findRootMostMatchingPathAndValue(relativePath,function(){return!0})},ImmutableTree.prototype.subtree=function(relativePath){if(pathIsEmpty(relativePath))return this;var front=pathGetFront(relativePath),childTree=this.children.get(front);return null!==childTree?childTree.subtree(pathPopFront(relativePath)):new ImmutableTree(null)},ImmutableTree.prototype.set=function(relativePath,toSet){if(pathIsEmpty(relativePath))return new ImmutableTree(toSet,this.children);var front=pathGetFront(relativePath),newChild=(this.children.get(front)||new ImmutableTree(null)).set(pathPopFront(relativePath),toSet),newChildren=this.children.insert(front,newChild);return new ImmutableTree(this.value,newChildren)},ImmutableTree.prototype.remove=function(relativePath){if(pathIsEmpty(relativePath))return this.children.isEmpty()?new ImmutableTree(null):new ImmutableTree(null,this.children);var front=pathGetFront(relativePath),child=this.children.get(front);if(child){var newChild=child.remove(pathPopFront(relativePath)),newChildren=void 0;return newChildren=newChild.isEmpty()?this.children.remove(front):this.children.insert(front,newChild),null===this.value&&newChildren.isEmpty()?new ImmutableTree(null):new ImmutableTree(this.value,newChildren)}return this},ImmutableTree.prototype.get=function(relativePath){if(pathIsEmpty(relativePath))return this.value;var front=pathGetFront(relativePath),child=this.children.get(front);return child?child.get(pathPopFront(relativePath)):null},ImmutableTree.prototype.setTree=function(relativePath,newTree){if(pathIsEmpty(relativePath))return newTree;var front=pathGetFront(relativePath),newChild=(this.children.get(front)||new ImmutableTree(null)).setTree(pathPopFront(relativePath),newTree),newChildren=void 0;return newChildren=newChild.isEmpty()?this.children.remove(front):this.children.insert(front,newChild),new ImmutableTree(this.value,newChildren)},ImmutableTree.prototype.fold=function(fn){return this.fold_(newEmptyPath(),fn)},ImmutableTree.prototype.fold_=function(pathSoFar,fn){var accum={};return this.children.inorderTraversal(function(childKey,childTree){accum[childKey]=childTree.fold_(pathChild(pathSoFar,childKey),fn)}),fn(pathSoFar,this.value,accum)},ImmutableTree.prototype.findOnPath=function(path,f){return this.findOnPath_(path,newEmptyPath(),f)},ImmutableTree.prototype.findOnPath_=function(pathToFollow,pathSoFar,f){var result=!!this.value&&f(pathSoFar,this.value);if(result)return result;if(pathIsEmpty(pathToFollow))return null;var front=pathGetFront(pathToFollow),nextChild=this.children.get(front);return nextChild?nextChild.findOnPath_(pathPopFront(pathToFollow),pathChild(pathSoFar,front),f):null},ImmutableTree.prototype.foreachOnPath=function(path,f){return this.foreachOnPath_(path,newEmptyPath(),f)},ImmutableTree.prototype.foreachOnPath_=function(pathToFollow,currentRelativePath,f){if(pathIsEmpty(pathToFollow))return this;this.value&&f(currentRelativePath,this.value);var front=pathGetFront(pathToFollow),nextChild=this.children.get(front);return nextChild?nextChild.foreachOnPath_(pathPopFront(pathToFollow),pathChild(currentRelativePath,front),f):new ImmutableTree(null)},ImmutableTree.prototype.foreach=function(f){this.foreach_(newEmptyPath(),f)},ImmutableTree.prototype.foreach_=function(currentRelativePath,f){this.children.inorderTraversal(function(childName,childTree){childTree.foreach_(pathChild(currentRelativePath,childName),f)}),this.value&&f(currentRelativePath,this.value)},ImmutableTree.prototype.foreachChild=function(f){this.children.inorderTraversal(function(childName,childTree){childTree.value&&f(childName,childTree.value)})},ImmutableTree}(),CompoundWrite=function(){function CompoundWrite(writeTree_){this.writeTree_=writeTree_}return CompoundWrite.empty=function(){return new CompoundWrite(new ImmutableTree(null))},CompoundWrite}();function compoundWriteAddWrite(compoundWrite,path,node){if(pathIsEmpty(path))return new CompoundWrite(new ImmutableTree(node));var rootmost=compoundWrite.writeTree_.findRootMostValueAndPath(path);if(null!=rootmost){var rootMostPath=rootmost.path,value=rootmost.value,relativePath=newRelativePath(rootMostPath,path);return value=value.updateChild(relativePath,node),new CompoundWrite(compoundWrite.writeTree_.set(rootMostPath,value))}var subtree=new ImmutableTree(node),newWriteTree=compoundWrite.writeTree_.setTree(path,subtree);return new CompoundWrite(newWriteTree)}function compoundWriteAddWrites(compoundWrite,path,updates){var newWrite=compoundWrite;return each(updates,function(childKey,node){newWrite=compoundWriteAddWrite(newWrite,pathChild(path,childKey),node)}),newWrite}function compoundWriteRemoveWrite(compoundWrite,path){if(pathIsEmpty(path))return CompoundWrite.empty();var newWriteTree=compoundWrite.writeTree_.setTree(path,new ImmutableTree(null));return new CompoundWrite(newWriteTree)}function compoundWriteHasCompleteWrite(compoundWrite,path){return null!=compoundWriteGetCompleteNode(compoundWrite,path)}function compoundWriteGetCompleteNode(compoundWrite,path){var rootmost=compoundWrite.writeTree_.findRootMostValueAndPath(path);return null!=rootmost?compoundWrite.writeTree_.get(rootmost.path).getChild(newRelativePath(rootmost.path,path)):null}function compoundWriteGetCompleteChildren(compoundWrite){var children=[],node=compoundWrite.writeTree_.value;return null!=node?node.isLeafNode()||node.forEachChild(PRIORITY_INDEX,function(childName,childNode){children.push(new NamedNode(childName,childNode))}):compoundWrite.writeTree_.children.inorderTraversal(function(childName,childTree){null!=childTree.value&&children.push(new NamedNode(childName,childTree.value))}),children}function compoundWriteChildCompoundWrite(compoundWrite,path){if(pathIsEmpty(path))return compoundWrite;var shadowingNode=compoundWriteGetCompleteNode(compoundWrite,path);return new CompoundWrite(null!=shadowingNode?new ImmutableTree(shadowingNode):compoundWrite.writeTree_.subtree(path))}function compoundWriteIsEmpty(compoundWrite){return compoundWrite.writeTree_.isEmpty()}function compoundWriteApply(compoundWrite,node){return applySubtreeWrite(newEmptyPath(),compoundWrite.writeTree_,node)}function applySubtreeWrite(relativePath,writeTree,node){if(null!=writeTree.value)return node.updateChild(relativePath,writeTree.value);var priorityWrite_1=null;return writeTree.children.inorderTraversal(function(childKey,childTree){".priority"===childKey?(util.assert(null!==childTree.value,"Priority writes must always be leaf nodes"),priorityWrite_1=childTree.value):node=applySubtreeWrite(pathChild(relativePath,childKey),childTree,node)}),node.getChild(relativePath).isEmpty()||null===priorityWrite_1||(node=node.updateChild(pathChild(relativePath,".priority"),priorityWrite_1)),node}function writeTreeChildWrites(writeTree,path){return newWriteTreeRef(path,writeTree)}function writeTreeRemoveWrite(writeTree,writeId){var idx=writeTree.allWrites.findIndex(function(s){return s.writeId===writeId});util.assert(idx>=0,"removeWrite called with nonexistent writeId.");var writeToRemove=writeTree.allWrites[idx];writeTree.allWrites.splice(idx,1);for(var removedWriteWasVisible=writeToRemove.visible,removedWriteOverlapsWithOtherWrites=!1,i=writeTree.allWrites.length-1;removedWriteWasVisible&&i>=0;){var currentWrite=writeTree.allWrites[i];currentWrite.visible&&(i>=idx&&writeTreeRecordContainsPath_(currentWrite,writeToRemove.path)?removedWriteWasVisible=!1:pathContains(writeToRemove.path,currentWrite.path)&&(removedWriteOverlapsWithOtherWrites=!0)),i--}if(removedWriteWasVisible){if(removedWriteOverlapsWithOtherWrites)return function writeTreeResetTree_(writeTree){writeTree.visibleWrites=writeTreeLayerTree_(writeTree.allWrites,writeTreeDefaultFilter_,newEmptyPath()),writeTree.allWrites.length>0?writeTree.lastWriteId=writeTree.allWrites[writeTree.allWrites.length-1].writeId:writeTree.lastWriteId=-1}(writeTree),!0;writeToRemove.snap?writeTree.visibleWrites=compoundWriteRemoveWrite(writeTree.visibleWrites,writeToRemove.path):each(writeToRemove.children,function(childName){writeTree.visibleWrites=compoundWriteRemoveWrite(writeTree.visibleWrites,pathChild(writeToRemove.path,childName))});return!0}return!1}function writeTreeRecordContainsPath_(writeRecord,path){if(writeRecord.snap)return pathContains(writeRecord.path,path);for(var childName in writeRecord.children)if(writeRecord.children.hasOwnProperty(childName)&&pathContains(pathChild(writeRecord.path,childName),path))return!0;return!1}function writeTreeDefaultFilter_(write){return write.visible}function writeTreeLayerTree_(writes,filter,treeRoot){for(var compoundWrite=CompoundWrite.empty(),i=0;i<writes.length;++i){var write=writes[i];if(filter(write)){var writePath=write.path,relativePath=void 0;if(write.snap)pathContains(treeRoot,writePath)?compoundWrite=compoundWriteAddWrite(compoundWrite,relativePath=newRelativePath(treeRoot,writePath),write.snap):pathContains(writePath,treeRoot)&&(relativePath=newRelativePath(writePath,treeRoot),compoundWrite=compoundWriteAddWrite(compoundWrite,newEmptyPath(),write.snap.getChild(relativePath)));else{if(!write.children)throw util.assertionError("WriteRecord should have .snap or .children");if(pathContains(treeRoot,writePath))compoundWrite=compoundWriteAddWrites(compoundWrite,relativePath=newRelativePath(treeRoot,writePath),write.children);else if(pathContains(writePath,treeRoot))if(pathIsEmpty(relativePath=newRelativePath(writePath,treeRoot)))compoundWrite=compoundWriteAddWrites(compoundWrite,newEmptyPath(),write.children);else{var child=util.safeGet(write.children,pathGetFront(relativePath));if(child){var deepNode=child.getChild(pathPopFront(relativePath));compoundWrite=compoundWriteAddWrite(compoundWrite,newEmptyPath(),deepNode)}}}}}return compoundWrite}function writeTreeCalcCompleteEventCache(writeTree,treePath,completeServerCache,writeIdsToExclude,includeHiddenWrites){if(writeIdsToExclude||includeHiddenWrites){var merge=compoundWriteChildCompoundWrite(writeTree.visibleWrites,treePath);if(!includeHiddenWrites&&compoundWriteIsEmpty(merge))return completeServerCache;if(includeHiddenWrites||null!=completeServerCache||compoundWriteHasCompleteWrite(merge,newEmptyPath())){return compoundWriteApply(writeTreeLayerTree_(writeTree.allWrites,function(write){return(write.visible||includeHiddenWrites)&&(!writeIdsToExclude||!~writeIdsToExclude.indexOf(write.writeId))&&(pathContains(write.path,treePath)||pathContains(treePath,write.path))},treePath),completeServerCache||ChildrenNode.EMPTY_NODE)}return null}var shadowingNode=compoundWriteGetCompleteNode(writeTree.visibleWrites,treePath);if(null!=shadowingNode)return shadowingNode;var subMerge=compoundWriteChildCompoundWrite(writeTree.visibleWrites,treePath);return compoundWriteIsEmpty(subMerge)?completeServerCache:null!=completeServerCache||compoundWriteHasCompleteWrite(subMerge,newEmptyPath())?compoundWriteApply(subMerge,completeServerCache||ChildrenNode.EMPTY_NODE):null}function writeTreeRefCalcCompleteEventCache(writeTreeRef,completeServerCache,writeIdsToExclude,includeHiddenWrites){return writeTreeCalcCompleteEventCache(writeTreeRef.writeTree,writeTreeRef.treePath,completeServerCache,writeIdsToExclude,includeHiddenWrites)}function writeTreeRefCalcCompleteEventChildren(writeTreeRef,completeServerChildren){return function writeTreeCalcCompleteEventChildren(writeTree,treePath,completeServerChildren){var completeChildren=ChildrenNode.EMPTY_NODE,topLevelSet=compoundWriteGetCompleteNode(writeTree.visibleWrites,treePath);if(topLevelSet)return topLevelSet.isLeafNode()||topLevelSet.forEachChild(PRIORITY_INDEX,function(childName,childSnap){completeChildren=completeChildren.updateImmediateChild(childName,childSnap)}),completeChildren;if(completeServerChildren){var merge_1=compoundWriteChildCompoundWrite(writeTree.visibleWrites,treePath);return completeServerChildren.forEachChild(PRIORITY_INDEX,function(childName,childNode){var node=compoundWriteApply(compoundWriteChildCompoundWrite(merge_1,new Path(childName)),childNode);completeChildren=completeChildren.updateImmediateChild(childName,node)}),compoundWriteGetCompleteChildren(merge_1).forEach(function(namedNode){completeChildren=completeChildren.updateImmediateChild(namedNode.name,namedNode.node)}),completeChildren}return compoundWriteGetCompleteChildren(compoundWriteChildCompoundWrite(writeTree.visibleWrites,treePath)).forEach(function(namedNode){completeChildren=completeChildren.updateImmediateChild(namedNode.name,namedNode.node)}),completeChildren}(writeTreeRef.writeTree,writeTreeRef.treePath,completeServerChildren)}function writeTreeRefCalcEventCacheAfterServerOverwrite(writeTreeRef,path,existingEventSnap,existingServerSnap){return function writeTreeCalcEventCacheAfterServerOverwrite(writeTree,treePath,childPath,existingEventSnap,existingServerSnap){util.assert(existingEventSnap||existingServerSnap,"Either existingEventSnap or existingServerSnap must exist");var path=pathChild(treePath,childPath);if(compoundWriteHasCompleteWrite(writeTree.visibleWrites,path))return null;var childMerge=compoundWriteChildCompoundWrite(writeTree.visibleWrites,path);return compoundWriteIsEmpty(childMerge)?existingServerSnap.getChild(childPath):compoundWriteApply(childMerge,existingServerSnap.getChild(childPath))}(writeTreeRef.writeTree,writeTreeRef.treePath,path,existingEventSnap,existingServerSnap)}function writeTreeRefShadowingWrite(writeTreeRef,path){return function writeTreeShadowingWrite(writeTree,path){return compoundWriteGetCompleteNode(writeTree.visibleWrites,path)}(writeTreeRef.writeTree,pathChild(writeTreeRef.treePath,path))}function writeTreeRefCalcIndexedSlice(writeTreeRef,completeServerData,startPost,count,reverse,index){return function writeTreeCalcIndexedSlice(writeTree,treePath,completeServerData,startPost,count,reverse,index){var toIterate,merge=compoundWriteChildCompoundWrite(writeTree.visibleWrites,treePath),shadowingNode=compoundWriteGetCompleteNode(merge,newEmptyPath());if(null!=shadowingNode)toIterate=shadowingNode;else{if(null==completeServerData)return[];toIterate=compoundWriteApply(merge,completeServerData)}if((toIterate=toIterate.withIndex(index)).isEmpty()||toIterate.isLeafNode())return[];for(var nodes=[],cmp=index.getCompare(),iter=reverse?toIterate.getReverseIteratorFrom(startPost,index):toIterate.getIteratorFrom(startPost,index),next=iter.getNext();next&&nodes.length<count;)0!==cmp(next,startPost)&&nodes.push(next),next=iter.getNext();return nodes}(writeTreeRef.writeTree,writeTreeRef.treePath,completeServerData,startPost,count,reverse,index)}function writeTreeRefCalcCompleteChild(writeTreeRef,childKey,existingServerCache){return function writeTreeCalcCompleteChild(writeTree,treePath,childKey,existingServerSnap){var path=pathChild(treePath,childKey),shadowingNode=compoundWriteGetCompleteNode(writeTree.visibleWrites,path);return null!=shadowingNode?shadowingNode:existingServerSnap.isCompleteForChild(childKey)?compoundWriteApply(compoundWriteChildCompoundWrite(writeTree.visibleWrites,path),existingServerSnap.getNode().getImmediateChild(childKey)):null}(writeTreeRef.writeTree,writeTreeRef.treePath,childKey,existingServerCache)}function writeTreeRefChild(writeTreeRef,childName){return newWriteTreeRef(pathChild(writeTreeRef.treePath,childName),writeTreeRef.writeTree)}function newWriteTreeRef(path,writeTree){return{treePath:path,writeTree:writeTree}}var ChildChangeAccumulator=function(){function ChildChangeAccumulator(){this.changeMap=new Map}return ChildChangeAccumulator.prototype.trackChildChange=function(change){var type=change.type,childKey=change.childName;util.assert("child_added"===type||"child_changed"===type||"child_removed"===type,"Only child changes supported for tracking"),util.assert(".priority"!==childKey,"Only non-priority child changes can be tracked.");var oldChange=this.changeMap.get(childKey);if(oldChange){var oldType=oldChange.type;if("child_added"===type&&"child_removed"===oldType)this.changeMap.set(childKey,changeChildChanged(childKey,change.snapshotNode,oldChange.snapshotNode));else if("child_removed"===type&&"child_added"===oldType)this.changeMap.delete(childKey);else if("child_removed"===type&&"child_changed"===oldType)this.changeMap.set(childKey,changeChildRemoved(childKey,oldChange.oldSnap));else if("child_changed"===type&&"child_added"===oldType)this.changeMap.set(childKey,changeChildAdded(childKey,change.snapshotNode));else{if("child_changed"!==type||"child_changed"!==oldType)throw util.assertionError("Illegal combination of changes: "+change+" occurred after "+oldChange);this.changeMap.set(childKey,changeChildChanged(childKey,change.snapshotNode,oldChange.oldSnap))}}else this.changeMap.set(childKey,change)},ChildChangeAccumulator.prototype.getChanges=function(){return Array.from(this.changeMap.values())},ChildChangeAccumulator}(),NO_COMPLETE_CHILD_SOURCE=new(function(){function NoCompleteChildSource_(){}return NoCompleteChildSource_.prototype.getCompleteChild=function(childKey){return null},NoCompleteChildSource_.prototype.getChildAfterChild=function(index,child,reverse){return null},NoCompleteChildSource_}()),WriteTreeCompleteChildSource=function(){function WriteTreeCompleteChildSource(writes_,viewCache_,optCompleteServerCache_){void 0===optCompleteServerCache_&&(optCompleteServerCache_=null),this.writes_=writes_,this.viewCache_=viewCache_,this.optCompleteServerCache_=optCompleteServerCache_}return WriteTreeCompleteChildSource.prototype.getCompleteChild=function(childKey){var node=this.viewCache_.eventCache;if(node.isCompleteForChild(childKey))return node.getNode().getImmediateChild(childKey);var serverNode=null!=this.optCompleteServerCache_?new CacheNode(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return writeTreeRefCalcCompleteChild(this.writes_,childKey,serverNode)},WriteTreeCompleteChildSource.prototype.getChildAfterChild=function(index,child,reverse){var completeServerData=null!=this.optCompleteServerCache_?this.optCompleteServerCache_:viewCacheGetCompleteServerSnap(this.viewCache_),nodes=writeTreeRefCalcIndexedSlice(this.writes_,completeServerData,child,1,reverse,index);return 0===nodes.length?null:nodes[0]},WriteTreeCompleteChildSource}();function viewProcessorApplyOperation(viewProcessor,oldViewCache,operation,writesCache,completeCache){var newViewCache,filterServerNode,accumulator=new ChildChangeAccumulator;if(operation.type===OperationType.OVERWRITE){var overwrite=operation;overwrite.source.fromUser?newViewCache=viewProcessorApplyUserOverwrite(viewProcessor,oldViewCache,overwrite.path,overwrite.snap,writesCache,completeCache,accumulator):(util.assert(overwrite.source.fromServer,"Unknown source."),filterServerNode=overwrite.source.tagged||oldViewCache.serverCache.isFiltered()&&!pathIsEmpty(overwrite.path),newViewCache=viewProcessorApplyServerOverwrite(viewProcessor,oldViewCache,overwrite.path,overwrite.snap,writesCache,completeCache,filterServerNode,accumulator))}else if(operation.type===OperationType.MERGE){var merge=operation;merge.source.fromUser?newViewCache=function viewProcessorApplyUserMerge(viewProcessor,viewCache,path,changedChildren,writesCache,serverCache,accumulator){var curViewCache=viewCache;return changedChildren.foreach(function(relativePath,childNode){var writePath=pathChild(path,relativePath);viewProcessorCacheHasChild(viewCache,pathGetFront(writePath))&&(curViewCache=viewProcessorApplyUserOverwrite(viewProcessor,curViewCache,writePath,childNode,writesCache,serverCache,accumulator))}),changedChildren.foreach(function(relativePath,childNode){var writePath=pathChild(path,relativePath);viewProcessorCacheHasChild(viewCache,pathGetFront(writePath))||(curViewCache=viewProcessorApplyUserOverwrite(viewProcessor,curViewCache,writePath,childNode,writesCache,serverCache,accumulator))}),curViewCache}(viewProcessor,oldViewCache,merge.path,merge.children,writesCache,completeCache,accumulator):(util.assert(merge.source.fromServer,"Unknown source."),filterServerNode=merge.source.tagged||oldViewCache.serverCache.isFiltered(),newViewCache=viewProcessorApplyServerMerge(viewProcessor,oldViewCache,merge.path,merge.children,writesCache,completeCache,filterServerNode,accumulator))}else if(operation.type===OperationType.ACK_USER_WRITE){var ackUserWrite=operation;newViewCache=ackUserWrite.revert?function viewProcessorRevertUserWrite(viewProcessor,viewCache,path,writesCache,completeServerCache,accumulator){var complete;if(null!=writeTreeRefShadowingWrite(writesCache,path))return viewCache;var source=new WriteTreeCompleteChildSource(writesCache,viewCache,completeServerCache),oldEventCache=viewCache.eventCache.getNode(),newEventCache=void 0;if(pathIsEmpty(path)||".priority"===pathGetFront(path)){var newNode=void 0;if(viewCache.serverCache.isFullyInitialized())newNode=writeTreeRefCalcCompleteEventCache(writesCache,viewCacheGetCompleteServerSnap(viewCache));else{var serverChildren=viewCache.serverCache.getNode();util.assert(serverChildren instanceof ChildrenNode,"serverChildren would be complete if leaf node"),newNode=writeTreeRefCalcCompleteEventChildren(writesCache,serverChildren)}newNode=newNode,newEventCache=viewProcessor.filter.updateFullNode(oldEventCache,newNode,accumulator)}else{var childKey=pathGetFront(path),newChild=writeTreeRefCalcCompleteChild(writesCache,childKey,viewCache.serverCache);null==newChild&&viewCache.serverCache.isCompleteForChild(childKey)&&(newChild=oldEventCache.getImmediateChild(childKey)),(newEventCache=null!=newChild?viewProcessor.filter.updateChild(oldEventCache,childKey,newChild,pathPopFront(path),source,accumulator):viewCache.eventCache.getNode().hasChild(childKey)?viewProcessor.filter.updateChild(oldEventCache,childKey,ChildrenNode.EMPTY_NODE,pathPopFront(path),source,accumulator):oldEventCache).isEmpty()&&viewCache.serverCache.isFullyInitialized()&&(complete=writeTreeRefCalcCompleteEventCache(writesCache,viewCacheGetCompleteServerSnap(viewCache))).isLeafNode()&&(newEventCache=viewProcessor.filter.updateFullNode(newEventCache,complete,accumulator))}return complete=viewCache.serverCache.isFullyInitialized()||null!=writeTreeRefShadowingWrite(writesCache,newEmptyPath()),viewCacheUpdateEventSnap(viewCache,newEventCache,complete,viewProcessor.filter.filtersNodes())}(viewProcessor,oldViewCache,ackUserWrite.path,writesCache,completeCache,accumulator):function viewProcessorAckUserWrite(viewProcessor,viewCache,ackPath,affectedTree,writesCache,completeCache,accumulator){if(null!=writeTreeRefShadowingWrite(writesCache,ackPath))return viewCache;var filterServerNode=viewCache.serverCache.isFiltered(),serverCache=viewCache.serverCache;if(null!=affectedTree.value){if(pathIsEmpty(ackPath)&&serverCache.isFullyInitialized()||serverCache.isCompleteForPath(ackPath))return viewProcessorApplyServerOverwrite(viewProcessor,viewCache,ackPath,serverCache.getNode().getChild(ackPath),writesCache,completeCache,filterServerNode,accumulator);if(pathIsEmpty(ackPath)){var changedChildren_1=new ImmutableTree(null);return serverCache.getNode().forEachChild(KEY_INDEX,function(name,node){changedChildren_1=changedChildren_1.set(new Path(name),node)}),viewProcessorApplyServerMerge(viewProcessor,viewCache,ackPath,changedChildren_1,writesCache,completeCache,filterServerNode,accumulator)}return viewCache}var changedChildren_2=new ImmutableTree(null);return affectedTree.foreach(function(mergePath,value){var serverCachePath=pathChild(ackPath,mergePath);serverCache.isCompleteForPath(serverCachePath)&&(changedChildren_2=changedChildren_2.set(mergePath,serverCache.getNode().getChild(serverCachePath)))}),viewProcessorApplyServerMerge(viewProcessor,viewCache,ackPath,changedChildren_2,writesCache,completeCache,filterServerNode,accumulator)}(viewProcessor,oldViewCache,ackUserWrite.path,ackUserWrite.affectedTree,writesCache,completeCache,accumulator)}else{if(operation.type!==OperationType.LISTEN_COMPLETE)throw util.assertionError("Unknown operation type: "+operation.type);newViewCache=function viewProcessorListenComplete(viewProcessor,viewCache,path,writesCache,accumulator){var oldServerNode=viewCache.serverCache,newViewCache=viewCacheUpdateServerSnap(viewCache,oldServerNode.getNode(),oldServerNode.isFullyInitialized()||pathIsEmpty(path),oldServerNode.isFiltered());return viewProcessorGenerateEventCacheAfterServerEvent(viewProcessor,newViewCache,path,writesCache,NO_COMPLETE_CHILD_SOURCE,accumulator)}(viewProcessor,oldViewCache,operation.path,writesCache,accumulator)}var changes=accumulator.getChanges();return function viewProcessorMaybeAddValueEvent(oldViewCache,newViewCache,accumulator){var eventSnap=newViewCache.eventCache;if(eventSnap.isFullyInitialized()){var isLeafOrEmpty=eventSnap.getNode().isLeafNode()||eventSnap.getNode().isEmpty(),oldCompleteSnap=viewCacheGetCompleteEventSnap(oldViewCache);(accumulator.length>0||!oldViewCache.eventCache.isFullyInitialized()||isLeafOrEmpty&&!eventSnap.getNode().equals(oldCompleteSnap)||!eventSnap.getNode().getPriority().equals(oldCompleteSnap.getPriority()))&&accumulator.push(changeValue(viewCacheGetCompleteEventSnap(newViewCache)))}}(oldViewCache,newViewCache,changes),{viewCache:newViewCache,changes:changes}}function viewProcessorGenerateEventCacheAfterServerEvent(viewProcessor,viewCache,changePath,writesCache,source,accumulator){var oldEventSnap=viewCache.eventCache;if(null!=writeTreeRefShadowingWrite(writesCache,changePath))return viewCache;var newEventCache=void 0,serverNode=void 0;if(pathIsEmpty(changePath))if(util.assert(viewCache.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),viewCache.serverCache.isFiltered()){var serverCache=viewCacheGetCompleteServerSnap(viewCache),completeEventChildren=writeTreeRefCalcCompleteEventChildren(writesCache,serverCache instanceof ChildrenNode?serverCache:ChildrenNode.EMPTY_NODE);newEventCache=viewProcessor.filter.updateFullNode(viewCache.eventCache.getNode(),completeEventChildren,accumulator)}else{var completeNode=writeTreeRefCalcCompleteEventCache(writesCache,viewCacheGetCompleteServerSnap(viewCache));newEventCache=viewProcessor.filter.updateFullNode(viewCache.eventCache.getNode(),completeNode,accumulator)}else{var childKey=pathGetFront(changePath);if(".priority"===childKey){util.assert(1===pathGetLength(changePath),"Can't have a priority with additional path components");var oldEventNode=oldEventSnap.getNode(),updatedPriority=writeTreeRefCalcEventCacheAfterServerOverwrite(writesCache,changePath,oldEventNode,serverNode=viewCache.serverCache.getNode());newEventCache=null!=updatedPriority?viewProcessor.filter.updatePriority(oldEventNode,updatedPriority):oldEventSnap.getNode()}else{var childChangePath=pathPopFront(changePath),newEventChild=void 0;if(oldEventSnap.isCompleteForChild(childKey)){serverNode=viewCache.serverCache.getNode();var eventChildUpdate=writeTreeRefCalcEventCacheAfterServerOverwrite(writesCache,changePath,oldEventSnap.getNode(),serverNode);newEventChild=null!=eventChildUpdate?oldEventSnap.getNode().getImmediateChild(childKey).updateChild(childChangePath,eventChildUpdate):oldEventSnap.getNode().getImmediateChild(childKey)}else newEventChild=writeTreeRefCalcCompleteChild(writesCache,childKey,viewCache.serverCache);newEventCache=null!=newEventChild?viewProcessor.filter.updateChild(oldEventSnap.getNode(),childKey,newEventChild,childChangePath,source,accumulator):oldEventSnap.getNode()}}return viewCacheUpdateEventSnap(viewCache,newEventCache,oldEventSnap.isFullyInitialized()||pathIsEmpty(changePath),viewProcessor.filter.filtersNodes())}function viewProcessorApplyServerOverwrite(viewProcessor,oldViewCache,changePath,changedSnap,writesCache,completeCache,filterServerNode,accumulator){var newServerCache,oldServerSnap=oldViewCache.serverCache,serverFilter=filterServerNode?viewProcessor.filter:viewProcessor.filter.getIndexedFilter();if(pathIsEmpty(changePath))newServerCache=serverFilter.updateFullNode(oldServerSnap.getNode(),changedSnap,null);else if(serverFilter.filtersNodes()&&!oldServerSnap.isFiltered()){var newServerNode=oldServerSnap.getNode().updateChild(changePath,changedSnap);newServerCache=serverFilter.updateFullNode(oldServerSnap.getNode(),newServerNode,null)}else{var childKey=pathGetFront(changePath);if(!oldServerSnap.isCompleteForPath(changePath)&&pathGetLength(changePath)>1)return oldViewCache;var childChangePath=pathPopFront(changePath),newChildNode=oldServerSnap.getNode().getImmediateChild(childKey).updateChild(childChangePath,changedSnap);newServerCache=".priority"===childKey?serverFilter.updatePriority(oldServerSnap.getNode(),newChildNode):serverFilter.updateChild(oldServerSnap.getNode(),childKey,newChildNode,childChangePath,NO_COMPLETE_CHILD_SOURCE,null)}var newViewCache=viewCacheUpdateServerSnap(oldViewCache,newServerCache,oldServerSnap.isFullyInitialized()||pathIsEmpty(changePath),serverFilter.filtersNodes());return viewProcessorGenerateEventCacheAfterServerEvent(viewProcessor,newViewCache,changePath,writesCache,new WriteTreeCompleteChildSource(writesCache,newViewCache,completeCache),accumulator)}function viewProcessorApplyUserOverwrite(viewProcessor,oldViewCache,changePath,changedSnap,writesCache,completeCache,accumulator){var newViewCache,newEventCache,oldEventSnap=oldViewCache.eventCache,source=new WriteTreeCompleteChildSource(writesCache,oldViewCache,completeCache);if(pathIsEmpty(changePath))newEventCache=viewProcessor.filter.updateFullNode(oldViewCache.eventCache.getNode(),changedSnap,accumulator),newViewCache=viewCacheUpdateEventSnap(oldViewCache,newEventCache,!0,viewProcessor.filter.filtersNodes());else{var childKey=pathGetFront(changePath);if(".priority"===childKey)newEventCache=viewProcessor.filter.updatePriority(oldViewCache.eventCache.getNode(),changedSnap),newViewCache=viewCacheUpdateEventSnap(oldViewCache,newEventCache,oldEventSnap.isFullyInitialized(),oldEventSnap.isFiltered());else{var childChangePath=pathPopFront(changePath),oldChild=oldEventSnap.getNode().getImmediateChild(childKey),newChild=void 0;if(pathIsEmpty(childChangePath))newChild=changedSnap;else{var childNode=source.getCompleteChild(childKey);newChild=null!=childNode?".priority"===pathGetBack(childChangePath)&&childNode.getChild(pathParent(childChangePath)).isEmpty()?childNode:childNode.updateChild(childChangePath,changedSnap):ChildrenNode.EMPTY_NODE}if(oldChild.equals(newChild))newViewCache=oldViewCache;else newViewCache=viewCacheUpdateEventSnap(oldViewCache,viewProcessor.filter.updateChild(oldEventSnap.getNode(),childKey,newChild,childChangePath,source,accumulator),oldEventSnap.isFullyInitialized(),viewProcessor.filter.filtersNodes())}}return newViewCache}function viewProcessorCacheHasChild(viewCache,childKey){return viewCache.eventCache.isCompleteForChild(childKey)}function viewProcessorApplyMerge(viewProcessor,node,merge){return merge.foreach(function(relativePath,childNode){node=node.updateChild(relativePath,childNode)}),node}function viewProcessorApplyServerMerge(viewProcessor,viewCache,path,changedChildren,writesCache,serverCache,filterServerNode,accumulator){if(viewCache.serverCache.getNode().isEmpty()&&!viewCache.serverCache.isFullyInitialized())return viewCache;var viewMergeTree,curViewCache=viewCache;viewMergeTree=pathIsEmpty(path)?changedChildren:new ImmutableTree(null).setTree(path,changedChildren);var serverNode=viewCache.serverCache.getNode();return viewMergeTree.children.inorderTraversal(function(childKey,childTree){if(serverNode.hasChild(childKey)){var newChild=viewProcessorApplyMerge(0,viewCache.serverCache.getNode().getImmediateChild(childKey),childTree);curViewCache=viewProcessorApplyServerOverwrite(viewProcessor,curViewCache,new Path(childKey),newChild,writesCache,serverCache,filterServerNode,accumulator)}}),viewMergeTree.children.inorderTraversal(function(childKey,childMergeTree){var isUnknownDeepMerge=!viewCache.serverCache.isCompleteForChild(childKey)&&void 0===childMergeTree.value;if(!serverNode.hasChild(childKey)&&!isUnknownDeepMerge){var newChild=viewProcessorApplyMerge(0,viewCache.serverCache.getNode().getImmediateChild(childKey),childMergeTree);curViewCache=viewProcessorApplyServerOverwrite(viewProcessor,curViewCache,new Path(childKey),newChild,writesCache,serverCache,filterServerNode,accumulator)}}),curViewCache}var referenceConstructor$1,View=function(){function View(query_,initialViewCache){this.query_=query_,this.eventRegistrations_=[];var params=this.query_._queryParams,indexFilter=new IndexedFilter(params.getIndex()),filter=function queryParamsGetNodeFilter(queryParams){return queryParams.loadsAllData()?new IndexedFilter(queryParams.getIndex()):queryParams.hasLimit()?new LimitedFilter(queryParams):new RangedFilter(queryParams)}(params);this.processor_=function newViewProcessor(filter){return{filter:filter}}(filter);var initialServerCache=initialViewCache.serverCache,initialEventCache=initialViewCache.eventCache,serverSnap=indexFilter.updateFullNode(ChildrenNode.EMPTY_NODE,initialServerCache.getNode(),null),eventSnap=filter.updateFullNode(ChildrenNode.EMPTY_NODE,initialEventCache.getNode(),null),newServerCache=new CacheNode(serverSnap,initialServerCache.isFullyInitialized(),indexFilter.filtersNodes()),newEventCache=new CacheNode(eventSnap,initialEventCache.isFullyInitialized(),filter.filtersNodes());this.viewCache_=newViewCache(newEventCache,newServerCache),this.eventGenerator_=new EventGenerator(this.query_)}return Object.defineProperty(View.prototype,"query",{get:function(){return this.query_},enumerable:!1,configurable:!0}),View}();function viewGetCompleteServerCache(view,path){var cache=viewCacheGetCompleteServerSnap(view.viewCache_);return cache&&(view.query._queryParams.loadsAllData()||!pathIsEmpty(path)&&!cache.getImmediateChild(pathGetFront(path)).isEmpty())?cache.getChild(path):null}function viewIsEmpty(view){return 0===view.eventRegistrations_.length}function viewRemoveEventRegistration(view,eventRegistration,cancelError){var cancelEvents=[];if(cancelError){util.assert(null==eventRegistration,"A cancel should cancel all event registrations.");var path_1=view.query._path;view.eventRegistrations_.forEach(function(registration){var maybeEvent=registration.createCancelEvent(cancelError,path_1);maybeEvent&&cancelEvents.push(maybeEvent)})}if(eventRegistration){for(var remaining=[],i=0;i<view.eventRegistrations_.length;++i){var existing=view.eventRegistrations_[i];if(existing.matches(eventRegistration)){if(eventRegistration.hasAnyCallback()){remaining=remaining.concat(view.eventRegistrations_.slice(i+1));break}}else remaining.push(existing)}view.eventRegistrations_=remaining}else view.eventRegistrations_=[];return cancelEvents}function viewApplyOperation(view,operation,writesCache,completeServerCache){operation.type===OperationType.MERGE&&null!==operation.source.queryId&&(util.assert(viewCacheGetCompleteServerSnap(view.viewCache_),"We should always have a full cache before handling merges"),util.assert(viewCacheGetCompleteEventSnap(view.viewCache_),"Missing event cache, even though we have a server cache"));var oldViewCache=view.viewCache_,result=viewProcessorApplyOperation(view.processor_,oldViewCache,operation,writesCache,completeServerCache);return function viewProcessorAssertIndexed(viewProcessor,viewCache){util.assert(viewCache.eventCache.getNode().isIndexed(viewProcessor.filter.getIndex()),"Event snap not indexed"),util.assert(viewCache.serverCache.getNode().isIndexed(viewProcessor.filter.getIndex()),"Server snap not indexed")}(view.processor_,result.viewCache),util.assert(result.viewCache.serverCache.isFullyInitialized()||!oldViewCache.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),view.viewCache_=result.viewCache,viewGenerateEventsForChanges_(view,result.changes,result.viewCache.eventCache.getNode(),null)}function viewGenerateEventsForChanges_(view,changes,eventCache,eventRegistration){var registrations=eventRegistration?[eventRegistration]:view.eventRegistrations_;return function eventGeneratorGenerateEventsForChanges(eventGenerator,changes,eventCache,eventRegistrations){var events=[],moves=[];return changes.forEach(function(change){"child_changed"===change.type&&eventGenerator.index_.indexedValueChanged(change.oldSnap,change.snapshotNode)&&moves.push(function changeChildMoved(childName,snapshotNode){return{type:"child_moved",snapshotNode:snapshotNode,childName:childName}}(change.childName,change.snapshotNode))}),eventGeneratorGenerateEventsForType(eventGenerator,events,"child_removed",changes,eventRegistrations,eventCache),eventGeneratorGenerateEventsForType(eventGenerator,events,"child_added",changes,eventRegistrations,eventCache),eventGeneratorGenerateEventsForType(eventGenerator,events,"child_moved",moves,eventRegistrations,eventCache),eventGeneratorGenerateEventsForType(eventGenerator,events,"child_changed",changes,eventRegistrations,eventCache),eventGeneratorGenerateEventsForType(eventGenerator,events,"value",changes,eventRegistrations,eventCache),events}(view.eventGenerator_,changes,eventCache,registrations)}var referenceConstructor,SyncPoint=function SyncPoint(){this.views=new Map};function syncPointApplyOperation(syncPoint,operation,writesCache,optCompleteServerCache){var e_1,_a,queryId=operation.source.queryId;if(null!==queryId){var view=syncPoint.views.get(queryId);return util.assert(null!=view,"SyncTree gave us an op for an invalid query."),viewApplyOperation(view,operation,writesCache,optCompleteServerCache)}var events=[];try{for(var _b=tslib.__values(syncPoint.views.values()),_c=_b.next();!_c.done;_c=_b.next()){view=_c.value;events=events.concat(viewApplyOperation(view,operation,writesCache,optCompleteServerCache))}}catch(e_1_1){e_1={error:e_1_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_1)throw e_1.error}}return events}function syncPointGetView(syncPoint,query,writesCache,serverCache,serverCacheComplete){var queryId=query._queryIdentifier,view=syncPoint.views.get(queryId);if(!view){var eventCache=writeTreeRefCalcCompleteEventCache(writesCache,serverCacheComplete?serverCache:null),eventCacheComplete=!1;eventCache?eventCacheComplete=!0:serverCache instanceof ChildrenNode?(eventCache=writeTreeRefCalcCompleteEventChildren(writesCache,serverCache),eventCacheComplete=!1):(eventCache=ChildrenNode.EMPTY_NODE,eventCacheComplete=!1);var viewCache=newViewCache(new CacheNode(eventCache,eventCacheComplete,!1),new CacheNode(serverCache,serverCacheComplete,!1));return new View(query,viewCache)}return view}function syncPointAddEventRegistration(syncPoint,query,eventRegistration,writesCache,serverCache,serverCacheComplete){var view=syncPointGetView(syncPoint,query,writesCache,serverCache,serverCacheComplete);return syncPoint.views.has(query._queryIdentifier)||syncPoint.views.set(query._queryIdentifier,view),function viewAddEventRegistration(view,eventRegistration){view.eventRegistrations_.push(eventRegistration)}(view,eventRegistration),function viewGetInitialEvents(view,registration){var eventSnap=view.viewCache_.eventCache,initialChanges=[];return eventSnap.getNode().isLeafNode()||eventSnap.getNode().forEachChild(PRIORITY_INDEX,function(key,childNode){initialChanges.push(changeChildAdded(key,childNode))}),eventSnap.isFullyInitialized()&&initialChanges.push(changeValue(eventSnap.getNode())),viewGenerateEventsForChanges_(view,initialChanges,eventSnap.getNode(),registration)}(view,eventRegistration)}function syncPointRemoveEventRegistration(syncPoint,query,eventRegistration,cancelError){var e_2,_a,queryId=query._queryIdentifier,removed=[],cancelEvents=[],hadCompleteView=syncPointHasCompleteView(syncPoint);if("default"===queryId)try{for(var _b=tslib.__values(syncPoint.views.entries()),_c=_b.next();!_c.done;_c=_b.next()){var _d=tslib.__read(_c.value,2),viewQueryId=_d[0],view=_d[1];cancelEvents=cancelEvents.concat(viewRemoveEventRegistration(view,eventRegistration,cancelError)),viewIsEmpty(view)&&(syncPoint.views.delete(viewQueryId),view.query._queryParams.loadsAllData()||removed.push(view.query))}}catch(e_2_1){e_2={error:e_2_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_2)throw e_2.error}}else(view=syncPoint.views.get(queryId))&&(cancelEvents=cancelEvents.concat(viewRemoveEventRegistration(view,eventRegistration,cancelError)),viewIsEmpty(view)&&(syncPoint.views.delete(queryId),view.query._queryParams.loadsAllData()||removed.push(view.query)));return hadCompleteView&&!syncPointHasCompleteView(syncPoint)&&removed.push(new(function syncPointGetReferenceConstructor(){return util.assert(referenceConstructor$1,"Reference.ts has not been loaded"),referenceConstructor$1}())(query._repo,query._path)),{removed:removed,events:cancelEvents}}function syncPointGetQueryViews(syncPoint){var e_3,_a,result=[];try{for(var _b=tslib.__values(syncPoint.views.values()),_c=_b.next();!_c.done;_c=_b.next()){var view=_c.value;view.query._queryParams.loadsAllData()||result.push(view)}}catch(e_3_1){e_3={error:e_3_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_3)throw e_3.error}}return result}function syncPointGetCompleteServerCache(syncPoint,path){var e_4,_a,serverCache=null;try{for(var _b=tslib.__values(syncPoint.views.values()),_c=_b.next();!_c.done;_c=_b.next()){var view=_c.value;serverCache=serverCache||viewGetCompleteServerCache(view,path)}}catch(e_4_1){e_4={error:e_4_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_4)throw e_4.error}}return serverCache}function syncPointViewForQuery(syncPoint,query){if(query._queryParams.loadsAllData())return syncPointGetCompleteView(syncPoint);var queryId=query._queryIdentifier;return syncPoint.views.get(queryId)}function syncPointViewExistsForQuery(syncPoint,query){return null!=syncPointViewForQuery(syncPoint,query)}function syncPointHasCompleteView(syncPoint){return null!=syncPointGetCompleteView(syncPoint)}function syncPointGetCompleteView(syncPoint){var e_5,_a;try{for(var _b=tslib.__values(syncPoint.views.values()),_c=_b.next();!_c.done;_c=_b.next()){var view=_c.value;if(view.query._queryParams.loadsAllData())return view}}catch(e_5_1){e_5={error:e_5_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_5)throw e_5.error}}return null}var syncTreeNextQueryTag_=1,SyncTree=function SyncTree(listenProvider_){this.listenProvider_=listenProvider_,this.syncPointTree_=new ImmutableTree(null),this.pendingWriteTree_=function newWriteTree(){return{visibleWrites:CompoundWrite.empty(),allWrites:[],lastWriteId:-1}}(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map};function syncTreeApplyUserOverwrite(syncTree,path,newData,writeId,visible){return function writeTreeAddOverwrite(writeTree,path,snap,writeId,visible){util.assert(writeId>writeTree.lastWriteId,"Stacking an older write on top of newer ones"),void 0===visible&&(visible=!0),writeTree.allWrites.push({path:path,snap:snap,writeId:writeId,visible:visible}),visible&&(writeTree.visibleWrites=compoundWriteAddWrite(writeTree.visibleWrites,path,snap)),writeTree.lastWriteId=writeId}(syncTree.pendingWriteTree_,path,newData,writeId,visible),visible?syncTreeApplyOperationToSyncPoints_(syncTree,new Overwrite({fromUser:!0,fromServer:!1,queryId:null,tagged:!1},path,newData)):[]}function syncTreeApplyUserMerge(syncTree,path,changedChildren,writeId){!function writeTreeAddMerge(writeTree,path,changedChildren,writeId){util.assert(writeId>writeTree.lastWriteId,"Stacking an older merge on top of newer ones"),writeTree.allWrites.push({path:path,children:changedChildren,writeId:writeId,visible:!0}),writeTree.visibleWrites=compoundWriteAddWrites(writeTree.visibleWrites,path,changedChildren),writeTree.lastWriteId=writeId}(syncTree.pendingWriteTree_,path,changedChildren,writeId);var changeTree=ImmutableTree.fromObject(changedChildren);return syncTreeApplyOperationToSyncPoints_(syncTree,new Merge({fromUser:!0,fromServer:!1,queryId:null,tagged:!1},path,changeTree))}function syncTreeAckUserWrite(syncTree,writeId,revert){void 0===revert&&(revert=!1);var write=function writeTreeGetWrite(writeTree,writeId){for(var i=0;i<writeTree.allWrites.length;i++){var record=writeTree.allWrites[i];if(record.writeId===writeId)return record}return null}(syncTree.pendingWriteTree_,writeId);if(writeTreeRemoveWrite(syncTree.pendingWriteTree_,writeId)){var affectedTree_1=new ImmutableTree(null);return null!=write.snap?affectedTree_1=affectedTree_1.set(newEmptyPath(),!0):each(write.children,function(pathString){affectedTree_1=affectedTree_1.set(new Path(pathString),!0)}),syncTreeApplyOperationToSyncPoints_(syncTree,new AckUserWrite(write.path,affectedTree_1,revert))}return[]}function syncTreeApplyServerOverwrite(syncTree,path,newData){return syncTreeApplyOperationToSyncPoints_(syncTree,new Overwrite({fromUser:!1,fromServer:!0,queryId:null,tagged:!1},path,newData))}function syncTreeRemoveEventRegistration(syncTree,query,eventRegistration,cancelError){var path=query._path,maybeSyncPoint=syncTree.syncPointTree_.get(path),cancelEvents=[];if(maybeSyncPoint&&("default"===query._queryIdentifier||syncPointViewExistsForQuery(maybeSyncPoint,query))){var removedAndEvents=syncPointRemoveEventRegistration(maybeSyncPoint,query,eventRegistration,cancelError);(function syncPointIsEmpty(syncPoint){return 0===syncPoint.views.size})(maybeSyncPoint)&&(syncTree.syncPointTree_=syncTree.syncPointTree_.remove(path));var removed=removedAndEvents.removed;cancelEvents=removedAndEvents.events;var removingDefault=-1!==removed.findIndex(function(query){return query._queryParams.loadsAllData()}),covered=syncTree.syncPointTree_.findOnPath(path,function(relativePath,parentSyncPoint){return syncPointHasCompleteView(parentSyncPoint)});if(removingDefault&&!covered){var subtree=syncTree.syncPointTree_.subtree(path);if(!subtree.isEmpty())for(var newViews=function syncTreeCollectDistinctViewsForSubTree_(subtree){return subtree.fold(function(relativePath,maybeChildSyncPoint,childMap){if(maybeChildSyncPoint&&syncPointHasCompleteView(maybeChildSyncPoint))return[syncPointGetCompleteView(maybeChildSyncPoint)];var views_1=[];return maybeChildSyncPoint&&(views_1=syncPointGetQueryViews(maybeChildSyncPoint)),each(childMap,function(_key,childViews){views_1=views_1.concat(childViews)}),views_1})}(subtree),i=0;i<newViews.length;++i){var view=newViews[i],newQuery=view.query,listener=syncTreeCreateListenerForView_(syncTree,view);syncTree.listenProvider_.startListening(syncTreeQueryForListening_(newQuery),syncTreeTagForQuery_(syncTree,newQuery),listener.hashFn,listener.onComplete)}}if(!covered&&removed.length>0&&!cancelError)if(removingDefault){syncTree.listenProvider_.stopListening(syncTreeQueryForListening_(query),null)}else removed.forEach(function(queryToRemove){var tagToRemove=syncTree.queryToTagMap.get(syncTreeMakeQueryKey_(queryToRemove));syncTree.listenProvider_.stopListening(syncTreeQueryForListening_(queryToRemove),tagToRemove)});!function syncTreeRemoveTags_(syncTree,queries){for(var j=0;j<queries.length;++j){var removedQuery=queries[j];if(!removedQuery._queryParams.loadsAllData()){var removedQueryKey=syncTreeMakeQueryKey_(removedQuery),removedQueryTag=syncTree.queryToTagMap.get(removedQueryKey);syncTree.queryToTagMap.delete(removedQueryKey),syncTree.tagToQueryMap.delete(removedQueryTag)}}}(syncTree,removed)}return cancelEvents}function syncTreeAddEventRegistration(syncTree,query,eventRegistration){var path=query._path,serverCache=null,foundAncestorDefaultView=!1;syncTree.syncPointTree_.foreachOnPath(path,function(pathToSyncPoint,sp){var relativePath=newRelativePath(pathToSyncPoint,path);serverCache=serverCache||syncPointGetCompleteServerCache(sp,relativePath),foundAncestorDefaultView=foundAncestorDefaultView||syncPointHasCompleteView(sp)});var serverCacheComplete,syncPoint=syncTree.syncPointTree_.get(path);(syncPoint?(foundAncestorDefaultView=foundAncestorDefaultView||syncPointHasCompleteView(syncPoint),serverCache=serverCache||syncPointGetCompleteServerCache(syncPoint,newEmptyPath())):(syncPoint=new SyncPoint,syncTree.syncPointTree_=syncTree.syncPointTree_.set(path,syncPoint)),null!=serverCache)?serverCacheComplete=!0:(serverCacheComplete=!1,serverCache=ChildrenNode.EMPTY_NODE,syncTree.syncPointTree_.subtree(path).foreachChild(function(childName,childSyncPoint){var completeCache=syncPointGetCompleteServerCache(childSyncPoint,newEmptyPath());completeCache&&(serverCache=serverCache.updateImmediateChild(childName,completeCache))}));var viewAlreadyExists=syncPointViewExistsForQuery(syncPoint,query);if(!viewAlreadyExists&&!query._queryParams.loadsAllData()){var queryKey=syncTreeMakeQueryKey_(query);util.assert(!syncTree.queryToTagMap.has(queryKey),"View does not exist, but we have a tag");var tag=function syncTreeGetNextQueryTag_(){return syncTreeNextQueryTag_++}();syncTree.queryToTagMap.set(queryKey,tag),syncTree.tagToQueryMap.set(tag,queryKey)}var events=syncPointAddEventRegistration(syncPoint,query,eventRegistration,writeTreeChildWrites(syncTree.pendingWriteTree_,path),serverCache,serverCacheComplete);if(!viewAlreadyExists&&!foundAncestorDefaultView){var view=syncPointViewForQuery(syncPoint,query);events=events.concat(function syncTreeSetupListener_(syncTree,query,view){var path=query._path,tag=syncTreeTagForQuery_(syncTree,query),listener=syncTreeCreateListenerForView_(syncTree,view),events=syncTree.listenProvider_.startListening(syncTreeQueryForListening_(query),tag,listener.hashFn,listener.onComplete),subtree=syncTree.syncPointTree_.subtree(path);if(tag)util.assert(!syncPointHasCompleteView(subtree.value),"If we're adding a query, it shouldn't be shadowed");else for(var queriesToStop=subtree.fold(function(relativePath,maybeChildSyncPoint,childMap){if(!pathIsEmpty(relativePath)&&maybeChildSyncPoint&&syncPointHasCompleteView(maybeChildSyncPoint))return[syncPointGetCompleteView(maybeChildSyncPoint).query];var queries_1=[];return maybeChildSyncPoint&&(queries_1=queries_1.concat(syncPointGetQueryViews(maybeChildSyncPoint).map(function(view){return view.query}))),each(childMap,function(_key,childQueries){queries_1=queries_1.concat(childQueries)}),queries_1}),i=0;i<queriesToStop.length;++i){var queryToStop=queriesToStop[i];syncTree.listenProvider_.stopListening(syncTreeQueryForListening_(queryToStop),syncTreeTagForQuery_(syncTree,queryToStop))}return events}(syncTree,query,view))}return events}function syncTreeCalcCompleteEventCache(syncTree,path,writeIdsToExclude){var writeTree=syncTree.pendingWriteTree_,serverCache=syncTree.syncPointTree_.findOnPath(path,function(pathSoFar,syncPoint){var serverCache=syncPointGetCompleteServerCache(syncPoint,newRelativePath(pathSoFar,path));if(serverCache)return serverCache});return writeTreeCalcCompleteEventCache(writeTree,path,serverCache,writeIdsToExclude,!0)}function syncTreeGetServerValue(syncTree,query){var path=query._path,serverCache=null;syncTree.syncPointTree_.foreachOnPath(path,function(pathToSyncPoint,sp){var relativePath=newRelativePath(pathToSyncPoint,path);serverCache=serverCache||syncPointGetCompleteServerCache(sp,relativePath)});var syncPoint=syncTree.syncPointTree_.get(path);syncPoint?serverCache=serverCache||syncPointGetCompleteServerCache(syncPoint,newEmptyPath()):(syncPoint=new SyncPoint,syncTree.syncPointTree_=syncTree.syncPointTree_.set(path,syncPoint));var serverCacheComplete=null!=serverCache,serverCacheNode=serverCacheComplete?new CacheNode(serverCache,!0,!1):null;return function viewGetCompleteNode(view){return viewCacheGetCompleteEventSnap(view.viewCache_)}(syncPointGetView(syncPoint,query,writeTreeChildWrites(syncTree.pendingWriteTree_,query._path),serverCacheComplete?serverCacheNode.getNode():ChildrenNode.EMPTY_NODE,serverCacheComplete))}function syncTreeApplyOperationToSyncPoints_(syncTree,operation){return syncTreeApplyOperationHelper_(operation,syncTree.syncPointTree_,null,writeTreeChildWrites(syncTree.pendingWriteTree_,newEmptyPath()))}function syncTreeApplyOperationHelper_(operation,syncPointTree,serverCache,writesCache){if(pathIsEmpty(operation.path))return syncTreeApplyOperationDescendantsHelper_(operation,syncPointTree,serverCache,writesCache);var syncPoint=syncPointTree.get(newEmptyPath());null==serverCache&&null!=syncPoint&&(serverCache=syncPointGetCompleteServerCache(syncPoint,newEmptyPath()));var events=[],childName=pathGetFront(operation.path),childOperation=operation.operationForChild(childName),childTree=syncPointTree.children.get(childName);if(childTree&&childOperation){var childServerCache=serverCache?serverCache.getImmediateChild(childName):null,childWritesCache=writeTreeRefChild(writesCache,childName);events=events.concat(syncTreeApplyOperationHelper_(childOperation,childTree,childServerCache,childWritesCache))}return syncPoint&&(events=events.concat(syncPointApplyOperation(syncPoint,operation,writesCache,serverCache))),events}function syncTreeApplyOperationDescendantsHelper_(operation,syncPointTree,serverCache,writesCache){var syncPoint=syncPointTree.get(newEmptyPath());null==serverCache&&null!=syncPoint&&(serverCache=syncPointGetCompleteServerCache(syncPoint,newEmptyPath()));var events=[];return syncPointTree.children.inorderTraversal(function(childName,childTree){var childServerCache=serverCache?serverCache.getImmediateChild(childName):null,childWritesCache=writeTreeRefChild(writesCache,childName),childOperation=operation.operationForChild(childName);childOperation&&(events=events.concat(syncTreeApplyOperationDescendantsHelper_(childOperation,childTree,childServerCache,childWritesCache)))}),syncPoint&&(events=events.concat(syncPointApplyOperation(syncPoint,operation,writesCache,serverCache))),events}function syncTreeCreateListenerForView_(syncTree,view){var query=view.query,tag=syncTreeTagForQuery_(syncTree,query);return{hashFn:function(){return(function viewGetServerCache(view){return view.viewCache_.serverCache.getNode()}(view)||ChildrenNode.EMPTY_NODE).hash()},onComplete:function(status){if("ok"===status)return tag?function syncTreeApplyTaggedListenComplete(syncTree,path,tag){var queryKey=syncTreeQueryKeyForTag_(syncTree,tag);if(queryKey){var r=syncTreeParseQueryKey_(queryKey),queryPath=r.path,queryId=r.queryId,relativePath=newRelativePath(queryPath,path);return syncTreeApplyTaggedOperation_(syncTree,queryPath,new ListenComplete(newOperationSourceServerTaggedQuery(queryId),relativePath))}return[]}(syncTree,query._path,tag):function syncTreeApplyListenComplete(syncTree,path){return syncTreeApplyOperationToSyncPoints_(syncTree,new ListenComplete({fromUser:!1,fromServer:!0,queryId:null,tagged:!1},path))}(syncTree,query._path);var error=function errorForServerCode(code,query){var reason="Unknown Error";"too_big"===code?reason="The data requested exceeds the maximum size that can be accessed with a single request.":"permission_denied"===code?reason="Client doesn't have permission to access the desired data.":"unavailable"===code&&(reason="The service is unavailable");var error=new Error(code+" at "+query._path.toString()+": "+reason);return error.code=code.toUpperCase(),error}(status,query);return syncTreeRemoveEventRegistration(syncTree,query,null,error)}}}function syncTreeTagForQuery_(syncTree,query){var queryKey=syncTreeMakeQueryKey_(query);return syncTree.queryToTagMap.get(queryKey)}function syncTreeMakeQueryKey_(query){return query._path.toString()+"$"+query._queryIdentifier}function syncTreeQueryKeyForTag_(syncTree,tag){return syncTree.tagToQueryMap.get(tag)}function syncTreeParseQueryKey_(queryKey){var splitIndex=queryKey.indexOf("$");return util.assert(-1!==splitIndex&&splitIndex<queryKey.length-1,"Bad queryKey."),{queryId:queryKey.substr(splitIndex+1),path:new Path(queryKey.substr(0,splitIndex))}}function syncTreeApplyTaggedOperation_(syncTree,queryPath,operation){var syncPoint=syncTree.syncPointTree_.get(queryPath);return util.assert(syncPoint,"Missing sync point for query tag that we're tracking"),syncPointApplyOperation(syncPoint,operation,writeTreeChildWrites(syncTree.pendingWriteTree_,queryPath),null)}function syncTreeQueryForListening_(query){return query._queryParams.loadsAllData()&&!query._queryParams.isDefault()?new(function syncTreeGetReferenceConstructor(){return util.assert(referenceConstructor,"Reference.ts has not been loaded"),referenceConstructor}())(query._repo,query._path):query}var ExistingValueProvider=function(){function ExistingValueProvider(node_){this.node_=node_}return ExistingValueProvider.prototype.getImmediateChild=function(childName){return new ExistingValueProvider(this.node_.getImmediateChild(childName))},ExistingValueProvider.prototype.node=function(){return this.node_},ExistingValueProvider}(),DeferredValueProvider=function(){function DeferredValueProvider(syncTree,path){this.syncTree_=syncTree,this.path_=path}return DeferredValueProvider.prototype.getImmediateChild=function(childName){var childPath=pathChild(this.path_,childName);return new DeferredValueProvider(this.syncTree_,childPath)},DeferredValueProvider.prototype.node=function(){return syncTreeCalcCompleteEventCache(this.syncTree_,this.path_)},DeferredValueProvider}(),resolveDeferredLeafValue=function(value,existingVal,serverValues){return value&&"object"==typeof value?(util.assert(".sv"in value,"Unexpected leaf node or priority contents"),"string"==typeof value[".sv"]?resolveScalarDeferredValue(value[".sv"],existingVal,serverValues):"object"==typeof value[".sv"]?resolveComplexDeferredValue(value[".sv"],existingVal):void util.assert(!1,"Unexpected server value: "+JSON.stringify(value,null,2))):value},resolveScalarDeferredValue=function(op,existing,serverValues){switch(op){case"timestamp":return serverValues.timestamp;default:util.assert(!1,"Unexpected server value: "+op)}},resolveComplexDeferredValue=function(op,existing,unused){op.hasOwnProperty("increment")||util.assert(!1,"Unexpected server value: "+JSON.stringify(op,null,2));var delta=op.increment;"number"!=typeof delta&&util.assert(!1,"Unexpected increment value: "+delta);var existingNode=existing.node();if(util.assert(null!=existingNode,"Expected ChildrenNode.EMPTY_NODE for nulls"),!existingNode.isLeafNode())return delta;var existingVal=existingNode.getValue();return"number"!=typeof existingVal?delta:existingVal+delta},resolveDeferredValueTree=function(path,node,syncTree,serverValues){return resolveDeferredValue(node,new DeferredValueProvider(syncTree,path),serverValues)},resolveDeferredValueSnapshot=function(node,existing,serverValues){return resolveDeferredValue(node,new ExistingValueProvider(existing),serverValues)};function resolveDeferredValue(node,existingVal,serverValues){var newNode,rawPri=node.getPriority().val(),priority=resolveDeferredLeafValue(rawPri,existingVal.getImmediateChild(".priority"),serverValues);if(node.isLeafNode()){var leafNode=node,value=resolveDeferredLeafValue(leafNode.getValue(),existingVal,serverValues);return value!==leafNode.getValue()||priority!==leafNode.getPriority().val()?new LeafNode(value,nodeFromJSON(priority)):node}var childrenNode=node;return newNode=childrenNode,priority!==childrenNode.getPriority().val()&&(newNode=newNode.updatePriority(new LeafNode(priority))),childrenNode.forEachChild(PRIORITY_INDEX,function(childName,childNode){var newChildNode=resolveDeferredValue(childNode,existingVal.getImmediateChild(childName),serverValues);newChildNode!==childNode&&(newNode=newNode.updateImmediateChild(childName,newChildNode))}),newNode}var Tree=function Tree(name,parent,node){void 0===name&&(name=""),void 0===parent&&(parent=null),void 0===node&&(node={children:{},childCount:0}),this.name=name,this.parent=parent,this.node=node};function treeSubTree(tree,pathObj){for(var path=pathObj instanceof Path?pathObj:new Path(pathObj),child=tree,next=pathGetFront(path);null!==next;){var childNode=util.safeGet(child.node.children,next)||{children:{},childCount:0};child=new Tree(next,child,childNode),next=pathGetFront(path=pathPopFront(path))}return child}function treeGetValue(tree){return tree.node.value}function treeSetValue(tree,value){tree.node.value=value,treeUpdateParents(tree)}function treeHasChildren(tree){return tree.node.childCount>0}function treeForEachChild(tree,action){each(tree.node.children,function(child,childTree){action(new Tree(child,tree,childTree))})}function treeForEachDescendant(tree,action,includeSelf,childrenFirst){includeSelf&&!childrenFirst&&action(tree),treeForEachChild(tree,function(child){treeForEachDescendant(child,action,!0,childrenFirst)}),includeSelf&&childrenFirst&&action(tree)}function treeGetPath(tree){return new Path(null===tree.parent?tree.name:treeGetPath(tree.parent)+"/"+tree.name)}function treeUpdateParents(tree){null!==tree.parent&&function treeUpdateChild(tree,childName,child){var childEmpty=function treeIsEmpty(tree){return void 0===treeGetValue(tree)&&!treeHasChildren(tree)}(child),childExists=util.contains(tree.node.children,childName);childEmpty&&childExists?(delete tree.node.children[childName],tree.node.childCount--,treeUpdateParents(tree)):childEmpty||childExists||(tree.node.children[childName]=child.node,tree.node.childCount++,treeUpdateParents(tree))}(tree.parent,tree.name,tree)}var INVALID_KEY_REGEX_=/[\[\].#$\/\u0000-\u001F\u007F]/,INVALID_PATH_REGEX_=/[\[\].#$\u0000-\u001F\u007F]/,isValidKey=function(key){return"string"==typeof key&&0!==key.length&&!INVALID_KEY_REGEX_.test(key)},isValidPathString=function(pathString){return"string"==typeof pathString&&0!==pathString.length&&!INVALID_PATH_REGEX_.test(pathString)},isValidPriority=function(priority){return null===priority||"string"==typeof priority||"number"==typeof priority&&!isInvalidJSONNumber(priority)||priority&&"object"==typeof priority&&util.contains(priority,".sv")},validateFirebaseDataArg=function(fnName,value,path,optional){optional&&void 0===value||validateFirebaseData(util.errorPrefix(fnName,"value"),value,path)},validateFirebaseData=function(errorPrefix,data,path_){var path=path_ instanceof Path?new ValidationPath(path_,errorPrefix):path_;if(void 0===data)throw new Error(errorPrefix+"contains undefined "+validationPathToErrorString(path));if("function"==typeof data)throw new Error(errorPrefix+"contains a function "+validationPathToErrorString(path)+" with contents = "+data.toString());if(isInvalidJSONNumber(data))throw new Error(errorPrefix+"contains "+data.toString()+" "+validationPathToErrorString(path));if("string"==typeof data&&data.length>10485760/3&&util.stringLength(data)>10485760)throw new Error(errorPrefix+"contains a string greater than 10485760 utf8 bytes "+validationPathToErrorString(path)+" ('"+data.substring(0,50)+"...')");if(data&&"object"==typeof data){var hasDotValue_1=!1,hasActualChild_1=!1;if(each(data,function(key,value){if(".value"===key)hasDotValue_1=!0;else if(".priority"!==key&&".sv"!==key&&(hasActualChild_1=!0,!isValidKey(key)))throw new Error(errorPrefix+" contains an invalid key ("+key+") "+validationPathToErrorString(path)+'.  Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"');!function validationPathPush(validationPath,child){validationPath.parts_.length>0&&(validationPath.byteLength_+=1),validationPath.parts_.push(child),validationPath.byteLength_+=util.stringLength(child),validationPathCheckValid(validationPath)}(path,key),validateFirebaseData(errorPrefix,value,path),function validationPathPop(validationPath){var last=validationPath.parts_.pop();validationPath.byteLength_-=util.stringLength(last),validationPath.parts_.length>0&&(validationPath.byteLength_-=1)}(path)}),hasDotValue_1&&hasActualChild_1)throw new Error(errorPrefix+' contains ".value" child '+validationPathToErrorString(path)+" in addition to actual children.")}},validateFirebaseMergeDataArg=function(fnName,data,path,optional){if(!optional||void 0!==data){var errorPrefix=util.errorPrefix(fnName,"values");if(!data||"object"!=typeof data||Array.isArray(data))throw new Error(errorPrefix+" must be an object containing the children to replace.");var mergePaths=[];each(data,function(key,value){var curPath=new Path(key);if(validateFirebaseData(errorPrefix,value,pathChild(path,curPath)),".priority"===pathGetBack(curPath)&&!isValidPriority(value))throw new Error(errorPrefix+"contains an invalid value for '"+curPath.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");mergePaths.push(curPath)}),function(errorPrefix,mergePaths){var i,curPath;for(i=0;i<mergePaths.length;i++)for(var keys=pathSlice(curPath=mergePaths[i]),j=0;j<keys.length;j++)if(".priority"===keys[j]&&j===keys.length-1);else if(!isValidKey(keys[j]))throw new Error(errorPrefix+"contains an invalid key ("+keys[j]+") in path "+curPath.toString()+'. Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"');mergePaths.sort(pathCompare);var prevPath=null;for(i=0;i<mergePaths.length;i++){if(curPath=mergePaths[i],null!==prevPath&&pathContains(prevPath,curPath))throw new Error(errorPrefix+"contains a path "+prevPath.toString()+" that is ancestor of another path "+curPath.toString());prevPath=curPath}}(errorPrefix,mergePaths)}},validatePriority=function(fnName,priority,optional){if(!optional||void 0!==priority){if(isInvalidJSONNumber(priority))throw new Error(util.errorPrefix(fnName,"priority")+"is "+priority.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!isValidPriority(priority))throw new Error(util.errorPrefix(fnName,"priority")+"must be a valid Firebase priority (a string, finite number, server value, or null).")}},validateEventType=function(fnName,eventType,optional){if(!optional||void 0!==eventType)switch(eventType){case"value":case"child_added":case"child_removed":case"child_changed":case"child_moved":break;default:throw new Error(util.errorPrefix(fnName,"eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}},validateKey=function(fnName,argumentName,key,optional){if(!(optional&&void 0===key||isValidKey(key)))throw new Error(util.errorPrefix(fnName,argumentName)+'was an invalid key = "'+key+'".  Firebase keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]").')},validatePathString=function(fnName,argumentName,pathString,optional){if(!(optional&&void 0===pathString||isValidPathString(pathString)))throw new Error(util.errorPrefix(fnName,argumentName)+'was an invalid path = "'+pathString+'". Paths must be non-empty strings and can\'t contain ".", "#", "$", "[", or "]"')},validateWritablePath=function(fnName,path){if(".info"===pathGetFront(path))throw new Error(fnName+" failed = Can't modify data under /.info/")},validateUrl=function(fnName,parsedUrl){var pathString=parsedUrl.path.toString();if("string"!=typeof parsedUrl.repoInfo.host||0===parsedUrl.repoInfo.host.length||!isValidKey(parsedUrl.repoInfo.namespace)&&"localhost"!==parsedUrl.repoInfo.host.split(":")[0]||0!==pathString.length&&!function(pathString){return pathString&&(pathString=pathString.replace(/^\/*\.info(\/|$)/,"/")),isValidPathString(pathString)}(pathString))throw new Error(util.errorPrefix(fnName,"url")+'must be a valid firebase URL and the path can\'t contain ".", "#", "$", "[", or "]".')},validateBoolean=function(fnName,argumentName,bool,optional){if((!optional||void 0!==bool)&&"boolean"!=typeof bool)throw new Error(util.errorPrefix(fnName,argumentName)+"must be a boolean.")},EventQueue=function EventQueue(){this.eventLists_=[],this.recursionDepth_=0};function eventQueueQueueEvents(eventQueue,eventDataList){for(var currList=null,i=0;i<eventDataList.length;i++){var data=eventDataList[i],path=data.getPath();null===currList||pathEquals(path,currList.path)||(eventQueue.eventLists_.push(currList),currList=null),null===currList&&(currList={events:[],path:path}),currList.events.push(data)}currList&&eventQueue.eventLists_.push(currList)}function eventQueueRaiseEventsAtPath(eventQueue,path,eventDataList){eventQueueQueueEvents(eventQueue,eventDataList),eventQueueRaiseQueuedEventsMatchingPredicate(eventQueue,function(eventPath){return pathEquals(eventPath,path)})}function eventQueueRaiseEventsForChangedPath(eventQueue,changedPath,eventDataList){eventQueueQueueEvents(eventQueue,eventDataList),eventQueueRaiseQueuedEventsMatchingPredicate(eventQueue,function(eventPath){return pathContains(eventPath,changedPath)||pathContains(changedPath,eventPath)})}function eventQueueRaiseQueuedEventsMatchingPredicate(eventQueue,predicate){eventQueue.recursionDepth_++;for(var sentAll=!0,i=0;i<eventQueue.eventLists_.length;i++){var eventList=eventQueue.eventLists_[i];if(eventList)predicate(eventList.path)?(eventListRaise(eventQueue.eventLists_[i]),eventQueue.eventLists_[i]=null):sentAll=!1}sentAll&&(eventQueue.eventLists_=[]),eventQueue.recursionDepth_--}function eventListRaise(eventList){for(var i=0;i<eventList.events.length;i++){var eventData=eventList.events[i];if(null!==eventData){eventList.events[i]=null;var eventFn=eventData.getEventRunner();logger&&log("event: "+eventData.toString()),exceptionGuard(eventFn)}}}var Repo=function(){function Repo(repoInfo_,forceRestClient_,authTokenProvider_,appCheckProvider_){this.repoInfo_=repoInfo_,this.forceRestClient_=forceRestClient_,this.authTokenProvider_=authTokenProvider_,this.appCheckProvider_=appCheckProvider_,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new EventQueue,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=newSparseSnapshotTree(),this.transactionQueueTree_=new Tree,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}return Repo.prototype.toString=function(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host},Repo}();function repoStart(repo,appId,authOverride){if(repo.stats_=statsManagerGetCollection(repo.repoInfo_),repo.forceRestClient_||("object"==typeof window&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0)repo.server_=new ReadonlyRestClient(repo.repoInfo_,function(pathString,data,isMerge,tag){repoOnDataUpdate(repo,pathString,data,isMerge,tag)},repo.authTokenProvider_,repo.appCheckProvider_),setTimeout(function(){return repoOnConnectStatus(repo,!0)},0);else{if(null!=authOverride){if("object"!=typeof authOverride)throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{util.stringify(authOverride)}catch(e){throw new Error("Invalid authOverride provided: "+e)}}repo.persistentConnection_=new PersistentConnection(repo.repoInfo_,appId,function(pathString,data,isMerge,tag){repoOnDataUpdate(repo,pathString,data,isMerge,tag)},function(connectStatus){repoOnConnectStatus(repo,connectStatus)},function(updates){!function repoOnServerInfoUpdate(repo,updates){each(updates,function(key,value){repoUpdateInfo(repo,key,value)})}(repo,updates)},repo.authTokenProvider_,repo.appCheckProvider_,authOverride),repo.server_=repo.persistentConnection_}repo.authTokenProvider_.addTokenChangeListener(function(token){repo.server_.refreshAuthToken(token)}),repo.appCheckProvider_.addTokenChangeListener(function(result){repo.server_.refreshAppCheckToken(result.token)}),repo.statsReporter_=function statsManagerGetOrCreateReporter(repoInfo,creatorFunction){var hashString=repoInfo.toString();return reporters[hashString]||(reporters[hashString]=creatorFunction()),reporters[hashString]}(repo.repoInfo_,function(){return new StatsReporter(repo.stats_,repo.server_)}),repo.infoData_=new SnapshotHolder,repo.infoSyncTree_=new SyncTree({startListening:function(query,tag,currentHashFn,onComplete){var infoEvents=[],node=repo.infoData_.getNode(query._path);return node.isEmpty()||(infoEvents=syncTreeApplyServerOverwrite(repo.infoSyncTree_,query._path,node),setTimeout(function(){onComplete("ok")},0)),infoEvents},stopListening:function(){}}),repoUpdateInfo(repo,"connected",!1),repo.serverSyncTree_=new SyncTree({startListening:function(query,tag,currentHashFn,onComplete){return repo.server_.listen(query,currentHashFn,tag,function(status,data){var events=onComplete(status,data);eventQueueRaiseEventsForChangedPath(repo.eventQueue_,query._path,events)}),[]},stopListening:function(query,tag){repo.server_.unlisten(query,tag)}})}function repoServerTime(repo){var offset=repo.infoData_.getNode(new Path(".info/serverTimeOffset")).val()||0;return(new Date).getTime()+offset}function repoGenerateServerValues(repo){return(values=(values={timestamp:repoServerTime(repo)})||{}).timestamp=values.timestamp||(new Date).getTime(),values;var values}function repoOnDataUpdate(repo,pathString,data,isMerge,tag){repo.dataUpdateCount++;var path=new Path(pathString);data=repo.interceptServerDataCallback_?repo.interceptServerDataCallback_(pathString,data):data;var events=[];if(tag)if(isMerge){var taggedChildren=util.map(data,function(raw){return nodeFromJSON(raw)});events=function syncTreeApplyTaggedQueryMerge(syncTree,path,changedChildren,tag){var queryKey=syncTreeQueryKeyForTag_(syncTree,tag);if(queryKey){var r=syncTreeParseQueryKey_(queryKey),queryPath=r.path,queryId=r.queryId,relativePath=newRelativePath(queryPath,path),changeTree=ImmutableTree.fromObject(changedChildren);return syncTreeApplyTaggedOperation_(syncTree,queryPath,new Merge(newOperationSourceServerTaggedQuery(queryId),relativePath,changeTree))}return[]}(repo.serverSyncTree_,path,taggedChildren,tag)}else{var taggedSnap=nodeFromJSON(data);events=function syncTreeApplyTaggedQueryOverwrite(syncTree,path,snap,tag){var queryKey=syncTreeQueryKeyForTag_(syncTree,tag);if(null!=queryKey){var r=syncTreeParseQueryKey_(queryKey),queryPath=r.path,queryId=r.queryId,relativePath=newRelativePath(queryPath,path);return syncTreeApplyTaggedOperation_(syncTree,queryPath,new Overwrite(newOperationSourceServerTaggedQuery(queryId),relativePath,snap))}return[]}(repo.serverSyncTree_,path,taggedSnap,tag)}else if(isMerge){var changedChildren=util.map(data,function(raw){return nodeFromJSON(raw)});events=function syncTreeApplyServerMerge(syncTree,path,changedChildren){var changeTree=ImmutableTree.fromObject(changedChildren);return syncTreeApplyOperationToSyncPoints_(syncTree,new Merge({fromUser:!1,fromServer:!0,queryId:null,tagged:!1},path,changeTree))}(repo.serverSyncTree_,path,changedChildren)}else{var snap=nodeFromJSON(data);events=syncTreeApplyServerOverwrite(repo.serverSyncTree_,path,snap)}var affectedPath=path;events.length>0&&(affectedPath=repoRerunTransactions(repo,path)),eventQueueRaiseEventsForChangedPath(repo.eventQueue_,affectedPath,events)}function repoOnConnectStatus(repo,connectStatus){repoUpdateInfo(repo,"connected",connectStatus),!1===connectStatus&&function repoRunOnDisconnectEvents(repo){repoLog(repo,"onDisconnectEvents");var serverValues=repoGenerateServerValues(repo),resolvedOnDisconnectTree=newSparseSnapshotTree();sparseSnapshotTreeForEachTree(repo.onDisconnect_,newEmptyPath(),function(path,node){var resolved=resolveDeferredValueTree(path,node,repo.serverSyncTree_,serverValues);sparseSnapshotTreeRemember(resolvedOnDisconnectTree,path,resolved)});var events=[];sparseSnapshotTreeForEachTree(resolvedOnDisconnectTree,newEmptyPath(),function(path,snap){events=events.concat(syncTreeApplyServerOverwrite(repo.serverSyncTree_,path,snap));var affectedPath=repoAbortTransactions(repo,path);repoRerunTransactions(repo,affectedPath)}),repo.onDisconnect_=newSparseSnapshotTree(),eventQueueRaiseEventsForChangedPath(repo.eventQueue_,newEmptyPath(),events)}(repo)}function repoUpdateInfo(repo,pathString,value){var path=new Path("/.info/"+pathString),newNode=nodeFromJSON(value);repo.infoData_.updateSnapshot(path,newNode);var events=syncTreeApplyServerOverwrite(repo.infoSyncTree_,path,newNode);eventQueueRaiseEventsForChangedPath(repo.eventQueue_,path,events)}function repoGetNextWriteId(repo){return repo.nextWriteId_++}function repoSetWithPriority(repo,path,newVal,newPriority,onComplete){repoLog(repo,"set",{path:path.toString(),value:newVal,priority:newPriority});var serverValues=repoGenerateServerValues(repo),newNodeUnresolved=nodeFromJSON(newVal,newPriority),existing=syncTreeCalcCompleteEventCache(repo.serverSyncTree_,path),newNode=resolveDeferredValueSnapshot(newNodeUnresolved,existing,serverValues),writeId=repoGetNextWriteId(repo),events=syncTreeApplyUserOverwrite(repo.serverSyncTree_,path,newNode,writeId,!0);eventQueueQueueEvents(repo.eventQueue_,events),repo.server_.put(path.toString(),newNodeUnresolved.val(!0),function(status,errorReason){var success="ok"===status;success||warn("set at "+path+" failed: "+status);var clearEvents=syncTreeAckUserWrite(repo.serverSyncTree_,writeId,!success);eventQueueRaiseEventsForChangedPath(repo.eventQueue_,path,clearEvents),repoCallOnCompleteCallback(repo,onComplete,status,errorReason)});var affectedPath=repoAbortTransactions(repo,path);repoRerunTransactions(repo,affectedPath),eventQueueRaiseEventsForChangedPath(repo.eventQueue_,affectedPath,[])}function repoOnDisconnectCancel(repo,path,onComplete){repo.server_.onDisconnectCancel(path.toString(),function(status,errorReason){"ok"===status&&sparseSnapshotTreeForget(repo.onDisconnect_,path),repoCallOnCompleteCallback(repo,onComplete,status,errorReason)})}function repoOnDisconnectSet(repo,path,value,onComplete){var newNode=nodeFromJSON(value);repo.server_.onDisconnectPut(path.toString(),newNode.val(!0),function(status,errorReason){"ok"===status&&sparseSnapshotTreeRemember(repo.onDisconnect_,path,newNode),repoCallOnCompleteCallback(repo,onComplete,status,errorReason)})}function repoRemoveEventCallbackForQuery(repo,query,eventRegistration){var events;events=".info"===pathGetFront(query._path)?syncTreeRemoveEventRegistration(repo.infoSyncTree_,query,eventRegistration):syncTreeRemoveEventRegistration(repo.serverSyncTree_,query,eventRegistration),eventQueueRaiseEventsAtPath(repo.eventQueue_,query._path,events)}function repoInterrupt(repo){repo.persistentConnection_&&repo.persistentConnection_.interrupt("repo_interrupt")}function repoLog(repo){for(var varArgs=[],_i=1;_i<arguments.length;_i++)varArgs[_i-1]=arguments[_i];var prefix="";repo.persistentConnection_&&(prefix=repo.persistentConnection_.id+":"),log.apply(void 0,tslib.__spreadArray([prefix],tslib.__read(varArgs)))}function repoCallOnCompleteCallback(repo,callback,status,errorReason){callback&&exceptionGuard(function(){if("ok"===status)callback(null);else{var code=(status||"error").toUpperCase(),message=code;errorReason&&(message+=": "+errorReason);var error=new Error(message);error.code=code,callback(error)}})}function repoGetLatestState(repo,path,excludeSets){return syncTreeCalcCompleteEventCache(repo.serverSyncTree_,path,excludeSets)||ChildrenNode.EMPTY_NODE}function repoSendReadyTransactions(repo,node){if(void 0===node&&(node=repo.transactionQueueTree_),node||repoPruneCompletedTransactionsBelowNode(repo,node),treeGetValue(node)){var queue=repoBuildTransactionQueue(repo,node);util.assert(queue.length>0,"Sending zero length transaction queue"),queue.every(function(transaction){return 0===transaction.status})&&function repoSendTransactionQueue(repo,path,queue){for(var setsToIgnore=queue.map(function(txn){return txn.currentWriteId}),latestState=repoGetLatestState(repo,path,setsToIgnore),snapToSend=latestState,latestHash=latestState.hash(),i=0;i<queue.length;i++){var txn=queue[i];util.assert(0===txn.status,"tryToSendTransactionQueue_: items in queue should all be run."),txn.status=1,txn.retryCount++;var relativePath=newRelativePath(path,txn.path);snapToSend=snapToSend.updateChild(relativePath,txn.currentOutputSnapshotRaw)}var dataToSend=snapToSend.val(!0),pathToSend=path;repo.server_.put(pathToSend.toString(),dataToSend,function(status){repoLog(repo,"transaction put response",{path:pathToSend.toString(),status:status});var events=[];if("ok"===status){for(var callbacks=[],_loop_1=function(i){queue[i].status=2,events=events.concat(syncTreeAckUserWrite(repo.serverSyncTree_,queue[i].currentWriteId)),queue[i].onComplete&&callbacks.push(function(){return queue[i].onComplete(null,!0,queue[i].currentOutputSnapshotResolved)}),queue[i].unwatcher()},i=0;i<queue.length;i++)_loop_1(i);repoPruneCompletedTransactionsBelowNode(repo,treeSubTree(repo.transactionQueueTree_,path)),repoSendReadyTransactions(repo,repo.transactionQueueTree_),eventQueueRaiseEventsForChangedPath(repo.eventQueue_,path,events);for(i=0;i<callbacks.length;i++)exceptionGuard(callbacks[i])}else{if("datastale"===status)for(i=0;i<queue.length;i++)3===queue[i].status?queue[i].status=4:queue[i].status=0;else{warn("transaction at "+pathToSend.toString()+" failed: "+status);for(i=0;i<queue.length;i++)queue[i].status=4,queue[i].abortReason=status}repoRerunTransactions(repo,path)}},latestHash)}(repo,treeGetPath(node),queue)}else treeHasChildren(node)&&treeForEachChild(node,function(childNode){repoSendReadyTransactions(repo,childNode)})}function repoRerunTransactions(repo,changedPath){var rootMostTransactionNode=repoGetAncestorTransactionNode(repo,changedPath),path=treeGetPath(rootMostTransactionNode);return function repoRerunTransactionQueue(repo,queue,path){if(0===queue.length)return;for(var callbacks=[],events=[],setsToIgnore=queue.filter(function(q){return 0===q.status}).map(function(q){return q.currentWriteId}),_loop_2=function(i){var abortReason,unwatcher,transaction=queue[i],relativePath=newRelativePath(path,transaction.path),abortTransaction=!1;if(util.assert(null!==relativePath,"rerunTransactionsUnderNode_: relativePath should not be null."),4===transaction.status)abortTransaction=!0,abortReason=transaction.abortReason,events=events.concat(syncTreeAckUserWrite(repo.serverSyncTree_,transaction.currentWriteId,!0));else if(0===transaction.status)if(transaction.retryCount>=25)abortTransaction=!0,abortReason="maxretry",events=events.concat(syncTreeAckUserWrite(repo.serverSyncTree_,transaction.currentWriteId,!0));else{var currentNode=repoGetLatestState(repo,transaction.path,setsToIgnore);transaction.currentInputSnapshot=currentNode;var newData=queue[i].update(currentNode.val());if(void 0!==newData){validateFirebaseData("transaction failed: Data returned ",newData,transaction.path);var newDataNode=nodeFromJSON(newData);"object"==typeof newData&&null!=newData&&util.contains(newData,".priority")||(newDataNode=newDataNode.updatePriority(currentNode.getPriority()));var oldWriteId=transaction.currentWriteId,serverValues=repoGenerateServerValues(repo),newNodeResolved=resolveDeferredValueSnapshot(newDataNode,currentNode,serverValues);transaction.currentOutputSnapshotRaw=newDataNode,transaction.currentOutputSnapshotResolved=newNodeResolved,transaction.currentWriteId=repoGetNextWriteId(repo),setsToIgnore.splice(setsToIgnore.indexOf(oldWriteId),1),events=(events=events.concat(syncTreeApplyUserOverwrite(repo.serverSyncTree_,transaction.path,newNodeResolved,transaction.currentWriteId,transaction.applyLocally))).concat(syncTreeAckUserWrite(repo.serverSyncTree_,oldWriteId,!0))}else abortTransaction=!0,abortReason="nodata",events=events.concat(syncTreeAckUserWrite(repo.serverSyncTree_,transaction.currentWriteId,!0))}eventQueueRaiseEventsForChangedPath(repo.eventQueue_,path,events),events=[],abortTransaction&&(queue[i].status=2,unwatcher=queue[i].unwatcher,setTimeout(unwatcher,Math.floor(0)),queue[i].onComplete&&("nodata"===abortReason?callbacks.push(function(){return queue[i].onComplete(null,!1,queue[i].currentInputSnapshot)}):callbacks.push(function(){return queue[i].onComplete(new Error(abortReason),!1,null)})))},i=0;i<queue.length;i++)_loop_2(i);repoPruneCompletedTransactionsBelowNode(repo,repo.transactionQueueTree_);for(i=0;i<callbacks.length;i++)exceptionGuard(callbacks[i]);repoSendReadyTransactions(repo,repo.transactionQueueTree_)}(repo,repoBuildTransactionQueue(repo,rootMostTransactionNode),path),path}function repoGetAncestorTransactionNode(repo,path){var front,transactionNode=repo.transactionQueueTree_;for(front=pathGetFront(path);null!==front&&void 0===treeGetValue(transactionNode);)transactionNode=treeSubTree(transactionNode,front),front=pathGetFront(path=pathPopFront(path));return transactionNode}function repoBuildTransactionQueue(repo,transactionNode){var transactionQueue=[];return repoAggregateTransactionQueuesForNode(repo,transactionNode,transactionQueue),transactionQueue.sort(function(a,b){return a.order-b.order}),transactionQueue}function repoAggregateTransactionQueuesForNode(repo,node,queue){var nodeQueue=treeGetValue(node);if(nodeQueue)for(var i=0;i<nodeQueue.length;i++)queue.push(nodeQueue[i]);treeForEachChild(node,function(child){repoAggregateTransactionQueuesForNode(repo,child,queue)})}function repoPruneCompletedTransactionsBelowNode(repo,node){var queue=treeGetValue(node);if(queue){for(var to=0,from=0;from<queue.length;from++)2!==queue[from].status&&(queue[to]=queue[from],to++);queue.length=to,treeSetValue(node,queue.length>0?queue:void 0)}treeForEachChild(node,function(childNode){repoPruneCompletedTransactionsBelowNode(repo,childNode)})}function repoAbortTransactions(repo,path){var affectedPath=treeGetPath(repoGetAncestorTransactionNode(repo,path)),transactionNode=treeSubTree(repo.transactionQueueTree_,path);return function treeForEachAncestor(tree,action,includeSelf){for(var node=includeSelf?tree:tree.parent;null!==node;){if(action(node))return!0;node=node.parent}return!1}(transactionNode,function(node){repoAbortTransactionsOnNode(repo,node)}),repoAbortTransactionsOnNode(repo,transactionNode),treeForEachDescendant(transactionNode,function(node){repoAbortTransactionsOnNode(repo,node)}),affectedPath}function repoAbortTransactionsOnNode(repo,node){var queue=treeGetValue(node);if(queue){for(var callbacks=[],events=[],lastSent=-1,i=0;i<queue.length;i++)3===queue[i].status||(1===queue[i].status?(util.assert(lastSent===i-1,"All SENT items should be at beginning of queue."),lastSent=i,queue[i].status=3,queue[i].abortReason="set"):(util.assert(0===queue[i].status,"Unexpected transaction status in abort"),queue[i].unwatcher(),events=events.concat(syncTreeAckUserWrite(repo.serverSyncTree_,queue[i].currentWriteId,!0)),queue[i].onComplete&&callbacks.push(queue[i].onComplete.bind(null,new Error("set"),!1,null))));-1===lastSent?treeSetValue(node,void 0):queue.length=lastSent+1,eventQueueRaiseEventsForChangedPath(repo.eventQueue_,treeGetPath(node),events);for(i=0;i<callbacks.length;i++)exceptionGuard(callbacks[i])}}var parseRepoInfo=function(dataURL,nodeAdmin){var parsedUrl=parseDatabaseURL(dataURL),namespace=parsedUrl.namespace;"firebase.com"===parsedUrl.domain&&fatal(parsedUrl.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),namespace&&"undefined"!==namespace||"localhost"===parsedUrl.domain||fatal("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),parsedUrl.secure||"undefined"!=typeof window&&window.location&&window.location.protocol&&-1!==window.location.protocol.indexOf("https:")&&warn("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().");var webSocketOnly="ws"===parsedUrl.scheme||"wss"===parsedUrl.scheme;return{repoInfo:new RepoInfo(parsedUrl.host,parsedUrl.secure,namespace,nodeAdmin,webSocketOnly,"",namespace!==parsedUrl.subdomain),path:new Path(parsedUrl.pathString)}},parseDatabaseURL=function(dataURL){var host="",domain="",subdomain="",pathString="",namespace="",secure=!0,scheme="https",port=443;if("string"==typeof dataURL){var colonInd=dataURL.indexOf("//");colonInd>=0&&(scheme=dataURL.substring(0,colonInd-1),dataURL=dataURL.substring(colonInd+2));var slashInd=dataURL.indexOf("/");-1===slashInd&&(slashInd=dataURL.length);var questionMarkInd=dataURL.indexOf("?");-1===questionMarkInd&&(questionMarkInd=dataURL.length),host=dataURL.substring(0,Math.min(slashInd,questionMarkInd)),slashInd<questionMarkInd&&(pathString=function decodePath(pathString){for(var pathStringDecoded="",pieces=pathString.split("/"),i=0;i<pieces.length;i++)if(pieces[i].length>0){var piece=pieces[i];try{piece=decodeURIComponent(piece.replace(/\+/g," "))}catch(e){}pathStringDecoded+="/"+piece}return pathStringDecoded}(dataURL.substring(slashInd,questionMarkInd)));var queryParams=function decodeQuery(queryString){var e_1,_a,results={};"?"===queryString.charAt(0)&&(queryString=queryString.substring(1));try{for(var _b=tslib.__values(queryString.split("&")),_c=_b.next();!_c.done;_c=_b.next()){var segment=_c.value;if(0!==segment.length){var kv=segment.split("=");2===kv.length?results[decodeURIComponent(kv[0])]=decodeURIComponent(kv[1]):warn("Invalid query segment '"+segment+"' in query '"+queryString+"'")}}}catch(e_1_1){e_1={error:e_1_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_1)throw e_1.error}}return results}(dataURL.substring(Math.min(dataURL.length,questionMarkInd)));(colonInd=host.indexOf(":"))>=0?(secure="https"===scheme||"wss"===scheme,port=parseInt(host.substring(colonInd+1),10)):colonInd=host.length;var hostWithoutPort=host.slice(0,colonInd);if("localhost"===hostWithoutPort.toLowerCase())domain="localhost";else if(hostWithoutPort.split(".").length<=2)domain=hostWithoutPort;else{var dotInd=host.indexOf(".");subdomain=host.substring(0,dotInd).toLowerCase(),domain=host.substring(dotInd+1),namespace=subdomain}"ns"in queryParams&&(namespace=queryParams.ns)}return{host:host,port:port,domain:domain,subdomain:subdomain,secure:secure,scheme:scheme,pathString:pathString,namespace:namespace}},DataEvent=function(){function DataEvent(eventType,eventRegistration,snapshot,prevName){this.eventType=eventType,this.eventRegistration=eventRegistration,this.snapshot=snapshot,this.prevName=prevName}return DataEvent.prototype.getPath=function(){var ref=this.snapshot.ref;return"value"===this.eventType?ref._path:ref.parent._path},DataEvent.prototype.getEventType=function(){return this.eventType},DataEvent.prototype.getEventRunner=function(){return this.eventRegistration.getEventRunner(this)},DataEvent.prototype.toString=function(){return this.getPath().toString()+":"+this.eventType+":"+util.stringify(this.snapshot.exportVal())},DataEvent}(),CancelEvent=function(){function CancelEvent(eventRegistration,error,path){this.eventRegistration=eventRegistration,this.error=error,this.path=path}return CancelEvent.prototype.getPath=function(){return this.path},CancelEvent.prototype.getEventType=function(){return"cancel"},CancelEvent.prototype.getEventRunner=function(){return this.eventRegistration.getEventRunner(this)},CancelEvent.prototype.toString=function(){return this.path.toString()+":cancel"},CancelEvent}(),CallbackContext=function(){function CallbackContext(snapshotCallback,cancelCallback){this.snapshotCallback=snapshotCallback,this.cancelCallback=cancelCallback}return CallbackContext.prototype.onValue=function(expDataSnapshot,previousChildName){this.snapshotCallback.call(null,expDataSnapshot,previousChildName)},CallbackContext.prototype.onCancel=function(error){return util.assert(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,error)},Object.defineProperty(CallbackContext.prototype,"hasCancelCallback",{get:function(){return!!this.cancelCallback},enumerable:!1,configurable:!0}),CallbackContext.prototype.matches=function(other){return this.snapshotCallback===other.snapshotCallback||this.snapshotCallback.userCallback===other.snapshotCallback.userCallback&&this.snapshotCallback.context===other.snapshotCallback.context},CallbackContext}(),OnDisconnect$1=function(){function OnDisconnect(_repo,_path){this._repo=_repo,this._path=_path}return OnDisconnect.prototype.cancel=function(){var deferred=new util.Deferred;return repoOnDisconnectCancel(this._repo,this._path,deferred.wrapCallback(function(){})),deferred.promise},OnDisconnect.prototype.remove=function(){validateWritablePath("OnDisconnect.remove",this._path);var deferred=new util.Deferred;return repoOnDisconnectSet(this._repo,this._path,null,deferred.wrapCallback(function(){})),deferred.promise},OnDisconnect.prototype.set=function(value){validateWritablePath("OnDisconnect.set",this._path),validateFirebaseDataArg("OnDisconnect.set",value,this._path,!1);var deferred=new util.Deferred;return repoOnDisconnectSet(this._repo,this._path,value,deferred.wrapCallback(function(){})),deferred.promise},OnDisconnect.prototype.setWithPriority=function(value,priority){validateWritablePath("OnDisconnect.setWithPriority",this._path),validateFirebaseDataArg("OnDisconnect.setWithPriority",value,this._path,!1),validatePriority("OnDisconnect.setWithPriority",priority,!1);var deferred=new util.Deferred;return function repoOnDisconnectSetWithPriority(repo,path,value,priority,onComplete){var newNode=nodeFromJSON(value,priority);repo.server_.onDisconnectPut(path.toString(),newNode.val(!0),function(status,errorReason){"ok"===status&&sparseSnapshotTreeRemember(repo.onDisconnect_,path,newNode),repoCallOnCompleteCallback(0,onComplete,status,errorReason)})}(this._repo,this._path,value,priority,deferred.wrapCallback(function(){})),deferred.promise},OnDisconnect.prototype.update=function(values){validateWritablePath("OnDisconnect.update",this._path),validateFirebaseMergeDataArg("OnDisconnect.update",values,this._path,!1);var deferred=new util.Deferred;return function repoOnDisconnectUpdate(repo,path,childrenToMerge,onComplete){if(util.isEmpty(childrenToMerge))return log("onDisconnect().update() called with empty data.  Don't do anything."),void repoCallOnCompleteCallback(0,onComplete,"ok",void 0);repo.server_.onDisconnectMerge(path.toString(),childrenToMerge,function(status,errorReason){"ok"===status&&each(childrenToMerge,function(childName,childNode){var newChildNode=nodeFromJSON(childNode);sparseSnapshotTreeRemember(repo.onDisconnect_,pathChild(path,childName),newChildNode)}),repoCallOnCompleteCallback(0,onComplete,status,errorReason)})}(this._repo,this._path,values,deferred.wrapCallback(function(){})),deferred.promise},OnDisconnect}(),QueryImpl=function(){function QueryImpl(_repo,_path,_queryParams,_orderByCalled){this._repo=_repo,this._path=_path,this._queryParams=_queryParams,this._orderByCalled=_orderByCalled}return Object.defineProperty(QueryImpl.prototype,"key",{get:function(){return pathIsEmpty(this._path)?null:pathGetBack(this._path)},enumerable:!1,configurable:!0}),Object.defineProperty(QueryImpl.prototype,"ref",{get:function(){return new ReferenceImpl(this._repo,this._path)},enumerable:!1,configurable:!0}),Object.defineProperty(QueryImpl.prototype,"_queryIdentifier",{get:function(){var obj=queryParamsGetQueryObject(this._queryParams),id=ObjectToUniqueKey(obj);return"{}"===id?"default":id},enumerable:!1,configurable:!0}),Object.defineProperty(QueryImpl.prototype,"_queryObject",{get:function(){return queryParamsGetQueryObject(this._queryParams)},enumerable:!1,configurable:!0}),QueryImpl.prototype.isEqual=function(other){if(!((other=util.getModularInstance(other))instanceof QueryImpl))return!1;var sameRepo=this._repo===other._repo,samePath=pathEquals(this._path,other._path),sameQueryIdentifier=this._queryIdentifier===other._queryIdentifier;return sameRepo&&samePath&&sameQueryIdentifier},QueryImpl.prototype.toJSON=function(){return this.toString()},QueryImpl.prototype.toString=function(){return this._repo.toString()+function pathToUrlEncodedString(path){for(var pathString="",i=path.pieceNum_;i<path.pieces_.length;i++)""!==path.pieces_[i]&&(pathString+="/"+encodeURIComponent(String(path.pieces_[i])));return pathString||"/"}(this._path)},QueryImpl}();function validateNoPreviousOrderByCall(query,fnName){if(!0===query._orderByCalled)throw new Error(fnName+": You can't combine multiple orderBy calls.")}function validateQueryEndpoints(params){var startNode=null,endNode=null;if(params.hasStart()&&(startNode=params.getIndexStartValue()),params.hasEnd()&&(endNode=params.getIndexEndValue()),params.getIndex()===KEY_INDEX){var tooManyArgsError="Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().",wrongArgTypeError="Query: When ordering by key, the argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() must be a string.";if(params.hasStart()){if(params.getIndexStartName()!==MIN_NAME)throw new Error(tooManyArgsError);if("string"!=typeof startNode)throw new Error(wrongArgTypeError)}if(params.hasEnd()){if(params.getIndexEndName()!==MAX_NAME)throw new Error(tooManyArgsError);if("string"!=typeof endNode)throw new Error(wrongArgTypeError)}}else if(params.getIndex()===PRIORITY_INDEX){if(null!=startNode&&!isValidPriority(startNode)||null!=endNode&&!isValidPriority(endNode))throw new Error("Query: When ordering by priority, the first argument passed to startAt(), startAfter() endAt(), endBefore(), or equalTo() must be a valid priority value (null, a number, or a string).")}else if(util.assert(params.getIndex()instanceof PathIndex||params.getIndex()===VALUE_INDEX,"unknown index type."),null!=startNode&&"object"==typeof startNode||null!=endNode&&"object"==typeof endNode)throw new Error("Query: First argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() cannot be an object.")}function validateLimit(params){if(params.hasStart()&&params.hasEnd()&&params.hasLimit()&&!params.hasAnchoredLimit())throw new Error("Query: Can't combine startAt(), startAfter(), endAt(), endBefore(), and limit(). Use limitToFirst() or limitToLast() instead.")}var ReferenceImpl=function(_super){function ReferenceImpl(repo,path){return _super.call(this,repo,path,new QueryParams,!1)||this}return tslib.__extends(ReferenceImpl,_super),Object.defineProperty(ReferenceImpl.prototype,"parent",{get:function(){var parentPath=pathParent(this._path);return null===parentPath?null:new ReferenceImpl(this._repo,parentPath)},enumerable:!1,configurable:!0}),Object.defineProperty(ReferenceImpl.prototype,"root",{get:function(){for(var ref=this;null!==ref.parent;)ref=ref.parent;return ref},enumerable:!1,configurable:!0}),ReferenceImpl}(QueryImpl),DataSnapshot$1=function(){function DataSnapshot(_node,ref,_index){this._node=_node,this.ref=ref,this._index=_index}return Object.defineProperty(DataSnapshot.prototype,"priority",{get:function(){return this._node.getPriority().val()},enumerable:!1,configurable:!0}),Object.defineProperty(DataSnapshot.prototype,"key",{get:function(){return this.ref.key},enumerable:!1,configurable:!0}),Object.defineProperty(DataSnapshot.prototype,"size",{get:function(){return this._node.numChildren()},enumerable:!1,configurable:!0}),DataSnapshot.prototype.child=function(path){var childPath=new Path(path),childRef=child(this.ref,path);return new DataSnapshot(this._node.getChild(childPath),childRef,PRIORITY_INDEX)},DataSnapshot.prototype.exists=function(){return!this._node.isEmpty()},DataSnapshot.prototype.exportVal=function(){return this._node.val(!0)},DataSnapshot.prototype.forEach=function(action){var _this=this;return!this._node.isLeafNode()&&!!this._node.forEachChild(this._index,function(key,node){return action(new DataSnapshot(node,child(_this.ref,key),PRIORITY_INDEX))})},DataSnapshot.prototype.hasChild=function(path){var childPath=new Path(path);return!this._node.getChild(childPath).isEmpty()},DataSnapshot.prototype.hasChildren=function(){return!this._node.isLeafNode()&&!this._node.isEmpty()},DataSnapshot.prototype.toJSON=function(){return this.exportVal()},DataSnapshot.prototype.val=function(){return this._node.val()},DataSnapshot}();function ref(db,path){return(db=util.getModularInstance(db))._checkNotDeleted("ref"),void 0!==path?child(db._root,path):db._root}function refFromURL(db,url){(db=util.getModularInstance(db))._checkNotDeleted("refFromURL");var parsedURL=parseRepoInfo(url,db._repo.repoInfo_.nodeAdmin);validateUrl("refFromURL",parsedURL);var repoInfo=parsedURL.repoInfo;return db._repo.repoInfo_.isCustomHost()||repoInfo.host===db._repo.repoInfo_.host||fatal("refFromURL: Host name does not match the current database: (found "+repoInfo.host+" but expected "+db._repo.repoInfo_.host+")"),ref(db,parsedURL.path.toString())}function child(parent,path){var fnName,argumentName,pathString,optional;return null===pathGetFront((parent=util.getModularInstance(parent))._path)?(fnName="child",argumentName="path",optional=!1,(pathString=path)&&(pathString=pathString.replace(/^\/*\.info(\/|$)/,"/")),validatePathString(fnName,argumentName,pathString,optional)):validatePathString("child","path",path,!1),new ReferenceImpl(parent._repo,pathChild(parent._path,path))}function push(parent,value){parent=util.getModularInstance(parent),validateWritablePath("push",parent._path),validateFirebaseDataArg("push",value,parent._path,!0);var promise,now=repoServerTime(parent._repo),name=nextPushId(now),thennablePushRef=child(parent,name),pushRef=child(parent,name);return promise=null!=value?set(pushRef,value).then(function(){return pushRef}):Promise.resolve(pushRef),thennablePushRef.then=promise.then.bind(promise),thennablePushRef.catch=promise.then.bind(promise,void 0),thennablePushRef}function remove(ref){return validateWritablePath("remove",ref._path),set(ref,null)}function set(ref,value){ref=util.getModularInstance(ref),validateWritablePath("set",ref._path),validateFirebaseDataArg("set",value,ref._path,!1);var deferred=new util.Deferred;return repoSetWithPriority(ref._repo,ref._path,value,null,deferred.wrapCallback(function(){})),deferred.promise}function setPriority(ref,priority){ref=util.getModularInstance(ref),validateWritablePath("setPriority",ref._path),validatePriority("setPriority",priority,!1);var deferred=new util.Deferred;return repoSetWithPriority(ref._repo,pathChild(ref._path,".priority"),priority,null,deferred.wrapCallback(function(){})),deferred.promise}function setWithPriority(ref,value,priority){if(validateWritablePath("setWithPriority",ref._path),validateFirebaseDataArg("setWithPriority",value,ref._path,!1),validatePriority("setWithPriority",priority,!1),".length"===ref.key||".keys"===ref.key)throw"setWithPriority failed: "+ref.key+" is a read-only object.";var deferred=new util.Deferred;return repoSetWithPriority(ref._repo,ref._path,value,priority,deferred.wrapCallback(function(){})),deferred.promise}function update(ref,values){validateFirebaseMergeDataArg("update",values,ref._path,!1);var deferred=new util.Deferred;return function repoUpdate(repo,path,childrenToMerge,onComplete){repoLog(repo,"update",{path:path.toString(),value:childrenToMerge});var empty=!0,serverValues=repoGenerateServerValues(repo),changedChildren={};if(each(childrenToMerge,function(changedKey,changedValue){empty=!1,changedChildren[changedKey]=resolveDeferredValueTree(pathChild(path,changedKey),nodeFromJSON(changedValue),repo.serverSyncTree_,serverValues)}),empty)log("update() called with empty data.  Don't do anything."),repoCallOnCompleteCallback(0,onComplete,"ok",void 0);else{var writeId_1=repoGetNextWriteId(repo),events=syncTreeApplyUserMerge(repo.serverSyncTree_,path,changedChildren,writeId_1);eventQueueQueueEvents(repo.eventQueue_,events),repo.server_.merge(path.toString(),childrenToMerge,function(status,errorReason){var success="ok"===status;success||warn("update at "+path+" failed: "+status);var clearEvents=syncTreeAckUserWrite(repo.serverSyncTree_,writeId_1,!success),affectedPath=clearEvents.length>0?repoRerunTransactions(repo,path):path;eventQueueRaiseEventsForChangedPath(repo.eventQueue_,affectedPath,clearEvents),repoCallOnCompleteCallback(0,onComplete,status,errorReason)}),each(childrenToMerge,function(changedPath){var affectedPath=repoAbortTransactions(repo,pathChild(path,changedPath));repoRerunTransactions(repo,affectedPath)}),eventQueueRaiseEventsForChangedPath(repo.eventQueue_,path,[])}}(ref._repo,ref._path,values,deferred.wrapCallback(function(){})),deferred.promise}function get(query){return function repoGetValue(repo,query){var cached=syncTreeGetServerValue(repo.serverSyncTree_,query);return null!=cached?Promise.resolve(cached):repo.server_.get(query).then(function(payload){var node=nodeFromJSON(payload).withIndex(query._queryParams.getIndex()),events=syncTreeApplyServerOverwrite(repo.serverSyncTree_,query._path,node);return eventQueueRaiseEventsAtPath(repo.eventQueue_,query._path,events),Promise.resolve(node)},function(err){return repoLog(repo,"get for query "+util.stringify(query)+" failed: "+err),Promise.reject(new Error(err))})}((query=util.getModularInstance(query))._repo,query).then(function(node){return new DataSnapshot$1(node,new ReferenceImpl(query._repo,query._path),query._queryParams.getIndex())})}var ValueEventRegistration=function(){function ValueEventRegistration(callbackContext){this.callbackContext=callbackContext}return ValueEventRegistration.prototype.respondsTo=function(eventType){return"value"===eventType},ValueEventRegistration.prototype.createEvent=function(change,query){var index=query._queryParams.getIndex();return new DataEvent("value",this,new DataSnapshot$1(change.snapshotNode,new ReferenceImpl(query._repo,query._path),index))},ValueEventRegistration.prototype.getEventRunner=function(eventData){var _this=this;return"cancel"===eventData.getEventType()?function(){return _this.callbackContext.onCancel(eventData.error)}:function(){return _this.callbackContext.onValue(eventData.snapshot,null)}},ValueEventRegistration.prototype.createCancelEvent=function(error,path){return this.callbackContext.hasCancelCallback?new CancelEvent(this,error,path):null},ValueEventRegistration.prototype.matches=function(other){return other instanceof ValueEventRegistration&&(!other.callbackContext||!this.callbackContext||other.callbackContext.matches(this.callbackContext))},ValueEventRegistration.prototype.hasAnyCallback=function(){return null!==this.callbackContext},ValueEventRegistration}(),ChildEventRegistration=function(){function ChildEventRegistration(eventType,callbackContext){this.eventType=eventType,this.callbackContext=callbackContext}return ChildEventRegistration.prototype.respondsTo=function(eventType){var eventToCheck="children_added"===eventType?"child_added":eventType;return eventToCheck="children_removed"===eventToCheck?"child_removed":eventToCheck,this.eventType===eventToCheck},ChildEventRegistration.prototype.createCancelEvent=function(error,path){return this.callbackContext.hasCancelCallback?new CancelEvent(this,error,path):null},ChildEventRegistration.prototype.createEvent=function(change,query){util.assert(null!=change.childName,"Child events should have a childName.");var childRef=child(new ReferenceImpl(query._repo,query._path),change.childName),index=query._queryParams.getIndex();return new DataEvent(change.type,this,new DataSnapshot$1(change.snapshotNode,childRef,index),change.prevName)},ChildEventRegistration.prototype.getEventRunner=function(eventData){var _this=this;return"cancel"===eventData.getEventType()?function(){return _this.callbackContext.onCancel(eventData.error)}:function(){return _this.callbackContext.onValue(eventData.snapshot,eventData.prevName)}},ChildEventRegistration.prototype.matches=function(other){return other instanceof ChildEventRegistration&&(this.eventType===other.eventType&&(!this.callbackContext||!other.callbackContext||this.callbackContext.matches(other.callbackContext)))},ChildEventRegistration.prototype.hasAnyCallback=function(){return!!this.callbackContext},ChildEventRegistration}();function addEventListener(query,eventType,callback,cancelCallbackOrListenOptions,options){var cancelCallback;if("object"==typeof cancelCallbackOrListenOptions&&(cancelCallback=void 0,options=cancelCallbackOrListenOptions),"function"==typeof cancelCallbackOrListenOptions&&(cancelCallback=cancelCallbackOrListenOptions),options&&options.onlyOnce){var userCallback_1=callback,onceCallback=function(dataSnapshot,previousChildName){repoRemoveEventCallbackForQuery(query._repo,query,container),userCallback_1(dataSnapshot,previousChildName)};onceCallback.userCallback=callback.userCallback,onceCallback.context=callback.context,callback=onceCallback}var callbackContext=new CallbackContext(callback,cancelCallback||void 0),container="value"===eventType?new ValueEventRegistration(callbackContext):new ChildEventRegistration(eventType,callbackContext);return function repoAddEventCallbackForQuery(repo,query,eventRegistration){var events;events=".info"===pathGetFront(query._path)?syncTreeAddEventRegistration(repo.infoSyncTree_,query,eventRegistration):syncTreeAddEventRegistration(repo.serverSyncTree_,query,eventRegistration),eventQueueRaiseEventsAtPath(repo.eventQueue_,query._path,events)}(query._repo,query,container),function(){return repoRemoveEventCallbackForQuery(query._repo,query,container)}}function onValue(query,callback,cancelCallbackOrListenOptions,options){return addEventListener(query,"value",callback,cancelCallbackOrListenOptions,options)}function onChildAdded(query,callback,cancelCallbackOrListenOptions,options){return addEventListener(query,"child_added",callback,cancelCallbackOrListenOptions,options)}function onChildChanged(query,callback,cancelCallbackOrListenOptions,options){return addEventListener(query,"child_changed",callback,cancelCallbackOrListenOptions,options)}function onChildMoved(query,callback,cancelCallbackOrListenOptions,options){return addEventListener(query,"child_moved",callback,cancelCallbackOrListenOptions,options)}function onChildRemoved(query,callback,cancelCallbackOrListenOptions,options){return addEventListener(query,"child_removed",callback,cancelCallbackOrListenOptions,options)}function off(query,eventType,callback){var container=null,expCallback=callback?new CallbackContext(callback):null;"value"===eventType?container=new ValueEventRegistration(expCallback):eventType&&(container=new ChildEventRegistration(eventType,expCallback)),repoRemoveEventCallbackForQuery(query._repo,query,container)}var QueryConstraint=function QueryConstraint(){},QueryEndAtConstraint=function(_super){function QueryEndAtConstraint(_value,_key){var _this=_super.call(this)||this;return _this._value=_value,_this._key=_key,_this}return tslib.__extends(QueryEndAtConstraint,_super),QueryEndAtConstraint.prototype._apply=function(query){validateFirebaseDataArg("endAt",this._value,query._path,!0);var newParams=queryParamsEndAt(query._queryParams,this._value,this._key);if(validateLimit(newParams),validateQueryEndpoints(newParams),query._queryParams.hasEnd())throw new Error("endAt: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new QueryImpl(query._repo,query._path,newParams,query._orderByCalled)},QueryEndAtConstraint}(QueryConstraint);function endAt(value,key){return validateKey("endAt","key",key,!0),new QueryEndAtConstraint(value,key)}var QueryEndBeforeConstraint=function(_super){function QueryEndBeforeConstraint(_value,_key){var _this=_super.call(this)||this;return _this._value=_value,_this._key=_key,_this}return tslib.__extends(QueryEndBeforeConstraint,_super),QueryEndBeforeConstraint.prototype._apply=function(query){validateFirebaseDataArg("endBefore",this._value,query._path,!1);var newParams=function queryParamsEndBefore(queryParams,indexValue,key){var params;return queryParams.index_===KEY_INDEX?("string"==typeof indexValue&&(indexValue=predecessor(indexValue)),params=queryParamsEndAt(queryParams,indexValue,key)):params=queryParamsEndAt(queryParams,indexValue,null==key?MIN_NAME:predecessor(key)),params.endBeforeSet_=!0,params}(query._queryParams,this._value,this._key);if(validateLimit(newParams),validateQueryEndpoints(newParams),query._queryParams.hasEnd())throw new Error("endBefore: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new QueryImpl(query._repo,query._path,newParams,query._orderByCalled)},QueryEndBeforeConstraint}(QueryConstraint);function endBefore(value,key){return validateKey("endBefore","key",key,!0),new QueryEndBeforeConstraint(value,key)}var QueryStartAtConstraint=function(_super){function QueryStartAtConstraint(_value,_key){var _this=_super.call(this)||this;return _this._value=_value,_this._key=_key,_this}return tslib.__extends(QueryStartAtConstraint,_super),QueryStartAtConstraint.prototype._apply=function(query){validateFirebaseDataArg("startAt",this._value,query._path,!0);var newParams=queryParamsStartAt(query._queryParams,this._value,this._key);if(validateLimit(newParams),validateQueryEndpoints(newParams),query._queryParams.hasStart())throw new Error("startAt: Starting point was already set (by another call to startAt, startBefore or equalTo).");return new QueryImpl(query._repo,query._path,newParams,query._orderByCalled)},QueryStartAtConstraint}(QueryConstraint);function startAt(value,key){return void 0===value&&(value=null),validateKey("startAt","key",key,!0),new QueryStartAtConstraint(value,key)}var QueryStartAfterConstraint=function(_super){function QueryStartAfterConstraint(_value,_key){var _this=_super.call(this)||this;return _this._value=_value,_this._key=_key,_this}return tslib.__extends(QueryStartAfterConstraint,_super),QueryStartAfterConstraint.prototype._apply=function(query){validateFirebaseDataArg("startAfter",this._value,query._path,!1);var newParams=function queryParamsStartAfter(queryParams,indexValue,key){var params;queryParams.index_===KEY_INDEX?("string"==typeof indexValue&&(indexValue=successor(indexValue)),params=queryParamsStartAt(queryParams,indexValue,key)):params=queryParamsStartAt(queryParams,indexValue,null==key?MAX_NAME:successor(key));return params.startAfterSet_=!0,params}(query._queryParams,this._value,this._key);if(validateLimit(newParams),validateQueryEndpoints(newParams),query._queryParams.hasStart())throw new Error("startAfter: Starting point was already set (by another call to startAt, startAfter, or equalTo).");return new QueryImpl(query._repo,query._path,newParams,query._orderByCalled)},QueryStartAfterConstraint}(QueryConstraint);function startAfter(value,key){return validateKey("startAfter","key",key,!0),new QueryStartAfterConstraint(value,key)}var QueryLimitToFirstConstraint=function(_super){function QueryLimitToFirstConstraint(_limit){var _this=_super.call(this)||this;return _this._limit=_limit,_this}return tslib.__extends(QueryLimitToFirstConstraint,_super),QueryLimitToFirstConstraint.prototype._apply=function(query){if(query._queryParams.hasLimit())throw new Error("limitToFirst: Limit was already set (by another call to limitToFirst or limitToLast).");return new QueryImpl(query._repo,query._path,function queryParamsLimitToFirst(queryParams,newLimit){var newParams=queryParams.copy();return newParams.limitSet_=!0,newParams.limit_=newLimit,newParams.viewFrom_="l",newParams}(query._queryParams,this._limit),query._orderByCalled)},QueryLimitToFirstConstraint}(QueryConstraint);function limitToFirst(limit){if("number"!=typeof limit||Math.floor(limit)!==limit||limit<=0)throw new Error("limitToFirst: First argument must be a positive integer.");return new QueryLimitToFirstConstraint(limit)}var QueryLimitToLastConstraint=function(_super){function QueryLimitToLastConstraint(_limit){var _this=_super.call(this)||this;return _this._limit=_limit,_this}return tslib.__extends(QueryLimitToLastConstraint,_super),QueryLimitToLastConstraint.prototype._apply=function(query){if(query._queryParams.hasLimit())throw new Error("limitToLast: Limit was already set (by another call to limitToFirst or limitToLast).");return new QueryImpl(query._repo,query._path,function queryParamsLimitToLast(queryParams,newLimit){var newParams=queryParams.copy();return newParams.limitSet_=!0,newParams.limit_=newLimit,newParams.viewFrom_="r",newParams}(query._queryParams,this._limit),query._orderByCalled)},QueryLimitToLastConstraint}(QueryConstraint);function limitToLast(limit){if("number"!=typeof limit||Math.floor(limit)!==limit||limit<=0)throw new Error("limitToLast: First argument must be a positive integer.");return new QueryLimitToLastConstraint(limit)}var QueryOrderByChildConstraint=function(_super){function QueryOrderByChildConstraint(_path){var _this=_super.call(this)||this;return _this._path=_path,_this}return tslib.__extends(QueryOrderByChildConstraint,_super),QueryOrderByChildConstraint.prototype._apply=function(query){validateNoPreviousOrderByCall(query,"orderByChild");var parsedPath=new Path(this._path);if(pathIsEmpty(parsedPath))throw new Error("orderByChild: cannot pass in empty path. Use orderByValue() instead.");var index=new PathIndex(parsedPath),newParams=queryParamsOrderBy(query._queryParams,index);return validateQueryEndpoints(newParams),new QueryImpl(query._repo,query._path,newParams,!0)},QueryOrderByChildConstraint}(QueryConstraint);function orderByChild(path){if("$key"===path)throw new Error('orderByChild: "$key" is invalid.  Use orderByKey() instead.');if("$priority"===path)throw new Error('orderByChild: "$priority" is invalid.  Use orderByPriority() instead.');if("$value"===path)throw new Error('orderByChild: "$value" is invalid.  Use orderByValue() instead.');return validatePathString("orderByChild","path",path,!1),new QueryOrderByChildConstraint(path)}var QueryOrderByKeyConstraint=function(_super){function QueryOrderByKeyConstraint(){return null!==_super&&_super.apply(this,arguments)||this}return tslib.__extends(QueryOrderByKeyConstraint,_super),QueryOrderByKeyConstraint.prototype._apply=function(query){validateNoPreviousOrderByCall(query,"orderByKey");var newParams=queryParamsOrderBy(query._queryParams,KEY_INDEX);return validateQueryEndpoints(newParams),new QueryImpl(query._repo,query._path,newParams,!0)},QueryOrderByKeyConstraint}(QueryConstraint);function orderByKey(){return new QueryOrderByKeyConstraint}var QueryOrderByPriorityConstraint=function(_super){function QueryOrderByPriorityConstraint(){return null!==_super&&_super.apply(this,arguments)||this}return tslib.__extends(QueryOrderByPriorityConstraint,_super),QueryOrderByPriorityConstraint.prototype._apply=function(query){validateNoPreviousOrderByCall(query,"orderByPriority");var newParams=queryParamsOrderBy(query._queryParams,PRIORITY_INDEX);return validateQueryEndpoints(newParams),new QueryImpl(query._repo,query._path,newParams,!0)},QueryOrderByPriorityConstraint}(QueryConstraint);function orderByPriority(){return new QueryOrderByPriorityConstraint}var QueryOrderByValueConstraint=function(_super){function QueryOrderByValueConstraint(){return null!==_super&&_super.apply(this,arguments)||this}return tslib.__extends(QueryOrderByValueConstraint,_super),QueryOrderByValueConstraint.prototype._apply=function(query){validateNoPreviousOrderByCall(query,"orderByValue");var newParams=queryParamsOrderBy(query._queryParams,VALUE_INDEX);return validateQueryEndpoints(newParams),new QueryImpl(query._repo,query._path,newParams,!0)},QueryOrderByValueConstraint}(QueryConstraint);function orderByValue(){return new QueryOrderByValueConstraint}var QueryEqualToValueConstraint=function(_super){function QueryEqualToValueConstraint(_value,_key){var _this=_super.call(this)||this;return _this._value=_value,_this._key=_key,_this}return tslib.__extends(QueryEqualToValueConstraint,_super),QueryEqualToValueConstraint.prototype._apply=function(query){if(validateFirebaseDataArg("equalTo",this._value,query._path,!1),query._queryParams.hasStart())throw new Error("equalTo: Starting point was already set (by another call to startAt/startAfter or equalTo).");if(query._queryParams.hasEnd())throw new Error("equalTo: Ending point was already set (by another call to endAt/endBefore or equalTo).");return new QueryEndAtConstraint(this._value,this._key)._apply(new QueryStartAtConstraint(this._value,this._key)._apply(query))},QueryEqualToValueConstraint}(QueryConstraint);function equalTo(value,key){return validateKey("equalTo","key",key,!0),new QueryEqualToValueConstraint(value,key)}function query(query){for(var e_1,_a,queryConstraints=[],_i=1;_i<arguments.length;_i++)queryConstraints[_i-1]=arguments[_i];var queryImpl=util.getModularInstance(query);try{for(var queryConstraints_1=tslib.__values(queryConstraints),queryConstraints_1_1=queryConstraints_1.next();!queryConstraints_1_1.done;queryConstraints_1_1=queryConstraints_1.next()){var constraint=queryConstraints_1_1.value;queryImpl=constraint._apply(queryImpl)}}catch(e_1_1){e_1={error:e_1_1}}finally{try{queryConstraints_1_1&&!queryConstraints_1_1.done&&(_a=queryConstraints_1.return)&&_a.call(queryConstraints_1)}finally{if(e_1)throw e_1.error}}return queryImpl}!function syncPointSetReferenceConstructor(val){util.assert(!referenceConstructor$1,"__referenceConstructor has already been defined"),referenceConstructor$1=val}(ReferenceImpl),function syncTreeSetReferenceConstructor(val){util.assert(!referenceConstructor,"__referenceConstructor has already been defined"),referenceConstructor=val}(ReferenceImpl);var repos={},useRestClient=!1;function repoManagerDatabaseFromApp(app,authProvider,appCheckProvider,url,nodeAdmin){var dbUrl=url||app.options.databaseURL;void 0===dbUrl&&(app.options.projectId||fatal("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),log("Using default host for project ",app.options.projectId),dbUrl=app.options.projectId+"-default-rtdb.firebaseio.com");var isEmulator,parsedUrl=parseRepoInfo(dbUrl,nodeAdmin),repoInfo=parsedUrl.repoInfo,dbEmulatorHost=void 0;"undefined"!=typeof process&&(dbEmulatorHost=process.env.FIREBASE_DATABASE_EMULATOR_HOST),dbEmulatorHost?(isEmulator=!0,dbUrl="http://"+dbEmulatorHost+"?ns="+repoInfo.namespace,repoInfo=(parsedUrl=parseRepoInfo(dbUrl,nodeAdmin)).repoInfo):isEmulator=!parsedUrl.repoInfo.secure;var authTokenProvider=nodeAdmin&&isEmulator?new EmulatorTokenProvider(EmulatorTokenProvider.OWNER):new FirebaseAuthTokenProvider(app.name,app.options,authProvider);validateUrl("Invalid Firebase Database URL",parsedUrl),pathIsEmpty(parsedUrl.path)||fatal("Database URL must point to the root of a Firebase Database (not including a child path).");var repo=function repoManagerCreateRepo(repoInfo,app,authTokenProvider,appCheckProvider){var appRepos=repos[app.name];appRepos||(appRepos={},repos[app.name]=appRepos);var repo=appRepos[repoInfo.toURLString()];repo&&fatal("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call.");return repo=new Repo(repoInfo,useRestClient,authTokenProvider,appCheckProvider),appRepos[repoInfo.toURLString()]=repo,repo}(repoInfo,app,authTokenProvider,new AppCheckTokenProvider(app.name,appCheckProvider));return new FirebaseDatabase(repo,app)}var FirebaseDatabase=function(){function FirebaseDatabase(_repoInternal,app){this._repoInternal=_repoInternal,this.app=app,this.type="database",this._instanceStarted=!1}return Object.defineProperty(FirebaseDatabase.prototype,"_repo",{get:function(){return this._instanceStarted||(repoStart(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal},enumerable:!1,configurable:!0}),Object.defineProperty(FirebaseDatabase.prototype,"_root",{get:function(){return this._rootInternal||(this._rootInternal=new ReferenceImpl(this._repo,newEmptyPath())),this._rootInternal},enumerable:!1,configurable:!0}),FirebaseDatabase.prototype._delete=function(){return this._checkNotDeleted("delete"),function repoManagerDeleteRepo(repo,appName){var appRepos=repos[appName];appRepos&&appRepos[repo.key]===repo||fatal("Database "+appName+"("+repo.repoInfo_+") has already been deleted."),repoInterrupt(repo),delete appRepos[repo.key]}(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null,Promise.resolve()},FirebaseDatabase.prototype._checkNotDeleted=function(apiName){null===this._rootInternal&&fatal("Cannot call "+apiName+" on a deleted database.")},FirebaseDatabase}();function useDatabaseEmulator(db,host,port,options){void 0===options&&(options={}),(db=util.getModularInstance(db))._checkNotDeleted("useEmulator"),db._instanceStarted&&fatal("Cannot call useEmulator() after instance has already been initialized.");var repo=db._repoInternal,tokenProvider=void 0;if(repo.repoInfo_.nodeAdmin)options.mockUserToken&&fatal('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),tokenProvider=new EmulatorTokenProvider(EmulatorTokenProvider.OWNER);else if(options.mockUserToken){var token=util.createMockUserToken(options.mockUserToken,db.app.options.projectId);tokenProvider=new EmulatorTokenProvider(token)}!function repoManagerApplyEmulatorSettings(repo,host,port,tokenProvider){repo.repoInfo_=new RepoInfo(host+":"+port,!1,repo.repoInfo_.namespace,repo.repoInfo_.webSocketOnly,repo.repoInfo_.nodeAdmin,repo.repoInfo_.persistenceKey,repo.repoInfo_.includeNamespaceInQueryParams),tokenProvider&&(repo.authTokenProvider_=tokenProvider)}(repo,host,port,tokenProvider)}function goOffline(db){(db=util.getModularInstance(db))._checkNotDeleted("goOffline"),repoInterrupt(db._repo)}function goOnline(db){(db=util.getModularInstance(db))._checkNotDeleted("goOnline"),function repoResume(repo){repo.persistentConnection_&&repo.persistentConnection_.resume("repo_interrupt")}(db._repo)}function enableLogging(logger,persistent){enableLogging$1(logger,persistent)}var SERVER_TIMESTAMP={".sv":"timestamp"};var TransactionResult$1=function(){function TransactionResult(committed,snapshot){this.committed=committed,this.snapshot=snapshot}return TransactionResult.prototype.toJSON=function(){return{committed:this.committed,snapshot:this.snapshot.toJSON()}},TransactionResult}();function runTransaction(ref,transactionUpdate,options){var _a;if(ref=util.getModularInstance(ref),validateWritablePath("Reference.transaction",ref._path),".length"===ref.key||".keys"===ref.key)throw"Reference.transaction failed: "+ref.key+" is a read-only object.";var applyLocally=null===(_a=null==options?void 0:options.applyLocally)||void 0===_a||_a,deferred=new util.Deferred,unwatcher=onValue(ref,function(){});return function repoStartTransaction(repo,path,transactionUpdate,onComplete,unwatcher,applyLocally){repoLog(repo,"transaction on "+path);var transaction={path:path,update:transactionUpdate,onComplete:onComplete,status:null,order:LUIDGenerator(),applyLocally:applyLocally,retryCount:0,unwatcher:unwatcher,abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null},currentState=repoGetLatestState(repo,path,void 0);transaction.currentInputSnapshot=currentState;var newVal=transaction.update(currentState.val());if(void 0===newVal)transaction.unwatcher(),transaction.currentOutputSnapshotRaw=null,transaction.currentOutputSnapshotResolved=null,transaction.onComplete&&transaction.onComplete(null,!1,transaction.currentInputSnapshot);else{validateFirebaseData("transaction failed: Data returned ",newVal,transaction.path),transaction.status=0;var queueNode=treeSubTree(repo.transactionQueueTree_,path),nodeQueue=treeGetValue(queueNode)||[];nodeQueue.push(transaction),treeSetValue(queueNode,nodeQueue);var priorityForNode=void 0;"object"==typeof newVal&&null!==newVal&&util.contains(newVal,".priority")?(priorityForNode=util.safeGet(newVal,".priority"),util.assert(isValidPriority(priorityForNode),"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.")):priorityForNode=(syncTreeCalcCompleteEventCache(repo.serverSyncTree_,path)||ChildrenNode.EMPTY_NODE).getPriority().val();var serverValues=repoGenerateServerValues(repo),newNodeUnresolved=nodeFromJSON(newVal,priorityForNode),newNode=resolveDeferredValueSnapshot(newNodeUnresolved,currentState,serverValues);transaction.currentOutputSnapshotRaw=newNodeUnresolved,transaction.currentOutputSnapshotResolved=newNode,transaction.currentWriteId=repoGetNextWriteId(repo);var events=syncTreeApplyUserOverwrite(repo.serverSyncTree_,path,newNode,transaction.currentWriteId,transaction.applyLocally);eventQueueRaiseEventsForChangedPath(repo.eventQueue_,path,events),repoSendReadyTransactions(repo,repo.transactionQueueTree_)}}(ref._repo,ref._path,transactionUpdate,function(error,committed,node){var dataSnapshot=null;error?deferred.reject(error):(dataSnapshot=new DataSnapshot$1(node,new ReferenceImpl(ref._repo,ref._path),PRIORITY_INDEX),deferred.resolve(new TransactionResult$1(committed,dataSnapshot)))},unwatcher,applyLocally),deferred.promise}var OnDisconnect=function(){function OnDisconnect(_delegate){this._delegate=_delegate}return OnDisconnect.prototype.cancel=function(onComplete){util.validateArgCount("OnDisconnect.cancel",0,1,arguments.length),util.validateCallback("OnDisconnect.cancel","onComplete",onComplete,!0);var result=this._delegate.cancel();return onComplete&&result.then(function(){return onComplete(null)},function(error){return onComplete(error)}),result},OnDisconnect.prototype.remove=function(onComplete){util.validateArgCount("OnDisconnect.remove",0,1,arguments.length),util.validateCallback("OnDisconnect.remove","onComplete",onComplete,!0);var result=this._delegate.remove();return onComplete&&result.then(function(){return onComplete(null)},function(error){return onComplete(error)}),result},OnDisconnect.prototype.set=function(value,onComplete){util.validateArgCount("OnDisconnect.set",1,2,arguments.length),util.validateCallback("OnDisconnect.set","onComplete",onComplete,!0);var result=this._delegate.set(value);return onComplete&&result.then(function(){return onComplete(null)},function(error){return onComplete(error)}),result},OnDisconnect.prototype.setWithPriority=function(value,priority,onComplete){util.validateArgCount("OnDisconnect.setWithPriority",2,3,arguments.length),util.validateCallback("OnDisconnect.setWithPriority","onComplete",onComplete,!0);var result=this._delegate.setWithPriority(value,priority);return onComplete&&result.then(function(){return onComplete(null)},function(error){return onComplete(error)}),result},OnDisconnect.prototype.update=function(objectToMerge,onComplete){if(util.validateArgCount("OnDisconnect.update",1,2,arguments.length),Array.isArray(objectToMerge)){for(var newObjectToMerge={},i=0;i<objectToMerge.length;++i)newObjectToMerge[""+i]=objectToMerge[i];objectToMerge=newObjectToMerge,warn("Passing an Array to firebase.database.onDisconnect().update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}util.validateCallback("OnDisconnect.update","onComplete",onComplete,!0);var result=this._delegate.update(objectToMerge);return onComplete&&result.then(function(){return onComplete(null)},function(error){return onComplete(error)}),result},OnDisconnect}(),TransactionResult=function(){function TransactionResult(committed,snapshot){this.committed=committed,this.snapshot=snapshot}return TransactionResult.prototype.toJSON=function(){return util.validateArgCount("TransactionResult.toJSON",0,1,arguments.length),{committed:this.committed,snapshot:this.snapshot.toJSON()}},TransactionResult}(),DataSnapshot=function(){function DataSnapshot(_database,_delegate){this._database=_database,this._delegate=_delegate}return DataSnapshot.prototype.val=function(){return util.validateArgCount("DataSnapshot.val",0,0,arguments.length),this._delegate.val()},DataSnapshot.prototype.exportVal=function(){return util.validateArgCount("DataSnapshot.exportVal",0,0,arguments.length),this._delegate.exportVal()},DataSnapshot.prototype.toJSON=function(){return util.validateArgCount("DataSnapshot.toJSON",0,1,arguments.length),this._delegate.toJSON()},DataSnapshot.prototype.exists=function(){return util.validateArgCount("DataSnapshot.exists",0,0,arguments.length),this._delegate.exists()},DataSnapshot.prototype.child=function(path){return util.validateArgCount("DataSnapshot.child",0,1,arguments.length),path=String(path),validatePathString("DataSnapshot.child","path",path,!1),new DataSnapshot(this._database,this._delegate.child(path))},DataSnapshot.prototype.hasChild=function(path){return util.validateArgCount("DataSnapshot.hasChild",1,1,arguments.length),validatePathString("DataSnapshot.hasChild","path",path,!1),this._delegate.hasChild(path)},DataSnapshot.prototype.getPriority=function(){return util.validateArgCount("DataSnapshot.getPriority",0,0,arguments.length),this._delegate.priority},DataSnapshot.prototype.forEach=function(action){var _this=this;return util.validateArgCount("DataSnapshot.forEach",1,1,arguments.length),util.validateCallback("DataSnapshot.forEach","action",action,!1),this._delegate.forEach(function(expDataSnapshot){return action(new DataSnapshot(_this._database,expDataSnapshot))})},DataSnapshot.prototype.hasChildren=function(){return util.validateArgCount("DataSnapshot.hasChildren",0,0,arguments.length),this._delegate.hasChildren()},Object.defineProperty(DataSnapshot.prototype,"key",{get:function(){return this._delegate.key},enumerable:!1,configurable:!0}),DataSnapshot.prototype.numChildren=function(){return util.validateArgCount("DataSnapshot.numChildren",0,0,arguments.length),this._delegate.size},DataSnapshot.prototype.getRef=function(){return util.validateArgCount("DataSnapshot.ref",0,0,arguments.length),new Reference(this._database,this._delegate.ref)},Object.defineProperty(DataSnapshot.prototype,"ref",{get:function(){return this.getRef()},enumerable:!1,configurable:!0}),DataSnapshot}(),Query=function(){function Query(database,_delegate){this.database=database,this._delegate=_delegate}return Query.prototype.on=function(eventType,callback,cancelCallbackOrContext,context){var _a,_this=this;util.validateArgCount("Query.on",2,4,arguments.length),util.validateCallback("Query.on","callback",callback,!1);var ret=Query.getCancelAndContextArgs_("Query.on",cancelCallbackOrContext,context),valueCallback=function(expSnapshot,previousChildName){callback.call(ret.context,new DataSnapshot(_this.database,expSnapshot),previousChildName)};valueCallback.userCallback=callback,valueCallback.context=ret.context;var cancelCallback=null===(_a=ret.cancel)||void 0===_a?void 0:_a.bind(ret.context);switch(eventType){case"value":return onValue(this._delegate,valueCallback,cancelCallback),callback;case"child_added":return onChildAdded(this._delegate,valueCallback,cancelCallback),callback;case"child_removed":return onChildRemoved(this._delegate,valueCallback,cancelCallback),callback;case"child_changed":return onChildChanged(this._delegate,valueCallback,cancelCallback),callback;case"child_moved":return onChildMoved(this._delegate,valueCallback,cancelCallback),callback;default:throw new Error(util.errorPrefix("Query.on","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}},Query.prototype.off=function(eventType,callback,context){if(util.validateArgCount("Query.off",0,3,arguments.length),validateEventType("Query.off",eventType,!0),util.validateCallback("Query.off","callback",callback,!0),util.validateContextObject("Query.off","context",context,!0),callback){var valueCallback=function(){};valueCallback.userCallback=callback,valueCallback.context=context,off(this._delegate,eventType,valueCallback)}else off(this._delegate,eventType)},Query.prototype.get=function(){var _this=this;return get(this._delegate).then(function(expSnapshot){return new DataSnapshot(_this.database,expSnapshot)})},Query.prototype.once=function(eventType,callback,failureCallbackOrContext,context){var _this=this;util.validateArgCount("Query.once",1,4,arguments.length),util.validateCallback("Query.once","callback",callback,!0);var ret=Query.getCancelAndContextArgs_("Query.once",failureCallbackOrContext,context),deferred=new util.Deferred,valueCallback=function(expSnapshot,previousChildName){var result=new DataSnapshot(_this.database,expSnapshot);callback&&callback.call(ret.context,result,previousChildName),deferred.resolve(result)};valueCallback.userCallback=callback,valueCallback.context=ret.context;var cancelCallback=function(error){ret.cancel&&ret.cancel.call(ret.context,error),deferred.reject(error)};switch(eventType){case"value":onValue(this._delegate,valueCallback,cancelCallback,{onlyOnce:!0});break;case"child_added":onChildAdded(this._delegate,valueCallback,cancelCallback,{onlyOnce:!0});break;case"child_removed":onChildRemoved(this._delegate,valueCallback,cancelCallback,{onlyOnce:!0});break;case"child_changed":onChildChanged(this._delegate,valueCallback,cancelCallback,{onlyOnce:!0});break;case"child_moved":onChildMoved(this._delegate,valueCallback,cancelCallback,{onlyOnce:!0});break;default:throw new Error(util.errorPrefix("Query.once","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}return deferred.promise},Query.prototype.limitToFirst=function(limit){return util.validateArgCount("Query.limitToFirst",1,1,arguments.length),new Query(this.database,query(this._delegate,limitToFirst(limit)))},Query.prototype.limitToLast=function(limit){return util.validateArgCount("Query.limitToLast",1,1,arguments.length),new Query(this.database,query(this._delegate,limitToLast(limit)))},Query.prototype.orderByChild=function(path){return util.validateArgCount("Query.orderByChild",1,1,arguments.length),new Query(this.database,query(this._delegate,orderByChild(path)))},Query.prototype.orderByKey=function(){return util.validateArgCount("Query.orderByKey",0,0,arguments.length),new Query(this.database,query(this._delegate,orderByKey()))},Query.prototype.orderByPriority=function(){return util.validateArgCount("Query.orderByPriority",0,0,arguments.length),new Query(this.database,query(this._delegate,orderByPriority()))},Query.prototype.orderByValue=function(){return util.validateArgCount("Query.orderByValue",0,0,arguments.length),new Query(this.database,query(this._delegate,orderByValue()))},Query.prototype.startAt=function(value,name){return void 0===value&&(value=null),util.validateArgCount("Query.startAt",0,2,arguments.length),new Query(this.database,query(this._delegate,startAt(value,name)))},Query.prototype.startAfter=function(value,name){return void 0===value&&(value=null),util.validateArgCount("Query.startAfter",0,2,arguments.length),new Query(this.database,query(this._delegate,startAfter(value,name)))},Query.prototype.endAt=function(value,name){return void 0===value&&(value=null),util.validateArgCount("Query.endAt",0,2,arguments.length),new Query(this.database,query(this._delegate,endAt(value,name)))},Query.prototype.endBefore=function(value,name){return void 0===value&&(value=null),util.validateArgCount("Query.endBefore",0,2,arguments.length),new Query(this.database,query(this._delegate,endBefore(value,name)))},Query.prototype.equalTo=function(value,name){return util.validateArgCount("Query.equalTo",1,2,arguments.length),new Query(this.database,query(this._delegate,equalTo(value,name)))},Query.prototype.toString=function(){return util.validateArgCount("Query.toString",0,0,arguments.length),this._delegate.toString()},Query.prototype.toJSON=function(){return util.validateArgCount("Query.toJSON",0,1,arguments.length),this._delegate.toJSON()},Query.prototype.isEqual=function(other){if(util.validateArgCount("Query.isEqual",1,1,arguments.length),!(other instanceof Query)){var error="Query.isEqual failed: First argument must be an instance of firebase.database.Query.";throw new Error(error)}return this._delegate.isEqual(other._delegate)},Query.getCancelAndContextArgs_=function(fnName,cancelOrContext,context){var ret={cancel:void 0,context:void 0};if(cancelOrContext&&context)ret.cancel=cancelOrContext,util.validateCallback(fnName,"cancel",ret.cancel,!0),ret.context=context,util.validateContextObject(fnName,"context",ret.context,!0);else if(cancelOrContext)if("object"==typeof cancelOrContext&&null!==cancelOrContext)ret.context=cancelOrContext;else{if("function"!=typeof cancelOrContext)throw new Error(util.errorPrefix(fnName,"cancelOrContext")+" must either be a cancel callback or a context object.");ret.cancel=cancelOrContext}return ret},Object.defineProperty(Query.prototype,"ref",{get:function(){return new Reference(this.database,new ReferenceImpl(this._delegate._repo,this._delegate._path))},enumerable:!1,configurable:!0}),Query}(),Reference=function(_super){function Reference(database,_delegate){var _this=_super.call(this,database,new QueryImpl(_delegate._repo,_delegate._path,new QueryParams,!1))||this;return _this.database=database,_this._delegate=_delegate,_this}return tslib.__extends(Reference,_super),Reference.prototype.getKey=function(){return util.validateArgCount("Reference.key",0,0,arguments.length),this._delegate.key},Reference.prototype.child=function(pathString){return util.validateArgCount("Reference.child",1,1,arguments.length),"number"==typeof pathString&&(pathString=String(pathString)),new Reference(this.database,child(this._delegate,pathString))},Reference.prototype.getParent=function(){util.validateArgCount("Reference.parent",0,0,arguments.length);var parent=this._delegate.parent;return parent?new Reference(this.database,parent):null},Reference.prototype.getRoot=function(){return util.validateArgCount("Reference.root",0,0,arguments.length),new Reference(this.database,this._delegate.root)},Reference.prototype.set=function(newVal,onComplete){util.validateArgCount("Reference.set",1,2,arguments.length),util.validateCallback("Reference.set","onComplete",onComplete,!0);var result=set(this._delegate,newVal);return onComplete&&result.then(function(){return onComplete(null)},function(error){return onComplete(error)}),result},Reference.prototype.update=function(values,onComplete){if(util.validateArgCount("Reference.update",1,2,arguments.length),Array.isArray(values)){for(var newObjectToMerge={},i=0;i<values.length;++i)newObjectToMerge[""+i]=values[i];values=newObjectToMerge,warn("Passing an Array to Firebase.update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}validateWritablePath("Reference.update",this._delegate._path),util.validateCallback("Reference.update","onComplete",onComplete,!0);var result=update(this._delegate,values);return onComplete&&result.then(function(){return onComplete(null)},function(error){return onComplete(error)}),result},Reference.prototype.setWithPriority=function(newVal,newPriority,onComplete){util.validateArgCount("Reference.setWithPriority",2,3,arguments.length),util.validateCallback("Reference.setWithPriority","onComplete",onComplete,!0);var result=setWithPriority(this._delegate,newVal,newPriority);return onComplete&&result.then(function(){return onComplete(null)},function(error){return onComplete(error)}),result},Reference.prototype.remove=function(onComplete){util.validateArgCount("Reference.remove",0,1,arguments.length),util.validateCallback("Reference.remove","onComplete",onComplete,!0);var result=remove(this._delegate);return onComplete&&result.then(function(){return onComplete(null)},function(error){return onComplete(error)}),result},Reference.prototype.transaction=function(transactionUpdate,onComplete,applyLocally){var _this=this;util.validateArgCount("Reference.transaction",1,3,arguments.length),util.validateCallback("Reference.transaction","transactionUpdate",transactionUpdate,!1),util.validateCallback("Reference.transaction","onComplete",onComplete,!0),validateBoolean("Reference.transaction","applyLocally",applyLocally,!0);var result=runTransaction(this._delegate,transactionUpdate,{applyLocally:applyLocally}).then(function(transactionResult){return new TransactionResult(transactionResult.committed,new DataSnapshot(_this.database,transactionResult.snapshot))});return onComplete&&result.then(function(transactionResult){return onComplete(null,transactionResult.committed,transactionResult.snapshot)},function(error){return onComplete(error,!1,null)}),result},Reference.prototype.setPriority=function(priority,onComplete){util.validateArgCount("Reference.setPriority",1,2,arguments.length),util.validateCallback("Reference.setPriority","onComplete",onComplete,!0);var result=setPriority(this._delegate,priority);return onComplete&&result.then(function(){return onComplete(null)},function(error){return onComplete(error)}),result},Reference.prototype.push=function(value,onComplete){var _this=this;util.validateArgCount("Reference.push",0,2,arguments.length),util.validateCallback("Reference.push","onComplete",onComplete,!0);var expPromise=push(this._delegate,value),promise=expPromise.then(function(expRef){return new Reference(_this.database,expRef)});onComplete&&promise.then(function(){return onComplete(null)},function(error){return onComplete(error)});var result=new Reference(this.database,expPromise);return result.then=promise.then.bind(promise),result.catch=promise.catch.bind(promise,void 0),result},Reference.prototype.onDisconnect=function(){return validateWritablePath("Reference.onDisconnect",this._delegate._path),new OnDisconnect(new OnDisconnect$1(this._delegate._repo,this._delegate._path))},Object.defineProperty(Reference.prototype,"key",{get:function(){return this.getKey()},enumerable:!1,configurable:!0}),Object.defineProperty(Reference.prototype,"parent",{get:function(){return this.getParent()},enumerable:!1,configurable:!0}),Object.defineProperty(Reference.prototype,"root",{get:function(){return this.getRoot()},enumerable:!1,configurable:!0}),Reference}(Query),Database=function(){function Database(_delegate,app){var _this=this;this._delegate=_delegate,this.app=app,this.INTERNAL={delete:function(){return _this._delegate._delete()}}}return Database.prototype.useEmulator=function(host,port,options){void 0===options&&(options={}),useDatabaseEmulator(this._delegate,host,port,options)},Database.prototype.ref=function(path){if(util.validateArgCount("database.ref",0,1,arguments.length),path instanceof Reference){var childRef=refFromURL(this._delegate,path.toString());return new Reference(this,childRef)}childRef=ref(this._delegate,path);return new Reference(this,childRef)},Database.prototype.refFromURL=function(url){var apiName="database.refFromURL";util.validateArgCount(apiName,1,1,arguments.length);var childRef=refFromURL(this._delegate,url);return new Reference(this,childRef)},Database.prototype.goOffline=function(){return util.validateArgCount("database.goOffline",0,0,arguments.length),goOffline(this._delegate)},Database.prototype.goOnline=function(){return util.validateArgCount("database.goOnline",0,0,arguments.length),goOnline(this._delegate)},Database.ServerValue={TIMESTAMP:SERVER_TIMESTAMP,increment:function(delta){return function increment(delta){return{".sv":{increment:delta}}}(delta)}},Database}();function initStandalone$1(_a){var app=_a.app,url=_a.url,version=_a.version,customAuthImpl=_a.customAuthImpl,namespace=_a.namespace,_b=_a.nodeAdmin,nodeAdmin=void 0!==_b&&_b;setSDKVersion(version);var authProvider=new component.Provider("auth-internal",new component.ComponentContainer("database-standalone"));return authProvider.setComponent(new component.Component("auth-internal",function(){return customAuthImpl},"PRIVATE")),{instance:new Database(repoManagerDatabaseFromApp(app,authProvider,void 0,url,nodeAdmin),app),namespace:namespace}}var INTERNAL=Object.freeze({__proto__:null,forceLongPolling:function(){WebSocketConnection.forceDisallow(),BrowserPollConnection.forceAllow()},forceWebSockets:function(){BrowserPollConnection.forceDisallow()},isWebSocketsAvailable:function(){return WebSocketConnection.isAvailable()},setSecurityDebugCallback:function(ref,callback){ref._delegate._repo.persistentConnection_.securityDebugCallback_=callback},stats:function(ref,showDelta){!function repoStats(repo,showDelta){if(void 0===showDelta&&(showDelta=!1),"undefined"!=typeof console){var stats;showDelta?(repo.statsListener_||(repo.statsListener_=new StatsListener(repo.stats_)),stats=repo.statsListener_.get()):stats=repo.stats_.get();var longestName=Object.keys(stats).reduce(function(previousValue,currentValue){return Math.max(currentValue.length,previousValue)},0);each(stats,function(stat,value){for(var paddedStat=stat,i=stat.length;i<longestName+2;i++)paddedStat+=" ";console.log(paddedStat+value)})}}(ref._delegate._repo,showDelta)},statsIncrementCounter:function(ref,metric){!function repoStatsIncrementCounter(repo,metric){repo.stats_.incrementCounter(metric),function statsReporterIncludeStat(reporter,stat){reporter.statsToReport_[stat]=!0}(repo.statsReporter_,metric)}(ref._delegate._repo,metric)},dataUpdateCount:function(ref){return ref._delegate._repo.dataUpdateCount},interceptServerData:function(ref,callback){return function repoInterceptServerData(repo,callback){repo.interceptServerDataCallback_=callback}(ref._delegate._repo,callback)},initStandalone:initStandalone$1}),DataConnection=PersistentConnection;PersistentConnection.prototype.simpleListen=function(pathString,onComplete){this.sendRequest("q",{p:pathString},onComplete)},PersistentConnection.prototype.echo=function(data,onEcho){this.sendRequest("echo",{d:data},onEcho)};var RealTimeConnection=Connection,ConnectionTarget=RepoInfo,TEST_ACCESS=Object.freeze({__proto__:null,DataConnection:DataConnection,RealTimeConnection:RealTimeConnection,hijackHash:function(newHash){var oldPut=PersistentConnection.prototype.put;return PersistentConnection.prototype.put=function(pathString,data,onComplete,hash){void 0!==hash&&(hash=newHash()),oldPut.call(this,pathString,data,onComplete,hash)},function(){PersistentConnection.prototype.put=oldPut}},ConnectionTarget:ConnectionTarget,queryIdentifier:function(query){return query._delegate._queryIdentifier},forceRestClient:function(forceRestClient){!function repoManagerForceRestClient(forceRestClient){useRestClient=forceRestClient}(forceRestClient)}});!function setWebSocketImpl(impl){WebSocketImpl=impl}(fayeWebsocket.Client);var ServerValue=Database.ServerValue;function initStandalone(app,url,version,nodeAdmin){return void 0===nodeAdmin&&(nodeAdmin=!0),util.CONSTANTS.NODE_ADMIN=nodeAdmin,initStandalone$1({app:app,url:url,version:version,customAuthImpl:app.INTERNAL,namespace:{Reference:Reference,Query:Query,Database:Database,DataSnapshot:DataSnapshot,enableLogging:enableLogging,INTERNAL:INTERNAL,ServerValue:ServerValue,TEST_ACCESS:TEST_ACCESS},nodeAdmin:nodeAdmin})}function registerDatabase(instance){setSDKVersion(instance.SDK_VERSION);var namespace=instance.INTERNAL.registerComponent(new component.Component("database",function(container,_a){var url=_a.instanceIdentifier,app=container.getProvider("app").getImmediate(),authProvider=container.getProvider("auth-internal"),appCheckProvider=container.getProvider("app-check-internal");return new Database(repoManagerDatabaseFromApp(app,authProvider,appCheckProvider,url),app)},"PUBLIC").setServiceProps({Reference:Reference,Query:Query,Database:Database,DataSnapshot:DataSnapshot,enableLogging:enableLogging,INTERNAL:INTERNAL,ServerValue:ServerValue,TEST_ACCESS:TEST_ACCESS}).setMultipleInstances(!0));instance.registerVersion("@firebase/database","0.10.7","node"),util.isNodeSdk()&&(module.exports=Object.assign({},namespace,{initStandalone:initStandalone}))}try{var firebase=__webpack_require__("eq5/").default;firebase&&registerDatabase(firebase)}catch(err){if("MODULE_NOT_FOUND"!==err.code)throw err}exports.DataSnapshot=DataSnapshot,exports.Database=Database,exports.OnDisconnect=OnDisconnect,exports.Query=Query,exports.Reference=Reference,exports.ServerValue=ServerValue,exports.enableLogging=enableLogging,exports.initStandalone=initStandalone,exports.registerDatabase=registerDatabase},sWNQ:function(module,exports,__webpack_require__){"use strict";var Event=__webpack_require__("AhIK"),EventTarget={onopen:null,onmessage:null,onerror:null,onclose:null,addEventListener:function(eventType,listener,useCapture){this.on(eventType,listener)},removeEventListener:function(eventType,listener,useCapture){this.removeListener(eventType,listener)},dispatchEvent:function(event){event.target=event.currentTarget=this,event.eventPhase=Event.AT_TARGET,this["on"+event.type]&&this["on"+event.type](event),this.emit(event.type,event)}};module.exports=EventTarget},u4G8:function(module,exports,__webpack_require__){"use strict";var Stream=__webpack_require__("msIP").Stream,util=__webpack_require__("jK02"),IO=function(driver){this.readable=this.writable=!0,this._paused=!1,this._driver=driver};util.inherits(IO,Stream),IO.prototype.pause=function(){this._paused=!0,this._driver.messages._paused=!0},IO.prototype.resume=function(){this._paused=!1,this.emit("drain");var messages=this._driver.messages;messages._paused=!1,messages.emit("drain")},IO.prototype.write=function(chunk){return!!this.writable&&(this._driver.parse(chunk),!this._paused)},IO.prototype.end=function(chunk){if(this.writable){void 0!==chunk&&this.write(chunk),this.writable=!1;var messages=this._driver.messages;messages.readable&&(messages.readable=messages.writable=!1,messages.emit("end"))}},IO.prototype.destroy=function(){this.end()};var Messages=function(driver){this.readable=this.writable=!0,this._paused=!1,this._driver=driver};util.inherits(Messages,Stream),Messages.prototype.pause=function(){this._driver.io._paused=!0},Messages.prototype.resume=function(){this._driver.io._paused=!1,this._driver.io.emit("drain")},Messages.prototype.write=function(message){return!!this.writable&&("string"==typeof message?this._driver.text(message):this._driver.binary(message),!this._paused)},Messages.prototype.end=function(message){void 0!==message&&this.write(message)},Messages.prototype.destroy=function(){},exports.IO=IO,exports.Messages=Messages},u5A6:function(module,exports,__webpack_require__){"use strict";var RingBuffer=function(bufferSize){this._bufferSize=bufferSize,this.clear()};RingBuffer.prototype.clear=function(){this._buffer=new Array(this._bufferSize),this._ringOffset=0,this._ringSize=this._bufferSize,this._head=0,this._tail=0,this.length=0},RingBuffer.prototype.push=function(value){var expandBuffer=!1,expandRing=!1;this._ringSize<this._bufferSize?expandBuffer=0===this._tail:this._ringOffset===this._ringSize&&(expandBuffer=!0,expandRing=0===this._tail),expandBuffer&&(this._tail=this._bufferSize,this._buffer=this._buffer.concat(new Array(this._bufferSize)),this._bufferSize=this._buffer.length,expandRing&&(this._ringSize=this._bufferSize)),this._buffer[this._tail]=value,this.length+=1,this._tail<this._ringSize&&(this._ringOffset+=1),this._tail=(this._tail+1)%this._bufferSize},RingBuffer.prototype.peek=function(){if(0!==this.length)return this._buffer[this._head]},RingBuffer.prototype.shift=function(){if(0!==this.length){var value=this._buffer[this._head];return this._buffer[this._head]=void 0,this.length-=1,this._ringOffset-=1,0===this._ringOffset&&this.length>0?(this._head=this._ringSize,this._ringOffset=this.length,this._ringSize=this._bufferSize):this._head=(this._head+1)%this._ringSize,value}},module.exports=RingBuffer},ziip:function(module,exports,__webpack_require__){"use strict";var NodeHTTPParser=__webpack_require__("cKJ5").HTTPParser,Buffer=__webpack_require__("hwdV").Buffer,TYPES={request:NodeHTTPParser.REQUEST||"request",response:NodeHTTPParser.RESPONSE||"response"},HttpParser=function(type){this._type=type,this._parser=new NodeHTTPParser(TYPES[type]),this._complete=!1,this.headers={};var current=null,self=this;this._parser.onHeaderField=function(b,start,length){current=b.toString("utf8",start,start+length).toLowerCase()},this._parser.onHeaderValue=function(b,start,length){var value=b.toString("utf8",start,start+length);self.headers.hasOwnProperty(current)?self.headers[current]+=", "+value:self.headers[current]=value},this._parser.onHeadersComplete=this._parser[NodeHTTPParser.kOnHeadersComplete]=function(majorVersion,minorVersion,headers,method,pathname,statusCode){var info=arguments[0];if("object"==typeof info&&(method=info.method,pathname=info.url,statusCode=info.statusCode,headers=info.headers),self.method="number"==typeof method?HttpParser.METHODS[method]:method,self.statusCode=statusCode,self.url=pathname,headers){for(var key,value,i=0,n=headers.length;i<n;i+=2)key=headers[i].toLowerCase(),value=headers[i+1],self.headers.hasOwnProperty(key)?self.headers[key]+=", "+value:self.headers[key]=value;self._complete=!0}}};HttpParser.METHODS={0:"DELETE",1:"GET",2:"HEAD",3:"POST",4:"PUT",5:"CONNECT",6:"OPTIONS",7:"TRACE",8:"COPY",9:"LOCK",10:"MKCOL",11:"MOVE",12:"PROPFIND",13:"PROPPATCH",14:"SEARCH",15:"UNLOCK",16:"BIND",17:"REBIND",18:"UNBIND",19:"ACL",20:"REPORT",21:"MKACTIVITY",22:"CHECKOUT",23:"MERGE",24:"M-SEARCH",25:"NOTIFY",26:"SUBSCRIBE",27:"UNSUBSCRIBE",28:"PATCH",29:"PURGE",30:"MKCALENDAR",31:"LINK",32:"UNLINK"};var VERSION=process.version?process.version.match(/[0-9]+/g).map(function(n){return parseInt(n,10)}):[];0===VERSION[0]&&12===VERSION[1]&&(HttpParser.METHODS[16]="REPORT",HttpParser.METHODS[17]="MKACTIVITY",HttpParser.METHODS[18]="CHECKOUT",HttpParser.METHODS[19]="MERGE",HttpParser.METHODS[20]="M-SEARCH",HttpParser.METHODS[21]="NOTIFY",HttpParser.METHODS[22]="SUBSCRIBE",HttpParser.METHODS[23]="UNSUBSCRIBE",HttpParser.METHODS[24]="PATCH",HttpParser.METHODS[25]="PURGE"),HttpParser.prototype.isComplete=function(){return this._complete},HttpParser.prototype.parse=function(chunk){var consumed=this._parser.execute(chunk,0,chunk.length);if("number"!=typeof consumed)return this.error=consumed,void(this._complete=!0);this._complete&&(this.body=consumed<chunk.length?chunk.slice(consumed):Buffer.alloc(0))},module.exports=HttpParser},zzpY:function(module,exports,__webpack_require__){"use strict";var Buffer=__webpack_require__("hwdV").Buffer,Stream=__webpack_require__("msIP").Stream,url=__webpack_require__("bzos"),util=__webpack_require__("jK02"),Base=__webpack_require__("Wdmt"),Headers=__webpack_require__("q+85"),HttpParser=__webpack_require__("ziip"),PORTS={"ws:":80,"wss:":443},Proxy=function(client,origin,options){this._client=client,this._http=new HttpParser("response"),this._origin="object"==typeof client.url?client.url:url.parse(client.url),this._url="object"==typeof origin?origin:url.parse(origin),this._options=options||{},this._state=0,this.readable=this.writable=!0,this._paused=!1,this._headers=new Headers,this._headers.set("Host",this._origin.host),this._headers.set("Connection","keep-alive"),this._headers.set("Proxy-Connection","keep-alive");var auth=this._url.auth&&Buffer.from(this._url.auth,"utf8").toString("base64");auth&&this._headers.set("Proxy-Authorization","Basic "+auth)};util.inherits(Proxy,Stream);var instance={setHeader:function(name,value){return 0===this._state&&(this._headers.set(name,value),!0)},start:function(){if(0!==this._state)return!1;this._state=1;var origin=this._origin,port=origin.port||PORTS[origin.protocol],headers=["CONNECT "+origin.hostname+":"+port+" HTTP/1.1",this._headers.toString(),""];return this.emit("data",Buffer.from(headers.join("\r\n"),"utf8")),!0},pause:function(){this._paused=!0},resume:function(){this._paused=!1,this.emit("drain")},write:function(chunk){if(!this.writable)return!1;if(this._http.parse(chunk),!this._http.isComplete())return!this._paused;if(this.statusCode=this._http.statusCode,this.headers=this._http.headers,200===this.statusCode)this.emit("connect",new Base.ConnectEvent);else{var message="Can't establish a connection to the server at "+this._origin.href;this.emit("error",new Error(message))}return this.end(),!this._paused},end:function(chunk){this.writable&&(void 0!==chunk&&this.write(chunk),this.readable=this.writable=!1,this.emit("close"),this.emit("end"))},destroy:function(){this.end()}};for(var key in instance)Proxy.prototype[key]=instance[key];module.exports=Proxy}};